---
---

```{r include = F}
#| setup
if (!requireNamespace("utils.tool"))
  devtools::load_all("~/utils.tool/")
autor_preset()
## the package are available at <https://github.com/shaman-yellow/utils.tool>
## if you want to run codes of this Rmarkdown,
## please install the package `utils.tool` and other related packages (run
## install.R)
options(savedir = list(figs = "Figure+Table", tabs = "Figure+Table"))
```

```{r eval = T, echo = F, results = "asis"}
set_index()
```

# 摘要 {#abstract}

# 前言 {#introduction}

# 研究设计流程图 {#route}

```{r}
#| route
route <- as_network(
  list("RNA_seq_data:Preprocess",
    ), "tree"
)
p.route <- flowChart(route, 1.1, 1)
```

```{r, eval = T, echo = F, fig.width = 10, fig.height = 7, fig.cap = NULL}
p.route
```

# 材料和方法 {#methods}

# 分析结果 {#results}

# 结论 {#dis}

# 附：分析流程 {#workflow}

## ST 数据预处理

scAnno[@ScannoADeconLiuH2023]

```{r}
dirs <- list.files("/media/echo/6E3CE3153CE2D75D/曹卓测序结果/空间转录组/肺癌空间转录组测序/CellRanger/", full.names = T)

pbapply::pblapply(dirs,
  function(dir) {
    file <- list.files(dir, "tar\\.gz$", full.names = T)
    untar(file, exdir = dir)
  })
metadata <- tibble::tibble(dirs = dirs, target = paste0(dirs, "/outs"), sample = get_filename(dirs))
```

```{r}
## seurat
st <- job_seuratSp(metadata$target[[1]])
st <- step1(st)
st <- step2(st, 2500, 9000)
st <- step3(st, 1:15, 1.5)
st <- step4(st, "scAnno")

st@plots$step4$p.score_SingleR
wrap(st@plots$step4$p.map_SingleR, 10, 5)
st <- step5(st, 5)
st@tables$step5$all_markers
```

```{r}
obj <- st@object
data(gene.anno, package = "scAnno")
data(hcl.sc, package = "scAnno")
data(tcga.data.u, package = "scAnno")
ref.expr <- as.data.frame(Seurat::GetAssayData(hcl.sc, slot = 'data'))
ref.anno <- as.character(Seurat::Idents(hcl.sc))

results <- scAnno::scAnno(query = obj,
	ref.expr = ref.expr, ref.anno = ref.anno,
	save.markers = "markers",
  gene.anno = gene.anno, tcga.data.u = tcga.data.u)

```

```{r}
## cellchat
cc <- asjob_cellchat(st)
cc <- step1(cc)
cc <- step2(cc)
```
