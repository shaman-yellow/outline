---
title: 
bibliography: '`r system.file("extdata", "library.bib", package = "utils.tool")`'
csl: '`r system.file("extdata", "nature.csl", package = "utils.tool")`'
reference-section-title: "Reference"
link-citations: true
output:
  bookdown::pdf_document2:
    # pandoc_args: [
      # "--filter", "pandoc-fignos",
      # "--filter", "pandoc-tablenos"
    # ]
    keep_tex: true
    toc: false
    # toc_depth: 4
    latex_engine: xelatex
header-includes:
  \usepackage{caption}
  \captionsetup{font={footnotesize},width=6in}
  \renewcommand{\dblfloatpagefraction}{.9}
  \makeatletter
  \renewenvironment{figure}
  {\def\@captype{figure}}
  \makeatother
  \definecolor{shadecolor}{RGB}{242,242,242}
  \usepackage{xeCJK}
  \usepackage{setspace}
  \setstretch{1.3} 
  \usepackage{tcolorbox}
  \setcounter{secnumdepth}{4}
  \setcounter{tocdepth}{4}
  \usepackage{wallpaper}
  \usepackage[absolute]{textpos}
---


```{r include = F}
deparse_mail()
```

```{r include = F}
#| setup
if (!requireNamespace("utils.tool"))
  devtools::load_all("~/utils.tool/")
autor_preset()
## the package are available at <https://github.com/shaman-yellow/utils.tool>
## if you want to run codes of this Rmarkdown,
## please install the package `utils.tool` and other related packages (run
## install.R)
options(savedir = list(figs = "Figure+Table", tabs = "Figure+Table"))
```

```{r eval = T, echo = F, results = "asis"}
set_cover("肺癌和癌旁组织单细胞数据对比分析")
```

```{r eval = T, echo = F, results = "asis"}
set_index()
```

# 摘要 {#abstract}

- 分析不同组织样本中各细胞比例的情况，包括上皮细胞（肿瘤细胞或正常乳腺细胞）、淋系细胞、髓系细胞等等。
- 对比肺癌与癌旁组织中各细胞的比例，分析在肺癌进展过程中细胞成分的变化，探索在肺癌进展过程中是否出现新的细胞亚群。
- 进化树分析（trajectory analysis）揭示在肺癌进展过程中细胞分化与进化的情况。

# 材料和方法 {#methods}

## 方法

```{r eval = T, echo = F, results = "asis"}
auto_method()
```

# 分析结果 {#results}

# 结论 {#dis}

# 附：分析流程 {#workflow}

## 癌组织切片分析

### 空间转录组数据前处理与可视化

使用 Seurat 前处理空间转录组数据集，完成降维聚类，使用 SCSA 对细胞进行注释。

```{r eval = T, echo = F, results = "asis"}
#| Cancer-tissue-SCSA-annotation
autor(p.scsa)
```

```{r}
## use the previous data
st0 <- readRDS("~/disk_sdb1/2023_10_06_lunST/st.6.rds")
st0 <- upd(st0)
p.scsa <- vis(st0, "scsa_cell")
```

### 癌细胞鉴定

- 使用 copyKAT 鉴定癌细胞。

```{r eval = T, echo = F, results = "asis"}
#| Cancer-tissue-copyKAT-prediction-of-aneuploidy
autor(p.kat)
```

```{r eval = T, echo = F, results = "asis"}
#| Cancer-tissue-cell-mapped-of-copyKAT-prediction
autor(p.scsa_kat)
```

```{r}
p.kat <- f("../2023_10_06_lunST/Figure+Table/copykat_heatmap.png")
p.scsa_kat <- vis(st0, group.by = "scsa_copykat")
```

### 细胞比例分析

```{r eval = T, echo = F, results = "asis"}
#| Cancer-tissue-cell-proportion
autor(p.st0.pp)
```

```{r}
p.st0.pp <- wrap(new_pie(ids(st0, "scsa_copykat", unique = F), use.ggplot = T, fun_text = ggrepel::geom_label_repel), 7, 7)
p.st0.pp
```

## 癌旁组织切片分析

### 空间转录组数据前处理与可视化

使用 Seurat 前处理空间转录组数据集，完成降维聚类，使用 SCSA 对细胞进行注释。

```{r eval = T, echo = F, results = "asis"}
#| Paracancerous-tissue-SCSA-annotation
autor(p.st2.scsa)
```

```{r}
# stc2 <- step1(stc2)
# stc2 <- step2(stc2, 1, 7000, max.percent.mt = 30)
st2 <- readRDS("~/disk_sdb1/2023_10_06_lunST/st2.2.rds")
st2 <- upd(st2)
sig(st2) <- "Paracancerous tissue"
st2 <- step3(st2, 1:15, 1.2)
st2@step <- 4L
st2 <- step5(st2, 8)
st2 <- step6(st2, "Lung")
p.st2.scsa <- vis(st2, "scsa_cell")
p.st2.scsa
```

### 细胞比例分析

```{r}
p.st2.pp <- wrap(new_pie(ids(st2, "scsa_cell", unique = F), use.ggplot = T, fun_text = ggrepel::geom_label_repel), 7, 7)
```

```{r eval = T, echo = F, results = "asis"}
#| Paracancerous-tissue-cell-proportion
autor(p.st2.pp)
```

## 癌组织和癌旁组织整合分析

### 集成癌组织和癌旁组织数据

```{r eval = T, echo = F, results = "asis"}
#| Integrated-The-cell-type
autor(p.srs)
```

```{r}
st0 <- mutate(st0, cell_type = paste0(scsa_copykat, "_cancer"))
st2 <- mutate(st2, cell_type = paste0(scsa_cell, "_paracancer"))
rs <- asjob_risc(list(Cancer = st0, Paracancer = st2), NULL, "cell_type")
rs <- step1(rs)

pattern <- unique(gs(c(ids(st0, "cell_type"), ids(st2, "cell_type")), "_cancer|_paracancer", ""))
rs <- step2(rs, "Cancer", pattern)
rs@plots$step2$p.umap
clear(rs)

srs <- asjob_seurat(rs)
p.srs <- wrap(vis(srs, "cell_type"), 9, 6)

contrast <- table(gs(ids(srs), "_cancer|_paracancer", "")) %>% .[. == 2] %>%
  names %>% lapply(function(x) paste0(x, c("_cancer", "_paracancer")))

clear(srs)
```


### 巨噬细胞的亚群分析

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-subtypes-The-regroup-hclust
autor(p.srs.m)
```

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-subtypes-gene-module-heatmap
autor(mns@plots$step3$gene_module_heatdata$graph_test.sig)
```

```{r}
mns <- do_monocle(srs, "Macrophage")
sig(mns) <- "Macrophage-subtypes"
mns$palette <- NULL
mns <- step1(mns, "cell_type", pre = T)
mns@plots$step1$p.prin
mns <- step2(mns, c("Y_22"))
mns@plots$step2$p.pseu
mns <- step3(mns, group.by = "seurat_clusters")
mns@plots$step3$gene_module_heatdata$graph_test.sig
mns <- clear(mns)

srs.m <- asjob_seurat(mns, 3, rename = "Macrophage")
sig(srs.m) <- "Macrophage-subtypes"
p.srs.m <- vis(srs.m, "regroup.hclust")
p.srs.m

```

### 巨噬细胞亚群间差异分析

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-subtypes-contrasts-DEGs-intersection
autor(srs.m@params$p.diff_sets_intersection)
```

```{r}
srs.m@params$contrasts <- NULL
srs.m <- diff(srs.m, "regroup.hclust", combn(paste0("Macrophage_", 3:1), 2, simplify = F))
srs.m@params$p.diff_sets_intersection
clear(srs.m)

```

### 巨噬细胞亚群间差异功能分析

#### M3 vs M1

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-3-vs-Macrophage-1-GSEA-plot-of-the-pathways
autor(ge.31@plots$step2$p.code)
```

```{r}
srs.m@params$contrasts
ge.31 <- asjob_gsea(srs.m, "Macrophage_3_vs_Macrophage_1")
sig(ge.31)
ge.31 <- step1(ge.31)
ge.31@plots$step1$p.kegg
ge.31@tables$step1$table_kegg
ge.31 <- step2(ge.31, "hsa04142")
ge.31@plots$step2$p.code
clear(ge.31)
```

#### M2 vs M1

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-2-vs-Macrophage-1-GSEA-plot-of-the-pathways
autor(ge.21@plots$step2$p.code)
```

```{r}
srs.m@params$contrasts
ge.21 <- asjob_gsea(srs.m, "Macrophage_2_vs_Macrophage_1")
ge.21 <- step1(ge.21)
ge.21@plots$step1$p.kegg
ge.21@tables$step1$table_kegg
ge.21 <- step2(ge.21, c("hsa04080", "hsa03040"))
ge.21@plots$step2$p.code
clear(ge.21)
```

#### M3 vs M2

```{r eval = T, echo = F, results = "asis"}
#| Macrophage-3-vs-Macrophage-2-GSEA-plot-of-the-pathways
autor(ge.32@plots$step2$p.code)
```

```{r}
srs.m@params$contrasts
ge.32 <- asjob_gsea(srs.m, "Macrophage_3_vs_Macrophage_2")
ge.32 <- step1(ge.32)
ge.32@plots$step1$p.kegg
ge.32@tables$step1$table_kegg
ge.32 <- step2(ge.32, c("hsa04612", "hsa04145"))
ge.32@plots$step2$p.code
clear(ge.32)
```

```{r}
mns <- readRDS("./mns.3.rds")
srs <- readRDS("./srs.3.rds")
save.image("before_rs.Rdata")
load("before_rs.Rdata")

save_small()
```

