---
---

```{r include = F, eval = F}
deparse_mail()
info <- items(belong = odate(4), eval = ic(2, 2, 0, 2, 0))
show.ic(info)

order_publish()
idname <- order_packaging()
```

```{r include = F}
#| setup
if (!requireNamespace("utils.tool"))
  devtools::load_all("~/utils.tool/")
autor_preset()
## the package are available at <https://github.com/shaman-yellow/utils.tool>
## if you want to run codes of this Rmarkdown,
## please install the package `utils.tool` and other related packages (run
## install.R)
options(savedir = list(figs = "Figure+Table", tabs = "Figure+Table"))
```

```{r eval = T, echo = F, results = "asis"}
set_cover(info$title)
```

```{r eval = T, echo = F, results = "asis"}
set_index()
```

# 摘要 {#abstract}

中药复方乌梅丸：乌梅，花椒，细辛，黄连，黄柏，干姜，附子，桂枝，人参，当归
网络药理学部分可参考附件pdf文献
疾病为：慢性结肠炎，炎性肠病，肠纤维化，可以都包含，也可以单独一种疾病（如果单独疾病可以做出来，优先级按照语序来）
目标：筛出有效成分XX，及其作用靶点蛋白YY，YY需满足1、与XX能对接 2、富集分析显示YY与疾病相关的机制相关（比如炎症，纤维化，再放宽可以免疫细胞调控）

1、选取中药复方（乌梅丸）中和调控纤维化相关的单体成分，结合pubchem、chemical book、scifinder等数据库分析排名靠前的化合物的活性信息，并通过中医网络药理学方法（如TCMSP平台和BATMAN-TCM数据库），分析有效成分XXX的对应靶点YYY，功能富集分析显示YYY调控肠道纤维化。
2、、通过PubChem数据库（https://pubchem.ncbi.nlm.nih.gov/）获取中药单体主要活性成分的2D化学结构，在PDB数据库（https://www.rcsb.org/）中查找相关核心靶点蛋白3D结构，通过Autodock软件进行分子对接，获取结合能最高的位点，最后通过Pymol软件进行可视化处理。

交付：
1、疾病-复方-成分-靶点网络图
2、成分XX-靶点网络图
3、XX与YY分子对接pymol可视化图，注意细节标注
4、成分XX靶点功能富集分析
5、总的复方靶点的功能富集分析
6、YY可能参与的环节需要标注在4上或者单独注释分

oral bioavailability (OB) and drug likeness (DL)

```{r}
dic(di("差异表达基因", "Differential Expressed Genes", "DEGs"),
  di("慢性结肠炎")
)

# DEGs: Differential Expressed Genes 差异表达基因
# CC: chronic colitis 慢性结肠炎
```

# 前言 {#introduction}

# 材料和方法 {#methods}

## 材料

```{r eval = T, echo = F, results = "asis"}
auto_material()
```

## 方法

```{r eval = T, echo = F, results = "asis"}
auto_method()
```

# 分析结果 {#results}

# 结论 {#dis}

# 附：分析流程 {#workflow}

```{r}
herbs <- c("乌梅", "花椒", "细辛", "黄连", "黄柏", "干姜", "附子", "桂枝", "人参", "当归")

tc <- job_tcmsp(herbs)
tc <- step1(tc)

bt <- job_batman(herbs)
bt <- slice(bt, 1:10)
bt <- step1(bt)
bt <- step2(bt)
bt <- step3(bt)

bt@plots$step3$p.pharm
bt@params$compounds_info

bt@params$compounds_info
bt@params$herbs_info
bt@tables$step1$herbs_compounds
bt@tables$step2$compounds_targets
```

```{r}
gm <- job_gmix("chronic colitis", "colitis")
gm <- step1(gm)
gm <- step2(gm, 1, 10, 0, restrict = T)
gm@tables$step2$t.genecard

bt <- map(bt, gm@params$lst.genes)
bt@params$p.pharm2dis
bt@params$p.venn2dis
```

```{r}
en.herbs <- job_enrich(bt@params$p.venn2dis$ins)
en.herbs <- step1(en.herbs)
en.herbs <- step2(en.herbs, "hsa05321")
en.herbs@plots$step1$p.kegg$ids
en.herbs@tables$step1$res.kegg$ids
en.herbs@plots$step2$p.pathviews$hsa05321

```

```{r}
genes.infla <- dplyr::filter(en.herbs@tables$step1$res.kegg$ids, ID == "hsa05321")$geneName_list[[1]]
genes.infla

cpds.infla <- dplyr::filter(bt@params$data.allu, Target.name %in% genes.infla)
cpds.infla <- map(cpds.infla, "Ingredient.name", bt@params$compounds_info, "name", "LiteratureCount", col = "LiteratureCount")
cpds.infla <- map(cpds.infla, "Ingredient.name", bt@params$compounds_info, "name", "cids", col = "cids")
cpds.infla

```

```{r}
ct <- job_ctd()
ct <- step1(ct, "colitis")
ct@params$dis %<>% dplyr::slice(2)
ct <- step2(ct)
ct@tables$step2$t.chemical

p.vennShip <- new_venn(lst = list(CTD_records = ct@tables$step2$t.chemical$CID,
    herbs_related = cpds.infla$cids))
p.vennShip$ins
```

```{r}
cpds.infla.ctd <- dplyr::filter(cpds.infla, cids %in% as.integer(p.vennShip$ins))
cpds.infla.ctd
```

```{r}
file.copy("~/Downloads/AF-Q9HC29-F1-model_v4.pdb", "./order_material/nod2.pdb")
vn <- job_vina(.layout = dplyr::distinct(cpds.infla.ctd, Ingredient.name, Target.name, cids))
vn <- step1(vn, pdbs = c(IL13 = "3lb6"))
vn <- step2(vn, F)
vn <- step3(vn, extra_pdb.files = c(NOD2 = "./order_material/nod2.pdb"))
vn <- set_remote(vn)
vn <- step4(vn)
vn@step <- 4L
vn <- step5(vn)
vn@plots$step5$p.res_vina
vn@tables$step5$res_dock
res(vn)

vn@step <- 5L
vn <- step6(vn, top = 3, unique = T)
vn@plots$step6$Top1_72326_into_9ilb
vn@plots$step6$Top2_969516_into_4xfu
vn@plots$step6$Top3_774_into_nod2
vn@tables$step6$data

```

```{r}
cpd.top <- dplyr::filter(cpds.infla.ctd, cids %in% vn@tables$step6$data$PubChem_id[1])
en.top <- job_enrich(cpd.top$Target.name)
en.top <- step1(en.top)
en.top@plots$step1$p.kegg
en.top <- step2(en.top, "hsa05321")
en.top@plots$step2$p.pathviews$hsa05321

p.alluTop.dis <- new_allu(cpd.top, axes = 1:3, trunc = T)

p.alluTop.all <- new_allu(
  dplyr::filter(bt@params$data.allu, Ingredient.name %in% unique(cpd.top$Ingredient.name)), axes = 1:3, trunc = T)

```
