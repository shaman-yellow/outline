

而在免疫性 AA 中，会发生干细胞突变导致的免疫逃逸 (丢失了包含 HLA 等位基因的 6 号染色体区域的粒细胞) 。

metagwas <- MungeSumstats::find_sumstats(
  traits = c("parkinson", "alzheimer"),
  min_sample_size = 5000
)
### Only use a subset for testing purposes
ids <- (dplyr::arrange(metagwas, nsnp))$id
datasets <- MungeSumstats::import_sumstats(ids = ids[1])
datasets


metagwas <- MungeSumstats::find_sumstats(
  traits = c("parkinson", "alzheimer"),
  min_sample_size = 5000
)

### Only use a subset for testing purposes
ids <- (dplyr::arrange(metagwas, nsnp))$id
datasets <- MungeSumstats::import_sumstats(ids = ids[1])
ftibble(datasets[[1]])

```{r}
nscf.aa <- asjob_nscfea(sr5n.aa, "hu")
nscf.aa <- set_remote(nscf.aa)
nscf.aa <- step1(nscf.aa)
nscf.aa <- step2(nscf.aa)

test <- lapply(
  list.files("./scfea_aa1_test", "data.csv", full.names = TRUE, recursive = TRUE),
  ftibble
)
test %>% lapply(
  function(x) {
    any(apply(x[, -1], 2, sum) == 0)
  })
test

err <- ftibble("./scfea_aa1_test/5_scfea/data.csv")
sums = err[-1] %>% apply(2, sum)
which(sums == 0)
```

```{r}
sr5n.aa1 <- getsub(sr5n.aa, orig.ident == "AA1")
split <- grouping_vec2list(seq_len(dim(sr5n.aa1@object)[2]), 500)
sr5n.aa1@object@meta.data$split <- rep(seq_along(split), lengths(split))

```


```{r}
nscf.test <- asjob_nscfea(
  sr5n.aa1, "human", "split", dir = "scfea_aa1_test2", testWhich = 5
)
nscf.test <- set_remote(nscf.test, "scfea_aa1_test2")
nscf.test <- step1(nscf.test)
nscf.test <- step2(nscf.test)
```


```{r}
gds.aa <- job_gds("Aplastic anemia", 2:1000)
gds.aa <- step1(gds.aa, single_cell = TRUE, clinical = NULL)
vis(gds.aa)
```


## GEO 数据获取 (AA_BULK)

```{r}
geo.aa_bulk <- job_geo("GSE165870")
geo.aa_bulk <- step1(geo.aa_bulk)
geo.aa_bulk <- step2(geo.aa_bulk, rna = FALSE)
metadata.aa_bulk <- expect(geo.aa_bulk, geo_cols())
metadata.aa_bulk <- dplyr::mutate(metadata.aa_bulk, sample = title)
metadata.aa_bulk$group

raw.aa_bulk <- ftibble(list.files(geo.aa_bulk$dir, ".", full.names = TRUE))
counts.aa_bulk <- dplyr::select(raw.aa_bulk, GeneName, dplyr::where(is.integer))
counts.aa_bulk %>% colnames

genes.aa_bulk <- dplyr::select(raw.aa_bulk, GeneName, GeneSymbol)
genes.aa_bulk
```

## Limma 差异分析 (AA_BULK)

```{r}
lm.aa_bulk <- job_limma(
  new_dge(metadata.aa_bulk, counts.aa_bulk, genes.aa_bulk)
)
lm.aa_bulk <- step1(lm.aa_bulk)
lm.aa_bulk <- step2(
  lm.aa_bulk, non_SAA - Ctrl, label = "GeneSymbol", use = "P", cut.fc = .3
)
lm.aa_bulk@tables$step2$tops$`non_SAA - Ctrl`

dplyr::filter(lm.aa_bulk@tables$step2$tops$`non_SAA - Ctrl`, GeneSymbol %in% tbl_genesEry$gene)

```


```{r}
gds.aa_bulk <- job_gds(c("Aplastic anemia"))
active(gds.aa_bulk)
gds.aa_bulk <- step1(gds.aa_bulk)
vis(gds.aa_bulk)
```


## Seurat 细胞群中的 TWAS 风险相关基因 (AA)

`r snap(sr5n.aa, "fusion")`

```{r}
sr5n.aa <- map(sr5n.aa, fus.aa)
sr5n.aa@params$fusion_degs
```

m <- feature(sr5n.aa)
names(m) <- .get_versus_cell(names(m))
n <- feature(sr5n.aa, "cfrom")
names(n) <- gs(make.names(names(n)), "[.]+", "_")

lapply(names(n), 
  function(name) {
    n[[name]] %in% m[[name]]
  })


## 关联分析

聚焦于 Erythroblast 细胞 (在 TWAS 与 代谢通量分析中，都筛选出了差异变化) ，
将 TWAS 风险基因 (见`r ref("AA-Filtered-TWAS-associated-genes-of-Cell-Cluster-DEGs", FALSE)` 中的 Erythroblast)
与差异代谢通量关联分析 (见 `r ref("AA-FLUX-Erythroblast-AA-vs-Erythroblast-Normal")`)。

`r ref("Correlation-heatmap")` 
`r ref("Significant-correlation")` 
`r ref("AA-dimension-plot-of-expression-level-of-the-genes")` 

`r ref("AA-dimension-plot-of-expression-level-of-the-genes")` 中，'TUBB2A' 具有差异分布趋势。

`r ref("AA-violing-plot-of-expression-level-of-the-genes")`
<!-- LEGEND_END -->

```{r}
lm.erythroblast <- asjob_limma(sr5n.aa, feature(fus.aa), cell_groups = "Erythroblast")
cp.corr <- cal_corp(
  lm.erythroblast, lm.aa_flux,
  tbl_genesEry$gene, character_lm.aa_flux_name,
  names = c("TWAS associated DEGs", "Metabolic Flux"),
  use.x = "gene", use.y = "name", gname = FALSE
)
cp.corr@params$res$sig.corp
```

```{r}
p.Ery <- focus(sr5n.aa, tbl_genesEry$gene)
p.Ery$p.dim

p.Ery_TUBB2A <- focus(sr5n.aa, "TUBB2A")
p.Ery_TUBB2A$p.vln
```

```{r eval = T, echo = F, results = "asis"}
#| Correlation-heatmap
autor(cp.corr@params$res$hp)
```


```{r eval = T, echo = F, results = "asis"}
#| Significant-correlation
autor(cp.corr@params$res$sig.corp)
```


```{r eval = T, echo = F, results = "asis"}
#| AA-dimension-plot-of-expression-level-of-the-genes
autor(p.Ery$p.dim)
```


```{r eval = T, echo = F, results = "asis"}
#| AA-violing-plot-of-expression-level-of-the-genes
autor(p.Ery_TUBB2A$p.vln)
```


```{r}
en.cor_from <- asjob_enrich(feature(sr5n.aa, "cfrom"), FALSE)
en.cor_from <- step1(en.cor_from)
rm(en.cor_from)
```
