

## WGCNA 分析 (MRNA)

```{r}
wg.mrna <- asjob_wgcna(lm.mrna, unlist(lm.mrna@plots$step3$p.sets_intersection$raw))
wg.mrna <- step1(wg.mrna)
wg.mrna@plots$step1
wg.mrna <- step2(wg.mrna)
wg.mrna <- step3(wg.mrna)
wg.mrna@plots$step3
wg.mrna <- step4(wg.mrna)
wg.mrna@plots$step4$net
wg.mrna <- step5(wg.mrna)
```

 
test <- function(...) {
  expr <- rlang::enquos(...)
  print(as.character(expr))
  dplyr::filter(eg, !!!expr)
}
test(x > 5, y > 7)


test <- survival::coxph(as.formula(paste0("Terror$target ~ ", colnames(Terror$data)[1])),
  data.frame(Terror$data, check.names = F))
plot(test)

test <- glmnet::glmnet(Terror$data[, 1, drop = F], Terror$target, alpha = 1, family = "cox")
plot(lasso.luad@params$model)

## STRINGdb PPI 分析 (MRNA)

```{r}
sdb.mrna <- job_stringdb(unlist(en.mrna$raw))
sdb.mrna <- step1(sdb.mrna)
sdb.mrna@plots$step1$p.ppi
sdb.mrna@plots$step1$p.mcc
sdb.mrna@tables$step1$hub_genes
```

## 富集分析 (MRNA-TOPS)

```{r}
en.mrnaTops <- job_enrich(head(sdb.mrna@tables$step1$hub_genes$Symbol, 30))
en.mrnaTops <- step1(en.mrnaTops)
en.mrnaTops@plots$step1$p.kegg
en.mrnaTops@plots$step1$p.go
```

surv.luscCross <- asjob_survival(lasso.lusc, sig.uni_cox = lasso.luad$sig.uni_cox, force = T)
surv.luscCross@params$p.surv_genes_hp
surv.luscCross <- step1(surv.luscCross)
surv.luscCross@plots$step1$risk_score$p.surv


## TCGA 数据获取 (LUSC)

```{r}
tc.lusc <- job_tcga("TCGA-LUSC")
tc.lusc <- step1(tc.lusc)
tc.lusc <- step2(tc.lusc)
tc.lusc <- step3(tc.lusc)
tc.lusc
```

## Survival 生存分析 (LUSC)

```{r}
lm.lusc <- asjob_limma(tc.lusc,
  grpl(ajcc_pathologic_stage, "Stage [I]{1,2}[AB]?$"),
  days_to_last_follow_up >= 10, isTumor == "tumor")
lm.lusc@params$t.common
lm.lusc <- step1(lm.lusc)
lm.lusc@object$targets

lasso.lusc <- asjob_lasso(lm.lusc, unlist(en.mrna$raw))
lasso.lusc <- step1(lasso.lusc)
lasso.lusc <- step2(lasso.lusc)
lasso.lusc <- step3(lasso.lusc, use_data = "all", nfold = 3, multi_cox = T)

surv.lusc <- asjob_survival(lasso.lusc)
surv.lusc <- step1(surv.lusc)
surv.lusc@plots$step1$risk_score$p.surv
```

## COX 回归 (Prognosis)

```{r}
meta4 <- tbmerge(
  select(lasso.lung$metadata, rownames,
    # smoking = paper_Smoking.Status,
    # treatment_or_therapy,
    age = age_at_index, gender, ajcc_pathologic_stage),
  select(surv.lung@object, rownames, risk_score),
  by = "rownames"
)
meta4 <- dplyr::mutate(meta4,
  # smoking = ifelse(is.na(smoking) | grpl(smoking, "N/A"),
    # "not reported", as.character(smoking)),
  ajcc_pathologic_stage = strx(ajcc_pathologic_stage, "Stage I[I]?"),
  age = ifelse(is.na(age), "not reported",
    ifelse(age > 65, "> 65", "<= 65"))
)
meta4 <- dplyr::filter(meta4, dplyr::if_all(-rownames, ~ !grpl(.x, "reported")))
summary_tibble(meta4)

#' @meth {get_meth(lasso.prog)}
lasso.prog <- job_lasso(meta4[, -1], filter(lasso.lung$metadata, rownames %in% meta4$rownames))
lasso.prog <- step1(lasso.prog)
lasso.prog <- step2(lasso.prog, efs = F)
lasso.prog <- step3(lasso.prog, multi_cox = T, alpha = 0, use_data = "all", multi_cox.inherits = F)
coefMerged <- lasso.prog@tables$step3$t.CoefficientsOfCOX
coefMerged <- dplyr::mutate(coefMerged, feature = dplyr::recode(feature,
    age = "Age (>65/<=64)", gender = "gender (female/male)",
    ajcc_pathologic_stage = "AJCC stage (I/II)", risk_score = "Risk score")
)
coefMerged
```

进一步通过单因素和多因素 COX 回归的方式评估了包括风险评分在内的4项预后特征 (smoking, treatment 等其他数据缺失值较多，不易处理) 。

单因素和多因素分析结果，风险评分是诊断早期肺癌预后的独立风险指标，见 Tab. \@ref(tab:META-Coefficients-Of-COX)。

```{r eval = T, echo = F, results = "asis"}
#| META-Coefficients-Of-COX
autor(coefMerged)
```


sigLusc <- lasso.lung$sig.uni_cox
sigLusc
sigLusc_less <- dplyr::filter(sigLusc, !feature %in% c("HERC3", "SPACA9"))
sigLusc_less


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-risk-score-related-genes-heatmap
autor(surv.GEO_lusc@params$p.surv_genes_hp)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-boxplot-of-risk-score
autor(surv.GEO_lusc@plots$step1$risk_score$p.boxplot)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-time-ROC
autor(surv.GEO_lusc@plots$step1$risk_score$p.roc)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-survival-curve-of-risk-score
autor(surv.GEO_lusc@plots$step1$risk_score$p.surv)
```


为了验证预后特征在不同数据平台上的性能，这里获取了 GEO 数据平台的早期肺癌数据 (GSE157010，微阵列数据)，并筛选了 Stage 为 I，II 阶段的病例。`r snap(lm.GEO_lusc, 1)`

```{r}
#' @meth {get_meth(geo.lusc)}
# geo.lusc <- readRDS("./geo.lusc.1.rds")
geo.lusc <- job_geo("GSE157010")
geo.lusc <- step1(geo.lusc)
metadata.geolusc <- dplyr::mutate(geo.lusc$guess,
  sample = rownames,
  vital_status = ifelse(os_event.ch1 == "0", "Alive", "Dead"),
  group = vital_status,
  days_to_last_follow_up = as.double(os_mo.ch1) * 30,
  stage = strx(Stage.ch1, "T[0-3]"),
  .before = 1
)
metadata.geolusc <- dplyr::filter(metadata.geolusc, stage != "T3")
metadata.geolusc
lm.GEO_lusc <- asjob_limma(geo.lusc, metadata.geolusc)
lm.GEO_lusc <- step1(lm.GEO_lusc, min.count = 1, pca = T)

# lm.GEO_lusc@object$genes <- dplyr::mutate(lm.GEO_lusc@object$genes, hgnc_symbol = strx(hgnc_symbol, "[^ ]+"))

lm.GEO_lusc@object$genes
lasso.GEO_lusc <- asjob_lasso(lm.GEO_lusc, unlist(en.mrna$raw), fun_scale = scale,
  use = "hgnc_symbol", dup_method = "max")
lasso.GEO_lusc <- step1(lasso.GEO_lusc)
# lasso.GEO_lusc <- step2(lasso.GEO_lusc)
# lasso.GEO_lusc <- step3(lasso.GEO_lusc, use_data = "all")
```

## Survival 生存分析 (GEO_LUSC)

GEO 数据集中，风险评分基因集表达特征见
Fig. \@ref(fig:GEO-LUSC-risk-score-related-genes-heatmap)
将 GEO 数据集按相同的方式处理，并计算风险评分，
生存结果见
Fig. \@ref(fig:GEO-LUSC-survival-curve-of-risk-score)
高风险组与低风险组显著差异。
ROC 曲线见
Fig. \@ref(fig:GEO-LUSC-time-ROC)。
第 1，3，5 年风险评分差异见
Fig. \@ref(fig:GEO-LUSC-boxplot-of-risk-score) 。

```{r}
#' @meth {get_meth(surv.GEO_lusc)}
surv.GEO_lusc <- asjob_survival(lasso.GEO_lusc, fea_coefs = sig.cox_lasso, force = T)
surv.GEO_lusc@params$p.surv_genes_hp
surv.GEO_lusc <- step1(surv.GEO_lusc, only_keep_sig = F)
surv.GEO_lusc@plots$step1$p.surv$risk_score
surv.GEO_lusc@plots$step1$p.boxplot$risk_score
surv.GEO_lusc@plots$step1$p.roc$risk_score
```


lst_test <- lapply(head(en.mrna@tables$step1$res.kegg$ups$geneName_list, n = 10),
  function(genes) {
    x <- asjob_lasso(lm.lung, genes)
    x <- step1(x)
    x <- step2(x, efs = F, use_data = "all")
    x <- step3(x, use_data = "all", use_tops = F, multi_cox = F)
    x$sig.uni_cox
  })

## GEO 数据获取 (GEO_LUSC)

```{r}
gds.lusc <- job_gds(c("Lung Squamous", "survival"), 20:2000)
gds.lusc <- step1(gds.lusc)
vis(gds.lusc)
active(gds.lusc)

geo.luscs <- batch_geo(dplyr::filter(gds.lusc@object, grpl(gdsType, "high"))$GSE)
geo.luscs$metas
gds.lusc@object$GSE[8]
```

为了验证预后特征在不同数据平台上的性能，这里获取了 GEO 数据平台的早期肺癌数据 (GSE157010，微阵列数据)，并筛选了 Stage 为 I，II 阶段的病例。`r snap(lm.GEO_lusc, 1)`

```{r}
#' @meth {get_meth(geo.lusc)}
# geo.lusc <- readRDS("./geo.lusc.1.rds")
geo.lusc <- job_geo("GSE157010")
geo.lusc <- step1(geo.lusc)
metadata.geolusc <- dplyr::mutate(geo.lusc$guess,
  sample = rownames,
  vital_status = ifelse(os_event.ch1 == "0", "Alive", "Dead"),
  group = vital_status,
  days_to_last_follow_up = as.double(os_mo.ch1) * 30,
  stage = strx(Stage.ch1, "T[0-3]"),
  .before = 1
)
metadata.geolusc <- dplyr::filter(metadata.geolusc,
  days_to_last_follow_up > 30,
  stage != "T3")
metadata.geolusc
lm.GEO_lusc <- asjob_limma(geo.lusc, metadata.geolusc)
# lm.GEO_lusc <- step1(lm.GEO_lusc, min.count = 0, pca = T)

# lm.GEO_lusc@object$genes <- dplyr::mutate(lm.GEO_lusc@object$genes, hgnc_symbol = strx(hgnc_symbol, "[^ ]+"))

lm.GEO_lusc@object$genes
lasso.GEO_lusc <- asjob_lasso(lm.GEO_lusc, unlist(en.mrna$raw),
  use = "hgnc_symbol", dup_method = "max")
lasso.GEO_lusc <- step1(lasso.GEO_lusc)
# lasso.GEO_lusc <- step2(lasso.GEO_lusc)
# lasso.GEO_lusc <- step3(lasso.GEO_lusc, use_data = "all")
```

## Survival 生存分析 (GEO_LUSC)

GEO 数据集中，风险评分基因集表达特征见
Fig. \@ref(fig:GEO-LUSC-risk-score-related-genes-heatmap)
将 GEO 数据集按相同的方式处理，并计算风险评分，
生存结果见
Fig. \@ref(fig:GEO-LUSC-survival-curve-of-risk-score)
高风险组与低风险组显著差异。
ROC 曲线见
Fig. \@ref(fig:GEO-LUSC-time-ROC)。
第 1，3，5 年风险评分差异见
Fig. \@ref(fig:GEO-LUSC-boxplot-of-risk-score) 。

```{r}
#' @meth {get_meth(surv.GEO_lusc)}
surv.GEO_lusc <- asjob_survival(lasso.GEO_lusc, fea_coefs = sig.cox_lasso, force = T)
surv.GEO_lusc@params$p.surv_genes_hp
surv.GEO_lusc <- step1(surv.GEO_lusc, only_keep_sig = F)
surv.GEO_lusc@plots$step1$p.surv$risk_score
surv.GEO_lusc@plots$step1$p.boxplot$risk_score
surv.GEO_lusc@plots$step1$p.roc$risk_score
```


metadata.geoluad <- dplyr::mutate(geo.luad$guess,
  sample = rownames,
  vital_status = ifelse(survstatus.ch1 == "0", "Alive", "Dead"),
  group = vital_status,
  days_to_last_follow_up = as.double(time.to.last.followup.ch1) * 30 * 12,
  stage = Stage.ch1,
  .before = 1
)
