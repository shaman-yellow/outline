

## WGCNA 分析 (MRNA)

```{r}
wg.mrna <- asjob_wgcna(lm.mrna, unlist(lm.mrna@plots$step3$p.sets_intersection$raw))
wg.mrna <- step1(wg.mrna)
wg.mrna@plots$step1
wg.mrna <- step2(wg.mrna)
wg.mrna <- step3(wg.mrna)
wg.mrna@plots$step3
wg.mrna <- step4(wg.mrna)
wg.mrna@plots$step4$net
wg.mrna <- step5(wg.mrna)
```

 
test <- function(...) {
  expr <- rlang::enquos(...)
  print(as.character(expr))
  dplyr::filter(eg, !!!expr)
}
test(x > 5, y > 7)


test <- survival::coxph(as.formula(paste0("Terror$target ~ ", colnames(Terror$data)[1])),
  data.frame(Terror$data, check.names = F))
plot(test)

test <- glmnet::glmnet(Terror$data[, 1, drop = F], Terror$target, alpha = 1, family = "cox")
plot(lasso.luad@params$model)

## STRINGdb PPI 分析 (MRNA)

```{r}
sdb.mrna <- job_stringdb(unlist(en.mrna$raw))
sdb.mrna <- step1(sdb.mrna)
sdb.mrna@plots$step1$p.ppi
sdb.mrna@plots$step1$p.mcc
sdb.mrna@tables$step1$hub_genes
```

## 富集分析 (MRNA-TOPS)

```{r}
en.mrnaTops <- job_enrich(head(sdb.mrna@tables$step1$hub_genes$Symbol, 30))
en.mrnaTops <- step1(en.mrnaTops)
en.mrnaTops@plots$step1$p.kegg
en.mrnaTops@plots$step1$p.go
```

surv.luscCross <- asjob_survival(lasso.lusc, sig.uni_cox = lasso.luad$sig.uni_cox, force = T)
surv.luscCross@params$p.surv_genes_hp
surv.luscCross <- step1(surv.luscCross)
surv.luscCross@plots$step1$risk_score$p.surv


## TCGA 数据获取 (LUSC)

```{r}
tc.lusc <- job_tcga("TCGA-LUSC")
tc.lusc <- step1(tc.lusc)
tc.lusc <- step2(tc.lusc)
tc.lusc <- step3(tc.lusc)
tc.lusc
```

## Survival 生存分析 (LUSC)

```{r}
lm.lusc <- asjob_limma(tc.lusc,
  grpl(ajcc_pathologic_stage, "Stage [I]{1,2}[AB]?$"),
  days_to_last_follow_up >= 10, isTumor == "tumor")
lm.lusc@params$t.common
lm.lusc <- step1(lm.lusc)
lm.lusc@object$targets

lasso.lusc <- asjob_lasso(lm.lusc, unlist(en.mrna$raw))
lasso.lusc <- step1(lasso.lusc)
lasso.lusc <- step2(lasso.lusc)
lasso.lusc <- step3(lasso.lusc, use_data = "all", nfold = 3, multi_cox = T)

surv.lusc <- asjob_survival(lasso.lusc)
surv.lusc <- step1(surv.lusc)
surv.lusc@plots$step1$risk_score$p.surv
```

## COX 回归 (Prognosis)

```{r}
meta4 <- tbmerge(
  select(lasso.lung$metadata, rownames,
    # smoking = paper_Smoking.Status,
    # treatment_or_therapy,
    age = age_at_index, gender, ajcc_pathologic_stage),
  select(surv.lung@object, rownames, risk_score),
  by = "rownames"
)
meta4 <- dplyr::mutate(meta4,
  # smoking = ifelse(is.na(smoking) | grpl(smoking, "N/A"),
    # "not reported", as.character(smoking)),
  ajcc_pathologic_stage = strx(ajcc_pathologic_stage, "Stage I[I]?"),
  age = ifelse(is.na(age), "not reported",
    ifelse(age > 65, "> 65", "<= 65"))
)
meta4 <- dplyr::filter(meta4, dplyr::if_all(-rownames, ~ !grpl(.x, "reported")))
summary_tibble(meta4)

#' @meth {get_meth(lasso.prog)}
lasso.prog <- job_lasso(meta4[, -1], filter(lasso.lung$metadata, rownames %in% meta4$rownames))
lasso.prog <- step1(lasso.prog)
lasso.prog <- step2(lasso.prog, efs = F)
lasso.prog <- step3(lasso.prog, multi_cox = T, alpha = 0, use_data = "all", multi_cox.inherits = F)
coefMerged <- lasso.prog@tables$step3$t.CoefficientsOfCOX
coefMerged <- dplyr::mutate(coefMerged, feature = dplyr::recode(feature,
    age = "Age (>65/<=64)", gender = "gender (female/male)",
    ajcc_pathologic_stage = "AJCC stage (I/II)", risk_score = "Risk score")
)
coefMerged
```

进一步通过单因素和多因素 COX 回归的方式评估了包括风险评分在内的4项预后特征 (smoking, treatment 等其他数据缺失值较多，不易处理) 。

单因素和多因素分析结果，风险评分是诊断早期肺癌预后的独立风险指标，见 Tab. \@ref(tab:META-Coefficients-Of-COX)。

```{r eval = T, echo = F, results = "asis"}
#| META-Coefficients-Of-COX
autor(coefMerged)
```


sigLusc <- lasso.lung$sig.uni_cox
sigLusc
sigLusc_less <- dplyr::filter(sigLusc, !feature %in% c("HERC3", "SPACA9"))
sigLusc_less


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-risk-score-related-genes-heatmap
autor(surv.GEO_lusc@params$p.surv_genes_hp)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-boxplot-of-risk-score
autor(surv.GEO_lusc@plots$step1$risk_score$p.boxplot)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-time-ROC
autor(surv.GEO_lusc@plots$step1$risk_score$p.roc)
```


```{r eval = T, echo = F, results = "asis"}
#| GEO-LUSC-survival-curve-of-risk-score
autor(surv.GEO_lusc@plots$step1$risk_score$p.surv)
```

