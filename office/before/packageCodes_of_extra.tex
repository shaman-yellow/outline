% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{caption} \captionsetup{font={footnotesize},width=6in} \renewcommand{\dblfloatpagefraction}{.9} \makeatletter \renewenvironment{figure} {\def\@captype{figure}} \makeatletter \definecolor{shadecolor}{RGB}{242,242,242} \usepackage{xeCJK} \usepackage{setspace} \setstretch{1.3}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={R codes of extra},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{R codes of extra}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{3}
\tableofcontents
}
\hypertarget{file-as_pca_df.r}{%
\section{File: as\_pca\_df.R}\label{file-as_pca_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{as\_pca\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
    \FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ df[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{t}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,]}
    \FunctionTok{rownames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(df) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{gsub}\NormalTok{(}\StringTok{" Peak area"}\NormalTok{, }\StringTok{""}\NormalTok{, .)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{adjust\_extremity }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_all}\NormalTok{(df, add\_1)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{add\_1 }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x}
\NormalTok{           )\{}
\NormalTok{    x }\OtherTok{\textless{}{-}}\NormalTok{ x }\SpecialCharTok{+} \DecValTok{1}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-auto_classy.r}{%
\section{File: auto\_classy.R}\label{file-auto_classy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gather\_classyfire }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"classyfire"}\NormalTok{,}
           \AttributeTok{class =} \StringTok{"Indoles and derivatives"}\NormalTok{,}
           \AttributeTok{inchi\_df =} \ConstantTok{NA}
\NormalTok{           )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =} \StringTok{"\^{}[0{-}9]\{1,100\}$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ file\_set }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ file\_set }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(}\StringTok{"(?\textless{}=/)[0{-}9]\{1,100\}$"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(class) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(Classification }\SpecialCharTok{==}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(class)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, Classification) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{classification =}\NormalTok{ Classification)}
\NormalTok{    \} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(inchi\_df))\{ }
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ inchi\_df }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{inchikey =}\NormalTok{ InChIKey) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{inchi2d =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(inchikey, }\StringTok{"\^{}[A{-}Z]\{1,1000\}"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{merge}\NormalTok{(list, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(inchi2d, }\AttributeTok{.keep\_all =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(inchi2d, classification)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{mutate\_auto\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{path =} \StringTok{"classyfire"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(path) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{dir.create}\NormalTok{(path)}
\NormalTok{    origin }\OtherTok{=} \FunctionTok{getwd}\NormalTok{()}
    \FunctionTok{setwd}\NormalTok{(path)}
    \FunctionTok{auto\_classy}\NormalTok{(df, ...)}
    \FunctionTok{setwd}\NormalTok{(origin)}
\NormalTok{  \}}
\NormalTok{auto\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# classyfireR}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(df, }\StringTok{".id"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, base\_auto\_classy,}
\NormalTok{                        ...)}
\NormalTok{  \}}
\NormalTok{base\_auto\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    .id }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{,][[}\StringTok{".id"}\NormalTok{]]}
    \FunctionTok{lapply}\NormalTok{(df[[}\StringTok{"InChIKey"}\NormalTok{]], base2\_classy,}
                      \AttributeTok{.id =}\NormalTok{ .id)}
\NormalTok{  \}}
\NormalTok{base2\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchi,}
\NormalTok{           .id}
\NormalTok{           )\{}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.id)), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(ch)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{get\_classification}\NormalTok{(inchi)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(ch))\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{classification}\NormalTok{(ch)}
      \FunctionTok{write\_tsv}\NormalTok{(ch, }\FunctionTok{paste0}\NormalTok{(.id))}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-by_group_as_list.r}{%
\section{File: by\_group\_as\_list.R}\label{file-by_group_as_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{by\_group\_as\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           colnames}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(df[[colnames]])}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(vector, by\_group\_as\_list\_select,}
                   \AttributeTok{df =}\NormalTok{ df,}
                   \AttributeTok{colNames =}\NormalTok{ colnames)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ vector}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{by\_group\_as\_list\_select }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           KEY,}
\NormalTok{           df,}
\NormalTok{           colNames}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[colNames]] }\SpecialCharTok{==}\NormalTok{ KEY), ]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_as_noise_pool.r}{%
\section{File: collate\_as\_noise\_pool.R}\label{file-collate_as_noise_pool.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{collate\_as\_noise\_pool }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    origin\_list,}
\NormalTok{    valid\_list}
\NormalTok{    )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# filter origin\_list}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{list =}\NormalTok{ origin\_list, }\AttributeTok{discard\_level1 =}\NormalTok{ T, }\AttributeTok{only\_peak\_info =}\NormalTok{ T, }\AttributeTok{mass\_shift =}\NormalTok{ F)}
    \DocumentationTok{\#\# get mz and intensity}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Catch main peak information}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(spectrum\_add\_noise, args)}
    \DocumentationTok{\#\# discard the NULL data}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Discard empty dataset}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(origin\_list, is.data.frame) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      origin\_list[.]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# order the origin\_list and valid\_list according to .id}
    \DocumentationTok{\#\# first, filter the origin\_list, only the .id in valid\_list is reserved.}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}}\NormalTok{ origin\_list[}\FunctionTok{names}\NormalTok{(origin\_list) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(valid\_list)]}
    \DocumentationTok{\#\# keep identical}
\NormalTok{    valid\_list }\OtherTok{\textless{}{-}}\NormalTok{ valid\_list[}\FunctionTok{names}\NormalTok{(valid\_list) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(origin\_list)]}
    \DocumentationTok{\#\# order}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Order the lists...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}} \FunctionTok{order\_list}\NormalTok{(origin\_list)}
\NormalTok{    valid\_list }\OtherTok{\textless{}{-}} \FunctionTok{order\_list}\NormalTok{(valid\_list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# list merge (use mapply)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Merge to get noise list}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    noise\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(numeric\_round\_merge, origin\_list, valid\_list,}
      \AttributeTok{main\_col =} \StringTok{"mass"}\NormalTok{, }\AttributeTok{sub\_col =} \StringTok{"mz"}\NormalTok{,}
      \AttributeTok{mz.tol =} \FloatTok{0.002}\NormalTok{, }\AttributeTok{noise =}\NormalTok{ T, }\AttributeTok{SIMPLIFY =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    noise\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(noise\_list, }\AttributeTok{fill =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(noise\_df, }\AttributeTok{mass =} \FunctionTok{as.numeric}\NormalTok{(mass), }\AttributeTok{inte =} \FunctionTok{as.numeric}\NormalTok{(inte))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{return}\NormalTok{(noise\_df)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{  \}}
\NormalTok{load\_all\_valid\_spectra }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
    \AttributeTok{formula\_adduct =}\NormalTok{ .MCn.formula\_set,}
    \AttributeTok{path =}\NormalTok{ .MCn.sirius}
\NormalTok{    )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Collate as metadata}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"\^{}[0{-}9]\{1,\}\_(.*)\_(.*)[0{-}9]\{1,\}$"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ .) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(dir, }\StringTok{"(?\textless{}=\_)[\^{}\_]\{1,\}$"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{merge}\NormalTok{(formula\_adduct, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, dir, precursorFormula, adduct) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{adduct =} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, adduct),}
        \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/spectra/"}\NormalTok{, precursorFormula, }\StringTok{"\_"}\NormalTok{, adduct, }\StringTok{".tsv"}\NormalTok{),}
        \AttributeTok{exists =} \FunctionTok{unlist}\NormalTok{(pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(file, file.exists), }\AttributeTok{use.names =}\NormalTok{ F)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(exists }\SpecialCharTok{==}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Read file and collate}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(metadata}\SpecialCharTok{$}\NormalTok{file, read\_tsv) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{select, mz, rel.intensity)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{.id}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_comment.r}{%
\section{File: collate\_comment.R}\label{file-collate_comment.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{collate\_comment }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           names}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(vector, base\_collate\_comment)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ names}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{base\_collate\_comment }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           string}
\NormalTok{           )\{}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(ch)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\StringTok{""}\NormalTok{, ch)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{"="}\NormalTok{, }\StringTok{"\#\#\#"}\NormalTok{, ch)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(ch, }\AttributeTok{split =} \StringTok{"\#\#\#"}\NormalTok{)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(ch, }\ControlFlowTok{function}\NormalTok{(str)\{}
\NormalTok{               df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{comment =}\NormalTok{ str[}\DecValTok{1}\NormalTok{], }\AttributeTok{record =}\NormalTok{ str[}\DecValTok{2}\NormalTok{])}
               \FunctionTok{return}\NormalTok{(df)}
\NormalTok{           \})}
\NormalTok{    ch }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(ch)}
    \FunctionTok{return}\NormalTok{(ch)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_structure_table.r}{%
\section{File: collate\_structure\_table.R}\label{file-collate_structure_table.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{collate\_structure\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{file =} \StringTok{"method\_pick\_formula\_excellent.structure.tsv"}\NormalTok{,}
           \AttributeTok{class =} \StringTok{"../canopus\_summary.tsv"}\NormalTok{,}
           \AttributeTok{cut\_tanimoto =} \FloatTok{0.4}\NormalTok{,}
           \AttributeTok{delete\_null =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    order }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{,}
              \StringTok{"most specific class"}\NormalTok{, }\StringTok{"inchikey2D"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(file)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ cut\_tanimoto) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name, tanimotoSimilarity, molecularFormula, inchikey2D) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{as.character}\NormalTok{(.id))}
\NormalTok{    class }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(class) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(name, }\StringTok{\textasciigrave{}}\AttributeTok{most specific class}\StringTok{\textasciigrave{}}\NormalTok{, adduct) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(name, }\StringTok{"(?\textless{}=\_)[0{-}9]\{1,4\}$"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, }\StringTok{\textasciigrave{}}\AttributeTok{most specific class}\StringTok{\textasciigrave{}}\NormalTok{, adduct)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, class, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(order)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(name, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(delete\_null }\SpecialCharTok{==}\NormalTok{ T)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, name }\SpecialCharTok{!=} \StringTok{"null"}\NormalTok{)}
    \FunctionTok{write\_tsv}\NormalTok{(df, }\StringTok{"table\_of\_pdf.tsv"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_top_score_structure.r}{%
\section{File: collate\_top\_score\_structure.R}\label{file-collate_top_score_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{collate\_top\_score\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"."}
\NormalTok{           )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"(?\textless{}=\_)[a{-}z]\{1,50\}[0{-}9]\{1,50\}$"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{sort}\NormalTok{()}
\NormalTok{    id\_set }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(file\_set, grep\_id) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unlist}\NormalTok{()}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(id\_set, base\_collate\_top)}
    \FunctionTok{names}\NormalTok{(structure\_set) }\OtherTok{=}\NormalTok{ id\_set}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(structure\_set, }\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(structure\_set)}
\NormalTok{  \}}
\NormalTok{base\_collate\_top }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(df }\OtherTok{\textless{}{-}} \FunctionTok{get\_structure}\NormalTok{(key\_id, }\AttributeTok{return\_row =} \DecValTok{1}\NormalTok{), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-compound_align.r}{%
\section{File: compound\_align.R}\label{file-compound_align.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{compound\_align }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           main,}
\NormalTok{           sub,}
           \AttributeTok{main\_col =} \StringTok{"mz"}\NormalTok{,}
           \AttributeTok{mz\_tol =} \FloatTok{0.002}\NormalTok{,}
           \AttributeTok{rt\_tol =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{mz\_wight =} \DecValTok{75}\NormalTok{,}
           \AttributeTok{rt\_wight =} \DecValTok{25}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(main[[main\_col]], mz\_align,}
                   \AttributeTok{df =}\NormalTok{ sub, }\AttributeTok{mz\_tol =}\NormalTok{ mz\_tol)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(rt\_tol))}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{rt\_align }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           the\_rt,}
\NormalTok{           df,}
           \AttributeTok{rt\_tol =} \FloatTok{0.1}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, rt }\SpecialCharTok{\textless{}=}\NormalTok{ the\_rt }\SpecialCharTok{+}\NormalTok{ rt\_tol }\SpecialCharTok{\&}
\NormalTok{                        rt }\SpecialCharTok{\textgreater{}=}\NormalTok{ the\_rt }\SpecialCharTok{{-}}\NormalTok{ rt\_tol)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mz\_align }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           the\_mz,}
\NormalTok{           df,}
           \AttributeTok{mz\_tol =} \FloatTok{0.002}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, mz }\SpecialCharTok{\textless{}=}\NormalTok{ the\_mz }\SpecialCharTok{+}\NormalTok{ mz\_tol }\SpecialCharTok{\&}
\NormalTok{                        mz }\SpecialCharTok{\textgreater{}=}\NormalTok{ the\_mz }\SpecialCharTok{{-}}\NormalTok{ mz\_tol)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-deal_with_msp_record.r}{%
\section{File: deal\_with\_msp\_record.R}\label{file-deal_with_msp_record.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate\_deal\_with\_msp\_record }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...,}
      \AttributeTok{mass\_sep =} \StringTok{" "}\NormalTok{,}
      \AttributeTok{input =} \FunctionTok{c}\NormalTok{(}
        \AttributeTok{name =} \StringTok{"Name"}\NormalTok{,}
        \AttributeTok{mass =} \StringTok{"PrecursorMZ"}\NormalTok{, }
        \AttributeTok{adduct =} \StringTok{"Precursor\_type"}\NormalTok{,}
        \AttributeTok{formula =} \StringTok{"Formula"}\NormalTok{,}
        \AttributeTok{rt =} \StringTok{"NA"}\NormalTok{),}
      \AttributeTok{other =} \FunctionTok{c}\NormalTok{(}
        \StringTok{"Name"}\NormalTok{, }\StringTok{"Synon"}\NormalTok{, }\StringTok{"DB\#"}\NormalTok{, }\StringTok{"InChIKey"}\NormalTok{,}
        \StringTok{"Precursor\_type"}\NormalTok{, }\StringTok{"Spectrum\_type"}\NormalTok{, }\StringTok{"PrecursorMZ"}\NormalTok{,}
        \StringTok{"Instrument\_type"}\NormalTok{, }\StringTok{"Instrument"}\NormalTok{, }\StringTok{"Ion\_mode"}\NormalTok{,}
        \StringTok{"Collision\_energy"}\NormalTok{, }\StringTok{"Formula"}\NormalTok{,}
        \StringTok{"MW"}\NormalTok{, }\StringTok{"ExactMass"}\NormalTok{, }\StringTok{"Comments"}\NormalTok{)}
\NormalTok{    )}
    \FunctionTok{do.call}\NormalTok{(deal\_with\_msp\_record, args)}
\NormalTok{  \}}
\NormalTok{deal\_with\_msp\_record }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
\NormalTok{    id\_prefix,}
\NormalTok{    cache,}
\NormalTok{    store,}
    \AttributeTok{mass\_level =} \DecValTok{2}\NormalTok{,}
    \AttributeTok{set\_rt =} \ConstantTok{NA}\NormalTok{,}
    \AttributeTok{mass\_sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}
    \AttributeTok{id =} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache),}
    \AttributeTok{input =} \FunctionTok{c}\NormalTok{(}\AttributeTok{name =} \StringTok{"NAME"}\NormalTok{,}
      \AttributeTok{mass =} \StringTok{"PRECURSORMZ"}\NormalTok{,}
      \AttributeTok{adduct =} \StringTok{"PRECURSORTYPE"}\NormalTok{,}
      \AttributeTok{formula =} \StringTok{"FORMULA"}\NormalTok{,}
      \AttributeTok{rt =} \StringTok{"RETENTIONTIME"}\NormalTok{),}
    \AttributeTok{other =} \FunctionTok{c}\NormalTok{(}\StringTok{"NAME"}\NormalTok{, }\StringTok{"PRECURSORMZ"}\NormalTok{, }\StringTok{"PRECURSORTYPE"}\NormalTok{,}
      \StringTok{"FORMULA"}\NormalTok{, }\StringTok{"Ontology"}\NormalTok{, }\StringTok{"INCHIKEY"}\NormalTok{, }\StringTok{"SMILES"}\NormalTok{,}
      \StringTok{"RETENTIONTIME"}\NormalTok{, }\StringTok{"CCS"}\NormalTok{, }\StringTok{"IONMODE"}\NormalTok{,}
      \StringTok{"INSTRUMENTTYPE"}\NormalTok{,}\StringTok{"INSTRUMENT"}\NormalTok{,}
      \StringTok{"COLLISIONENERGY"}\NormalTok{, }\StringTok{"Comment"}\NormalTok{, }\StringTok{"Num Peaks"}\NormalTok{),}
    \AttributeTok{output =} \FunctionTok{c}\NormalTok{(}\AttributeTok{begin =} \StringTok{"BEGIN IONS"}\NormalTok{,}
      \AttributeTok{id =} \StringTok{"FEATURE\_ID="}\NormalTok{,}
      \AttributeTok{mass =} \StringTok{"PEPMASS="}\NormalTok{,}
      \AttributeTok{charge =} \StringTok{"CHARGE="}\NormalTok{,}
      \AttributeTok{rt =} \StringTok{"RTINSECONDS="}\NormalTok{,}
      \AttributeTok{level =} \StringTok{"MSLEVEL="}\NormalTok{,}
      \AttributeTok{end =} \StringTok{"END IONS"}\NormalTok{),}
    \AttributeTok{add\_scans =}\NormalTok{ F}
\NormalTok{    )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get name and value}
\NormalTok{    name }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string)}
\NormalTok{    name }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(name) }\SpecialCharTok{==}\NormalTok{ T, }\StringTok{""}\NormalTok{, name)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[A{-}Z]"}\NormalTok{, name) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      value }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    cat }\OtherTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"name"}\NormalTok{]])\{}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# id update}
\NormalTok{      id }\OtherTok{=}\NormalTok{ id }\SpecialCharTok{+} \DecValTok{1}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, id, }\AttributeTok{envir =}\NormalTok{ cache)}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
      \DocumentationTok{\#\# output}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"id"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(id\_prefix, id)}
      \DocumentationTok{\#\# new var in envir: store}
\NormalTok{      info }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ s, }\AttributeTok{name =}\NormalTok{ value)}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"mass"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"mass"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=}\NormalTok{ value}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"adduct"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"charge"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}|]+"}\NormalTok{, value) }\SpecialCharTok{==}\NormalTok{ F, }\StringTok{"0"}\NormalTok{,}
        \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}"}\NormalTok{, value), }\StringTok{"1{-}"}\NormalTok{, }\StringTok{"1+"}\NormalTok{))}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[}\StringTok{"charge"}\NormalTok{]] }\OtherTok{=}\NormalTok{ s}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"adduct"}\NormalTok{, value, }\AttributeTok{envir =}\NormalTok{ cache)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"formula"}\NormalTok{]])\{}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"formula"}\NormalTok{, value, }\AttributeTok{envir =}\NormalTok{ cache)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"rt"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"rt"}\NormalTok{]]}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(set\_rt))\{}
\NormalTok{        s }\OtherTok{=}\NormalTok{ value}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        s }\OtherTok{=}\NormalTok{ set\_rt}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==} \StringTok{"Num Peaks"}\NormalTok{)\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{0}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(mass\_level }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
        \FunctionTok{catapp}\NormalTok{(info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"100}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
        \DocumentationTok{\#\# here, use rcdk to simulate calculate the isotope pattern}
\NormalTok{        adduct }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"adduct"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
        \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"FA|ACN"}\NormalTok{, adduct))\{}
\NormalTok{          adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"FA"}\NormalTok{, }\StringTok{"CO2H2"}\NormalTok{, adduct)}
\NormalTok{          adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"ACN"}\NormalTok{, }\StringTok{"C2H3N"}\NormalTok{, adduct)}
\NormalTok{        \}}
        \ControlFlowTok{if}\NormalTok{(adduct }\SpecialCharTok{!=} \StringTok{"[M+H{-}99]+"}\NormalTok{)\{}
\NormalTok{          formula }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"formula"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
          \DocumentationTok{\#\# according to adduct to revise formula}
\NormalTok{          formula }\OtherTok{\textless{}{-}} \FunctionTok{formula\_reshape\_with\_adduct}\NormalTok{(formula, adduct)}
          \DocumentationTok{\#\# rcdk function}
\NormalTok{          array }\OtherTok{\textless{}{-}} \FunctionTok{get.isotopes.pattern}\NormalTok{(}\FunctionTok{get.formula}\NormalTok{(formula))}
          \FunctionTok{apply}\NormalTok{(array, }\DecValTok{1}\NormalTok{, cat\_isotope)}
\NormalTok{        \}}
        \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"end"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \DocumentationTok{\#\# begin mass level 2}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"id"}\NormalTok{]], info[[}\StringTok{".id"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"mass"}\NormalTok{]], info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"charge"}\NormalTok{]], info[[}\StringTok{"charge"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(set\_rt))}
\NormalTok{        info[[}\StringTok{"RETENTIONTIME"}\NormalTok{]] }\OtherTok{=}\NormalTok{ set\_rt}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"rt"}\NormalTok{]], info[[}\StringTok{"RETENTIONTIME"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(}\StringTok{"MERGED\_STATS=1 / 1 (0 removed due to low quality, 0 removed due to low cosine)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[0{-}9]"}\NormalTok{, string))\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{2}
\NormalTok{      p }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string, }\AttributeTok{sep =}\NormalTok{ mass\_sep)}
\NormalTok{      s }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string, }\AttributeTok{sep =}\NormalTok{ mass\_sep)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(string }\SpecialCharTok{==} \StringTok{""}\NormalTok{)\{}
\NormalTok{      ion }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
      \ControlFlowTok{if}\NormalTok{(ion }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{()}
\NormalTok{      \}}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"end"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(add\_scans }\SpecialCharTok{==}\NormalTok{ T)\{}
        \ControlFlowTok{if}\NormalTok{(p }\SpecialCharTok{==}\NormalTok{ output[[}\StringTok{"mass"}\NormalTok{]])\{}
\NormalTok{          id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
          \FunctionTok{catapp}\NormalTok{(}\StringTok{"SCANS="}\NormalTok{, id, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# data store}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{\%in\%}\NormalTok{ other }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[name]] }\OtherTok{=}\NormalTok{ value}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# output}
\NormalTok{  \}}
\NormalTok{catapp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    ...,}
    \AttributeTok{sep =} \StringTok{""}\NormalTok{,}
    \AttributeTok{mgf =} \FunctionTok{get}\NormalTok{(}\StringTok{"mgf"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{    )\{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste}\NormalTok{(..., }\AttributeTok{sep =}\NormalTok{ sep), }\AttributeTok{file =}\NormalTok{ mgf, }\AttributeTok{append =}\NormalTok{ T)}
\NormalTok{  \}}
\NormalTok{cat\_isotope }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    vector}
\NormalTok{    )\{}
    \FunctionTok{catapp}\NormalTok{(vector[}\DecValTok{1}\NormalTok{], vector[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{get\_value }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
    \AttributeTok{sep =} \StringTok{": "}
\NormalTok{    )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{2}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{get\_name }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
    \AttributeTok{sep =} \StringTok{": "}
\NormalTok{    )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{1}\NormalTok{])}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-filter_via_rownames.r}{%
\section{File: filter\_via\_rownames.R}\label{file-filter_via_rownames.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{filter\_via\_rownames }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           row}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{rownames}\NormalTok{(df) }\SpecialCharTok{\%in\%}\NormalTok{ row, ]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-flow_collate_skeleton.r}{%
\section{File: flow\_collate\_skeleton.R}\label{file-flow_collate_skeleton.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{flow\_collate\_skeleton }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           classes,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{lapply}\NormalTok{(classes, base\_flow, ...)}
\NormalTok{  \}}
\NormalTok{base\_flow }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           class,}
           \AttributeTok{savepath =} \StringTok{"\textasciitilde{}/extra/data"}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] the class is \textgreater{}\textgreater{}\textgreater{}"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(class), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Enter the skeleton smiles:}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    smiles }\OtherTok{\textless{}{-}} \FunctionTok{scan}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{, }\AttributeTok{what =} \StringTok{"character"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(smiles) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
      \FunctionTok{write.table}\NormalTok{(smiles, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(savepath, }\StringTok{"/"}\NormalTok{, class),}
                  \AttributeTok{col.names =}\NormalTok{ F, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generic_horizon_bar.r}{%
\section{File: generic\_horizon\_bar.R}\label{file-generic_horizon_bar.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{generic\_horizon\_bar }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{scale\_fill\_expression =} \StringTok{"scale\_fill\_gradient(high = \textquotesingle{}\#E6550DFF\textquotesingle{}, low = \textquotesingle{}\#FDD0A2FF\textquotesingle{})"}\NormalTok{,}
           \AttributeTok{x =} \FunctionTok{colnames}\NormalTok{(df)[}\DecValTok{1}\NormalTok{],}
           \AttributeTok{y =} \FunctionTok{colnames}\NormalTok{(df)[}\DecValTok{2}\NormalTok{],}
           \AttributeTok{ylab =} \StringTok{"stat"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{position =} \StringTok{"identity"}\NormalTok{,}
           \AttributeTok{save =} \StringTok{"tmp.svg"}
\NormalTok{           )\{}
\NormalTok{    df[[x]] }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(df[[x]], }\AttributeTok{width =} \DecValTok{35}\NormalTok{)}
\NormalTok{    df[[x]] }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df[[x]], }\AttributeTok{levels =}\NormalTok{ df[[x]][}\FunctionTok{order}\NormalTok{(df[[y]], }\AttributeTok{decreasing =}\NormalTok{ F)])}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ x)),}
                    \AttributeTok{y =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ y)),}
                    \AttributeTok{fill =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ y)))) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{position =}\NormalTok{ position) }\SpecialCharTok{+}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ scale\_fill\_expression)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{16}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ save, }\AttributeTok{width =} \DecValTok{6}\NormalTok{, }\AttributeTok{height =} \DecValTok{12}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_hierarchy.in_df.r}{%
\section{File: get\_hierarchy.in\_df.R}\label{file-get_hierarchy.in_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_hierarchy.in\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{col =} \StringTok{"Classification"}
\NormalTok{           )\{}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_get\_parent\_class}\NormalTok{(df[[col]], }\AttributeTok{class\_cutof =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(vec)\{}\FunctionTok{length}\NormalTok{(vec) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{\}) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{hierarchy =} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ col)),}
                                           \ControlFlowTok{function}\NormalTok{(class)\{}
\NormalTok{                                             deep[[class]]}
\NormalTok{                                           \})))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_reference_class_density.r}{%
\section{File: get\_reference\_class\_density.R}\label{file-get_reference_class_density.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_reference\_class\_density }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"classyfire"}
\NormalTok{           )\{}
\NormalTok{    distribution }\OtherTok{\textless{}{-}} \FunctionTok{show\_distribution}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path)}
    \DocumentationTok{\#\# metadata show all classification}
\NormalTok{    meta\_distribution }\OtherTok{\textless{}{-}}\NormalTok{ distribution }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(Level, Classification) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{level =}\NormalTok{ Level, }\AttributeTok{classification =}\NormalTok{ Classification)}
    \DocumentationTok{\#\# classes distribution density table}
\NormalTok{    table\_distribution }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(distribution}\SpecialCharTok{$}\NormalTok{Classification) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.table}\NormalTok{(}\AttributeTok{classification =} \FunctionTok{names}\NormalTok{(.), }\AttributeTok{sum =} \FunctionTok{unname}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(classification, sum.N)}
    \DocumentationTok{\#\# merge meta and density stat}
\NormalTok{    reference\_density }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(meta\_distribution, table\_distribution,}
                               \AttributeTok{by =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(level) }\SpecialCharTok{==}\NormalTok{ F)}
    \FunctionTok{return}\NormalTok{(reference\_density)}
\NormalTok{  \}}
\NormalTok{get\_reference\_class\_parent }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{min\_possess =} \DecValTok{50}
\NormalTok{           )\{}
\NormalTok{    test }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{filter}\NormalTok{(sum.N }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_possess, }\SpecialCharTok{!}\NormalTok{level }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"superclass"}\NormalTok{, }\StringTok{"kingdom"}\NormalTok{))}
\NormalTok{    p\_test }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_get\_parent\_class}\NormalTok{(test}\SpecialCharTok{$}\NormalTok{class, }\AttributeTok{this\_class =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(end\_of\_vector) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unname}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(p\_test)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-horizon_bar_accuracy.r}{%
\section{File: horizon\_bar\_accuracy.R}\label{file-horizon_bar_accuracy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{horizon\_bar\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{ylab =} \StringTok{"stat ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{extra\_sides\_df =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{return\_p =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(df, }\AttributeTok{id.vars =} \StringTok{"classification"}\NormalTok{,}
                         \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                         \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{classification =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                        \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
                        \AttributeTok{type =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                    \AttributeTok{y =}\NormalTok{ value,}
                    \AttributeTok{fill =}\NormalTok{ type)) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{,}
               \AttributeTok{position =} \StringTok{"stack"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(extra\_sides\_df))\{}
\NormalTok{      max }\OtherTok{=} \DecValTok{500}
\NormalTok{      ps }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ extra\_sides\_df) }\SpecialCharTok{+}
        \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(sum }\SpecialCharTok{\textgreater{}=}\NormalTok{ max, max, sum))) }\SpecialCharTok{+}
        \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, max) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{svg}\NormalTok{(savename, }\AttributeTok{width =} \DecValTok{14}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{)}
      \FunctionTok{grid.newpage}\NormalTok{()}
      \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{20}\NormalTok{) ))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{12}\NormalTok{))}
      \FunctionTok{print}\NormalTok{( ps, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{95}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{13}\SpecialCharTok{:}\DecValTok{19}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{dev.off}\NormalTok{()}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(return\_p }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(p)}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-list_merge_df.r}{%
\section{File: list\_merge\_df.R}\label{file-list_merge_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{list\_merge\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           df,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, merge,}
                   \AttributeTok{y =} \FunctionTok{get}\NormalTok{(}\StringTok{"df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{)),}
\NormalTok{                   ...)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-load_extra.r}{%
\section{File: load\_extra.R}\label{file-load_extra.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{load\_extra }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/extra/R"}
\NormalTok{           )\{}
    \FunctionTok{load\_all}\NormalTok{(path)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-load_mgf.r}{%
\section{File: load\_mgf.R}\label{file-load_mgf.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{filter\_mgf }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{filter\_id =} \FunctionTok{prapare\_inst\_data}\NormalTok{(.MCn.structure\_set)}\SpecialCharTok{$}\NormalTok{.id,}
           \AttributeTok{file =} \StringTok{"\textasciitilde{}/Downloads/msp/msms\_pos\_gnps.msp.mgf"}
\NormalTok{           )\{}
\NormalTok{    mgf }\OtherTok{\textless{}{-}} \FunctionTok{read\_msp}\NormalTok{(file)}
\NormalTok{    start }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(mgf}\SpecialCharTok{$}\NormalTok{V1 }\SpecialCharTok{==} \StringTok{"BEGIN IONS"}\NormalTok{)}
\NormalTok{    end }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(mgf}\SpecialCharTok{$}\NormalTok{V1 }\SpecialCharTok{==} \StringTok{""}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ mgf[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"FEATURE\_ID"}\NormalTok{, mgf}\SpecialCharTok{$}\NormalTok{V1), ]}
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(id, }\StringTok{"(?\textless{}==).*$"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
      \ControlFlowTok{function}\NormalTok{(start, end, mgf) \{}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(mgf, start}\SpecialCharTok{:}\NormalTok{end)}
\NormalTok{      \}}
\NormalTok{      start, end, }\AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{mgf =}\NormalTok{ mgf), }\AttributeTok{SIMPLIFY =}\NormalTok{ F}
\NormalTok{    )}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ id}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(filter\_id) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{\%in\%}\NormalTok{ filter\_id]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-load_svg.r}{%
\section{File: load\_svg.R}\label{file-load_svg.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_svg }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{as\_cairo =}\NormalTok{ T,}
           \AttributeTok{grobify =}\NormalTok{ F,}
           \AttributeTok{arrange =}\NormalTok{ F}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(as\_cairo)}
\NormalTok{      rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(file, file)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(file)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(grobify)}
\NormalTok{      svg }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{grobify}\NormalTok{(svg)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(arrange)}
\NormalTok{      svg }\OtherTok{\textless{}{-}}\NormalTok{ gridExtra}\SpecialCharTok{::}\FunctionTok{arrangeGrob}\NormalTok{(svg)}
    \FunctionTok{return}\NormalTok{(svg)}
\NormalTok{  \}}
\NormalTok{grid\_draw\_svg.legend }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           main,}
\NormalTok{           legend,}
\NormalTok{           savename,}
           \AttributeTok{position.main =} \FloatTok{0.55}\NormalTok{,}
           \AttributeTok{position.legend =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{main\_size =} \DecValTok{1}\NormalTok{,}
           \AttributeTok{legend\_size =} \FloatTok{0.8}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{13}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{12}
\NormalTok{           )\{}
    \FunctionTok{svg}\NormalTok{(savename, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    grImport2}\SpecialCharTok{::}\FunctionTok{grid.picture}\NormalTok{(main, }\AttributeTok{width =}\NormalTok{ main\_size, }\AttributeTok{height =}\NormalTok{ main\_size, }\AttributeTok{x =}\NormalTok{ position.main)}
\NormalTok{    grImport2}\SpecialCharTok{::}\FunctionTok{grid.picture}\NormalTok{(legend, }\AttributeTok{width =}\NormalTok{ legend\_size, }\AttributeTok{height =}\NormalTok{ legend\_size, }\AttributeTok{x =}\NormalTok{ position.legend)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mass_shift.r}{%
\section{File: mass\_shift.R}\label{file-mass_shift.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# |mass      |inte |}
\CommentTok{\# |:{-}{-}{-}{-}{-}{-}{-}{-}{-}|:{-}{-}{-}{-}|}
\CommentTok{\# |117.06971 |20   |}
\NormalTok{mass\_shift }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{merge =}\NormalTok{ T,}
           \AttributeTok{sep =} \StringTok{" "}\NormalTok{,}
           \AttributeTok{int.sigma =} \DecValTok{1}\NormalTok{,}
           \AttributeTok{re.ppm =} \FloatTok{1e{-}6}\NormalTok{,}
           \AttributeTok{global.sigma =} \DecValTok{10}\SpecialCharTok{/}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ re.ppm,}
           \AttributeTok{indivi.sigma =} \DecValTok{10}\SpecialCharTok{/}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ re.ppm,}
           \AttributeTok{sub.factor =} \FloatTok{0.03}\NormalTok{,}
           \AttributeTok{.noise\_pool =}\NormalTok{ noise\_pool,}
           \AttributeTok{alpha =} \FloatTok{0.2}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =} \FunctionTok{as.numeric}\NormalTok{(mass), }\AttributeTok{inte =} \FunctionTok{as.numeric}\NormalTok{(inte))}
    \DocumentationTok{\#\# intensity variation}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df), }\DecValTok{1}\NormalTok{, int.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{inte =}\NormalTok{ inte }\SpecialCharTok{*}\NormalTok{ var)}
    \DocumentationTok{\#\# subtract according to max intensity}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{inte =} \FunctionTok{round}\NormalTok{(inte }\SpecialCharTok{{-}} \FunctionTok{max}\NormalTok{(inte) }\SpecialCharTok{*}\NormalTok{ sub.factor, }\DecValTok{0}\NormalTok{))}
    \DocumentationTok{\#\# if intensity less than 0, discard}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, inte }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \DocumentationTok{\#\# almost one peak, discard the data}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\textless{}=} \DecValTok{1}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# global shift}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, global.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =}\NormalTok{ mass }\SpecialCharTok{+}\NormalTok{ mass }\SpecialCharTok{*}\NormalTok{ var)}
    \DocumentationTok{\#\# individual shift}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df), }\DecValTok{0}\NormalTok{, indivi.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =} \FunctionTok{round}\NormalTok{(mass }\SpecialCharTok{+}\NormalTok{ mass }\SpecialCharTok{*}\NormalTok{ var, }\DecValTok{4}\NormalTok{))}
    \DocumentationTok{\#\# add noise peak}
    \DocumentationTok{\#\# random drawn noise peak from noise pool}
\NormalTok{    noise }\OtherTok{\textless{}{-}}\NormalTok{ .noise\_pool[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.noise\_pool), }\FunctionTok{round}\NormalTok{(alpha }\SpecialCharTok{*} \FunctionTok{nrow}\NormalTok{(df))), ]}
    \DocumentationTok{\#\# reshape intensity}
\NormalTok{    noise }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(noise, }\AttributeTok{inte =} \FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{inte) }\SpecialCharTok{*}\NormalTok{ re.inte)}
    \DocumentationTok{\#\# bind into df}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(df, dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(noise, mass, inte))}
    \ControlFlowTok{if}\NormalTok{(merge)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(mass, sep, inte))}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, V1)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-merge_horizon_accuracy.r}{%
\section{File: merge\_horizon\_accuracy.R}\label{file-merge_horizon_accuracy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{merge\_horizon\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{ylab =} \StringTok{"stat ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{return\_p =}\NormalTok{ t}
\NormalTok{           )\{}
\NormalTok{    list.name }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(list)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, reshape2}\SpecialCharTok{::}\NormalTok{melt,}
                   \AttributeTok{id.vars =} \StringTok{"classification"}\NormalTok{,}
                   \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                   \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
                   \AttributeTok{classification =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                   \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
                   \AttributeTok{type =}\NormalTok{ hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ t) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(type }\SpecialCharTok{==} \StringTok{"true"}\NormalTok{)}
\NormalTok{    line\_df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{dcast}\NormalTok{(df, classification }\SpecialCharTok{+}\NormalTok{ type }\SpecialCharTok{\textasciitilde{}}\NormalTok{ .id)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                    \AttributeTok{y =}\NormalTok{ value,}
                    \AttributeTok{color =}\NormalTok{ .id)) }\SpecialCharTok{+}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ line\_df,}
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                       \AttributeTok{xend =}\NormalTok{ classification,}
                       \AttributeTok{y =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciigrave{}"}\NormalTok{, list.name[}\DecValTok{1}\NormalTok{], }\StringTok{"\textasciigrave{}"}\NormalTok{))),}
                       \AttributeTok{yend =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciigrave{}"}\NormalTok{, list.name[}\DecValTok{2}\NormalTok{], }\StringTok{"\textasciigrave{}"}\NormalTok{)))),}
                   \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{,}
                 \AttributeTok{position =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{color =}\NormalTok{ hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(return\_p }\SpecialCharTok{==}\NormalTok{ t)}
        \FunctionTok{return}\NormalTok{(p)}
      \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{mutate\_merge\_horizon\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{ylab =} \StringTok{"stat ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{return\_p =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, reshape2}\SpecialCharTok{::}\NormalTok{melt,}
                   \AttributeTok{id.vars =} \StringTok{"classification"}\NormalTok{,}
                   \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                   \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
                   \AttributeTok{classification =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                   \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
                   \AttributeTok{type =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(type }\SpecialCharTok{==} \StringTok{"True"}\NormalTok{)}
\NormalTok{    line\_df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{dcast}\NormalTok{(df, classification }\SpecialCharTok{+}\NormalTok{ type }\SpecialCharTok{\textasciitilde{}}\NormalTok{ .id)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                    \AttributeTok{y =}\NormalTok{ value,}
                    \AttributeTok{color =}\NormalTok{ .id)) }\SpecialCharTok{+}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ line\_df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification, }\AttributeTok{y =}\NormalTok{ origin, }\AttributeTok{yend =}\NormalTok{ re\_rank),}
                   \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{,}
                 \AttributeTok{position =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(return\_p }\SpecialCharTok{==}\NormalTok{ T)}
        \FunctionTok{return}\NormalTok{(p)}
      \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_compound_filter.r}{%
\section{File: meta\_compound\_filter.R}\label{file-meta_compound_filter.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_compound\_filter }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           vip,}
           \AttributeTok{dose =} \StringTok{"high"}\NormalTok{,}
           \AttributeTok{l\_abs\_log\_fc =} \DecValTok{1}\NormalTok{, }\DocumentationTok{\#\# or 0}
           \AttributeTok{l\_q\_value =} \FloatTok{0.05}\NormalTok{, }\DocumentationTok{\#\# or 1}
           \AttributeTok{l\_vip =} \DecValTok{1}\NormalTok{, }\DocumentationTok{\#\# or 0}
           \AttributeTok{id\_fix =}\NormalTok{ T,}
           \AttributeTok{round =}\NormalTok{ T}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(id\_fix }\SpecialCharTok{==}\NormalTok{ T)}
\NormalTok{      vip }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(vip, }\AttributeTok{id =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"X"}\NormalTok{, }\StringTok{""}\NormalTok{, id))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(round }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(set, }\AttributeTok{log2.fc =} \FunctionTok{round}\NormalTok{(log2.fc, }\DecValTok{2}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# control and model}
\NormalTok{    part1 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(set, facet\_row }\SpecialCharTok{==} \StringTok{"extra"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(vip, }\AttributeTok{by =} \StringTok{"id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(vip }\SpecialCharTok{\textgreater{}}\NormalTok{ l\_vip,}
                    \FunctionTok{abs}\NormalTok{(log2.fc) }\SpecialCharTok{\textgreater{}}\NormalTok{ l\_abs\_log\_fc,}
\NormalTok{                    q\_value }\SpecialCharTok{\textless{}}\NormalTok{ l\_q\_value) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(round }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      part1 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(part1, }\AttributeTok{vip =} \FunctionTok{round}\NormalTok{(vip, }\DecValTok{2}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# drug dispose}
\NormalTok{    part2 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(set, facet\_row }\SpecialCharTok{==} \StringTok{"high"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{by\_group\_as\_list}\NormalTok{(}\StringTok{"facet\_col"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} rename the col}
      \FunctionTok{lapply}\NormalTok{(., meta\_rename\_prefix,}
             \AttributeTok{col =} \FunctionTok{c}\NormalTok{(}\StringTok{"p\_value"}\NormalTok{, }\StringTok{"q\_value"}\NormalTok{, }\StringTok{"log2.fc"}\NormalTok{),}
             \AttributeTok{prefix\_from\_col =} \StringTok{"facet\_col"}\NormalTok{, }\AttributeTok{internal =} \StringTok{"\#"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} select the needed col}
      \FunctionTok{lapply}\NormalTok{(., dplyr}\SpecialCharTok{::}\NormalTok{select,}
\NormalTok{             id, }\FunctionTok{contains}\NormalTok{(}\StringTok{"\#"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} merge into a data.frame}
      \FunctionTok{meta\_merge\_list}\NormalTok{(}\AttributeTok{col =} \StringTok{"id"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather data}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ part1 }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(id, vip) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(., part2, }\AttributeTok{by =} \StringTok{"id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\FunctionTok{abs}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{raw\_model\#log2.fc}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\textgreater{}} \DecValTok{1} \SpecialCharTok{|} \FunctionTok{abs}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{pro\_model\#log2.fc}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{meta\_rename\_prefix }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           col,}
           \AttributeTok{prefix =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{prefix\_from\_col =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{internal =} \StringTok{"."}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(prefix\_from\_col) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df[}\DecValTok{1}\NormalTok{, ][[prefix\_from\_col]], internal)}
\NormalTok{    \}}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{base\_meta\_rename\_prefix}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df),}
                                            \AttributeTok{mutate =}\NormalTok{ col,}
                                            \AttributeTok{PREFIX =}\NormalTok{ prefix)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{base\_meta\_rename\_prefix }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           names,}
\NormalTok{           mutate,}
\NormalTok{           PREFIX}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{origin =}\NormalTok{ names) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{change =} \FunctionTok{ifelse}\NormalTok{(origin }\SpecialCharTok{\%in\%}\NormalTok{ mutate,}
                                    \FunctionTok{paste0}\NormalTok{(PREFIX, origin),}
\NormalTok{                                    origin))}
    \FunctionTok{return}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{change)}
\NormalTok{  \}}
\NormalTok{meta\_merge\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
           \AttributeTok{col =} \StringTok{"id"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ list[[}\DecValTok{1}\NormalTok{]]}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(list))\{}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, list[[i]], }\AttributeTok{by =}\NormalTok{ col, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_do_list.r}{%
\section{File: meta\_do\_list.R}\label{file-meta_do_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_do\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metadata}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(metadata, }\StringTok{"group"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, select, sample) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(unlist) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(unname)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_gather_pub_classyfire_sirius.r}{%
\section{File: meta\_gather\_pub\_classyfire\_sirius.R}\label{file-meta_gather_pub_classyfire_sirius.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_gather\_pub\_classyfire\_sirius }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \DocumentationTok{\#\# contain sp.id}
\NormalTok{           pub,}
\NormalTok{           class,}
           \DocumentationTok{\#\# contain sp.id}
\NormalTok{           sirius}
\NormalTok{           )\{}
\NormalTok{    class\_anno }\OtherTok{\textless{}{-}} \FunctionTok{gather\_classyfire}\NormalTok{(}\AttributeTok{class =}\NormalTok{ class, }\AttributeTok{inchi\_df =}\NormalTok{ pub)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# annotate sirius results with classification}
\NormalTok{    simp\_candi }\OtherTok{\textless{}{-}}\NormalTok{ sirius }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{merge}\NormalTok{(class\_anno, }\AttributeTok{by.x =} \StringTok{"inchikey2D"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"inchi2d"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(classification }\SpecialCharTok{==}\NormalTok{ class) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, inchikey2D, name, classification, tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{sp.id =} \FunctionTok{rownames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(simp\_candi)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_get_couple.r}{%
\section{File: meta\_get\_couple.R}\label{file-meta_get_couple.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_get\_couple }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           group}
\NormalTok{           )\{}
\NormalTok{    compare }\OtherTok{\textless{}{-}}\NormalTok{ group }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      .[}\FunctionTok{which}\NormalTok{(}\SpecialCharTok{!}\NormalTok{. }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"blank"}\NormalTok{, }\StringTok{"positive"}\NormalTok{))] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{combn}\NormalTok{(}\DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{t}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# exclude group compare in different dosage}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(V1, }\StringTok{"\_.*$"}\NormalTok{) }\SpecialCharTok{==}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(V2, }\StringTok{"\_.*$"}\NormalTok{) }\SpecialCharTok{|}
                    \DocumentationTok{\#\# get the control or model group}
\NormalTok{                    V1 }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\NormalTok{, }\StringTok{"model"}\NormalTok{) }\SpecialCharTok{|}
\NormalTok{                    V2 }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\NormalTok{, }\StringTok{"model"}\NormalTok{),}
                  \DocumentationTok{\#\# with control, only compare with model}
                  \SpecialCharTok{!}\NormalTok{(V1 }\SpecialCharTok{==} \StringTok{"control"} \SpecialCharTok{\&}\NormalTok{ V2 }\SpecialCharTok{!=} \StringTok{"model"}\NormalTok{),}
                  \SpecialCharTok{!}\NormalTok{(V2 }\SpecialCharTok{==} \StringTok{"control"} \SpecialCharTok{\&}\NormalTok{ V1 }\SpecialCharTok{!=} \StringTok{"model"}\NormalTok{))}
      \FunctionTok{return}\NormalTok{(compare)}
\NormalTok{  \}}
\NormalTok{meta\_get\_extra\_couple }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           compare,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    extra\_compare\_1 }\OtherTok{\textless{}{-}}\NormalTok{ compare }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\NormalTok{((V1 }\SpecialCharTok{==} \StringTok{"control"} \SpecialCharTok{\&}\NormalTok{ V2 }\SpecialCharTok{==}\StringTok{"model"}\NormalTok{) }\SpecialCharTok{|}\NormalTok{ (V1 }\SpecialCharTok{==} \StringTok{"model"} \SpecialCharTok{\&}\NormalTok{ V2 }\SpecialCharTok{==} \StringTok{"control"}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{V3 =} \StringTok{"control"}\NormalTok{, }\AttributeTok{V4 =} \StringTok{"model"}\NormalTok{)}
\NormalTok{    extra\_compare\_2 }\OtherTok{\textless{}{-}}\NormalTok{ extra\_compare\_1 }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, .meta\_muti\_add) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(unlist) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
\NormalTok{    extra\_compare\_3 }\OtherTok{\textless{}{-}}\NormalTok{ compare }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, .meta\_muti\_add) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(unlist) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      .[}\FunctionTok{which}\NormalTok{(}\FunctionTok{lengths}\NormalTok{(.) }\SpecialCharTok{!=} \DecValTok{2}\NormalTok{)]}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(extra\_compare\_1, extra\_compare\_2, extra\_compare\_3)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"c1"}\NormalTok{, }\StringTok{"c2"}\NormalTok{, }\StringTok{"c3"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{.meta\_muti\_add }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
           \AttributeTok{dose =} \FunctionTok{c}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\StringTok{"medium"}\NormalTok{, }\StringTok{"low"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    group }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(vector, }\StringTok{"\^{}.*(?=\_)"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{sort}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{expand.grid}\NormalTok{(dose) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{combine =} \FunctionTok{paste0}\NormalTok{(Var1, }\StringTok{"\_"}\NormalTok{, Var2))}
\NormalTok{    combine }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{combine, vector) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(combine)}
\NormalTok{  \}}
\NormalTok{vector\_delete\_var }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           delete}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}}\NormalTok{ vector[}\SpecialCharTok{!}\NormalTok{vector }\SpecialCharTok{\%in\%}\NormalTok{ delete]}
    \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_get_metadata.r}{%
\section{File: meta\_get\_metadata.R}\label{file-meta_get_metadata.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_get\_metadata }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           mzmine\_col\_peak\_area}
\NormalTok{           )\{}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ mzmine\_col\_peak\_area }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{gsub}\NormalTok{(}\StringTok{" Peak area"}\NormalTok{, }\StringTok{""}\NormalTok{, .) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{sample =}\NormalTok{ .) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(sample, }\StringTok{".*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.)"}\NormalTok{),}
                    \AttributeTok{prefix =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(name, }\StringTok{"[\^{}[0{-}9]]*(?=[0{-}9])"}\NormalTok{),}
                    \AttributeTok{identifier =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(name, }\StringTok{"[0{-}9]\{1,100\}"}\NormalTok{),}
                    \AttributeTok{group =} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(prefix, sub\_data, }\AttributeTok{meta =}\NormalTok{ GROUP)),}
                    \AttributeTok{identifier =} \FunctionTok{paste0}\NormalTok{(group, }\StringTok{"\_"}\NormalTok{, identifier),}
                    \AttributeTok{super\_group =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\_.*$"}\NormalTok{, }\StringTok{""}\NormalTok{, group)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(sample, identifier, group, super\_group) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(identifier)}
    \FunctionTok{return}\NormalTok{(metadata)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_metabo_pathway.r}{%
\section{File: meta\_metabo\_pathway.R}\label{file-meta_metabo_pathway.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_metabo\_pathway }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{export =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{mz\_rt =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{p\_col =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{extra\_entity =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{only\_return =}\NormalTok{ F,}
           \DocumentationTok{\#\# from name involves the character rename into the columns}
           \AttributeTok{key =} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{, }\StringTok{"q\_value"}\NormalTok{, }\StringTok{"log2.fc"}\NormalTok{, }\StringTok{"rt"}\NormalTok{),}
           \DocumentationTok{\#\# note that both key and as\_col must be ordered}
           \AttributeTok{as\_col =} \FunctionTok{c}\NormalTok{(}\StringTok{"m.z"}\NormalTok{, }\StringTok{"p.value"}\NormalTok{, }\StringTok{"t.score"}\NormalTok{, }\StringTok{"r.t"}\NormalTok{),}
           \AttributeTok{ion\_mode =} \StringTok{"negative"}\NormalTok{,}
           \AttributeTok{ppm =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{p\_cutoff =} \FloatTok{0.05}\NormalTok{,}
           \AttributeTok{db\_pathway =} \StringTok{"hsa\_mfn"}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(extra\_entity))\{}
\NormalTok{      df\_mz\_rt }\OtherTok{\textless{}{-}}\NormalTok{ extra\_entity}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      df\_mz\_rt }\OtherTok{\textless{}{-}}\NormalTok{ mz\_rt }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(id }\SpecialCharTok{\%in\%}\NormalTok{ export}\SpecialCharTok{$}\NormalTok{id) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{merge}\NormalTok{(export[, }\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, p\_col)], }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{"id"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# note that this step is setting up to auto find and rename}
    \FunctionTok{colnames}\NormalTok{(df\_mz\_rt) }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(df\_mz\_rt) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# find and sort as order of \textasciigrave{}key\textasciigrave{}}
      \FunctionTok{.meta\_find\_and\_sort}\NormalTok{(., key) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# rename columns of df\_mz\_rt}
      \FunctionTok{mapply\_rename\_col}\NormalTok{(., as\_col, }\FunctionTok{colnames}\NormalTok{(df\_mz\_rt))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# then, select and relocate (sort) the columns of df}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df\_mz\_rt, }\FunctionTok{all\_of}\NormalTok{(as\_col)) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# convert rt from min to secounds}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{r.t =}\NormalTok{ r.t }\SpecialCharTok{*} \DecValTok{60}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# save to file}
    \FunctionTok{write\_tsv}\NormalTok{(df, }\AttributeTok{file =} \StringTok{"tmp.txt"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get the submit file}
    \ControlFlowTok{if}\NormalTok{(only\_return }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{id =}\NormalTok{ df\_mz\_rt, }\AttributeTok{submit =}\NormalTok{ df))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# submit to MetaboAnalyst}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{print}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df))}
    \DocumentationTok{\#\# submit to MetaboAnalyst}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{InitDataObjects}\NormalTok{(}\StringTok{"mass\_all"}\NormalTok{, }\StringTok{"mummichog"}\NormalTok{, }\ConstantTok{FALSE}\NormalTok{)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{SetPeakFormat}\NormalTok{(mSet, }\StringTok{"mprt"}\NormalTok{)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{UpdateInstrumentParameters}\NormalTok{(mSet, ppm, ion\_mode, }\StringTok{"yes"}\NormalTok{, }\FloatTok{0.02}\NormalTok{);}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{Read.PeakListData}\NormalTok{(mSet, }\StringTok{"tmp.txt"}\NormalTok{);}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{SetRTincluded}\NormalTok{(mSet, }\StringTok{"seconds"}\NormalTok{)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{SanityCheckMummichogData}\NormalTok{(mSet)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{SetPeakEnrichMethod}\NormalTok{(mSet, }\StringTok{"mum"}\NormalTok{, }\StringTok{"v2"}\NormalTok{)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{SetMummichogPval}\NormalTok{(mSet, p\_cutoff)}
\NormalTok{    mSet }\OtherTok{\textless{}{-}} \FunctionTok{PerformPSEA}\NormalTok{(mSet, db\_pathway, }\StringTok{"current"}\NormalTok{, }\DecValTok{3}\NormalTok{ , }\DecValTok{100}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(mSet)}
\NormalTok{  \}}
\NormalTok{.meta\_find\_and\_sort }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           name\_set,}
\NormalTok{           pattern\_set}
\NormalTok{           )\{}
\NormalTok{    name\_set }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(pattern\_set, .meta\_mutate\_grep\_get,}
                       \AttributeTok{string\_set =}\NormalTok{ name\_set) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(name\_set)}
\NormalTok{  \}}
\NormalTok{.meta\_mutate\_grep\_get }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           pattern,}
\NormalTok{           string\_set}
\NormalTok{           )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}}\NormalTok{ string\_set }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\FunctionTok{grepl}\NormalTok{(pattern, .)]}
    \FunctionTok{return}\NormalTok{(string)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_oplsda.r}{%
\section{File: meta\_oplsda.R}\label{file-meta_oplsda.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_oplsda }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           metadata,}
\NormalTok{           GROUP}
\NormalTok{           )\{}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(group }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(GROUP)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(sample, group)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# collate data}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{filter\_via\_rownames}\NormalTok{(df, metadata}\SpecialCharTok{$}\NormalTok{sample) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{sample =} \FunctionTok{rownames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# in order to sort sample with group}
      \FunctionTok{merge}\NormalTok{(metadata, }\AttributeTok{by =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# select the col of var}
\NormalTok{    gr }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"sample|group"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(df))}
    \DocumentationTok{\#\# scale the data}
\NormalTok{    matrix }\OtherTok{\textless{}{-}} \FunctionTok{meta\_scale}\NormalTok{(df[, }\SpecialCharTok{!}\NormalTok{gr])}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# opls{-}da}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# calculate OPLS{-}DA...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    oplsda }\OtherTok{\textless{}{-}}\NormalTok{ ropls}\SpecialCharTok{::}\FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ matrix, }\AttributeTok{y =} \FunctionTok{unlist}\NormalTok{(df[, }\StringTok{"group"}\NormalTok{]),}
                          \AttributeTok{predI =} \DecValTok{1}\NormalTok{, }\AttributeTok{orthoI =} \ConstantTok{NA}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather opls{-}da results}
    \DocumentationTok{\#\# T score}
\NormalTok{    tscore }\OtherTok{\textless{}{-}}\NormalTok{ oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{1}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}
    \DocumentationTok{\#\# O score}
\NormalTok{    oscore }\OtherTok{\textless{}{-}}\NormalTok{ oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{2}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# collate as df}
\NormalTok{    part1 }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\AttributeTok{h1 =}\NormalTok{ oplsda}\SpecialCharTok{@}\NormalTok{scoreMN[, }\DecValTok{1}\NormalTok{], }\AttributeTok{o1 =}\NormalTok{ oplsda}\SpecialCharTok{@}\NormalTok{orthoScoreMN[, }\DecValTok{1}\NormalTok{]) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{bind\_cols}\NormalTok{(df[, gr]) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{x\_lab =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"T score[1] ("}\NormalTok{, tscore, }\StringTok{"\%)"}\NormalTok{),}
                    \AttributeTok{y\_lab =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Orthogonal T score[1] ("}\NormalTok{, oscore, }\StringTok{"\%)"}\NormalTok{))}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather VIP value}
\NormalTok{    part2 }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{vipVn) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# get id}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{id =} \FunctionTok{rownames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# rename}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vip =}\NormalTok{ oplsda.vipVn) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{oplsda\_coord =}\NormalTok{ part1, }\AttributeTok{vip =}\NormalTok{ part2)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_re_collate_iupac_via_inchi.r}{%
\section{File: meta\_re\_collate\_iupac\_via\_inchi.R}\label{file-meta_re_collate_iupac_via_inchi.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{meta\_re\_collate\_iupac\_via\_inchi }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           simp\_candi,}
\NormalTok{           name\_df,}
\NormalTok{           export}
\NormalTok{           )\{}
\NormalTok{    export }\OtherTok{\textless{}{-}}\NormalTok{ simp\_candi }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(name\_df, }\AttributeTok{by =} \StringTok{"sp.id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =} \FunctionTok{ifelse}\NormalTok{(name }\SpecialCharTok{==} \StringTok{"null"}\NormalTok{, IUPACName, name)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name, classification, tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{id =}\NormalTok{ .id, }\AttributeTok{info =}\NormalTok{ classification) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(export, }\AttributeTok{by =} \StringTok{"id"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(name) }\SpecialCharTok{==}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(tanimotoSimilarity)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(export)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-meta_summarise_via_group.r}{%
\section{File: meta\_summarise\_via\_group.R}\label{file-meta_summarise_via_group.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# |V1         |V2         |}
\CommentTok{\# |:{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}|:{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}|}
\CommentTok{\# |control    |model      |}
\CommentTok{\# |model      |pro\_high   |}
\CommentTok{\# |model      |pro\_low    |}
\CommentTok{\# |model      |pro\_medium |}
\CommentTok{\# |model      |raw\_high   |}
\CommentTok{\# |model      |raw\_low    |}
\CommentTok{\# |model      |raw\_medium |}
\CommentTok{\# |pro\_high   |raw\_high   |}
\CommentTok{\# |pro\_low    |raw\_low    |}
\CommentTok{\# |pro\_medium |raw\_medium |}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\DocumentationTok{\#\# load into a metadata}
\NormalTok{meta\_summarise\_via\_group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           compare}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(compare, }\DecValTok{1}\NormalTok{, base\_meta\_summarise\_via\_group,}
                  \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{simplify =}\NormalTok{ F)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\CommentTok{\# $fc}
\CommentTok{\# [1] "test"}

\CommentTok{\# $p\_value}
\CommentTok{\# [1] "test"}

\CommentTok{\# $q\_value}
\CommentTok{\# [1] "test"}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{base\_meta\_summarise\_via\_group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           group,}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    GROUP }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_meta\_sort}\NormalTok{(group)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# computaton of"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(GROUP, }\AttributeTok{collapse =} \StringTok{"/"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, group }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(GROUP))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    x\_row }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(GROUP[}\DecValTok{1}\NormalTok{], df}\SpecialCharTok{$}\NormalTok{group)}
    \DocumentationTok{\#\# x versus y}
\NormalTok{    y\_row }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(GROUP[}\DecValTok{2}\NormalTok{], df}\SpecialCharTok{$}\NormalTok{group)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} log2(FC)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    fc\_set }\OtherTok{\textless{}{-}} \FunctionTok{meta\_calculate\_couple}\NormalTok{(df, x\_row, y\_row, group,}
                                    \StringTok{"base\_meta\_calculate\_fc"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{log2.fc =}\NormalTok{ expr)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} t.test}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    p\_set }\OtherTok{\textless{}{-}} \FunctionTok{meta\_calculate\_couple}\NormalTok{(df, x\_row, y\_row, group,}
                                    \StringTok{"base\_meta\_calculate\_p"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} FDR}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    q\_set }\OtherTok{\textless{}{-}}\NormalTok{ p\_set }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(expr) }\SpecialCharTok{==}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{q\_value =}\NormalTok{ fdrtool}\SpecialCharTok{::}\FunctionTok{fdrtool}\NormalTok{(expr, }\AttributeTok{statistic =} \StringTok{\textquotesingle{}pvalue\textquotesingle{}}\NormalTok{, }\AttributeTok{plot =}\NormalTok{ F)}\SpecialCharTok{$}\NormalTok{qval) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{p\_value =}\NormalTok{ expr)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather all data}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ q\_set }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(id, p\_value, q\_value) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(fc\_set, }\AttributeTok{by =} \StringTok{"id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{meta\_calculate\_couple }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           x\_row,}
\NormalTok{           y\_row,}
\NormalTok{           group,}
\NormalTok{           fun}
\NormalTok{           )\{}
\NormalTok{    fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(fun)}
\NormalTok{    gr }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"sample|group"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(df))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{gr]}
    \DocumentationTok{\#\# use in multiple function}
\NormalTok{    data\_set }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(df, }\DecValTok{2}\NormalTok{, fun, x\_row, y\_row)}
    \DocumentationTok{\#\# reformat and then return}
\NormalTok{    data\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{id =} \FunctionTok{names}\NormalTok{(data\_set), }\AttributeTok{expr =} \FunctionTok{unname}\NormalTok{(data\_set),}
                                       \AttributeTok{facet\_col =} \FunctionTok{meta\_get\_facet\_col}\NormalTok{(group),}
                                       \AttributeTok{facet\_row =} \FunctionTok{meta\_get\_facet\_row}\NormalTok{(group))}
    \FunctionTok{return}\NormalTok{(data\_set)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{base\_meta\_calculate\_fc }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           x\_row,}
\NormalTok{           y\_row}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}}\NormalTok{ vector }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    fc }\OtherTok{\textless{}{-}} \FunctionTok{log2}\NormalTok{(}\FunctionTok{mean}\NormalTok{(vector[x\_row]) }\SpecialCharTok{/} \FunctionTok{mean}\NormalTok{(vector[y\_row]))}
    \FunctionTok{return}\NormalTok{(fc)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{base\_meta\_calculate\_p }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           x\_row,}
\NormalTok{           y\_row}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}}\NormalTok{ vector }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    x }\OtherTok{\textless{}{-}}\NormalTok{ vector[x\_row]}
\NormalTok{    y }\OtherTok{\textless{}{-}}\NormalTok{ vector[y\_row]}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(stat }\OtherTok{\textless{}{-}} \FunctionTok{t.test}\NormalTok{(x, y, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check) }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ stat}\SpecialCharTok{$}\NormalTok{p.value}
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# trans df format}
\NormalTok{meta\_array\_to\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           compute\_df,}
\NormalTok{           metadata}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ compute\_df }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{check.names =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{sample =} \FunctionTok{rownames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(metadata[, }\FunctionTok{c}\NormalTok{(}\StringTok{"sample"}\NormalTok{, }\StringTok{"group"}\NormalTok{), }\AttributeTok{with =}\NormalTok{ F], }\AttributeTok{by =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(sample, group, }\FunctionTok{colnames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate\_meta\_sort }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
           \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"pro"}\NormalTok{, }\StringTok{"raw"}\NormalTok{, }\StringTok{"model"}\NormalTok{, }\StringTok{"control"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{origin =}\NormalTok{ vector)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mutate =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\_.*$"}\NormalTok{, }\StringTok{""}\NormalTok{, origin),}
                        \AttributeTok{mutate =} \FunctionTok{factor}\NormalTok{(mutate, }\AttributeTok{levels =}\NormalTok{ levels))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(df, mutate)}
    \FunctionTok{return}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{origin)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-metabo_get_id_via_mz_rt.r}{%
\section{File: metabo\_get\_id\_via\_mz\_rt.R}\label{file-metabo_get_id_via_mz_rt.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{metabo\_get\_id\_via\_mz\_rt }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metabo\_results,}
\NormalTok{           mutate\_mz\_rt}
\NormalTok{           )\{}
\NormalTok{    metabos }\OtherTok{\textless{}{-}}\NormalTok{ metabo\_results }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{rename, }\AttributeTok{mz =}\NormalTok{ Query.Mass, }\AttributeTok{rt =}\NormalTok{ Retention.Time) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(merge, mutate\_mz\_rt, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{, }\StringTok{"rt"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
             \AttributeTok{info =} \FunctionTok{paste0}\NormalTok{(pathway,  }\StringTok{" {-}{-}{-}{-} Gamma: "}\NormalTok{, Gamma, }\StringTok{" {-}{-}{-}{-} Hits.sig: "}\NormalTok{, Hits.sig)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{select, id, name, mz, info) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{as\_tibble)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mgf_add_anno.gnps.r}{%
\section{File: mgf\_add\_anno.gnps.R}\label{file-mgf_add_anno.gnps.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mgf\_add\_anno.gnps }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    slice\_line }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"1:3"}\NormalTok{, }\StringTok{"4:6"}\NormalTok{, }\StringTok{"7:nrow(df)"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(slice\_line, }\ControlFlowTok{function}\NormalTok{(lines)\{}
\NormalTok{                   list }\OtherTok{\textless{}{-}} \FunctionTok{slice}\NormalTok{(df, }\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ lines)))}
                   \FunctionTok{return}\NormalTok{(list)}
\NormalTok{           \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# scans}
\NormalTok{    scans }\OtherTok{\textless{}{-}} \FunctionTok{str\_extract}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{], }\StringTok{"[0{-}9]\{1,\}$"}\NormalTok{)}
\NormalTok{    scans }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"SCANS="}\NormalTok{, scans))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# merge}
\NormalTok{    merge }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \StringTok{"MERGED\_STATS=1 / 1 (0 removed due to low quality, 0 removed due to low cosine)"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], scans, list[[}\DecValTok{2}\NormalTok{]], merge, list[[}\DecValTok{3}\NormalTok{]])}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mgf\_add\_anno.mistree }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    mass\_level }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{V1[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"MSLEVEL"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)]}
\NormalTok{    id\_line }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{V1[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"FEATURE\_ID"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# process level 1}
    \ControlFlowTok{if}\NormalTok{(mass\_level }\SpecialCharTok{==} \StringTok{"MSLEVEL=1"}\NormalTok{)\{}
\NormalTok{      slice\_line }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"1:4"}\NormalTok{, }\StringTok{"5"}\NormalTok{, }\StringTok{"6:nrow(df)"}\NormalTok{)}
\NormalTok{      list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(slice\_line, }\ControlFlowTok{function}\NormalTok{(lines)\{}
\NormalTok{                       list }\OtherTok{\textless{}{-}} \FunctionTok{slice}\NormalTok{(df, }\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ lines)))}
                       \FunctionTok{return}\NormalTok{(list)}
\NormalTok{           \})}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# rt}
\NormalTok{      rt }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \StringTok{"RTINSECONDS=1000"}\NormalTok{)}
      \DocumentationTok{\#\# spectype}
\NormalTok{      sp }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \StringTok{"SPECTYPE=CORRELATED MS"}\NormalTok{)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# filename}
\NormalTok{      filename }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \StringTok{"FILENAME=sample.mzML"}\NormalTok{)}
      \DocumentationTok{\#\# scans}
\NormalTok{      scans }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"SCANS="}\NormalTok{, }\FunctionTok{str\_extract}\NormalTok{(id\_line, }\StringTok{"[0{-}9]\{1,\}$"}\NormalTok{)))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# bind rows}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], rt, sp, list[[}\DecValTok{2}\NormalTok{]], filename, scans, list[[}\DecValTok{3}\NormalTok{]])}
      \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# process level 2}
\NormalTok{      slice\_line }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"1:6"}\NormalTok{, }\StringTok{"7:nrow(df)"}\NormalTok{)}
\NormalTok{      list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(slice\_line, }\ControlFlowTok{function}\NormalTok{(lines)\{}
\NormalTok{                       list }\OtherTok{\textless{}{-}} \FunctionTok{slice}\NormalTok{(df, }\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ lines)))}
                       \FunctionTok{return}\NormalTok{(list)}
\NormalTok{           \})}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{      filename }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \StringTok{"FILENAME=sample.mzML"}\NormalTok{)}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], filename, list[[}\DecValTok{2}\NormalTok{]])}
      \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-msp_to_mgf.r}{%
\section{File: msp\_to\_mgf.R}\label{file-msp_to_mgf.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{msp\_to\_mgf }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           name,}
\NormalTok{           id\_prefix,}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/Downloads/msp/MoNA/"}\NormalTok{,}
           \AttributeTok{write\_meta\_data =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".meta.tsv"}\NormalTok{),}
           \AttributeTok{fun =} \StringTok{"mutate\_deal\_with\_msp\_record"}\NormalTok{,}
           \AttributeTok{pre\_modify =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(pre\_modify }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"sed {-}i \textquotesingle{}s/}\SpecialCharTok{\textbackslash{}r}\StringTok{//g\textquotesingle{} "}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, name))}
\NormalTok{    \}}
\NormalTok{    msp }\OtherTok{\textless{}{-}} \FunctionTok{read\_msp}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name))}
\NormalTok{    cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{    store }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{    mgf }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".mgf"}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{file =}\NormalTok{ mgf)}
\NormalTok{    ms\_fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(fun)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(msp[[}\DecValTok{1}\NormalTok{]], ms\_fun, }
                      \AttributeTok{id\_prefix =}\NormalTok{ id\_prefix,}
                      \AttributeTok{cache =}\NormalTok{ cache,}
                      \AttributeTok{store =}\NormalTok{ store,}
\NormalTok{                      ...)}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(set, get\_envir\_df,}
                        \AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(meta\_data, }\AttributeTok{fill =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(write\_meta\_data) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{write\_tsv}\NormalTok{(meta\_data, write\_meta\_data)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(meta\_data)}
\NormalTok{  \}}
\NormalTok{read\_msp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           filepath}
\NormalTok{           )\{}
\NormalTok{    msp }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(filepath, }\AttributeTok{sep =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F)}
\NormalTok{  \}}
\NormalTok{get\_envir\_df }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           var,}
\NormalTok{           envir}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(var, }\AttributeTok{envir =}\NormalTok{ envir)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-multi_formula_adduct_align.r}{%
\section{File: multi\_formula\_adduct\_align.R}\label{file-multi_formula_adduct_align.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{multi\_formula\_adduct\_align }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           db,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, mz\_df\_align, }\AttributeTok{db =}\NormalTok{ db, ...)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{mz\_df\_align }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           db,}
           \AttributeTok{col =} \StringTok{"mass"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(df[[col]], mz\_align, }\AttributeTok{df =}\NormalTok{ db, ...)}
\NormalTok{    adduct }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(df, col)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(mutate\_bind\_cols, adduct, list, }\AttributeTok{SIMPLIFY =}\NormalTok{ F)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{fill =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate\_bind\_cols }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           row,}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_cols}\NormalTok{(row[}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df)),], df)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mutate_head.r}{%
\section{File: mutate\_head.R}\label{file-mutate_head.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate\_head }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{row =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{col =} \DecValTok{10}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{row, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{col]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mutate_horizon_bar_accuracy.r}{%
\section{File: mutate\_horizon\_bar\_accuracy.R}\label{file-mutate_horizon_bar_accuracy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate\_horizon\_bar\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{extra\_palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{),}
           \AttributeTok{ylab =} \StringTok{"stat ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{extra\_sides\_df =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{return\_p =}\NormalTok{ T,}
           \AttributeTok{width =} \DecValTok{16}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{15}\NormalTok{,}
           \AttributeTok{l\_ratio =} \DecValTok{63}\NormalTok{,}
           \AttributeTok{m\_ratio =} \DecValTok{138}\NormalTok{,}
           \AttributeTok{extra\_col\_max =} \DecValTok{500}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get parent class}
\NormalTok{    parent\_class }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_get\_parent\_class}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{classification) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(., end\_of\_vector) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{parent\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(parent\_class), classification, parent\_class))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    annotation }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{combine =} \FunctionTok{paste0}\NormalTok{(classification, }\StringTok{" {-}{-}{-}{-} "}\NormalTok{, parent\_class))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(df, }\AttributeTok{id.vars =} \FunctionTok{c}\NormalTok{(}\StringTok{"classification"}\NormalTok{, }\StringTok{"parent\_class"}\NormalTok{),}
                         \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                         \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df,}
                        \AttributeTok{classification =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                        \AttributeTok{parent\_class =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                        \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
                        \AttributeTok{type =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                    \AttributeTok{y =}\NormalTok{ value,}
                    \AttributeTok{fill =}\NormalTok{ type)) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{,}
               \AttributeTok{position =} \StringTok{"stack"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(extra\_sides\_df) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      max }\OtherTok{=}\NormalTok{ extra\_col\_max}
\NormalTok{      ps }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ extra\_sides\_df) }\SpecialCharTok{+}
        \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{,}
                 \AttributeTok{fill =} \StringTok{"\#709AE1FF"}\NormalTok{,}
                 \AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(sum }\SpecialCharTok{\textgreater{}=}\NormalTok{ max, max, sum))) }\SpecialCharTok{+}
        \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, max) }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"Compounds number"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{      pa1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(annotation) }\SpecialCharTok{+}
        \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{y =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                      \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)),}
                  \AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{colorRampPalette}\NormalTok{(extra\_palette)(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(annotation}\SpecialCharTok{$}\NormalTok{parent\_class)))) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
              \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{legend.position =} \StringTok{"left"}\NormalTok{,}
              \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{())}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{svg}\NormalTok{(savename, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
      \FunctionTok{grid.newpage}\NormalTok{()}
      \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{200}\NormalTok{) ))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# classification}
      \FunctionTok{print}\NormalTok{( pa1, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{5}\SpecialCharTok{:}\DecValTok{94}\NormalTok{, }\AttributeTok{layout.pos.col =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{l\_ratio))}
      \DocumentationTok{\#\# cluster accuracy}
      \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{2}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\AttributeTok{layout.pos.col =}\NormalTok{ (l\_ratio }\SpecialCharTok{+} \DecValTok{2}\NormalTok{)}\SpecialCharTok{:}\NormalTok{m\_ratio))}
      \DocumentationTok{\#\# compounds number}
      \FunctionTok{print}\NormalTok{( ps, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{5}\SpecialCharTok{:}\DecValTok{96}\NormalTok{, }\AttributeTok{layout.pos.col =}\NormalTok{ (m\_ratio }\SpecialCharTok{+} \DecValTok{4}\NormalTok{)}\SpecialCharTok{:}\DecValTok{195}\NormalTok{))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{dev.off}\NormalTok{()}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(return\_p)}
      \FunctionTok{return}\NormalTok{(p)}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =} \DecValTok{9}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{end\_of\_vector }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    var }\OtherTok{\textless{}{-}}\NormalTok{ vector[}\FunctionTok{length}\NormalTok{(vector)]}
    \FunctionTok{return}\NormalTok{(var)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mutate2_horizon_bar_accuracy.r}{%
\section{File: mutate2\_horizon\_bar\_accuracy.R}\label{file-mutate2_horizon_bar_accuracy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate2\_horizon\_bar\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df\_list,}
\NormalTok{           extra\_list,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{ylab =} \StringTok{"stat ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"Type"}\NormalTok{,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{mutate\_palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"true"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{3}\NormalTok{],}
                              \StringTok{"latent"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{2}\NormalTok{],}
                              \StringTok{"false"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{1}\NormalTok{],}
                              \StringTok{"noise"} \OtherTok{=} \StringTok{"\#FED439FF"}\NormalTok{,}
                              \StringTok{"high\_noise"} \OtherTok{=} \StringTok{"\#8A4198FF"}\NormalTok{),}
           \AttributeTok{extra\_palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"sum"} \OtherTok{=} \StringTok{"\#95CC5EFF"}\NormalTok{,}
                             \StringTok{"noise"} \OtherTok{=} \StringTok{"\#FED439FF"}\NormalTok{,}
                             \StringTok{"high\_noise"} \OtherTok{=} \StringTok{"\#8A4198FF"}\NormalTok{),}
           \AttributeTok{group\_palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{),}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{width =} \DecValTok{18}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{15}\NormalTok{,}
           \AttributeTok{l\_ratio =} \DecValTok{57}\NormalTok{,}
           \AttributeTok{m\_ratio =} \DecValTok{130}\NormalTok{,}
           \AttributeTok{y\_cut\_left =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{500}\NormalTok{),}
           \AttributeTok{y\_cut\_right =} \FunctionTok{c}\NormalTok{(}\DecValTok{900}\NormalTok{, }\DecValTok{1300}\NormalTok{),}
           \AttributeTok{y\_cut\_left\_breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{500}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{)),}
           \AttributeTok{y\_cut\_right\_breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\DecValTok{1200}\NormalTok{)}
           \CommentTok{\# extra\_col\_max = NA}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get parent class}
\NormalTok{    df\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(df\_list, }\ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{                        parent\_class }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_get\_parent\_class}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{classification) }\SpecialCharTok{\%\textgreater{}\%}
                          \FunctionTok{lapply}\NormalTok{(., end\_of\_vector) }\SpecialCharTok{\%\textgreater{}\%}
                          \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{                        df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{parent\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(parent\_class),}
\NormalTok{                                                                      classification,}
\NormalTok{                                                                      parent\_class),}
                                            \AttributeTok{st.true =} \DecValTok{0}\NormalTok{, }\AttributeTok{en.true =}\NormalTok{ true,}
                                            \AttributeTok{st.latent =}\NormalTok{ en.true, }\AttributeTok{en.latent =}\NormalTok{ st.latent }\SpecialCharTok{+}\NormalTok{ latent,}
                                            \AttributeTok{st.false =}\NormalTok{ en.latent, }\AttributeTok{en.false =}\NormalTok{ st.false }\SpecialCharTok{+}\NormalTok{ false)}
\NormalTok{           \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# group draw}
\NormalTok{    annotation }\OtherTok{\textless{}{-}}\NormalTok{ df\_list[[}\StringTok{"origin"}\NormalTok{]]}
\NormalTok{    pa1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(annotation) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{y =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
                    \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)),}
                \AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{, }\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{colorRampPalette}\NormalTok{(group\_palette)(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(annotation}\SpecialCharTok{$}\NormalTok{parent\_class)))) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{14}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.position =} \StringTok{"left"}\NormalTok{,}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{())}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# initial stat}
\NormalTok{    mutate\_origin }\OtherTok{\textless{}{-}}\NormalTok{ df\_list[[}\StringTok{"origin"}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(., }\AttributeTok{id.vars =} \FunctionTok{colnames}\NormalTok{(.)[}\SpecialCharTok{!}\FunctionTok{colnames}\NormalTok{(.) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"true"}\NormalTok{, }\StringTok{"false"}\NormalTok{, }\StringTok{"latent"}\NormalTok{)],}
                     \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                     \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(., }\AttributeTok{y =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v)\{}
\NormalTok{                                            v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"st."}\NormalTok{, v[[}\StringTok{"type"}\NormalTok{]])]]}
\NormalTok{                                                                      \})),}
                  \AttributeTok{yend =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v)\{}
\NormalTok{                                 v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"type"}\NormalTok{]])]]}
\NormalTok{                                            \})))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# noise dirft}
\NormalTok{    noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mutate2.horizon.tmp\_merge}\NormalTok{(}\StringTok{"origin"}\NormalTok{, }\StringTok{"noise"}\NormalTok{, df\_list) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(y }\SpecialCharTok{!=}\NormalTok{ yend, exclude }\SpecialCharTok{==}\NormalTok{ F,}
\NormalTok{                    classification }\SpecialCharTok{\%in\%}\NormalTok{ mutate\_origin}\SpecialCharTok{$}\NormalTok{classification)}
    \DocumentationTok{\#\# high noise drift}
\NormalTok{    h\_noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mutate2.horizon.tmp\_merge}\NormalTok{(}\StringTok{"noise"}\NormalTok{, }\StringTok{"h\_noise"}\NormalTok{, df\_list) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(y }\SpecialCharTok{!=}\NormalTok{ yend, exclude }\SpecialCharTok{==}\NormalTok{ F,}
\NormalTok{                    classification }\SpecialCharTok{\%in\%}\NormalTok{ mutate\_origin}\SpecialCharTok{$}\NormalTok{classification)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
      \DocumentationTok{\#\# origin}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ mutate\_origin,}
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification,}
                       \AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend,}
                       \AttributeTok{color =}\NormalTok{ type),}
                   \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ noise\_df,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification,}
                     \AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend,}
                     \AttributeTok{color =} \StringTok{"noise"}\NormalTok{),}
                   \AttributeTok{size =} \DecValTok{7}\NormalTok{, }
                   \AttributeTok{inherit.aes =}\NormalTok{ F) }\SpecialCharTok{+}
      \DocumentationTok{\#\# high noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ h\_noise\_df,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification,}
                     \AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend,}
                     \AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
                   \AttributeTok{size =} \DecValTok{7}\NormalTok{,}
                   \AttributeTok{inherit.aes =}\NormalTok{ F) }\SpecialCharTok{+}
      \DocumentationTok{\#\# the point indicate the start of noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ noise\_df,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification,}
                     \AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(yend }\SpecialCharTok{\textgreater{}}\NormalTok{ y, y }\SpecialCharTok{{-}} \FloatTok{0.001}\NormalTok{, y }\SpecialCharTok{+} \FloatTok{0.001}\NormalTok{), }\AttributeTok{yend =}\NormalTok{ y,}
                     \AttributeTok{color =} \StringTok{"noise"}\NormalTok{),}
                   \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\DecValTok{10}\NormalTok{, }\StringTok{"pt"}\NormalTok{)),}
                   \AttributeTok{size =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{lineend =} \StringTok{"round"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# the point indicate the start of high noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ h\_noise\_df,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{xend =}\NormalTok{ classification,}
                     \AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(yend }\SpecialCharTok{\textgreater{}}\NormalTok{ y, y }\SpecialCharTok{{-}} \FloatTok{0.001}\NormalTok{, y }\SpecialCharTok{+} \FloatTok{0.001}\NormalTok{), }\AttributeTok{yend =}\NormalTok{ y,}
                     \AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
                   \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\DecValTok{10}\NormalTok{, }\StringTok{"pt"}\NormalTok{)),}
                   \AttributeTok{size =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{lineend =} \StringTok{"round"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ mutate\_palette,}
                         \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\AttributeTok{sum =} \StringTok{"sum"}\NormalTok{, }\AttributeTok{noise =} \StringTok{"middle noise"}\NormalTok{, }\AttributeTok{high\_noise =} \StringTok{"high noise"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{color =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    extra.noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mutate2.extra.horizon.tmp\_merge}\NormalTok{(}\AttributeTok{extra\_list =}\NormalTok{ extra\_list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    ps }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
        \DocumentationTok{\#\# origin sum}
        \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ extra\_list[[}\StringTok{"origin"}\NormalTok{]],}
                     \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                         \AttributeTok{xend =}\NormalTok{ classification,}
                         \AttributeTok{y =} \DecValTok{0}\NormalTok{,}
                         \AttributeTok{yend =}\NormalTok{ sum,}
                         \AttributeTok{color =} \StringTok{"sum"}\NormalTok{),}
                     \AttributeTok{size =} \DecValTok{7}
\NormalTok{                     ) }\SpecialCharTok{+}
        \DocumentationTok{\#\# noise drift}
        \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(extra.noise\_df,}
                                          \AttributeTok{sum.x =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.x), }\DecValTok{0}\NormalTok{, sum.x)),}
                     \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                         \AttributeTok{xend =}\NormalTok{ classification,}
                         \AttributeTok{y =}\NormalTok{ sum,}
                         \AttributeTok{yend =}\NormalTok{ sum.x,}
                         \AttributeTok{color =} \StringTok{"noise"}\NormalTok{),}
                     \AttributeTok{size =} \DecValTok{7}
\NormalTok{                     ) }\SpecialCharTok{+}
        \DocumentationTok{\#\# high\_noise drift}
        \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(extra.noise\_df, }\FunctionTok{is.na}\NormalTok{(sum.x) }\SpecialCharTok{==}\NormalTok{ F),}
                                          \AttributeTok{sum.x =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.y), }\DecValTok{0}\NormalTok{, sum.x),}
                                          \AttributeTok{sum.y =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.y), sum.x, sum.y)),}
                     \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                         \AttributeTok{xend =}\NormalTok{ classification,}
                         \AttributeTok{y =}\NormalTok{ sum.x,}
                         \AttributeTok{yend =}\NormalTok{ sum.y,}
                         \AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
                     \AttributeTok{size =} \DecValTok{7}
\NormalTok{                     ) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ extra\_palette,}
                           \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\AttributeTok{sum =} \StringTok{"sum"}\NormalTok{, }\AttributeTok{noise =} \StringTok{"middle noise"}\NormalTok{, }\AttributeTok{high\_noise =} \StringTok{"high noise"}\NormalTok{)) }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{color =} \StringTok{"Type"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# do coord. axis cut off}
\NormalTok{    ps1 }\OtherTok{\textless{}{-}}\NormalTok{ ps }\SpecialCharTok{+} 
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =}\NormalTok{ y\_cut\_left) }\SpecialCharTok{+}
      \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{), }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.7}\NormalTok{,}
                 \AttributeTok{color =} \StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ y\_cut\_left\_breaks)}
\NormalTok{    ps2 }\OtherTok{\textless{}{-}}\NormalTok{ ps }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =}\NormalTok{ y\_cut\_right) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ y\_cut\_right\_breaks)}
\NormalTok{    ps }\OtherTok{\textless{}{-}}\NormalTok{ ggpubr}\SpecialCharTok{::}\FunctionTok{ggarrange}\NormalTok{(ps1, ps2, }\AttributeTok{ncol =} \DecValTok{2}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{,}
                            \AttributeTok{widths =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{),}
                            \AttributeTok{common.legend =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{legend =} \StringTok{"right"}\NormalTok{, }\AttributeTok{align =} \StringTok{"h"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{svg}\NormalTok{(savename, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{grid.newpage}\NormalTok{()}
    \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{1000}\NormalTok{, }\DecValTok{200}\NormalTok{) ))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# classification}
    \DocumentationTok{\#\# while 2 line of bottom legend, set to 923}
\NormalTok{    adjust }\OtherTok{\textless{}{-}} \DecValTok{940}
    \FunctionTok{print}\NormalTok{( pa1, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{30}\SpecialCharTok{:}\NormalTok{adjust, }\AttributeTok{layout.pos.col =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{l\_ratio))}
    \DocumentationTok{\#\# cluster accuracy}
    \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{3}\SpecialCharTok{:}\DecValTok{1000}\NormalTok{, }\AttributeTok{layout.pos.col =}\NormalTok{ (l\_ratio }\SpecialCharTok{+} \DecValTok{2}\NormalTok{)}\SpecialCharTok{:}\NormalTok{m\_ratio))}
    \DocumentationTok{\#\# compounds number}
    \FunctionTok{print}\NormalTok{( ps, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =} \DecValTok{30}\SpecialCharTok{:}\NormalTok{adjust, }\AttributeTok{layout.pos.col =}\NormalTok{ (m\_ratio }\SpecialCharTok{+} \DecValTok{4}\NormalTok{)}\SpecialCharTok{:}\DecValTok{195}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{dev.off}\NormalTok{()}
    \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{  \}}
\DocumentationTok{\#\# difine a function}
\NormalTok{mutate2.extra.horizon.tmp\_merge }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{v1 =} \StringTok{"noise"}\NormalTok{,}
           \AttributeTok{v2 =} \StringTok{"h\_noise"}\NormalTok{,}
\NormalTok{           extra\_list}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(extra\_list[[v1]], extra\_list[[v2]],}
                              \AttributeTok{by =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{merge}\NormalTok{(extra\_list[[}\StringTok{"origin"}\NormalTok{]], }\AttributeTok{by =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate2.horizon.tmp\_merge }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           v1,}
\NormalTok{           v2,}
\NormalTok{           df\_list}
\NormalTok{           )\{}
\NormalTok{  df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df\_list[[v1]], df\_list[[v2]],}
                    \AttributeTok{by =} \StringTok{"classification"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{flow1 =} \StringTok{"true"}\NormalTok{, }\AttributeTok{flow2 =} \StringTok{"latent"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# both true and false is changing, so duplicated the col}
\NormalTok{  reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(., }\AttributeTok{id.vars =} \FunctionTok{colnames}\NormalTok{(.)[}\SpecialCharTok{!}\FunctionTok{colnames}\NormalTok{(.) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"flow1"}\NormalTok{, }\StringTok{"flow2"}\NormalTok{)],}
                 \AttributeTok{variable.name =} \StringTok{"type"}\NormalTok{,}
                 \AttributeTok{value.name =} \StringTok{"value"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# calculate segment from y to yend}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(., }\AttributeTok{y =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v)\{}
\NormalTok{                                          v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"value"}\NormalTok{]], }\StringTok{".x"}\NormalTok{)]]}
\NormalTok{                                            \})),}
                \AttributeTok{yend =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(., }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v)\{}
\NormalTok{                                          v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"value"}\NormalTok{]], }\StringTok{".y"}\NormalTok{)]]}
\NormalTok{                                            \})),}
                \AttributeTok{exclude =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), T, F),}
                \AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), }\DecValTok{0}\NormalTok{, y),}
                \AttributeTok{yend =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), }\DecValTok{1}\NormalTok{, yend))}
  \FunctionTok{return}\NormalTok{(df)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pathway_horizon.r}{%
\section{File: pathway\_horizon.R}\label{file-pathway_horizon.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pathway\_horizon }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           title,}
           \AttributeTok{ylab =} \StringTok{"{-}log10(Gamma p)"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"pathway"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{""}\NormalTok{,}
           \AttributeTok{save =} \StringTok{"tmp.svg"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{Gamma =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(Gamma),}
                        \AttributeTok{pathway =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(pathway, }\AttributeTok{width =} \DecValTok{30}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(Gamma)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{position =} \StringTok{"identity"}\NormalTok{,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \FunctionTok{reorder}\NormalTok{(pathway, Gamma),}
                     \AttributeTok{y =}\NormalTok{ Gamma,}
                     \AttributeTok{size =}\NormalTok{ Hits.sig,}
                     \AttributeTok{color =}\NormalTok{ Hits.sig)) }\SpecialCharTok{+}
      \CommentTok{\# geom\_segment(aes(x = pathway, xend = pathway, y = 0, yend = Gamma)) +}
      \FunctionTok{scale\_color\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"white"}\NormalTok{, }\AttributeTok{mid =} \StringTok{"\#FED439FF"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#BB0021FF"}\NormalTok{) }\SpecialCharTok{+}
      \CommentTok{\# geom\_hline(yintercept = {-}log10(0.05), linetype = 3) +}
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{size =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}
            \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\FloatTok{1.5}\NormalTok{), }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
            \CommentTok{\# axis.text = element\_text(size = 6),}
            \CommentTok{\# plot.title = element\_text(hjust = 0.3)}
\NormalTok{      )}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ save, }\AttributeTok{width =} \DecValTok{7}\NormalTok{, }\AttributeTok{height =} \DecValTok{8}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pca_via_group.r}{%
\section{File: pca\_via\_group.R}\label{file-pca_via_group.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pca\_via\_group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           compare,}
\NormalTok{           extra\_compare,}
\NormalTok{           db\_get\_sample,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(compare))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# compute dominant compare group}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      part1 }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(compare, }\AttributeTok{MARGIN =} \DecValTok{1}\NormalTok{, base\_pca\_via\_group,}
                                \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{meta =}\NormalTok{ db\_get\_sample,}
\NormalTok{                                ...)}
\NormalTok{      part1 }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(part1)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.list}\NormalTok{(extra\_compare))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# compute extra compare group}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      part2 }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(extra\_compare, internal\_base\_pca\_via\_group,}
                                 \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{meta =}\NormalTok{ db\_get\_sample,}
\NormalTok{                                 ...)}
\NormalTok{      part2 }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(part2)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(part1, part2) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{internal\_base\_pca\_via\_group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           extra\_compare\_part,}
\NormalTok{           df,}
\NormalTok{           meta,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(extra\_compare\_part))\{}
\NormalTok{      part }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(extra\_compare\_part, }\AttributeTok{MARGIN =} \DecValTok{1}\NormalTok{, base\_pca\_via\_group,}
                               \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{meta =}\NormalTok{ meta, ...)}
\NormalTok{      part }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(part)}
      \FunctionTok{return}\NormalTok{(part)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.list}\NormalTok{(extra\_compare\_part))\{}
\NormalTok{      part }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(extra\_compare\_part, base\_pca\_via\_group,}
                                \AttributeTok{df =}\NormalTok{ df, }\AttributeTok{meta =}\NormalTok{ meta, ...)}
\NormalTok{      part }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(part)}
      \FunctionTok{return}\NormalTok{(part)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{base\_pca\_via\_group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           group,}
\NormalTok{           df,}
\NormalTok{           meta,}
           \AttributeTok{dose =} \FunctionTok{c}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\StringTok{"medium"}\NormalTok{, }\StringTok{"low"}\NormalTok{),}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# according to group name to get sample file name}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(group)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ meta[}\FunctionTok{names}\NormalTok{(meta) }\SpecialCharTok{\%in\%}\NormalTok{ group]}
\NormalTok{    sample }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# facet col (different dispose)}
\NormalTok{    facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{meta\_get\_facet\_col}\NormalTok{(group, ...)}
    \DocumentationTok{\#\# facet row (different dosage)}
\NormalTok{    facet\_row }\OtherTok{\textless{}{-}} \FunctionTok{meta\_get\_facet\_row}\NormalTok{(group, dose)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{filter\_via\_rownames}\NormalTok{(df, sample)}
    \DocumentationTok{\#\# scale the data}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{meta\_scale}\NormalTok{(df)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    pca }\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(df, }\AttributeTok{scale. =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# PC annotation}
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(pca)}
    \DocumentationTok{\#\# following, return a vector project}
    \CommentTok{\#     PC1    PC2    PC3}
    \CommentTok{\#  0.2595 0.2190 0.1774}
\NormalTok{    summary }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\FunctionTok{round}\NormalTok{(summary}\SpecialCharTok{$}\NormalTok{importance[}\DecValTok{2}\NormalTok{,],}\DecValTok{4}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    pca\_coord }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{x) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(PC1, PC2, PC3) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{sample =} \FunctionTok{rownames}\NormalTok{(df),}
                    \DocumentationTok{\#\# facet annotation}
                    \AttributeTok{facet\_col =}\NormalTok{ facet\_col, }\AttributeTok{facet\_row =}\NormalTok{ facet\_row,}
                    \DocumentationTok{\#\# annotation of PC importance}
                    \AttributeTok{im\_PC1 =}\NormalTok{ summary[[}\StringTok{"PC1"}\NormalTok{]], }\AttributeTok{im\_PC2 =}\NormalTok{ summary[[}\StringTok{"PC2"}\NormalTok{]],}
                    \DocumentationTok{\#\# importance lengend in figure}
                    \AttributeTok{legend\_PC1 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC1 ("}\NormalTok{, im\_PC1 }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{),}
                    \DocumentationTok{\#\# the same as PC1}
                    \AttributeTok{legend\_PC2 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC2 ("}\NormalTok{, im\_PC2 }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{),}
                    \DocumentationTok{\#\# calculate the PC importance annotation coord in figure}
                    \DocumentationTok{\#\# x coord}
                    \AttributeTok{anno\_x =} \FunctionTok{min}\NormalTok{(PC1) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{20} \SpecialCharTok{/} \DecValTok{20}\NormalTok{),}
                    \DocumentationTok{\#\# y coord}
                    \AttributeTok{anno\_y =} \FunctionTok{max}\NormalTok{(PC2) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{22} \SpecialCharTok{/} \DecValTok{20}\NormalTok{),}
                    \DocumentationTok{\#\# pc3 is not considered ruster into figure}
                    \AttributeTok{im\_PC3 =}\NormalTok{ summary[[}\StringTok{"PC3"}\NormalTok{]])}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{return}\NormalTok{(pca\_coord)}
\NormalTok{  \}}
\NormalTok{meta\_sort }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
           \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"pro"}\NormalTok{, }\StringTok{"raw"}\NormalTok{, }\StringTok{"model"}\NormalTok{, }\StringTok{"control"}\NormalTok{),}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\_.*$"}\NormalTok{, }\StringTok{""}\NormalTok{, vector) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{vector\_delete\_var}\NormalTok{(}\StringTok{"control"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{      vector }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\NormalTok{, }\StringTok{"model"}\NormalTok{)}
\NormalTok{    levels }\OtherTok{=} \FunctionTok{c}\NormalTok{(levels, vector) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{sort}\NormalTok{(}\FunctionTok{factor}\NormalTok{(vector, }\AttributeTok{levels =}\NormalTok{ levels))}
    \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{  \}}
\NormalTok{meta\_scale }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{scale}\NormalTok{(df, }\AttributeTok{center =}\NormalTok{ T, }\AttributeTok{scale =}\NormalTok{ T)}
\NormalTok{    exclude }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{,] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{is.nan}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{exclude]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{multi\_extract }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           pattern\_set}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(pattern\_set, base\_muti\_extract,}
                     \AttributeTok{vector =}\NormalTok{ vector)}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(vector)}
    \FunctionTok{return}\NormalTok{(vector)}
\NormalTok{  \}}
\NormalTok{base\_muti\_extract }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           pattern,}
\NormalTok{           vector}
\NormalTok{           )\{}
\NormalTok{    character }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(vector, pattern)}
    \FunctionTok{return}\NormalTok{(character)}
\NormalTok{  \}}
\NormalTok{meta\_get\_facet\_col }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           group,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{meta\_sort}\NormalTok{(group, ...) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{paste}\NormalTok{(}\AttributeTok{collapse =} \StringTok{"\_"}\NormalTok{)}
    \DocumentationTok{\#\# if multiple group}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(group) }\SpecialCharTok{\textgreater{}=} \DecValTok{3}\NormalTok{)\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\NormalTok{, }\StringTok{"model"}\NormalTok{) }\SpecialCharTok{\%in\%}\NormalTok{ group}
      \ControlFlowTok{if}\NormalTok{(F }\SpecialCharTok{\%in\%}\NormalTok{ check }\SpecialCharTok{==}\NormalTok{ F)}
\NormalTok{        facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"multiple\_"}\NormalTok{, facet\_col)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(facet\_col)}
\NormalTok{  \}}
\NormalTok{meta\_get\_facet\_row }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           group,}
           \AttributeTok{dose =} \FunctionTok{c}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\StringTok{"medium"}\NormalTok{, }\StringTok{"low"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    facet\_row }\OtherTok{\textless{}{-}} \FunctionTok{multi\_extract}\NormalTok{(group, dose) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{sort}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unique}\NormalTok{()}
    \DocumentationTok{\#\# if multiple dose}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(facet\_row) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      facet\_row }\OtherTok{\textless{}{-}} \StringTok{"multiple"}
\NormalTok{    \}}
    \DocumentationTok{\#\# only control and model}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(facet\_row) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{      facet\_row }\OtherTok{\textless{}{-}} \StringTok{"extra"}
    \FunctionTok{return}\NormalTok{(facet\_row)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-plot.facet_compare.r}{%
\section{File: plot.facet\_compare.R}\label{file-plot.facet_compare.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plot.facet\_compare }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list1,}
\NormalTok{           list2,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{           title,}
\NormalTok{           savename,}
           \AttributeTok{ylim\_min =} \DecValTok{50}\NormalTok{,}
           \AttributeTok{group\_levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"origin"}\NormalTok{, }\StringTok{"noise"}\NormalTok{, }\StringTok{"high noise"}\NormalTok{), }
           \AttributeTok{from =} \FunctionTok{c}\NormalTok{(}\StringTok{"MCnebula"}\NormalTok{, }\StringTok{"MolnetEnhancer"}\NormalTok{),}
           \AttributeTok{by\_col =} \StringTok{"classification"}\NormalTok{,}
           \AttributeTok{ylab =} \StringTok{"In cluster numbers"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"Classification"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"Type"}\NormalTok{,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{width =} \DecValTok{18}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{12}
\NormalTok{           )\{}
    \DocumentationTok{\#\# select in common classification}
\NormalTok{    common.class }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(list1[[}\DecValTok{1}\NormalTok{]], list2[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{by =}\NormalTok{ by\_col) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\DecValTok{1}\NormalTok{)}
    \DocumentationTok{\#\# filter classification}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(list1, list2) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(list)\{}
\NormalTok{               list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, merge, }\AttributeTok{y =}\NormalTok{ common.class, }\AttributeTok{by =}\NormalTok{ by\_col, }\AttributeTok{all.y =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
                 \DocumentationTok{\#\# reset col name as sum}
                 \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{rename, }\AttributeTok{sum =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
                 \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{mutate, }\AttributeTok{sum =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum), }\DecValTok{0}\NormalTok{, sum))}
\NormalTok{           \}) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(data.table}\SpecialCharTok{::}\NormalTok{rbindlist, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{rename, }\AttributeTok{group =}\NormalTok{ .id) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{               dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{group =} \FunctionTok{mapply\_rename\_col}\NormalTok{(}\StringTok{"h\_noise"}\NormalTok{, }\StringTok{"high noise"}\NormalTok{, group))}
\NormalTok{           \}) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{mapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(df, VALUE)\{}
\NormalTok{               dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{from =}\NormalTok{ VALUE)}
\NormalTok{           \}, ., from, }\AttributeTok{SIMPLIFY =}\NormalTok{ F)}
    \DocumentationTok{\#\# for segment}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], list[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"group"}\NormalTok{, by\_col))}
    \DocumentationTok{\#\# for point}
\NormalTok{    df2 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], list[[}\DecValTok{2}\NormalTok{]])}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# plot figure}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df,}
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification,}
                       \AttributeTok{xend =}\NormalTok{ classification,}
                       \AttributeTok{y =}\NormalTok{ sum.x,}
                       \AttributeTok{yend =}\NormalTok{ sum.y),}
                   \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df2,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ classification, }\AttributeTok{y =}\NormalTok{ sum, }\AttributeTok{color =}\NormalTok{ from),}
                 \AttributeTok{size =} \DecValTok{5}\NormalTok{,}
                 \AttributeTok{position =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(ylim\_min, }\DecValTok{300}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1200}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{title =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title),}
           \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
           \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
           \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(ylim\_min, }\FunctionTok{max}\NormalTok{(df2}\SpecialCharTok{$}\NormalTok{sum) }\SpecialCharTok{*} \FloatTok{1.1}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(group, }\AttributeTok{levels =}\NormalTok{ group\_levels)) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{10}\NormalTok{),}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-png_add_margin.r}{%
\section{File: png\_add\_margin.R}\label{file-png_add_margin.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{png\_gather\_two }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           png\_file1,}
           \AttributeTok{png\_file2 =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{5000}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{3500}\NormalTok{,}
           \AttributeTok{internal =} \FloatTok{0.06}
\NormalTok{           )\{}
    \DocumentationTok{\#\# read png1}
\NormalTok{    png1 }\OtherTok{\textless{}{-}}\NormalTok{ png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(png\_file1)}
\NormalTok{    ratio}\FloatTok{.1} \OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png1) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(png1)}
    \DocumentationTok{\#\# read png2}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(png\_file2))\{}
\NormalTok{      png2 }\OtherTok{\textless{}{-}}\NormalTok{ png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(png\_file2)}
\NormalTok{      ratio}\FloatTok{.2} \OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png2) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(png2)}
      \DocumentationTok{\#\# filename fix}
\NormalTok{      fix }\OtherTok{\textless{}{-}} \StringTok{"gather\_"}
      \DocumentationTok{\#\# png postion shift}
\NormalTok{      position\_shift }\OtherTok{\textless{}{-}} \StringTok{"0"}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ratio}\FloatTok{.2} \OtherTok{\textless{}{-}} \ConstantTok{NULL}
      \DocumentationTok{\#\# filename fix}
\NormalTok{      fix }\OtherTok{\textless{}{-}} \StringTok{"ps\_"}
      \DocumentationTok{\#\# png postion shift}
\NormalTok{      position\_shift }\OtherTok{\textless{}{-}} \StringTok{"(unit.width / 2 + internal / 2) / width.adjust"}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    max }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(}\FunctionTok{c}\NormalTok{(ratio}\FloatTok{.1}\NormalTok{, ratio}\FloatTok{.2}\NormalTok{))}
    \DocumentationTok{\#\# according to height, calculate needed width}
\NormalTok{    expect.width }\OtherTok{\textless{}{-}}\NormalTok{ height }\SpecialCharTok{*}\NormalTok{ max }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ internal) }\SpecialCharTok{*} \DecValTok{2}
    \DocumentationTok{\#\# if width not enough}
    \ControlFlowTok{if}\NormalTok{(width }\SpecialCharTok{\textless{}}\NormalTok{ expect.width)\{}
\NormalTok{      width }\OtherTok{\textless{}{-}}\NormalTok{ expect.width}
\NormalTok{      width.adjust }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      width.adjust }\OtherTok{\textless{}{-}}\NormalTok{ expect.width }\SpecialCharTok{/}\NormalTok{ width}
\NormalTok{    \}}
    \DocumentationTok{\#\# save path and savename}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(png\_file1)}
\NormalTok{    name }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(png\_file1)}
    \FunctionTok{png}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, fix, name), }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{plot.new}\NormalTok{()}
    \DocumentationTok{\#\# x, y, xend, yend}
\NormalTok{    unit.width }\OtherTok{\textless{}{-}}\NormalTok{ (}\FloatTok{0.5} \SpecialCharTok{{-}}\NormalTok{ internal }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ width.adjust}
    \FunctionTok{rasterImage}\NormalTok{(png1,}
                \AttributeTok{xleft =}\NormalTok{ unit.width }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ratio}\FloatTok{.1} \SpecialCharTok{/}\NormalTok{ max) }\SpecialCharTok{+}
                  \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ position\_shift)),}
                \AttributeTok{ybottom =} \DecValTok{0}\NormalTok{,}
                \AttributeTok{xright =}\NormalTok{ unit.width }\SpecialCharTok{+} 
                  \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ position\_shift)),}
                \AttributeTok{ytop =} \DecValTok{1}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(png\_file2))\{}
      \DocumentationTok{\#\# x, y, xend, yend}
      \FunctionTok{rasterImage}\NormalTok{(png2,}
                  \AttributeTok{xleft =}\NormalTok{ unit.width }\SpecialCharTok{+}\NormalTok{ internal,}
                  \AttributeTok{ybottom =} \DecValTok{0}\NormalTok{,}
                  \AttributeTok{xright =}\NormalTok{ unit.width }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ratio}\FloatTok{.2} \SpecialCharTok{/}\NormalTok{ max) }\SpecialCharTok{+}\NormalTok{ internal, }
                  \AttributeTok{ytop =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{get\_path }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           path\_str}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(path\_str, }\StringTok{".*(?=/)"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(path)}
\NormalTok{  \}}
\NormalTok{get\_filename }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           path\_str}
\NormalTok{           )\{}
\NormalTok{    filename }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(path\_str, }\StringTok{"(?\textless{}=/)[\^{}/]*$"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(filename)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{png\_to\_pdf }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file}
\NormalTok{           )\{}
\NormalTok{    file.pdf }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.png"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf"}\NormalTok{, file)}
    \FunctionTok{pdf}\NormalTok{(}\AttributeTok{file =}\NormalTok{ file.pdf)}
\NormalTok{    png }\OtherTok{\textless{}{-}}\NormalTok{ EBImage}\SpecialCharTok{::}\FunctionTok{readImage}\NormalTok{(file)}
\NormalTok{    EBImage}\SpecialCharTok{::}\FunctionTok{display}\NormalTok{(png, }\AttributeTok{method =} \StringTok{"raster"}\NormalTok{, }\AttributeTok{all =}\NormalTok{ T)}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-png_auto_zoom.r}{%
\section{File: png\_auto\_zoom.R}\label{file-png_auto_zoom.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{png\_auto\_zoom }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{zoom.center.x =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{zoom.center.y =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{global.h =} \DecValTok{5000}\NormalTok{,}
           \AttributeTok{zoom.width =} \FloatTok{1.5}\NormalTok{,}
           \AttributeTok{internal.width =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{zoom.window =} \FloatTok{0.2}
\NormalTok{           )\{}
    \DocumentationTok{\#\# readpng}
\NormalTok{    png }\OtherTok{\textless{}{-}}\NormalTok{ EBImage}\SpecialCharTok{::}\FunctionTok{readImage}\NormalTok{(file)}
    \DocumentationTok{\#\# size ratio}
\NormalTok{    ratio.png }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(png)}
    \DocumentationTok{\#\# dev ratio}
\NormalTok{    ratio.dev }\OtherTok{\textless{}{-}}\NormalTok{ zoom.width }\SpecialCharTok{+}\NormalTok{ ratio.png }\SpecialCharTok{+}\NormalTok{ internal.width}
    \DocumentationTok{\#\# create dev}
    \FunctionTok{png}\NormalTok{(}\AttributeTok{filename =} \FunctionTok{paste0}\NormalTok{(file, }\StringTok{".zoom.png"}\NormalTok{),}
        \AttributeTok{width =}\NormalTok{ global.h }\SpecialCharTok{*}\NormalTok{ ratio.dev,}
        \AttributeTok{height =}\NormalTok{ global.h)}
    \DocumentationTok{\#\# use grid}
    \FunctionTok{grid.newpage}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# origin plot}
    \DocumentationTok{\#\# position and size}
\NormalTok{    ori.x }\OtherTok{\textless{}{-}}\NormalTok{ (internal.width }\SpecialCharTok{+}\NormalTok{ zoom.width) }\SpecialCharTok{/}\NormalTok{ ratio.dev}
\NormalTok{    ori.y }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    ori.tmp.width }\OtherTok{\textless{}{-}}\NormalTok{ ratio.png }\SpecialCharTok{/}\NormalTok{ ratio.dev}
\NormalTok{    ori.tmp.height }\OtherTok{\textless{}{-}} \DecValTok{1}
    \DocumentationTok{\#\# create windows}
\NormalTok{    view.port }\OtherTok{\textless{}{-}} \FunctionTok{fast.view}\NormalTok{(ori.x, ori.y, ori.tmp.width, ori.tmp.height)}
    \DocumentationTok{\#\# push}
    \FunctionTok{grid.raster}\NormalTok{(png, }\AttributeTok{vp =}\NormalTok{ view.port)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# zoom plot}
    \DocumentationTok{\#\# clip the plot}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# row clip }
\NormalTok{    row.start }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(png) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ zoom.center.y }\SpecialCharTok{{-}}\NormalTok{ zoom.window }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{    row.end }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(png) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ zoom.center.y }\SpecialCharTok{+}\NormalTok{ zoom.window }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
    \DocumentationTok{\#\# relative width of zoom size}
\NormalTok{    zoom.relative.width }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{/}\NormalTok{ ratio.dev) }\SpecialCharTok{*}\NormalTok{ zoom.window }\SpecialCharTok{*}\NormalTok{ zoom.width}
    \DocumentationTok{\#\# col clip}
\NormalTok{    col.start }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png) }\SpecialCharTok{*}\NormalTok{ (zoom.center.x }\SpecialCharTok{{-}}\NormalTok{ zoom.relative.width }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{    col.end }\OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png) }\SpecialCharTok{*}\NormalTok{ (zoom.center.x }\SpecialCharTok{+}\NormalTok{ zoom.relative.width }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    focus.png }\OtherTok{\textless{}{-}}\NormalTok{ png[row.start}\SpecialCharTok{:}\NormalTok{row.end, col.start}\SpecialCharTok{:}\NormalTok{col.end, ]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# position}
\NormalTok{    focus.x }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    focus.y }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    focus.tmp.width }\OtherTok{\textless{}{-}}\NormalTok{ zoom.width }\SpecialCharTok{/}\NormalTok{ ratio.dev}
\NormalTok{    focus.tmp.height }\OtherTok{\textless{}{-}} \DecValTok{1}
    \DocumentationTok{\#\# viewport}
\NormalTok{    view.port }\OtherTok{\textless{}{-}} \FunctionTok{fast.view}\NormalTok{(focus.x, focus.y, focus.tmp.width, focus.tmp.height)}
    \DocumentationTok{\#\# push focus.png}
    \FunctionTok{grid.raster}\NormalTok{(focus.png, }\AttributeTok{vp =}\NormalTok{ view.port)}
    \DocumentationTok{\#\# zoom rect}
    \FunctionTok{grid.rect}\NormalTok{(}\AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lwd =} \DecValTok{100}\NormalTok{, }\AttributeTok{col =} \StringTok{"black"}\NormalTok{),}
              \AttributeTok{vp =}\NormalTok{ view.port)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{fast.view }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x, y, tmp.width, tmp.height,}
           \AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{  view.port }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{x =} \FunctionTok{unit}\NormalTok{(x, }\StringTok{"npc"}\NormalTok{),}
                        \AttributeTok{y =} \FunctionTok{unit}\NormalTok{(y, }\StringTok{"npc"}\NormalTok{),}
                        \AttributeTok{width =} \FunctionTok{unit}\NormalTok{(tmp.width, }\StringTok{"npc"}\NormalTok{),}
                        \AttributeTok{height =} \FunctionTok{unit}\NormalTok{(tmp.height, }\StringTok{"npc"}\NormalTok{),}
                        \AttributeTok{just =}\NormalTok{ just)}
  \FunctionTok{return}\NormalTok{(view.port)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-prapare_inst_data.r}{%
\section{File: prapare\_inst\_data.R}\label{file-prapare_inst_data.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prapare\_inst\_data }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{raw\_path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{to\_path =} \StringTok{"\textasciitilde{}/MCnebula/inst/extdata"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(tanimotoSimilarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, rank, score, tanimotoSimilarity, file\_name) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pubmed_query.r}{%
\section{File: pubmed\_query.R}\label{file-pubmed_query.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pubmed\_query }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key,}
           \AttributeTok{mindate =} \DecValTok{2000}\NormalTok{,}
           \AttributeTok{maxdate =}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{year}\NormalTok{(}\FunctionTok{Sys.Date}\NormalTok{()),}
           \AttributeTok{retmax =} \DecValTok{1000}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] step1: RISmed::EUtilsSummary}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    res }\OtherTok{\textless{}{-}}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{EUtilsSummary}\NormalTok{(}\AttributeTok{query =}\NormalTok{ key,}
                                 \AttributeTok{mindate =}\NormalTok{ mindate, }\AttributeTok{maxdate =}\NormalTok{ maxdate, }\AttributeTok{retmax =}\NormalTok{ retmax,}
                                 \AttributeTok{type =} \StringTok{"esearch"}\NormalTok{, }\AttributeTok{db =} \StringTok{"pubmed"}\NormalTok{, }\AttributeTok{datetype =} \StringTok{"ppdt"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] step2: RISmed::EUtilsGet}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    res.get }\OtherTok{\textless{}{-}}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{EUtilsGet}\NormalTok{(res)}
    \FunctionTok{return}\NormalTok{(res.get)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{pubmed\_query.meta }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           res.get,}
           \AttributeTok{affi =}\NormalTok{ F,}
           \AttributeTok{author =}\NormalTok{ F,}
           \AttributeTok{mesh =}\NormalTok{ F,}
           \AttributeTok{citation =}\NormalTok{ F,}
           \AttributeTok{metadata =}\NormalTok{ T,}
           \AttributeTok{IF.data =} \ConstantTok{NULL}
\NormalTok{           )\{}
    \DocumentationTok{\#\# cite times}
    \ControlFlowTok{if}\NormalTok{(citation)\{}
\NormalTok{      cites }\OtherTok{=}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{Citations}\NormalTok{(res.get) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{base\_pubmed\_query.meta}\NormalTok{(}\StringTok{"ref"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(cites)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(affi)\{}
      \DocumentationTok{\#\# Affiliation, a vector}
\NormalTok{      extra.affi }\OtherTok{\textless{}{-}}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{Affiliation}\NormalTok{(res.get) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{base\_pubmed\_query.meta}\NormalTok{(}\StringTok{"affiliation"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(extra.affi)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(author)\{}
      \DocumentationTok{\#\# authors}
\NormalTok{      extra.author }\OtherTok{\textless{}{-}}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{Author}\NormalTok{(res.get) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{base\_pubmed\_query.meta}\NormalTok{(}\StringTok{"name"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(extra.author)}
\NormalTok{    \}}
    \DocumentationTok{\#\# meshs, a df }
    \ControlFlowTok{if}\NormalTok{(mesh)\{}
\NormalTok{      extra.mesh }\OtherTok{\textless{}{-}}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{Mesh}\NormalTok{(res.get) }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(df)\{}
                 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(df))}
                   \FunctionTok{return}\NormalTok{(df)}
\NormalTok{           \}) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{id =}\NormalTok{ .id)}
      \FunctionTok{return}\NormalTok{(extra.mesh)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{titles =}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{ArticleTitle}\NormalTok{(res.get),}
                                       \DocumentationTok{\#\# journal name}
                                       \AttributeTok{journal =}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{ISOAbbreviation}\NormalTok{(res.get),}
                                       \DocumentationTok{\#\# institutions}
                                       \AttributeTok{year\_pubmed =}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{YearPubmed}\NormalTok{(res.get),}
                                       \AttributeTok{id =}\NormalTok{ RISmed}\SpecialCharTok{::}\FunctionTok{ArticleId}\NormalTok{(res.get))}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(IF.data))\{}
\NormalTok{      IF.data }\OtherTok{\textless{}{-}}\NormalTok{ readxl}\SpecialCharTok{::}\FunctionTok{read\_xlsx}\NormalTok{(IF.data, }\AttributeTok{skip =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{Full Journal Title}\StringTok{\textasciigrave{}}\NormalTok{, }\StringTok{\textasciigrave{}}\AttributeTok{Impact Factor}\StringTok{\textasciigrave{}}\NormalTok{)}
\NormalTok{      metadata }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, IF.data, }\AttributeTok{by.x =} \StringTok{"journal"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"Full Journal Title"}\NormalTok{,}
                        \AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    \}}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(metadata)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{return}\NormalTok{(metadata)}
\NormalTok{  \}}
\NormalTok{base\_pubmed\_query.meta }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
           \AttributeTok{index =} \StringTok{"name"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ list }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(unlist, }\AttributeTok{use.names =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(vec)\{}
\NormalTok{               data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =}\NormalTok{ vec)}
\NormalTok{           \}) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{id =}\NormalTok{ .id) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# set colnames}
    \FunctionTok{colnames}\NormalTok{(df)[}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ index}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-read_tsv.r}{%
\section{File: read\_tsv.R}\label{file-read_tsv.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_tsv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path, ...)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input=}\NormalTok{path, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{quote=}\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F, ...)}
  \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}
\NormalTok{write\_tsv }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, filename)\{}
    \FunctionTok{write.table}\NormalTok{(x, }\AttributeTok{file =}\NormalTok{ filename, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-roman_convert.r}{%
\section{File: roman\_convert.R}\label{file-roman_convert.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roman\_convert }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{from =} \StringTok{"Nimbus Roman"}\NormalTok{,}
           \AttributeTok{to =} \StringTok{"Times New Roman"}
\NormalTok{           )\{}
\NormalTok{    txt }\OtherTok{\textless{}{-}} \FunctionTok{read\_txt}\NormalTok{(file)}
\NormalTok{    txt }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(txt, }\AttributeTok{V1 =} \FunctionTok{gsub}\NormalTok{(from, to, V1))}
    \FunctionTok{write.table}\NormalTok{(txt, }\AttributeTok{file =}\NormalTok{ file, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ F, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-select_app.r}{%
\section{File: select\_app.R}\label{file-select_app.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{select\_app }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           col}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, }\FunctionTok{all\_of}\NormalTok{(col))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-set_export.no.r}{%
\section{File: set\_export.no.R}\label{file-set_export.no.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{set\_export.no }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{col =} \StringTok{"name"}
\NormalTok{           )\{}
\NormalTok{    tmp }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{unique}\NormalTok{(df[[col]])) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(., }\AttributeTok{No =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(No, name)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, tmp, }\AttributeTok{by.x =}\NormalTok{ col, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{relocate}\NormalTok{(No) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-set_instance_mcnebula.r}{%
\section{File: set\_instance\_MCnebula.R}\label{file-set_instance_mcnebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{set\_instance\_MCnebula }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/MCnebula"}
\NormalTok{           )\{}
\NormalTok{    inst\_structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.structure\_set, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.6}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, file\_name, score, smiles, tanimotoSimilarity, structure\_rank) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(., }\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.), }\DecValTok{700}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    inst\_formula\_set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.formula\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ inst\_structure\_set}\SpecialCharTok{$}\NormalTok{.id)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    inst\_ppcp\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.ppcp\_dataset }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\FunctionTok{names}\NormalTok{(.) }\SpecialCharTok{\%in\%}\NormalTok{ inst\_structure\_set}\SpecialCharTok{$}\NormalTok{.id] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{               df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{V1 =} \FunctionTok{round}\NormalTok{(V1, }\DecValTok{2}\NormalTok{))}
               \FunctionTok{return}\NormalTok{(df)}
\NormalTok{           \})}
\NormalTok{    dir }\OtherTok{\textless{}{-}} \FunctionTok{getwd}\NormalTok{()}
    \FunctionTok{setwd}\NormalTok{(path)}
\NormalTok{    usethis}\SpecialCharTok{::}\FunctionTok{use\_data}\NormalTok{(inst\_formula\_set, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    usethis}\SpecialCharTok{::}\FunctionTok{use\_data}\NormalTok{(inst\_structure\_set, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    usethis}\SpecialCharTok{::}\FunctionTok{use\_data}\NormalTok{(inst\_ppcp\_dataset, }\AttributeTok{overwrite =} \ConstantTok{TRUE}\NormalTok{)}
    \FunctionTok{setwd}\NormalTok{(dir)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Set instance files done}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-show_chem.r}{%
\section{File: show\_chem.R}\label{file-show_chem.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# a function to fast show df}
\NormalTok{show\_meta }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{df =}\NormalTok{ meta}
\NormalTok{           )\{}
\NormalTok{    prefix }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(df[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{"\^{}[a{-}z]\{1,100\}(?=[0{-}9])"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, .id }\SpecialCharTok{==} \FunctionTok{paste0}\NormalTok{(prefix, x)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{getk }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{col =} \StringTok{"INCHIKEY"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{show\_meta}\NormalTok{(x)}
    \FunctionTok{return}\NormalTok{(df[[col]])}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{show\_stru }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{key =} \FunctionTok{c}\NormalTok{(}\StringTok{"smiles"}\NormalTok{, }\StringTok{"SMILES"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    key }\OtherTok{\textless{}{-}}\NormalTok{ key[key }\SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(df)][}\DecValTok{1}\NormalTok{]}
\NormalTok{    smiles }\OtherTok{\textless{}{-}}\NormalTok{ df[[key]]}
    \FunctionTok{molconvert\_structure}\NormalTok{(smiles)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{auto }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           id}
\NormalTok{           )\{}
\NormalTok{    id }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(id))}
    \FunctionTok{show\_meta}\NormalTok{(id) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{show\_stru}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-show_distribution.r}{%
\section{File: show\_distribution.R}\label{file-show_distribution.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{show\_distribution }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{level =} \ConstantTok{NA}
\NormalTok{           )\{}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =} \StringTok{"(.*)[0{-}9]\{1{-}5\}$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(set, read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ set}
\NormalTok{    Level }\OtherTok{=} \StringTok{"Level"}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(level) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, Level }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(level))}
\NormalTok{    \}}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(.id, }\StringTok{"(?\textless{}=/)[a{-}z]\{1,10\}[0{-}9]\{1,5\}$"}\NormalTok{))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-show_palette.r}{%
\section{File: show\_palette.R}\label{file-show_palette.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{show\_palette }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           palette,}
           \AttributeTok{width =} \DecValTok{2}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{font\_size =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{ylab =} \StringTok{"Re{-}ID"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"Color"}\NormalTok{,}
           \AttributeTok{title =} \StringTok{""}\NormalTok{,}
           \AttributeTok{re\_order =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{names}\NormalTok{(palette), }\AttributeTok{color =} \FunctionTok{unname}\NormalTok{(palette)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{re\_order)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{name =} \FunctionTok{factor}\NormalTok{(name, }\AttributeTok{levels =}\NormalTok{ name))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{"color"}\NormalTok{, }\AttributeTok{y =}\NormalTok{ name,}
                    \AttributeTok{fill =}\NormalTok{ name),}
                \AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =}\NormalTok{ xlab, }\AttributeTok{y =}\NormalTok{ ylab) }\SpecialCharTok{+}
      \FunctionTok{ggtitle}\NormalTok{(title) }\SpecialCharTok{+}
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =}\NormalTok{ font\_size, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \SpecialCharTok{{-}}\DecValTok{2}\NormalTok{),}
            \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{())}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \StringTok{"tmp.svg"}\NormalTok{, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{mutate\_show\_palette }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           palette,}
           \AttributeTok{width =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{font\_size =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{ylab =} \StringTok{"Re{-}ID"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"Color"}\NormalTok{,}
           \AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}
           \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
           \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
           \AttributeTok{fill\_lab =} \StringTok{""}\NormalTok{,}
           \AttributeTok{title =} \StringTok{""}\NormalTok{,}
           \AttributeTok{re\_order =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{names}\NormalTok{(palette), }\AttributeTok{color =} \FunctionTok{unname}\NormalTok{(palette)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{re\_order)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{name =} \FunctionTok{factor}\NormalTok{(name, }\AttributeTok{levels =}\NormalTok{ name))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{"color"}\NormalTok{, }\AttributeTok{y =}\NormalTok{ name,}
                    \AttributeTok{fill =}\NormalTok{ name),}
                \AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \DecValTok{1}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =}\NormalTok{ xlab, }\AttributeTok{y =}\NormalTok{ ylab, }\AttributeTok{fill =}\NormalTok{ fill\_lab) }\SpecialCharTok{+}
      \FunctionTok{ggtitle}\NormalTok{(title) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =}\NormalTok{ font\_size, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \SpecialCharTok{{-}}\DecValTok{2}\NormalTok{),}
            \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.position =}\NormalTok{ legend.position,}
            \AttributeTok{legend.key.height =}\NormalTok{ legend.key.height,}
            \AttributeTok{legend.key.width =}\NormalTok{ legend.key.width,}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{())}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ ggpubr}\SpecialCharTok{::}\FunctionTok{get\_legend}\NormalTok{(p)}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ ggpubr}\SpecialCharTok{::}\FunctionTok{as\_ggplot}\NormalTok{(p)}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \StringTok{"tmp.svg"}\NormalTok{, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-simulate_gnps_quant.r}{%
\section{File: simulate\_gnps\_quant.R}\label{file-simulate_gnps_quant.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{simulate\_gnps\_quant }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           meta,}
\NormalTok{           save\_path,}
           \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(save\_path, }\StringTok{"/"}\NormalTok{, }\StringTok{"quant.csv"}\NormalTok{),}
           \AttributeTok{rt =} \DecValTok{1000}\NormalTok{,}
           \AttributeTok{area =} \DecValTok{10000}\NormalTok{,}
           \AttributeTok{id =} \StringTok{".id"}\NormalTok{,}
           \AttributeTok{mz =} \StringTok{"PRECURSORMZ"}\NormalTok{,}
           \AttributeTok{simu\_id =} \StringTok{"row ID"}\NormalTok{,}
           \AttributeTok{simu\_mz =} \StringTok{"row m/z"}\NormalTok{,}
           \AttributeTok{simu\_rt =} \StringTok{"row retention time"}\NormalTok{,}
           \AttributeTok{simu\_quant =} \StringTok{"sample.mzML Peak area"}\NormalTok{,}
           \AttributeTok{return\_df =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(meta, }\FunctionTok{all\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(id, mz)))}
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta, }\AttributeTok{rt =}\NormalTok{ rt, }\AttributeTok{sample =}\NormalTok{ area)}
    \FunctionTok{colnames}\NormalTok{(meta) }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(meta) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{.meta\_find\_and\_sort}\NormalTok{(., }\FunctionTok{c}\NormalTok{(id, mz, }\StringTok{"rt"}\NormalTok{, }\StringTok{"sample"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{mapply\_rename\_col}\NormalTok{(., }\FunctionTok{c}\NormalTok{(simu\_id, simu\_mz, simu\_rt, simu\_quant),}
                        \FunctionTok{colnames}\NormalTok{(meta))}
    \ControlFlowTok{if}\NormalTok{(return\_df)}
      \FunctionTok{return}\NormalTok{(meta)}
    \FunctionTok{write.table}\NormalTok{(meta, }\AttributeTok{file =}\NormalTok{ file, }\AttributeTok{sep =} \StringTok{","}\NormalTok{, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-spectrum_add_noise.r}{%
\section{File: spectrum\_add\_noise.R}\label{file-spectrum_add_noise.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# for .mgf data}
\NormalTok{spectrum\_add\_noise }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
           \AttributeTok{cl =} \DecValTok{8}\NormalTok{,}
           \AttributeTok{filter\_empty =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list,}
      \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{discard\_level1 =}\NormalTok{ F, }\AttributeTok{mass\_process\_level\_1 =}\NormalTok{ F,}
        \AttributeTok{mass\_process\_level\_2 =}\NormalTok{ T, ...)}
\NormalTok{      \{}
\NormalTok{        mass\_level }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{V1[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"MSLEVEL"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)]}
        \DocumentationTok{\#\# process level 1}
        \ControlFlowTok{if}\NormalTok{(mass\_level }\SpecialCharTok{==} \StringTok{"MSLEVEL=1"}\NormalTok{)\{}
          \ControlFlowTok{if}\NormalTok{(discard\_level1)}
            \FunctionTok{return}\NormalTok{()}
          \ControlFlowTok{if}\NormalTok{(mass\_process\_level\_1)}
\NormalTok{            df }\OtherTok{\textless{}{-}} \FunctionTok{mass\_process\_level\_1}\NormalTok{(df, ...)}
          \FunctionTok{return}\NormalTok{(df)}
          \DocumentationTok{\#\# process level 2}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
          \ControlFlowTok{if}\NormalTok{(mass\_process\_level\_2)}
\NormalTok{            df }\OtherTok{\textless{}{-}} \FunctionTok{mass\_process\_level\_2}\NormalTok{(df, ...)}
          \FunctionTok{return}\NormalTok{(df)}
\NormalTok{        \}}
\NormalTok{      \}, }\AttributeTok{cl =}\NormalTok{ cl, ...)}
    \DocumentationTok{\#\# filter the empty spectrum}
    \ControlFlowTok{if}\NormalTok{(filter\_empty)\{}
\NormalTok{      empty }\OtherTok{\textless{}{-}} \SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(list, is.data.frame, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{USE.NAMES =}\NormalTok{ F)}
\NormalTok{      empty }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{names}\NormalTok{(list[empty]))}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\SpecialCharTok{!}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{\%in\%}\NormalTok{ empty]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}

\NormalTok{mass\_process\_level\_1 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, ...)\{\}}
\NormalTok{mass\_process\_level\_2 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    df,}
    \AttributeTok{mass\_shift =}\NormalTok{ T,}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{separate\_peak\_info}\NormalTok{(df, ...)}
    \ControlFlowTok{if}\NormalTok{(mass\_shift }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{return}\NormalTok{(list)}
\NormalTok{    list[[}\DecValTok{2}\NormalTok{]] }\OtherTok{\textless{}{-}} \FunctionTok{mass\_shift}\NormalTok{(list[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{merge =}\NormalTok{ T, ...)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(list) }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{rbindlist}\NormalTok{(list)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{separate\_peak\_info }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    df,}
    \AttributeTok{sep =} \StringTok{" "}\NormalTok{,}
    \AttributeTok{only\_peak\_info =}\NormalTok{ F,}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    peak\_row }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}[0{-}9]"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)}
\NormalTok{    peak\_info }\OtherTok{\textless{}{-}} \FunctionTok{slice}\NormalTok{(df, peak\_row)}
\NormalTok{    peak\_info }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(peak\_info, }\AttributeTok{col =} \StringTok{"V1"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{"mass"}\NormalTok{, }\StringTok{"inte"}\NormalTok{), }\AttributeTok{sep =}\NormalTok{ sep)}
    \ControlFlowTok{if}\NormalTok{(only\_peak\_info }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(peak\_info)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{slice}\NormalTok{(df, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{min}\NormalTok{(peak\_row) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)),}
\NormalTok{      peak\_info,}
      \FunctionTok{slice}\NormalTok{(df, (}\FunctionTok{max}\NormalTok{(peak\_row) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-stat_accuracy.r}{%
\section{File: stat\_accuracy.R}\label{file-stat_accuracy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stat\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \DocumentationTok{\#\# a list contain .id}
\NormalTok{           dominant\_list,}
           \DocumentationTok{\#\# the col are .id, inchikey2D}
\NormalTok{           structure,}
           \DocumentationTok{\#\# the col are .id, standard}
\NormalTok{           meta,}
           \AttributeTok{return\_id\_stat =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(dominant\_list, merge, }\AttributeTok{y =}\NormalTok{ structure,}
                             \AttributeTok{by =} \StringTok{".id"}\NormalTok{,}
                             \AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, merge, }\AttributeTok{y =}\NormalTok{ meta,}
                             \AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
                             \AttributeTok{evaluate =} \FunctionTok{ifelse}\NormalTok{(inchikey2D }\SpecialCharTok{==}\NormalTok{ standard, }\StringTok{"true"}\NormalTok{, }\StringTok{"false"}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(return\_id\_stat }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(id\_stat)}
\NormalTok{    table }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, table\_app) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{classification =}\NormalTok{ .id)}
    \FunctionTok{return}\NormalTok{(table)}
\NormalTok{  \}}
\NormalTok{stat\_topn\_candidates\_accuracy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{path =} \StringTok{"mcnebula\_results/candidates"}\NormalTok{,}
\NormalTok{           meta,}
           \AttributeTok{return\_id\_stat =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(nebula\_name, mutate\_list\_files, }\AttributeTok{path =}\NormalTok{ path) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{()}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(file\_set, read\_tsv) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{select, .id, inchikey2D, structure\_rank) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(merge, meta, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{mutate, }\AttributeTok{evaluate =} \FunctionTok{ifelse}\NormalTok{(inchikey2D }\SpecialCharTok{==}\NormalTok{ standard, }\StringTok{"true"}\NormalTok{, }\StringTok{"false"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{arrange, .id, }\FunctionTok{desc}\NormalTok{(evaluate)) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{distinct, .id, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \FunctionTok{names}\NormalTok{(id\_stat) }\OtherTok{\textless{}{-}}\NormalTok{ nebula\_name}
    \ControlFlowTok{if}\NormalTok{(return\_id\_stat }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(id\_stat)}
\NormalTok{    table }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, table\_app) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{classification =}\NormalTok{ .id)}
    \FunctionTok{return}\NormalTok{(table)}
\NormalTok{  \}}
\NormalTok{mutate\_list\_files }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           pattern,}
\NormalTok{           path}
\NormalTok{           )\{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, pattern, }\AttributeTok{full.names =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(files)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-stat_results_class.r}{%
\section{File: stat\_results\_class.R}\label{file-stat_results_class.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stat\_results\_class }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \DocumentationTok{\#\# only .id is needed}
\NormalTok{           df,}
\NormalTok{           standard,}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{class\_cutoff =} \DecValTok{4}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(df) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    db }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.class\_tree\_data, hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ class\_cutoff)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# for name to get id}
\NormalTok{    db\_id }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{id, c)}
    \FunctionTok{names}\NormalTok{(db\_id) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{name}
    \DocumentationTok{\#\# for id to get parentId}
\NormalTok{    db\_parent }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{parentId, c)}
    \FunctionTok{names}\NormalTok{(db\_parent) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{id}
    \DocumentationTok{\#\# for id to get name}
\NormalTok{    db\_name }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{name, c)}
    \FunctionTok{names}\NormalTok{(db\_name) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{id}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{get\_parent\_class}\NormalTok{(standard,}
\NormalTok{                            db\_id,}
\NormalTok{                            db\_parent,}
\NormalTok{                            db\_name)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"stat:"}\NormalTok{, standard, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    id\_set }\OtherTok{\textless{}{-}}\NormalTok{ df[[}\StringTok{".id"}\NormalTok{]]}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(id\_set, base\_stat\_results\_class,}
                      \AttributeTok{standard =}\NormalTok{ standard,}
                      \AttributeTok{set =}\NormalTok{ set,}
                      \AttributeTok{path =}\NormalTok{ path)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{base\_stat\_results\_class }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           id,}
\NormalTok{           set,}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
\NormalTok{           standard}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(class }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, id)), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      stat }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =} \ConstantTok{NA}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(standard }\SpecialCharTok{\%in\%}\NormalTok{ class[[}\StringTok{"Classification"}\NormalTok{]])\{}
\NormalTok{      stat }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =} \StringTok{"true"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \ControlFlowTok{if}\NormalTok{(class[}\DecValTok{3}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{Classification }\SpecialCharTok{\%in\%}\NormalTok{ set)\{}
        \DocumentationTok{\#\# at least the cluster is T in "class" level}
\NormalTok{        evaluate }\OtherTok{\textless{}{-}} \StringTok{"latent"}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        evaluate }\OtherTok{\textless{}{-}} \StringTok{"false"}
\NormalTok{      \}}
\NormalTok{      stat }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =}\NormalTok{ evaluate)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-struc_match_in_df.r}{%
\section{File: struc\_match\_in\_df.R}\label{file-struc_match_in_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{struc\_match\_in\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           pattern,}
           \AttributeTok{id\_col =} \StringTok{"id"}\NormalTok{,}
           \AttributeTok{smiles\_col =} \StringTok{"SMILES"}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{\#\# match:"}\NormalTok{, pattern, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(df[[smiles\_col]], base\_pattern\_chem,}
                              \AttributeTok{pattern =}\NormalTok{ pattern)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ df[[id\_col]],}
                                 \AttributeTok{evaluate =} \FunctionTok{c}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(list)))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{base\_pattern\_chem }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles,}
\NormalTok{           pattern}
\NormalTok{           )\{}
\NormalTok{    mol }\OtherTok{\textless{}{-}}\NormalTok{ rcdk}\SpecialCharTok{::}\FunctionTok{parse.smiles}\NormalTok{(smiles)}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(match }\OtherTok{\textless{}{-}}\NormalTok{ rcdk}\SpecialCharTok{::}\FunctionTok{matches}\NormalTok{(pattern, mol, }\AttributeTok{return.matches =}\NormalTok{ F), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check) }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{X =} \StringTok{"is.na"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(match)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-table_app.r}{%
\section{File: table\_app.R}\label{file-table_app.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{table\_app }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{col =} \StringTok{"evaluate"}\NormalTok{,}
           \AttributeTok{prop =}\NormalTok{ T}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(df) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    stat }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(df[[col]])}
    \ControlFlowTok{if}\NormalTok{(prop }\SpecialCharTok{==}\NormalTok{ T)}
\NormalTok{      stat }\OtherTok{\textless{}{-}} \FunctionTok{prop.table}\NormalTok{(stat)}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(stat)}
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-test_rerank_method.r}{%
\section{File: test\_rerank\_method.R}\label{file-test_rerank_method.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test\_rerank\_method }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \DocumentationTok{\#\# nebula\_name}
\NormalTok{           name,}
           \DocumentationTok{\#\# involve col of .id, standard}
\NormalTok{           meta,}
           \AttributeTok{top\_n =} \DecValTok{10}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \CommentTok{\# rerank method}
\NormalTok{    test\_structure }\OtherTok{\textless{}{-}} \FunctionTok{nebula\_re\_rank}\NormalTok{(}\AttributeTok{nebula\_name =}\NormalTok{ name, }\AttributeTok{top\_n =}\NormalTok{ top\_n, ...)}
    \DocumentationTok{\#\# gather results with reference data}
\NormalTok{    stat }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(test\_structure[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"inchikey2D"}\NormalTok{)], meta,}
                            \AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{evaluate =} \FunctionTok{ifelse}\NormalTok{(inchikey2D }\SpecialCharTok{==}\NormalTok{ standard, }\StringTok{"true"}\NormalTok{, }\StringTok{"false"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{table\_app}\NormalTok{()}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# nebula\_name:"}\NormalTok{, name, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{print}\NormalTok{(stat)}
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_facet_pca.r}{%
\section{File: visualize\_facet\_pca.R}\label{file-visualize_facet_pca.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{visualize\_facet\_pca }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           palette,}
\NormalTok{           metadata,}
           \AttributeTok{savename =} \StringTok{"pca\_facet.svg"}\NormalTok{,}
           \AttributeTok{anno\_adjust =} \DecValTok{3}\SpecialCharTok{/}\DecValTok{4}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get PC importance df}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(facet\_row }\SpecialCharTok{!=} \StringTok{"extra"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(metadata, }\AttributeTok{by =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    annotation }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(im\_PC1, im\_PC2, legend\_PC1, legend\_PC2,}
\NormalTok{                      anno\_x, anno\_y,}
\NormalTok{                      facet\_col, facet\_row) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{anno\_x =} \FunctionTok{min}\NormalTok{(anno\_x) }\SpecialCharTok{*}\NormalTok{ anno\_adjust,}
                    \AttributeTok{anno\_y =} \FunctionTok{max}\NormalTok{(anno\_y) }\SpecialCharTok{*}\NormalTok{ anno\_adjust)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# drawing part}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ PC1, }\AttributeTok{y =}\NormalTok{ PC2, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{, }\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{shape =} \DecValTok{21}\NormalTok{, }\AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# draw confidence ellipse}
      \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ group), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \DocumentationTok{\#\# exlude repeat legend}
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{color =}  \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# for PC1}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ annotation, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ anno\_x }\SpecialCharTok{*} \FloatTok{1.4}\NormalTok{, }\AttributeTok{y =}\NormalTok{ anno\_y }\SpecialCharTok{*} \FloatTok{1.4}\NormalTok{, }\AttributeTok{label =}\NormalTok{ legend\_PC1),}
                \AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
                \AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{,}
                \AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                \AttributeTok{family =} \StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# for PC2}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ annotation, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ anno\_x }\SpecialCharTok{*} \FloatTok{1.4}\NormalTok{, }\AttributeTok{y =}\NormalTok{ anno\_y }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{) }\SpecialCharTok{*} \FloatTok{1.4}\NormalTok{, }\AttributeTok{label =}\NormalTok{ legend\_PC2),}
                \AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{,}
                \AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{, }\AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                \AttributeTok{family =} \StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =} \StringTok{"PC2"}\NormalTok{, }\AttributeTok{x =} \StringTok{"PC1"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# facet into multiple panel}
      \FunctionTok{facet\_grid}\NormalTok{(Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(facet\_row) }\SpecialCharTok{\textasciitilde{}}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(facet\_col)) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =}\NormalTok{ savename, }\AttributeTok{width =} \DecValTok{11}\NormalTok{, }\AttributeTok{height =} \FloatTok{6.5}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}


\end{document}
