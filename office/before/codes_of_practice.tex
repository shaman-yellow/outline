% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{caption} \captionsetup{font={footnotesize},width=6in} \renewcommand{\dblfloatpagefraction}{.9} \makeatletter \renewenvironment{figure} {\def\@captype{figure}} \makeatletter \definecolor{shadecolor}{RGB}{242,242,242} \usepackage{xeCJK} \usepackage{setspace} \setstretch{1.3}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={R codes of `practice'},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{R codes of `practice'}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{3}
\tableofcontents
}
\hypertarget{file-auto_workflow.r}{%
\section{File: auto\_workflow.R}\label{file-auto_workflow.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(usethis)}
\FunctionTok{library}\NormalTok{(devtools)}
\FunctionTok{library}\NormalTok{(progress)}
\DocumentationTok{\#\# data reformat}
\FunctionTok{library}\NormalTok{(pbapply)}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(plyr)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(MSnbase)}
\FunctionTok{library}\NormalTok{(igraph)}
\DocumentationTok{\#\# visualize}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(grid)}
\DocumentationTok{\#\# suggest}
\FunctionTok{library}\NormalTok{(ChemmineR)}
\FunctionTok{library}\NormalTok{(ChemmineOB)}
\FunctionTok{library}\NormalTok{(rsvg)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(ggimage)}
\DocumentationTok{\#\# extra}
\FunctionTok{library}\NormalTok{(gt)}
\FunctionTok{library}\NormalTok{(classyfireR)}
\FunctionTok{library}\NormalTok{(aplot)}
\FunctionTok{library}\NormalTok{(ggalluvial)}
\DocumentationTok{\#\#}
\FunctionTok{load\_all}\NormalTok{(}\StringTok{"\textasciitilde{}/MCnebula/R"}\NormalTok{)}
\FunctionTok{load\_all}\NormalTok{(}\StringTok{"\textasciitilde{}/extra/R"}\NormalTok{)}
\FunctionTok{initialize\_mcnebula}\NormalTok{(}\StringTok{"."}\NormalTok{)}
\CommentTok{\# collate\_structure(exclude\_element = c("P", "S", "B", "Si"), fc = NA)}
\FunctionTok{collate\_structure}\NormalTok{()}
\FunctionTok{build\_classes\_tree\_list}\NormalTok{()}
\CommentTok{\# collate\_ppcp(min\_possess = 50, max\_possess\_pct = 0.1, filter\_via\_struc\_score = NA)}
\FunctionTok{collate\_ppcp}\NormalTok{()}
\CommentTok{\# generate\_parent\_nebula(min\_tanimoto = 0.5)}
\FunctionTok{generate\_parent\_nebula}\NormalTok{()}
\FunctionTok{generate\_child\_nebulae}\NormalTok{()}
\FunctionTok{visualize\_parent\_nebula}\NormalTok{()}
\FunctionTok{visualize\_child\_nebulae}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-barplot_horizental.r}{%
\section{File: barplot\_horizental.R}\label{file-barplot_horizental.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(Hmisc)}
\NormalTok{ args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}
 \FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}
\NormalTok{ file}\OtherTok{=}\NormalTok{args[}\DecValTok{2}\NormalTok{]}
\NormalTok{ savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file,}\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ df[,}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{capitalize}\NormalTok{(df[,}\DecValTok{1}\NormalTok{])}
\NormalTok{ annonation }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"Annonation"}\NormalTok{),]}
\NormalTok{ df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"Annonation"}\NormalTok{),]}
\NormalTok{ df[,}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(df[,}\DecValTok{2}\NormalTok{])}
 \CommentTok{\#order=df[order(df[,2],decreasing=F),]}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{reorder}\NormalTok{(df[,}\DecValTok{1}\NormalTok{],df[,}\DecValTok{2}\NormalTok{]), }\AttributeTok{y=}\NormalTok{df[,}\DecValTok{2}\NormalTok{], }\AttributeTok{fill=}\NormalTok{df[,}\DecValTok{2}\NormalTok{])) }\SpecialCharTok{+}
   \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FFBB78FF"}\NormalTok{,}\StringTok{"\#FF7F0EFF"}\NormalTok{)) }\SpecialCharTok{+}
   \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Number("}\NormalTok{, annonation[,}\DecValTok{2}\NormalTok{]), }\AttributeTok{x=}\StringTok{"FC group"}\NormalTok{, }\StringTok{")"}\NormalTok{, }\AttributeTok{title=}\StringTok{"Stat features"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{df[,}\DecValTok{1}\NormalTok{], }\AttributeTok{y=}\NormalTok{df[,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\FunctionTok{max}\NormalTok{(df[,}\DecValTok{2}\NormalTok{])}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{30}\NormalTok{), }\AttributeTok{label=}\NormalTok{df[,}\DecValTok{2}\NormalTok{]), }
             \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{))}
 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{15}\NormalTok{, }\AttributeTok{height=}\DecValTok{7}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-blood_chemical.r}{%
\section{File: blood\_chemical.R}\label{file-blood_chemical.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(Hmisc)}
 \FunctionTok{library}\NormalTok{(outliers)}
 \FunctionTok{library}\NormalTok{(ggthemes)}
 \FunctionTok{library}\NormalTok{(stringr)}
\NormalTok{grubbs}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x}\OtherTok{\textless{}{-}}\FunctionTok{round}\NormalTok{(x,}\DecValTok{4}\NormalTok{)}
\NormalTok{  grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
  \ControlFlowTok{while}\NormalTok{(grubbs\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{    grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_outliers,grubbs\_minormax)}
\NormalTok{    grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_p.value,grubbs\_pvalue)}
\NormalTok{    grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_g,grubbs\_g.value)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{    grubbs\_test}\OtherTok{\textless{}{-}}\FunctionTok{grubbs.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{10}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{    grubbs\_p}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_g.value}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{    grubbs\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(grubbs\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{    grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(grubbs\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{  outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{grubbs\_outliers,}\AttributeTok{gvalue=}\NormalTok{grubbs\_g,}\AttributeTok{pvalue=}\NormalTok{grubbs\_p.value)}
  \FunctionTok{return}\NormalTok{(outliner\_res)}
\NormalTok{\}}
\NormalTok{dixon}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(dixon\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{      dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_outliers,dixon\_minormax)}
\NormalTok{      dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_p.value,dixon\_pvalue)}
\NormalTok{      dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_q,dixon\_q.value)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)]}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{      dixon\_test}\OtherTok{\textless{}{-}}\FunctionTok{dixon.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{0}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{      dixon\_p}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_q.value}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{      dixon\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(dixon\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{      dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(dixon\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{    \}}
\NormalTok{    outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{dixon\_outliers,}\AttributeTok{qvalue=}\NormalTok{dixon\_q,}\AttributeTok{pvalue=}\NormalTok{dixon\_p.value)}
    \FunctionTok{return}\NormalTok{(outliner\_res)}
\NormalTok{  \}}
\NormalTok{ args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}
 \FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}
\NormalTok{ file}\OtherTok{=}\NormalTok{args[}\DecValTok{2}\NormalTok{]}
\NormalTok{ savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file,}\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ class}\OtherTok{=}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{index)}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"re\_stat"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{TRUE}\NormalTok{)\{}\FunctionTok{rm}\NormalTok{(re\_stat)\}}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"stat\_exclude"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{TRUE}\NormalTok{)\{}\FunctionTok{rm}\NormalTok{(stat\_exclude)\}}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ class)\{}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i),]}
\NormalTok{ subgroup}\OtherTok{=}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup)}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in}\NormalTok{ subgroup)\{}
\NormalTok{    group}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{k),]}
\NormalTok{    X}\OtherTok{=}\NormalTok{group}\SpecialCharTok{$}\NormalTok{level}
    \CommentTok{\#if(exists("x\_filter")==TRUE)\{rm(x\_filter)\}}
\NormalTok{    out1}\OtherTok{=}\FunctionTok{grubbs}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{2}\NormalTok{))}
\NormalTok{    out2}\OtherTok{=}\FunctionTok{dixon}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{2}\NormalTok{))}
\NormalTok{    out3}\OtherTok{=}\ConstantTok{NULL}
    \ControlFlowTok{for}\NormalTok{(t }\ControlFlowTok{in}\NormalTok{ X)\{}
        \ControlFlowTok{if}\NormalTok{( t}\SpecialCharTok{\textgreater{}}\NormalTok{(}\FunctionTok{mean}\NormalTok{(X)}\SpecialCharTok{+}\DecValTok{2}\SpecialCharTok{*}\FunctionTok{sd}\NormalTok{(X)) }\SpecialCharTok{||}\NormalTok{ t}\SpecialCharTok{\textless{}}\NormalTok{(}\FunctionTok{mean}\NormalTok{(X)}\SpecialCharTok{{-}}\DecValTok{2}\SpecialCharTok{*}\FunctionTok{sd}\NormalTok{(X)))\{out3}\OtherTok{=}\FunctionTok{c}\NormalTok{(out3,t)\}\}}
\NormalTok{    out}\OtherTok{=}\FunctionTok{c}\NormalTok{(out1}\SpecialCharTok{$}\NormalTok{outliers, out2}\SpecialCharTok{$}\NormalTok{outliers, out3)}
    \CommentTok{\#num\_x=length(x\_filter)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out))\{re\_group}\OtherTok{=}\NormalTok{group\}}\ControlFlowTok{else}\NormalTok{\{re\_group}\OtherTok{=}\NormalTok{group[}\FunctionTok{which}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{level}\SpecialCharTok{!=}\NormalTok{out),]\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out))\{exclude}\OtherTok{=}\ConstantTok{NULL}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{exclude}\OtherTok{=}\NormalTok{group[}\FunctionTok{which}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{level}\SpecialCharTok{==}\NormalTok{out),]\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"re\_stat"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{re\_stat}\OtherTok{=}\NormalTok{re\_group\}}\ControlFlowTok{else}\NormalTok{\{re\_stat}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(re\_stat,re\_group)\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"stat\_exclude"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{stat\_exclude}\OtherTok{=}\NormalTok{exclude\}}\ControlFlowTok{else}\NormalTok{\{stat\_exclude}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(stat\_exclude,exclude)\}}
\NormalTok{    \}}
\NormalTok{ \}}
\NormalTok{list}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"raw"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"raw"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"control"}\NormalTok{))}
\NormalTok{t.test}\OtherTok{=}\FunctionTok{array}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"compare1"}\NormalTok{,}\StringTok{"compare2"}\NormalTok{,}\StringTok{"p"}\NormalTok{,}\StringTok{"index"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{(chem }\ControlFlowTok{in}\NormalTok{ class)\{}
    \ControlFlowTok{for}\NormalTok{(row }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(list))\{}
\NormalTok{    double}\OtherTok{=}\NormalTok{list[row,]}
\NormalTok{    escape}\OtherTok{=}\DecValTok{0}
        \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\StringTok{"low"}\NormalTok{,}\StringTok{"medium"}\NormalTok{,}\StringTok{"high"}\NormalTok{))\{}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare2}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{1}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare2}\OtherTok{=}\NormalTok{double[}\DecValTok{1}\NormalTok{]\}}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare1}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{2}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare1}\OtherTok{=}\NormalTok{double[}\DecValTok{2}\NormalTok{]\}}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"model"} \SpecialCharTok{\&}\NormalTok{ double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{)\{compare2}\OtherTok{=}\StringTok{"model"}\NormalTok{; compare1}\OtherTok{=}\StringTok{"control"}\NormalTok{; escape}\OtherTok{=}\DecValTok{1}\NormalTok{\}}
\NormalTok{        X}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare2 }\SpecialCharTok{\&}\NormalTok{ re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{chem),] }\CommentTok{\#x\textasciitilde{}compare2}
\NormalTok{        Y}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare1 }\SpecialCharTok{\&}\NormalTok{ re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{chem),] }\CommentTok{\#y\textasciitilde{}compare1}
\NormalTok{        stat\_p}\OtherTok{=}\FunctionTok{t.test}\NormalTok{(X}\SpecialCharTok{$}\NormalTok{level, Y}\SpecialCharTok{$}\NormalTok{level, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F)}
\NormalTok{        stat\_p}\SpecialCharTok{$}\NormalTok{p.value}\OtherTok{=}\FunctionTok{round}\NormalTok{(stat\_p}\SpecialCharTok{$}\NormalTok{p.value,}\DecValTok{5}\NormalTok{)}
        \CommentTok{\#hx=fivenum(X$level)[4]+(fivenum(X$level)[4]{-}fivenum(X$level)[2])*(1.5)}
        \CommentTok{\#hy=fivenum(Y$level)[4]+(fivenum(Y$level)[4]{-}fivenum(Y$level)[2])*(1.5)}
\NormalTok{        t.test}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(t.test,}\FunctionTok{c}\NormalTok{(compare1, compare2, stat\_p}\SpecialCharTok{$}\NormalTok{p.value, chem),}
                    \FunctionTok{c}\NormalTok{(compare2, compare1, stat\_p}\SpecialCharTok{$}\NormalTok{p.value, chem))}
        \ControlFlowTok{if}\NormalTok{(escape}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}\ControlFlowTok{break}\NormalTok{\}}
\NormalTok{        \}}
\NormalTok{    \}}
\NormalTok{\}}
\NormalTok{stat}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(t.test[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,])}
\FunctionTok{colnames}\NormalTok{(stat)}\OtherTok{=}\NormalTok{t.test[}\DecValTok{1}\NormalTok{,]}
\FunctionTok{write.table}\NormalTok{(stat, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ttest"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(re\_stat, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"filter\_chemical\_index"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }
        \AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(stat\_exclude, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"exclude"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }
        \AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\#\# loop}
\NormalTok{df}\OtherTok{=}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"filter\_chemical\_index.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(df, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"filter\_chemical\_index\_"}\NormalTok{,}\FunctionTok{Sys.Date}\NormalTok{(),}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }
        \AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{class}\OtherTok{=}\FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{index)}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"re\_stat"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{TRUE}\NormalTok{)\{}\FunctionTok{rm}\NormalTok{(re\_stat)\}}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"stat\_exclude"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{TRUE}\NormalTok{)\{}\FunctionTok{rm}\NormalTok{(stat\_exclude)\}}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ class)\{}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i),]}
\NormalTok{ subgroup}\OtherTok{=}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup)}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in}\NormalTok{ subgroup)\{}
\NormalTok{    group}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{k),]}
\NormalTok{    X}\OtherTok{=}\NormalTok{group}\SpecialCharTok{$}\NormalTok{level}
    \CommentTok{\#if(exists("x\_filter")==TRUE)\{rm(x\_filter)\}}
\NormalTok{    out1}\OtherTok{=}\FunctionTok{grubbs}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{2}\NormalTok{))}
\NormalTok{    out2}\OtherTok{=}\FunctionTok{dixon}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{2}\NormalTok{))}
\NormalTok{    out3}\OtherTok{=}\ConstantTok{NULL}
    \ControlFlowTok{for}\NormalTok{(t }\ControlFlowTok{in}\NormalTok{ X)\{}
        \ControlFlowTok{if}\NormalTok{( t}\SpecialCharTok{\textgreater{}}\NormalTok{(}\FunctionTok{mean}\NormalTok{(X)}\SpecialCharTok{+}\DecValTok{2}\SpecialCharTok{*}\FunctionTok{sd}\NormalTok{(X)) }\SpecialCharTok{||}\NormalTok{ t}\SpecialCharTok{\textless{}}\NormalTok{(}\FunctionTok{mean}\NormalTok{(X)}\SpecialCharTok{{-}}\DecValTok{2}\SpecialCharTok{*}\FunctionTok{sd}\NormalTok{(X)))\{out3}\OtherTok{=}\FunctionTok{c}\NormalTok{(out3,t)\}\}}
\NormalTok{    out}\OtherTok{=}\FunctionTok{c}\NormalTok{(out1}\SpecialCharTok{$}\NormalTok{outliers, out2}\SpecialCharTok{$}\NormalTok{outliers, out3)}
    \CommentTok{\#num\_x=length(x\_filter)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out))\{re\_group}\OtherTok{=}\NormalTok{group\}}\ControlFlowTok{else}\NormalTok{\{re\_group}\OtherTok{=}\NormalTok{group[}\FunctionTok{which}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{level}\SpecialCharTok{!=}\NormalTok{out),]\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out))\{exclude}\OtherTok{=}\ConstantTok{NULL}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{exclude}\OtherTok{=}\NormalTok{group[}\FunctionTok{which}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{level}\SpecialCharTok{==}\NormalTok{out),]\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"re\_stat"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{re\_stat}\OtherTok{=}\NormalTok{re\_group\}}\ControlFlowTok{else}\NormalTok{\{re\_stat}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(re\_stat,re\_group)\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"stat\_exclude"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{stat\_exclude}\OtherTok{=}\NormalTok{exclude\}}\ControlFlowTok{else}\NormalTok{\{stat\_exclude}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(stat\_exclude,exclude)\}}
\NormalTok{    \}}
\NormalTok{ \}}
\NormalTok{list}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"raw"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"raw"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"control"}\NormalTok{))}
\NormalTok{t.test}\OtherTok{=}\FunctionTok{array}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"compare1"}\NormalTok{,}\StringTok{"compare2"}\NormalTok{,}\StringTok{"p"}\NormalTok{,}\StringTok{"index"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{(chem }\ControlFlowTok{in}\NormalTok{ class)\{}
    \ControlFlowTok{for}\NormalTok{(row }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(list))\{}
\NormalTok{    double}\OtherTok{=}\NormalTok{list[row,]}
\NormalTok{    escape}\OtherTok{=}\DecValTok{0}
        \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\StringTok{"low"}\NormalTok{,}\StringTok{"medium"}\NormalTok{,}\StringTok{"high"}\NormalTok{))\{}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare2}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{1}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare2}\OtherTok{=}\NormalTok{double[}\DecValTok{1}\NormalTok{]\}}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare1}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{2}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare1}\OtherTok{=}\NormalTok{double[}\DecValTok{2}\NormalTok{]\}}
        \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"model"} \SpecialCharTok{\&}\NormalTok{ double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{)\{compare2}\OtherTok{=}\StringTok{"model"}\NormalTok{; compare1}\OtherTok{=}\StringTok{"control"}\NormalTok{; escape}\OtherTok{=}\DecValTok{1}\NormalTok{\}}
\NormalTok{        X}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare2 }\SpecialCharTok{\&}\NormalTok{ re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{chem),] }\CommentTok{\#x\textasciitilde{}compare2}
\NormalTok{        Y}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare1 }\SpecialCharTok{\&}\NormalTok{ re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{chem),] }\CommentTok{\#y\textasciitilde{}compare1}
\NormalTok{        stat\_p}\OtherTok{=}\FunctionTok{t.test}\NormalTok{(X}\SpecialCharTok{$}\NormalTok{level, Y}\SpecialCharTok{$}\NormalTok{level, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F)}
\NormalTok{        stat\_p}\SpecialCharTok{$}\NormalTok{p.value}\OtherTok{=}\FunctionTok{round}\NormalTok{(stat\_p}\SpecialCharTok{$}\NormalTok{p.value,}\DecValTok{5}\NormalTok{)}
        \CommentTok{\#hx=fivenum(X$level)[4]+(fivenum(X$level)[4]{-}fivenum(X$level)[2])*(1.5)}
        \CommentTok{\#hy=fivenum(Y$level)[4]+(fivenum(Y$level)[4]{-}fivenum(Y$level)[2])*(1.5)}
\NormalTok{        t.test}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(t.test,}\FunctionTok{c}\NormalTok{(compare1, compare2, stat\_p}\SpecialCharTok{$}\NormalTok{p.value, chem),}
                    \FunctionTok{c}\NormalTok{(compare2, compare1, stat\_p}\SpecialCharTok{$}\NormalTok{p.value, chem))}
        \ControlFlowTok{if}\NormalTok{(escape}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}\ControlFlowTok{break}\NormalTok{\}}
\NormalTok{        \}}
\NormalTok{    \}}
\NormalTok{\}}
\NormalTok{stat}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(t.test[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,])}
\FunctionTok{colnames}\NormalTok{(stat)}\OtherTok{=}\NormalTok{t.test[}\DecValTok{1}\NormalTok{,]}
\FunctionTok{write.table}\NormalTok{(stat, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ttest"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(re\_stat, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"re\_filter\_chemical\_index"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }
        \AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{write.table}\NormalTok{(stat\_exclude, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"re\_exclude"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }
        \AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\#\# loop end here}
\NormalTok{re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\OtherTok{=}\FunctionTok{capitalize}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup)}
\NormalTok{stat}\SpecialCharTok{$}\NormalTok{compare1}\OtherTok{=}\FunctionTok{capitalize}\NormalTok{(stat}\SpecialCharTok{$}\NormalTok{compare1)}
\NormalTok{t1}\OtherTok{=}\NormalTok{stat[}\FunctionTok{which}\NormalTok{(stat}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{!=}\StringTok{"Model"} \SpecialCharTok{\&}\NormalTok{ stat}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{!=}\StringTok{"Control"}\NormalTok{),]}
\NormalTok{    t1}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{compare2}\SpecialCharTok{==}\StringTok{"model"}\NormalTok{, }
        \FunctionTok{ifelse}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.01}\NormalTok{, }\StringTok{"**"}\NormalTok{, }\StringTok{"*"}\NormalTok{), }\StringTok{""}\NormalTok{), }
        \FunctionTok{ifelse}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.01}\NormalTok{, }\StringTok{"\#\#"}\NormalTok{, }\StringTok{"\#"}\NormalTok{), }\StringTok{""}\NormalTok{))}
\NormalTok{t2}\OtherTok{=}\NormalTok{stat[}\FunctionTok{which}\NormalTok{(stat}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{==}\StringTok{"Model"} \SpecialCharTok{\&}\NormalTok{ stat}\SpecialCharTok{$}\NormalTok{compare2}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{),]}
\NormalTok{    t2}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{compare2}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{, }
        \FunctionTok{ifelse}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.01}\NormalTok{, }\StringTok{"**"}\NormalTok{, }\StringTok{"*"}\NormalTok{), }\StringTok{""}\NormalTok{), }
        \FunctionTok{ifelse}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{p}\SpecialCharTok{\textless{}}\FloatTok{0.01}\NormalTok{, }\StringTok{"\#\#"}\NormalTok{, }\StringTok{"\#"}\NormalTok{), }\StringTok{""}\NormalTok{))}
\NormalTok{tt}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(t1[}\FunctionTok{which}\NormalTok{(t1}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),], t2[}\FunctionTok{which}\NormalTok{(t2}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),])}
\NormalTok{tt}\SpecialCharTok{$}\NormalTok{h}\OtherTok{=}\ConstantTok{NA}
\NormalTok{tt}\SpecialCharTok{$}\NormalTok{h1}\OtherTok{=}\ConstantTok{NA}
\NormalTok{tt}\SpecialCharTok{$}\NormalTok{h2}\OtherTok{=}\ConstantTok{NA}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index))\{}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{subgroup))\{}
\NormalTok{    calculate}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i }\SpecialCharTok{\&}\NormalTok{ re\_stat}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{j),]}
\NormalTok{    rule}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i),]}
\NormalTok{    h}\OtherTok{=}\FunctionTok{max}\NormalTok{(calculate}\SpecialCharTok{$}\NormalTok{level) }\CommentTok{\#fivenum(calculate$level)[4]+(fivenum(calculate$level)[4]{-}fivenum(calculate$level)[2])*(3/2)}
\NormalTok{    h1}\OtherTok{=}\NormalTok{h}\SpecialCharTok{+}\NormalTok{(}\FunctionTok{max}\NormalTok{(rule}\SpecialCharTok{$}\NormalTok{level)}\SpecialCharTok{{-}}\FunctionTok{min}\NormalTok{(rule}\SpecialCharTok{$}\NormalTok{level))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{    h2}\OtherTok{=}\NormalTok{h}\SpecialCharTok{+}\NormalTok{(}\FunctionTok{max}\NormalTok{(rule}\SpecialCharTok{$}\NormalTok{level)}\SpecialCharTok{{-}}\FunctionTok{min}\NormalTok{(rule}\SpecialCharTok{$}\NormalTok{level))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{3}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
    \CommentTok{\#if(h \textgreater{} max(calculate$level)+(fivenum(calculate$level)[4]{-}fivenum(calculate$level)[2]))\{h=max(calculate$level)\}}
\NormalTok{    test}\OtherTok{=}\NormalTok{tt[}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i }\SpecialCharTok{\&}\NormalTok{ tt}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{==}\NormalTok{j),]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(test)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)\{tt[}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i }\SpecialCharTok{\&}\NormalTok{ tt}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{==}\NormalTok{j),]}\SpecialCharTok{$}\NormalTok{h}\OtherTok{=}\NormalTok{h; }
\NormalTok{              tt[}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i }\SpecialCharTok{\&}\NormalTok{ tt}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{==}\NormalTok{j),]}\SpecialCharTok{$}\NormalTok{h1}\OtherTok{=}\NormalTok{h1}
\NormalTok{              tt[}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i }\SpecialCharTok{\&}\NormalTok{ tt}\SpecialCharTok{$}\NormalTok{compare1}\SpecialCharTok{==}\NormalTok{j),]}\SpecialCharTok{$}\NormalTok{h2}\OtherTok{=}\NormalTok{h2\}}
\NormalTok{    \}}
\NormalTok{\}}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ class)\{}
\NormalTok{data}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i),]}
\CommentTok{\#delta=max(data$level){-}min(data$level)}
\NormalTok{anno}\OtherTok{=}\NormalTok{tt[}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\NormalTok{i),]}
\NormalTok{savename}\OtherTok{=}\NormalTok{i}
\NormalTok{complement}\OtherTok{=}\NormalTok{anno[}\DecValTok{1}\NormalTok{,]}
\NormalTok{anno1}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"*"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"**"}\NormalTok{)),]}
\NormalTok{anno2}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#\#"}\NormalTok{)),]}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno1)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno1}\OtherTok{=}\NormalTok{complement; anno1}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno2)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno2}\OtherTok{=}\NormalTok{complement; anno2}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
\NormalTok{boxplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{subgroup,}\AttributeTok{y=}\NormalTok{level,}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
  \FunctionTok{stat\_boxplot}\NormalTok{(}\AttributeTok{geom=}\StringTok{"errorbar"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#geom\_point(aes(fill=subgroup), shape=21, color="black") +}
  \FunctionTok{geom\_jitter}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup, }\AttributeTok{x=}\NormalTok{subgroup), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.01}\NormalTok{, }\AttributeTok{height=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_summary}\NormalTok{(}\AttributeTok{fun=}\StringTok{"mean"}\NormalTok{,}\AttributeTok{geom=}\StringTok{"point"}\NormalTok{,}\AttributeTok{shape=}\DecValTok{23}\NormalTok{,}\AttributeTok{size=}\DecValTok{3}\NormalTok{,}\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h1),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h2),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{4}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\FunctionTok{paste0}\NormalTok{(}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{index),}\StringTok{"("}\NormalTok{, }\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{unit), }\StringTok{")"}\NormalTok{), }
    \AttributeTok{x=}\StringTok{"Classification(Control vs model or Eucommia vs model: * \textasciitilde{} p \textless{} 0.05; ** \textasciitilde{} p \textless{} 0.01. \textbackslash{}}
\StringTok{    Pro{-} or raw{-} Eucommia in identical dosage compare with each other: \# \textasciitilde{} p \textless{} 0.05; \#\# \textasciitilde{} p \textless{} 0.01)"}\NormalTok{, }
    \AttributeTok{title=}\StringTok{"Hematochemistry"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{10}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =}\StringTok{"white"}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(boxplot, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{10}\NormalTok{, }\AttributeTok{height=}\DecValTok{6}\NormalTok{)}
\NormalTok{\}}
 \DocumentationTok{\#\#\#\# facet\_grid all plot}
\NormalTok{ data}\OtherTok{=}\NormalTok{re\_stat}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{index\_unit}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{index, }\StringTok{"("}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{unit, }\StringTok{")"}\NormalTok{)}
\NormalTok{ anno}\OtherTok{=}\NormalTok{tt}
\NormalTok{ ct}\OtherTok{=}\FunctionTok{unique}\NormalTok{(data[,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"index"}\NormalTok{,}\StringTok{"index\_unit"}\NormalTok{)])}
\NormalTok{ anno}\OtherTok{=}\FunctionTok{merge}\NormalTok{(anno, ct, }\AttributeTok{by=}\StringTok{"index"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{ anno1}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"*"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"**"}\NormalTok{)),]}
\NormalTok{ anno2}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#\#"}\NormalTok{)),]}
\NormalTok{ complement}\OtherTok{=}\NormalTok{anno[}\DecValTok{1}\NormalTok{,]}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno1)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno1}\OtherTok{=}\NormalTok{complement; anno1}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno2)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno2}\OtherTok{=}\NormalTok{complement; anno2}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
\NormalTok{ boxplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{subgroup,}\AttributeTok{y=}\NormalTok{level,}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
  \FunctionTok{stat\_boxplot}\NormalTok{(}\AttributeTok{geom=}\StringTok{"errorbar"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#geom\_point(aes(fill=subgroup), shape=21, color="black") +}
  \FunctionTok{geom\_jitter}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup, }\AttributeTok{x=}\NormalTok{subgroup), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.01}\NormalTok{, }\AttributeTok{height=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_summary}\NormalTok{(}\AttributeTok{fun=}\StringTok{"mean"}\NormalTok{,}\AttributeTok{geom=}\StringTok{"point"}\NormalTok{,}\AttributeTok{shape=}\DecValTok{23}\NormalTok{,}\AttributeTok{size=}\DecValTok{3}\NormalTok{,}\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h1),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h2),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{4}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{""}\NormalTok{, }
    \AttributeTok{x=}\StringTok{"Classification(Control vs model or Eucommia vs model: * \textasciitilde{} p \textless{} 0.05; ** \textasciitilde{} p \textless{} 0.01. \textbackslash{}}
\StringTok{    Pro{-} or raw{-} Eucommia in identical dosage compare with each other: \# \textasciitilde{} p \textless{} 0.05; \#\# \textasciitilde{} p \textless{} 0.01)"}\NormalTok{, }
    \AttributeTok{title=}\StringTok{"Hematochemistry"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(index\_unit}\SpecialCharTok{\textasciitilde{}}\NormalTok{.,}\AttributeTok{scales=}\StringTok{"free\_y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{10}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =}\StringTok{"white"}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(boxplot, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"chemical\_facet"}\NormalTok{,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{8}\NormalTok{, }\AttributeTok{height=}\DecValTok{20}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# BUN and CR}
\NormalTok{ data}\OtherTok{=}\NormalTok{re\_stat[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\StringTok{"Urea"}\NormalTok{), }\FunctionTok{which}\NormalTok{(re\_stat}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\StringTok{"CR"}\NormalTok{)),]}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{index\_unit}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{index, }\StringTok{"("}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{unit, }\StringTok{")"}\NormalTok{)}
\NormalTok{ anno}\OtherTok{=}\NormalTok{tt[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\StringTok{"Urea"}\NormalTok{), }\FunctionTok{which}\NormalTok{(tt}\SpecialCharTok{$}\NormalTok{index}\SpecialCharTok{==}\StringTok{"CR"}\NormalTok{)),]}
\NormalTok{ ct}\OtherTok{=}\FunctionTok{unique}\NormalTok{(data[,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"index"}\NormalTok{,}\StringTok{"index\_unit"}\NormalTok{)])}
\NormalTok{ anno}\OtherTok{=}\FunctionTok{merge}\NormalTok{(anno, ct, }\AttributeTok{by=}\StringTok{"index"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{ anno1}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"*"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"**"}\NormalTok{)),]}
\NormalTok{ anno2}\OtherTok{=}\NormalTok{anno[}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#"}\NormalTok{),}\FunctionTok{which}\NormalTok{(anno}\SpecialCharTok{$}\NormalTok{anno}\SpecialCharTok{==}\StringTok{"\#\#"}\NormalTok{)),]}
\NormalTok{ complement}\OtherTok{=}\NormalTok{anno[}\DecValTok{1}\NormalTok{,]}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno1)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno1}\OtherTok{=}\NormalTok{complement; anno1}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
 \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(anno2)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{anno2}\OtherTok{=}\NormalTok{complement; anno2}\SpecialCharTok{$}\NormalTok{anno}\OtherTok{=}\StringTok{""}\NormalTok{\}}
\NormalTok{ boxplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{subgroup,}\AttributeTok{y=}\NormalTok{level,}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
  \FunctionTok{stat\_boxplot}\NormalTok{(}\AttributeTok{geom=}\StringTok{"errorbar"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#geom\_point(aes(fill=subgroup), shape=21, color="black") +}
  \FunctionTok{geom\_jitter}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup, }\AttributeTok{x=}\NormalTok{subgroup), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.01}\NormalTok{, }\AttributeTok{height=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{stat\_summary}\NormalTok{(}\AttributeTok{fun=}\StringTok{"mean"}\NormalTok{,}\AttributeTok{geom=}\StringTok{"point"}\NormalTok{,}\AttributeTok{shape=}\DecValTok{23}\NormalTok{,}\AttributeTok{size=}\DecValTok{3}\NormalTok{,}\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h1),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno1}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{geom\_label}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{compare1, }\AttributeTok{label=}\NormalTok{anno, }\AttributeTok{y=}\NormalTok{h2),}
        \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }
        \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.7}\NormalTok{), }\AttributeTok{label.size=}\FunctionTok{ifelse}\NormalTok{(anno2}\SpecialCharTok{$}\NormalTok{anno[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{""}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.3}\NormalTok{),}
        \AttributeTok{size=}\DecValTok{4}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Control"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{,}\StringTok{"Drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"Model"}\OtherTok{=}\StringTok{"\#7E6148FF"}\NormalTok{,}
                \StringTok{"Pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"Pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"Pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"Raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"Raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{""}\NormalTok{, }
    \AttributeTok{x=}\StringTok{"Classification(Control vs model or Eucommia vs model: * \textasciitilde{} p \textless{} 0.05; ** \textasciitilde{} p \textless{} 0.01. \textbackslash{}}
\StringTok{    Pro{-} or raw{-} Eucommia in identical dosage compare with each other: \# \textasciitilde{} p \textless{} 0.05; \#\# \textasciitilde{} p \textless{} 0.01)"}\NormalTok{, }
    \AttributeTok{title=}\StringTok{"Hematochemistry"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_grid}\NormalTok{(index\_unit}\SpecialCharTok{\textasciitilde{}}\NormalTok{.,}\AttributeTok{scales=}\StringTok{"free\_y"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{10}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(), }\AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =}\StringTok{"white"}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(boxplot, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"BUN\_CR\_facet"}\NormalTok{,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{10}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-chemical_svg.r}{%
\section{File: chemical\_svg.R}\label{file-chemical_svg.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(grImport2)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-cholic_acid.r}{%
\section{File: cholic\_acid.R}\label{file-cholic_acid.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cat}\NormalTok{(}\StringTok{"Cholic acid formula: C24{-}H40{-}O5}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"Cholic acid{-}d4 formula: C24{-}H36{-}D4{-}O5}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(}\StringTok{"{-}{-}{-}Ion mode{-}{-}{-}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}

\FunctionTok{cat}\NormalTok{(}\StringTok{"Cholic acid{-}d4 [M{-}H]{-}: C24{-}H35{-}D4{-}O5}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{d4\_neg }\OtherTok{\textless{}{-}} \DecValTok{12}\SpecialCharTok{*}\DecValTok{24} \SpecialCharTok{+} \FloatTok{1.007825}\SpecialCharTok{*}\DecValTok{35} \SpecialCharTok{+} \FloatTok{2.014102}\SpecialCharTok{*}\DecValTok{4} \SpecialCharTok{+} \FloatTok{15.994915}\SpecialCharTok{*}\DecValTok{5}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Cholic acid{-}d4 in negtive ion mode [M{-}H]{-}: "}\NormalTok{, d4\_neg, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}

\FunctionTok{cat}\NormalTok{(}\StringTok{"Cholic acid{-}d4 [M{-}2*H2O+H]+: C24{-}H33{-}D4{-}O3}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{d4\_pos }\OtherTok{\textless{}{-}} \DecValTok{12}\SpecialCharTok{*}\DecValTok{24} \SpecialCharTok{+} \FloatTok{1.007825}\SpecialCharTok{*}\DecValTok{33} \SpecialCharTok{+} \FloatTok{2.014102}\SpecialCharTok{*}\DecValTok{4} \SpecialCharTok{+} \FloatTok{15.994915}\SpecialCharTok{*}\DecValTok{3}
\FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Cholic acid{-}d4 in positive ion mode [M{-}H2O+H]+: "}\NormalTok{, d4\_pos, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-class_matrix.r}{%
\section{File: class\_matrix.R}\label{file-class_matrix.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(hrbrthemes)}
\NormalTok{plimit}\OtherTok{=}\FloatTok{0.5}
\NormalTok{datapath1}\OtherTok{=}\StringTok{"stat\_classification.tsv"}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath1, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{definition}\SpecialCharTok{!=}\StringTok{"null"}\NormalTok{),]}
\NormalTok{datapath2}\OtherTok{=}\StringTok{"fingerid\_first\_score.tsv"}
\NormalTok{data2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath2, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, data2[,}\FunctionTok{colnames}\NormalTok{(data2) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{)], }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{similarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{instance }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{2028}\NormalTok{, }\DecValTok{274}\NormalTok{, }\DecValTok{347}\NormalTok{, }\DecValTok{495}\NormalTok{, }\DecValTok{2268}\NormalTok{)}
\NormalTok{test }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ instance, ]}
\DocumentationTok{\#\# another: "specific\_pp", "definition\_pp"}
\NormalTok{facet }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"specific\_pp"}\NormalTok{, }\StringTok{"level\_5\_pp"}\NormalTok{, }\StringTok{"subclass\_pp"}\NormalTok{, }\StringTok{"class\_pp"}\NormalTok{, }\StringTok{"superclass\_pp"}\NormalTok{)}
\NormalTok{re\_facet }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"Most specific class"}\NormalTok{, }\StringTok{"Level 5"}\NormalTok{, }\StringTok{"Subclass"}\NormalTok{, }\StringTok{"Class"}\NormalTok{, }\StringTok{"Superclass"}\NormalTok{)}
\FunctionTok{colnames}\NormalTok{(test)[}\FunctionTok{colnames}\NormalTok{(test) }\SpecialCharTok{\%in\%}\NormalTok{ facet]}\OtherTok{=}\NormalTok{re\_facet}
\NormalTok{test }\OtherTok{\textless{}{-}} \FunctionTok{melt}\NormalTok{(test, }\AttributeTok{measure.vars=}\NormalTok{re\_facet, }\AttributeTok{variable.name=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value.name=}\StringTok{"expr"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(test) }\SpecialCharTok{+} 
  \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\DecValTok{2}\NormalTok{, }\AttributeTok{y=}\NormalTok{expr, }
               \AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(expr}\SpecialCharTok{\textgreater{}}\NormalTok{plimit, }
                           \FunctionTok{ifelse}\NormalTok{(condition}\SpecialCharTok{==}\NormalTok{re\_facet[}\DecValTok{1}\NormalTok{], }\StringTok{"PPCP (filter)"}\NormalTok{, }\StringTok{"PPCP"}\NormalTok{), }\StringTok{"filter"}\NormalTok{)), }
           \AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# class}
\FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\DecValTok{3}\NormalTok{, }\AttributeTok{y=}\NormalTok{plimit, }\AttributeTok{fill=}\StringTok{"PPCP threshold"}\NormalTok{), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# class expect}
  \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\DecValTok{1}\NormalTok{, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }
               \AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(similarity}\SpecialCharTok{\textgreater{}}\FloatTok{0.4}\NormalTok{, }
                           \FunctionTok{ifelse}\NormalTok{(condition}\SpecialCharTok{==}\NormalTok{re\_facet[}\DecValTok{1}\NormalTok{], }\StringTok{"filter"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{), }\StringTok{"filter"}\NormalTok{))) }\SpecialCharTok{+} \CommentTok{\# similarity}
\FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\DecValTok{4}\NormalTok{, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{fill=}\StringTok{"similarity threshold"}\NormalTok{)) }\SpecialCharTok{+} \CommentTok{\# similarity expect}
  \FunctionTok{theme\_ipsum}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\FunctionTok{c}\NormalTok{(}\StringTok{"PPCP (filter)"}\OtherTok{=}\StringTok{"\#ADB6B6FF"}\NormalTok{, }\StringTok{"PPCP"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}
                               \StringTok{"PPCP threshold"}\OtherTok{=}\StringTok{"\#0073C2FF"}\NormalTok{)) }\SpecialCharTok{+}
\FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Status"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow=}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{6}\NormalTok{),}
      \AttributeTok{panel.spacing =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\StringTok{"lines"}\NormalTok{),}
      \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{0}\NormalTok{),}
      \AttributeTok{axis.title.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{, }
      \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{), }
      \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{8}\NormalTok{), }
      \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{8}\NormalTok{),}
      \AttributeTok{strip.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{7}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{),}
      \AttributeTok{strip.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{), }
      \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.2}\NormalTok{,}\FloatTok{0.2}\NormalTok{,}\FloatTok{0.2}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{      ) }\SpecialCharTok{+}
\FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{facet\_grid}\NormalTok{(id }\SpecialCharTok{\textasciitilde{}}\NormalTok{ condition) }
 \CommentTok{\#ggsave(p, file="test.svg")}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ eg }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{6}\NormalTok{)), }\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)))}
\FunctionTok{colnames}\NormalTok{(eg) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{)}
\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(eg, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y)) }\SpecialCharTok{+}
  \FunctionTok{geom\_step}\NormalTok{(}\AttributeTok{size=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"Class priority"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
        \AttributeTok{panel.spacing =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\StringTok{"lines"}\NormalTok{),}
        \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{,}\FloatTok{0.2}\NormalTok{,}\DecValTok{0}\NormalTok{,}\FloatTok{0.2}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
        \CommentTok{\#plot.background = element\_rect(fill = "white"),}
        \AttributeTok{axis.title.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size=}\DecValTok{7}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{, }
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  text }\OtherTok{\textless{}{-}}\NormalTok{ df[df}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ instance, }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"definition"}\NormalTok{)]}
\NormalTok{  text}\SpecialCharTok{$}\NormalTok{access }\OtherTok{\textless{}{-}} \StringTok{"Access class"}
\NormalTok{  p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{text, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\DecValTok{5}\NormalTok{, }\AttributeTok{y=}\DecValTok{5}\NormalTok{, }\AttributeTok{label=}\FunctionTok{str\_wrap}\NormalTok{(definition, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }
              \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{facet\_grid}\NormalTok{(id}\SpecialCharTok{\textasciitilde{}}\NormalTok{access) }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
      \AttributeTok{panel.spacing =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\StringTok{"lines"}\NormalTok{),}
      \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.2}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
      \CommentTok{\#plot.background = element\_rect(fill = "white"),}
      \AttributeTok{axis.title.x =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{7}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{),}
      \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{, }
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{)}
\NormalTok{)}
\FunctionTok{svg}\NormalTok{(}\StringTok{"class\_priority.svg"}\NormalTok{, }\AttributeTok{height=}\DecValTok{7}\NormalTok{, }\AttributeTok{width=}\DecValTok{7}\NormalTok{)}
\CommentTok{\#pdf("class\_priority.svg", height=7, width=7)}
\FunctionTok{grid.newpage}\NormalTok{()}
\FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{60}\NormalTok{)) )}
\FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{7}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{50}\NormalTok{ ))}
\FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{50}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{3}\SpecialCharTok{:}\DecValTok{50}\NormalTok{ ))}
\FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{46}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{51}\SpecialCharTok{:}\DecValTok{60}\NormalTok{ ))}
\FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful_2.r}{%
\section{File: colorful\_2.R}\label{file-colorful_2.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"sun.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{gather}\NormalTok{(}\AttributeTok{key =} \StringTok{"observation"}\NormalTok{, }\AttributeTok{value=}\StringTok{"value"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)) }
\NormalTok{nObsType }\OtherTok{\textless{}{-}} \FunctionTok{nlevels}\NormalTok{(}\FunctionTok{as.factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{observation))}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{arrange}\NormalTok{(group, name)}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(data)}\SpecialCharTok{/}\NormalTok{nObsType), }\AttributeTok{each=}\NormalTok{nObsType)}
\NormalTok{data}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{value}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{),]}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{group\_comple}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{value}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"pro"}\NormalTok{,}\StringTok{"raw"}\NormalTok{)}
\NormalTok{label\_data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(id, name) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{tot=}\FunctionTok{sum}\NormalTok{(value))}
\NormalTok{number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
\NormalTok{angle }\OtherTok{\textless{}{-}} \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (label\_data}\SpecialCharTok{$}\NormalTok{id}\FloatTok{{-}0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{hjust }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
\NormalTok{p }\OtherTok{\textless{}{-}} 
  \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(id), }\AttributeTok{y=}\NormalTok{value, }\AttributeTok{fill=}\NormalTok{group\_comple),}
           \AttributeTok{colour=}\StringTok{"\#000033"}\NormalTok{,}
           \AttributeTok{stat=}\StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}
\NormalTok{           ) }\SpecialCharTok{+}
\FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
      \AttributeTok{legend.key.size =} \FunctionTok{unit}\NormalTok{(}\DecValTok{35}\NormalTok{, }\StringTok{"pt"}\NormalTok{)}
\NormalTok{      ) }\SpecialCharTok{+}
\FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{)}\SpecialCharTok{+}
\FunctionTok{guides}\NormalTok{(}
       \AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{order =} \DecValTok{1}\NormalTok{)}
\NormalTok{       ) }\SpecialCharTok{+}
\FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{id, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{label=}\NormalTok{name, }\AttributeTok{hjust=}\NormalTok{hjust),}
          \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{angle=} \DecValTok{90}\NormalTok{, }
          \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
          \AttributeTok{family=}\StringTok{"Times"}\NormalTok{)}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"test.pdf"}\NormalTok{,}\AttributeTok{width=}\DecValTok{20}\NormalTok{,}\AttributeTok{height=}\DecValTok{50}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful_3_for_volcano.r}{%
\section{File: colorful\_3\_for\_volcano.R}\label{file-colorful_3_for_volcano.r}}

\begin{Shaded}
\begin{Highlighting}[]
            \FunctionTok{library}\NormalTok{(tidyverse)}
            
            \FunctionTok{library}\NormalTok{(RColorBrewer)}
            
            \FunctionTok{library}\NormalTok{(ggsci)}
            
\NormalTok{            data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"pearson\_filter\_volcano\_sun.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
            
\NormalTok{            data}\SpecialCharTok{$}\NormalTok{group\_comple}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{FC}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{)}
            
\NormalTok{            label\_data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{group\_by}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), group) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{tot=}\FunctionTok{sum}\NormalTok{(FC))}
            
\NormalTok{            label\_data}\OtherTok{=}\NormalTok{label\_data[}\FunctionTok{order}\NormalTok{(label\_data}\SpecialCharTok{$}\NormalTok{group),]}
            
\NormalTok{            label\_data}\SpecialCharTok{$}\NormalTok{num}\OtherTok{=}\FunctionTok{rownames}\NormalTok{(label\_data)}
            
\NormalTok{            number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
            
\NormalTok{            angle }\OtherTok{\textless{}{-}} \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (}\FunctionTok{as.numeric}\NormalTok{(label\_data}\SpecialCharTok{$}\NormalTok{num)}\SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar}
            
\NormalTok{            label\_data}\SpecialCharTok{$}\NormalTok{hjust }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
            
\NormalTok{            label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
            
\NormalTok{            colourCount }\OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id))}
            
\NormalTok{            getPalette }\OtherTok{=} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{12}\NormalTok{, }\StringTok{"Paired"}\NormalTok{))}
            
\NormalTok{            test1}\OtherTok{=}\NormalTok{label\_data[}\FunctionTok{nrow}\NormalTok{(label\_data),]}
            
\NormalTok{            p }\OtherTok{\textless{}{-}} 
             \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+}
             \FunctionTok{geom\_bar}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(name), }\AttributeTok{y=}\NormalTok{fold\_change, }\AttributeTok{fill=}\FunctionTok{as.factor}\NormalTok{(id)),}
                      \AttributeTok{stat=}\StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}
\NormalTok{                      ) }\SpecialCharTok{+}
             \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{0}\NormalTok{, }\AttributeTok{linetype =} \StringTok{"twodash"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{name, }\AttributeTok{y=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold\_change), }\AttributeTok{label=}\NormalTok{name, }\AttributeTok{hjust=}\NormalTok{hjust),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{angle=}\NormalTok{ label\_data}\SpecialCharTok{$}\NormalTok{angle,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{test1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{name, }\AttributeTok{y=}\SpecialCharTok{{-}}\DecValTok{40}\NormalTok{, }\AttributeTok{label=}\StringTok{"p{-}value \textless{} 0.05"}\NormalTok{),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{test1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{name, }\AttributeTok{y=}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{, }\AttributeTok{label=}\StringTok{"r(pearson) \textgreater{}= 0.4"}\NormalTok{),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{getPalette}\NormalTok{(colourCount)) }\SpecialCharTok{+}
             \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+} 
             \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{50}\NormalTok{,}\DecValTok{50}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{theme}\NormalTok{(}
                   \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
                       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.1}\NormalTok{),}
                       \AttributeTok{legend.title=} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                   \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                   \AttributeTok{legend.text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{6}\NormalTok{)}
\NormalTok{                  ) }\SpecialCharTok{+}
             \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{)}\SpecialCharTok{+}
             \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
             \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow=}\DecValTok{11}\NormalTok{))}
            \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"test.pdf"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful_fc.r}{%
\section{File: colorful\_FC.R}\label{file-colorful_fc.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\NormalTok{pal}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20c"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal}\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(pal,}\DecValTok{5}\SpecialCharTok{:}\DecValTok{4}\NormalTok{))}
\NormalTok{pal}\OtherTok{=} \FunctionTok{c}\NormalTok{(pal[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{],pal[}\DecValTok{2}\NormalTok{,}\DecValTok{3}\SpecialCharTok{:}\DecValTok{1}\NormalTok{])}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"com\_lignans\_and\_iridoids.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id),]}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{), ]}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id, }\AttributeTok{levels=}\NormalTok{data[}\FunctionTok{order}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw, }\AttributeTok{decreasing =}\NormalTok{ T), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)])}
\NormalTok{label\_data }\OtherTok{\textless{}{-}}\NormalTok{ data}
\NormalTok{label\_data }\OtherTok{\textless{}{-}}\NormalTok{ label\_data[}\FunctionTok{order}\NormalTok{(label\_data}\SpecialCharTok{$}\NormalTok{id), ]}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{sequ }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(label\_data))}
\NormalTok{number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
\NormalTok{angle }\OtherTok{\textless{}{-}} \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (label\_data}\SpecialCharTok{$}\NormalTok{sequ}\FloatTok{{-}0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{hjust }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(id), }\AttributeTok{y=}\FunctionTok{log2}\NormalTok{(pro.raw), }\AttributeTok{fill=}\FunctionTok{log2}\NormalTok{(pro.raw))) }\SpecialCharTok{+} 
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat=}\StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{7}\NormalTok{,}\DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{start =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Log2(FC)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colours =}\NormalTok{ pal, }\AttributeTok{breaks=}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{,}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{id, }\AttributeTok{y=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{log2}\NormalTok{(pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{, }\FunctionTok{log2}\NormalTok{(pro.raw)}\SpecialCharTok{+}\FloatTok{0.3}\NormalTok{, }\FunctionTok{log2}\NormalTok{(pro.raw)}\SpecialCharTok{{-}}\FloatTok{0.3}\NormalTok{), }\AttributeTok{angle=}\NormalTok{angle, }
                                 \AttributeTok{label=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{log2}\NormalTok{(pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{|} \FunctionTok{log2}\NormalTok{(pro.raw)}\SpecialCharTok{\textless{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\FunctionTok{as.character}\NormalTok{(id), }\StringTok{""}\NormalTok{)), }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{,}
            \AttributeTok{size=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{log2}\NormalTok{(label\_data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{, }\FloatTok{1.5}\NormalTok{, }\DecValTok{1}\NormalTok{), }
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{ ) }\SpecialCharTok{+}
\FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw}\SpecialCharTok{==}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)], }\AttributeTok{y=}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}
         \AttributeTok{label =} \StringTok{"Lignans and iridoids}\SpecialCharTok{\textbackslash{}n}\StringTok{(PPCP \textgreater{} 0.5;}\SpecialCharTok{\textbackslash{}n}\StringTok{Tanimoto similarity \textgreater{} 0.5)}\SpecialCharTok{\textbackslash{}n}\StringTok{FC(peak area:}\SpecialCharTok{\textbackslash{}n}\StringTok{Eucommia{-}pro/raw)"}\NormalTok{, }
         \AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{) }\SpecialCharTok{+}
\CommentTok{\#ggtitle("Lignans and iridoids(PP \textgreater{}= 0.9)\textbackslash{}nFC(peak area:\textbackslash{}nEucommia{-}pro/raw)") +}
\FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \CommentTok{\#plot.title = element\_text(hjust = 0.5, vjust={-}190, face="bold", size=12),}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
      \CommentTok{\#panel.background = element\_rect(fill="white"), }
      \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.41}\NormalTok{),}
      \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
      \CommentTok{\#plot.margin = unit(rep({-}1,4), "cm"), }
      \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{4}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{), }\StringTok{"cm"}\NormalTok{)    }\CommentTok{\# Adjust the margin to make in sort labels are not truncated!}
\NormalTok{) }
\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"fc.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful_line_eucommia.r}{%
\section{File: colorful\_line\_eucommia.R}\label{file-colorful_line_eucommia.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \DocumentationTok{\#\#\# line}
 \FunctionTok{library}\NormalTok{(xcms)}
\NormalTok{ path}\OtherTok{=}\StringTok{"/media/wizard/back/thermo\_mzML\_0518"}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"com\_lignans\_and\_iridoids.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id),]}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{), ]}
 \CommentTok{\# data \textless{}{-} data[which(data$id==1746|data$id==2081),]}
\NormalTok{ metadata }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{|} \FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textless{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"m.z"}\NormalTok{)]}
 \CommentTok{\# metadata \textless{}{-} data[, colnames(data) \%in\% c("id", "m.z")]}
\NormalTok{ dda\_file}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.mzML$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \FunctionTok{dir.create}\NormalTok{(}\StringTok{"/media/wizard/back/thermo\_mzML\_0518/EIC"}\NormalTok{)}
\NormalTok{ tolerance}\OtherTok{=}\FloatTok{0.005}
 \ControlFlowTok{for}\NormalTok{(filename }\ControlFlowTok{in}\NormalTok{ dda\_file)\{}
\NormalTok{   dda\_data }\OtherTok{\textless{}{-}} \FunctionTok{readMSData}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path,}\StringTok{"/"}\NormalTok{,filename), }\AttributeTok{mode =} \StringTok{"onDisk"}\NormalTok{)}
   \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path,}\StringTok{"/EIC/EIC\_"}\NormalTok{,filename))}
   \ControlFlowTok{for}\NormalTok{(number }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(metadata))\{}
\NormalTok{     id }\OtherTok{\textless{}{-}}\NormalTok{ metadata[number,}\FunctionTok{colnames}\NormalTok{(metadata) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)]}
\NormalTok{     mz }\OtherTok{\textless{}{-}}\NormalTok{ metadata[number,}\FunctionTok{colnames}\NormalTok{(metadata) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"m.z"}\NormalTok{)]}
\NormalTok{     mzrange }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(mz)}\SpecialCharTok{{-}}\NormalTok{tolerance,}\FunctionTok{as.numeric}\NormalTok{(mz)}\SpecialCharTok{+}\NormalTok{tolerance)}
\NormalTok{     ex\_data }\OtherTok{\textless{}{-}} \FunctionTok{chromatogram}\NormalTok{(dda\_data, }\AttributeTok{msLevel =}\NormalTok{ 1L, }\AttributeTok{mz =}\NormalTok{ mzrange, }\AttributeTok{aggregationFun =} \StringTok{"max"}\NormalTok{)}
\NormalTok{     ex\_data\_1 }\OtherTok{\textless{}{-}}\NormalTok{ ex\_data[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
     \ControlFlowTok{if}\NormalTok{(number}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}
       \FunctionTok{write.table}\NormalTok{(}\FunctionTok{rtime}\NormalTok{(ex\_data\_1),}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/EIC/EIC\_"}\NormalTok{,filename,}\StringTok{"/rt"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{col.names =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)\}}
     \FunctionTok{write.table}\NormalTok{(}\FunctionTok{intensity}\NormalTok{(ex\_data\_1),}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/EIC/EIC\_"}\NormalTok{,filename,}\StringTok{"/"}\NormalTok{,id,}\StringTok{"\_intensity"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{col.names =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
     \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(filename,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,number,}\StringTok{"/"}\NormalTok{,}\FunctionTok{nrow}\NormalTok{(metadata)))}
\NormalTok{   \}}
\NormalTok{ \}}
 \FunctionTok{write.table}\NormalTok{(metadata, }\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/metadata.tsv"}\NormalTok{), }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \DocumentationTok{\#\#\# run bash script colorful\_line\_eucommia\_bash.sh}
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(ggalt)}
\NormalTok{ path}\OtherTok{=}\StringTok{"results/EIC\_rt\_during"}
\NormalTok{ list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                    \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                    \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"com\_lignans\_and\_iridoids.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{), ]}
\NormalTok{ draw\_list }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{|} \FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textless{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)]}
\NormalTok{ draw\_list }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(draw\_list), }\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ list }\OtherTok{\textless{}{-}}\NormalTok{ list[list }\SpecialCharTok{\%in\%}\NormalTok{ draw\_list]}
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ list)\{}
\NormalTok{   savename }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{   data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
\NormalTok{   data\_anno\_mz }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{)]}
\NormalTok{   data\_anno\_rt }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"center\_rt"}\NormalTok{)]}
\NormalTok{   tolerance }\OtherTok{=} \FloatTok{0.005}
\NormalTok{   data\_label }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{label}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),]}
\NormalTok{   data\_label}\SpecialCharTok{$}\NormalTok{sample }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(data\_label}\SpecialCharTok{$}\NormalTok{sample, }\AttributeTok{split=}\StringTok{".mzML"}\NormalTok{)}
\NormalTok{   anno\_x\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt))}
\NormalTok{   anno\_y\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity))}
\NormalTok{   delta }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}\SpecialCharTok{{-}}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}
   \ControlFlowTok{if}\NormalTok{(file}\SpecialCharTok{==}\StringTok{"3938.tsv"}\NormalTok{)\{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textless{}=}\FloatTok{12.08}\NormalTok{),] \}}
\NormalTok{   p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{group=}\NormalTok{sample, }\AttributeTok{colour=}\NormalTok{color)) }\SpecialCharTok{+}
     \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
     \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
     \CommentTok{\#  geom\_label\_repel(data=data\_label, aes(x=rt, y=intensity, label=sample),}
     \CommentTok{\#                    color="black", alpha=0.5, fontface="bold", size=2, angle= 0, xlim=anno\_x\_range, ylim=anno\_y\_range,}
     \CommentTok{\#                    direction="both", segment.size = 0.2, segment.alpha = 0.3, force = 1,}
     \CommentTok{\#                    \#nudge\_x = runif(1, min=delta*(1/18), max=delta*(1/10))*sample(c(1,{-}1),1), }
     \CommentTok{\#                    nudge\_y = max(data$intensity)*(1/10),}
     \CommentTok{\#                    inherit.aes = FALSE, hjust = 0,}
     \CommentTok{\#                    family="Times") +}
     \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Blank"}\OtherTok{=}\StringTok{"\#4A6990FF"}\NormalTok{,}
                                   \StringTok{"Non feature"}\OtherTok{=}\StringTok{"\#B8B8B8FF"}\NormalTok{,}
                                   \StringTok{"Pro\_Eucommia"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                                   \StringTok{"Raw\_Eucommia"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
\CommentTok{\#drug green}
\FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x=}\StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{17}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
         \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID: "}\NormalTok{,}\FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)),}
         \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
\FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{16}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
         \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{{-}}\NormalTok{tolerance,}\StringTok{" \textasciitilde{} "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{+}\NormalTok{tolerance),}
         \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
\FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
         \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{,data\_anno\_rt),}
         \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
\CommentTok{\#theme\_minimal() +}
\FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
      \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{,}\FloatTok{0.75}\NormalTok{),}
      \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
      \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
      \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Finish \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,file))}
\NormalTok{ \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(hrbrthemes)}
\NormalTok{ path}\OtherTok{=}\StringTok{"results/EIC\_rt\_during"}
\NormalTok{ list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"com\_lignans\_and\_iridoids.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{), ]}
\NormalTok{ draw\_list }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{|} \FunctionTok{log2}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{pro.raw)}\SpecialCharTok{\textless{}}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)]}
\NormalTok{ draw\_list }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{as.character}\NormalTok{(draw\_list), }\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ list }\OtherTok{\textless{}{-}}\NormalTok{ list[list }\SpecialCharTok{\%in\%}\NormalTok{ draw\_list]}
\NormalTok{ n}\OtherTok{=}\DecValTok{0}
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ list)\{}
\NormalTok{ id }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ n}\OtherTok{=}\NormalTok{n}\SpecialCharTok{+}\DecValTok{1}
\NormalTok{ savename }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
\NormalTok{ data\_anno\_mz }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{)]}
\NormalTok{ data\_anno\_rt }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"center\_rt"}\NormalTok{)]}
\NormalTok{ tolerance }\OtherTok{=} \FloatTok{0.005}
\NormalTok{ data\_label }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{label}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),]}
\NormalTok{ data\_label}\SpecialCharTok{$}\NormalTok{sample }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(data\_label}\SpecialCharTok{$}\NormalTok{sample, }\AttributeTok{split=}\StringTok{".mzML"}\NormalTok{)}
 \ControlFlowTok{if}\NormalTok{(file}\SpecialCharTok{==}\StringTok{"3938.tsv"}\NormalTok{)\{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textless{}=}\FloatTok{12.08}\NormalTok{),] \}}
 \ControlFlowTok{if}\NormalTok{(file}\SpecialCharTok{==}\StringTok{"3380.tsv"}\NormalTok{)\{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textgreater{}=}\FloatTok{12.55}\NormalTok{),] \}}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
 \ControlFlowTok{if}\NormalTok{(n}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{sum\_data}\OtherTok{=}\NormalTok{data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{,}\DecValTok{9}\NormalTok{)]\}}\ControlFlowTok{else}\NormalTok{\{sum\_data}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_data, data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{,}\DecValTok{9}\NormalTok{)])\}}
 \CommentTok{\#text1=c("x"=min(data$rt), "y"=max(data$intensity)*(17/20), "label"=paste0("ID: ", id))}
 \CommentTok{\#}
\NormalTok{ text2}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\StringTok{"y"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{17}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{{-}}\NormalTok{tolerance,}\StringTok{" \textasciitilde{} "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{+}\NormalTok{tolerance))}
\NormalTok{ text3}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\StringTok{"y"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }\StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{,data\_anno\_rt) )}
\NormalTok{ text}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(text2, text3))}
\NormalTok{ text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
 \ControlFlowTok{if}\NormalTok{(n}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{sum\_text}\OtherTok{=}\NormalTok{text\}}\ControlFlowTok{else}\NormalTok{\{sum\_text}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_text, text)\}}
 \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Finish \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,file))\}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#  plot}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ select }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{279}\NormalTok{, }\DecValTok{458}\NormalTok{, }\DecValTok{574}\NormalTok{, }\DecValTok{1107}\NormalTok{, }\DecValTok{1445}\NormalTok{, }\DecValTok{2227}\NormalTok{, }\DecValTok{2529}\NormalTok{, }\DecValTok{2664}\NormalTok{, }\DecValTok{2824}\NormalTok{, }\DecValTok{3380}\NormalTok{, }\DecValTok{3918}\NormalTok{, }\DecValTok{3938}\NormalTok{)}
\NormalTok{ sum\_data }\OtherTok{\textless{}{-}}\NormalTok{ sum\_data[sum\_data}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ select,]}
\NormalTok{ sum\_data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, sum\_data}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ sum\_text }\OtherTok{\textless{}{-}}\NormalTok{ sum\_text[sum\_text}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ select,]}
\NormalTok{ sum\_text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, sum\_text}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(sum\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{group=}\NormalTok{sample, }\AttributeTok{colour=}\NormalTok{color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Blank"}\OtherTok{=}\StringTok{"\#4A6990FF"}\NormalTok{,}
                \StringTok{"Non feature"}\OtherTok{=}\StringTok{"\#B8B8B8FF"}\NormalTok{,}
                \StringTok{"Pro\_Eucommia"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_Eucommia"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\#drug green}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x=}\StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{sum\_text, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(x), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(y), }\AttributeTok{label=}\NormalTok{label), }
        \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{size=}\FloatTok{3.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal() +}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{scientific) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{as.character}\NormalTok{(id), }\AttributeTok{scales=}\StringTok{"free"}\NormalTok{, }\AttributeTok{ncol=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow=}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{0}\NormalTok{),}
    \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
    \CommentTok{\#panel.spacing = unit(c(0,0,0,0),"cm")}
\NormalTok{    )}
 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"results"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\StringTok{"ms1\_line.svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{15}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#  plot}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\NormalTok{path}\OtherTok{=}\StringTok{"results/ms2\_figures\_label"}
\NormalTok{n}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{select }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{279}\NormalTok{, }\DecValTok{458}\NormalTok{, }\DecValTok{574}\NormalTok{, }\DecValTok{1107}\NormalTok{, }\DecValTok{1445}\NormalTok{, }\DecValTok{2227}\NormalTok{, }\DecValTok{2529}\NormalTok{, }\DecValTok{2664}\NormalTok{, }\DecValTok{2824}\NormalTok{, }\DecValTok{3380}\NormalTok{, }\DecValTok{3918}\NormalTok{, }\DecValTok{3938}\NormalTok{)}
\CommentTok{\# select \textless{}{-} c(1746, 2081)}
\NormalTok{n }\OtherTok{\textless{}{-}}\NormalTok{ n[n }\SpecialCharTok{\%in\%} \FunctionTok{paste0}\NormalTok{(select, }\StringTok{".tsv"}\NormalTok{)]}
\NormalTok{m}\OtherTok{=}\DecValTok{0}
\ControlFlowTok{for}\NormalTok{(x }\ControlFlowTok{in}\NormalTok{ n)\{}
\NormalTok{  m}\OtherTok{=}\NormalTok{m}\SpecialCharTok{+}\DecValTok{1}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(x, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{  id }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(file)}
\NormalTok{  savename}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(file,}\StringTok{".svg"}\NormalTok{)}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{  data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
  \ControlFlowTok{if}\NormalTok{(m}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}
\NormalTok{    sum\_data}\OtherTok{=}\NormalTok{data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{,}\DecValTok{10}\NormalTok{)]}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    sum\_data}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_data, data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{,}\DecValTok{10}\NormalTok{)])}
\NormalTok{  \}}
\NormalTok{  text1}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{mz), }\StringTok{"y"}\OtherTok{=}\DecValTok{90}\NormalTok{, }\StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"precursor.m.z"}\NormalTok{)]) )}
\NormalTok{  text2}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{mz), }\StringTok{"y"}\OtherTok{=}\DecValTok{72}\NormalTok{, }
          \StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{, data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"RT..min."}\NormalTok{)]) )}
\NormalTok{  text3}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{mz), }\StringTok{"y"}\OtherTok{=}\DecValTok{54}\NormalTok{, }\StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Tanimoto similarity: "}\NormalTok{, data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"similarity"}\NormalTok{)]) )}
\NormalTok{  text}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(text1, text2, text3))}
\NormalTok{  text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
  \ControlFlowTok{if}\NormalTok{(m}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}
\NormalTok{    sum\_text}\OtherTok{=}\NormalTok{text}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    sum\_text}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_text, text)}
\NormalTok{  \}}
  \FunctionTok{print}\NormalTok{(file) }
\NormalTok{\}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ data}\OtherTok{=}\NormalTok{sum\_data}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ sum\_text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, sum\_text}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+} 
  \FunctionTok{geom\_segment}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{xend=}\NormalTok{mz, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{yend=}\NormalTok{rel.intensity), }\AttributeTok{color=}\FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"\#E6550DFF"}\NormalTok{), }\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{match}\SpecialCharTok{\textgreater{}=}\DecValTok{1}\NormalTok{),], }\AttributeTok{size=}\FloatTok{0.9}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{rel.intensity),}
            \AttributeTok{color=}\FunctionTok{ifelse}\NormalTok{(data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{match}\SpecialCharTok{\textgreater{}=}\DecValTok{1}\NormalTok{),]}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"red"}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{sum\_text, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(x)}\SpecialCharTok{*}\DecValTok{3}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(y), }\AttributeTok{label=}\NormalTok{label), }
        \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{size=}\FloatTok{3.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{as.character}\NormalTok{(id), }\AttributeTok{scales=}\StringTok{"free\_x"}\NormalTok{, }\AttributeTok{ncol=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"m/z"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Relative intensity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
  \AttributeTok{panel.background=}\FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{0}\NormalTok{),}
  \AttributeTok{panel.grid=}\FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"grey85"}\NormalTok{), }
  \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
  \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
  \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{),}
  \AttributeTok{strip.background  =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{0}\NormalTok{), }
  \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{  )}
\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"results"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\StringTok{"ms2\_segment.svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{12}\NormalTok{,}\AttributeTok{height=}\DecValTok{15}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggtree)}
\FunctionTok{library}\NormalTok{(aplot)}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(rayshader)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(reshape2)}
\NormalTok{ datapath}\OtherTok{=}\StringTok{"results/re\_neg\_RT.tsv"}
\NormalTok{ select }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{279}\NormalTok{, }\DecValTok{458}\NormalTok{, }\DecValTok{574}\NormalTok{, }\DecValTok{1107}\NormalTok{, }\DecValTok{1445}\NormalTok{, }\DecValTok{2227}\NormalTok{, }\DecValTok{2529}\NormalTok{, }\DecValTok{2664}\NormalTok{, }\DecValTok{2824}\NormalTok{, }\DecValTok{3380}\NormalTok{, }\DecValTok{3918}\NormalTok{, }\DecValTok{3938}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ grouppath}\OtherTok{=}\StringTok{"results/stat\_classification.tsv"}
\NormalTok{ group }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{grouppath, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ col }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"row.ID|area"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(data), }\AttributeTok{ignore.case=}\NormalTok{T)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{row.ID }\SpecialCharTok{\%in\%}\NormalTok{ select, }\FunctionTok{c}\NormalTok{(col)]}
 \FunctionTok{colnames}\NormalTok{(data) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"blank"}\NormalTok{, }\StringTok{"Pro{-}Eu1"}\NormalTok{, }\StringTok{"Pro{-}Eu2"}\NormalTok{, }\StringTok{"Pro{-}Eu3"}\NormalTok{, }\StringTok{"Raw{-}Eu1"}\NormalTok{, }\StringTok{"Raw{-}Eu2"}\NormalTok{, }\StringTok{"Raw{-}Eu3"}\NormalTok{)}
 \FunctionTok{rownames}\NormalTok{(data) }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID: "}\NormalTok{,data}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ group\_anno }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, group[, }\FunctionTok{colnames}\NormalTok{(group) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"specific"}\NormalTok{, }\StringTok{"specific\_pp"}\NormalTok{)], }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ group\_anno}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID: "}\NormalTok{,group\_anno}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[, }\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{)]}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{log2}\NormalTok{(data)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# heatmap}
\NormalTok{ savename}\OtherTok{=}\StringTok{"results/features\_heatmap.svg"}
\NormalTok{ phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(data)) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.2}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(data))) }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.2}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{layout\_dendrogram}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}
\NormalTok{ p1 }\OtherTok{\textless{}{-}} \FunctionTok{gather}\NormalTok{(data, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{key=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value=}\StringTok{\textquotesingle{}expr\textquotesingle{}}\NormalTok{)  }\DocumentationTok{\#\# keep the last col}
\NormalTok{ p1 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(p1, group\_anno[, }\FunctionTok{colnames}\NormalTok{(group\_anno) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"specific"}\NormalTok{)], }\AttributeTok{by.x=}\StringTok{"names"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ anno }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\StringTok{"group"}\NormalTok{, }\AttributeTok{y=}\NormalTok{names)) }\SpecialCharTok{+}
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{specific), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{, }\AttributeTok{y=}\StringTok{""}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Classes"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#guides(fill="none") +}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{90}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#legend.text = element\_text(size=20),}
    \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{ pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{condition,}\AttributeTok{y=}\NormalTok{names,}\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal()+}
  \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colors=}\FunctionTok{c}\NormalTok{(}\StringTok{"\#3182BDFF"}\NormalTok{, }\StringTok{"white"}\NormalTok{, }\StringTok{"\#E6550DFF"}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\#scale\_color\_gradientn(colors=c( "black", "\#8F7700FF", "black")) +}
  \CommentTok{\#scale\_fill\_gradient2(low="\#3182BDFF", mid="black", high="\#E6550DFF", midpoint=21) +}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{position=}\StringTok{"right"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Sample name"}\NormalTok{, }\AttributeTok{y=}\StringTok{""}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Log2(peak area)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{()}\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{90}\NormalTok{),}
    \CommentTok{\#axis.text.y = element\_blank(),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#legend.text = element\_text(size=20),}
    \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{ pp\_com }\OtherTok{\textless{}{-}}\NormalTok{ pp }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{insert\_right}\NormalTok{(anno, }\AttributeTok{width=}\NormalTok{.}\DecValTok{15}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{insert\_left}\NormalTok{(phr, }\AttributeTok{width=}\NormalTok{.}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{insert\_top}\NormalTok{(phc, }\AttributeTok{height=}\NormalTok{.}\DecValTok{1}\NormalTok{) }
 \FunctionTok{ggsave}\NormalTok{(pp\_com,}\AttributeTok{file=}\NormalTok{savename, }\AttributeTok{width=}\DecValTok{10}\NormalTok{, }\AttributeTok{height=}\DecValTok{12}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\CommentTok{\# extended data}
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(hrbrthemes)}
\NormalTok{ path}\OtherTok{=}\StringTok{"EIC\_rt\_during"}
\NormalTok{ list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"com\_lignans\_and\_iridoids.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity }\SpecialCharTok{\textgreater{}=} \FloatTok{0.5}\NormalTok{), ]}
\NormalTok{ n}\OtherTok{=}\DecValTok{0}
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ list)\{}
\NormalTok{ id }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ n}\OtherTok{=}\NormalTok{n}\SpecialCharTok{+}\DecValTok{1}
\NormalTok{ savename }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
\NormalTok{ data\_anno\_mz }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{)]}
\NormalTok{ data\_anno\_rt }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"center\_rt"}\NormalTok{)]}
\NormalTok{ tolerance }\OtherTok{=} \FloatTok{0.005}
\NormalTok{ data\_label }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{label}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),]}
\NormalTok{ data\_label}\SpecialCharTok{$}\NormalTok{sample }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(data\_label}\SpecialCharTok{$}\NormalTok{sample, }\AttributeTok{split=}\StringTok{".mzML"}\NormalTok{)}
 \ControlFlowTok{if}\NormalTok{(file}\SpecialCharTok{==}\StringTok{"3938.tsv"}\NormalTok{)\{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textless{}=}\FloatTok{12.08}\NormalTok{),] \}}
 \ControlFlowTok{if}\NormalTok{(file}\SpecialCharTok{==}\StringTok{"3380.tsv"}\NormalTok{)\{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textgreater{}=}\FloatTok{12.55}\NormalTok{),] \}}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
 \ControlFlowTok{if}\NormalTok{(n}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{sum\_data}\OtherTok{=}\NormalTok{data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{,}\DecValTok{9}\NormalTok{)]\}}\ControlFlowTok{else}\NormalTok{\{sum\_data}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_data, data[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{,}\DecValTok{9}\NormalTok{)])\}}
 \CommentTok{\#text1=c("x"=min(data$rt), "y"=max(data$intensity)*(17/20), "label"=paste0("ID: ", id))}
 \CommentTok{\#}
\NormalTok{ text2}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\StringTok{"y"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{17}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{{-}}\NormalTok{tolerance,}\StringTok{" \textasciitilde{} "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{+}\NormalTok{tolerance))}
\NormalTok{ text3}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\OtherTok{=}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\StringTok{"y"}\OtherTok{=}\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }\StringTok{"label"}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{,data\_anno\_rt) )}
\NormalTok{ text}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(text2, text3))}
\NormalTok{ text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ id}
 \ControlFlowTok{if}\NormalTok{(n}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{sum\_text}\OtherTok{=}\NormalTok{text\}}\ControlFlowTok{else}\NormalTok{\{sum\_text}\OtherTok{\textless{}{-}}\FunctionTok{rbind}\NormalTok{(sum\_text, text)\}}
 \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Finish \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,file))\}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#  plot}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ select }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{1746}\NormalTok{,}\DecValTok{2081}\NormalTok{)}
\NormalTok{ sum\_data }\OtherTok{\textless{}{-}}\NormalTok{ sum\_data[sum\_data}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ select,]}
\NormalTok{ sum\_data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, sum\_data}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ sum\_text }\OtherTok{\textless{}{-}}\NormalTok{ sum\_text[sum\_text}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ select,]}
\NormalTok{ sum\_text}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, sum\_text}\SpecialCharTok{$}\NormalTok{id)}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(sum\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{group=}\NormalTok{sample, }\AttributeTok{colour=}\NormalTok{color)) }\SpecialCharTok{+}
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"Blank"}\OtherTok{=}\StringTok{"\#4A6990FF"}\NormalTok{,}
                \StringTok{"Non feature"}\OtherTok{=}\StringTok{"\#B8B8B8FF"}\NormalTok{,}
                \StringTok{"Pro\_Eucommia"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                \StringTok{"Raw\_Eucommia"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\#drug green}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x=}\StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{sum\_text, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(x), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(y), }\AttributeTok{label=}\NormalTok{label), }
        \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal() +}
  \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{scientific) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{as.character}\NormalTok{(id), }\AttributeTok{scales=}\StringTok{"free"}\NormalTok{, }\AttributeTok{ncol=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow=}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_ipsum}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{0}\NormalTok{),}
    \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{10}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{10}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
    \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
    \CommentTok{\#panel.spacing = unit(c(0,0,0,0),"cm")}
\NormalTok{    )}
 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"extended\_ms1\_line.svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful_line_fecal.r}{%
\section{File: colorful\_line\_fecal.R}\label{file-colorful_line_fecal.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \DocumentationTok{\#\#\# line}
 
 \FunctionTok{library}\NormalTok{(ggplot2)}
 
 \FunctionTok{library}\NormalTok{(ggrepel)}
 
 \FunctionTok{library}\NormalTok{(ggsci)}
 
 \FunctionTok{library}\NormalTok{(ggalt)}
 
\NormalTok{ path}\OtherTok{=}\StringTok{"results/EIC\_rt\_during"}
 
\NormalTok{ list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ list)\{}
 
\NormalTok{ savename }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
 
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 
\NormalTok{ data\_anno\_mz }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{)]}
 
\NormalTok{ data\_anno\_rt }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"center\_rt"}\NormalTok{)]}
 
\NormalTok{ tolerance }\OtherTok{=} \FloatTok{0.005}
 
\NormalTok{ data\_label }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{label}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),]}
 
\NormalTok{ anno\_x\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt))}
 
\NormalTok{ anno\_y\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity))}
 
\NormalTok{ delta }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}\SpecialCharTok{{-}}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}
 
 
 
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{group=}\NormalTok{sample, }\AttributeTok{colour=}\NormalTok{color)) }\SpecialCharTok{+}
 
  \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
  
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{data\_label, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{label=}\NormalTok{sample),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }\AttributeTok{xlim=}\NormalTok{anno\_x\_range, }\AttributeTok{ylim=}\NormalTok{anno\_y\_range,}
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{force =} \DecValTok{1}\NormalTok{,}
                      \AttributeTok{nudge\_x =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{min=}\NormalTok{delta}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{18}\NormalTok{), }\AttributeTok{max=}\NormalTok{delta}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{)), }\AttributeTok{nudge\_y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{),}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
                      
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"\#4A6990FF"}\NormalTok{,}\StringTok{"drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  
                \StringTok{"Non feature"}\OtherTok{=}\StringTok{"\#B8B8B8FF"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"high\_raw"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  \CommentTok{\#drug green}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x=}\StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{16}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{{-}}\NormalTok{tolerance,}\StringTok{" \textasciitilde{} "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{+}\NormalTok{tolerance),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{,data\_anno\_rt),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
  
  \CommentTok{\#theme\_minimal() +}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
  
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{,}\FloatTok{0.75}\NormalTok{),}
    
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
    
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}

    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}

 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
 
 \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Finish \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,file))\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-colorful.r}{%
\section{File: colorful.R}\label{file-colorful.r}}

\begin{Shaded}
\begin{Highlighting}[]
            \FunctionTok{library}\NormalTok{(tidyverse)}
            
            \FunctionTok{library}\NormalTok{(RColorBrewer)}
            
\NormalTok{            data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"Sun\_0827{-}1.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
            
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{gather}\NormalTok{(}\AttributeTok{key =} \StringTok{"observation"}\NormalTok{, }\AttributeTok{value=}\StringTok{"value"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)) }
            
\NormalTok{            nObsType }\OtherTok{\textless{}{-}} \FunctionTok{nlevels}\NormalTok{(}\FunctionTok{as.factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{observation))}
            
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{arrange}\NormalTok{(group, name)}
            
\NormalTok{            data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(data)}\SpecialCharTok{/}\NormalTok{nObsType), }\AttributeTok{each=}\NormalTok{nObsType)}
            
\NormalTok{            label\_data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{group\_by}\NormalTok{(id, name) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{tot=}\FunctionTok{sum}\NormalTok{(value))}
            
\NormalTok{            number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
            
\NormalTok{            angle }\OtherTok{\textless{}{-}} \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (label\_data}\SpecialCharTok{$}\NormalTok{id}\FloatTok{{-}0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar}
            
\NormalTok{            label\_data}\SpecialCharTok{$}\NormalTok{hjust }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
            
\NormalTok{            label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
            
\NormalTok{            colourCount }\OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{observation))}
            
\NormalTok{            getPalette }\OtherTok{=} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{12}\NormalTok{, }\StringTok{"Paired"}\NormalTok{))}
            
\NormalTok{            p }\OtherTok{\textless{}{-}} 
             \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+}
             \FunctionTok{geom\_bar}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(id), }\AttributeTok{y=}\NormalTok{value, }\AttributeTok{fill=}\NormalTok{observation), }
                      \AttributeTok{stat=}\StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}
\NormalTok{                      ) }\SpecialCharTok{+}
             \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{getPalette}\NormalTok{(colourCount)) }\SpecialCharTok{+}
             \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{10}\NormalTok{,}\DecValTok{13}\NormalTok{) }\SpecialCharTok{+}
             \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
             \FunctionTok{theme}\NormalTok{(}
                   \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
                       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.03}\NormalTok{),}
                       \AttributeTok{legend.title=} \FunctionTok{element\_blank}\NormalTok{(),}
                       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                   \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                   \AttributeTok{legend.text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{6}\NormalTok{)}
\NormalTok{                  ) }\SpecialCharTok{+}
            \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{)}\SpecialCharTok{+}
            \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{nrow=}\DecValTok{10}\NormalTok{))}\SpecialCharTok{+}
            \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
            \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{id, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{label=}\NormalTok{name, }\AttributeTok{hjust=}\NormalTok{hjust),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=}\NormalTok{ label\_data}\SpecialCharTok{$}\NormalTok{angle, }
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{)}
                      
            \FunctionTok{pdf}\NormalTok{(}\StringTok{"test.pdf"}\NormalTok{)}
\NormalTok{            p}
            \FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-create_mcnebula.r}{%
\section{File: create\_mcnebula.R}\label{file-create_mcnebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(usethis)}
\FunctionTok{library}\NormalTok{(devtools)}
\FunctionTok{library}\NormalTok{(progress)}
\DocumentationTok{\#\# data reformat}
\FunctionTok{library}\NormalTok{(pbapply)}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(MSnbase)}
\FunctionTok{library}\NormalTok{(igraph)}
\DocumentationTok{\#\# visualize}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(grid)}
\DocumentationTok{\#\# suggest}
\CommentTok{\#library(ChemmineR)}
\FunctionTok{library}\NormalTok{(ChemmineOB)}
\FunctionTok{library}\NormalTok{(rsvg)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{load\_all}\NormalTok{(}\StringTok{"\textasciitilde{}/MCnebula/R"}\NormalTok{)}
\NormalTok{usethis}\SpecialCharTok{::}\FunctionTok{create\_package}\NormalTok{(}\StringTok{"MCnebula"}\NormalTok{)}
\FunctionTok{load\_all}\NormalTok{()}
\FunctionTok{check}\NormalTok{()}
\FunctionTok{use\_mit\_license}\NormalTok{(}\StringTok{"Lichuang Huang"}\NormalTok{)}
\FunctionTok{use\_package}\NormalTok{(}\StringTok{"data.table"}\NormalTok{, }\AttributeTok{type=}\StringTok{"Imports"}\NormalTok{)}
\FunctionTok{use\_package}\NormalTok{(}\StringTok{"dplyr"}\NormalTok{, }\AttributeTok{type=}\StringTok{"Imports"}\NormalTok{)}
\FunctionTok{use\_package}\NormalTok{(}\StringTok{"progress"}\NormalTok{, }\AttributeTok{type=}\StringTok{"Imports"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-exact_mass.r}{%
\section{File: exact\_mass.R}\label{file-exact_mass.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{isotopic\_mass }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"H"}\OtherTok{=}\FloatTok{1.007825}\NormalTok{,}
                   \StringTok{"C"}\OtherTok{=}\FloatTok{12.0}\NormalTok{,}
                   \StringTok{"N"}\OtherTok{=}\FloatTok{14.003074}\NormalTok{,}
                   \StringTok{"O"}\OtherTok{=}\FloatTok{15.994915}\NormalTok{,}
                   \StringTok{"F"}\OtherTok{=}\FloatTok{18.000938}\NormalTok{,}
                   \StringTok{"P"}\OtherTok{=}\FloatTok{30.973762}\NormalTok{,}
                   \StringTok{"S"}\OtherTok{=}\FloatTok{31.972071}\NormalTok{)}
\NormalTok{exact\_mass }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(formula, }\AttributeTok{db=}\NormalTok{isotopic\_mass)\{}
\NormalTok{  vector }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(formula, }\AttributeTok{split=}\StringTok{""}\NormalTok{))}
\NormalTok{  mass}\OtherTok{=}\DecValTok{0}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(vector))\{}
    \ControlFlowTok{if}\NormalTok{(vector[i] }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(db))\{}
      \ControlFlowTok{if}\NormalTok{(i }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(vector))\{}
\NormalTok{        mass }\OtherTok{=}\NormalTok{ mass }\SpecialCharTok{+}\NormalTok{ db[[vector[i]]]}
        \FunctionTok{return}\NormalTok{(mass)}
\NormalTok{      \}}
      \FunctionTok{options}\NormalTok{ (}\AttributeTok{warn =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{      test }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(vector[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{])}
      \FunctionTok{options}\NormalTok{ (}\AttributeTok{warn =} \DecValTok{1}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(test) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{        mass }\OtherTok{=}\NormalTok{ mass }\SpecialCharTok{+}\NormalTok{ db[[vector[i]]]}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        mass }\OtherTok{=}\NormalTok{ mass }\SpecialCharTok{+}\NormalTok{ db[[vector[i]]] }\SpecialCharTok{*}\NormalTok{ test}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \ControlFlowTok{next}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(mass)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-auto_classy.r}{%
\section{File: auto\_classy.R}\label{file-auto_classy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{auto\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# classyfireR}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(df, }\StringTok{".id"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, base\_auto\_classy,}
\NormalTok{                        ...)}
\NormalTok{  \}}
\NormalTok{base\_auto\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df}
\NormalTok{           )\{}
\NormalTok{    .id }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{,][[}\StringTok{".id"}\NormalTok{]]}
    \FunctionTok{lapply}\NormalTok{(df[[}\StringTok{"InChIKey"}\NormalTok{]], base2\_classy,}
                      \AttributeTok{.id =}\NormalTok{ .id)}
\NormalTok{  \}}
\NormalTok{base2\_classy }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchi,}
\NormalTok{           .id}
\NormalTok{           )\{}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.id)), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(ch) }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{get\_classification}\NormalTok{(inchi)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(ch))\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{classification}\NormalTok{(ch)}
      \FunctionTok{write\_tsv}\NormalTok{(ch, }\FunctionTok{paste0}\NormalTok{(.id))}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-by_group_as_list.r}{%
\section{File: by\_group\_as\_list.R}\label{file-by_group_as_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{by\_group\_as\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           colnames}
\NormalTok{           )\{}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(df[[colnames]])}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(vector, by\_group\_as\_list\_select,}
                   \AttributeTok{colNames =}\NormalTok{ colnames)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ vector}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{by\_group\_as\_list\_select }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           KEY,}
           \AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{)),}
\NormalTok{           colNames}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[colNames]] }\SpecialCharTok{==}\NormalTok{ KEY), ]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_structure_table.r}{%
\section{File: collate\_structure\_table.R}\label{file-collate_structure_table.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{collate\_structure\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{file =} \StringTok{"method\_pick\_formula\_excellent.structure.tsv"}\NormalTok{,}
           \AttributeTok{class =} \StringTok{"../canopus\_summary.tsv"}\NormalTok{,}
           \AttributeTok{cut\_tanimoto =} \FloatTok{0.4}\NormalTok{,}
           \AttributeTok{delete\_null =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    order }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{,}
              \StringTok{"most specific class"}\NormalTok{, }\StringTok{"inchikey2D"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(file)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ cut\_tanimoto) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name, tanimotoSimilarity, molecularFormula, inchikey2D) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{as.character}\NormalTok{(.id))}
\NormalTok{    class }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(class) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(name, }\StringTok{\textasciigrave{}}\AttributeTok{most specific class}\StringTok{\textasciigrave{}}\NormalTok{, adduct) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(name, }\StringTok{"(?\textless{}=\_)[0{-}9]\{1,4\}$"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, }\StringTok{\textasciigrave{}}\AttributeTok{most specific class}\StringTok{\textasciigrave{}}\NormalTok{, adduct)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, class, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{all\_of}\NormalTok{(order)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(name, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(delete\_null }\SpecialCharTok{==}\NormalTok{ T)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, name }\SpecialCharTok{!=} \StringTok{"null"}\NormalTok{)}
    \FunctionTok{write\_tsv}\NormalTok{(df, }\StringTok{"table\_of\_pdf.tsv"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-deal_with_msp_record.r}{%
\section{File: deal\_with\_msp\_record.R}\label{file-deal_with_msp_record.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{deal\_with\_msp\_record }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           string,}
\NormalTok{           id\_prefix,}
\NormalTok{           cache,}
\NormalTok{           store,}
           \AttributeTok{id =} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache),}
           \AttributeTok{input =} \FunctionTok{c}\NormalTok{(}\AttributeTok{name =} \StringTok{"NAME"}\NormalTok{,}
                     \AttributeTok{mass =} \StringTok{"PRECURSORMZ"}\NormalTok{,}
                     \AttributeTok{adduct =} \StringTok{"PRECURSORTYPE"}\NormalTok{,}
                     \AttributeTok{rt =} \StringTok{"RETENTIONTIME"}\NormalTok{),}
           \AttributeTok{other =} \FunctionTok{c}\NormalTok{(}\StringTok{"NAME"}\NormalTok{, }\StringTok{"PRECURSORMZ"}\NormalTok{, }\StringTok{"PRECURSORTYPE"}\NormalTok{,}
                     \StringTok{"FORMULA"}\NormalTok{, }\StringTok{"Ontology"}\NormalTok{, }\StringTok{"INCHIKEY"}\NormalTok{, }\StringTok{"SMILES"}\NormalTok{,}
                     \StringTok{"RETENTIONTIME"}\NormalTok{, }\StringTok{"CCS"}\NormalTok{, }\StringTok{"IONMODE"}\NormalTok{,}
                     \StringTok{"INSTRUMENTTYPE"}\NormalTok{,}\StringTok{"INSTRUMENT"}\NormalTok{,}
                     \StringTok{"COLLISIONENERGY"}\NormalTok{, }\StringTok{"Comment"}\NormalTok{, }\StringTok{"Num Peaks"}\NormalTok{),}
           \AttributeTok{output =} \FunctionTok{c}\NormalTok{(}\AttributeTok{begin =} \StringTok{"BEGIN IONS"}\NormalTok{,}
                     \AttributeTok{id =} \StringTok{"FEATURE\_ID="}\NormalTok{,}
                     \AttributeTok{mass =} \StringTok{"PEPMASS="}\NormalTok{,}
                     \AttributeTok{charge =} \StringTok{"CHARGE="}\NormalTok{,}
                     \AttributeTok{rt =} \StringTok{"RTINSECONDS="}\NormalTok{,}
                     \AttributeTok{level =} \StringTok{"MSLEVEL="}\NormalTok{,}
                     \AttributeTok{end =} \StringTok{"END IONS"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get name and value}
\NormalTok{    name }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string)}
\NormalTok{    name }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(name) }\SpecialCharTok{==}\NormalTok{ T, }\StringTok{""}\NormalTok{, name)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[A{-}Z]"}\NormalTok{, name) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      value }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    cat }\OtherTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"name"}\NormalTok{]])\{}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# id update}
\NormalTok{      id }\OtherTok{=}\NormalTok{ id }\SpecialCharTok{+} \DecValTok{1}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, id, }\AttributeTok{envir =}\NormalTok{ cache)}
      \DocumentationTok{\#\# output}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"id"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(id\_prefix, id)}
      \DocumentationTok{\#\# new var in envir: store}
\NormalTok{      info }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ s, }\AttributeTok{name =}\NormalTok{ value)}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"mass"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"mass"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=}\NormalTok{ value}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"adduct"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"charge"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}|]+"}\NormalTok{, value) }\SpecialCharTok{==}\NormalTok{ F, }\StringTok{"0"}\NormalTok{,}
                 \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}"}\NormalTok{, value), }\StringTok{"{-}1"}\NormalTok{, }\StringTok{"+1"}\NormalTok{))}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[}\StringTok{"charge"}\NormalTok{]] }\OtherTok{=}\NormalTok{ s}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"rt"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"rt"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=}\NormalTok{ value}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==} \StringTok{"Num Peaks"}\NormalTok{)\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{0}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"end"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# begin mass level 2}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"id"}\NormalTok{]], info[[}\StringTok{".id"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"mass"}\NormalTok{]], info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"charge"}\NormalTok{]], info[[}\StringTok{"charge"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"rt"}\NormalTok{]], info[[}\StringTok{"RETENTIONTIME"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[0{-}9]"}\NormalTok{, string))\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{2}
\NormalTok{      p }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{      s }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(string }\SpecialCharTok{==} \StringTok{""}\NormalTok{)\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"end"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# data store}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{\%in\%}\NormalTok{ other }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[name]] }\OtherTok{=}\NormalTok{ value}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# output}
\NormalTok{  \}}
\NormalTok{catapp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           ...,}
           \AttributeTok{sep =} \StringTok{""}\NormalTok{,}
           \AttributeTok{mgf =} \FunctionTok{get}\NormalTok{(}\StringTok{"mgf"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste}\NormalTok{(..., }\AttributeTok{sep =}\NormalTok{ sep), }\AttributeTok{file =}\NormalTok{ mgf, }\AttributeTok{append =}\NormalTok{ T)}
\NormalTok{  \}}
\NormalTok{get\_value }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           string,}
           \AttributeTok{sep =} \StringTok{": "}
\NormalTok{           )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{2}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{get\_name }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           string,}
           \AttributeTok{sep =} \StringTok{": "}
\NormalTok{           )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{1}\NormalTok{])}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-inchi_curl.r}{%
\section{File: inchi\_curl.R}\label{file-inchi_curl.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key,}
\NormalTok{           .id,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
           \AttributeTok{save =} \FunctionTok{paste0}\NormalTok{(.id, }\StringTok{".csv"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    http }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/"}\NormalTok{, type, }\StringTok{"/"}\NormalTok{)}
\NormalTok{    http\_end }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/property/"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(get, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"/CSV \textgreater{} "}\NormalTok{)}
\NormalTok{    curl }\OtherTok{\textless{}{-}} \StringTok{"curl {-}s {-}{-}connect{-}timeout 20 {-}{-}retry 100 {-}{-}retry{-}delay 30 "}
\NormalTok{    curl\_http }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(curl, http)}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(curl\_http, key, http\_end, save))}
\NormalTok{  \}}
\NormalTok{int\_inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           seq,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    init }\OtherTok{\textless{}{-}}\NormalTok{ dload[seq, }\StringTok{"init"}\NormalTok{]}
\NormalTok{    .id }\OtherTok{\textless{}{-}}\NormalTok{ dload[seq, }\StringTok{".id"}\NormalTok{]}
\NormalTok{    save }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.id, }\StringTok{".csv"}\NormalTok{)}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{class}\NormalTok{(}\FunctionTok{try}\NormalTok{(}\FunctionTok{read.csv}\NormalTok{(save), }\AttributeTok{silent =}\NormalTok{ T))[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{inchi\_curl}\NormalTok{(init, .id, }
                 \AttributeTok{get =}\NormalTok{ get,}
                 \AttributeTok{type =}\NormalTok{ type,}
\NormalTok{                 ...)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-list_merge_df.r}{%
\section{File: list\_merge\_df.R}\label{file-list_merge_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{list\_merge\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
\NormalTok{           df,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, merge,}
                   \AttributeTok{y =} \FunctionTok{get}\NormalTok{(}\StringTok{"df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{)),}
\NormalTok{                   ...)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-msp_to_mgf.r}{%
\section{File: msp\_to\_mgf.R}\label{file-msp_to_mgf.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{msp\_to\_mgf }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           name,}
\NormalTok{           id\_prefix,}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/Downloads/msp"}\NormalTok{,}
           \AttributeTok{write\_meta\_data =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".meta.tsv"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    msp }\OtherTok{\textless{}{-}} \FunctionTok{read\_msp}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name))}
\NormalTok{    cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{    store }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{    mgf }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".mgf"}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{file =}\NormalTok{ mgf)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(msp[[}\DecValTok{1}\NormalTok{]], deal\_with\_msp\_record, }
                      \AttributeTok{id\_prefix =}\NormalTok{ id\_prefix,}
                      \AttributeTok{cache =}\NormalTok{ cache,}
                      \AttributeTok{store =}\NormalTok{ store)}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(set, get\_envir\_df,}
                                   \AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(meta\_data)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(write\_meta\_data) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{write\_tsv}\NormalTok{(meta\_data, write\_meta\_data)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(meta\_data)}
\NormalTok{  \}}
\NormalTok{read\_msp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           filepath}
\NormalTok{           )\{}
\NormalTok{    msp }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(filepath, }\AttributeTok{sep =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F)}
\NormalTok{  \}}
\NormalTok{get\_envir\_df }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           var,}
\NormalTok{           envir}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(var, }\AttributeTok{envir =}\NormalTok{ envir)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pretty_table.r}{%
\section{File: pretty\_table.R}\label{file-pretty_table.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pretty\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{title =} \StringTok{"compounds summary"}\NormalTok{,}
           \AttributeTok{subtitle =} \StringTok{"LC{-}MS"}\NormalTok{,}
           \AttributeTok{footnote =} \StringTok{"Compounds summary"}\NormalTok{,}
           \AttributeTok{filename =} \StringTok{"tmp.html"}\NormalTok{,}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{return\_gt =}\NormalTok{ T,}
           \AttributeTok{font =} \StringTok{"Times"}\NormalTok{,}
           \AttributeTok{shorter\_name =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    title }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title), }\StringTok{"**"}\NormalTok{)}
\NormalTok{    subtitle }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(subtitle), }\StringTok{"**"}\NormalTok{)}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df))}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{gt}\NormalTok{(df) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{opt\_table\_font}\NormalTok{(}\AttributeTok{font=}\FunctionTok{list}\NormalTok{(font)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_header}\NormalTok{(}\AttributeTok{title =} \FunctionTok{md}\NormalTok{(title),}
                 \AttributeTok{subtitle =} \FunctionTok{md}\NormalTok{(subtitle)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{opt\_align\_table\_header}\NormalTok{(}\AttributeTok{align =} \StringTok{"left"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_footnote}\NormalTok{(}\AttributeTok{footnote =}\NormalTok{ footnote,}
                   \AttributeTok{locations =} \FunctionTok{cells\_title}\NormalTok{(}\AttributeTok{groups =} \FunctionTok{c}\NormalTok{(}\StringTok{"title"}\NormalTok{))) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{opt\_table\_lines}\NormalTok{(}\AttributeTok{extent =} \FunctionTok{c}\NormalTok{(}\StringTok{"none"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{cols\_align}\NormalTok{(}\AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
                 \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_style}\NormalTok{(}\AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}\AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"top"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
                                     \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
                                     \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
                                     \AttributeTok{style =} \StringTok{"solid"}\NormalTok{),}
                \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{()) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_style}\NormalTok{(}\AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
                \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{everything}\NormalTok{())) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_style}\NormalTok{(}\AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}\AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottom"}\NormalTok{),}
                                     \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
                                     \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
                                     \AttributeTok{style =} \StringTok{"solid"}\NormalTok{),}
                \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}\AttributeTok{columns=}\FunctionTok{everything}\NormalTok{(),}
                                       \AttributeTok{rows=}\FunctionTok{nrow}\NormalTok{(df))) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{tab\_style}\NormalTok{(}\AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
                \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()))}
    \ControlFlowTok{if}\NormalTok{(shorter\_name }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      t }\OtherTok{\textless{}{-}}\NormalTok{ t }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{cols\_width}\NormalTok{(Name }\SpecialCharTok{\textasciitilde{}} \FunctionTok{px}\NormalTok{(}\DecValTok{300}\NormalTok{))}
\NormalTok{    \}}
    \FunctionTok{gtsave}\NormalTok{(t, filename, path)}
    \ControlFlowTok{if}\NormalTok{(return\_gt }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(t)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-read_tsv.r}{%
\section{File: read\_tsv.R}\label{file-read_tsv.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_tsv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input=}\NormalTok{path, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{quote=}\StringTok{""}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F)}
  \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}
\NormalTok{write\_tsv }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, filename)\{}
    \FunctionTok{write.table}\NormalTok{(x, }\AttributeTok{file =}\NormalTok{ filename, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-select_app.r}{%
\section{File: select\_app.R}\label{file-select_app.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{select\_app }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           col}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, }\FunctionTok{all\_of}\NormalTok{(col))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-show_chem.r}{%
\section{File: show\_chem.R}\label{file-show_chem.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# a function to fast show df}
\NormalTok{show\_meta }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{df =}\NormalTok{ meta}
\NormalTok{           )\{}
\NormalTok{    prefix }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(df[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{"\^{}[a{-}z]\{1,100\}(?=[0{-}9])"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, .id }\SpecialCharTok{==} \FunctionTok{paste0}\NormalTok{(prefix, x)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{getk }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{col =} \StringTok{"INCHIKEY"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{show\_meta}\NormalTok{(x)}
    \FunctionTok{return}\NormalTok{(df[[col]])}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{show\_stru }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{key =} \FunctionTok{c}\NormalTok{(}\StringTok{"smiles"}\NormalTok{, }\StringTok{"SMILES"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    key }\OtherTok{\textless{}{-}}\NormalTok{ key[key }\SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(df)][}\DecValTok{1}\NormalTok{]}
\NormalTok{    smiles }\OtherTok{\textless{}{-}}\NormalTok{ df[[key]]}
    \FunctionTok{molconvert\_structure}\NormalTok{(smiles)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{auto }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           id}
\NormalTok{           )\{}
\NormalTok{    id }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(id))}
    \FunctionTok{show\_meta}\NormalTok{(id) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{show\_stru}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-vis_via_molconvert_nebulae.r}{%
\section{File: vis\_via\_molconvert\_nebulae.R}\label{file-vis_via_molconvert_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vis\_via\_molconvert\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}
\NormalTok{    stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.structure\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{vis\_via\_molconvert}\NormalTok{(stru}\SpecialCharTok{$}\NormalTok{smiles, stru}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{vis\_via\_molconvert }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(output) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results))}
      \FunctionTok{dir.create}\NormalTok{(output)}
\NormalTok{    \}}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(molconvert\_structure,}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{output =}\NormalTok{ output)}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{molconvert\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles,}
           \AttributeTok{id =} \StringTok{"tmp"}\NormalTok{,}
           \AttributeTok{output =} \StringTok{"."} 
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{=} \FunctionTok{tempfile}\NormalTok{()}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"molconvert mol }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, smiles, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ {-}o "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"obabel "}\NormalTok{, file, }\StringTok{" {-}imol {-}osvg {-}O "}\NormalTok{, file, }\StringTok{" \textgreater{} /dev/null 2\textgreater{}\&1"}\NormalTok{))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"sed {-}i }\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{s/white/transparent/g}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{ "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cairosvg {-}f svg "}\NormalTok{, file, }\StringTok{" {-}o "}\NormalTok{, output, }\StringTok{"/"}\NormalTok{, id, }\StringTok{".svg"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-fecal_neg.r}{%
\section{File: fecal\_neg.R}\label{file-fecal_neg.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}

\NormalTok{path}\OtherTok{=}\StringTok{"\textasciitilde{}/operation/re\_fecal\_neg"}
\FunctionTok{setwd}\NormalTok{(path)}
\NormalTok{mzmine }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fecal\_neg\_mzmine.csv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{","}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
\CommentTok{\#filter the blank}
\NormalTok{mzmine }\OtherTok{\textless{}{-}}\NormalTok{ mzmine[,}\SpecialCharTok{!}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(mzmine) }\SpecialCharTok{\%in\%} \FunctionTok{grep}\NormalTok{(}\StringTok{"Blank"}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(mzmine)))]}
\NormalTok{metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"metadata.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data\_area }\OtherTok{\textless{}{-}}\NormalTok{ mzmine[, }\FunctionTok{grep}\NormalTok{(}\StringTok{"ID|m/z|retention|area"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(mzmine))]}
\FunctionTok{rownames}\NormalTok{(data\_area) }\OtherTok{\textless{}{-}}\NormalTok{ data\_area}\SpecialCharTok{$}\StringTok{"row ID"}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
              \FunctionTok{t}\NormalTok{(}
\NormalTok{            data\_area[,}\FunctionTok{grep}\NormalTok{(}\StringTok{"area"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(data\_area))]}
\NormalTok{              )}
\NormalTok{)}
\NormalTok{df\_area}\SpecialCharTok{$}\NormalTok{file }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(df\_area)}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(df\_area, }\AttributeTok{col=}\StringTok{"file"}\NormalTok{, }\AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"peak"}\NormalTok{, }\StringTok{"area"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{" "}\NormalTok{)}
\CommentTok{\# df\_area[1:10,(ncol(df\_area){-}5):ncol(df\_area)]}
\NormalTok{df\_area }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df\_area) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"peak"}\NormalTok{, }\StringTok{"area"}\NormalTok{))]}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df\_area, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"file"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"file"}\NormalTok{)}
\CommentTok{\# finish reformat}
\CommentTok{\# compare group as follow}
\NormalTok{element1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"pro"}\NormalTok{, }\StringTok{"raw"}\NormalTok{, }\StringTok{"model"}\NormalTok{, }\StringTok{"control"}\NormalTok{)}
\NormalTok{element2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\StringTok{"medium"}\NormalTok{, }\StringTok{"low"}\NormalTok{, }\StringTok{"multi"}\NormalTok{)}
\NormalTok{c\_group }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{"model"}\NormalTok{, }\DecValTok{3}\NormalTok{), }\StringTok{"pro"}\NormalTok{, }\StringTok{"multi"}\NormalTok{), }\FunctionTok{c}\NormalTok{(element1[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)], }\StringTok{"raw"}\NormalTok{, }\StringTok{"multi"}\NormalTok{))}
\FunctionTok{colnames}\NormalTok{(c\_group) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"n1"}\NormalTok{, }\StringTok{"n2"}\NormalTok{)}
\CommentTok{\# compare between multi{-}subgroup}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(c\_group))\{}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ element2)\{}
        \CommentTok{\# grep group}
        \ControlFlowTok{if}\NormalTok{(c\_group[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[}\FunctionTok{grep}\NormalTok{(}\StringTok{"pro|raw|model|control|drug"}\NormalTok{, df\_area}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[}\FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(c\_group[i,}\DecValTok{1}\NormalTok{],}\StringTok{"|"}\NormalTok{,c\_group[i,}\DecValTok{2}\NormalTok{]), df\_area}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}
        \CommentTok{\# grep subgroup}
        \ControlFlowTok{if}\NormalTok{(j}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"model|control|"}\NormalTok{, j), data}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"list\_"}\NormalTok{, i, }\StringTok{"\_"}\NormalTok{, j), data)}
        \CommentTok{\# break the single comparation}
        \ControlFlowTok{if}\NormalTok{(c\_group[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{)\{}
            \ControlFlowTok{break}
\NormalTok{        \}}
\NormalTok{    \}}
\NormalTok{\}}
\CommentTok{\# list all the compare group}
\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"list\_"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))]}
\CommentTok{\# single plot of pca}
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"pca\_plot"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]    }
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
    \CommentTok{\#compute pca matrix}
\NormalTok{  dfd }\OtherTok{\textless{}{-}}\NormalTok{ dfd[, }\FunctionTok{apply}\NormalTok{(dfd, }\DecValTok{2}\NormalTok{, var) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{]}
\NormalTok{    pca }\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(dfd, }\AttributeTok{scale.=}\NormalTok{T)}
\NormalTok{    pca\_anno }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(pca[}\DecValTok{5}\NormalTok{])}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggbiplot}\NormalTok{(pca, }\AttributeTok{obs.scale =} \DecValTok{1}\NormalTok{, }
               \AttributeTok{var.scale =} \DecValTok{1}\NormalTok{, }
               \AttributeTok{groups =}\NormalTok{ dfm}\SpecialCharTok{$}\NormalTok{subgroup, }
               \AttributeTok{ellipse =} \ConstantTok{TRUE}\NormalTok{, }
               \AttributeTok{circle =} \ConstantTok{TRUE}\NormalTok{,}
               \AttributeTok{varname.size=}\DecValTok{0}\NormalTok{, }
               \AttributeTok{var.axes =}\NormalTok{ F) }\SpecialCharTok{+}
        \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{pca\_anno, }
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x.PC1, }\AttributeTok{y=}\NormalTok{x.PC2, }\AttributeTok{label=}\NormalTok{dfm}\SpecialCharTok{$}\NormalTok{name),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }
                  \AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }
                  \AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pca\_plot/"}\NormalTok{, i, }\StringTok{".svg"}\NormalTok{))}
\NormalTok{\}}
\CommentTok{\# pca\_facet}
\NormalTok{origin\_team }\OtherTok{\textless{}{-}}\NormalTok{ team}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%} \StringTok{"list\_3\_high"}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{  dfd }\OtherTok{\textless{}{-}}\NormalTok{ dfd[, }\FunctionTok{apply}\NormalTok{(dfd, }\DecValTok{2}\NormalTok{, var) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{]}
\NormalTok{    pca}\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(dfd, }\AttributeTok{scale.=}\NormalTok{T)}
\NormalTok{    pca\_x}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{x)}
\NormalTok{    pca\_x }\OtherTok{\textless{}{-}}\NormalTok{ pca\_x[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# join the facet group}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{        pca\_x}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        pca\_x}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \StringTok{"multi"}
\NormalTok{    \}}
\NormalTok{    pca\_x}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep }
\NormalTok{    pca\_x }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(pca\_x,dfm)}
    \CommentTok{\# annotate PC value}
\NormalTok{    pca}\OtherTok{=}\FunctionTok{summary}\NormalTok{(pca)}
\NormalTok{    summary}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\FunctionTok{round}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{importance[}\DecValTok{2}\NormalTok{,],}\DecValTok{4}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(summary)}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{annotate }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(summary)}
    \ControlFlowTok{if}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{        summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n,}\DecValTok{2}\NormalTok{])}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \StringTok{"multi"}
\NormalTok{    \}}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ pca\_x}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}}\NormalTok{ summary}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, pca\_x)}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet\_anno, summary)}
\NormalTok{    \}}
\NormalTok{\}}

\NormalTok{PC1 }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"PC1"}\NormalTok{),]}
\NormalTok{PC2 }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"PC2"}\NormalTok{),]}
\NormalTok{PC1}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC1("}\NormalTok{,PC1}\SpecialCharTok{$}\NormalTok{summary}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}
\NormalTok{PC2}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC2("}\NormalTok{,PC2}\SpecialCharTok{$}\NormalTok{summary}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}

\CommentTok{\# calculate the annotate coord}
\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{PC1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{PC2))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\CommentTok{\# set the color}
\NormalTok{colors }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}
  \StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  \StringTok{"drug"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{,}
  \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}
  \StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}
  \StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
  \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}
  \StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}
  \StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data\_facet, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(PC1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(PC2), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }
            \AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }
            \AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }
            \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{)}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}
            \AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }
            \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"PC2"}\NormalTok{, }\AttributeTok{x=}\StringTok{"PC1"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pca\_plot/pca\_facet.svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# opls\_da plot}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ origin\_team }
\NormalTok{escape }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"multi|"}\NormalTok{,}\FunctionTok{which}\NormalTok{(c\_group}\SpecialCharTok{$}\NormalTok{n1}\SpecialCharTok{==}\StringTok{"multi"} \SpecialCharTok{|}\NormalTok{ c\_group}\SpecialCharTok{$}\NormalTok{n2}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)), team)}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%}\NormalTok{ team[}\FunctionTok{c}\NormalTok{(escape)]]}
\CommentTok{\# single plot}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"opls\_plot"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(ropls)}
\FunctionTok{library}\NormalTok{(scales)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    oplsda }\OtherTok{\textless{}{-}} \FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dfd, }\AttributeTok{y =}\NormalTok{ dfm[, }\StringTok{"subgroup"}\NormalTok{], }\AttributeTok{predI =} \DecValTok{1}\NormalTok{, }\AttributeTok{orthoI =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{scoreMN[, }\DecValTok{1}\NormalTok{], oplsda}\SpecialCharTok{@}\NormalTok{orthoScoreMN[, }\DecValTok{1}\NormalTok{])}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"h1"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"o"}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(df)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(df, dfm)}
    \CommentTok{\# join the facet group}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
    \CommentTok{\# x lab and y lab text}
\NormalTok{    x\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{1}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{    y\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Orthogonal T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{2}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(x\_lab, y\_lab)  }
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(summary)}
    \CommentTok{\# join the facet group}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{annotate }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(summary)}
    \CommentTok{\# vip }
\NormalTok{    vip}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{vipVn)}
\NormalTok{    vip}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(vip),vip)}
    \FunctionTok{colnames}\NormalTok{(vip)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"vip"}\NormalTok{)}
    \CommentTok{\# join the facet group}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(i, }\StringTok{"\_"}\NormalTok{, vip}\SpecialCharTok{$}\NormalTok{id)}
    \CommentTok{\# gather the data into facet data.frame}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ df}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}}\NormalTok{ summary}
\NormalTok{        data\_vip }\OtherTok{\textless{}{-}}\NormalTok{ vip}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, df)}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet\_anno, summary)}
\NormalTok{        data\_vip }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_vip, vip)}
\NormalTok{    \}}
    \CommentTok{\# ggplot plot the single plot}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1)) }\SpecialCharTok{+}
        \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{,}
               \FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
        \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1, }\AttributeTok{label=}\NormalTok{name),}
                 \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }
                 \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{,}
                 \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{,}
                 \AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                 \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                 \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\NormalTok{x\_lab,}\AttributeTok{y=}\NormalTok{y\_lab,}\AttributeTok{title=}\StringTok{"OPLS{-}DA"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
              \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"opls\_plot/"}\NormalTok{, i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{height=}\DecValTok{6}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# opls facet plot }
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet[}\FunctionTok{which}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{facet\_col}\SpecialCharTok{!=}\StringTok{"model\_control"}\NormalTok{),]}
\NormalTok{df\_anno }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{facet\_col}\SpecialCharTok{!=}\StringTok{"model\_control"}\NormalTok{),] }
\NormalTok{df\_xlab }\OtherTok{\textless{}{-}}\NormalTok{ df\_anno[}\FunctionTok{which}\NormalTok{(df\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"x\_lab"}\NormalTok{),]}
\NormalTok{df\_ylab }\OtherTok{\textless{}{-}}\NormalTok{ df\_anno[}\FunctionTok{which}\NormalTok{(df\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"y\_lab"}\NormalTok{),]}
\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{h1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{o1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{colors }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}
  \StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  \StringTok{"drug"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{,}
  \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}
  \StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}
  \StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
  \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}
  \StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}
  \StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(h1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(o1), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+} 
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{df\_xlab, }
             \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{summary),}
         \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }
         \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{df\_ylab, }
             \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{)}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{summary),}
         \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{,}
         \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"Orthogonal T score[1]"}\NormalTok{, }\AttributeTok{x=}\StringTok{"T score[1]"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"opls\_plot/opls\_facet.svg"}\NormalTok{,}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# volcano\_plot}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ origin\_team}
\NormalTok{escape }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"multi|"}\NormalTok{,}\FunctionTok{which}\NormalTok{(c\_group}\SpecialCharTok{$}\NormalTok{n1}\SpecialCharTok{==}\StringTok{"multi"} \SpecialCharTok{|}\NormalTok{ c\_group}\SpecialCharTok{$}\NormalTok{n2}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)), team)}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%}\NormalTok{ team[}\FunctionTok{c}\NormalTok{(escape)]]}
\CommentTok{\# single plot}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"volcano"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    compare }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group)}
\NormalTok{    xn }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{==}\NormalTok{compare[}\DecValTok{1}\NormalTok{])}
\NormalTok{    yn }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{==}\NormalTok{compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    fc\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"\_d\_"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \FunctionTok{colnames}\NormalTok{(dfd))\{}
        \CommentTok{\# t.test calculate p.value}
\NormalTok{        x }\OtherTok{\textless{}{-}}\NormalTok{ dfd[}\FunctionTok{c}\NormalTok{(xn), }\FunctionTok{colnames}\NormalTok{(dfd) }\SpecialCharTok{\%in\%}\NormalTok{ j]}
\NormalTok{        y }\OtherTok{\textless{}{-}}\NormalTok{ dfd[}\FunctionTok{c}\NormalTok{(yn), }\FunctionTok{colnames}\NormalTok{(dfd) }\SpecialCharTok{\%in\%}\NormalTok{ j]}
\NormalTok{        stat}\OtherTok{=}\FunctionTok{t.test}\NormalTok{(x, y, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F)}\SpecialCharTok{$}\NormalTok{p.value}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"p.value\_"}\NormalTok{, j), stat)}
        \CommentTok{\# mean and fc}
\NormalTok{        fc}\OtherTok{=}\FunctionTok{mean}\NormalTok{(x)}\SpecialCharTok{/}\FunctionTok{mean}\NormalTok{(y)}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"fc\_"}\NormalTok{, j), fc)}
\NormalTok{    \}}
    \CommentTok{\# gather the fc list}
\NormalTok{    fc\_list }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"fc\_X"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))]}
\NormalTok{    fc }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(fc\_list)}
\NormalTok{    fc}\SpecialCharTok{$}\NormalTok{fc }\OtherTok{\textless{}{-}} \ConstantTok{NA}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(fc))\{}
\NormalTok{        fc}\SpecialCharTok{$}\NormalTok{fc[k] }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(fc}\SpecialCharTok{$}\NormalTok{fc\_list[k])}
\NormalTok{    \}}
\NormalTok{    fc }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(fc, }\AttributeTok{col=}\StringTok{"fc\_list"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"fc\_"}\NormalTok{, }
               \AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"m"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T)[, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# gather the p.value list}
\NormalTok{    p.value\_list }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"p.value\_X"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))] }
\NormalTok{    p.value }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(p.value\_list)}
\NormalTok{    p.value}\SpecialCharTok{$}\NormalTok{p.value }\OtherTok{\textless{}{-}} \ConstantTok{NA}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(p.value))\{}
\NormalTok{        p.value}\SpecialCharTok{$}\NormalTok{p.value[k] }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(p.value}\SpecialCharTok{$}\NormalTok{p.value\_list[k])}
\NormalTok{    \}}
\NormalTok{    p.value }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(p.value, }\AttributeTok{col=}\StringTok{"p.value\_list"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"p.value\_"}\NormalTok{, }
                \AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"m"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T)[, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# merge}
\NormalTok{    fc\_p }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(fc, p.value, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{fc }\OtherTok{\textless{}{-}} \FunctionTok{log2}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc)}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{change }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{p.value }\SpecialCharTok{\textless{}} \FloatTok{0.05} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}
                      \FunctionTok{ifelse}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{),}\StringTok{"stable"}\NormalTok{),}
                      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{,}\StringTok{"stable"}\NormalTok{))}
    \CommentTok{\#plot volcano}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ fc\_p}
\NormalTok{    title }\OtherTok{\textless{}{-}}  \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"/"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fc, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+} 
        \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+} 
        \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}
                          \StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}
                          \StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
        \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{), }\AttributeTok{linetype=}\DecValTok{4}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{linetype=}\DecValTok{4}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(FC)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"{-}log10(p{-}value)"}\NormalTok{, }\AttributeTok{title=}\NormalTok{title) }\SpecialCharTok{+} 
        \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{substring}\NormalTok{(id, }\DecValTok{2}\NormalTok{)),}
                \AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
                \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
                \CommentTok{\#plot.margin = unit(c(3, 1, 3, 1), "cm")}
                \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"volcano/"}\NormalTok{, i, }\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

    \CommentTok{\# for facet plot}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"/"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(i, }\StringTok{"\_"}\NormalTok{, fc\_p}\SpecialCharTok{$}\NormalTok{id)}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ fc\_p}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, fc\_p)}
\NormalTok{    \}}
\NormalTok{\}}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet[}\SpecialCharTok{!}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data\_facet) }\SpecialCharTok{\%in\%} \FunctionTok{grep}\NormalTok{(}\StringTok{"control"}\NormalTok{, data\_facet}\SpecialCharTok{$}\NormalTok{facet\_col)),]}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fc, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}
                      \StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}
                      \StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(FC)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"{-}log10(p{-}value)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{substring}\NormalTok{(id, }\DecValTok{2}\NormalTok{)),}
            \AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
          \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col)}
\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"volcano/volcano\_facet.svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# plot vip{-}p plot}
\CommentTok{\# merge the vip dataset and p.value dataset}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"vip"}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, data\_vip, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"team"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p.value, }\AttributeTok{y=}\NormalTok{vip, }\AttributeTok{color=}\NormalTok{fc)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_gradientn(limits = c({-}5, +5), }
    \CommentTok{\#             breaks = c({-}3, 0, +3), }
    \CommentTok{\#             colours = c("\#E6550DFF", "\#79AF97FF", "\#3182BDFF")) +}
    \FunctionTok{scale\_color\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"VIP"}\NormalTok{, }\AttributeTok{x=}\StringTok{"p{-}value"}\NormalTok{, }\AttributeTok{color=}\StringTok{"log2(FC)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{1}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FloatTok{0.05}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row.x }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col.x) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}
          \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{), }
          \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"vip/vip\_p\_facet.svg"}\NormalTok{)}
\CommentTok{\# filter the data according to vip, p.value, fc}
\CommentTok{\# FDR revise}
\FunctionTok{library}\NormalTok{(fdrtool)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{p.value)}\SpecialCharTok{==}\NormalTok{F),] }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{id=}\FunctionTok{substring}\NormalTok{(id.x, }\DecValTok{2}\NormalTok{))}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{q.value }\OtherTok{\textless{}{-}} \FunctionTok{fdrtool}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{p.value, }\AttributeTok{statistic=}\StringTok{\textquotesingle{}pvalue\textquotesingle{}}\NormalTok{, }\AttributeTok{plot=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{qval}
\FunctionTok{write.table}\NormalTok{(df, }\AttributeTok{file=}\StringTok{"discrepancy\_raw.tsv"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\CommentTok{\# p.value filter}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fc}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{vip}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{),]}
\NormalTok{data\_u }\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id.x),] }
\FunctionTok{write.table}\NormalTok{(data\_u, }\AttributeTok{file=}\StringTok{"discrepancy\_fc1\_vip1\_p005.tsv"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\CommentTok{\# get sirius idenfication results}
\NormalTok{stru\_path}\OtherTok{=}\StringTok{"0070\_results/"}
\NormalTok{structure }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(stru\_path, }\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{), }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\CommentTok{\# merge the structure according to qdata}
\NormalTok{data1 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data\_u, structure, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\FunctionTok{write.table}\NormalTok{(data1, }\AttributeTok{file=}\StringTok{"discrepancy\_pdata\_structure.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}

\CommentTok{\# q.value filter}
\NormalTok{qdata }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fc}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{vip}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{q.value}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{),]}
\NormalTok{qdata\_u }\OtherTok{\textless{}{-}}\NormalTok{ qdata[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(qdata}\SpecialCharTok{$}\NormalTok{id.x),]}
\CommentTok{\# merge the structure according to qdata}
\NormalTok{data0 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(qdata\_u, structure, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\FunctionTok{write.table}\NormalTok{(data0, }\AttributeTok{file=}\StringTok{"discrepancy\_qdata\_structure.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}
\CommentTok{\# pathway enrichment analysis}
\FunctionTok{library}\NormalTok{(FELLA)}
\CommentTok{\# data0 \textless{}{-} read.csv(file="discrepancy\_qdata\_structure.tsv", sep="\textbackslash{}t", header=T)}
\CommentTok{\# data1 \textless{}{-} read.csv(file="discrepancy\_pdata\_structure.tsv", sep="\textbackslash{}t", header=T)}
\CommentTok{\# according to q.value}
\NormalTok{qdata\_h }\OtherTok{\textless{}{-}}\NormalTok{ data0[}\FunctionTok{grep}\NormalTok{(}\StringTok{"high"}\NormalTok{,data0}\SpecialCharTok{$}\NormalTok{team), ]}
\NormalTok{qdata\_h\_simi }\OtherTok{\textless{}{-}}\NormalTok{ qdata\_h[}\FunctionTok{which}\NormalTok{(qdata\_h}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{\textgreater{}=}\FloatTok{0.5}\NormalTok{), ]}
\NormalTok{qdata\_h\_simi }\OtherTok{\textless{}{-}}\NormalTok{ qdata\_h\_simi[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(qdata\_h\_simi}\SpecialCharTok{$}\NormalTok{smiles),]}
\CommentTok{\# according to p.value}
\NormalTok{pdata\_h }\OtherTok{\textless{}{-}}\NormalTok{ data1[}\FunctionTok{grep}\NormalTok{(}\StringTok{"high"}\NormalTok{,data1}\SpecialCharTok{$}\NormalTok{team), ]}
\NormalTok{pdata\_h\_simi }\OtherTok{\textless{}{-}}\NormalTok{ pdata\_h[}\FunctionTok{which}\NormalTok{(pdata\_h}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{\textgreater{}=}\FloatTok{0.5}\NormalTok{), ]}
\NormalTok{pdata\_h\_simi }\OtherTok{\textless{}{-}}\NormalTok{ pdata\_h\_simi[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(pdata\_h\_simi}\SpecialCharTok{$}\NormalTok{smiles),]}
\CommentTok{\# this table is summarized by fc, vip, p, dosage of high, idenfication of high tanimoto similarity, and is unique.}
\FunctionTok{write.table}\NormalTok{(pdata\_h\_simi, }\AttributeTok{file=}\StringTok{"p\_cluster\_pathway.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-fecal_pos.r}{%
\section{File: fecal\_pos.R}\label{file-fecal_pos.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}

\NormalTok{path}\OtherTok{=}\StringTok{"\textasciitilde{}/operation/re\_fecal\_pos"}
\FunctionTok{setwd}\NormalTok{(path)}

\NormalTok{mzmine }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fecal\_pos\_mzmine.csv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{","}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
\NormalTok{metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"metadata.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data\_area }\OtherTok{\textless{}{-}}\NormalTok{ mzmine[, }\FunctionTok{grep}\NormalTok{(}\StringTok{"ID|m/z|retention|area"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(mzmine))]}
\FunctionTok{rownames}\NormalTok{(data\_area) }\OtherTok{\textless{}{-}}\NormalTok{ data\_area}\SpecialCharTok{$}\StringTok{"row ID"}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
              \FunctionTok{t}\NormalTok{(}
\NormalTok{            data\_area[,}\FunctionTok{grep}\NormalTok{(}\StringTok{"area"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(data\_area))]}
\NormalTok{              )}
\NormalTok{)}
\NormalTok{df\_area}\SpecialCharTok{$}\NormalTok{file }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(df\_area)}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(df\_area, }\AttributeTok{col=}\StringTok{"file"}\NormalTok{, }\AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"peak"}\NormalTok{, }\StringTok{"area"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{" "}\NormalTok{)}
\CommentTok{\# df\_area[1:10,(ncol(df\_area){-}5):ncol(df\_area)]}
\NormalTok{df\_area }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df\_area) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"peak"}\NormalTok{, }\StringTok{"area"}\NormalTok{))]}
\NormalTok{df\_area }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df\_area, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"file"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"file"}\NormalTok{)}
\CommentTok{\# finish reformat}
\CommentTok{\# compare group as follow}
\NormalTok{element1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"pro"}\NormalTok{, }\StringTok{"raw"}\NormalTok{, }\StringTok{"model"}\NormalTok{, }\StringTok{"control"}\NormalTok{)}
\NormalTok{element2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\StringTok{"medium"}\NormalTok{, }\StringTok{"low"}\NormalTok{, }\StringTok{"multi"}\NormalTok{)}
\NormalTok{c\_group }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{"model"}\NormalTok{, }\DecValTok{3}\NormalTok{), }\StringTok{"pro"}\NormalTok{, }\StringTok{"multi"}\NormalTok{), }\FunctionTok{c}\NormalTok{(element1[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{)], }\StringTok{"raw"}\NormalTok{, }\StringTok{"multi"}\NormalTok{))}
\FunctionTok{colnames}\NormalTok{(c\_group) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"n1"}\NormalTok{, }\StringTok{"n2"}\NormalTok{)}
\CommentTok{\# compare between multi{-}subgroup}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(c\_group))\{}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ element2)\{}
        \CommentTok{\# grep group}
        \ControlFlowTok{if}\NormalTok{(c\_group[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[}\FunctionTok{grep}\NormalTok{(}\StringTok{"pro|raw|model|control|drug"}\NormalTok{, df\_area}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ df\_area[}\FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(c\_group[i,}\DecValTok{1}\NormalTok{],}\StringTok{"|"}\NormalTok{,c\_group[i,}\DecValTok{2}\NormalTok{]), df\_area}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}
        \CommentTok{\# grep subgroup}
        \ControlFlowTok{if}\NormalTok{(j}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{            data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"model|control|"}\NormalTok{, j), data}\SpecialCharTok{$}\NormalTok{subgroup), ]}
\NormalTok{        \}}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"list\_"}\NormalTok{, i, }\StringTok{"\_"}\NormalTok{, j), data)}
        \CommentTok{\# break the single comparation}
        \ControlFlowTok{if}\NormalTok{(c\_group[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{)\{}
            \ControlFlowTok{break}
\NormalTok{        \}}
\NormalTok{    \}}
\NormalTok{\}}
\CommentTok{\# list all the compare group}
\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"list\_"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))]}
\CommentTok{\# single plot of pca}
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"pca\_plot"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]    }
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
    \CommentTok{\#compute pca matrix}
\NormalTok{    pca }\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(dfd, }\AttributeTok{scale. =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    pca\_anno }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(pca[}\DecValTok{5}\NormalTok{])}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggbiplot}\NormalTok{(pca, }\AttributeTok{obs.scale =} \DecValTok{1}\NormalTok{, }
               \AttributeTok{var.scale =} \DecValTok{1}\NormalTok{, }
               \AttributeTok{groups =}\NormalTok{ dfm}\SpecialCharTok{$}\NormalTok{subgroup, }
               \AttributeTok{ellipse =} \ConstantTok{TRUE}\NormalTok{, }
               \AttributeTok{circle =} \ConstantTok{TRUE}\NormalTok{,}
               \AttributeTok{varname.size=}\DecValTok{0}\NormalTok{, }
               \AttributeTok{var.axes =}\NormalTok{ F) }\SpecialCharTok{+}
        \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{pca\_anno, }
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x.PC1, }\AttributeTok{y=}\NormalTok{x.PC2, }\AttributeTok{label=}\NormalTok{dfm}\SpecialCharTok{$}\NormalTok{name),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }
                  \AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }
                  \AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pca\_plot/"}\NormalTok{, i, }\StringTok{".svg"}\NormalTok{))}
\NormalTok{\}}
\CommentTok{\# pca\_facet}
\NormalTok{origin\_team }\OtherTok{\textless{}{-}}\NormalTok{ team}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%} \StringTok{"list\_3\_high"}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    pca}\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(dfd, }\AttributeTok{scale. =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{    pca\_x}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{x)}
\NormalTok{    pca\_x }\OtherTok{\textless{}{-}}\NormalTok{ pca\_x[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# join the facet group}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{        pca\_x}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        pca\_x}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \StringTok{"multi"}
\NormalTok{    \}}
\NormalTok{    pca\_x}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep }
\NormalTok{    pca\_x }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(pca\_x,dfm)}
    \CommentTok{\# annotate PC value}
\NormalTok{    pca}\OtherTok{=}\FunctionTok{summary}\NormalTok{(pca)}
\NormalTok{    summary}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\FunctionTok{round}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{importance[}\DecValTok{2}\NormalTok{,],}\DecValTok{4}\NormalTok{))[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(summary)}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{annotate }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(summary)}
    \ControlFlowTok{if}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"multi"}\NormalTok{)\{}
\NormalTok{        summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n,}\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n,}\DecValTok{2}\NormalTok{])}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \StringTok{"multi"}
\NormalTok{    \}}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ pca\_x}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}}\NormalTok{ summary}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, pca\_x)}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet\_anno, summary)}
\NormalTok{    \}}
\NormalTok{\}}

\NormalTok{PC1 }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"PC1"}\NormalTok{),]}
\NormalTok{PC2 }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"PC2"}\NormalTok{),]}
\NormalTok{PC1}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC1("}\NormalTok{,PC1}\SpecialCharTok{$}\NormalTok{summary}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}
\NormalTok{PC2}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC2("}\NormalTok{,PC2}\SpecialCharTok{$}\NormalTok{summary}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}

\CommentTok{\# calculate the annotate coord}
\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{PC1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{PC2))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\CommentTok{\# set the color}
\NormalTok{colors }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}
  \StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  \StringTok{"drug"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{,}
  \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}
  \StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}
  \StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
  \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}
  \StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}
  \StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data\_facet, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(PC1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(PC2), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }
            \AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }
            \AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }
            \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{)}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}
            \AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }
            \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"PC2"}\NormalTok{, }\AttributeTok{x=}\StringTok{"PC1"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}
\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pca\_plot/pca\_facet.svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# opls\_da plot}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ origin\_team }
\NormalTok{escape }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"multi|"}\NormalTok{,}\FunctionTok{which}\NormalTok{(c\_group}\SpecialCharTok{$}\NormalTok{n1}\SpecialCharTok{==}\StringTok{"multi"} \SpecialCharTok{|}\NormalTok{ c\_group}\SpecialCharTok{$}\NormalTok{n2}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)), team)}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%}\NormalTok{ team[}\FunctionTok{c}\NormalTok{(escape)]]}
\CommentTok{\# single plot}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"opls\_plot"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(ropls)}
\FunctionTok{library}\NormalTok{(scales)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    oplsda }\OtherTok{\textless{}{-}} \FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ dfd, }\AttributeTok{y =}\NormalTok{ dfm[, }\StringTok{"subgroup"}\NormalTok{], }\AttributeTok{predI =} \DecValTok{1}\NormalTok{, }\AttributeTok{orthoI =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{scoreMN[, }\DecValTok{1}\NormalTok{], oplsda}\SpecialCharTok{@}\NormalTok{orthoScoreMN[, }\DecValTok{1}\NormalTok{])}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"h1"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"o"}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(df)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(df, dfm)}
    \CommentTok{\# join the facet group}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
    \CommentTok{\# x lab and y lab text}
\NormalTok{    x\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{1}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{    y\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Orthogonal T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{2}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(x\_lab, y\_lab)  }
\NormalTok{    summary }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(summary)}
    \CommentTok{\# join the facet group}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    summary}\SpecialCharTok{$}\NormalTok{annotate }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(summary)}
    \CommentTok{\# vip }
\NormalTok{    vip}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{vipVn)}
\NormalTok{    vip}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(vip),vip)}
    \FunctionTok{colnames}\NormalTok{(vip)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"vip"}\NormalTok{)}
    \CommentTok{\# join the facet group}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(c\_group[n, }\DecValTok{1}\NormalTok{], }\StringTok{"\_"}\NormalTok{, c\_group[n, }\DecValTok{2}\NormalTok{])}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    vip}\SpecialCharTok{$}\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(i, }\StringTok{"\_"}\NormalTok{, vip}\SpecialCharTok{$}\NormalTok{id)}
    \CommentTok{\# gather the data into facet data.frame}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ df}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}}\NormalTok{ summary}
\NormalTok{        data\_vip }\OtherTok{\textless{}{-}}\NormalTok{ vip}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, df)}
\NormalTok{        data\_facet\_anno }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet\_anno, summary)}
\NormalTok{        data\_vip }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_vip, vip)}
\NormalTok{    \}}
    \CommentTok{\# ggplot plot the single plot}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1)) }\SpecialCharTok{+}
        \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{,}
               \FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
        \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1, }\AttributeTok{label=}\NormalTok{name),}
                 \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }
                 \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{,}
                 \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{,}
                 \AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                 \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                 \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\NormalTok{x\_lab,}\AttributeTok{y=}\NormalTok{y\_lab,}\AttributeTok{title=}\StringTok{"OPLS{-}DA"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}
              \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"opls\_plot/"}\NormalTok{, i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{height=}\DecValTok{6}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{)}
\NormalTok{\}}
\CommentTok{\# opls facet plot }
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet[}\FunctionTok{which}\NormalTok{(data\_facet}\SpecialCharTok{$}\NormalTok{facet\_col}\SpecialCharTok{!=}\StringTok{"model\_control"}\NormalTok{),]}
\NormalTok{df\_anno }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet\_anno[}\FunctionTok{which}\NormalTok{(data\_facet\_anno}\SpecialCharTok{$}\NormalTok{facet\_col}\SpecialCharTok{!=}\StringTok{"model\_control"}\NormalTok{),] }
\NormalTok{df\_xlab }\OtherTok{\textless{}{-}}\NormalTok{ df\_anno[}\FunctionTok{which}\NormalTok{(df\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"x\_lab"}\NormalTok{),]}
\NormalTok{df\_ylab }\OtherTok{\textless{}{-}}\NormalTok{ df\_anno[}\FunctionTok{which}\NormalTok{(df\_anno}\SpecialCharTok{$}\NormalTok{annotate}\SpecialCharTok{==}\StringTok{"y\_lab"}\NormalTok{),]}
\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{h1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{o1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{colors }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}
  \StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  \StringTok{"drug"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{,}
  \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}
  \StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}
  \StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
  \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}
  \StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}
  \StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(h1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(o1), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ colors) }\SpecialCharTok{+} 
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{df\_xlab, }
             \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{summary),}
         \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }
         \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{df\_ylab, }
             \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{)}\SpecialCharTok{*}\FloatTok{1.4}\NormalTok{, }\AttributeTok{label=}\NormalTok{summary),}
         \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{,}
         \AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"Orthogonal T score[1]"}\NormalTok{, }\AttributeTok{x=}\StringTok{"T score[1]"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"opls\_plot/opls\_facet.svg"}\NormalTok{,}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# volcano\_plot}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ origin\_team}
\NormalTok{escape }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"multi|"}\NormalTok{,}\FunctionTok{which}\NormalTok{(c\_group}\SpecialCharTok{$}\NormalTok{n1}\SpecialCharTok{==}\StringTok{"multi"} \SpecialCharTok{|}\NormalTok{ c\_group}\SpecialCharTok{$}\NormalTok{n2}\SpecialCharTok{==}\StringTok{"multi"}\NormalTok{)), team)}
\NormalTok{team }\OtherTok{\textless{}{-}}\NormalTok{ team[}\SpecialCharTok{!}\NormalTok{team }\SpecialCharTok{\%in\%}\NormalTok{ team[}\FunctionTok{c}\NormalTok{(escape)]]}
\CommentTok{\# single plot}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"volcano"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ team)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(i)}
\NormalTok{    dfd }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    dfm }\OtherTok{\textless{}{-}}\NormalTok{ df[, (}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"subgroup"}\NormalTok{, }\StringTok{"group"}\NormalTok{))]}
\NormalTok{    compare }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group)}
\NormalTok{    xn }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{==}\NormalTok{compare[}\DecValTok{1}\NormalTok{])}
\NormalTok{    yn }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(dfm}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{==}\NormalTok{compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    fc\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"\_d\_"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \FunctionTok{colnames}\NormalTok{(dfd))\{}
        \CommentTok{\# t.test calculate p.value}
\NormalTok{        x }\OtherTok{\textless{}{-}}\NormalTok{ dfd[}\FunctionTok{c}\NormalTok{(xn), }\FunctionTok{colnames}\NormalTok{(dfd) }\SpecialCharTok{\%in\%}\NormalTok{ j]}
\NormalTok{        y }\OtherTok{\textless{}{-}}\NormalTok{ dfd[}\FunctionTok{c}\NormalTok{(yn), }\FunctionTok{colnames}\NormalTok{(dfd) }\SpecialCharTok{\%in\%}\NormalTok{ j]}
\NormalTok{        stat}\OtherTok{=}\FunctionTok{t.test}\NormalTok{(x, y, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F)}\SpecialCharTok{$}\NormalTok{p.value}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"p.value\_"}\NormalTok{, j), stat)}
        \CommentTok{\# mean and fc}
\NormalTok{        fc}\OtherTok{=}\FunctionTok{mean}\NormalTok{(x)}\SpecialCharTok{/}\FunctionTok{mean}\NormalTok{(y)}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"fc\_"}\NormalTok{, j), fc)}
\NormalTok{    \}}
    \CommentTok{\# gather the fc list}
\NormalTok{    fc\_list }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"fc\_X"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))]}
\NormalTok{    fc }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(fc\_list)}
\NormalTok{    fc}\SpecialCharTok{$}\NormalTok{fc }\OtherTok{\textless{}{-}} \ConstantTok{NA}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(fc))\{}
\NormalTok{        fc}\SpecialCharTok{$}\NormalTok{fc[k] }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(fc}\SpecialCharTok{$}\NormalTok{fc\_list[k])}
\NormalTok{    \}}
\NormalTok{    fc }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(fc, }\AttributeTok{col=}\StringTok{"fc\_list"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"fc\_"}\NormalTok{, }
               \AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"m"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T)[, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# gather the p.value list}
\NormalTok{    p.value\_list }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{()[}\FunctionTok{c}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"p.value\_X"}\NormalTok{, }\FunctionTok{ls}\NormalTok{()))] }
\NormalTok{    p.value }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(p.value\_list)}
\NormalTok{    p.value}\SpecialCharTok{$}\NormalTok{p.value }\OtherTok{\textless{}{-}} \ConstantTok{NA}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(p.value))\{}
\NormalTok{        p.value}\SpecialCharTok{$}\NormalTok{p.value[k] }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(p.value}\SpecialCharTok{$}\NormalTok{p.value\_list[k])}
\NormalTok{    \}}
\NormalTok{    p.value }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(p.value, }\AttributeTok{col=}\StringTok{"p.value\_list"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"p.value\_"}\NormalTok{, }
                \AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"m"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{remove=}\NormalTok{T)[, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
    \CommentTok{\# merge}
\NormalTok{    fc\_p }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(fc, p.value, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{fc }\OtherTok{\textless{}{-}} \FunctionTok{log2}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc)}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{change }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{p.value }\SpecialCharTok{\textless{}} \FloatTok{0.05} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}
                      \FunctionTok{ifelse}\NormalTok{(fc\_p}\SpecialCharTok{$}\NormalTok{fc }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{),}\StringTok{"stable"}\NormalTok{),}
                      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{,}\StringTok{"stable"}\NormalTok{))}
    \CommentTok{\#plot volcano}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ fc\_p}
\NormalTok{    title }\OtherTok{\textless{}{-}}  \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"/"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fc, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+} 
        \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+} 
        \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}
                          \StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}
                          \StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
        \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{), }\AttributeTok{linetype=}\DecValTok{4}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{), }\AttributeTok{linetype=}\DecValTok{4}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(FC)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"{-}log10(p{-}value)"}\NormalTok{, }\AttributeTok{title=}\NormalTok{title) }\SpecialCharTok{+} 
        \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{strsplit}\NormalTok{(id, }\AttributeTok{split=}\StringTok{"X"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]),}
                \AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
                \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
                \CommentTok{\#plot.margin = unit(c(3, 1, 3, 1), "cm")}
                \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}
    \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"volcano/"}\NormalTok{, i, }\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

    \CommentTok{\# for facet plot}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(i, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{3}\NormalTok{]}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{facet\_col }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(compare[}\DecValTok{1}\NormalTok{], }\StringTok{"/"}\NormalTok{, compare[}\DecValTok{2}\NormalTok{])}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{facet\_row }\OtherTok{\textless{}{-}}\NormalTok{ deep}
\NormalTok{    fc\_p}\SpecialCharTok{$}\NormalTok{team }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(i, }\StringTok{"\_"}\NormalTok{, fc\_p}\SpecialCharTok{$}\NormalTok{id)}
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\NormalTok{team[}\DecValTok{1}\NormalTok{])\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}}\NormalTok{ fc\_p}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        data\_facet }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(data\_facet, fc\_p)}
\NormalTok{    \}}
\NormalTok{\}}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data\_facet[}\SpecialCharTok{!}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data\_facet) }\SpecialCharTok{\%in\%} \FunctionTok{grep}\NormalTok{(}\StringTok{"control"}\NormalTok{, data\_facet}\SpecialCharTok{$}\NormalTok{facet\_col)),]}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fc, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}
                      \StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}
                      \StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(FC)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"{-}log10(p{-}value)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fc) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{strsplit}\NormalTok{(id, }\AttributeTok{split=}\StringTok{"X"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{]),}
            \AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
          \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col)}
\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"volcano/volcano\_facet.svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\CommentTok{\# plot vip{-}p plot}
\CommentTok{\# merge the vip dataset and p.value dataset}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"vip"}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, data\_vip, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"team"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p.value, }\AttributeTok{y=}\NormalTok{vip, }\AttributeTok{color=}\NormalTok{fc)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\SpecialCharTok{+}\DecValTok{5}\NormalTok{), }
                  \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{+}\DecValTok{3}\NormalTok{), }
                  \AttributeTok{colours =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#E6550DFF"}\NormalTok{, }\StringTok{"\#79AF97FF"}\NormalTok{, }\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
\CommentTok{\#   scale\_color\_viridis\_c() +}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"VIP"}\NormalTok{, }\AttributeTok{x=}\StringTok{"p{-}value"}\NormalTok{, }\AttributeTok{color=}\StringTok{"log2(FC)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{1}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FloatTok{0.05}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{facet\_grid}\NormalTok{(facet\_row.x }\SpecialCharTok{\textasciitilde{}}\NormalTok{ facet\_col.x) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}
          \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{), }
          \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"vip/vip\_p\_facet.svg"}\NormalTok{)}
\CommentTok{\# filter the data according to vip, p.value, fc}
\CommentTok{\# FDR revise}
\FunctionTok{library}\NormalTok{(fdrtool)}
\NormalTok{df}\SpecialCharTok{$}\NormalTok{q.value }\OtherTok{\textless{}{-}} \FunctionTok{fdrtool}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{p.value, }\AttributeTok{statistic=}\StringTok{\textquotesingle{}pvalue\textquotesingle{}}\NormalTok{, }\AttributeTok{plot=}\NormalTok{F)}\SpecialCharTok{$}\NormalTok{qval}

\CommentTok{\# p.value filter}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fc}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{vip}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01}\NormalTok{),]}
\NormalTok{data\_u }\OtherTok{\textless{}{-}}\NormalTok{ data[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id.x),]}
\NormalTok{data\_u }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(data\_u, }\AttributeTok{col=}\StringTok{"id.x"}\NormalTok{, }\AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"X"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{sep=}\StringTok{"X"}\NormalTok{, }\AttributeTok{remove=}\NormalTok{T)}
\CommentTok{\# get sirius idenfication results}
\NormalTok{structure }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\CommentTok{\# merge the structure according to qdata}
\NormalTok{data1 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data\_u, structure, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\FunctionTok{write.table}\NormalTok{(data1, }\AttributeTok{file=}\StringTok{"data\_structure.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}

\CommentTok{\# q.value filter}
\NormalTok{qdata }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fc}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{vip}\SpecialCharTok{\textgreater{}}\DecValTok{1} \SpecialCharTok{\&}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{q.value}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{),]}
\NormalTok{qdata\_u }\OtherTok{\textless{}{-}}\NormalTok{ qdata[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(qdata}\SpecialCharTok{$}\NormalTok{id.x),]}
\NormalTok{qdata\_u }\OtherTok{\textless{}{-}} \FunctionTok{separate}\NormalTok{(qdata\_u, }\AttributeTok{col=}\StringTok{"id.x"}\NormalTok{, }\AttributeTok{into=}\FunctionTok{c}\NormalTok{(}\StringTok{"X"}\NormalTok{, }\StringTok{"id"}\NormalTok{), }\AttributeTok{sep=}\StringTok{"X"}\NormalTok{, }\AttributeTok{remove=}\NormalTok{T)}
\CommentTok{\# merge the structure according to qdata}
\NormalTok{data0 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(qdata\_u, structure, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\FunctionTok{write.table}\NormalTok{(data0, }\AttributeTok{file=}\StringTok{"qdata\_structure.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}
\CommentTok{\# pathway enrichment analysis}
\FunctionTok{library}\NormalTok{(FELLA)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-format_geen.medical.r}{%
\section{File: format\_geen.medical.R}\label{file-format_geen.medical.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# format\_geen.medical \textless{}{-} }
  \CommentTok{\# function(}
  \CommentTok{\#          file = "\textasciitilde{}/Downloads/pubmed.xlsx",}
  \CommentTok{\#          get\_full.text = T,}
  \CommentTok{\#          save\_path = paste0("\textasciitilde{}/Documents/", Sys.time())}
  \CommentTok{\#          )\{}
  \CommentTok{\#   metadata \textless{}{-} readxl::read\_xlsx(file)}
  \CommentTok{\#   colnames(metadata) \textless{}{-} c("title", "IF", "author.1", "freq.author.1", }
  \CommentTok{\#                           "author.corr", "freq.author.corr", "email.author.corr",}
  \CommentTok{\#                           "journal", "freq.journal", "publish.year",}
  \CommentTok{\#                           "pmid", "url", "affi.author.1", "freq.affi.author.1")}
  \CommentTok{\#   if(get\_full.text)\{}
  \CommentTok{\#     save\_path \textless{}{-} gsub(":", "{-}", save\_path)}
  \CommentTok{\#     \#\# create dir}
  \CommentTok{\#     if(!file.exists(save\_path))}
  \CommentTok{\#       dir.create(save\_path)}
  \CommentTok{\#   \}}
  \CommentTok{\#   return(metadata)}
  \CommentTok{\# \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggplot2_heatmap.r}{%
\section{File: ggplot2\_heatmap.R}\label{file-ggplot2_heatmap.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\#  ggplot2\_heatmap.R}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggtree)}
\FunctionTok{library}\NormalTok{(aplot)}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(rayshader)}
\FunctionTok{library}\NormalTok{(ggsci)}
\CommentTok{\# instance: 2655 3058 2631 4719 3591 2629 2835 3378 3188 2528 1121 525 196 1683 3983 2428 34 4322 2943 2053 4291 3038 403 1637 4684 2028 274 347 495 2268}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{file}\OtherTok{=}\StringTok{"0703\_all/ftalign.tsv"}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{row.names=}\DecValTok{1}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
\NormalTok{name}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), }\AttributeTok{split=}\StringTok{"initial\_8\_neg\_"}\NormalTok{))[}\DecValTok{2}\NormalTok{,]}
\FunctionTok{colnames}\NormalTok{(data)}\OtherTok{=}\NormalTok{name}
\FunctionTok{rownames}\NormalTok{(data)}\OtherTok{=}\NormalTok{name}
\NormalTok{instance }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{sample}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data),}\DecValTok{27}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\StringTok{"347"}\NormalTok{, }\StringTok{"495"}\NormalTok{, }\StringTok{"2268"}\NormalTok{))}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%}\NormalTok{ instance, }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%}\NormalTok{ instance]}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{savename}\OtherTok{=}\StringTok{"instance.svg"}
\NormalTok{phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(data)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{)}
\NormalTok{phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(data))) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{layout\_dendrogram}\NormalTok{()}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{gather}\NormalTok{(data, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{key=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value=}\StringTok{\textquotesingle{}expr\textquotesingle{}}\NormalTok{)  }\DocumentationTok{\#\# keep the last col}
\NormalTok{pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{condition,}\AttributeTok{y=}\NormalTok{names,}\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal()+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\#scale\_fill\_npg() +}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{position=}\StringTok{"right"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"FTAS"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{90}\NormalTok{),}
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
        \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \CommentTok{\#axis.text = element\_blank(),}
        \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
        \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{4}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)}
        \CommentTok{\#axis.title.y = element\_text(size = 14),}
        \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{  )}
\NormalTok{  pp\_com }\OtherTok{\textless{}{-}}\NormalTok{ pp }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{insert\_left}\NormalTok{(phr, }\AttributeTok{width=}\NormalTok{.}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{insert\_top}\NormalTok{(phc, }\AttributeTok{height=}\NormalTok{.}\DecValTok{1}\NormalTok{) }
  \FunctionTok{ggsave}\NormalTok{(pp\_com,}\AttributeTok{file=}\NormalTok{savename, }\AttributeTok{width=}\DecValTok{16}\NormalTok{, }\AttributeTok{height=}\DecValTok{15}\NormalTok{)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[, }\FunctionTok{c}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data), }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{))]}
  \FunctionTok{write.table}\NormalTok{(data, }\AttributeTok{file=}\StringTok{"instance\_data.tsv"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#  normalized data}
\NormalTok{  file}\OtherTok{=}\StringTok{"norm\_instance\_data.tsv"}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{row.names=}\DecValTok{1}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  savename}\OtherTok{=}\StringTok{"norm\_instance.svg"}
\NormalTok{  phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(data)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{)}
\NormalTok{  phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(data))) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{layout\_dendrogram}\NormalTok{()}
\NormalTok{  data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}
\NormalTok{  p1 }\OtherTok{\textless{}{-}} \FunctionTok{gather}\NormalTok{(data, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{key=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value=}\StringTok{\textquotesingle{}expr\textquotesingle{}}\NormalTok{)  }\DocumentationTok{\#\# keep the last col}
\NormalTok{  pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{condition,}\AttributeTok{y=}\NormalTok{names,}\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+} 
    \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#theme\_minimal()+}
    \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{position=}\StringTok{"right"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"NFTAS"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
          \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{90}\NormalTok{),}
          \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
          \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
          \CommentTok{\#axis.text = element\_blank(),}
          \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
          \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
          \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
          \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{4}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
          \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)}
          \CommentTok{\#axis.title.y = element\_text(size = 14),}
          \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{    )}
\NormalTok{    pp\_com }\OtherTok{\textless{}{-}}\NormalTok{ pp }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{insert\_left}\NormalTok{(phr, }\AttributeTok{width=}\NormalTok{.}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{insert\_top}\NormalTok{(phc, }\AttributeTok{height=}\NormalTok{.}\DecValTok{1}\NormalTok{) }
    \FunctionTok{ggsave}\NormalTok{(pp\_com,}\AttributeTok{file=}\NormalTok{savename, }\AttributeTok{width=}\DecValTok{16}\NormalTok{, }\AttributeTok{height=}\DecValTok{15}\NormalTok{)}
    \CommentTok{\#plot\_gg(pp\_com, multicore = TRUE, width = 20 ,height=20, scale=250) \#加载图形}
    \CommentTok{\#render\_depth(focallength=100,focus=0.72)}
    \FunctionTok{library}\NormalTok{(ggupset)}
    \FunctionTok{library}\NormalTok{(reshape2)}
    \DocumentationTok{\#\#\# instance: 627 880 362 835 26 289 39 482 871 213 433 636 609 295 132 245 15 162 740 599 585 412 865 446 116 580 766 221 469 663 244 894 774 827 782 408 841 830 488 832 397 114 848 722 776 485 645 235 186 668}
\NormalTok{    file}\OtherTok{=}\StringTok{"norm\_instance\_data.tsv"}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{row.names=}\DecValTok{1}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
\NormalTok{    data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{melt}\NormalTok{(data, }\AttributeTok{measure.vars=}\FunctionTok{rownames}\NormalTok{(data), }\AttributeTok{variable.name=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value.name=}\StringTok{"expr"}\NormalTok{)}
\NormalTok{    instance }\OtherTok{\textless{}{-}} \FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data), }\DecValTok{50}\NormalTok{)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ data[instance, ]}
\NormalTok{    data}\SpecialCharTok{$}\NormalTok{upset\_x}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{names, }\StringTok{"\_"}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{condition)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{factor}\NormalTok{(upset\_x), }\AttributeTok{y=}\NormalTok{expr, }\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
      \CommentTok{\#scale\_x\_mergelist(sep = "\_") +}
      \FunctionTok{axis\_combmatrix}\NormalTok{(}\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
      \CommentTok{\#coord\_flip() +}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Feature link"}\NormalTok{, }\AttributeTok{y=}\StringTok{"NFTAS"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \CommentTok{\#axis.text.x = element\_text(angle=90),}
            \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{angle=}\DecValTok{90}\NormalTok{),}
            \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{30}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{angle=}\DecValTok{180}\NormalTok{),}
            \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{30}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
            \CommentTok{\#axis.text = element\_blank(),}
            \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
            \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
            \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
            \CommentTok{\#legend.key.width = unit(2, "cm"),}
            \CommentTok{\#legend.key.height = unit(4, "cm"),}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)}
            \CommentTok{\#axis.title.y = element\_text(size = 14),}
            \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{            ) }\SpecialCharTok{+}
\FunctionTok{theme\_combmatrix}\NormalTok{(}\AttributeTok{combmatrix.panel.point.size =} \DecValTok{5}\NormalTok{, }
                 \CommentTok{\#combmatrix.panel.margin = unit(c(0.5,0.5),"pt"),}
                 \AttributeTok{combmatrix.panel.line.size =} \DecValTok{2}\NormalTok{,}
                 \AttributeTok{combmatrix.label.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{500}\NormalTok{, }\StringTok{"pt"}\NormalTok{), }
                 \AttributeTok{combmatrix.label.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{angle=}\DecValTok{145}\NormalTok{, }\AttributeTok{size=}\DecValTok{12}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{vjust=}\SpecialCharTok{{-}}\FloatTok{0.2}\NormalTok{),}
                 \AttributeTok{combmatrix.label.make\_space =}\NormalTok{ F)}
\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"test1.pdf"}\NormalTok{, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{20}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggtree)}
\FunctionTok{library}\NormalTok{(aplot)}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(rayshader)}
\FunctionTok{library}\NormalTok{(ggsci)}
\NormalTok{file}\OtherTok{=}\StringTok{"0703\_all/ftalign.tsv"}
\NormalTok{savename}\OtherTok{=}\StringTok{"small\_heatmap.svg"}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{row.names=}\DecValTok{1}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}
\NormalTok{name}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), }\AttributeTok{split=}\StringTok{"initial\_8\_neg\_"}\NormalTok{))[}\DecValTok{2}\NormalTok{,]}
\FunctionTok{colnames}\NormalTok{(data)}\OtherTok{=}\NormalTok{name}
\FunctionTok{rownames}\NormalTok{(data)}\OtherTok{=}\NormalTok{name}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"347"}\NormalTok{, }\StringTok{"495"}\NormalTok{, }\StringTok{"2268"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"347"}\NormalTok{, }\StringTok{"495"}\NormalTok{, }\StringTok{"2268"}\NormalTok{)]}
\NormalTok{phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(data)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{)}
\NormalTok{phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(data))) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{layout\_dendrogram}\NormalTok{()}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}
\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{gather}\NormalTok{(data, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{key=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value=}\StringTok{\textquotesingle{}expr\textquotesingle{}}\NormalTok{)  }\DocumentationTok{\#\# keep the last col}
\NormalTok{pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{condition,}\AttributeTok{y=}\NormalTok{names,}\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal()+}
  \FunctionTok{scale\_fill\_viridis\_c}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\#scale\_fill\_npg() +}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{position=}\StringTok{"right"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Normalized}\SpecialCharTok{\textbackslash{}n}\StringTok{ftalign}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
        \CommentTok{\#axis.text = element\_blank(),}
        \AttributeTok{legend.title =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{()}
        \CommentTok{\#legend.text = element\_text(size=20),}
        \CommentTok{\#legend.key.width = unit(2, "cm"),}
        \CommentTok{\#legend.key.height = unit(4, "cm"),}
        \CommentTok{\#text=element\_text(family="serif")}
        \CommentTok{\#axis.title.y = element\_text(size = 14),}
        \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{  )}
\NormalTok{  pp\_com }\OtherTok{\textless{}{-}}\NormalTok{ pp }\SpecialCharTok{\%\textgreater{}\%} 
    \FunctionTok{insert\_left}\NormalTok{(phr, }\AttributeTok{width=}\NormalTok{.}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{insert\_top}\NormalTok{(phc, }\AttributeTok{height=}\NormalTok{.}\DecValTok{1}\NormalTok{) }
  \FunctionTok{ggsave}\NormalTok{(pp\_com,}\AttributeTok{file=}\NormalTok{savename, }\AttributeTok{width=}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggraph_facet_network.r}{%
\section{File: ggraph\_facet\_network.R}\label{file-ggraph_facet_network.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(gridtext)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
\CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification[}\FunctionTok{grep}\NormalTok{(}\StringTok{"null"}\NormalTok{, nodes2}\SpecialCharTok{$}\NormalTok{classification)] }\OtherTok{\textless{}{-}} \StringTok{"Undifined"}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\CommentTok{\# edge \textless{}{-} list()}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(edge\_list))\{}
\NormalTok{  edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{  edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{  cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{  network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{    layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{    plot[[i]] }\OtherTok{\textless{}{-}} 
      \FunctionTok{ggraph}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout) }\SpecialCharTok{+} 
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
      \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\NormalTok{classification), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
      \CommentTok{\# geom\_node\_text(aes(label=name),size=3) +}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{str\_wrap}\NormalTok{(facet, }\AttributeTok{width=}\DecValTok{30}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
            \CommentTok{\#axis.line = element\_blank(),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
      \CommentTok{\# ggsave(plot[[i]], file="test.svg", width=5, height=5)}
      \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }
\NormalTok{\}}
\DocumentationTok{\#\#}
\FunctionTok{svg}\NormalTok{(}\StringTok{"test\_child\_nebula.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{18}\SpecialCharTok{*}\FloatTok{1.6}\NormalTok{, }\AttributeTok{height=}\DecValTok{22}\SpecialCharTok{*}\FloatTok{1.5}\NormalTok{)}
\NormalTok{n}\OtherTok{=}\FunctionTok{length}\NormalTok{(edge\_list)}
\NormalTok{s}\OtherTok{=}\NormalTok{n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{); }\ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(s)}\SpecialCharTok{!=}\NormalTok{s)\{s}\OtherTok{=}\FunctionTok{round}\NormalTok{(s); ss}\OtherTok{=}\NormalTok{s}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{ss}\OtherTok{=}\NormalTok{s\}}
\FunctionTok{grid.newpage}\NormalTok{()}
\FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(ss, s)))}
\NormalTok{r\_ss}\OtherTok{=}\DecValTok{1}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{  c\_s}\OtherTok{=}\NormalTok{i}\SpecialCharTok{\%\%}\NormalTok{s}
  \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{c\_s}\OtherTok{=}\NormalTok{s\}}
  \FunctionTok{print}\NormalTok{( plot[[i]], }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\NormalTok{r\_ss, }\AttributeTok{layout.pos.col=}\NormalTok{c\_s ))}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"push view port of "}\NormalTok{,i,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\NormalTok{s)\{ r\_ss}\OtherTok{=}\NormalTok{r\_ss}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{\}}
\FunctionTok{dev.off}\NormalTok{()}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\# network zoomed}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(gridSVG)}
\FunctionTok{library}\NormalTok{(rsvg)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
\CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\CommentTok{\# edge \textless{}{-} list()}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{nodes}\SpecialCharTok{$}\NormalTok{similarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{nodes}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"null"}\NormalTok{, }\StringTok{"Undefined"}\NormalTok{, nodes}\SpecialCharTok{$}\NormalTok{classification)}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{select1}\OtherTok{=}\StringTok{"Iridoids and derivatives.tsv"}
\NormalTok{select2}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{stru\_path}\OtherTok{=}\StringTok{"structure\_2d/smiles\_draw"}
\NormalTok{structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ stru\_path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"canopus\_pp\_filter.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(canopus\_set)}
\FunctionTok{colnames}\NormalTok{(canopus\_set)}\OtherTok{=}\FunctionTok{as.character}\NormalTok{(canopus\_set[}\DecValTok{1}\NormalTok{,])}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,]}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{metadata}\SpecialCharTok{$}\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"C"}\NormalTok{,metadata}\SpecialCharTok{$}\NormalTok{absoluteIndex)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# start plot}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ select\_list)\{}
\NormalTok{  edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{  edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{  cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{  network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{    layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\# figure elements}
    \DocumentationTok{\#\#\# structure}
\NormalTok{    elements }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n[,}\FunctionTok{colnames}\NormalTok{(layout\_n) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"classification"}\NormalTok{)]}
\NormalTok{    elements}\SpecialCharTok{$}\NormalTok{link\_structure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)}
\NormalTok{    grid\_elements }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, matrix, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"link\_structure"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"structure\_list"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
    \DocumentationTok{\#\#\# grobify}
\NormalTok{    structure\_p}\OtherTok{\textless{}{-}}\FunctionTok{list}\NormalTok{()}
\NormalTok{    list\_stru }\OtherTok{\textless{}{-}}\NormalTok{ grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(grid\_elements) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"link\_structure"}\NormalTok{)]}
\NormalTok{    prefix}\OtherTok{=}\FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ list\_stru)\{}
\NormalTok{      id}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(j, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
      \CommentTok{\#structure\_p[[as.numeric(id)]] = grobify(readPicture(paste0(path,"/",j)))}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,id), }\FunctionTok{grobify}\NormalTok{(}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{,j))))}
      \FunctionTok{cat}\NormalTok{(id,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{, }\StringTok{"structure\_p}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    aes\_stru }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{),], }\AttributeTok{grob=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,name), }\AttributeTok{id=}\NormalTok{name)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\# ring\_bar plot}
\NormalTok{    ring\_data }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[,}\FunctionTok{colnames}\NormalTok{(canopus\_set) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name)]}
\NormalTok{    list\_palette }\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification)), palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification))]))}
    \FunctionTok{colnames}\NormalTok{(list\_palette) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"classification"}\NormalTok{, }\StringTok{"color"}\NormalTok{)}
\NormalTok{    elements\_palette }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, list\_palette, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"classification"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(ring\_data)[j]}
\NormalTok{      fill\_in}\OtherTok{=}\NormalTok{elements\_palette[}\FunctionTok{which}\NormalTok{(elements\_palette}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}\SpecialCharTok{$}\NormalTok{color}
\NormalTok{      fill\_border}\OtherTok{=}\StringTok{"black"}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(ring\_data[,}\FunctionTok{colnames}\NormalTok{(ring\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(id)]) }
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{class=}\FunctionTok{rownames}\NormalTok{(df))}
      \FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}\StringTok{"class"}\NormalTok{)}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"class"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{num),]}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class, }\StringTok{": "}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fill, }\AttributeTok{levels=}\NormalTok{df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{absoluteIndex), }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"fill"}\NormalTok{)])}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\NormalTok{value)) }\SpecialCharTok{+}
        \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{), }\AttributeTok{fill =}\NormalTok{fill\_in) }\SpecialCharTok{+}
        \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{), }\AttributeTok{fill=}\NormalTok{fill\_border) }\SpecialCharTok{+}
        \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{fill), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.02}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
        \CommentTok{\#annotate("text", x=df[nrow(df), colnames(df) \%in\% "num"], y={-}1, }
        \CommentTok{\#       label=paste0("ID: ", id), hjust=0, family="Times", fontface="bold", size=0.7, alpha=0.5) +}
        \CommentTok{\#scale\_fill\_gsea() +}
        \CommentTok{\#geom\_text(data=df, aes(x=class, y=value+0.1, label=ifelse(value\textgreater{}0.7, class, "")), }
        \CommentTok{\#       color="black", fontface="bold",alpha=0.6, size=0.3, inherit.aes = FALSE ) +}
        \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}
              \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \CommentTok{\#plot.background = element\_rect(fill = "transparent"),}
              \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid.major =}\FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
              \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
              \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{) }\CommentTok{\# Adjust the margin to make in sort labels are not truncated!}
\NormalTok{        )}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id), p) }
\NormalTok{    \}}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{    plot[[i]] }\OtherTok{\textless{}{-}} 
      \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity),}
                    \AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
\FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
\FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
\FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
\FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{facet) }\SpecialCharTok{+} 
\FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Access classes"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
\FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
      \CommentTok{\#panel.background = element\_rect(fill="white"), }
      \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
      \CommentTok{\#panel.grid = element\_blank(),}
      \CommentTok{\#legend.position = "none",}
      \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
      \CommentTok{\#plot.margin =unit(c(0,0,0,0),"cm"),}
      \CommentTok{\#panel.spacing =unit(c(0,0,0,0),"cm")}
\NormalTok{)}
\FunctionTok{assign}\NormalTok{(}\StringTok{"find\_id"}\NormalTok{, plot[[i]])}
\DocumentationTok{\#\# size and posion adjust}
\NormalTok{min}\OtherTok{=}\FunctionTok{min}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{delta}\OtherTok{=}\FunctionTok{max}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}\SpecialCharTok{{-}}\NormalTok{min}
\NormalTok{step}\OtherTok{=}\DecValTok{1}\SpecialCharTok{/}\NormalTok{delta}
\ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{39} \SpecialCharTok{|}\NormalTok{ i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{)\{p\_size}\OtherTok{=}\FloatTok{0.85}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.105}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{p\_size}\OtherTok{=}\FloatTok{0.65}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.09}\NormalTok{\}}
\DocumentationTok{\#\# draw subview into the network}
\ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{  id}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(ring\_data)[k]}
\NormalTok{  aes\_ring}\OtherTok{=}\NormalTok{elements[}\FunctionTok{which}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}
\NormalTok{  size}\OtherTok{=}\NormalTok{(aes\_ring}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{{-}}\NormalTok{min)}\SpecialCharTok{*}\NormalTok{step}\SpecialCharTok{+}\NormalTok{p\_size}
  \DocumentationTok{\#\# ppcp datacet}
\NormalTok{  plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{x}\SpecialCharTok{{-}}\NormalTok{p\_dist, }\AttributeTok{y=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{y}\SpecialCharTok{{-}}\NormalTok{p\_dist,}
                                        \AttributeTok{subview=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id)),}
                                        \AttributeTok{width=}\NormalTok{size, }\AttributeTok{height=}\NormalTok{size )  }
  \DocumentationTok{\#\# structure}
\NormalTok{  kk }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(aes\_stru}\SpecialCharTok{$}\NormalTok{id}\SpecialCharTok{==}\NormalTok{id)}
\NormalTok{  size}\OtherTok{=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{similarity}
\NormalTok{  plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{y,}
                                        \AttributeTok{subview=}\FunctionTok{arrangeGrob}\NormalTok{( }\FunctionTok{get}\NormalTok{(aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{grob) ),}
                                        \AttributeTok{width=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{)}
\NormalTok{\}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{ggsave}\NormalTok{(plot[[i]], }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"tt\_zoom\_"}\NormalTok{,i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{7}\NormalTok{, }\AttributeTok{height=}\FloatTok{5.5}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }
\NormalTok{\}}

\NormalTok{p }\OtherTok{\textless{}{-}}\NormalTok{ find\_id }\SpecialCharTok{+} \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{3}\NormalTok{) }
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\# ladder network}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(gridSVG)}
\FunctionTok{library}\NormalTok{(ggpubr)}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_ladder1"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
\CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\CommentTok{\# edge \textless{}{-} list()}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal0}\OtherTok{=} \FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal0, pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{select1}\OtherTok{=}\StringTok{"Iridoids and derivatives.tsv"}
\NormalTok{select2}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# start plot}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#for(i in select\_list)\{}
\NormalTok{i}\OtherTok{=}\DecValTok{39}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{  network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  num\_edges }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{))) }
  \FunctionTok{colnames}\NormalTok{(num\_edges) }\OtherTok{\textless{}{-}} \StringTok{"tlimit"}
\NormalTok{  num\_edges}\SpecialCharTok{$}\NormalTok{num}\OtherTok{=}\ConstantTok{NA}
  \ControlFlowTok{for}\NormalTok{(tlimit }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{))\{}
\NormalTok{    network\_edges\_filter }\OtherTok{\textless{}{-}}\NormalTok{ network\_edges[}\FunctionTok{which}\NormalTok{(network\_edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}}\NormalTok{ tlimit),]}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(network\_edges\_filter}\SpecialCharTok{$}\NormalTok{from, network\_edges\_filter}\SpecialCharTok{$}\NormalTok{to))}
\NormalTok{    network\_nodes}\SpecialCharTok{$}\NormalTok{rownames}\OtherTok{=}\FunctionTok{rownames}\NormalTok{(network\_nodes)}
\NormalTok{    num\_edges[}\FunctionTok{which}\NormalTok{(num\_edges}\SpecialCharTok{$}\NormalTok{tlimit}\SpecialCharTok{==}\NormalTok{tlimit),]}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(network\_edges\_filter)}
\NormalTok{    network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges\_filter) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
      \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{))}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#}
      \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{      layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(tlimit}\SpecialCharTok{==}\FloatTok{0.2}\NormalTok{, }\StringTok{"fr"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{      layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      plot[[i]] }\OtherTok{\textless{}{-}} 
        \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
        \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{label\_alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
        \CommentTok{\#geom\_node\_point(aes(fill=str\_wrap(classification, width=25), size=similarity), shape=21) + }
        \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{deg, }\AttributeTok{size=}\FunctionTok{as.numeric}\NormalTok{(similarity)), }\AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(layout\_n}\SpecialCharTok{$}\NormalTok{rownames }\SpecialCharTok{\%in\%}\NormalTok{ list, }\DecValTok{1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
        \CommentTok{\#scale\_fill\_gradientn(labels=c("low", "", "", "", "high"), colors=c("\#1B1919FF", "\#4DBBD5FF")) +}
        \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colors=}\FunctionTok{c}\NormalTok{(}\StringTok{"\#1B1919FF"}\NormalTok{, }\StringTok{"\#4DBBD5FF"}\NormalTok{)) }\SpecialCharTok{+}
        \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
        \CommentTok{\#facet\_edges(\textasciitilde{}facet) + }
        \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Centrality}\SpecialCharTok{\textbackslash{}n}\StringTok{degree"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
        \CommentTok{\#guides(size="none", fill="none") +}
        \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}
              \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
              \CommentTok{\#panel.background = element\_rect(fill="white"), }
              \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
              \CommentTok{\#panel.grid = element\_blank(),}
              \CommentTok{\#legend.position = "none",}
              \CommentTok{\#strip.text = element\_text(size=15, face="bold")}
              \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{        )}
        \ControlFlowTok{if}\NormalTok{(tlimit}\SpecialCharTok{==}\FloatTok{0.7} \SpecialCharTok{\&}\NormalTok{ i}\SpecialCharTok{==}\DecValTok{39}\NormalTok{)\{}
\NormalTok{          plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"low"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"high"}\NormalTok{), }
                                                        \AttributeTok{colors=}\FunctionTok{c}\NormalTok{(}\StringTok{"\#1B1919FF"}\NormalTok{, }\StringTok{"\#4DBBD5FF"}\NormalTok{)) }
\NormalTok{        \}}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"plot\_"}\NormalTok{, tlimit), plot[[i]])}
        \CommentTok{\#ggsave(plot[[i]], file=paste0("tlimit\_", tlimit, ".svg"), width=7, height=5)}
        \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)  }
\NormalTok{  \}}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  p\_step1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(num\_edges, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(tlimit), }\AttributeTok{y=}\NormalTok{num)) }\SpecialCharTok{+} 
    \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"NFTAS (PPCP ≥ 0.5)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Edges"}\NormalTok{)}\SpecialCharTok{+}
    \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
          \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
          \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
          \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\DecValTok{1}\NormalTok{),}
          \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
          \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{          ) }\SpecialCharTok{+}
      \FunctionTok{coord\_cartesian}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{1500}\NormalTok{))}
\NormalTok{    p\_step2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(num\_edges, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(tlimit), }\AttributeTok{y=}\NormalTok{num)) }\SpecialCharTok{+} 
      \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\ConstantTok{NULL}\NormalTok{, }\AttributeTok{y=}\StringTok{"number"}\NormalTok{)}\SpecialCharTok{+}
      \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Lignans, neolignans and related compounds"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
            \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{), }
            \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size=}\DecValTok{25}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(), }
            \AttributeTok{axis.ticks.x =} \FunctionTok{element\_blank}\NormalTok{() }
\NormalTok{            ) }\SpecialCharTok{+}
      \FunctionTok{coord\_cartesian}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{6500}\NormalTok{,}\DecValTok{7000}\NormalTok{))}
\NormalTok{    p\_step }\OtherTok{\textless{}{-}} \FunctionTok{ggarrange}\NormalTok{(p\_step2, p\_step1, }\AttributeTok{heights=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\DecValTok{3}\SpecialCharTok{/}\DecValTok{5}\NormalTok{),}\AttributeTok{ncol =} \DecValTok{1}\NormalTok{, }\AttributeTok{nrow =} \DecValTok{2}\NormalTok{, }\AttributeTok{common.legend =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{legend=}\StringTok{"right"}\NormalTok{, }\AttributeTok{align =} \StringTok{"v"}\NormalTok{)}
    \CommentTok{\# p2 \textless{}{-} gg.gap(plot = p\_step,}
    \CommentTok{\#           segments = c(1000, 3400),}
    \CommentTok{\#           fontfamily = "serif",}
    \CommentTok{\#           \#tick\_width = 10,}
    \CommentTok{\#rel\_heights = c(0.25, 0, 0.1),\# 设置分隔为的三个部分的宽度}
    \CommentTok{\#           ylim = c(0, 3800)}
    \CommentTok{\#           ) +}
    \CommentTok{\#       theme(}
    \CommentTok{\#    axis.title = element\_text(face="bold"),}
    \CommentTok{\#    plot.margin =unit(c(0,0,0,0),"cm"),}
    \CommentTok{\#         panel.spacing =unit(c(0,0,0,0),"cm"),}
    \CommentTok{\#         text=element\_text(family="serif")}
    \CommentTok{\#        )}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \CommentTok{\#png("test.png", width=1000, height=1000)}
    \CommentTok{\#tiff("step\_network.tiff", width=1200*7/5, height=400*7/5, compression="lzw")}
    \FunctionTok{svg}\NormalTok{(}\StringTok{"step\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{24}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
    \CommentTok{\#pdf("step\_network.pdf", width=24, height=8)}
    \FunctionTok{grid.newpage}\NormalTok{()}
\NormalTok{    n}\OtherTok{=}\DecValTok{0}
\NormalTok{    adjust}\OtherTok{=}\FloatTok{3.8}
\NormalTok{    posi\_just}\OtherTok{=}\DecValTok{3}
    \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{60}\SpecialCharTok{+}\NormalTok{adjust}\SpecialCharTok{+}\NormalTok{posi\_just)) )}
    \FunctionTok{print}\NormalTok{( p\_step, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\DecValTok{60}\SpecialCharTok{+}\NormalTok{adjust) ))}
    \ControlFlowTok{for}\NormalTok{(tlimit }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.4}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.6}\NormalTok{, }\FloatTok{0.7}\NormalTok{))\{}
\NormalTok{      n}\OtherTok{=}\NormalTok{n}\SpecialCharTok{+}\DecValTok{1}
      \FunctionTok{print}\NormalTok{( }\FunctionTok{get}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"plot\_"}\NormalTok{, tlimit) ), }
            \AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{21}\SpecialCharTok{:}\DecValTok{39}\NormalTok{, }
                        \AttributeTok{layout.pos.col=}\NormalTok{( ((n}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\DecValTok{10}\SpecialCharTok{+}\DecValTok{1}\SpecialCharTok{+}\NormalTok{posi\_just)}\SpecialCharTok{:}\NormalTok{(n}\SpecialCharTok{*}\DecValTok{10}\SpecialCharTok{+}\NormalTok{adjust}\SpecialCharTok{+}\NormalTok{posi\_just) ) }
\NormalTok{            )}
\NormalTok{            ) \}}
    \FunctionTok{grid.text}\NormalTok{(}\StringTok{"Morphology"}\NormalTok{, }\AttributeTok{x=}\FloatTok{0.02}\NormalTok{, }\AttributeTok{y=}\FloatTok{0.25}\NormalTok{, }\AttributeTok{rot=}\DecValTok{90}\NormalTok{,}
              \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{( }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{fontsize =} \DecValTok{20}\NormalTok{, }\AttributeTok{fontfamily =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{fontangle=}\DecValTok{90}\NormalTok{) )}
    \FunctionTok{dev.off}\NormalTok{()}
    \CommentTok{\#\}}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \FunctionTok{library}\NormalTok{(tidyverse)}
    \FunctionTok{library}\NormalTok{(igraph)}
    \FunctionTok{library}\NormalTok{(ggraph)}
    \FunctionTok{library}\NormalTok{(tidygraph)}
    \FunctionTok{library}\NormalTok{(ggsci)}
    \FunctionTok{library}\NormalTok{(scales)}
    \FunctionTok{library}\NormalTok{(grid)}
    \FunctionTok{library}\NormalTok{(stringr)}
    \FunctionTok{library}\NormalTok{(ggimage)}
    \FunctionTok{library}\NormalTok{(grImport2)}
    \FunctionTok{library}\NormalTok{(gridSVG)}
    \FunctionTok{library}\NormalTok{(ggpubr)}
    \FunctionTok{library}\NormalTok{(reshape2)}
    \CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
    \CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{    nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{    nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{    nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{    nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{    nums }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{))) }
    \FunctionTok{colnames}\NormalTok{(nums) }\OtherTok{\textless{}{-}} \StringTok{"pp"}
\NormalTok{    nums}\SpecialCharTok{$}\NormalTok{e\_num}\OtherTok{=}\ConstantTok{NA}
\NormalTok{    nums}\SpecialCharTok{$}\NormalTok{n\_num}\OtherTok{=}\ConstantTok{NA}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \ControlFlowTok{for}\NormalTok{(pp }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{,}\FloatTok{0.5}\NormalTok{,}\FloatTok{0.7}\NormalTok{,}\FloatTok{0.9}\NormalTok{,}\FloatTok{0.95}\NormalTok{,}\FloatTok{0.99}\NormalTok{))\{}
\NormalTok{      path}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"network\_facet\_"}\NormalTok{, pp)}
\NormalTok{      edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                              \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                              \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{      name}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{      edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[}\FunctionTok{which}\NormalTok{(edge\_list}\SpecialCharTok{==}\NormalTok{name)]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{      edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{      cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{      network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
        \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{        network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{        list }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(network\_edges[}\FunctionTok{which}\NormalTok{(network\_edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity}\SpecialCharTok{!=}\DecValTok{1}\NormalTok{),]}\SpecialCharTok{$}\NormalTok{from, }
\NormalTok{                         network\_edges[}\FunctionTok{which}\NormalTok{(network\_edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity}\SpecialCharTok{!=}\DecValTok{1}\NormalTok{),]}\SpecialCharTok{$}\NormalTok{to))}
\NormalTok{        network\_nodes}\SpecialCharTok{$}\NormalTok{rownames}\OtherTok{=}\FunctionTok{rownames}\NormalTok{(network\_nodes)}
        \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{        nums[}\FunctionTok{which}\NormalTok{(nums}\SpecialCharTok{$}\NormalTok{pp}\SpecialCharTok{==}\NormalTok{pp), ]}\SpecialCharTok{$}\NormalTok{e\_num}\OtherTok{=} \FunctionTok{nrow}\NormalTok{(network\_edges)}
\NormalTok{        nums[}\FunctionTok{which}\NormalTok{(nums}\SpecialCharTok{$}\NormalTok{pp}\SpecialCharTok{==}\NormalTok{pp), ]}\SpecialCharTok{$}\NormalTok{n\_num}\OtherTok{=} \FunctionTok{nrow}\NormalTok{(network\_nodes)}
        \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
        \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
        \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{        network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{( }\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges ) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
          \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{))}
          \DocumentationTok{\#\#\#\#\#\#\#\#\#}
          \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{          layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{          layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
\NormalTok{          p }\OtherTok{\textless{}{-}} 
            \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
            \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
            \CommentTok{\#geom\_node\_point(aes(fill=str\_wrap(classification, width=25), size=similarity), shape=21) + }
            \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{deg, }\AttributeTok{size=}\FunctionTok{as.numeric}\NormalTok{(similarity)), }
                            \AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(layout\_n}\SpecialCharTok{$}\NormalTok{rownames }\SpecialCharTok{\%in\%}\NormalTok{ list, }\DecValTok{1}\NormalTok{, }\FloatTok{0.1}\NormalTok{), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
      \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low=}\StringTok{"\#1B1919FF"}\NormalTok{, }\AttributeTok{high=}\StringTok{"\#DC0000FF"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Centrality}\SpecialCharTok{\textbackslash{}n}\StringTok{degree"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
            \CommentTok{\#panel.background = element\_rect(fill="white"), }
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
            \CommentTok{\#panel.grid = element\_blank(),}
            \CommentTok{\#legend.position = "none",}
            \CommentTok{\#strip.text = element\_text(size=15, face="bold")}
            \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
      \ControlFlowTok{if}\NormalTok{(pp}\SpecialCharTok{==}\FloatTok{0.99}\NormalTok{)\{}
\NormalTok{        p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low=}\StringTok{"\#1B1919FF"}\NormalTok{, }\AttributeTok{high=}\StringTok{"\#DC0000FF"}\NormalTok{, }\AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\StringTok{"low"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"high"}\NormalTok{, }\StringTok{""}\NormalTok{)) }
\NormalTok{      \}}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"plot\_"}\NormalTok{, pp), p) }
\NormalTok{    \}}
\NormalTok{    nums1 }\OtherTok{\textless{}{-}} \FunctionTok{melt}\NormalTok{(nums, }\AttributeTok{measure.vars=}\FunctionTok{c}\NormalTok{(}\StringTok{"e\_num"}\NormalTok{, }\StringTok{"n\_num"}\NormalTok{), }\AttributeTok{variable.name=}\StringTok{"var"}\NormalTok{, }\AttributeTok{value.name=}\StringTok{"expr"}\NormalTok{)}
\NormalTok{    p\_step }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(nums1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(pp), }\AttributeTok{y=}\NormalTok{expr, }\AttributeTok{fill=}\NormalTok{var)) }\SpecialCharTok{+} 
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position=}\FunctionTok{position\_dodge}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.9}\NormalTok{), }\AttributeTok{width =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{, }\AttributeTok{y=}\StringTok{""}\NormalTok{)}\SpecialCharTok{+}
      \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_uchicago}\NormalTok{(}\StringTok{"dark"}\NormalTok{, }\AttributeTok{labels=}\FunctionTok{c}\NormalTok{(}\StringTok{"nodes"}\NormalTok{, }\StringTok{"edges"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"PPCP (NFTAS ≥ 0.4)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Number"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Type"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"Lignans, neolignans and related compounds"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
            \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
            \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
            \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{size=}\DecValTok{25}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{), }
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.02}\NormalTok{, }\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.1}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{            ) }\SpecialCharTok{+}
      \FunctionTok{coord\_cartesian}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{600}\NormalTok{))}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \FunctionTok{svg}\NormalTok{(}\StringTok{"step2\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{24}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
    \FunctionTok{grid.newpage}\NormalTok{()}
\NormalTok{    n}\OtherTok{=}\DecValTok{0}
\NormalTok{    adjust}\OtherTok{=}\FloatTok{3.8}
\NormalTok{    posi\_just}\OtherTok{=}\DecValTok{3}
    \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{40}\NormalTok{, }\DecValTok{60}\SpecialCharTok{+}\NormalTok{adjust}\SpecialCharTok{+}\NormalTok{posi\_just)) )}
    \FunctionTok{print}\NormalTok{( p\_step, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{20}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\DecValTok{60}\SpecialCharTok{+}\NormalTok{adjust) ))}
    \ControlFlowTok{for}\NormalTok{(pp }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.9}\NormalTok{, }\FloatTok{0.95}\NormalTok{, }\FloatTok{0.99}\NormalTok{))\{}
\NormalTok{      n}\OtherTok{=}\NormalTok{n}\SpecialCharTok{+}\DecValTok{1}
      \FunctionTok{print}\NormalTok{( }\FunctionTok{get}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"plot\_"}\NormalTok{, pp) ), }
            \AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{21}\SpecialCharTok{:}\DecValTok{39}\NormalTok{, }
                        \AttributeTok{layout.pos.col=}\NormalTok{( ((n}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{*}\DecValTok{10}\SpecialCharTok{+}\DecValTok{1}\SpecialCharTok{+}\NormalTok{posi\_just)}\SpecialCharTok{:}\NormalTok{(n}\SpecialCharTok{*}\DecValTok{10}\SpecialCharTok{+}\NormalTok{adjust}\SpecialCharTok{+}\NormalTok{posi\_just) ) }
\NormalTok{            )}
\NormalTok{            ) \}}
    \FunctionTok{grid.text}\NormalTok{(}\StringTok{"Morphology"}\NormalTok{, }\AttributeTok{x=}\FloatTok{0.02}\NormalTok{, }\AttributeTok{y=}\FloatTok{0.25}\NormalTok{, }\AttributeTok{rot=}\DecValTok{90}\NormalTok{,}
              \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{( }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{fontsize =} \DecValTok{20}\NormalTok{, }\AttributeTok{fontfamily =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{fontangle=}\DecValTok{90}\NormalTok{) )}
    \FunctionTok{dev.off}\NormalTok{()}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \CommentTok{\# EX}
\NormalTok{    metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{    metadata}\SpecialCharTok{$}\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"C"}\NormalTok{,metadata}\SpecialCharTok{$}\NormalTok{absoluteIndex)}
\NormalTok{    id }\OtherTok{\textless{}{-}} \DecValTok{527}
\NormalTok{    fill\_in}\OtherTok{=}\NormalTok{elements\_palette[}\FunctionTok{which}\NormalTok{(elements\_palette}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}\SpecialCharTok{$}\NormalTok{color}
\NormalTok{    fill\_border}\OtherTok{=}\StringTok{"black"}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(ring\_data[,}\FunctionTok{colnames}\NormalTok{(ring\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(id)]) }
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{class=}\FunctionTok{rownames}\NormalTok{(df))}
    \FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}\StringTok{"class"}\NormalTok{)}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"class"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{num),]}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class, }\StringTok{": "}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fill, }\AttributeTok{levels=}\NormalTok{df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{absoluteIndex), }\FunctionTok{c}\NormalTok{(}\StringTok{"fill"}\NormalTok{)])}
\NormalTok{    label\_data }\OtherTok{\textless{}{-}}\NormalTok{ df}
\NormalTok{    number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
\NormalTok{    label\_data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{nrow}\NormalTok{(label\_data))}
\NormalTok{    angle }\OtherTok{\textless{}{-}}  \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (label\_data}\SpecialCharTok{$}\NormalTok{id}\FloatTok{{-}0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar    }
\NormalTok{    label\_data}\SpecialCharTok{$}\NormalTok{hjust}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{    label\_data}\SpecialCharTok{$}\NormalTok{angle}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(angle) }\SpecialCharTok{\textless{}}\NormalTok{ (}\SpecialCharTok{{-}}\DecValTok{90}\NormalTok{), angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
    \FunctionTok{rm}\NormalTok{(angle)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\NormalTok{value)) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{), }\AttributeTok{fill =}\NormalTok{fill\_in) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{), }\AttributeTok{fill=}\NormalTok{fill\_border) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{fill), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \CommentTok{\#scale\_fill\_gsea() +}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{label=}\NormalTok{class, }\AttributeTok{angle=}\NormalTok{angle), }
                \AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{,}\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ ) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \CommentTok{\#plot.background = element\_rect(fill = "transparent"),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.grid.major =}\FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{,}\StringTok{"cm"}\NormalTok{),}
            \CommentTok{\#legend.position = "none",}
            \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
            \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{) }\CommentTok{\# Adjust the margin to make in sort labels are not truncated!}
\NormalTok{      )}
\NormalTok{      complement }\OtherTok{\textless{}{-}} \FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{, id,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{))}
      \FunctionTok{svg}\NormalTok{(}\StringTok{"annotate.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{14}\NormalTok{, }\AttributeTok{height=}\DecValTok{7}\NormalTok{)}
      \FunctionTok{grid.newpage}\NormalTok{()}
      \FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{50}\NormalTok{)))}
      \CommentTok{\#print( pal\_grey, vp=viewport(layout.pos.row=1:50, layout.pos.col=1:20 ))}
      \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{50}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{50}\NormalTok{ ))}
      \FunctionTok{grid.picture}\NormalTok{(complement, }\AttributeTok{x=}\FloatTok{0.18}\NormalTok{, }\AttributeTok{y=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{width=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{height=}\FloatTok{0.5}\NormalTok{)}
      \FunctionTok{dev.off}\NormalTok{()}
      \CommentTok{\# ggsave(pal\_grey, file="bg.svg")}

      \DocumentationTok{\#\# compare with gnps, so add noise}
      \FunctionTok{library}\NormalTok{(tidyverse)}
      \FunctionTok{library}\NormalTok{(igraph)}
      \FunctionTok{library}\NormalTok{(ggraph)}
      \FunctionTok{library}\NormalTok{(tidygraph)}
      \FunctionTok{library}\NormalTok{(ggsci)}
      \FunctionTok{library}\NormalTok{(scales)}
      \FunctionTok{library}\NormalTok{(stringr)}
      \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{      pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{      pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{      pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{      pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{      palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
\NormalTok{      nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{      nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{      nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{      nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{      nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{      edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{      edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{      cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{      network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
        \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{        network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
          \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{        network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{        layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"mds"}\NormalTok{)}
        \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{        p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
          \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
          \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(superclass, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
          \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
          \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
          \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
          \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
          \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
          \CommentTok{\#guides(size="none") +}
          \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Superclass"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
          \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
          \FunctionTok{theme}\NormalTok{(}
                \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
                \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
                \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
                \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
                \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
                \CommentTok{\#axis.line = element\_blank(),}
                \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
                \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
                \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
                \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
                \CommentTok{\#legend.position = c(0.6,0.25),}
                \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
                \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{          )}
          \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
          \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"parent\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{16}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggraph_gnps_merge.r}{%
\section{File: ggraph\_gnps\_merge.R}\label{file-ggraph_gnps_merge.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
 \CommentTok{\#lai; palette= unique(c(pal1[c(6:8,9:10,1:4,11:16)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 \CommentTok{\# from mcnebula}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}
 \CommentTok{\# from gnps}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"gnps07\_merge.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{, }\StringTok{"target"}\NormalTok{,  }\StringTok{"delta\_m.z"}\NormalTok{, }\StringTok{"MEH"}\NormalTok{, }\StringTok{"ftalign\_similarity"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}} \FloatTok{0.6808} \SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges)}
 \CommentTok{\# insert the connectionless nodes}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ allid[}\SpecialCharTok{!}\NormalTok{(allid }\SpecialCharTok{\%in\%}\NormalTok{ edges\_id)]}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(cont\_edges\_id)}
 \FunctionTok{colnames}\NormalTok{(cont\_list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{)}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(cont\_list, }\AttributeTok{target=}\NormalTok{source, }\AttributeTok{delta\_m.z=}\DecValTok{0}\NormalTok{, }\AttributeTok{MEH=}\StringTok{"N"}\NormalTok{, }\AttributeTok{ftalign\_similarity=}\DecValTok{1}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], cont\_list)}
 \CommentTok{\# write.table(edges[, c(1,2,5)], file="filter\_net\_0.6808", sep="\textbackslash{}t", quote=F, row.names=F, col.names=F)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{\textquotesingle{}stress\textquotesingle{}}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
   \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
   \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(superclass, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
   \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
   \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
   \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Superclass"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
   \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{theme}\NormalTok{(}
         \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
         \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
         \CommentTok{\#axis.line = element\_blank(),}
         \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
         \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
         \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
         \CommentTok{\#legend.position = c(0.6,0.25),}
         \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{) }
\NormalTok{   )}
   \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
   \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"gnps\_network\_merge07.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{19}\NormalTok{, }\AttributeTok{height=}\DecValTok{16}\NormalTok{)}
\DocumentationTok{\#\# facet plot}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \FunctionTok{library}\NormalTok{(ggimage)}
 \FunctionTok{library}\NormalTok{(gridExtra)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
 \CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification[}\FunctionTok{grep}\NormalTok{(}\StringTok{"null"}\NormalTok{, nodes2}\SpecialCharTok{$}\NormalTok{classification)] }\OtherTok{\textless{}{-}} \StringTok{"Undifined"}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
 \CommentTok{\# edge \textless{}{-} list()}
 \DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{ pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{ plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(edge\_list))\{}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{ layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}} 
 \FunctionTok{ggraph}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\NormalTok{classification), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \CommentTok{\# geom\_node\_text(aes(label=name),size=3) +}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{str\_wrap}\NormalTok{(facet, }\AttributeTok{width=}\DecValTok{30}\NormalTok{)) }\SpecialCharTok{+} 
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \CommentTok{\# ggsave(plot[[i]], file="test.svg", width=5, height=5)}
 \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) \}}
 \CommentTok{\# theme\_graph(base\_family = "Times", }
 \CommentTok{\#       foreground = "\#8491B4FF",}
 \CommentTok{\#       strip\_text\_size = 20,}
 \CommentTok{\#       fg\_text\_colour = "white",}
 \CommentTok{\#       plot\_margin = margin(10, 10, 10, 10))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \CommentTok{\#png("test.png", width=1000, height=1000)}
 \CommentTok{\#tiff("merge\_grey.tiff", width=2000, height=2200, compression="lzw")}
 \FunctionTok{svg}\NormalTok{(}\StringTok{"gnps\_child\_nebula.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{18}\SpecialCharTok{*}\FloatTok{1.6}\NormalTok{, }\AttributeTok{height=}\DecValTok{22}\SpecialCharTok{*}\FloatTok{1.5}\NormalTok{)}
\NormalTok{ n}\OtherTok{=}\FunctionTok{length}\NormalTok{(edge\_list)}
\NormalTok{ s}\OtherTok{=}\NormalTok{n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{); }\ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(s)}\SpecialCharTok{!=}\NormalTok{s)\{s}\OtherTok{=}\FunctionTok{round}\NormalTok{(s); ss}\OtherTok{=}\NormalTok{s}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{ss}\OtherTok{=}\NormalTok{s\}}
 \FunctionTok{grid.newpage}\NormalTok{()}
 \FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(ss, s)))}
\NormalTok{ r\_ss}\OtherTok{=}\DecValTok{1}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{ c\_s}\OtherTok{=}\NormalTok{i}\SpecialCharTok{\%\%}\NormalTok{s}
 \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{c\_s}\OtherTok{=}\NormalTok{s\}}
 \FunctionTok{print}\NormalTok{( plot[[i]], }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\NormalTok{r\_ss, }\AttributeTok{layout.pos.col=}\NormalTok{c\_s ))}
 \FunctionTok{cat}\NormalTok{(}\StringTok{"push view port of "}\NormalTok{,i,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
 \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\NormalTok{s)\{ r\_ss}\OtherTok{=}\NormalTok{r\_ss}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{ \}}
 \FunctionTok{dev.off}\NormalTok{()}
 \DocumentationTok{\#\# zoom the specific class }
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \FunctionTok{library}\NormalTok{(ggimage)}
 \FunctionTok{library}\NormalTok{(grImport2)}
 \FunctionTok{library}\NormalTok{(gridSVG)}
 \FunctionTok{library}\NormalTok{(rsvg)}
 \FunctionTok{library}\NormalTok{(gridExtra)}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
 \CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
 \CommentTok{\# edge \textless{}{-} list()}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{similarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"null"}\NormalTok{, }\StringTok{"Undefined"}\NormalTok{, nodes}\SpecialCharTok{$}\NormalTok{classification)}
 \DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{ pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{ select1}\OtherTok{=}\StringTok{"Iridoids and derivatives.tsv"}
\NormalTok{ select2}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{ select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{ plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{ stru\_path}\OtherTok{=}\StringTok{"structure\_2d/smiles\_draw"}
\NormalTok{ structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ stru\_path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"canopus\_pp\_filter.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(canopus\_set)}
 \FunctionTok{colnames}\NormalTok{(canopus\_set)}\OtherTok{=}\FunctionTok{as.character}\NormalTok{(canopus\_set[}\DecValTok{1}\NormalTok{,])}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{ metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{ metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"C"}\NormalTok{,metadata}\SpecialCharTok{$}\NormalTok{absoluteIndex)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# start plot}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ select\_list)\{}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{ layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\# figure elements}
 \DocumentationTok{\#\#\# structure}
\NormalTok{ elements }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n[,}\FunctionTok{colnames}\NormalTok{(layout\_n) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"classification"}\NormalTok{)]}
\NormalTok{ elements}\SpecialCharTok{$}\NormalTok{link\_structure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)}
\NormalTok{ grid\_elements }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, matrix, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"link\_structure"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"structure\_list"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
 \DocumentationTok{\#\#\# grobify}
\NormalTok{ structure\_p}\OtherTok{\textless{}{-}}\FunctionTok{list}\NormalTok{()}
\NormalTok{ list\_stru }\OtherTok{\textless{}{-}}\NormalTok{ grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(grid\_elements) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"link\_structure"}\NormalTok{)]}
 \CommentTok{\#grid.picture(readPicture(paste0(stru\_path,"/",j)))}
 \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ list\_stru)\{}
\NormalTok{   id}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(j, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
   \CommentTok{\#structure\_p[[as.numeric(id)]] = grobify(readPicture(paste0(path,"/",j)))}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,id), }\FunctionTok{grobify}\NormalTok{(}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{,j))))}
   \FunctionTok{cat}\NormalTok{(id,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{, }\StringTok{"structure\_p}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{ \}}
\NormalTok{ aes\_stru }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{),], }\AttributeTok{grob=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,name))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\# ring\_bar plot}
\NormalTok{ ring\_data }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[,}\FunctionTok{colnames}\NormalTok{(canopus\_set) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name)]}
\NormalTok{ list\_palette }\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification)), palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification))]))}
 \FunctionTok{colnames}\NormalTok{(list\_palette) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"classification"}\NormalTok{, }\StringTok{"color"}\NormalTok{)}
\NormalTok{ elements\_palette }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, list\_palette, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"classification"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
 \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{ id }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(ring\_data)[j]}
\NormalTok{ fill\_in}\OtherTok{=}\NormalTok{elements\_palette[}\FunctionTok{which}\NormalTok{(elements\_palette}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}\SpecialCharTok{$}\NormalTok{color}
\NormalTok{ fill\_border}\OtherTok{=}\StringTok{"black"}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(ring\_data[,}\FunctionTok{colnames}\NormalTok{(ring\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(id)])}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{class=}\FunctionTok{rownames}\NormalTok{(df))}
 \FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}\StringTok{"class"}\NormalTok{)}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"class"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{num),]}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class, }\StringTok{": "}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fill, }\AttributeTok{levels=}\NormalTok{df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{absoluteIndex), }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"fill"}\NormalTok{)])}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\NormalTok{value)) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{), }\AttributeTok{fill =}\NormalTok{fill\_in) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{), }\AttributeTok{fill=}\NormalTok{fill\_border) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{fill), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.02}\NormalTok{) }\SpecialCharTok{+}
          \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \CommentTok{\#annotate("text", x=df[nrow(df), colnames(df) \%in\% "num"], y={-}1,}
      \CommentTok{\#         label=paste0("ID: ", id), hjust=0, family="Times", fontface="bold", size=0.7, alpha=0.5) +}
      \CommentTok{\#scale\_fill\_gsea() +}
      \CommentTok{\#geom\_text(data=df, aes(x=class, y=value+0.1, label=ifelse(value\textgreater{}0.7, class, "")),}
    \CommentTok{\#       color="black", fontface="bold",alpha=0.6, size=0.3, inherit.aes = FALSE ) +}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \CommentTok{\#plot.background = element\_rect(fill = "transparent"),}
        \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
        \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
        \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{) }\CommentTok{\# Adjust the margin to make in sort labels are not truncated!}
\NormalTok{      )}
 \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id), p) \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}
 \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+}
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity, }\AttributeTok{label=}\NormalTok{delta\_m.z), }\AttributeTok{label\_size=}\FloatTok{0.7}\NormalTok{, }\AttributeTok{label\_alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+}
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+}
 \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{facet) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Access classes"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
 \CommentTok{\#guides(size="none", fill="none") +}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
       \CommentTok{\#panel.background = element\_rect(fill="white"),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \CommentTok{\#panel.grid = element\_blank(),}
       \CommentTok{\#legend.position = "none",}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
       \CommentTok{\#plot.margin =unit(c(0,0,0,0),"cm"),}
       \CommentTok{\#panel.spacing =unit(c(0,0,0,0),"cm")}
\NormalTok{      )}
 \FunctionTok{assign}\NormalTok{(}\StringTok{"find\_id"}\NormalTok{, plot[[i]])}
 \CommentTok{\#plot[[i]] \textless{}{-} plot[[i]] + geom\_subview(x=aes\_ring$x{-}(size/4.7)*1.05, y=aes\_ring$y{-}(size/4.7)*1.05,}
        \CommentTok{\#           subview=get(paste0("ring\_", id)), width=size*4.5*1.05, height=size*4.5*1.05 )}
 \CommentTok{\#ggsave(plot[[i]], file="test.svg", width=7, height=5)}
\NormalTok{ min}\OtherTok{=}\FunctionTok{min}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{ delta}\OtherTok{=}\FunctionTok{max}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}\SpecialCharTok{{-}}\NormalTok{min}
\NormalTok{ step}\OtherTok{=}\DecValTok{1}\SpecialCharTok{/}\NormalTok{delta}
 \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{39} \SpecialCharTok{|}\NormalTok{ i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{)\{p\_size}\OtherTok{=}\FloatTok{0.85}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.105}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{p\_size}\OtherTok{=}\FloatTok{0.65}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.09}\NormalTok{\}}
 \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{ id}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(ring\_data)[k]}
\NormalTok{ aes\_ring}\OtherTok{=}\NormalTok{elements[}\FunctionTok{which}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}
\NormalTok{ size}\OtherTok{=}\NormalTok{(aes\_ring}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{{-}}\NormalTok{min)}\SpecialCharTok{*}\NormalTok{step}\SpecialCharTok{+}\NormalTok{p\_size}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{x}\SpecialCharTok{{-}}\NormalTok{p\_dist, }\AttributeTok{y=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{y}\SpecialCharTok{{-}}\NormalTok{p\_dist,}
                    \AttributeTok{subview=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id)), }\AttributeTok{width=}\NormalTok{size, }\AttributeTok{height=}\NormalTok{size )  \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(aes\_stru))\{}
\NormalTok{ size}\OtherTok{=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{similarity}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{y,}
                    \AttributeTok{subview=}\FunctionTok{arrangeGrob}\NormalTok{( }\FunctionTok{get}\NormalTok{(aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{grob) ), }\AttributeTok{width=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{) \}}
 \CommentTok{\# plot[[i]] \textless{}{-} plot[[i]] + facet\_zoom(xlim = c(2, 4), ylim=c(5,7))}
 \FunctionTok{ggsave}\NormalTok{(plot[[i]], }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"gnps\_zoom\_"}\NormalTok{,i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{7}\NormalTok{, }\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
 \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{ \}}
\NormalTok{ p }\OtherTok{\textless{}{-}}\NormalTok{ find\_id }\SpecialCharTok{+} \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{3}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\# add noise (other class)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
 \CommentTok{\#lai; palette= unique(c(pal1[c(6:8,9:10,1:4,11:16)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 \CommentTok{\# from mcnebula}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}
 \CommentTok{\# from gnps}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"gnps04.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{, }\StringTok{"target"}\NormalTok{,  }\StringTok{"delta\_m.z"}\NormalTok{, }\StringTok{"MEH"}\NormalTok{, }\StringTok{"ftalign\_similarity"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}} \FloatTok{0.6808} \SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges)}
 \CommentTok{\# insert the connectionless nodes}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ allid[}\SpecialCharTok{!}\NormalTok{(allid }\SpecialCharTok{\%in\%}\NormalTok{ edges\_id)]}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(cont\_edges\_id)}
 \FunctionTok{colnames}\NormalTok{(cont\_list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{)}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(cont\_list, }\AttributeTok{target=}\NormalTok{source, }\AttributeTok{delta\_m.z=}\DecValTok{0}\NormalTok{, }\AttributeTok{MEH=}\StringTok{"N"}\NormalTok{, }\AttributeTok{ftalign\_similarity=}\DecValTok{1}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], cont\_list)}
 \CommentTok{\# add lignans and iridoids}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{,}\DecValTok{41}\NormalTok{))\{}
\NormalTok{   ed }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   ed\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ed}\SpecialCharTok{$}\NormalTok{source, ed}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{   allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(allid, ed\_id)}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"from\_"}\NormalTok{, i), ed\_id)}
\NormalTok{ \}}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(allid)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(nodes, }\AttributeTok{from\_class=}
                 \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_34, }\StringTok{"Iridoids"}\NormalTok{,}
                        \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_39, }\StringTok{"Lignans"}\NormalTok{, }
                               \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_41, }\StringTok{"Long{-}chain fatty acids"}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{                        )}
\NormalTok{                        ))}
 
 \CommentTok{\# write.table(edges[, c(1,2,5)], file="filter\_net\_0.6808", sep="\textbackslash{}t", quote=F, row.names=F, col.names=F)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{\textquotesingle{}fr\textquotesingle{}}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+}
   \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+}
   \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(from\_class, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+}
   \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
   \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+}
   \CommentTok{\#facet\_nodes(\textasciitilde{}classification) +}
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"From class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
   \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{theme}\NormalTok{(}
         \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
         \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{),}
         \CommentTok{\#axis.line = element\_blank(),}
         \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
         \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
         \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
         \CommentTok{\#legend.position = c(0.6,0.25),}
         \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{   )}
   \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
   \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"gnps\_add\_noise\_34\_39\_41.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{10}\NormalTok{)}
   \CommentTok{\#ggsave(p, file="test\_gnps\_add\_noise\_34\_39.svg", width=12, height=10)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggraph_gnps.r}{%
\section{File: ggraph\_gnps.R}\label{file-ggraph_gnps.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
 \CommentTok{\#lai; palette= unique(c(pal1[c(6:8,9:10,1:4,11:16)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 \CommentTok{\# from mcnebula}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}
 \CommentTok{\# from gnps}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"gnps04.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{, }\StringTok{"target"}\NormalTok{,  }\StringTok{"delta\_m.z"}\NormalTok{, }\StringTok{"MEH"}\NormalTok{, }\StringTok{"ftalign\_similarity"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}} \FloatTok{0.6808} \SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges)}
 \CommentTok{\# insert the connectionless nodes}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ allid[}\SpecialCharTok{!}\NormalTok{(allid }\SpecialCharTok{\%in\%}\NormalTok{ edges\_id)]}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(cont\_edges\_id)}
 \FunctionTok{colnames}\NormalTok{(cont\_list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{)}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(cont\_list, }\AttributeTok{target=}\NormalTok{source, }\AttributeTok{delta\_m.z=}\DecValTok{0}\NormalTok{, }\AttributeTok{MEH=}\StringTok{"N"}\NormalTok{, }\AttributeTok{ftalign\_similarity=}\DecValTok{1}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], cont\_list)}
 \CommentTok{\# write.table(edges[, c(1,2,5)], file="filter\_net\_0.6808", sep="\textbackslash{}t", quote=F, row.names=F, col.names=F)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{\textquotesingle{}mds\textquotesingle{}}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
   \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
   \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(superclass, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
   \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
   \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
   \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Superclass"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
   \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{theme}\NormalTok{(}
         \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
         \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
         \CommentTok{\#axis.line = element\_blank(),}
         \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
         \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
         \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
         \CommentTok{\#legend.position = c(0.6,0.25),}
         \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{) }
\NormalTok{   )}
   \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
   \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"gnps\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{19}\NormalTok{, }\AttributeTok{height=}\DecValTok{16}\NormalTok{)}
\DocumentationTok{\#\# facet plot}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \FunctionTok{library}\NormalTok{(ggimage)}
 \FunctionTok{library}\NormalTok{(gridExtra)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
 \CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification[}\FunctionTok{grep}\NormalTok{(}\StringTok{"null"}\NormalTok{, nodes2}\SpecialCharTok{$}\NormalTok{classification)] }\OtherTok{\textless{}{-}} \StringTok{"Undifined"}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
 \CommentTok{\# edge \textless{}{-} list()}
 \DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{ pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{ plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(edge\_list))\{}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{ layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}} 
 \FunctionTok{ggraph}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\NormalTok{classification), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \CommentTok{\# geom\_node\_text(aes(label=name),size=3) +}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{str\_wrap}\NormalTok{(facet, }\AttributeTok{width=}\DecValTok{30}\NormalTok{)) }\SpecialCharTok{+} 
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \CommentTok{\# ggsave(plot[[i]], file="test.svg", width=5, height=5)}
 \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) \}}
 \CommentTok{\# theme\_graph(base\_family = "Times", }
 \CommentTok{\#       foreground = "\#8491B4FF",}
 \CommentTok{\#       strip\_text\_size = 20,}
 \CommentTok{\#       fg\_text\_colour = "white",}
 \CommentTok{\#       plot\_margin = margin(10, 10, 10, 10))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \CommentTok{\#png("test.png", width=1000, height=1000)}
 \CommentTok{\#tiff("merge\_grey.tiff", width=2000, height=2200, compression="lzw")}
 \FunctionTok{svg}\NormalTok{(}\StringTok{"gnps\_child\_nebula.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{18}\SpecialCharTok{*}\FloatTok{1.6}\NormalTok{, }\AttributeTok{height=}\DecValTok{22}\SpecialCharTok{*}\FloatTok{1.5}\NormalTok{)}
\NormalTok{ n}\OtherTok{=}\FunctionTok{length}\NormalTok{(edge\_list)}
\NormalTok{ s}\OtherTok{=}\NormalTok{n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{); }\ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(s)}\SpecialCharTok{!=}\NormalTok{s)\{s}\OtherTok{=}\FunctionTok{round}\NormalTok{(s); ss}\OtherTok{=}\NormalTok{s}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{ss}\OtherTok{=}\NormalTok{s\}}
 \FunctionTok{grid.newpage}\NormalTok{()}
 \FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(ss, s)))}
\NormalTok{ r\_ss}\OtherTok{=}\DecValTok{1}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{ c\_s}\OtherTok{=}\NormalTok{i}\SpecialCharTok{\%\%}\NormalTok{s}
 \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{c\_s}\OtherTok{=}\NormalTok{s\}}
 \FunctionTok{print}\NormalTok{( plot[[i]], }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\NormalTok{r\_ss, }\AttributeTok{layout.pos.col=}\NormalTok{c\_s ))}
 \FunctionTok{cat}\NormalTok{(}\StringTok{"push view port of "}\NormalTok{,i,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
 \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\NormalTok{s)\{ r\_ss}\OtherTok{=}\NormalTok{r\_ss}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{ \}}
 \FunctionTok{dev.off}\NormalTok{()}
 \DocumentationTok{\#\# zoom the specific class }
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \FunctionTok{library}\NormalTok{(ggimage)}
 \FunctionTok{library}\NormalTok{(grImport2)}
 \FunctionTok{library}\NormalTok{(gridSVG)}
 \FunctionTok{library}\NormalTok{(rsvg)}
 \FunctionTok{library}\NormalTok{(gridExtra)}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
 \CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
 \CommentTok{\# edge \textless{}{-} list()}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{similarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"null"}\NormalTok{, }\StringTok{"Undefined"}\NormalTok{, nodes}\SpecialCharTok{$}\NormalTok{classification)}
 \DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{ pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{ select1}\OtherTok{=}\StringTok{"Iridoids and derivatives.tsv"}
\NormalTok{ select2}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{ select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{ plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{ stru\_path}\OtherTok{=}\StringTok{"structure\_2d/smiles\_draw"}
\NormalTok{ structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ stru\_path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"canopus\_pp\_filter.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(canopus\_set)}
 \FunctionTok{colnames}\NormalTok{(canopus\_set)}\OtherTok{=}\FunctionTok{as.character}\NormalTok{(canopus\_set[}\DecValTok{1}\NormalTok{,])}
\NormalTok{ canopus\_set }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{ metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{ metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"C"}\NormalTok{,metadata}\SpecialCharTok{$}\NormalTok{absoluteIndex)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# start plot}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ select\_list)\{}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{ layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\# figure elements}
 \DocumentationTok{\#\#\# structure}
\NormalTok{ elements }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n[,}\FunctionTok{colnames}\NormalTok{(layout\_n) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"classification"}\NormalTok{)]}
\NormalTok{ elements}\SpecialCharTok{$}\NormalTok{link\_structure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)}
\NormalTok{ grid\_elements }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, matrix, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"link\_structure"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"structure\_list"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
 \DocumentationTok{\#\#\# grobify}
\NormalTok{ structure\_p}\OtherTok{\textless{}{-}}\FunctionTok{list}\NormalTok{()}
\NormalTok{ list\_stru }\OtherTok{\textless{}{-}}\NormalTok{ grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(grid\_elements) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"link\_structure"}\NormalTok{)]}
 \CommentTok{\#grid.picture(readPicture(paste0(stru\_path,"/",j)))}
 \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ list\_stru)\{}
\NormalTok{   id}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(j, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
   \CommentTok{\#structure\_p[[as.numeric(id)]] = grobify(readPicture(paste0(path,"/",j)))}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,id), }\FunctionTok{grobify}\NormalTok{(}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{,j))))}
   \FunctionTok{cat}\NormalTok{(id,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{, }\StringTok{"structure\_p}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{ \}}
\NormalTok{ aes\_stru }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{),], }\AttributeTok{grob=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,name))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\# ring\_bar plot}
\NormalTok{ ring\_data }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[,}\FunctionTok{colnames}\NormalTok{(canopus\_set) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name)]}
\NormalTok{ list\_palette }\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification)), palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification))]))}
 \FunctionTok{colnames}\NormalTok{(list\_palette) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"classification"}\NormalTok{, }\StringTok{"color"}\NormalTok{)}
\NormalTok{ elements\_palette }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, list\_palette, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"classification"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
 \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{ id }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(ring\_data)[j]}
\NormalTok{ fill\_in}\OtherTok{=}\NormalTok{elements\_palette[}\FunctionTok{which}\NormalTok{(elements\_palette}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}\SpecialCharTok{$}\NormalTok{color}
\NormalTok{ fill\_border}\OtherTok{=}\StringTok{"black"}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(ring\_data[,}\FunctionTok{colnames}\NormalTok{(ring\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(id)])}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{class=}\FunctionTok{rownames}\NormalTok{(df))}
 \FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}\StringTok{"class"}\NormalTok{)}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"class"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{ df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{num),]}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class, }\StringTok{": "}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{ df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fill, }\AttributeTok{levels=}\NormalTok{df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{absoluteIndex), }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"fill"}\NormalTok{)])}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\NormalTok{value)) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{), }\AttributeTok{fill =}\NormalTok{fill\_in) }\SpecialCharTok{+}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{), }\AttributeTok{fill=}\NormalTok{fill\_border) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{fill), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.02}\NormalTok{) }\SpecialCharTok{+}
          \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \CommentTok{\#annotate("text", x=df[nrow(df), colnames(df) \%in\% "num"], y={-}1,}
      \CommentTok{\#         label=paste0("ID: ", id), hjust=0, family="Times", fontface="bold", size=0.7, alpha=0.5) +}
      \CommentTok{\#scale\_fill\_gsea() +}
      \CommentTok{\#geom\_text(data=df, aes(x=class, y=value+0.1, label=ifelse(value\textgreater{}0.7, class, "")),}
    \CommentTok{\#       color="black", fontface="bold",alpha=0.6, size=0.3, inherit.aes = FALSE ) +}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \CommentTok{\#plot.background = element\_rect(fill = "transparent"),}
        \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.major =}\FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
        \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
        \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{) }\CommentTok{\# Adjust the margin to make in sort labels are not truncated!}
\NormalTok{      )}
 \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id), p) \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}
 \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+}
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity, }\AttributeTok{label=}\NormalTok{delta\_m.z), }\AttributeTok{label\_size=}\FloatTok{0.7}\NormalTok{, }\AttributeTok{label\_alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+}
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+}
 \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{facet) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Access classes"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
 \CommentTok{\#guides(size="none", fill="none") +}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
       \CommentTok{\#panel.background = element\_rect(fill="white"),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \CommentTok{\#panel.grid = element\_blank(),}
       \CommentTok{\#legend.position = "none",}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
       \CommentTok{\#plot.margin =unit(c(0,0,0,0),"cm"),}
       \CommentTok{\#panel.spacing =unit(c(0,0,0,0),"cm")}
\NormalTok{      )}
 \FunctionTok{assign}\NormalTok{(}\StringTok{"find\_id"}\NormalTok{, plot[[i]])}
 \CommentTok{\#plot[[i]] \textless{}{-} plot[[i]] + geom\_subview(x=aes\_ring$x{-}(size/4.7)*1.05, y=aes\_ring$y{-}(size/4.7)*1.05,}
        \CommentTok{\#           subview=get(paste0("ring\_", id)), width=size*4.5*1.05, height=size*4.5*1.05 )}
 \CommentTok{\#ggsave(plot[[i]], file="test.svg", width=7, height=5)}
\NormalTok{ min}\OtherTok{=}\FunctionTok{min}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{ delta}\OtherTok{=}\FunctionTok{max}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}\SpecialCharTok{{-}}\NormalTok{min}
\NormalTok{ step}\OtherTok{=}\DecValTok{1}\SpecialCharTok{/}\NormalTok{delta}
 \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{39} \SpecialCharTok{|}\NormalTok{ i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{)\{p\_size}\OtherTok{=}\FloatTok{0.85}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.105}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{p\_size}\OtherTok{=}\FloatTok{0.65}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.09}\NormalTok{\}}
 \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{ id}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(ring\_data)[k]}
\NormalTok{ aes\_ring}\OtherTok{=}\NormalTok{elements[}\FunctionTok{which}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}
\NormalTok{ size}\OtherTok{=}\NormalTok{(aes\_ring}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{{-}}\NormalTok{min)}\SpecialCharTok{*}\NormalTok{step}\SpecialCharTok{+}\NormalTok{p\_size}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{x}\SpecialCharTok{{-}}\NormalTok{p\_dist, }\AttributeTok{y=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{y}\SpecialCharTok{{-}}\NormalTok{p\_dist,}
                    \AttributeTok{subview=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id)), }\AttributeTok{width=}\NormalTok{size, }\AttributeTok{height=}\NormalTok{size )  \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(aes\_stru))\{}
\NormalTok{ size}\OtherTok{=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{similarity}
\NormalTok{ plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{y,}
                    \AttributeTok{subview=}\FunctionTok{arrangeGrob}\NormalTok{( }\FunctionTok{get}\NormalTok{(aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{grob) ), }\AttributeTok{width=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{) \}}
 \CommentTok{\# plot[[i]] \textless{}{-} plot[[i]] + facet\_zoom(xlim = c(2, 4), ylim=c(5,7))}
 \FunctionTok{ggsave}\NormalTok{(plot[[i]], }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"gnps\_zoom\_"}\NormalTok{,i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{7}\NormalTok{, }\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
 \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{ \}}
\NormalTok{ p }\OtherTok{\textless{}{-}}\NormalTok{ find\_id }\SpecialCharTok{+} \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{3}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\# add noise (other class)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
 \CommentTok{\#lai; palette= unique(c(pal1[c(6:8,9:10,1:4,11:16)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 \CommentTok{\# from mcnebula}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}
 \CommentTok{\# from gnps}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"gnps04.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{, }\StringTok{"target"}\NormalTok{,  }\StringTok{"delta\_m.z"}\NormalTok{, }\StringTok{"MEH"}\NormalTok{, }\StringTok{"ftalign\_similarity"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}} \FloatTok{0.6808} \SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges)}
 \CommentTok{\# insert the connectionless nodes}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ allid[}\SpecialCharTok{!}\NormalTok{(allid }\SpecialCharTok{\%in\%}\NormalTok{ edges\_id)]}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(cont\_edges\_id)}
 \FunctionTok{colnames}\NormalTok{(cont\_list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{)}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(cont\_list, }\AttributeTok{target=}\NormalTok{source, }\AttributeTok{delta\_m.z=}\DecValTok{0}\NormalTok{, }\AttributeTok{MEH=}\StringTok{"N"}\NormalTok{, }\AttributeTok{ftalign\_similarity=}\DecValTok{1}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], cont\_list)}
 \CommentTok{\# add lignans and iridoids}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{,}\DecValTok{41}\NormalTok{))\{}
\NormalTok{   ed }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   ed\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ed}\SpecialCharTok{$}\NormalTok{source, ed}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{   allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(allid, ed\_id)}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"from\_"}\NormalTok{, i), ed\_id)}
\NormalTok{ \}}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(allid)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(nodes, }\AttributeTok{from\_class=}
                 \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_34, }\StringTok{"Iridoids"}\NormalTok{,}
                        \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_39, }\StringTok{"Lignans"}\NormalTok{, }
                               \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_41, }\StringTok{"Long{-}chain fatty acids"}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{                        )}
\NormalTok{                        ))}
 
 \CommentTok{\# write.table(edges[, c(1,2,5)], file="filter\_net\_0.6808", sep="\textbackslash{}t", quote=F, row.names=F, col.names=F)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{\textquotesingle{}fr\textquotesingle{}}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+}
   \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+}
   \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(from\_class, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{filter=}\NormalTok{name}\SpecialCharTok{==}\DecValTok{1746}\SpecialCharTok{|}\NormalTok{name}\SpecialCharTok{==}\DecValTok{2081}\NormalTok{,}\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+}
   \CommentTok{\#facet\_nodes(\textasciitilde{}classification) +}
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"From class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{theme}\NormalTok{(}
         \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
         \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{),}
         \CommentTok{\#axis.line = element\_blank(),}
         \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
         \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
         \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
         \CommentTok{\#legend.position = c(0.6,0.25),}
         \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{   )}
   \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
   \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"tt\_gnps\_add\_noise\_34\_39\_41.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{10}\NormalTok{)}
   \CommentTok{\#ggsave(p, file="test\_gnps\_add\_noise\_34\_39.svg", width=12, height=10)}

\DocumentationTok{\#\# scale change}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
 \CommentTok{\#lai; palette= unique(c(pal1[c(6:8,9:10,1:4,11:16)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 \CommentTok{\# from mcnebula}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.1.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity}\SpecialCharTok{\textgreater{}=}\FloatTok{0.3}\NormalTok{),]}

\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}
 \CommentTok{\# from gnps}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"gnps04.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{, }\StringTok{"target"}\NormalTok{,  }\StringTok{"delta\_m.z"}\NormalTok{, }\StringTok{"MEH"}\NormalTok{, }\StringTok{"ftalign\_similarity"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}} \FloatTok{0.5074} \SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges)}
 \CommentTok{\# insert the connectionless nodes}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ allid[}\SpecialCharTok{!}\NormalTok{(allid }\SpecialCharTok{\%in\%}\NormalTok{ edges\_id)]}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(cont\_edges\_id)}
 \FunctionTok{colnames}\NormalTok{(cont\_list) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"source"}\NormalTok{)}
\NormalTok{ cont\_list }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(cont\_list, }\AttributeTok{target=}\NormalTok{source, }\AttributeTok{delta\_m.z=}\DecValTok{0}\NormalTok{, }\AttributeTok{MEH=}\StringTok{"N"}\NormalTok{, }\AttributeTok{ftalign\_similarity=}\DecValTok{1}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], cont\_list)}
 \CommentTok{\# add lignans and iridoids}
\NormalTok{ path}\OtherTok{=}\StringTok{"gnps\_network\_facet\_0.5"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{,}\DecValTok{41}\NormalTok{))\{}
\NormalTok{   ed }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   ed\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ed}\SpecialCharTok{$}\NormalTok{source, ed}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{   allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(allid, ed\_id)}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"from\_"}\NormalTok{, i), ed\_id)}
\NormalTok{ \}}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(allid)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(nodes, }\AttributeTok{from\_class=}
                 \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_34, }\StringTok{"Iridoids"}\NormalTok{,}
                        \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_39, }\StringTok{"Lignans"}\NormalTok{, }
                               \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_41, }\StringTok{"Long{-}chain fatty acids"}\NormalTok{, }\ConstantTok{NA} 
\NormalTok{                               )}
\NormalTok{                        )}
\NormalTok{                        ))}
 
 \CommentTok{\# write.table(edges[, c(1,2,5)], file="filter\_net\_0.6808", sep="\textbackslash{}t", quote=F, row.names=F, col.names=F)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{\textquotesingle{}fr\textquotesingle{}}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+}
   \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+}
   \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(from\_class, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
   \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+}
   \CommentTok{\#facet\_nodes(\textasciitilde{}classification) +}
   \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"From class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
   \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
   \FunctionTok{theme}\NormalTok{(}
         \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
         \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{),}
         \CommentTok{\#axis.line = element\_blank(),}
         \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
         \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
         \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
         \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
         \CommentTok{\#legend.position = c(0.6,0.25),}
         \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
         \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{   )}
   \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
   \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"tt05\_gnps\_add\_noise\_34\_39\_41.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggraph_network.r}{%
\section{File: ggraph\_network.R}\label{file-ggraph_network.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(dplyr)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analysis}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"mds"}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(superclass, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \CommentTok{\#guides(size="none") +}
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Superclass"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
       \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
       \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"parent\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{16}\NormalTok{)}



 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \DocumentationTok{\#\# select the specific class}
\NormalTok{ path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{,}\DecValTok{41}\NormalTok{))\{}
\NormalTok{   ed }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   ed\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ed}\SpecialCharTok{$}\NormalTok{source, ed}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{   allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(allid, ed\_id)}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"from\_"}\NormalTok{, i), ed\_id)}
\NormalTok{ \}}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(allid)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(nodes, }\AttributeTok{from\_class=}
                 \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_34, }\StringTok{"Iridoids"}\NormalTok{,}
                        \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_39, }\StringTok{"Lignans"}\NormalTok{, }
                               \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_41, }\StringTok{"Long{-}chain fatty acids"}\NormalTok{, }\ConstantTok{NA}\NormalTok{)}
\NormalTok{                               )}
\NormalTok{                        ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"fr"}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(from\_class, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{filter=}\NormalTok{ name}\SpecialCharTok{==}\DecValTok{1746}\SpecialCharTok{|}\NormalTok{name}\SpecialCharTok{==}\DecValTok{2081}\NormalTok{, }\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
 \CommentTok{\#guides(size="none") +}
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{10}\NormalTok{))) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"From class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
       \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
       \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
       \CommentTok{\#legend.position = c(0.6,0.25),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"tt\_mcnebula\_add\_noise\_34\_39\_41.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{10}\NormalTok{)}
 \CommentTok{\# ggsave(p, file="test\_mcnebula\_add\_noise\_34\_39.svg", width=12, height=10)}

\DocumentationTok{\#\# scale change}
\FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.1.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity}\SpecialCharTok{\textgreater{}=}\FloatTok{0.3}\NormalTok{),]}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
 \FunctionTok{nrow}\NormalTok{(edges[edges}\SpecialCharTok{$}\NormalTok{source}\SpecialCharTok{!=}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{target,])}


 \DocumentationTok{\#\# select the specific class}
\NormalTok{ path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{ edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{,}\DecValTok{41}\NormalTok{))\{}
\NormalTok{   ed }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{   ed\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ed}\SpecialCharTok{$}\NormalTok{source, ed}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{   allid }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(allid, ed\_id)}
   \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"from\_"}\NormalTok{, i), ed\_id)}
\NormalTok{ \}}
\NormalTok{ allid }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(allid)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
 \CommentTok{\# edges id which not find in nodes}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ allid)]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(nodes, }\AttributeTok{from\_class=}
                 \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_34, }\StringTok{"Iridoids"}\NormalTok{,}
                        \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_39, }\StringTok{"Lignans"}\NormalTok{, }
                               \FunctionTok{ifelse}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{id }\SpecialCharTok{\%in\%}\NormalTok{ from\_41, }\StringTok{"Long{-}chain fatty acids"}\NormalTok{, }\ConstantTok{NA}
\NormalTok{                               )}
\NormalTok{                               )}
\NormalTok{                        ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  only show pp \textgreater{} 0.9}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"fr"}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(from\_class, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{filter=}\NormalTok{ name}\SpecialCharTok{==}\DecValTok{1746}\SpecialCharTok{|}\NormalTok{name}\SpecialCharTok{==}\DecValTok{2081}\NormalTok{, }\AttributeTok{label=}\NormalTok{name),}\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
 \CommentTok{\#guides(size="none") +}
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"From class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
       \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
       \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
       \CommentTok{\#legend.position = c(0.6,0.25),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"tt03\_mcnebula\_add\_noise\_34\_39\_41.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ggraph_zoom.r}{%
\section{File: ggraph\_zoom.R}\label{file-ggraph_zoom.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(gridSVG)}
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_0.3"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# facet\_group \textless{}{-} read.csv(file="../for\_violin.tsv", header=T,sep="\textbackslash{}t")}
\CommentTok{\# facet\_group \textless{}{-} facet\_group[order(facet\_group$classification),] }\AlertTok{\#\#\#}\CommentTok{ lead}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"../com\_compound.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{stru\_path}\OtherTok{=}\StringTok{"structure\_2d/smiles\_draw"}
\NormalTok{structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ stru\_path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\# edge \textless{}{-} list()}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal0}\OtherTok{=} \FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal10}\OtherTok{=} \FunctionTok{pal\_igv}\NormalTok{(}\StringTok{"default"}\NormalTok{)(}\DecValTok{51}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal0, pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{select1}\OtherTok{=}\StringTok{"Iridoids and derivatives.tsv"}
\NormalTok{select2}\OtherTok{=}\StringTok{"Lignans, neolignans and related compounds.tsv"}
\NormalTok{select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{i}\OtherTok{=}\DecValTok{34}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{group\_select2 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{3938}\NormalTok{, }\DecValTok{2529}\NormalTok{, }\DecValTok{1445}\NormalTok{)}
\NormalTok{group\_select1 }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{279}\NormalTok{, }\DecValTok{458}\NormalTok{, }\DecValTok{574}\NormalTok{, }\DecValTok{1107}\NormalTok{, }\DecValTok{1445}\NormalTok{, }\DecValTok{2227}\NormalTok{, }\DecValTok{2529}\NormalTok{, }\DecValTok{2664}\NormalTok{, }\DecValTok{2824}\NormalTok{)}
\ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{)\{}
\NormalTok{  select}\OtherTok{=}\NormalTok{group\_select1}
\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{  select}\OtherTok{=}\NormalTok{group\_select2}
\NormalTok{\} }\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# filter}
\FunctionTok{colnames}\NormalTok{(edges)[}\FunctionTok{colnames}\NormalTok{(edges) }\SpecialCharTok{\%in\%} \StringTok{"facet"}\NormalTok{] }\OtherTok{\textless{}{-}} \StringTok{"facet\_c"}
\CommentTok{\# select \textless{}{-} c(3938, 2529, 1445) \#\#\#\#\# lignans}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ select }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ select), ]}
\CommentTok{\#edges2 \textless{}{-} edges[edges$target \%in\% select, ]}
\CommentTok{\#edges \textless{}{-} rbind(edges1, edges2)}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]),]}
\NormalTok{edges\_set }\OtherTok{\textless{}{-}}\NormalTok{ edges}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{tlimit }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\FloatTok{0.1}\NormalTok{)}
\CommentTok{\#for(tlimit in c(0.2, 0.25, 0.3, 0.4))\{}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges\_set[}\FunctionTok{which}\NormalTok{(edges\_set}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}}\NormalTok{ tlimit),] }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{group=}\FunctionTok{ifelse}\NormalTok{(source }\SpecialCharTok{\%in\%}\NormalTok{ select, source, target), }\AttributeTok{group\_sub=}\FunctionTok{ifelse}\NormalTok{(source }\SpecialCharTok{\%in\%}\NormalTok{ select, target, source))}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(edges, nodes[,}\FunctionTok{colnames}\NormalTok{(nodes) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"norm\_delta"}\NormalTok{)], }\AttributeTok{by.x=}\StringTok{"group"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\FunctionTok{colnames}\NormalTok{(edges)[}\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(edges)}\SpecialCharTok{==}\StringTok{"norm\_delta"}\NormalTok{)] }\OtherTok{\textless{}{-}} \StringTok{"norm\_delta\_group"}
\NormalTok{edges }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(edges, nodes[,}\FunctionTok{colnames}\NormalTok{(nodes) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"norm\_delta"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{)], }\AttributeTok{by.x=}\StringTok{"group\_sub"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\FunctionTok{colnames}\NormalTok{(edges)[}\FunctionTok{colnames}\NormalTok{(edges) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"norm\_delta"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"norm\_delta\_group\_sub"}\NormalTok{, }\StringTok{"sub\_similarity"}\NormalTok{)}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{norm\_delta\_group }\SpecialCharTok{*}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{norm\_delta\_group\_sub }\SpecialCharTok{\textless{}} \DecValTok{0}\NormalTok{),]}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(edges))]}
\NormalTok{s\_limit }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{)}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{sub\_similarity }\SpecialCharTok{\textgreater{}}\NormalTok{ s\_limit), ]}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{order}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{group, edges}\SpecialCharTok{$}\NormalTok{norm\_delta\_group\_sub), ]}
\NormalTok{edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}}\NormalTok{ tlimit), ]}
\FunctionTok{write.table}\NormalTok{(edges, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_2d/candidate/"}\NormalTok{, i, }\StringTok{"\_class.tsv"}\NormalTok{), }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{  network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  network\_edges\_filter }\OtherTok{\textless{}{-}}\NormalTok{ network\_edges[}\FunctionTok{which}\NormalTok{(network\_edges}\SpecialCharTok{$}\NormalTok{ftalign\_similarity }\SpecialCharTok{\textgreater{}}\NormalTok{ tlimit),]}
\NormalTok{  list }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(network\_edges\_filter}\SpecialCharTok{$}\NormalTok{from, network\_edges\_filter}\SpecialCharTok{$}\NormalTok{to))}
\NormalTok{  network\_nodes}\SpecialCharTok{$}\NormalTok{rownames}\OtherTok{=}\FunctionTok{rownames}\NormalTok{(network\_nodes)}
\NormalTok{  network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges\_filter) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{))}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"circle"}\NormalTok{)}
\NormalTok{    select }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{group)}
\NormalTok{    outer\_circle }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\NormalTok{(name }\SpecialCharTok{\%in\%}\NormalTok{ select)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{mutate}\NormalTok{(}
             \AttributeTok{x =} \FunctionTok{cos}\NormalTok{((}\FunctionTok{row\_number}\NormalTok{() }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ ( }\FunctionTok{nrow}\NormalTok{(network\_nodes) }\SpecialCharTok{{-}} \FunctionTok{length}\NormalTok{(select) ) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi),}
             \AttributeTok{y =} \FunctionTok{sin}\NormalTok{((}\FunctionTok{row\_number}\NormalTok{() }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/}\NormalTok{ ( }\FunctionTok{nrow}\NormalTok{(network\_nodes) }\SpecialCharTok{{-}} \FunctionTok{length}\NormalTok{(select) ) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{*}\NormalTok{ pi)}
\NormalTok{      )}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      angles }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{360}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{360}\SpecialCharTok{/}\FunctionTok{length}\NormalTok{(select) )}
\NormalTok{      angles }\OtherTok{\textless{}{-}}\NormalTok{ angles[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{      radius }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\FunctionTok{length}\NormalTok{(select))}
\NormalTok{      centers }\OtherTok{\textless{}{-}} \FunctionTok{tibble}\NormalTok{(}
                        \AttributeTok{x =}\NormalTok{ radius }\SpecialCharTok{*} \FunctionTok{cos}\NormalTok{(angles }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi),}
                        \AttributeTok{y =}\NormalTok{ radius }\SpecialCharTok{*} \FunctionTok{sin}\NormalTok{(angles }\SpecialCharTok{/} \DecValTok{180} \SpecialCharTok{*}\NormalTok{ pi)}
\NormalTok{      )}
\NormalTok{      inner\_circle }\OtherTok{\textless{}{-}} \FunctionTok{bind\_cols}\NormalTok{(centers, }\FunctionTok{select}\NormalTok{(}\FunctionTok{filter}\NormalTok{(layout\_n, name }\SpecialCharTok{\%in\%}\NormalTok{ select), }\SpecialCharTok{{-}}\NormalTok{x, }\SpecialCharTok{{-}}\NormalTok{y))}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      layout\_n[] }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(outer\_circle, inner\_circle) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{arrange}\NormalTok{(.ggraph.index)}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      elements }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n[,}\FunctionTok{colnames}\NormalTok{(layout\_n) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{)]}
\NormalTok{      elements}\SpecialCharTok{$}\NormalTok{link\_structure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)}
\NormalTok{      grid\_elements }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, matrix, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"link\_structure"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"structure\_list"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
      \DocumentationTok{\#\#\# grobify}
\NormalTok{      structure\_p}\OtherTok{\textless{}{-}}\FunctionTok{list}\NormalTok{()}
\NormalTok{      list\_stru }\OtherTok{\textless{}{-}}\NormalTok{ grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(grid\_elements) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"link\_structure"}\NormalTok{)]}
      \CommentTok{\# grid.picture(readPicture(paste0(stru\_path,"/",j)))}
      \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ list\_stru)\{}
\NormalTok{        id}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(j, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
        \CommentTok{\#structure\_p[[as.numeric(id)]] = grobify(readPicture(paste0(path,"/",j)))}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,id), }\FunctionTok{grobify}\NormalTok{(}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{,j))))}
        \FunctionTok{cat}\NormalTok{(id,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{, }\StringTok{"structure\_p}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{      aes\_stru }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{),], }\AttributeTok{grob=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,name))}
      \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{      ratio }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(network\_nodes) }\SpecialCharTok{{-}} \FunctionTok{length}\NormalTok{(select))}\SpecialCharTok{/}\FunctionTok{length}\NormalTok{(select)}
\NormalTok{      plot[[i]] }\OtherTok{\textless{}{-}} 
        \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
        \CommentTok{\#geom\_edge\_fan(aes(edge\_width=ftalign\_similarity), label\_alpha=0.3, color="\#4DBBD5FF", show.legend=F) + }
        \FunctionTok{geom\_edge\_diagonal}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity, }\AttributeTok{edge\_color =} \FunctionTok{as.factor}\NormalTok{(group) ), }
                           \AttributeTok{label\_alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{T, }\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{) }\SpecialCharTok{+} 
\CommentTok{\#color="lightblue",}
\CommentTok{\#geom\_node\_point(aes(fill=str\_wrap(classification, width=25), size=similarity), shape=21) + }
\FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{( }\AttributeTok{fill=}\NormalTok{norm\_delta}\SpecialCharTok{*}\FunctionTok{log2}\NormalTok{(}\DecValTok{10}\NormalTok{) ), }\AttributeTok{size=}\FunctionTok{ifelse}\NormalTok{( layout\_n}\SpecialCharTok{$}\NormalTok{name }\SpecialCharTok{\%in\%}\NormalTok{ select, }\DecValTok{40}\NormalTok{, }\DecValTok{40}\SpecialCharTok{*}\FloatTok{4.5}\SpecialCharTok{/}\NormalTok{ratio), }
                \AttributeTok{stroke=}\DecValTok{0}\NormalTok{,}
                \AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
\FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ID: "}\NormalTok{, name, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\StringTok{"simi: "}\NormalTok{, }\FunctionTok{round}\NormalTok{(similarity,}\DecValTok{2}\NormalTok{) )), }
               \AttributeTok{size=}\FunctionTok{ifelse}\NormalTok{(layout\_n}\SpecialCharTok{$}\NormalTok{name }\SpecialCharTok{\%in\%}\NormalTok{ select, }\DecValTok{5}\NormalTok{, }\DecValTok{5}\SpecialCharTok{*}\FloatTok{4.5}\SpecialCharTok{/}\NormalTok{ratio), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
\CommentTok{\#scale\_color\_manual(values=palette) +}
\CommentTok{\# blue green grey yellow red}
\FunctionTok{scale\_fill\_gradientn}\NormalTok{(}\AttributeTok{colors=}\FunctionTok{c}\NormalTok{(}\StringTok{"\#197EC0FF"}\NormalTok{, }\StringTok{"\#B8B8B8FF"}\NormalTok{, }\StringTok{"\#EFC000FF"}\NormalTok{)) }\SpecialCharTok{+}
\FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{scale\_edge\_colour\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{pal1) }\SpecialCharTok{+}
\FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\DecValTok{4}\NormalTok{)) }\SpecialCharTok{+} 
\FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{facet\_c) }\SpecialCharTok{+}
\FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{, }\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{alpha =} \FloatTok{0.6}\NormalTok{))) }\SpecialCharTok{+}
\FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Log2(delta area)"}\NormalTok{, }\AttributeTok{edge\_width=}\StringTok{"Normalized}\SpecialCharTok{\textbackslash{}n}\StringTok{ftalign similarity"}\NormalTok{, }\AttributeTok{edge\_colour=}\StringTok{"From ID"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\FunctionTok{ifelse}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{15}\NormalTok{) ),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
      \CommentTok{\#panel.background = element\_rect(fill="white"), }
      \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
      \CommentTok{\#panel.grid = element\_blank(),}
      \CommentTok{\#legend.position = "none",}
      \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\FunctionTok{ifelse}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{24}\NormalTok{), }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
      \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{) }
\CommentTok{\#assign(paste0("plot\_", tlimit), plot[[i]])}
\CommentTok{\#ggsave(plot\_0.25, file=paste0("tlimit\_", 0.25, ".svg"), width=7, height=5)}
\CommentTok{\#if(tlimit==0.7 \& i==28)\{plot[[i]] \textless{}{-} plot[[i]] + scale\_fill\_gradient(labels = c("low", "", "", "high")) \}}
\CommentTok{\#if(tlimit==0.7 \& i==26)\{plot[[i]] \textless{}{-} plot[[i]] + scale\_fill\_gradient(labels = c("low", "", "", "","high")) \}}
\NormalTok{n }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{, }\DecValTok{3}\NormalTok{, }\FloatTok{1.7}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(aes\_stru))\{}
\NormalTok{  size}\OtherTok{=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{similarity}
\NormalTok{  id }\OtherTok{\textless{}{-}}\NormalTok{ aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{name}
\NormalTok{  plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{( }\AttributeTok{x=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y=}\NormalTok{aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{y,}
                                        \AttributeTok{subview=}\FunctionTok{arrangeGrob}\NormalTok{( }\FunctionTok{get}\NormalTok{(aes\_stru[k,]}\SpecialCharTok{$}\NormalTok{grob) ), }
                                        \AttributeTok{width=}\FunctionTok{ifelse}\NormalTok{(id }\SpecialCharTok{\%in\%}\NormalTok{ select, size}\SpecialCharTok{*}\NormalTok{n}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, size}\SpecialCharTok{*}\NormalTok{n}\SpecialCharTok{/}\NormalTok{ratio), }
                                        \AttributeTok{height=}\FunctionTok{ifelse}\NormalTok{(id }\SpecialCharTok{\%in\%}\NormalTok{ select, size}\SpecialCharTok{*}\NormalTok{n}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, size}\SpecialCharTok{*}\NormalTok{n}\SpecialCharTok{/}\NormalTok{ratio) ) \}}
\FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"plot\_"}\NormalTok{, tlimit), plot[[i]])}
\CommentTok{\#cat(i, edge\_list[i], "\textbackslash{}n")  \}}
\FunctionTok{ggsave}\NormalTok{(plot\_0}\FloatTok{.2}\NormalTok{, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"iridoids\_"}\NormalTok{, }\FloatTok{0.2}\NormalTok{, }\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{14}\NormalTok{, }\AttributeTok{height=}\DecValTok{12}\NormalTok{)}
\CommentTok{\#ggsave(plot\_0.25, file=paste0("tlimit\_", 0.25, ".svg"), width=6.5, height=5)}
\FunctionTok{ggsave}\NormalTok{(plot\_0}\FloatTok{.1}\NormalTok{, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"lignans\_"}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{9}\NormalTok{, }\AttributeTok{height=}\FloatTok{7.5}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\# import data}
\NormalTok{path }\OtherTok{\textless{}{-}} \StringTok{"structure\_2d/candidate"}
\NormalTok{structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\NormalTok{matrix }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(matrix, }\AttributeTok{idd=}\FunctionTok{strsplit}\NormalTok{(structure\_list, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{separate}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"idd"}\NormalTok{), }\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"candidate"}\NormalTok{), }\AttributeTok{sep=}\StringTok{"\_can\_"}\NormalTok{, }\AttributeTok{remove=}\NormalTok{F)}
\ControlFlowTok{for}\NormalTok{(id }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(matrix}\SpecialCharTok{$}\NormalTok{id))\{}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ matrix[}\FunctionTok{which}\NormalTok{(matrix}\SpecialCharTok{$}\NormalTok{id}\SpecialCharTok{==}\NormalTok{id), ]}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{candidate)),]}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))\{}
    \CommentTok{\# for(i in 20:29)\{}
    \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"stru\_"}\NormalTok{, df[i, }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"idd"}\NormalTok{)]), }\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path,}\StringTok{"/"}\NormalTok{,df[i, }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"structure\_list"}\NormalTok{)])) )}
    \FunctionTok{cat}\NormalTok{(i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)  }
\NormalTok{  \}}
\NormalTok{\}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path,}\StringTok{"/merge"}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{(id }\ControlFlowTok{in} \FunctionTok{unique}\NormalTok{(matrix}\SpecialCharTok{$}\NormalTok{id))\{}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ matrix[}\FunctionTok{which}\NormalTok{(matrix}\SpecialCharTok{$}\NormalTok{id}\SpecialCharTok{==}\NormalTok{id), ]}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{candidate)),]}
  \FunctionTok{svg}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/merge/"}\NormalTok{, id, }\StringTok{"\_merge.svg"}\NormalTok{), }\AttributeTok{height=}\FloatTok{1.2}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{)}
\NormalTok{  n}\OtherTok{=}\DecValTok{0}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))\{}
\NormalTok{    n}\OtherTok{=}\NormalTok{n}\SpecialCharTok{+}\DecValTok{1}
    \FunctionTok{grid.picture}\NormalTok{( }\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"stru\_"}\NormalTok{, df[i, }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"idd"}\NormalTok{)])) , }\AttributeTok{x=}\NormalTok{n}\SpecialCharTok{/}\DecValTok{11}\NormalTok{, }\AttributeTok{y=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{height=}\DecValTok{1}\NormalTok{, }\AttributeTok{width=}\DecValTok{1}\NormalTok{)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Info: the grid picture number is "}\NormalTok{, i, }\StringTok{" of ID: "}\NormalTok{, id, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-inchi_curl_syno.r}{%
\section{File: inchi\_curl\_syno.R}\label{file-inchi_curl_syno.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate\_inchi\_curl\_syno }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_set,}
\NormalTok{           .id\_set,}
           \AttributeTok{dir =} \StringTok{"inchi\_pub"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{    origin }\OtherTok{\textless{}{-}} \FunctionTok{getwd}\NormalTok{()}
    \FunctionTok{setwd}\NormalTok{(dir)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(data.table, key\_set, .id\_set, }\AttributeTok{SIMPLIFY =}\NormalTok{ F)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, }\ControlFlowTok{function}\NormalTok{(df, ...)\{}
                        \FunctionTok{inchi\_curl\_syno}\NormalTok{(df[[}\DecValTok{1}\NormalTok{]], df[[}\DecValTok{2}\NormalTok{]], ...)\}, ..., }\AttributeTok{cl =} \DecValTok{20}\NormalTok{)}
    \FunctionTok{setwd}\NormalTok{(origin)}
\NormalTok{  \}}
\NormalTok{inchi\_curl\_syno }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key,}
\NormalTok{           .id,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"synonyms"}\NormalTok{,}
           \AttributeTok{save =} \FunctionTok{paste0}\NormalTok{(.id, }\StringTok{".xml"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    http }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/"}\NormalTok{, type, }\StringTok{"/"}\NormalTok{)}
\NormalTok{    http\_end }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(get, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"/XML \textgreater{} "}\NormalTok{)}
\NormalTok{    curl }\OtherTok{\textless{}{-}} \StringTok{"curl {-}s {-}{-}connect{-}timeout 20 {-}{-}retry 100 {-}{-}retry{-}delay 30 "}
\NormalTok{    curl\_http }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(curl, http)}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(curl\_http, key, http\_end, save))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-inchi_curl.r-1}{%
\section{File: inchi\_curl.R}\label{file-inchi_curl.r-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inchikey\_get\_formula }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{sp.id =} \FunctionTok{as.character}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(inchikey)), }\AttributeTok{inchikey =}\NormalTok{ inchikey)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{inchikey, df}\SpecialCharTok{$}\NormalTok{sp.id, }\AttributeTok{get =} \FunctionTok{c}\NormalTok{(}\StringTok{"MolecularFormula"}\NormalTok{, }\StringTok{"ExactMass"}\NormalTok{, }\StringTok{"MonoisotopicMass"}\NormalTok{))}
    \FunctionTok{do.call}\NormalTok{(mutate\_inchi\_curl, args)}
\NormalTok{    from\_csv }\OtherTok{\textless{}{-}} \FunctionTok{gather\_inchi\_curl}\NormalTok{()}
    \FunctionTok{system}\NormalTok{(}\StringTok{"rm {-}r inchi\_pub"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, from\_csv, }\AttributeTok{by =} \StringTok{"sp.id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{gather\_inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"inchi\_pub"}
\NormalTok{           )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"csv$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(file\_set, mutate\_fread)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ file\_set }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(}\StringTok{"(?\textless{}=/)[0{-}9]\{1,100\}"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{sp.id =}\NormalTok{ .id)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate\_fread }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           path}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(df }\OtherTok{\textless{}{-}} \FunctionTok{fread}\NormalTok{(path, }\AttributeTok{fill =}\NormalTok{ T), }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{fread}\NormalTok{(path, }\AttributeTok{fill =}\NormalTok{ T, }\AttributeTok{skip =} \DecValTok{3}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"V1"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(df))\{}
      \FunctionTok{print}\NormalTok{(path)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate\_inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_set,}
\NormalTok{           .id\_set,}
           \AttributeTok{dir =} \StringTok{"inchi\_pub"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{    origin }\OtherTok{\textless{}{-}} \FunctionTok{getwd}\NormalTok{()}
    \FunctionTok{setwd}\NormalTok{(dir)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(data.table, key\_set, .id\_set, }\AttributeTok{SIMPLIFY =}\NormalTok{ F)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, }\ControlFlowTok{function}\NormalTok{(df, ...)\{}
                        \FunctionTok{inchi\_curl}\NormalTok{(df[[}\DecValTok{1}\NormalTok{]], df[[}\DecValTok{2}\NormalTok{]], ...)\}, ..., }\AttributeTok{cl =} \DecValTok{8}\NormalTok{)}
    \FunctionTok{setwd}\NormalTok{(origin)}
\NormalTok{  \}}
\NormalTok{inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key,}
\NormalTok{           .id,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
           \AttributeTok{save =} \FunctionTok{paste0}\NormalTok{(.id, }\StringTok{".csv"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    http }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/"}\NormalTok{, type, }\StringTok{"/"}\NormalTok{)}
\NormalTok{    http\_end }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/property/"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(get, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"/CSV \textgreater{} "}\NormalTok{)}
\NormalTok{    curl }\OtherTok{\textless{}{-}} \StringTok{"curl {-}s {-}{-}connect{-}timeout 20 {-}{-}retry 100 {-}{-}retry{-}delay 30 "}
\NormalTok{    curl\_http }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(curl, http)}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(curl\_http, key, http\_end, save))}
\NormalTok{  \}}
\NormalTok{int\_inchi\_curl }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           seq,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    init }\OtherTok{\textless{}{-}}\NormalTok{ dload[seq, }\StringTok{"init"}\NormalTok{]}
\NormalTok{    .id }\OtherTok{\textless{}{-}}\NormalTok{ dload[seq, }\StringTok{".id"}\NormalTok{]}
\NormalTok{    save }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.id, }\StringTok{".csv"}\NormalTok{)}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{class}\NormalTok{(}\FunctionTok{try}\NormalTok{(}\FunctionTok{read.csv}\NormalTok{(save), }\AttributeTok{silent =}\NormalTok{ T))[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{inchi\_curl}\NormalTok{(init, .id, }
                 \AttributeTok{get =}\NormalTok{ get,}
                 \AttributeTok{type =}\NormalTok{ type,}
\NormalTok{                 ...)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-inchikey2d_search.r}{%
\section{File: inchikey2d\_search.R}\label{file-inchikey2d_search.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{inchikey2d\_search }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           db,}
           \AttributeTok{col =} \StringTok{"inchikey2D"}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(df }\OtherTok{\textless{}{-}}\NormalTok{ db[}\FunctionTok{which}\NormalTok{(db[[col]] }\SpecialCharTok{==}\NormalTok{ inchikey2d), ], }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-instance_3d_xcms.r}{%
\section{File: instance\_3d\_xcms.R}\label{file-instance_3d_xcms.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(xcms)}
 \FunctionTok{library}\NormalTok{(MSnbase)}
 \FunctionTok{setwd}\NormalTok{(}\StringTok{"/media/wizard/back/thermo\_mzML\_0518"}\NormalTok{)}
\NormalTok{ savepath}\OtherTok{=}\StringTok{"/home/wizard/operation/back/"}
\NormalTok{ dataname}\OtherTok{=}\StringTok{"EU{-}Pro2.mzML"}
\NormalTok{ com\_data }\OtherTok{\textless{}{-}} \FunctionTok{readMSData}\NormalTok{(}\AttributeTok{file =}\NormalTok{ dataname, }\AttributeTok{mode =} \StringTok{"onDisk"}\NormalTok{)}
   \DocumentationTok{\#\#\#\#\#\#\# ms1 in peaks}
\NormalTok{   data }\OtherTok{\textless{}{-}} \FunctionTok{filterRt}\NormalTok{(com\_data, }\FunctionTok{c}\NormalTok{(}\DecValTok{600}\NormalTok{, }\DecValTok{780}\NormalTok{))}
\NormalTok{   mzrange }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{380}\NormalTok{, }\DecValTok{390}\NormalTok{)  }\CommentTok{\# build the eic model}
\NormalTok{   ex\_data }\OtherTok{\textless{}{-}} \FunctionTok{chromatogram}\NormalTok{(data, }\AttributeTok{msLevel =}\NormalTok{ 1L, }\AttributeTok{mz =}\NormalTok{ mzrange, }\AttributeTok{aggregationFun =} \StringTok{"max"}\NormalTok{)}
\NormalTok{   ex\_data\_1 }\OtherTok{\textless{}{-}}\NormalTok{ ex\_data[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{   rt}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rtime}\NormalTok{(ex\_data\_1))}
\NormalTok{   int}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{intensity}\NormalTok{(ex\_data\_1))}
\NormalTok{   rt\_int}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(rt,int)}
   \FunctionTok{colnames}\NormalTok{(rt\_int)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"rt"}\NormalTok{, }\StringTok{"int"}\NormalTok{)}
\NormalTok{   rt\_int}\SpecialCharTok{$}\NormalTok{rt}\OtherTok{=}\NormalTok{rt\_int}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{/}\DecValTok{60}
   \DocumentationTok{\#\#\#\#\#\#\#\#}
\NormalTok{   n}\OtherTok{=}\DecValTok{3}
\NormalTok{   time}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   time[[}\DecValTok{1}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{)}
\NormalTok{   time[[}\DecValTok{2}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{,}\DecValTok{12}\NormalTok{)}
\NormalTok{   time[[}\DecValTok{3}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{12}\NormalTok{,}\DecValTok{13}\NormalTok{)}
\NormalTok{   peak}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   scan}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{     peak[[i]]}\OtherTok{=}\NormalTok{rt\_int[}\FunctionTok{which}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}}\NormalTok{ time[[i]][}\DecValTok{1}\NormalTok{] }\SpecialCharTok{\&}\NormalTok{ rt\_int}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}}\NormalTok{ time[[i]][}\DecValTok{2}\NormalTok{]),] }
\NormalTok{     scan[[i]]}\OtherTok{=}\NormalTok{rt\_int[}\FunctionTok{which}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{int}\SpecialCharTok{==}\FunctionTok{max}\NormalTok{(peak[[i]]}\SpecialCharTok{$}\NormalTok{int)),] \}}
   \CommentTok{\# rownames(scan1)}
   \DocumentationTok{\#\#\#\#\#\#\# ms1 in scans}
\NormalTok{   mz}\OtherTok{=}\FunctionTok{mz}\NormalTok{(data)}
\NormalTok{   inn}\OtherTok{=}\FunctionTok{intensity}\NormalTok{(data)}
\NormalTok{   mz\_get}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   int\_get}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   scan\_set}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   a}\OtherTok{=}\NormalTok{pi}\SpecialCharTok{/}\DecValTok{3} \DocumentationTok{\#\#\#\#\# 45}
\NormalTok{   filter}\OtherTok{=}\DecValTok{50000}
\NormalTok{   xlim}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\FloatTok{10.6}\NormalTok{,}\FloatTok{12.7}\NormalTok{)}
\NormalTok{   mzfilter}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{360}\NormalTok{, }\DecValTok{420}\NormalTok{)}
\NormalTok{   ratio }\OtherTok{=}\NormalTok{ ((xlim[}\DecValTok{2}\NormalTok{])}\SpecialCharTok{/}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]))  }\CommentTok{\#((xlim[2]{-}xlim[1])/(mzfilter[2]{-}mzfilter[1]))}
\NormalTok{   ratio\_x\_y }\OtherTok{=} \FunctionTok{max}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{int)}\SpecialCharTok{/}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{xlim[}\DecValTok{1}\NormalTok{])}
\NormalTok{   lift}\OtherTok{=}\NormalTok{(}\FunctionTok{max}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{int))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}
\NormalTok{   height\_lift}\OtherTok{=}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{22}
\NormalTok{   base}\OtherTok{=}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio }\SpecialCharTok{*}\NormalTok{ratio\_x\_y}\SpecialCharTok{*}\FunctionTok{sin}\NormalTok{(a)}
   \CommentTok{\#zoom=0.95}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{   mz\_get[[i]]}\OtherTok{=}\NormalTok{mz[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(mz)}\SpecialCharTok{==}\FunctionTok{rownames}\NormalTok{(scan[[i]]))] }
\NormalTok{   int\_get[[i]]}\OtherTok{=}\NormalTok{inn[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(inn)}\SpecialCharTok{==}\FunctionTok{rownames}\NormalTok{(scan[[i]]))] }
\NormalTok{   scan\_set[[i]]}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(mz\_get[[i]], int\_get[[i]]);   }\FunctionTok{colnames}\NormalTok{(scan\_set[[i]])}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{, }\StringTok{"int"}\NormalTok{) }
\NormalTok{   scan\_set[[i]]}\OtherTok{=}\NormalTok{scan\_set[[i]][}\FunctionTok{which}\NormalTok{(scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{int }\SpecialCharTok{\textgreater{}=}\NormalTok{ filter }\SpecialCharTok{\&}
\NormalTok{                        scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz }\SpecialCharTok{\textgreater{}=}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{\&} 
\NormalTok{                        scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz }\SpecialCharTok{\textless{}=}\NormalTok{ mzfilter[}\DecValTok{2}\NormalTok{] ),] }
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{x }\OtherTok{\textless{}{-}}\NormalTok{ xlim[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ ((scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a) }\SpecialCharTok{+}\NormalTok{(scan[[i]]}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{{-}}\NormalTok{xlim[}\DecValTok{1}\NormalTok{]))}
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{xend }\OtherTok{\textless{}{-}}\NormalTok{ scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{x}
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{s\_x }\OtherTok{\textless{}{-}}\NormalTok{ xlim[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ (scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a)}
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{s\_xend }\OtherTok{\textless{}{-}}\NormalTok{ scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{s\_x }
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{y }\OtherTok{\textless{}{-}}\NormalTok{ ((scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio }\SpecialCharTok{*}\NormalTok{ratio\_x\_y}\SpecialCharTok{*}\FunctionTok{sin}\NormalTok{(a) }\SpecialCharTok{+}\NormalTok{ scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{int) }\SpecialCharTok{+}\NormalTok{ lift}
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{yend }\OtherTok{\textless{}{-}}\NormalTok{ ((scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio }\SpecialCharTok{*}\NormalTok{ratio\_x\_y}\SpecialCharTok{*}\FunctionTok{sin}\NormalTok{(a)) }\SpecialCharTok{+}\NormalTok{ lift}
\NormalTok{   scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{group}\OtherTok{=}\NormalTok{i}
\NormalTok{   scan\_set[[i]][}\FunctionTok{nrow}\NormalTok{(scan\_set[[i]])}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }
\NormalTok{                            scan[[i]]}\SpecialCharTok{$}\NormalTok{rt,  }\DocumentationTok{\#\# x}
\NormalTok{                            scan[[i]]}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }\DocumentationTok{\#\# xend}
                            \ConstantTok{NA}\NormalTok{,}
                            \ConstantTok{NA}\NormalTok{,}
\NormalTok{                            lift, }\DocumentationTok{\#\# y}
\NormalTok{                            base}\SpecialCharTok{+}\NormalTok{lift, }\DocumentationTok{\#\# yend}
                            \DecValTok{0}\NormalTok{)  }\DocumentationTok{\#\# group}
\NormalTok{   scan\_set[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ scan\_set[[i]][}\FunctionTok{order}\NormalTok{(scan\_set[[i]]}\SpecialCharTok{$}\NormalTok{mz),] \}}
\NormalTok{  segment}\OtherTok{=}\NormalTok{scan\_set[[}\DecValTok{1}\NormalTok{]]}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n)\{segment }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(segment, scan\_set[[i]])\}}
\NormalTok{  segment\_bottom }\OtherTok{\textless{}{-}}\NormalTok{ segment[}\FunctionTok{which}\NormalTok{(segment}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{==}\DecValTok{0}\NormalTok{), ]}
\NormalTok{  segment }\OtherTok{\textless{}{-}}\NormalTok{ segment[}\FunctionTok{which}\NormalTok{(segment}\SpecialCharTok{$}\NormalTok{mz}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{), ]}
\NormalTok{  segment\_outlier}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }\DecValTok{0}\NormalTok{, base ), }\CommentTok{\# 1}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{], xlim[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }\DecValTok{0}\NormalTok{, base ), }\CommentTok{\# 2}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], xlim[}\DecValTok{2}\NormalTok{], }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\CommentTok{\# 3}
            \CommentTok{\#c(xlim[1], xlim[2], lift*21, lift*21), \#top}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], xlim[}\DecValTok{1}\NormalTok{], }\DecValTok{0}\NormalTok{, height\_lift), }\CommentTok{\# 4}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{], xlim[}\DecValTok{2}\NormalTok{], }\DecValTok{0}\NormalTok{, height\_lift), }\CommentTok{\# 5}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }
\NormalTok{                    base, base}\SpecialCharTok{+}\NormalTok{height\_lift), }\CommentTok{\# 6}
            \CommentTok{\# c(xlim[2]+(xlim[2]{-}xlim[1])*cos(a), xlim[2]+(xlim[2]{-}xlim[1])*cos(a), lift*21, lift*21*2),}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), height\_lift, base}\SpecialCharTok{+}\NormalTok{height\_lift), }\CommentTok{\# 7}
            \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], xlim[}\DecValTok{2}\NormalTok{], height\_lift, height\_lift)  }\CommentTok{\# 8}
\NormalTok{            ))}
\NormalTok{  segment\_outlier}\SpecialCharTok{$}\NormalTok{group}\OtherTok{=}\StringTok{"0"}
  \FunctionTok{colnames}\NormalTok{(segment\_outlier) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"xend"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"yend"}\NormalTok{, }\StringTok{"group"}\NormalTok{)}
 \CommentTok{\# segment\_top=data.frame(rbind(c(xlim[1], xlim[2], base, base)))}
 \CommentTok{\# segment\_top$group="0"}
 \CommentTok{\# colnames(segment\_top) \textless{}{-} c("x", "xend", "y", "yend", "group")}
\NormalTok{  delta}\OtherTok{=}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a)}
\NormalTok{  point }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{],}\DecValTok{0}\NormalTok{),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), base),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), base }\SpecialCharTok{+}\NormalTok{ height\_lift),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{], height\_lift),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{],}\DecValTok{0}\NormalTok{),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{], height\_lift),}
              \FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), base)}
\NormalTok{              ))}
\NormalTok{  point}\SpecialCharTok{$}\NormalTok{group}\OtherTok{=}\StringTok{"0"}
  \FunctionTok{colnames}\NormalTok{(point)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{,}\StringTok{"y"}\NormalTok{, }\StringTok{"group"}\NormalTok{)}
\NormalTok{  grey }\OtherTok{\textless{}{-}}\NormalTok{ point[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{,]}
\NormalTok{  white }\OtherTok{\textless{}{-}}\NormalTok{ point[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{),]}
\NormalTok{  grey\_bottom }\OtherTok{\textless{}{-}}\NormalTok{ point[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{2}\NormalTok{),]}
\NormalTok{  grey\_bottom}\SpecialCharTok{$}\NormalTok{y1 }\OtherTok{\textless{}{-}}\NormalTok{ grey\_bottom}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{7}
\NormalTok{  grey\_bottom}\SpecialCharTok{$}\NormalTok{y2 }\OtherTok{\textless{}{-}}\NormalTok{ grey\_bottom}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{6}
\NormalTok{  grey\_bottom}\SpecialCharTok{$}\NormalTok{y3 }\OtherTok{\textless{}{-}}\NormalTok{ grey\_bottom}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{5}
\NormalTok{  grey\_bottom}\SpecialCharTok{$}\NormalTok{y4 }\OtherTok{\textless{}{-}}\NormalTok{ grey\_bottom}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{4}
\NormalTok{  grey\_bottom}\SpecialCharTok{$}\NormalTok{y5 }\OtherTok{\textless{}{-}}\NormalTok{ grey\_bottom}\SpecialCharTok{$}\NormalTok{y }\SpecialCharTok{{-}}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{3}
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(ggsci)}
\NormalTok{   data}\OtherTok{=}\NormalTok{raw\_data}\OtherTok{=}\NormalTok{rt\_int}
\NormalTok{   data}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textgreater{}=}\NormalTok{xlim[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textless{}=}\NormalTok{xlim[}\DecValTok{2}\NormalTok{]),]}
\NormalTok{   data}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{spline}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt, data}\SpecialCharTok{$}\NormalTok{int, }\AttributeTok{n=}\DecValTok{10000}\NormalTok{))}
  \DocumentationTok{\#\#\# beauty}
\NormalTok{  peak\_to}\OtherTok{=}\FloatTok{0.15}
\NormalTok{  scan\_tot}\OtherTok{=}\NormalTok{scan[[}\DecValTok{1}\NormalTok{]]}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n)\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, scan[[i]])\}}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{    scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{4}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{4}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{) ) }
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{!=}\NormalTok{n)\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{), }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{2}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{                ) }
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot,}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{))\} }
\NormalTok{        \}}
\NormalTok{  data}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(scan\_tot, }\FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{],}\DecValTok{0}\NormalTok{), }\FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{],}\DecValTok{0}\NormalTok{))}
\NormalTok{  data}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{spline}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt, data}\SpecialCharTok{$}\NormalTok{int, }\AttributeTok{n=}\DecValTok{10000}\NormalTok{))}
\NormalTok{  peak\_to}\OtherTok{=}\NormalTok{peak\_to }\SpecialCharTok{*}\FloatTok{1.2}
   \FunctionTok{colnames}\NormalTok{(data)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"rt"}\NormalTok{, }\StringTok{"int"}\NormalTok{)}
\NormalTok{   group\_set}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{   group\_set[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}} \FunctionTok{as.numeric}\NormalTok{(scan[[i]][}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to) }\SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}} \FunctionTok{as.numeric}\NormalTok{(scan[[i]][}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to)),] }\SpecialCharTok{\%\textgreater{}\%} 
            \FunctionTok{mutate}\NormalTok{(}\AttributeTok{group=}\NormalTok{i) \}}
\NormalTok{   set}\OtherTok{=}\NormalTok{group\_set[[}\DecValTok{1}\NormalTok{]]}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n)\{set }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(set, group\_set[[i]])\}}
\NormalTok{   data}\OtherTok{=}\FunctionTok{merge}\NormalTok{(data, set[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{)], }\AttributeTok{by=}\StringTok{"rt"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{   data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group)}\SpecialCharTok{==}\NormalTok{T),]}\SpecialCharTok{$}\NormalTok{group}\OtherTok{=}\DecValTok{0}
\NormalTok{   color\_set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"0"}\OtherTok{=}\StringTok{"black"}\NormalTok{, }\StringTok{"3"}\OtherTok{=}\StringTok{"\#E64B35FF"}\NormalTok{, }\StringTok{"2"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\StringTok{"1"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{)}
   \DocumentationTok{\#\#\#}
\NormalTok{   p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{int, }\AttributeTok{fill=}\FunctionTok{as.character}\NormalTok{(group), }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group))) }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y), }\AttributeTok{alpha=}\FloatTok{0.25}\NormalTok{, }\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data=}\NormalTok{segment, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{s\_x, }\AttributeTok{y=}\NormalTok{y}\SpecialCharTok{{-}}\NormalTok{lift, }\AttributeTok{xend=}\NormalTok{s\_xend, }\AttributeTok{yend=}\NormalTok{yend}\SpecialCharTok{{-}}\NormalTok{lift), }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{, }\AttributeTok{size=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\# geom\_polygon(data=grey\_bottom, aes(x=x, y=y1), alpha=0.15, fill="skyblue", color="\#BDBDBDFF") +}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y2), }\AttributeTok{alpha=}\FloatTok{0.15}\NormalTok{, }\AttributeTok{fill=}\StringTok{"skyblue"}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y3), }\AttributeTok{alpha=}\FloatTok{0.15}\NormalTok{, }\AttributeTok{fill=}\StringTok{"skyblue"}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y4), }\AttributeTok{alpha=}\FloatTok{0.15}\NormalTok{, }\AttributeTok{fill=}\StringTok{"skyblue"}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y5), }\AttributeTok{alpha=}\FloatTok{0.15}\NormalTok{, }\AttributeTok{fill=}\StringTok{"skyblue"}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{grey\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y), }\AttributeTok{alpha=}\FloatTok{0.15}\NormalTok{, }\AttributeTok{fill=}\StringTok{"skyblue"}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#BDBDBDFF"}\NormalTok{) }\SpecialCharTok{+}
     \CommentTok{\#geom\_area(data=point[!duplicated(point$x),], aes(x=x, y=y), fill=grey, alpha=0.5) +}
     \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data=}\NormalTok{segment\_bottom, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y, }\AttributeTok{xend=}\NormalTok{xend, }\AttributeTok{yend=}\NormalTok{yend, }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group)), }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"rect"}\NormalTok{, }\AttributeTok{xmin=}\NormalTok{xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }\AttributeTok{xmax=}\NormalTok{xlim[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(mzfilter[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{mzfilter[}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\NormalTok{ratio}\SpecialCharTok{*}\FunctionTok{cos}\NormalTok{(a), }
                  \AttributeTok{ymin=}\NormalTok{base, }\AttributeTok{ymax=}\NormalTok{base}\SpecialCharTok{+}\NormalTok{height\_lift,}
            \AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\AttributeTok{color=}\StringTok{"\#3C5488FF"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data=}\NormalTok{point, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y), }\AttributeTok{size=}\FloatTok{1.35}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data=}\NormalTok{segment\_outlier, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y, }\AttributeTok{xend=}\NormalTok{xend, }\AttributeTok{yend=}\NormalTok{yend, }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group)), }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data=}\NormalTok{segment, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y, }\AttributeTok{xend=}\NormalTok{xend, }\AttributeTok{yend=}\NormalTok{yend, }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group)), }\AttributeTok{size=}\DecValTok{4}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_line}\NormalTok{() }\SpecialCharTok{+}
     \FunctionTok{geom\_polygon}\NormalTok{(}\AttributeTok{data=}\NormalTok{white, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x, }\AttributeTok{y=}\NormalTok{y), }\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{fill=}\StringTok{"white"}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{geom\_area}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{scan[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{+}\NormalTok{delta, }\AttributeTok{y=}\NormalTok{height\_lift}\SpecialCharTok{*}\DecValTok{8}\SpecialCharTok{/}\DecValTok{10}\SpecialCharTok{+}\NormalTok{base, }\AttributeTok{label=}\StringTok{"LC{-}MS data set"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{scan[[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{height\_lift}\SpecialCharTok{*}\DecValTok{8}\SpecialCharTok{/}\DecValTok{10}\NormalTok{, }\AttributeTok{label=}\StringTok{"The Sample"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{scan[[}\FunctionTok{median}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n)]]}\SpecialCharTok{$}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{height\_lift}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\SpecialCharTok{*}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{label=}\StringTok{"Retention time"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{xlim[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\AttributeTok{y=}\NormalTok{lift}\SpecialCharTok{*}\DecValTok{7}\SpecialCharTok{*}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{label=}\StringTok{"Samples"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{angle=}\DecValTok{90}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x=}\NormalTok{xlim[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\NormalTok{delta}\SpecialCharTok{/}\DecValTok{2}\SpecialCharTok{+}\NormalTok{peak\_to}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\AttributeTok{y=}\NormalTok{base}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\AttributeTok{label=}\StringTok{"m/z"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{size=}\DecValTok{8}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{angle=}\DecValTok{0}\NormalTok{, }\AttributeTok{vjust=}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
   \CommentTok{\#  geom\_segment(data=segment\_top, aes(x=x, y=y, xend=xend, yend=yend, color=as.character(group)), size=2, alpha=0.95) +}
     \CommentTok{\#geom\_xspline(spline\_shape = {-}0.5, size=5) +}
     \CommentTok{\#geom\_smooth(method = "loess", formula=y\textasciitilde{}poly(x), se=F) +}
     \CommentTok{\#stat\_smooth(method = "loess", geom="area", se=F, formula=y\textasciitilde{}poly(x)) +}
     \CommentTok{\#xlim(xlim[1],xlim[2]*22/20) +}
     \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
     \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
     \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
     \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{, }\AttributeTok{y=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
     \FunctionTok{theme}\NormalTok{(}
           \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
           \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
           \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
           \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
           \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
           \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
           \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{          )}
  \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savepath, }\StringTok{"test.svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{7}\NormalTok{)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
  \DocumentationTok{\#\# card }
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{setwd}\NormalTok{(}\StringTok{"/media/wizard/back/thermo\_mzML\_0518"}\NormalTok{)}
\NormalTok{ savepath}\OtherTok{=}\StringTok{"/home/wizard/operation/back/"}
\NormalTok{ dataname}\OtherTok{=}\StringTok{"EU{-}Pro2.mzML"}
\NormalTok{ com\_data }\OtherTok{\textless{}{-}} \FunctionTok{readMSData}\NormalTok{(}\AttributeTok{file =}\NormalTok{ dataname, }\AttributeTok{mode =} \StringTok{"onDisk"}\NormalTok{)}
   \DocumentationTok{\#\#\#\#\#\#\# ms1 in peaks}
\NormalTok{   data }\OtherTok{\textless{}{-}} \FunctionTok{filterRt}\NormalTok{(com\_data, }\FunctionTok{c}\NormalTok{(}\DecValTok{600}\NormalTok{, }\DecValTok{780}\NormalTok{))}
\NormalTok{   mzrange }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{380}\NormalTok{, }\DecValTok{390}\NormalTok{)  }\CommentTok{\# build the eic model}
\NormalTok{   ex\_data }\OtherTok{\textless{}{-}} \FunctionTok{chromatogram}\NormalTok{(data, }\AttributeTok{msLevel =}\NormalTok{ 1L, }\AttributeTok{mz =}\NormalTok{ mzrange, }\AttributeTok{aggregationFun =} \StringTok{"max"}\NormalTok{)}
\NormalTok{   ex\_data\_1 }\OtherTok{\textless{}{-}}\NormalTok{ ex\_data[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
\NormalTok{   rt}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{rtime}\NormalTok{(ex\_data\_1))}
\NormalTok{   int}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{intensity}\NormalTok{(ex\_data\_1))}
\NormalTok{   rt\_int}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(rt,int)}
   \FunctionTok{colnames}\NormalTok{(rt\_int)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"rt"}\NormalTok{, }\StringTok{"int"}\NormalTok{)}
\NormalTok{   rt\_int}\SpecialCharTok{$}\NormalTok{rt}\OtherTok{=}\NormalTok{rt\_int}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{/}\DecValTok{60}
   \DocumentationTok{\#\#\#\#\#\#\#\#}
\NormalTok{   n}\OtherTok{=}\DecValTok{3}
\NormalTok{   time}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   time[[}\DecValTok{1}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{)}
\NormalTok{   time[[}\DecValTok{2}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{11}\NormalTok{,}\DecValTok{12}\NormalTok{)}
\NormalTok{   time[[}\DecValTok{3}\NormalTok{]]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{12}\NormalTok{,}\DecValTok{13}\NormalTok{)}
\NormalTok{   peak}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
\NormalTok{   scan}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{     peak[[i]]}\OtherTok{=}\NormalTok{rt\_int[}\FunctionTok{which}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}}\NormalTok{ time[[i]][}\DecValTok{1}\NormalTok{] }\SpecialCharTok{\&}\NormalTok{ rt\_int}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}}\NormalTok{ time[[i]][}\DecValTok{2}\NormalTok{]),] }
\NormalTok{     scan[[i]]}\OtherTok{=}\NormalTok{rt\_int[}\FunctionTok{which}\NormalTok{(rt\_int}\SpecialCharTok{$}\NormalTok{int}\SpecialCharTok{==}\FunctionTok{max}\NormalTok{(peak[[i]]}\SpecialCharTok{$}\NormalTok{int)),] \}}
   \CommentTok{\# rownames(scan1)}
   \DocumentationTok{\#\#\#\#\#\#\# ms1 in scans}
\NormalTok{   xlim}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\FloatTok{10.6}\NormalTok{,}\FloatTok{12.7}\NormalTok{)}
\NormalTok{   data}\OtherTok{=}\NormalTok{raw\_data}\OtherTok{=}\NormalTok{rt\_int}
\NormalTok{   data}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textgreater{}=}\NormalTok{xlim[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt}\SpecialCharTok{\textless{}=}\NormalTok{xlim[}\DecValTok{2}\NormalTok{]),]}
\NormalTok{   data}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{spline}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt, data}\SpecialCharTok{$}\NormalTok{int, }\AttributeTok{n=}\DecValTok{10000}\NormalTok{))}
  \DocumentationTok{\#\#\# beauty}
\NormalTok{  peak\_to}\OtherTok{=}\FloatTok{0.15}
\NormalTok{  scan\_tot}\OtherTok{=}\NormalTok{scan[[}\DecValTok{1}\NormalTok{]]}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n)\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, scan[[i]])\}}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{    scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{4}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{4}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{5}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to, scan\_tot[i,}\DecValTok{2}\NormalTok{]}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{) ) }
    \ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{!=}\NormalTok{n)\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot, }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{), }
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{),}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{(scan\_tot[i}\SpecialCharTok{+}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{scan\_tot[i,}\DecValTok{1}\NormalTok{])}\SpecialCharTok{*}\DecValTok{2}\SpecialCharTok{/}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{                ) }
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{scan\_tot }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(scan\_tot,}
               \FunctionTok{c}\NormalTok{(scan\_tot[i,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{4}\NormalTok{, }\DecValTok{0}\NormalTok{))\} }
\NormalTok{        \}}
\NormalTok{  data}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(scan\_tot, }\FunctionTok{c}\NormalTok{(xlim[}\DecValTok{1}\NormalTok{],}\DecValTok{0}\NormalTok{), }\FunctionTok{c}\NormalTok{(xlim[}\DecValTok{2}\NormalTok{],}\DecValTok{0}\NormalTok{))}
\NormalTok{  data}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(}\FunctionTok{spline}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt, data}\SpecialCharTok{$}\NormalTok{int, }\AttributeTok{n=}\DecValTok{10000}\NormalTok{))}
\NormalTok{  peak\_to}\OtherTok{=}\NormalTok{peak\_to }\SpecialCharTok{*}\FloatTok{1.2}
   \FunctionTok{colnames}\NormalTok{(data)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"rt"}\NormalTok{, }\StringTok{"int"}\NormalTok{)}
\NormalTok{   group\_set}\OtherTok{=}\FunctionTok{vector}\NormalTok{(}\AttributeTok{mode=}\StringTok{"list"}\NormalTok{, }\AttributeTok{length=}\NormalTok{n)}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{   group\_set[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}} \FunctionTok{as.numeric}\NormalTok{(scan[[i]][}\DecValTok{1}\NormalTok{]}\SpecialCharTok{{-}}\NormalTok{peak\_to) }\SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}} \FunctionTok{as.numeric}\NormalTok{(scan[[i]][}\DecValTok{1}\NormalTok{]}\SpecialCharTok{+}\NormalTok{peak\_to)),] }\SpecialCharTok{\%\textgreater{}\%} 
            \FunctionTok{mutate}\NormalTok{(}\AttributeTok{group=}\NormalTok{i) \}}
\NormalTok{   set}\OtherTok{=}\NormalTok{group\_set[[}\DecValTok{1}\NormalTok{]]}
   \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\NormalTok{n)\{set }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(set, group\_set[[i]])\}}
\NormalTok{   data}\OtherTok{=}\FunctionTok{merge}\NormalTok{(data, set[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{3}\NormalTok{)], }\AttributeTok{by=}\StringTok{"rt"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{TRUE}\NormalTok{)}
\NormalTok{   data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group)}\SpecialCharTok{==}\NormalTok{T),]}\SpecialCharTok{$}\NormalTok{group}\OtherTok{=}\DecValTok{0}
\NormalTok{   color\_set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"0"}\OtherTok{=}\StringTok{"black"}\NormalTok{, }\StringTok{"3"}\OtherTok{=}\StringTok{"\#E64B35FF"}\NormalTok{, }\StringTok{"2"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\StringTok{"1"}\OtherTok{=}\StringTok{"\#00A087FF"}\NormalTok{)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{   segment }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
                 \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{),}
                 \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{),}
                 \FunctionTok{c}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{10}\NormalTok{)}
\NormalTok{                )}
   \FunctionTok{colnames}\NormalTok{(segment) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"x"}\NormalTok{, }\StringTok{"xend"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"yend"}\NormalTok{)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{setwd}\NormalTok{(}\StringTok{"/home/wizard/operation/back/0703\_all/results"}\NormalTok{)}
\NormalTok{  p1\_1 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}} \FloatTok{10.68} \SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}} \FloatTok{11.12}\NormalTok{), ], }
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{int, }\AttributeTok{fill=}\FunctionTok{as.character}\NormalTok{(group), }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group))) }\SpecialCharTok{+}
    \FunctionTok{geom\_area}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(data=segment, aes(x=x, y=y, xend=xend, yend=yend, color=as.character(group)), size=2, alpha=0.4) +}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlim}\NormalTok{(}\FloatTok{10.6}\NormalTok{,}\FloatTok{12.6}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      ) }
\NormalTok{  p1\_2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}} \FloatTok{11.32} \SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}} \FloatTok{11.8}\NormalTok{), ], }
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{int, }\AttributeTok{fill=}\FunctionTok{as.character}\NormalTok{(group), }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group))) }\SpecialCharTok{+}
    \FunctionTok{geom\_area}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(data=segment, aes(x=x, y=y, xend=xend, yend=yend, color=as.character(group)), size=2, alpha=0.4) +}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlim}\NormalTok{(}\FloatTok{10.6}\NormalTok{,}\FloatTok{12.6}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      ) }
\NormalTok{  p1\_3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textgreater{}} \FloatTok{12.05} \SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{rt }\SpecialCharTok{\textless{}} \FloatTok{12.55}\NormalTok{), ], }
            \FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{int, }\AttributeTok{fill=}\FunctionTok{as.character}\NormalTok{(group), }\AttributeTok{color=}\FunctionTok{as.character}\NormalTok{(group))) }\SpecialCharTok{+}
    \FunctionTok{geom\_area}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{color\_set) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(data=segment, aes(x=x, y=y, xend=xend, yend=yend, color=as.character(group)), size=2, alpha=0.4) +}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{xlim}\NormalTok{(}\FloatTok{10.6}\NormalTok{,}\FloatTok{12.6}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      ) }
\NormalTok{  p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(segment) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(aes(x=x, y=y, xend=xend, yend=yend), color="\#BDBDBDFF", size=4, alpha=0.8) +}
    \FunctionTok{annotate}\NormalTok{(}\StringTok{"rect"}\NormalTok{, }\AttributeTok{xmin=}\DecValTok{0}\NormalTok{, }\AttributeTok{xmax=}\DecValTok{10}\NormalTok{, }\AttributeTok{ymin=}\DecValTok{0}\NormalTok{ , }\AttributeTok{ymax=}\DecValTok{10}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{), }
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
\NormalTok{  p3 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(segment) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(aes(x=x, y=y, xend=xend, yend=yend), color="\#BDBDBDFF", size=4, alpha=0.8) +}
    \FunctionTok{annotate}\NormalTok{(}\StringTok{"rect"}\NormalTok{, }\AttributeTok{xmin=}\DecValTok{0}\NormalTok{, }\AttributeTok{xmax=}\DecValTok{10}\NormalTok{, }\AttributeTok{ymin=}\DecValTok{0}\NormalTok{ , }\AttributeTok{ymax=}\DecValTok{10}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{alpha=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{), }
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
 \FunctionTok{svg}\NormalTok{(}\StringTok{"2d\_ms.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
 \FunctionTok{grid.newpage}\NormalTok{()}
 \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{) ))}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{92}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_1, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{48}\SpecialCharTok{:}\DecValTok{93}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{92}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{88}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{14}\SpecialCharTok{:}\DecValTok{96}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{44}\SpecialCharTok{:}\DecValTok{89}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{88}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{14}\SpecialCharTok{:}\DecValTok{96}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{24}\SpecialCharTok{:}\DecValTok{85}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \CommentTok{\# grid.text("Morphology", x=0.02, y=0.25, rot=90, gp = gpar( fontface = "bold", fontsize = 20, fontfamily = "Times", fontangle=90) )}
 \FunctionTok{dev.off}\NormalTok{()}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ path}\OtherTok{=}\StringTok{"ms2\_figures"}
\NormalTok{ id\_1}\OtherTok{=}\DecValTok{495}
\NormalTok{ id\_2}\OtherTok{=}\DecValTok{347}
\NormalTok{ id\_3}\OtherTok{=}\DecValTok{2268}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)\{}
\NormalTok{ id}\OtherTok{=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"id\_"}\NormalTok{, i))}
\NormalTok{ msms }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, id, }\StringTok{".tsv"}\NormalTok{), }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ set }\OtherTok{\textless{}{-}}\NormalTok{ msms[}\FunctionTok{which}\NormalTok{(msms}\SpecialCharTok{$}\NormalTok{rel.intensity }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{),]}
\NormalTok{ pal}\OtherTok{=}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ width}\OtherTok{=}\FunctionTok{max}\NormalTok{(set}\SpecialCharTok{$}\NormalTok{mz)}\SpecialCharTok{/}\DecValTok{150}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(set, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{rel.intensity)) }\SpecialCharTok{+}
   \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width=}\NormalTok{width, }\AttributeTok{fill=}\NormalTok{pal[i]) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(data=segment, aes(x=x, y=y, xend=xend, yend=yend, color=as.character(group)), size=2, alpha=0.4) +}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
  \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"p1\_"}\NormalTok{, i), p)    \} }
\NormalTok{ p2 }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(segment) }\SpecialCharTok{+}
    \CommentTok{\#geom\_segment(aes(x=x, y=y, xend=xend, yend=yend), color="\#BDBDBDFF", size=4, alpha=0.8) +}
    \FunctionTok{annotate}\NormalTok{(}\StringTok{"rect"}\NormalTok{, }\AttributeTok{xmin=}\DecValTok{0}\NormalTok{, }\AttributeTok{xmax=}\DecValTok{10}\NormalTok{, }\AttributeTok{ymin=}\DecValTok{0}\NormalTok{ , }\AttributeTok{ymax=}\DecValTok{10}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{), }
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title.y =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{      )}
 \FunctionTok{svg}\NormalTok{(}\StringTok{"msms.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{12}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)}
 \FunctionTok{grid.newpage}\NormalTok{()}
 \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{) ))}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{92}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{48}\SpecialCharTok{:}\DecValTok{93}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{92}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{88}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{14}\SpecialCharTok{:}\DecValTok{96}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{44}\SpecialCharTok{:}\DecValTok{89}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{16}\SpecialCharTok{:}\DecValTok{98}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{8}\SpecialCharTok{:}\DecValTok{88}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{14}\SpecialCharTok{:}\DecValTok{96}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p2, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p1\_1, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{24}\SpecialCharTok{:}\DecValTok{85}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{print}\NormalTok{( p3, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{4}\SpecialCharTok{:}\DecValTok{84}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{12}\SpecialCharTok{:}\DecValTok{94}\NormalTok{ ))}
 \CommentTok{\# grid.text("Morphology", x=0.02, y=0.25, rot=90, gp = gpar( fontface = "bold", fontsize = 20, fontfamily = "Times", fontangle=90) )}
 \FunctionTok{dev.off}\NormalTok{()}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ path}\OtherTok{=}\StringTok{"ms2\_figures\_label"}
\NormalTok{ id\_1}\OtherTok{=}\DecValTok{495}
\NormalTok{ id\_2}\OtherTok{=}\DecValTok{347}
\NormalTok{ id\_3}\OtherTok{=}\DecValTok{2268}
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)\{}
\NormalTok{ id}\OtherTok{=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"id\_"}\NormalTok{, i))}
\NormalTok{ source }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, id, }\StringTok{".tsv"}\NormalTok{), }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(source, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{rel.intensity)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat=}\StringTok{"identity"}\NormalTok{,}\AttributeTok{width=}\FunctionTok{max}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{mz)}\SpecialCharTok{/}\DecValTok{150}\NormalTok{,}\AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"red"}\NormalTok{)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{1.3}\NormalTok{,}\AttributeTok{color=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"red"}\NormalTok{),}\AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{match}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+} 
  \CommentTok{\#xlim(0,max(source$mz, na.rm=T)) +}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
    \AttributeTok{panel.background=}\FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{,}\AttributeTok{color=}\StringTok{"white"}\NormalTok{),}
    \AttributeTok{panel.grid=}\FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"grey85"}\NormalTok{),}
    \AttributeTok{panel.border =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\ConstantTok{NA}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{linetype=}\StringTok{"solid"}\NormalTok{), }
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{() )}
    \CommentTok{\#plot.margin = unit(c(3, 1, 3, 1), "cm"))}
  \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"p1\_"}\NormalTok{, i), p)  }
  \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ms2\_"}\NormalTok{, id, }\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{6}\NormalTok{, }\AttributeTok{height=}\DecValTok{4}\NormalTok{) \}}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{library}\NormalTok{(ggforce)}
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(grid)}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x0 =} \DecValTok{0}\NormalTok{, }\AttributeTok{y0 =} \DecValTok{0}\NormalTok{, }\AttributeTok{a =} \DecValTok{7}\NormalTok{, }\AttributeTok{b =} \DecValTok{3}\NormalTok{, }\AttributeTok{angle =} \DecValTok{0}\NormalTok{), }\AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"\#8491B4FF"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_fixed}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
    \CommentTok{\#panel.background=element\_rect(fill="transparent",color="white"),}
    \AttributeTok{panel.grid=}\FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{() )}
 \FunctionTok{svg}\NormalTok{(}\StringTok{"database.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\DecValTok{7}\NormalTok{)}
 \FunctionTok{grid.newpage}\NormalTok{()}
 \FunctionTok{pushViewport}\NormalTok{( }\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{) ))}
 \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{60}\SpecialCharTok{:}\DecValTok{90}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{95}\NormalTok{ ) )}
 \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{50}\SpecialCharTok{:}\DecValTok{80}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{95}\NormalTok{ ) )}
 \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{40}\SpecialCharTok{:}\DecValTok{70}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{95}\NormalTok{ ) )}
 \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{30}\SpecialCharTok{:}\DecValTok{60}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{95}\NormalTok{ ) )}
 \FunctionTok{print}\NormalTok{( p, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{20}\SpecialCharTok{:}\DecValTok{50}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{5}\SpecialCharTok{:}\DecValTok{95}\NormalTok{ ) )}
 \FunctionTok{dev.off}\NormalTok{()}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{library}\NormalTok{(ggforce)}
 \FunctionTok{library}\NormalTok{(ggalt)}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(grid)}
\NormalTok{ data}\OtherTok{=}\StringTok{"/media/wizard/back/0703\_all/490\_initial\_8\_neg\_495/fingerprints/C17H24O10\_[M{-}H]{-}.fpt"}
\NormalTok{ fp }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{data, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ fp }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(fp)),fp)}
 \FunctionTok{colnames}\NormalTok{(fp) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"num"}\NormalTok{, }\StringTok{"pp"}\NormalTok{)}
\NormalTok{ fp}\SpecialCharTok{$}\NormalTok{group }\OtherTok{\textless{}{-}} \StringTok{"g1"}
\NormalTok{ eg\_fp }\OtherTok{\textless{}{-}}\NormalTok{ fp[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{15}\NormalTok{,]}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(eg\_fp, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(num), }\AttributeTok{y=}\NormalTok{group, }\AttributeTok{fill=}\NormalTok{pp)) }\SpecialCharTok{+}
   \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low=}\StringTok{"white"}\NormalTok{, }\AttributeTok{high=}\StringTok{"\#3C5488FF"}\NormalTok{) }\SpecialCharTok{+}
   \FunctionTok{coord\_fixed}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
    \AttributeTok{panel.grid=}\FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
    \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{, }
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(), }
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{() )}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"495.fp.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{, }\AttributeTok{height=}\DecValTok{1}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(grid)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \FunctionTok{library}\NormalTok{(ggimage)}
 \FunctionTok{library}\NormalTok{(grImport2)}
 \FunctionTok{library}\NormalTok{(sunburstR)}
 \FunctionTok{library}\NormalTok{(RColorBrewer)}
 \FunctionTok{library}\NormalTok{(shiny)}
\NormalTok{ metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{ metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\# see in network}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ metadata[, }\FunctionTok{colnames}\NormalTok{(metadata) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"parentId"}\NormalTok{)]}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
     \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
     \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }
\NormalTok{ layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(metadata)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"unrooted"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ p }\OtherTok{\textless{}{-}} 
 \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\AttributeTok{edge\_width=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \CommentTok{\#geom\_node\_point(aes(fill=str\_wrap(classification, width=25), size=similarity), shape=21) + }
 \FunctionTok{geom\_node\_point}\NormalTok{(}\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{deg, }\AttributeTok{size=}\NormalTok{deg)) }\SpecialCharTok{+} 
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \FunctionTok{scale\_fill\_gradient}\NormalTok{(}\AttributeTok{low=}\StringTok{"\#1B1919FF"}\NormalTok{, }\AttributeTok{high=}\StringTok{"\#DC0000FF"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{alpha=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
 \CommentTok{\#labs(fill="Centrality\textbackslash{}ndegree", size="Tanimoto\textbackslash{}nsimilarity") +}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
       \CommentTok{\#panel.background = element\_rect(fill="white"), }
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
       \CommentTok{\#panel.grid = element\_blank(),}
       \CommentTok{\#legend.position = "none",}
       \CommentTok{\#strip.text = element\_text(size=15, face="bold")}
       \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"class\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{7}\NormalTok{, }\AttributeTok{height=}\DecValTok{6}\NormalTok{)}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ pal0}\OtherTok{=} \FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{ pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{ pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{ pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{ getPalette }\OtherTok{=} \FunctionTok{colorRampPalette}\NormalTok{(pal0)}
 \DocumentationTok{\#\#\#\#\#}
 \CommentTok{\# data=data[which(data$value \textgreater{} 0.01),]}
 \CommentTok{\# data$color \textless{}{-} seq(nrow(data))}
 \CommentTok{\# plot \textless{}{-} plot\_ly( data=data, }
 \CommentTok{\# labels = \textasciitilde{}id,}
 \CommentTok{\# parents = \textasciitilde{}parentid,}
 \CommentTok{\# values = \textasciitilde{}value,}
 \CommentTok{\# color = \textasciitilde{}color,}
 \CommentTok{\# colors = c(palette),}
  \CommentTok{\#colors = colorRamp(c("red", "blue")), }
  \CommentTok{\#colors = c(\textasciigrave{}4\textasciigrave{} = "red", \textasciigrave{}5\textasciigrave{} = "black", \textasciigrave{}6\textasciigrave{} = "blue", \textasciigrave{}8\textasciigrave{} = "green"), }
 \CommentTok{\# type = "sunburst", }
 \CommentTok{\# insidetextorientation="radial"}
 \CommentTok{\# ) \%\textgreater{}\%}
 \CommentTok{\# layout( margin = list(l = 0, r = 0, b = 0, t = 0))}
 \CommentTok{\# https://stackoverflow.com/questions/12926779/how{-}to{-}make{-}a{-}sunburst{-}plot{-}in{-}r{-}or{-}pythonlibrary(sunburstR)sequences sunburst(sequences)}
\NormalTok{ metadata\_parent\_path}\OtherTok{=}\StringTok{"../canopus\_parent\_index.tsv"}
\NormalTok{ metadata\_parent }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_parent\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{ data\_path}\OtherTok{=}\StringTok{"/media/wizard/back/0703\_all/490\_initial\_8\_neg\_495/canopus/C17H24O10\_[M{-}H]{-}.fpt"}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{data\_path, }\AttributeTok{header=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ guide\_data }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(metadata\_parent[,}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{)], data)}
\NormalTok{ dataset }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(metadata\_parent[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{)], data)}
 \FunctionTok{colnames}\NormalTok{(dataset) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"value"}\NormalTok{)}
\NormalTok{ dataset\_s }\OtherTok{\textless{}{-}}\NormalTok{ dataset[}\FunctionTok{which}\NormalTok{(dataset}\SpecialCharTok{$}\NormalTok{value}\SpecialCharTok{\textgreater{}}\FloatTok{0.01}\NormalTok{), ]}
\NormalTok{ dataset\_s }\OtherTok{\textless{}{-}}\NormalTok{ dataset\_s[}\FunctionTok{order}\NormalTok{(dataset\_s}\SpecialCharTok{$}\NormalTok{id),]}
 \CommentTok{\#pal\textless{}{-}palette[1:nrow(dataset\_s)]}
\NormalTok{ pal\_do }\OtherTok{\textless{}{-}} \FunctionTok{getPalette}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(dataset\_s))}
 \CommentTok{\#sunburst(dataset\_s, colors=list(range = RColorBrewer::brewer.pal(9, "Set3")))}
 \FunctionTok{sund2b}\NormalTok{(dataset\_s, }\AttributeTok{colors=}\FunctionTok{list}\NormalTok{(}\AttributeTok{range =}\NormalTok{ RColorBrewer}\SpecialCharTok{::}\FunctionTok{brewer.pal}\NormalTok{(}\DecValTok{9}\NormalTok{, }\StringTok{"Set3"}\NormalTok{)))}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#3}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ metadata\_parent\_path}\OtherTok{=}\StringTok{"../canopus\_parent\_index.tsv"}
\NormalTok{ metadata\_parent }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_parent\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ metadata\_parent[, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
 \CommentTok{\#data$num \textless{}{-} 1}
 \FunctionTok{sund2b}\NormalTok{(data, }\AttributeTok{colors=}\NormalTok{palette)}
\CommentTok{\# sunburst(data, colors=palette)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-json_tree.r}{%
\section{File: json\_tree.R}\label{file-json_tree.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(tidyverse)}
 
 \FunctionTok{library}\NormalTok{(igraph)}
 
 \FunctionTok{library}\NormalTok{(ggraph)}
 
 \FunctionTok{library}\NormalTok{(tidygraph)}
 
 \FunctionTok{library}\NormalTok{(ggsci)}
 
 \FunctionTok{library}\NormalTok{(scales)}
 
 \FunctionTok{library}\NormalTok{(grid)}
 
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
 
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_jama}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
 
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"dark"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
 
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_igv}\NormalTok{(}\StringTok{"default"}\NormalTok{)(}\DecValTok{51}\NormalTok{)}
 
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4))}
 
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 
 \FunctionTok{setwd}\NormalTok{(}\StringTok{"json\_tree"}\NormalTok{)}
 
 \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\DecValTok{495}\NormalTok{, }\DecValTok{347}\NormalTok{, }\DecValTok{2268}\NormalTok{))\{}
 
\NormalTok{ id}\OtherTok{=}\NormalTok{i}
 
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"nodes\_"}\NormalTok{,id,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"edges\_"}\NormalTok{,id,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
 
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{), }\AttributeTok{shape =} \FunctionTok{ifelse}\NormalTok{(name}\SpecialCharTok{==}\DecValTok{0}\NormalTok{, }\DecValTok{16}\NormalTok{, }\DecValTok{3}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
    
    \FunctionTok{as\_tibble}\NormalTok{()}
 
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    
    \FunctionTok{as\_tibble}\NormalTok{()}
 
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
 
 \DocumentationTok{\#\#\#\#\#\# network}
 
 \DocumentationTok{\#\# layout="dendrogram"}
 
\NormalTok{ layout}\OtherTok{=}\StringTok{"tree"}
 
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout) }\SpecialCharTok{+} 
 
 \FunctionTok{geom\_edge\_elbow}\NormalTok{(}\AttributeTok{edge\_width=}\DecValTok{1}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F, }\AttributeTok{strength =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+} 
 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{3}\NormalTok{, }\AttributeTok{color=}\StringTok{"red"}\NormalTok{) }\SpecialCharTok{+} 
 
 \CommentTok{\#geom\_node\_label(aes(label=label, fill=label), color="white", size=7,}
         \CommentTok{\#fill="transparent",}
        \CommentTok{\# label.padding = unit(0.5, "lines"), }
        \CommentTok{\# label.r = unit(0.25, "lines"), }
        \CommentTok{\# label.size = 2,}
        \CommentTok{\# fontface="bold",}
        \CommentTok{\# nudge\_y = 0.1,}
        \CommentTok{\# family="Times",}
        \CommentTok{\# repel = T) +}
 
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 
 \CommentTok{\# scale\_edge\_width(range=c(0.1,0.7)) + }
 
 \CommentTok{\#facet\_edges(\textasciitilde{}facet) + }
 
 \CommentTok{\#guides(size="none", fill="none") +}
 
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"tree\_"}\NormalTok{,id,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{4}\NormalTok{, }\AttributeTok{height=}\DecValTok{8}\NormalTok{)  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-kegg_get.r}{%
\section{File: kegg\_get.R}\label{file-kegg_get.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(KEGGREST)}
\FunctionTok{library}\NormalTok{(org.Mm.eg.db)}
\FunctionTok{library}\NormalTok{(clusterProfiler)}
\CommentTok{\#BiocManager::install("org.Hs.eg.db")}
\CommentTok{\#org \textless{}{-} keggList(\textquotesingle{}organism\textquotesingle{})}
\DocumentationTok{\#\#\# human \textless{}{-} hsa}
\DocumentationTok{\#\#\# mice \textless{}{-} mmu}
\DocumentationTok{\#\#\# rats \textless{}{-} rno}
\CommentTok{\# save}
\CommentTok{\# load}
\NormalTok{species}\OtherTok{=}\StringTok{"mmu"}
\NormalTok{pathway }\OtherTok{\textless{}{-}} \FunctionTok{keggLink}\NormalTok{(}\StringTok{"pathway"}\NormalTok{, species)}
\NormalTok{pathway }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(pathway)}
\CommentTok{\# capture.output(mmu\_test,file="test")}
\NormalTok{pathway.database }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{"list"}\NormalTok{, }\AttributeTok{length =} \FunctionTok{length}\NormalTok{(pathway))}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(pathway))\{}
    \FunctionTok{cat}\NormalTok{(i,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,pathway[[i]],}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    pathway.database[[i]] }\OtherTok{\textless{}{-}} \FunctionTok{keggGet}\NormalTok{(}\AttributeTok{dbentries =}\NormalTok{ pathway[[i]]) \}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\# compound message}
\NormalTok{compound.id }\OtherTok{\textless{}{-}} \FunctionTok{keggList}\NormalTok{(}\StringTok{\textquotesingle{}compound\textquotesingle{}}\NormalTok{)}
\NormalTok{compound.id }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(compound.id)}
\NormalTok{compound.database }\OtherTok{\textless{}{-}} \FunctionTok{vector}\NormalTok{(}\AttributeTok{mode =} \StringTok{\textquotesingle{}list\textquotesingle{}}\NormalTok{, }\AttributeTok{length =} \FunctionTok{length}\NormalTok{(compound.id))}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(compound.id))\{}
    \FunctionTok{cat}\NormalTok{(i,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,compound.id[i],}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    compound.database[[i]] }\OtherTok{\textless{}{-}} \FunctionTok{keggGet}\NormalTok{(}\AttributeTok{dbentries =}\NormalTok{ compound.id[i]) \}}
\DocumentationTok{\#\#\#\# search \textless{}{-} keggGet(entries = object)}
\DocumentationTok{\#\#\#\# }
\DocumentationTok{\#\# export DBLINKS}
\FunctionTok{sink}\NormalTok{(}\StringTok{"\textasciitilde{}/operation/re\_fecal\_neg/kegg/dblink.list"}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(compound.database))\{}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"BEGIN\_COMPOUND}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(compound.database[[i]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{ENTRY, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"DBLINKS}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(compound.database[[i]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{DBLINKS))\{}
    \FunctionTok{cat}\NormalTok{(compound.database[[i]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{DBLINKS[j], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"NAME}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(compound.database[[i]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{NAME))\{}
    \FunctionTok{cat}\NormalTok{(compound.database[[i]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{$}\NormalTok{NAME[j], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"END\_COMPOUND}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\FunctionTok{sink}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\# kegg api}
\NormalTok{png }\OtherTok{\textless{}{-}} \FunctionTok{keggGet}\NormalTok{(}\StringTok{"mmu01100"}\NormalTok{, }\StringTok{"image"}\NormalTok{)}
\FunctionTok{library}\NormalTok{(png)}
\FunctionTok{writePNG}\NormalTok{(png, }\StringTok{"test.png"}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{query}\OtherTok{=}\FunctionTok{keggGet}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"mmu:01100"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-lcms_xcms.r}{%
\section{File: lcms\_xcms.R}\label{file-lcms_xcms.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(xcms)}
\FunctionTok{library}\NormalTok{(RColorBrewer)}
\FunctionTok{library}\NormalTok{(magrittr)}
\FunctionTok{library}\NormalTok{(pheatmap)}
\FunctionTok{library}\NormalTok{(SummarizedExperiment)}
\CommentTok{\# data name list}
\NormalTok{path }\OtherTok{\textless{}{-}} \StringTok{"."}
\NormalTok{dda\_file}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.mzML$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{, }
                    \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                    \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# metadata}
\NormalTok{pd }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{sample\_name =}\NormalTok{ dda\_file, }
                 \AttributeTok{sample\_group =} \FunctionTok{rep}\NormalTok{(}\StringTok{"test"}\NormalTok{, }\FunctionTok{length}\NormalTok{(dda\_file)),}
                 \AttributeTok{stringsAsFactors =} \ConstantTok{FALSE}\NormalTok{)}
\CommentTok{\# xcms read the data}
\NormalTok{raw\_data }\OtherTok{\textless{}{-}} \FunctionTok{readMSData}\NormalTok{(}\AttributeTok{files =}\NormalTok{ dda\_file, }\AttributeTok{pdata =} \FunctionTok{new}\NormalTok{(}\StringTok{"NAnnotatedDataFrame"}\NormalTok{, pd), }
                       \AttributeTok{mode =} \StringTok{"onDisk"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-linear_regression.r}{%
\section{File: linear\_regression.R}\label{file-linear_regression.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggpmisc)}

\FunctionTok{setwd}\NormalTok{(}\StringTok{"linear\_regression"}\NormalTok{)}

\NormalTok{files}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ files)\{}

\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file,}\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{chem, }\AttributeTok{y=}\NormalTok{id\_content)) }\SpecialCharTok{+}

  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{se=}\ConstantTok{FALSE}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{4}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
  
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{coord\_cartesian}\NormalTok{(}\AttributeTok{clip =} \StringTok{"off"}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{chem), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id\_content)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{16}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Linear correlation: "}\NormalTok{,}\FunctionTok{as.character}\NormalTok{(savename)),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{4}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{chem), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id\_content)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"r(pearson): "}\NormalTok{,}\FunctionTok{as.character}\NormalTok{(}\FunctionTok{round}\NormalTok{(data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"r.pearson."}\NormalTok{)],}\DecValTok{4}\NormalTok{))),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{4}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{chem), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{id\_content)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{14}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"p{-}value: "}\NormalTok{,}\FunctionTok{as.character}\NormalTok{(}\FunctionTok{round}\NormalTok{(data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"p.value"}\NormalTok{)],}\DecValTok{4}\NormalTok{))),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{4}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{scale\_size\_continuous}\NormalTok{( }\AttributeTok{trans=}\StringTok{"exp"}\NormalTok{, }\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  
  \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"\#4A6990FF"}\NormalTok{,}\StringTok{"drug"}\OtherTok{=}\StringTok{"\#95CC5EFF"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"black"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}
  
\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\FunctionTok{print}\NormalTok{(file)}

\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-magick_svg.r}{%
\section{File: magick\_svg.R}\label{file-magick_svg.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(magick)}

\FunctionTok{setwd}\NormalTok{(}\StringTok{"results/structure\_2d"}\NormalTok{)}

\NormalTok{img }\OtherTok{\textless{}{-}} \FunctionTok{image\_read\_svg}\NormalTok{(}\StringTok{"3918.svg"}\NormalTok{, }\AttributeTok{width =} \DecValTok{3000}\NormalTok{, }\AttributeTok{height =} \DecValTok{3000}\NormalTok{)}

\FunctionTok{image\_display}\NormalTok{(img)}

\FunctionTok{image\_write}\NormalTok{(img,}\AttributeTok{path=}\StringTok{"test.svg"}\NormalTok{, }\AttributeTok{format=}\StringTok{"svg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mcnebula_child_nebula.r}{%
\section{File: MCnebula\_child\_nebula.R}\label{file-mcnebula_child_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(gridSVG)}
\FunctionTok{library}\NormalTok{(rsvg)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\DocumentationTok{\#\# Many steps of this script may not be easy to implement, such as having to draw the compound structure image beforehand, and fine{-}tuning the position of the subgraphs.}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{, }\AttributeTok{quote=}\StringTok{""}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{, }\AttributeTok{quote=}\StringTok{""}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{nodes}\SpecialCharTok{$}\NormalTok{similarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{nodes}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"null"}\NormalTok{, }\StringTok{"Undefined"}\NormalTok{, nodes}\SpecialCharTok{$}\NormalTok{classification)}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\DocumentationTok{\#\# an instance to draw lignans and iridoids of E. ulmoides }
\DocumentationTok{\#\# select1="Iridoids and derivatives.tsv"}
\DocumentationTok{\#\# select2="Lignans, neolignans and related compounds.tsv"}
\NormalTok{select\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\DecValTok{34}\NormalTok{,}\DecValTok{39}\NormalTok{)}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\DocumentationTok{\#\# Unfortunately, the structure of the compound must be drawn previously and converted into a Cairo SVG.}
\NormalTok{stru\_path}\OtherTok{=}\StringTok{"structure\_2d/smiles\_draw"}
\NormalTok{structure\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ stru\_path, }\AttributeTok{pattern =} \StringTok{"*.mol.svg.cairo.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                             \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{matrix }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(structure\_list) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{mutate}\NormalTok{(}\AttributeTok{catch=}\StringTok{"T"}\NormalTok{)}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"canopus\_pp\_filter.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(canopus\_set)}
\FunctionTok{colnames}\NormalTok{(canopus\_set)}\OtherTok{=}\FunctionTok{as.character}\NormalTok{(canopus\_set[}\DecValTok{1}\NormalTok{,])}
\NormalTok{canopus\_set }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,]}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{metadata\_path}\OtherTok{=}\StringTok{"../canopus\_neg.tsv"}
\NormalTok{metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadata\_path, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[,}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{4}\NormalTok{)]}
\NormalTok{metadata}\SpecialCharTok{$}\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"C"}\NormalTok{,metadata}\SpecialCharTok{$}\NormalTok{absoluteIndex)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\# start plot}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ select\_list)\{}
\NormalTok{  edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{  edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{  cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{  network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{    layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\# structure}
\NormalTok{    elements }\OtherTok{\textless{}{-}}\NormalTok{ layout\_n[,}\FunctionTok{colnames}\NormalTok{(layout\_n) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"x"}\NormalTok{, }\StringTok{"y"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"classification"}\NormalTok{)]}
\NormalTok{    elements}\SpecialCharTok{$}\NormalTok{link\_structure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name,}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)}
\NormalTok{    grid\_elements }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, matrix, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"link\_structure"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"structure\_list"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
    \DocumentationTok{\#\#\# grobify}
\NormalTok{    structure\_p}\OtherTok{\textless{}{-}}\FunctionTok{list}\NormalTok{()}
\NormalTok{    list\_stru }\OtherTok{\textless{}{-}}\NormalTok{ grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{), }\FunctionTok{colnames}\NormalTok{(grid\_elements) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"link\_structure"}\NormalTok{)]}
\NormalTok{    prefix}\OtherTok{=}\FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ list\_stru)\{}
\NormalTok{      id}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(j, }\AttributeTok{split=}\StringTok{".mol.svg.cairo.svg"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
      \CommentTok{\#structure\_p[[as.numeric(id)]] = grobify(readPicture(paste0(path,"/",j)))}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,id), }\FunctionTok{grobify}\NormalTok{(}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(stru\_path,}\StringTok{"/"}\NormalTok{,j))))}
      \FunctionTok{cat}\NormalTok{(id,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{, }\StringTok{"structure\_p}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    aes\_stru }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(grid\_elements[}\FunctionTok{which}\NormalTok{(grid\_elements}\SpecialCharTok{$}\NormalTok{catch}\SpecialCharTok{==}\StringTok{"T"}\NormalTok{),], }\AttributeTok{grob=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"grob\_"}\NormalTok{,name), }\AttributeTok{id=}\NormalTok{name)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\# ring\_bar plot}
\NormalTok{    ring\_data }\OtherTok{\textless{}{-}}\NormalTok{ canopus\_set[,}\FunctionTok{colnames}\NormalTok{(canopus\_set) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name)]}
\NormalTok{    list\_palette }\OtherTok{=} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification)), palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{classification))]))}
    \FunctionTok{colnames}\NormalTok{(list\_palette) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"classification"}\NormalTok{, }\StringTok{"color"}\NormalTok{)}
\NormalTok{    elements\_palette }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(elements, list\_palette, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"classification"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(ring\_data)[j]}
\NormalTok{      fill\_in}\OtherTok{=}\NormalTok{elements\_palette[}\FunctionTok{which}\NormalTok{(elements\_palette}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}\SpecialCharTok{$}\NormalTok{color}
\NormalTok{      fill\_border}\OtherTok{=}\StringTok{"black"}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(ring\_data[,}\FunctionTok{colnames}\NormalTok{(ring\_data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(id)]) }
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{class=}\FunctionTok{rownames}\NormalTok{(df))}
      \FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"value"}\NormalTok{,}\StringTok{"class"}\NormalTok{)}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"class"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{num),]}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class, }\StringTok{": "}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{fill }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{fill, }\AttributeTok{levels=}\NormalTok{df[}\FunctionTok{order}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{absoluteIndex), }\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"fill"}\NormalTok{)])}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{num, }\AttributeTok{y=}\NormalTok{value)) }\SpecialCharTok{+}
        \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{), }\AttributeTok{fill =}\NormalTok{fill\_in) }\SpecialCharTok{+}
        \FunctionTok{geom\_ribbon}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(num}\SpecialCharTok{==}\FunctionTok{nrow}\NormalTok{(df), num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{, num)), }\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{), }\AttributeTok{fill=}\NormalTok{fill\_border) }\SpecialCharTok{+}
        \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha=}\DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{fill), }\AttributeTok{color=}\StringTok{"white"}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.02}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{,}\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{""}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
        \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}
              \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid.major =}\FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid.minor =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
              \AttributeTok{legend.title=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=} \SpecialCharTok{{-}}\FloatTok{0.5}\NormalTok{),}
              \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{        )}
        \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id), p) }
\NormalTok{    \}}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
    \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{    plot[[i]] }\OtherTok{\textless{}{-}} 
      \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity),}
                    \AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
\FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(classification, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
\FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
\FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
\FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{facet) }\SpecialCharTok{+} 
\FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Access classes"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{) }\SpecialCharTok{+}
\FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes=}\FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
\FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}
      \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{legend.title=} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
      \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.6}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
      \AttributeTok{axis.line =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
\NormalTok{)}
\FunctionTok{assign}\NormalTok{(}\StringTok{"find\_id"}\NormalTok{, plot[[i]])}
\DocumentationTok{\#\# As we see it, there must be some bug in the ggimage package that causes the position to be misaligned, so it needs to be fine{-}tuned manually.}
\DocumentationTok{\#\# size and posion adjust}
\NormalTok{min}\OtherTok{=}\FunctionTok{min}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}
\NormalTok{delta}\OtherTok{=}\FunctionTok{max}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{similarity)}\SpecialCharTok{{-}}\NormalTok{min}
\NormalTok{step}\OtherTok{=}\DecValTok{1}\SpecialCharTok{/}\NormalTok{delta}
\ControlFlowTok{if}\NormalTok{(i}\SpecialCharTok{==}\DecValTok{39} \SpecialCharTok{|}\NormalTok{ i}\SpecialCharTok{==}\DecValTok{34}\NormalTok{)\{p\_size}\OtherTok{=}\FloatTok{0.85}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.105}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{p\_size}\OtherTok{=}\FloatTok{0.65}\NormalTok{; p\_dist}\OtherTok{=}\FloatTok{0.09}\NormalTok{\}}
\DocumentationTok{\#\# draw subview into the network}
\ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(ring\_data))\{}
\NormalTok{  id}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(ring\_data)[k]}
\NormalTok{  aes\_ring}\OtherTok{=}\NormalTok{elements[}\FunctionTok{which}\NormalTok{(elements}\SpecialCharTok{$}\NormalTok{name}\SpecialCharTok{==}\NormalTok{id),]}
\NormalTok{  size}\OtherTok{=}\NormalTok{(aes\_ring}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{{-}}\NormalTok{min)}\SpecialCharTok{*}\NormalTok{step}\SpecialCharTok{+}\NormalTok{p\_size}
  \DocumentationTok{\#\# ppcp datacet}
\NormalTok{  plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{x}\SpecialCharTok{{-}}\NormalTok{p\_dist, }\AttributeTok{y=}\NormalTok{aes\_ring}\SpecialCharTok{$}\NormalTok{y}\SpecialCharTok{{-}}\NormalTok{p\_dist,}
                                        \AttributeTok{subview=}\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ring\_"}\NormalTok{, id)),}
                                        \AttributeTok{width=}\NormalTok{size, }\AttributeTok{height=}\NormalTok{size )  }
  \DocumentationTok{\#\# structure}
\NormalTok{  kk }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(aes\_stru}\SpecialCharTok{$}\NormalTok{id}\SpecialCharTok{==}\NormalTok{id)}
\NormalTok{  size}\OtherTok{=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{similarity}
\NormalTok{  plot[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ plot[[i]] }\SpecialCharTok{+} \FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{x, }\AttributeTok{y=}\NormalTok{aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{y,}
                                        \AttributeTok{subview=}\FunctionTok{arrangeGrob}\NormalTok{( }\FunctionTok{get}\NormalTok{(aes\_stru[kk,]}\SpecialCharTok{$}\NormalTok{grob) ),}
                                        \AttributeTok{width=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\NormalTok{size}\SpecialCharTok{*}\DecValTok{6}\SpecialCharTok{/}\DecValTok{5}\NormalTok{)}
\NormalTok{\}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{ggsave}\NormalTok{(plot[[i]], }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"tt\_zoom\_"}\NormalTok{,i,}\StringTok{".svg"}\NormalTok{), }\AttributeTok{width=}\DecValTok{7}\NormalTok{, }\AttributeTok{height=}\FloatTok{5.5}\NormalTok{)}
\FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mcnebula_multi_nebulae.r}{%
\section{File: MCnebula\_multi\_nebulae.R}\label{file-mcnebula_multi_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\DocumentationTok{\#\#\#\# Eucommia analyses}
\NormalTok{path}\OtherTok{=}\StringTok{"network\_facet\_0.50"}
\NormalTok{edge\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
                        \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{nodes2}\SpecialCharTok{$}\NormalTok{classification[}\FunctionTok{grep}\NormalTok{(}\StringTok{"null"}\NormalTok{, nodes2}\SpecialCharTok{$}\NormalTok{classification)] }\OtherTok{\textless{}{-}} \StringTok{"Undifined"}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\DocumentationTok{\#\#\#\#\# color palette}
\NormalTok{pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{pal1}\OtherTok{=}\NormalTok{ pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{14}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{13}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{15}\NormalTok{,}\DecValTok{16}\NormalTok{)]}
\NormalTok{pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{pal5}\OtherTok{=} \FunctionTok{pal\_jco}\NormalTok{()(}\DecValTok{10}\NormalTok{)}
\NormalTok{pal6}\OtherTok{=} \FunctionTok{pal\_startrek}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal7}\OtherTok{=} \FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{)}
\NormalTok{pal8}\OtherTok{=} \FunctionTok{pal\_locuszoom}\NormalTok{()(}\DecValTok{7}\NormalTok{)}
\NormalTok{pal9}\OtherTok{=} \FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1, pal2, pal3, pal4, pal5, pal6, pal7, pal8, pal9))}
\NormalTok{plot }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(edge\_list))\{}
\NormalTok{  edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, edge\_list[i]), }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{  edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{  cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{  edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{  network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
    \DocumentationTok{\#\#\#\#\#\#\#\#\# candidate: graphopt kk fr mds}
\NormalTok{    layout}\OtherTok{=}\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(network\_nodes)}\SpecialCharTok{\textgreater{}}\DecValTok{1000}\NormalTok{, }\StringTok{"mds"}\NormalTok{, }\StringTok{"fr"}\NormalTok{)}
\NormalTok{    plot[[i]] }\OtherTok{\textless{}{-}} 
      \FunctionTok{ggraph}\NormalTok{(network, }\AttributeTok{layout =}\NormalTok{ layout) }\SpecialCharTok{+} 
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
      \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\NormalTok{classification), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
      \CommentTok{\# geom\_node\_text(aes(label=name),size=3) +}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{,}\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{facet\_edges}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\FunctionTok{str\_wrap}\NormalTok{(facet, }\AttributeTok{width=}\DecValTok{30}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
            \CommentTok{\#axis.line = element\_blank(),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
      \CommentTok{\# ggsave(plot[[i]], file="test.svg", width=5, height=5)}
      \FunctionTok{cat}\NormalTok{(i, edge\_list[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }
\NormalTok{\}}
\DocumentationTok{\#\# grid }
\FunctionTok{svg}\NormalTok{(}\StringTok{"child\_nebula.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{18}\SpecialCharTok{*}\FloatTok{1.6}\NormalTok{, }\AttributeTok{height=}\DecValTok{22}\SpecialCharTok{*}\FloatTok{1.5}\NormalTok{)}
\NormalTok{n}\OtherTok{=}\FunctionTok{length}\NormalTok{(edge\_list)}
\NormalTok{s}\OtherTok{=}\NormalTok{n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{); }\ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(s)}\SpecialCharTok{!=}\NormalTok{s)\{s}\OtherTok{=}\FunctionTok{round}\NormalTok{(s); ss}\OtherTok{=}\NormalTok{s}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}\ControlFlowTok{else}\NormalTok{\{ss}\OtherTok{=}\NormalTok{s\}}
\FunctionTok{grid.newpage}\NormalTok{()}
\FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(ss, s)))}
\NormalTok{r\_ss}\OtherTok{=}\DecValTok{1}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{  c\_s}\OtherTok{=}\NormalTok{i}\SpecialCharTok{\%\%}\NormalTok{s}
  \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\DecValTok{0}\NormalTok{)\{c\_s}\OtherTok{=}\NormalTok{s\}}
  \FunctionTok{print}\NormalTok{( plot[[i]], }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\NormalTok{r\_ss, }\AttributeTok{layout.pos.col=}\NormalTok{c\_s ))}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"push view port of "}\NormalTok{,i,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(c\_s}\SpecialCharTok{==}\NormalTok{s)\{ r\_ss}\OtherTok{=}\NormalTok{r\_ss}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{\}}
\FunctionTok{dev.off}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mcnebula_parent_nebula.r}{%
\section{File: MCnebula\_parent\_nebula.R}\label{file-mcnebula_parent_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(tidyverse)}
 \FunctionTok{library}\NormalTok{(igraph)}
 \FunctionTok{library}\NormalTok{(ggraph)}
 \FunctionTok{library}\NormalTok{(tidygraph)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(scales)}
 \FunctionTok{library}\NormalTok{(stringr)}
 \DocumentationTok{\#\#\#\# Eucommia analysis}
\NormalTok{ pal1}\OtherTok{=} \FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{)}
\NormalTok{ pal2}\OtherTok{=} \FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{ pal3}\OtherTok{=} \FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{)}
\NormalTok{ pal4}\OtherTok{=} \FunctionTok{pal\_uchicago}\NormalTok{(}\StringTok{"light"}\NormalTok{)(}\DecValTok{9}\NormalTok{)}
\NormalTok{ palette}\OtherTok{=} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(pal1[}\FunctionTok{c}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\SpecialCharTok{:}\DecValTok{8}\NormalTok{,}\DecValTok{10}\NormalTok{,}\DecValTok{11}\NormalTok{, }\DecValTok{13}\SpecialCharTok{:}\DecValTok{16}\NormalTok{)], pal2, pal3, pal4))}
\NormalTok{ nodes1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{) }
\NormalTok{ nodes2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"stat\_classification.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}}\NormalTok{ nodes2}\SpecialCharTok{$}\NormalTok{definition}
\NormalTok{ nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes1, nodes2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[}\FunctionTok{which}\NormalTok{(nodes}\SpecialCharTok{$}\NormalTok{superclass}\SpecialCharTok{!=}\StringTok{""}\NormalTok{), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"source\_target\_tree\_0.4.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ edges\_id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source, edges}\SpecialCharTok{$}\NormalTok{target))}
\NormalTok{ cont\_edges\_id }\OtherTok{\textless{}{-}}\NormalTok{ edges\_id[}\SpecialCharTok{!}\NormalTok{(edges\_id }\SpecialCharTok{\%in\%}\NormalTok{ nodes}\SpecialCharTok{$}\NormalTok{id)]}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{source }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id }\SpecialCharTok{|}\NormalTok{ edges}\SpecialCharTok{$}\NormalTok{target }\SpecialCharTok{\%in\%}\NormalTok{ cont\_edges\_id), ]}
\NormalTok{ edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(edges[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{]), ]}
\NormalTok{ network\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\#as\_tibble()}
    \FunctionTok{mutate}\NormalTok{(}\AttributeTok{deg =} \FunctionTok{centrality\_degree}\NormalTok{(}\AttributeTok{mode=}\StringTok{\textquotesingle{}in\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{merge}\NormalTok{(nodes, }\AttributeTok{by.x=}\StringTok{"name"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network\_edges }\OtherTok{\textless{}{-}} \FunctionTok{as\_tbl\_graph}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{ network }\OtherTok{\textless{}{-}} \FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ network\_nodes, }\AttributeTok{edges =}\NormalTok{ network\_edges)}
\NormalTok{ layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(network, }\AttributeTok{layout =} \StringTok{"mds"}\NormalTok{)}
 \DocumentationTok{\#\#\#\# molecular network}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
 \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width=}\NormalTok{ftalign\_similarity), }\AttributeTok{color=}\StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend=}\NormalTok{F) }\SpecialCharTok{+} 
 \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{as.numeric}\NormalTok{(similarity), }\AttributeTok{fill=}\FunctionTok{str\_wrap}\NormalTok{(superclass, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)), }\AttributeTok{shape=}\DecValTok{21}\NormalTok{) }\SpecialCharTok{+} 
 \CommentTok{\#geom\_node\_text(aes(filter= deg\textgreater{}12,label=name),size=1) +}
 \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values=}\NormalTok{palette) }\SpecialCharTok{+}
 \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
 \CommentTok{\#facet\_nodes(\textasciitilde{}classification) + }
 \CommentTok{\#guides(size="none") +}
 \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size=}\DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
 \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Superclass"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
 \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
 \FunctionTok{theme}\NormalTok{(}
       \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
       \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"white"}\NormalTok{), }
       \CommentTok{\#axis.line = element\_blank(),}
       \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
       \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\FloatTok{0.2}\NormalTok{),}
       \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
       \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{),}
       \CommentTok{\#legend.position = c(0.6,0.25),}
       \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
       \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
 \CommentTok{\# ggsave(p, file="parent\_network.tiff", width=20, height=22)}
 \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"parent\_network.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{16}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-opls_da.r}{%
\section{File: opls\_da.R}\label{file-opls_da.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ropls)}
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{datas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*pca.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{metadatas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}metadata*"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{n}\OtherTok{=}\FunctionTok{length}\NormalTok{(datas)}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}

\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(datas[i],}\AttributeTok{split=}\StringTok{"\_pca.tsv"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{datas[i],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}
\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{metadatas[i],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}
\NormalTok{oplsda }\OtherTok{\textless{}{-}} \FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ data, }\AttributeTok{y =}\NormalTok{ class[, }\StringTok{"group"}\NormalTok{], }\AttributeTok{predI =} \DecValTok{1}\NormalTok{, }\AttributeTok{orthoI =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{cbind}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{scoreMN[, }\DecValTok{1}\NormalTok{], oplsda}\SpecialCharTok{@}\NormalTok{orthoScoreMN[, }\DecValTok{1}\NormalTok{])}
\FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"h1"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"o"}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{x\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{1}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{y\_lab }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Orthogonal T score[1]("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{2}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(df)}
\NormalTok{vip}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(oplsda}\SpecialCharTok{@}\NormalTok{vipVn)}
\NormalTok{vip}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(vip),vip)}
\FunctionTok{colnames}\NormalTok{(vip)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"vip"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{group), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{h1, }\AttributeTok{y=}\NormalTok{o1, }\AttributeTok{label=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{name),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\NormalTok{x\_lab,}\AttributeTok{y=}\NormalTok{y\_lab,}\AttributeTok{title=}\StringTok{"OPLS{-}DA"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{),}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)) }
    
\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{"\_oplsda.svg"}\NormalTok{), }\AttributeTok{height=}\DecValTok{6}\NormalTok{, }\AttributeTok{width=}\DecValTok{10}\NormalTok{)}

\NormalTok{df}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(df),df)}

\FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"sample"}\NormalTok{,}\StringTok{"h1"}\NormalTok{,}\StringTok{"o1"}\NormalTok{)}

\NormalTok{df}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(df,}\FunctionTok{c}\NormalTok{(}\StringTok{"summary"}\NormalTok{,}\FunctionTok{paste0}\NormalTok{(}\StringTok{"t1("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{1}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{),}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ot1("}\NormalTok{, oplsda}\SpecialCharTok{@}\NormalTok{modelDF[}\DecValTok{2}\NormalTok{, }\StringTok{"R2X"}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"\%)"}\NormalTok{)))}

\FunctionTok{write.table}\NormalTok{(vip, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".vip"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{write.table}\NormalTok{(df, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".ropls"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-opls_facet_ggplot.r}{%
\section{File: opls\_facet\_ggplot.R}\label{file-opls_facet_ggplot.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsci)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=} \StringTok{"opls\_facet.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\NormalTok{PC1 }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1}\SpecialCharTok{==}\StringTok{"PC1"}\NormalTok{),]}

\NormalTok{PC2 }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1}\SpecialCharTok{==}\StringTok{"PC2"}\NormalTok{),]}

\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{sample}\SpecialCharTok{!=}\StringTok{"anno"}\NormalTok{),]}

\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}

\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC2))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(PC1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(PC2), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"high\_raw"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{), }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"Orthogonal T score[1]"}\NormalTok{, }\AttributeTok{x=}\StringTok{"T score[1]"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    
    \FunctionTok{facet\_grid}\NormalTok{(g2\_deep }\SpecialCharTok{\textasciitilde{}}\NormalTok{ g1\_from) }\SpecialCharTok{+}
    
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"opls\_facet.svg"}\NormalTok{,}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pca_facet_ggplot.r}{%
\section{File: pca\_facet\_ggplot.R}\label{file-pca_facet_ggplot.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsci)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=} \StringTok{"pca\_facet.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\NormalTok{PC1 }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1}\SpecialCharTok{==}\StringTok{"PC1"}\NormalTok{),]}

\NormalTok{PC1}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC1("}\NormalTok{,PC1}\SpecialCharTok{$}\NormalTok{figure}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}

\NormalTok{PC2 }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1}\SpecialCharTok{==}\StringTok{"PC2"}\NormalTok{),]}

\NormalTok{PC2}\SpecialCharTok{$}\NormalTok{figure }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"PC2("}\NormalTok{,PC2}\SpecialCharTok{$}\NormalTok{figure}\SpecialCharTok{*}\DecValTok{100}\NormalTok{,}\StringTok{"\%)"}\NormalTok{)}

\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{sample}\SpecialCharTok{!=}\StringTok{"anno"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{)]}

\NormalTok{anno\_x}\OtherTok{=}\FunctionTok{min}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC1))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{20}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}

\NormalTok{anno\_y}\OtherTok{=}\FunctionTok{max}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{PC2))}\SpecialCharTok{*}\NormalTok{(}\DecValTok{22}\SpecialCharTok{/}\DecValTok{20}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.numeric}\NormalTok{(PC1), }\AttributeTok{y=}\FunctionTok{as.numeric}\NormalTok{(PC2), }\AttributeTok{fill=}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"high\_raw"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"control"}\OtherTok{=}\StringTok{"grey"}\NormalTok{,}\StringTok{"model"}\OtherTok{=}\StringTok{"\#374E55FF"}\NormalTok{,}
  
                \StringTok{"pro\_low"}\OtherTok{=}\StringTok{"\#FDAE6BFF"}\NormalTok{,}\StringTok{"pro\_medium"}\OtherTok{=}\StringTok{"\#FD8D3CFF"}\NormalTok{,}\StringTok{"pro\_high"}\OtherTok{=}\StringTok{"\#E6550DFF"}\NormalTok{,}
                
                \StringTok{"raw\_low"}\OtherTok{=}\StringTok{"\#9ECAE1FF"}\NormalTok{,}\StringTok{"raw\_medium"}\OtherTok{=}\StringTok{"\#6BAED6FF"}\NormalTok{,}\StringTok{"raw\_high"}\OtherTok{=}\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{color=} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC1, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y, }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{PC2, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{anno\_x, }\AttributeTok{y=}\NormalTok{anno\_y}\SpecialCharTok{*}\NormalTok{(}\DecValTok{18}\SpecialCharTok{/}\DecValTok{22}\NormalTok{), }\AttributeTok{label=}\NormalTok{figure), }
            \AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"PC2"}\NormalTok{, }\AttributeTok{x=}\StringTok{"PC1"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
    
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    
    \FunctionTok{facet\_grid}\NormalTok{(g2\_deep }\SpecialCharTok{\textasciitilde{}}\NormalTok{ g1\_from) }\SpecialCharTok{+}
    
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"pca\_facet.svg"}\NormalTok{,}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pca_ggbiplot.r}{%
\section{File: pca\_ggbiplot.R}\label{file-pca_ggbiplot.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{datas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*pca.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{metadatas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"\^{}metadata*"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{n}\OtherTok{=}\FunctionTok{length}\NormalTok{(datas)}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n)\{}
\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(datas[i],}\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{source}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{ datas[i],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{class}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{ metadatas[i],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{pca}\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(source, }\AttributeTok{scale. =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{pca\_anno }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(pca[}\DecValTok{5}\NormalTok{])}

\NormalTok{output }\OtherTok{\textless{}{-}} \FunctionTok{ggbiplot}\NormalTok{(pca, }\AttributeTok{obs.scale =} \DecValTok{1}\NormalTok{, }\AttributeTok{var.scale =} \DecValTok{1}\NormalTok{, }\AttributeTok{groups =}\NormalTok{ class}\SpecialCharTok{$}\NormalTok{subgroup, }\AttributeTok{ellipse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{circle =} \ConstantTok{TRUE}\NormalTok{,}
            \AttributeTok{varname.size=}\DecValTok{0}\NormalTok{, }\AttributeTok{var.axes =}\NormalTok{ F) }\SpecialCharTok{+}
        \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{pca\_anno, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x.PC1, }\AttributeTok{y=}\NormalTok{x.PC2, }\AttributeTok{label=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{name),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(output,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{))}

\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pca_prcomp.r}{%
\section{File: pca\_prcomp.R}\label{file-pca_prcomp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{datas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*pca.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{(data }\ControlFlowTok{in}\NormalTok{ datas)\{}

\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(data,}\AttributeTok{split=}\StringTok{"\_pca.tsv"}\NormalTok{)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{data,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}

\NormalTok{pca}\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(data, }\AttributeTok{scale. =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{pca\_x}\OtherTok{=}\FunctionTok{data.frame}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{x)}

\NormalTok{rownames}\OtherTok{=}\FunctionTok{rownames}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{x)}

\NormalTok{pca\_x}\OtherTok{=}\FunctionTok{cbind}\NormalTok{(rownames,pca\_x)}

\NormalTok{pca}\OtherTok{=}\FunctionTok{summary}\NormalTok{(pca)}

\NormalTok{summary}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"summary"}\NormalTok{,}\FunctionTok{round}\NormalTok{(pca}\SpecialCharTok{$}\NormalTok{importance[}\DecValTok{2}\NormalTok{,],}\DecValTok{4}\NormalTok{))}

\NormalTok{pca\_x}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(pca\_x,summary)}

\FunctionTok{write.table}\NormalTok{(pca\_x, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".prcomp"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}

\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pearson_correlation.r}{%
\section{File: pearson\_correlation.R}\label{file-pearson_correlation.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(outliers)}
 
\NormalTok{grubbs}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x}\OtherTok{\textless{}{-}}\FunctionTok{round}\NormalTok{(x,}\DecValTok{4}\NormalTok{)}
\NormalTok{  grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
  \ControlFlowTok{while}\NormalTok{(grubbs\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{    grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_outliers,grubbs\_minormax)}
\NormalTok{    grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_p.value,grubbs\_pvalue)}
\NormalTok{    grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_g,grubbs\_g.value)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{    grubbs\_test}\OtherTok{\textless{}{-}}\FunctionTok{grubbs.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{10}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{    grubbs\_p}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_g.value}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{    grubbs\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(grubbs\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{    grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(grubbs\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{  outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{grubbs\_outliers,}\AttributeTok{gvalue=}\NormalTok{grubbs\_g,}\AttributeTok{pvalue=}\NormalTok{grubbs\_p.value)}
  \FunctionTok{return}\NormalTok{(outliner\_res)}

\NormalTok{\}}

\NormalTok{dixon}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(dixon\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{      dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_outliers,dixon\_minormax)}
\NormalTok{      dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_p.value,dixon\_pvalue)}
\NormalTok{      dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_q,dixon\_q.value)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)]}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{      dixon\_test}\OtherTok{\textless{}{-}}\FunctionTok{dixon.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{0}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{      dixon\_p}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_q.value}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{      dixon\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(dixon\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{      dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(dixon\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{    \}}
\NormalTok{    outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{dixon\_outliers,}\AttributeTok{qvalue=}\NormalTok{dixon\_q,}\AttributeTok{pvalue=}\NormalTok{dixon\_p.value)}
    \FunctionTok{return}\NormalTok{(outliner\_res)}
\NormalTok{  \}}

\NormalTok{savepath}\OtherTok{=}\StringTok{"correlation"}

\FunctionTok{dir.create}\NormalTok{(savepath)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fecal\_pos\_correlation.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}

\NormalTok{group}\OtherTok{=}\FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup)}

\NormalTok{data\_set}\OtherTok{=}\FunctionTok{array}\NormalTok{(}\ConstantTok{NA}\NormalTok{,}\AttributeTok{dim=}\FunctionTok{c}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data)}\SpecialCharTok{*}\DecValTok{3}\NormalTok{,}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{*}\DecValTok{3}\NormalTok{))}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{colnames}\NormalTok{(data))\{}
\NormalTok{    test}\OtherTok{\textless{}{-}}\FunctionTok{try}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(i)); }\ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(test)}\SpecialCharTok{==}\NormalTok{F)\{begin}\OtherTok{=}\NormalTok{i;}\ControlFlowTok{break}\NormalTok{\}\}}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data))\{}\ControlFlowTok{if}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data)[i]}\SpecialCharTok{==}\NormalTok{begin)\{begin}\OtherTok{=}\NormalTok{i\}\}}

\CommentTok{\#for(i in 3:(begin{-}1))\{data=data[which(is.na(data[,i])==F),]\}}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{3}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data))\{}

    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ group)\{}
 
\NormalTok{    X}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{j),i]}
    
\NormalTok{    n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{dixon}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{3}\NormalTok{)))}
    
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{grubbs}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{3}\NormalTok{)))\}}
    
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{out}\OtherTok{=}\ConstantTok{NULL}\NormalTok{\}}
    
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))\{x\_filter}\OtherTok{=}\NormalTok{X\}}\ControlFlowTok{else}\NormalTok{\{x\_filter}\OtherTok{=}\NormalTok{X[}\FunctionTok{which}\NormalTok{(X}\SpecialCharTok{!=}\FunctionTok{c}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))]\}}
        
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"team\_filter"}\NormalTok{)}\SpecialCharTok{==}\ConstantTok{TRUE}\NormalTok{)\{}
\NormalTok{            team\_filter}\OtherTok{=}\FunctionTok{c}\NormalTok{(team\_filter,x\_filter)}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{            team\_filter}\OtherTok{=}\FunctionTok{c}\NormalTok{(x\_filter)\}}
\NormalTok{    \}}
    
\NormalTok{    data\_set[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(team\_filter),i]}\OtherTok{=}\NormalTok{team\_filter}
    
    \FunctionTok{rm}\NormalTok{(team\_filter)\}    }

\FunctionTok{sink}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(savepath,}\StringTok{"/"}\NormalTok{,}\StringTok{"pearson\_p\_value"}\NormalTok{),}\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{split =} \ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{print}\NormalTok{(}\StringTok{"|factor|id|r|p\_value|"}\NormalTok{)}

\NormalTok{name\_set}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(data)}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{3}\SpecialCharTok{:}\NormalTok{(begin}\DecValTok{{-}1}\NormalTok{))\{}

    \ControlFlowTok{for}\NormalTok{(j }\ControlFlowTok{in}\NormalTok{ begin}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data))\{}

\NormalTok{    stat}\OtherTok{=}\FunctionTok{cor.test}\NormalTok{(data\_set[,i],data\_set[,j])}
    
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"|"}\NormalTok{,name\_set[i],}\StringTok{"|"}\NormalTok{,name\_set[j],}\StringTok{"|"}\NormalTok{,}\FunctionTok{as.vector}\NormalTok{(stat}\SpecialCharTok{$}\NormalTok{estimate),}\StringTok{"|"}\NormalTok{,stat}\SpecialCharTok{$}\NormalTok{p.value,}\StringTok{"|"}\NormalTok{))\}\}}

\FunctionTok{sink}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-phase1_propagation.r}{%
\section{File: phase1\_propagation.R}\label{file-phase1_propagation.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# library(igraph)}
\DocumentationTok{\#\# library(ggraph)}
\DocumentationTok{\#\# library(tidygraph)}
\DocumentationTok{\#\# library(ggsci)}
\DocumentationTok{\#\# library(scales)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggimage)}
\FunctionTok{library}\NormalTok{(grImport2)}
\FunctionTok{library}\NormalTok{(gridSVG)}
\FunctionTok{library}\NormalTok{(ggpubr)}
\FunctionTok{library}\NormalTok{(gridExtra)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(gt)}
\FunctionTok{library}\NormalTok{(Hmisc)}
\FunctionTok{library}\NormalTok{(stringr)}
\DocumentationTok{\#\# obabel, cairosvg, molconvert, these should be installed previously.}
\NormalTok{parse\_structure }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(smiles, id\_n)\{}
  \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"molconvert mol }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, smiles, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ {-}o Rtemp.mol"}\NormalTok{))}
  \FunctionTok{system}\NormalTok{(}\StringTok{"obabel Rtemp.mol {-}imol {-}osvg {-}O Rtemp.svg"}\NormalTok{)}
  \FunctionTok{system}\NormalTok{(}\StringTok{"cairosvg Rtemp.svg {-}o Rtemp.cairo.svg"}\NormalTok{)}
  \FunctionTok{assign}\NormalTok{(id\_n, }\FunctionTok{readPicture}\NormalTok{(}\StringTok{"Rtemp.cairo.svg"}\NormalTok{))}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{get}\NormalTok{(id\_n))}
\NormalTok{\}}
\DocumentationTok{\#\# grid 10(n) structure candidate}
\NormalTok{top }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(smiles\_list, }\AttributeTok{save\_id\_number=}\DecValTok{0}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"structure\_check"}\NormalTok{))\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Dir exist}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
    \FunctionTok{dir.create}\NormalTok{(}\StringTok{"structure\_check"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{)))\{}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"xdg{-}open "}\NormalTok{, }\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{cat}\NormalTok{(}\StringTok{"Image exist \textgreater{}\textgreater{}\textgreater{}"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{) ,}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{))}
\NormalTok{  \}}
  \DocumentationTok{\#\# draw structure in grid}
\NormalTok{  structure\_num}\OtherTok{=}\DecValTok{0}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ smiles\_list)\{}
\NormalTok{    structure\_num}\OtherTok{=}\NormalTok{structure\_num}\SpecialCharTok{+}\DecValTok{1}
    \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"project\_structure\_"}\NormalTok{, structure\_num), }\FunctionTok{parse\_structure}\NormalTok{(i, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"medium\_p"}\NormalTok{, structure\_num)))}
\NormalTok{  \}}
  \FunctionTok{svg}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{), }\AttributeTok{height=}\DecValTok{2}\NormalTok{, }\AttributeTok{width=}\DecValTok{2}\SpecialCharTok{*}\NormalTok{structure\_num)}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{structure\_num)\{}
    \FunctionTok{grid.picture}\NormalTok{( }\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"project\_structure\_"}\NormalTok{, i)) , }\AttributeTok{x=}\NormalTok{i}\SpecialCharTok{/}\NormalTok{(structure\_num}\SpecialCharTok{+}\DecValTok{1}\NormalTok{), }\AttributeTok{y=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{height=}\DecValTok{1}\NormalTok{, }\AttributeTok{width=}\DecValTok{1}\NormalTok{)}
\NormalTok{  \}}
  \FunctionTok{dev.off}\NormalTok{()}
  \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"xdg{-}open "}\NormalTok{, }\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{))}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Save Image \textgreater{}\textgreater{}\textgreater{}"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_check/"}\NormalTok{, save\_id\_number, }\StringTok{".svg"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\DocumentationTok{\#\# html table get}
\NormalTok{tab }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_branch, }\AttributeTok{list\_col=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"formula"}\NormalTok{))\{}
\NormalTok{  t }\OtherTok{\textless{}{-}} \FunctionTok{gt}\NormalTok{(data\_branch[, }\FunctionTok{colnames}\NormalTok{(data\_branch) }\SpecialCharTok{\%in\%}\NormalTok{ list\_col]) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{opt\_table\_font}\NormalTok{(}
    \AttributeTok{font=}\FunctionTok{list}\NormalTok{(}\FunctionTok{google\_font}\NormalTok{(}\AttributeTok{name=}\StringTok{"Times"}\NormalTok{))}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_header}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{md}\NormalTok{(}\StringTok{"**Features structure list**"}\NormalTok{)}
    \CommentTok{\#subtitle = md("\textasciigrave{}gtcars\textasciigrave{} is an R dataset")}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{opt\_align\_table\_header}\NormalTok{(}\AttributeTok{align =} \StringTok{"left"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{opt\_table\_lines}\NormalTok{(}\AttributeTok{extent =} \FunctionTok{c}\NormalTok{(}\StringTok{"none"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{cols\_align}\NormalTok{(}
    \AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
    \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}
        \AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"top"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}
\NormalTok{      ),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}
        \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
        \CommentTok{\#rows = 1:nrow(data\_branch)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}
        \AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}
\NormalTok{      ),}
      \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}
        \AttributeTok{columns=}\FunctionTok{everything}\NormalTok{(),}
        \AttributeTok{rows=}\FunctionTok{nrow}\NormalTok{(data\_branch)}
\NormalTok{      )}
\NormalTok{   ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}
        \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
        \CommentTok{\#rows = 1:nrow(data\_branch)}
\NormalTok{      )}
\NormalTok{   )}
  \FunctionTok{return}\NormalTok{(t)}
\NormalTok{\}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{database }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_candidate\_top10.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\DocumentationTok{\#\# catch and draw structure in db}
\NormalTok{smi }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id, }\AttributeTok{n=}\NormalTok{id)\{}
\NormalTok{  smiles }\OtherTok{\textless{}{-}}\NormalTok{ database[}\FunctionTok{which}\NormalTok{(database}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{==}\NormalTok{id), }\FunctionTok{colnames}\NormalTok{(database) }\SpecialCharTok{\%in\%} \StringTok{"smiles"}\NormalTok{] }
\NormalTok{  smiles }\OtherTok{\textless{}{-}} \FunctionTok{top}\NormalTok{(smiles,n)}
  \FunctionTok{return}\NormalTok{(smiles)}
\NormalTok{\}}
\DocumentationTok{\#\# smi\_batch\_save}
\NormalTok{smi\_batch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id, }\AttributeTok{n=}\NormalTok{id)\{}
\NormalTok{  smiles }\OtherTok{\textless{}{-}}\NormalTok{ database[}\FunctionTok{which}\NormalTok{(database}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{==}\NormalTok{id), }\FunctionTok{colnames}\NormalTok{(database) }\SpecialCharTok{\%in\%} \StringTok{"smiles"}\NormalTok{]}
\NormalTok{  smiles }\OtherTok{\textless{}{-}} \FunctionTok{top}\NormalTok{(smiles,n)}
\NormalTok{\}}
\DocumentationTok{\#\# catch and pretty table in db}
\NormalTok{sht }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id)\{}
\NormalTok{  table }\OtherTok{\textless{}{-}}\NormalTok{ database[}\FunctionTok{which}\NormalTok{(database}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{==}\NormalTok{id),] }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{tab}\NormalTok{()}
  \FunctionTok{return}\NormalTok{(table)}
\NormalTok{\}}
\DocumentationTok{\#\# replace the candidate structure annotation}
\NormalTok{rp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_pip, rp\_id, rank\_n,}
               \AttributeTok{col=}\FunctionTok{c}\NormalTok{(}\StringTok{"similarity"}\NormalTok{,}
                     \StringTok{"name"}\NormalTok{,}
                     \StringTok{"formula"}\NormalTok{,}
                     \StringTok{"xlogp"}\NormalTok{,}
                     \StringTok{"smiles"}\NormalTok{,}
                     \StringTok{"inchi"}\NormalTok{,}
                     \StringTok{"inchikey2D"}\NormalTok{,}
                     \StringTok{"links"}\NormalTok{))\{}
\NormalTok{  origin\_order}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(data\_pip)}
\NormalTok{  data\_pip}\OtherTok{\textless{}{-}}\NormalTok{data\_pip[,}\FunctionTok{order}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data\_pip))]}
\NormalTok{  database}\OtherTok{\textless{}{-}}\NormalTok{database[,}\FunctionTok{order}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(database))]}
\NormalTok{  data\_pip[}\FunctionTok{which}\NormalTok{(data\_pip}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{==}\NormalTok{rp\_id),}
       \FunctionTok{colnames}\NormalTok{(data\_pip) }\SpecialCharTok{\%in\%}\NormalTok{ col] }\OtherTok{\textless{}{-}}\NormalTok{ database[}\FunctionTok{which}\NormalTok{(database}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{==}\NormalTok{rp\_id)[rank\_n], }\FunctionTok{colnames}\NormalTok{(database) }\SpecialCharTok{\%in\%}\NormalTok{ col]}
\NormalTok{  data\_pip}\OtherTok{\textless{}{-}}\NormalTok{data\_pip[, }\FunctionTok{order}\NormalTok{(}\FunctionTok{factor}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data\_pip), }\AttributeTok{levels=}\NormalTok{origin\_order))]}
  \FunctionTok{return}\NormalTok{(data\_pip)}
\NormalTok{\}}
\NormalTok{cut\_line }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_pip, cut\_id)\{}
\NormalTok{  data\_pip }\OtherTok{\textless{}{-}}\NormalTok{ data\_pip[}\FunctionTok{which}\NormalTok{(data\_pip}\SpecialCharTok{$}\StringTok{"id"}\SpecialCharTok{!=}\NormalTok{cut\_id), ]}
  \FunctionTok{return}\NormalTok{(data\_pip)}
\NormalTok{\}}
\NormalTok{data\_save }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_pip, }\AttributeTok{file\_name=}\StringTok{"df"}\NormalTok{)\{}
\NormalTok{  time\_temp }\OtherTok{\textless{}{-}} \FunctionTok{date}\NormalTok{()}
  \FunctionTok{write.table}\NormalTok{(data\_pip, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(file\_name, }\StringTok{"\_"}\NormalTok{, time\_temp, }\StringTok{".tsv"}\NormalTok{),}
              \AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{quote=}\NormalTok{F)}
\NormalTok{\}}
\NormalTok{workflow }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id\_list, }\AttributeTok{sleep\_time=}\DecValTok{5}\NormalTok{, }\AttributeTok{data\_pip=}\NormalTok{data)\{}
\NormalTok{  cut\_id\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{()}
  \FunctionTok{system}\NormalTok{(}\StringTok{"echo \textgreater{} cut.list"}\NormalTok{)}
  \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ id\_list)\{}
    \FunctionTok{smi\_batch}\NormalTok{(i)}
\NormalTok{    cut\_else}\OtherTok{=}\FunctionTok{scan}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{nlines=}\DecValTok{1}\NormalTok{, }\AttributeTok{what=}\StringTok{"c"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(}\FunctionTok{try}\NormalTok{(cut\_else))}\SpecialCharTok{==}\StringTok{"try\_error"}\NormalTok{)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"Try again}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      cut\_else}\OtherTok{=}\FunctionTok{scan}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{nlines=}\DecValTok{1}\NormalTok{, }\AttributeTok{what=}\StringTok{"c"}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(cut\_else}\SpecialCharTok{==}\StringTok{"s"}\NormalTok{)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"Skip}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{next}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(cut\_else}\SpecialCharTok{==}\StringTok{"c"}\NormalTok{)\{}
\NormalTok{      cut\_id\_list}\OtherTok{=}\FunctionTok{c}\NormalTok{(cut\_id\_list, i)}
\NormalTok{      data\_pip}\OtherTok{=}\FunctionTok{cut\_line}\NormalTok{(data\_pip, i)}
      \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"echo "}\NormalTok{, i, }\StringTok{" \textgreater{}\textgreater{} cut.list"}\NormalTok{))}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"Cut the line of "}\NormalTok{, i, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(cut\_else))}\SpecialCharTok{==}\NormalTok{F)\{}
\NormalTok{      data\_pip}\OtherTok{=}\FunctionTok{rp}\NormalTok{(data\_pip, i, }\FunctionTok{as.numeric}\NormalTok{(cut\_else))}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"Replace id"}\NormalTok{, i, }\StringTok{"candidate}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(data\_pip)}
\NormalTok{\}}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{datapath}\OtherTok{=}\StringTok{"com\_1.tsv"}
\NormalTok{data}\OtherTok{=}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pretty_table.r-1}{%
\section{File: pretty\_table.R}\label{file-pretty_table.r-1}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# pretty table}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(reshape2)}
\FunctionTok{library}\NormalTok{(gt)}
\FunctionTok{library}\NormalTok{(Hmisc)}
\FunctionTok{library}\NormalTok{(stringr)}
\NormalTok{data\_save }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data\_pip, }\AttributeTok{file\_name=}\StringTok{"df"}\NormalTok{)\{}
\NormalTok{  time\_temp }\OtherTok{\textless{}{-}} \FunctionTok{date}\NormalTok{()}
  \FunctionTok{write.table}\NormalTok{(data\_pip, }\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(file\_name, }\StringTok{"\_"}\NormalTok{, time\_temp, }\StringTok{".tsv"}\NormalTok{),}
              \AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{quote=}\NormalTok{F)}
\NormalTok{\}}

\CommentTok{\# datapath0="com\_compound.tsv"}
\NormalTok{datapath0}\OtherTok{=}\StringTok{"merge.tsv"}
\CommentTok{\#datapath1="indraw\_lignans\_and\_iridoids.tsv"}
\NormalTok{datapath1}\OtherTok{=}\StringTok{"merge\_lignans\_and\_iridoids.tsv"}
\CommentTok{\#datapath11="iridoids\_Mon Jan  3 19:56:31 2022.tsv"}
\CommentTok{\#datapath1="com\_carboxylic\_acids.tsv"}
\NormalTok{datapath2}\OtherTok{=}\StringTok{"stat\_classification.tsv"}
\CommentTok{\# dataset \textless{}{-} read.csv(file=datapath0, header=T, sep="\textbackslash{}t")}
\CommentTok{\# dataset \textless{}{-} dataset[which(dataset$m.z \textgreater{} 193 \& dataset$m.z \textless{}194),]}
\CommentTok{\# write.table(dataset[,colnames(dataset) \%in\% c("id", "smiles")], file="test.tsv", sep="\textbackslash{}t", col.names=T, row.names=F)}
\NormalTok{data0 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath0, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data0 }\OtherTok{\textless{}{-}}\NormalTok{ data0[}\FunctionTok{order}\NormalTok{(data0}\SpecialCharTok{$}\NormalTok{id),]}
\NormalTok{data1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath1, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data1 }\OtherTok{\textless{}{-}}\NormalTok{ data1[}\FunctionTok{order}\NormalTok{(data1}\SpecialCharTok{$}\NormalTok{id),]}
\NormalTok{origin\_order}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(data1)}
\NormalTok{data1 }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data1, data0[,}\FunctionTok{colnames}\NormalTok{(data0) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"IUPACName"}\NormalTok{)], }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{data1 }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(data1, }\AttributeTok{extra\_name=}\FunctionTok{ifelse}\NormalTok{(}
\NormalTok{                                         name}\SpecialCharTok{!=}\StringTok{"null"}\NormalTok{, name,}
                                         \FunctionTok{ifelse}\NormalTok{(}
                                                \FunctionTok{is.na}\NormalTok{(IUPACName)}\SpecialCharTok{==}\NormalTok{T, }\StringTok{"null"}\NormalTok{, IUPACName}
\NormalTok{                                         )}
\NormalTok{)}
\NormalTok{)}
\NormalTok{data1 }\OtherTok{\textless{}{-}}\NormalTok{ data1[, }\SpecialCharTok{!}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data1) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"IUPACName"}\NormalTok{))]}
\FunctionTok{colnames}\NormalTok{(data1)[}\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data1)}\SpecialCharTok{==}\StringTok{"extra\_name"}\NormalTok{)]}\OtherTok{=}\StringTok{"name"}
\NormalTok{data1 }\OtherTok{\textless{}{-}}\NormalTok{ data1[, }\FunctionTok{order}\NormalTok{(}\FunctionTok{factor}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data1), }\AttributeTok{levels=}\NormalTok{origin\_order))]}
\FunctionTok{data\_save}\NormalTok{(data1, }\StringTok{"chem\_supple"}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#data11 \textless{}{-} read.csv(file=datapath11, header=T, sep="\textbackslash{}t")}
\CommentTok{\#data1 \textless{}{-} rbind(data1, data11)}
\NormalTok{data2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datapath2, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data1, data2, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{\textgreater{}}\FloatTok{0.45}\NormalTok{), ]}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[, }\FunctionTok{colnames}\NormalTok{(data\_branch) }\SpecialCharTok{\%in\%} 
    \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"rt"}\NormalTok{, }\StringTok{"m.z"}\NormalTok{, }\StringTok{"variety"}\NormalTok{, }\StringTok{"pro.raw"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"formula"}\NormalTok{, }\StringTok{"inchikey2D"}\NormalTok{, }\StringTok{"Index"}\NormalTok{)]}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[,}\FunctionTok{c}\NormalTok{(}\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data\_branch)}\SpecialCharTok{!=}\StringTok{"Index"}\NormalTok{), }\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data\_branch)}\SpecialCharTok{==}\StringTok{"Index"}\NormalTok{))]}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[}\FunctionTok{order}\NormalTok{(data\_branch}\SpecialCharTok{$}\NormalTok{inchikey2D, }\SpecialCharTok{{-}}\NormalTok{data\_branch}\SpecialCharTok{$}\NormalTok{similarity), ]}
\DocumentationTok{\#\# data\_branch \textless{}{-} data\_branch[!duplicated(data\_branch$inchikey2D), ] }
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[}\FunctionTok{order}\NormalTok{(data\_branch}\SpecialCharTok{$}\NormalTok{id, }\SpecialCharTok{{-}}\NormalTok{data\_branch}\SpecialCharTok{$}\NormalTok{similarity), ]}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(data\_branch}\SpecialCharTok{$}\NormalTok{id), ] }
\FunctionTok{colnames}\NormalTok{(data\_branch) }\OtherTok{\textless{}{-}} \FunctionTok{capitalize}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data\_branch))}
\FunctionTok{colnames}\NormalTok{(data\_branch)[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{6}\NormalTok{, }\DecValTok{10}\NormalTok{)] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"ID"}\NormalTok{, }\StringTok{"RT"}\NormalTok{, }\StringTok{"m/z"}\NormalTok{, }\StringTok{"Processing Variations"}\NormalTok{, }\StringTok{"Pro/Raw(peak area)"}\NormalTok{, }\StringTok{"Tanimoto similarity"}\NormalTok{, }\StringTok{"Classes"}\NormalTok{)}
\NormalTok{data\_branch}\SpecialCharTok{$}\NormalTok{Number }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data\_branch))}
\NormalTok{data\_branch }\OtherTok{\textless{}{-}}\NormalTok{ data\_branch[}\FunctionTok{c}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data\_branch), }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data\_branch)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{))]}
\CommentTok{\#data\_branch \textless{}{-} data\_branch[order(data\_branch[,colnames(data\_branch) \%in\% c("m/z")]),]}
\NormalTok{data\_branch}\SpecialCharTok{$}\NormalTok{Name }\OtherTok{\textless{}{-}} \FunctionTok{str\_wrap}\NormalTok{(data\_branch}\SpecialCharTok{$}\NormalTok{Name, }\AttributeTok{width=}\DecValTok{40}\NormalTok{)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{t }\OtherTok{\textless{}{-}} \FunctionTok{gt}\NormalTok{(data\_branch) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{opt\_table\_font}\NormalTok{(}
    \AttributeTok{font=}\FunctionTok{list}\NormalTok{(}\FunctionTok{google\_font}\NormalTok{(}\AttributeTok{name=}\StringTok{"Times"}\NormalTok{))}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_header}\NormalTok{(}
    \AttributeTok{title =} \FunctionTok{md}\NormalTok{(}\StringTok{"**Features of lignans and iridoids of \_Eucommia ulmoides\_ identified in LC{-}MS negative ion mode**"}\NormalTok{)}
    \CommentTok{\#subtitle = md("\textasciigrave{}gtcars\textasciigrave{} is an R dataset")}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{opt\_align\_table\_header}\NormalTok{(}\AttributeTok{align =} \StringTok{"left"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_footnote}\NormalTok{(}
               \AttributeTok{footnote =} \StringTok{"These features (compounds) were mainly obtained by phase I clustering of MCnebula. The structures of these compounds were manually picked from the top 10 ranked CSI:FingerID structure prediction candidates based on phase I clustering similarity propagation. The compounds with Tanimoto similarity (≤ 0.45) of picked structure were filtered. Note that MS/MS spectrum is fail in unequivocally ascertaining the molecular scaffold (i.e. geometrical isomers, position isomers) and 3D structure. Therefore, the structures of these compounds may be the respective isomers."}\NormalTok{,}
               \AttributeTok{locations =} \FunctionTok{cells\_title}\NormalTok{(}
                                       \AttributeTok{groups =} \FunctionTok{c}\NormalTok{(}\StringTok{"title"}\NormalTok{)}
\NormalTok{               )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{opt\_table\_lines}\NormalTok{(}\AttributeTok{extent =} \FunctionTok{c}\NormalTok{(}\StringTok{"none"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
    \FunctionTok{cols\_align}\NormalTok{(}
               \AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
    \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{cols\_width}\NormalTok{(}
\NormalTok{    Name }\SpecialCharTok{\textasciitilde{}} \FunctionTok{px}\NormalTok{(}\DecValTok{300}\NormalTok{)}
    \CommentTok{\# ends\_with("r") \textasciitilde{} px(100),}
    \CommentTok{\# starts\_with("date") \textasciitilde{} px(200),}
    \CommentTok{\# everything() \textasciitilde{} px(60)}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}
        \AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"top"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}
\NormalTok{      ),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{()}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}
        \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
        \CommentTok{\#rows = 1:nrow(data\_branch)}
\NormalTok{    )}
\NormalTok{  ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}
        \AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}
\NormalTok{      ),}
      \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}
        \AttributeTok{columns=}\FunctionTok{everything}\NormalTok{(),}
        \AttributeTok{rows=}\FunctionTok{nrow}\NormalTok{(data\_branch)}
\NormalTok{      )}
\NormalTok{   ) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{tab\_style}\NormalTok{(}
      \AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align=}\StringTok{"top"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}
        \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()}
        \CommentTok{\#rows = 1:nrow(data\_branch)}
\NormalTok{      )}
\NormalTok{   )}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pubchem_hub_merge.r}{%
\section{File: pubchem\_hub\_merge.R}\label{file-pubchem_hub_merge.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{data\_list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*smiles.csv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in}\NormalTok{ data\_list)\{}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{i, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{check.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{","}\NormalTok{)}
\NormalTok{  df }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(df, data)}
\NormalTok{\}}
\NormalTok{file }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"cid\_metadata.tsv"}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, file, }\AttributeTok{by.x=}\StringTok{"CID"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"cid"}\NormalTok{, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{sort=}\NormalTok{T)}
\CommentTok{\#file2 \textless{}{-} read.csv(file="../fingerid\_first\_score.tsv", check.names=F, sep="\textbackslash{}t", header=T)}
\NormalTok{file2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, file2, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{id), ]}
\FunctionTok{write.table}\NormalTok{(df, }\AttributeTok{file=}\StringTok{"merge.tsv"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{T, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{quote=}\NormalTok{F, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-heatmap.r}{%
\section{File: heatmap.R}\label{file-heatmap.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(pheatmap)}
\NormalTok{map}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"hot\_image{-}1.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{test}\OtherTok{=}\FunctionTok{pheatmap}\NormalTok{(map,}
    \AttributeTok{fontsize=}\DecValTok{5}\NormalTok{,}\AttributeTok{cellheight=}\DecValTok{10}\NormalTok{,}\AttributeTok{cellwidth=}\DecValTok{12}\NormalTok{,}\AttributeTok{border\_color=}\StringTok{"\#0a0404"}\NormalTok{,}
    \AttributeTok{treeheight\_row=}\DecValTok{15}\NormalTok{,}\AttributeTok{treeheight\_col=}\DecValTok{15}\NormalTok{,}
    \AttributeTok{clustering\_method =} \StringTok{"complete"}\NormalTok{,}
    \AttributeTok{color=}\FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#e60612"}\NormalTok{,}\StringTok{"\#e60612"}\NormalTok{,}\StringTok{"white"}\NormalTok{,}\StringTok{"\#4a85c5"}\NormalTok{,}\StringTok{"\#4a85c5"}\NormalTok{))(}\DecValTok{100}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"re\_heatmap.pdf"}\NormalTok{)}
\NormalTok{test}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#echo /media/wizard/Seagate/MDMN/sep\_neg0628/*\_*\_*/ | xargs {-}n 1 cp {-}v compound.config}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#heatmap}
\DocumentationTok{\#\# clustering\_method参数设定不同聚类方法，默认为"complete",可以设定为\textquotesingle{}ward\textquotesingle{}, \textquotesingle{}ward.D\textquotesingle{}, \textquotesingle{}ward.D2\textquotesingle{}, \textquotesingle{}single\textquotesingle{}, \textquotesingle{}complete\textquotesingle{}, \textquotesingle{}average\textquotesingle{}, \textquotesingle{}mcquitty\textquotesingle{}, \textquotesingle{}median\textquotesingle{} or \textquotesingle{}centroid\textquotesingle{}}
\DocumentationTok{\#\# clustering\_distance\_rows = "correlation"参数设定行聚类距离方法为Pearson corralation，默认为欧氏距离"euclidean"}
\CommentTok{\#clustering\_distance\_rows = "correlation")}
\CommentTok{\#clustering\_method = "ward")}
\FunctionTok{library}\NormalTok{(pheatmap)}
\NormalTok{map}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"hot\_image.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{group}\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"group.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{test}\OtherTok{=}\FunctionTok{pheatmap}\NormalTok{(map,}\AttributeTok{annotation\_row=}\NormalTok{group[}\DecValTok{1}\NormalTok{],}
    \AttributeTok{fontsize=}\DecValTok{5}\NormalTok{,}\AttributeTok{cellheight=}\DecValTok{10}\NormalTok{,}\AttributeTok{cellwidth=}\DecValTok{12}\NormalTok{,}\AttributeTok{border\_color=}\StringTok{"\#0a0404"}\NormalTok{,}
    \AttributeTok{treeheight\_row=}\DecValTok{15}\NormalTok{,}\AttributeTok{treeheight\_col=}\DecValTok{15}\NormalTok{,}
    \AttributeTok{clustering\_method =} \StringTok{"complete"}\NormalTok{,}
    \AttributeTok{color=}\FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#e60612"}\NormalTok{,}\StringTok{"\#e60612"}\NormalTok{,}\StringTok{"white"}\NormalTok{,}\StringTok{"\#4a85c5"}\NormalTok{,}\StringTok{"\#4a85c5"}\NormalTok{))(}\DecValTok{100}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"heatmap.pdf"}\NormalTok{)}
\NormalTok{test}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\# pca ggbiplot}



\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\FunctionTok{library}\NormalTok{(ggrepel)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggpmisc)}

\NormalTok{datas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*pca.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(datas[}\DecValTok{1}\NormalTok{],}\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
\NormalTok{source}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{ datas[}\DecValTok{1}\NormalTok{],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{class}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"metadata\_level.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{pca}\OtherTok{\textless{}{-}} \FunctionTok{prcomp}\NormalTok{(source, }\AttributeTok{scale. =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{pca\_anno }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(pca[}\DecValTok{5}\NormalTok{])}
\NormalTok{pca}\OtherTok{\textless{}{-}}\FunctionTok{cbind}\NormalTok{(pca\_anno,class)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(pca, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{x.PC1, }\AttributeTok{y=}\NormalTok{x.PC2, }\AttributeTok{fill=}\NormalTok{level)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+}
    \CommentTok{\#stat\_ellipse(aes(color=class$subgroup), level = 0.95) +}
    \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=} \FunctionTok{guide\_colourbar}\NormalTok{(}\AttributeTok{order =} \DecValTok{1}\NormalTok{)) }\SpecialCharTok{+}
    
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{"\_level.svg"}\NormalTok{))}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#pca  {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}ropls}
\FunctionTok{library}\NormalTok{(ropls)}
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\NormalTok{source}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"fecal\_pos\_YH\_oplsda.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{class}\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"metadata\_YH\_oplsda.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{pca }\OtherTok{\textless{}{-}} \FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ source)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ pca}\SpecialCharTok{@}\NormalTok{scoreMN}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(df)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p1, }\AttributeTok{y=}\NormalTok{p2, }\AttributeTok{fill=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{svg}\NormalTok{(}\StringTok{"raw\_and\_pro\_YH\_pca\_Nversion.svg"}\NormalTok{, }\AttributeTok{height=}\DecValTok{6}\NormalTok{, }\AttributeTok{width=}\DecValTok{10}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()   }

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#pls{-}da}

\FunctionTok{library}\NormalTok{(ropls)}
\FunctionTok{library}\NormalTok{(ggbiplot)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(scales)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"fecal\_pos\_pca.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}
\NormalTok{class }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=} \StringTok{"metadata.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{row.names=} \DecValTok{1}\NormalTok{,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}
\NormalTok{plsda }\OtherTok{\textless{}{-}} \FunctionTok{opls}\NormalTok{(}\AttributeTok{x =}\NormalTok{ data, }\AttributeTok{y =}\NormalTok{ class[, }\StringTok{"subgroup"}\NormalTok{], }\AttributeTok{orthoI =} \DecValTok{0}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ plsda}\SpecialCharTok{@}\NormalTok{scoreMN}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(df)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p1, }\AttributeTok{y=}\NormalTok{p2, }\AttributeTok{fill=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{subgroup)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{stat\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\NormalTok{class}\SpecialCharTok{$}\NormalTok{subgroup), }\AttributeTok{level =} \FloatTok{0.95}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}

\FunctionTok{svg}\NormalTok{(}\StringTok{"pls\_da\_ggplot.svg"}\NormalTok{, }\AttributeTok{height=}\DecValTok{6}\NormalTok{, }\AttributeTok{width=}\DecValTok{10}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()   }

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\# opls{-}da}
\DocumentationTok{\#\#}


\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}




\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#boxplot}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{source}\OtherTok{\textless{}{-}}\FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\StringTok{"chang"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{boxplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(source,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{days,}\AttributeTok{y=}\NormalTok{length,}\AttributeTok{fill=}\NormalTok{days))}\SpecialCharTok{+}
  \FunctionTok{stat\_boxplot}\NormalTok{(}\AttributeTok{geom=}\StringTok{"errorbar"}\NormalTok{,}\AttributeTok{width=}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width=}\FloatTok{0.7}\NormalTok{)}\SpecialCharTok{+}
  \FunctionTok{geom\_dotplot}\NormalTok{(}\AttributeTok{binaxis =}\StringTok{"y"}\NormalTok{,}
               \AttributeTok{stackdir=}\StringTok{"center"}\NormalTok{,}
               \CommentTok{\#position="jitter",}
               \AttributeTok{dotsize =} \FloatTok{0.4}\NormalTok{,)}\SpecialCharTok{+}
  \FunctionTok{stat\_summary}\NormalTok{(}\AttributeTok{fun.y=}\StringTok{"mean"}\NormalTok{,}\AttributeTok{geom=}\StringTok{"point"}\NormalTok{,}\AttributeTok{shape=}\DecValTok{23}\NormalTok{,}\AttributeTok{size=}\DecValTok{3}\NormalTok{,}\AttributeTok{fill=}\StringTok{"grey"}\NormalTok{)}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"output\_boxplot.pdf"}\NormalTok{)}
\NormalTok{boxplot}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#bar}
\FunctionTok{library}\NormalTok{(ggplot2)}
\NormalTok{source}\OtherTok{\textless{}{-}}\FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\StringTok{"bar.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{mzscale}\OtherTok{=}\DecValTok{1200}
\NormalTok{colwidth}\OtherTok{=}\NormalTok{mzscale}\SpecialCharTok{/}\DecValTok{200}
\NormalTok{barplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(source, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{abun)) }\SpecialCharTok{+} 
\FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat=}\StringTok{"identity"}\NormalTok{,}\AttributeTok{width=}\NormalTok{colwidth,}\AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{abun}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{+} 
\FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{0.95}\NormalTok{,}\AttributeTok{color=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{abun}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{)) }\SpecialCharTok{+} 
\FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,mzscale) }\SpecialCharTok{+}
\FunctionTok{theme}\NormalTok{(}\AttributeTok{panel.background=}\FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{\textquotesingle{}transparent\textquotesingle{}}\NormalTok{,}\AttributeTok{color=}\StringTok{\textquotesingle{}white\textquotesingle{}}\NormalTok{),}
    \AttributeTok{panel.grid=}\FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{\textquotesingle{}grey85\textquotesingle{}}\NormalTok{), }\AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"output\_bar.pdf"}\NormalTok{)}
\NormalTok{barplot}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{行列布局}
\FunctionTok{grid.newpage}\NormalTok{()}
\FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)))}
\FunctionTok{print}\NormalTok{(p.scatter, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{))}
\FunctionTok{print}\NormalTok{(p.hist.len, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{1}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{))}
\FunctionTok{print}\NormalTok{(p.hist.wid, }\AttributeTok{vp=}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row=}\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{, }\AttributeTok{layout.pos.col=}\DecValTok{3}\NormalTok{))}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{library}\NormalTok{(ggplot2)}
\CommentTok{\# prepare ggplot charts}
\NormalTok{p.hist.len }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Sepal.Length))}
\NormalTok{p.hist.wid }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+} \FunctionTok{geom\_histogram}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Sepal.Width)) }\SpecialCharTok{+} \FunctionTok{coord\_flip}\NormalTok{()}
\NormalTok{p.scatter }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(iris) }\SpecialCharTok{+} \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{Sepal.Length, }\AttributeTok{y=}\NormalTok{Sepal.Width))}
 
 
 
 

\CommentTok{\# create viewports}
\FunctionTok{library}\NormalTok{(grid)}
\FunctionTok{grid.newpage}\NormalTok{()}
\NormalTok{vp1 }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{x=}\DecValTok{0}\NormalTok{, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{width=}\DecValTok{5}\NormalTok{, }\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\NormalTok{vp2 }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{x=}\DecValTok{0}\NormalTok{, }\AttributeTok{y=}\DecValTok{0}\NormalTok{, }\AttributeTok{width=}\DecValTok{2}\NormalTok{, }\AttributeTok{height=}\DecValTok{2}\NormalTok{)}
 
\CommentTok{\# direct the charts into the specified viewport}
\NormalTok{s1 }\OtherTok{\textless{}{-}} \FunctionTok{print}\NormalTok{(p, }\AttributeTok{vp=}\NormalTok{vp1)}
\NormalTok{s2 }\OtherTok{\textless{}{-}} \FunctionTok{print}\NormalTok{(l, }\AttributeTok{vp=}\NormalTok{vp2)}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(}\StringTok{"grImport2"}\NormalTok{)}
\FunctionTok{readPicture}\NormalTok{(}\StringTok{"file"}\NormalTok{)}
\FunctionTok{grid.picture}\NormalTok{(var)}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{library}\NormalTok{(visNetwork)}
\NormalTok{lists }\OtherTok{=} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\StringTok{"net.csv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{nodes }\OtherTok{=} \FunctionTok{read.table}\NormalTok{()}
\NormalTok{edges }\OtherTok{=} \FunctionTok{read.table}\NormalTok{()}

\NormalTok{network }\OtherTok{=} \FunctionTok{visNetwork}\NormalTok{(nodes, edges, }\AttributeTok{height =} \StringTok{"100\%"}\NormalTok{, }\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{)}
\NormalTok{htmlwidgets}\SpecialCharTok{::}\FunctionTok{saveWidget}\NormalTok{(network, }\StringTok{"network.html"}\NormalTok{)}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#Radial bar plot}

\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(}\AttributeTok{file=}\NormalTok{args[}\DecValTok{1}\NormalTok{],}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
  \AttributeTok{individual=}\FunctionTok{paste}\NormalTok{( }\StringTok{"Mister "}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{60}\NormalTok{), }\AttributeTok{sep=}\StringTok{""}\NormalTok{),}
  \AttributeTok{group=}\FunctionTok{c}\NormalTok{( }\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, }\DecValTok{10}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\DecValTok{30}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{, }\DecValTok{14}\NormalTok{), }\FunctionTok{rep}\NormalTok{(}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{, }\DecValTok{6}\NormalTok{)),}
  \AttributeTok{value1=}\FunctionTok{sample}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{100}\NormalTok{), }\DecValTok{60}\NormalTok{, }\AttributeTok{replace=}\NormalTok{T),}
  \AttributeTok{value2=}\FunctionTok{sample}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{100}\NormalTok{), }\DecValTok{60}\NormalTok{, }\AttributeTok{replace=}\NormalTok{T),}
  \AttributeTok{value3=}\FunctionTok{sample}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{,}\DecValTok{100}\NormalTok{), }\DecValTok{60}\NormalTok{, }\AttributeTok{replace=}\NormalTok{T)}
\NormalTok{)}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{gather}\NormalTok{(}\AttributeTok{key =} \StringTok{"observation"}\NormalTok{, }\AttributeTok{value=}\StringTok{"value"}\NormalTok{, }\SpecialCharTok{{-}}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{)) }
\NormalTok{nObsType }\OtherTok{\textless{}{-}} \FunctionTok{nlevels}\NormalTok{(}\FunctionTok{as.factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{observation))}
\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{arrange}\NormalTok{(group, individual)}
\NormalTok{data}\SpecialCharTok{$}\NormalTok{id }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{( }\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(data)}\SpecialCharTok{/}\NormalTok{nObsType), }\AttributeTok{each=}\NormalTok{nObsType)}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\NormalTok{label\_data }\OtherTok{\textless{}{-}}\NormalTok{ data }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{group\_by}\NormalTok{(id, individual) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{summarize}\NormalTok{(}\AttributeTok{tot=}\FunctionTok{sum}\NormalTok{(value))}
\NormalTok{number\_of\_bar }\OtherTok{\textless{}{-}} \FunctionTok{nrow}\NormalTok{(label\_data)}
\NormalTok{angle }\OtherTok{\textless{}{-}} \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ (label\_data}\SpecialCharTok{$}\NormalTok{id}\FloatTok{{-}0.5}\NormalTok{) }\SpecialCharTok{/}\NormalTok{number\_of\_bar}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{hjust }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{( angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}} \SpecialCharTok{{-}}\DecValTok{90}\NormalTok{, angle}\SpecialCharTok{+}\DecValTok{180}\NormalTok{, angle)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+}
  \FunctionTok{geom\_bar}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{as.factor}\NormalTok{(id), }\AttributeTok{y=}\NormalTok{value, }\AttributeTok{fill=}\NormalTok{observation), }\AttributeTok{stat=}\StringTok{"identity"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_fill\_brewer}\NormalTok{(}\AttributeTok{palette =} \StringTok{"Paired"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{150}\NormalTok{,}\FunctionTok{max}\NormalTok{(label\_data}\SpecialCharTok{$}\NormalTok{tot, }\AttributeTok{na.rm=}\NormalTok{T)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{), }\StringTok{"cm"}\NormalTok{) }
\NormalTok{  ) }\SpecialCharTok{+}
  \FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{label\_data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{id, }\AttributeTok{y=}\NormalTok{tot}\SpecialCharTok{+}\DecValTok{10}\NormalTok{, }\AttributeTok{label=}\NormalTok{individual, }\AttributeTok{hjust=}\NormalTok{hjust), }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\DecValTok{5}\NormalTok{, }\AttributeTok{angle=}\NormalTok{ label\_data}\SpecialCharTok{$}\NormalTok{angle, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{ )}

\FunctionTok{png}\NormalTok{(}\StringTok{\textquotesingle{}tr\_tst2.png\textquotesingle{}}\NormalTok{,}\AttributeTok{width=}\DecValTok{300}\NormalTok{,}\AttributeTok{height=}\DecValTok{300}\NormalTok{,}\AttributeTok{units=}\StringTok{"px"}\NormalTok{,}\AttributeTok{bg=}\StringTok{"transparent"}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\FunctionTok{nodes}\NormalTok{(imagepath,shape}\StringTok{"image"}\NormalTok{)}
\NormalTok{nodes }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{, }
                    \AttributeTok{shape =} \FunctionTok{c}\NormalTok{(}\StringTok{"image"}\NormalTok{, }\StringTok{"circularImage"}\NormalTok{),}
                    \AttributeTok{label =} \StringTok{"I\textquotesingle{}m an image"}\NormalTok{)}



\FunctionTok{visNetwork}\NormalTok{(nodes, edges) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{visPhysics}\NormalTok{(}\AttributeTok{stabilization =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{visNodes}\NormalTok{(}\AttributeTok{shapeProperties =} \FunctionTok{list}\NormalTok{(}\AttributeTok{useBorderWithImage =} \ConstantTok{FALSE}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{visEdges}\NormalTok{(}\AttributeTok{smooth =} \ConstantTok{FALSE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \CommentTok{\#visIgraphLayout() \%\textgreater{}\%}
  \FunctionTok{visOptions}\NormalTok{(}\AttributeTok{highlightNearest =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{nodesIdSelection =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{selectedBy =} \StringTok{"group"}\NormalTok{, }\AttributeTok{manipulation =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{visLayout}\NormalTok{(}\AttributeTok{randomSeed =} \DecValTok{123}\NormalTok{)}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#bubble plot}
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggpmisc)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fecal\_pos\_mzmine.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{xlogp, }\AttributeTok{size=}\NormalTok{similarity, }\AttributeTok{fill=}\NormalTok{m.z, }\AttributeTok{color=}\FunctionTok{str\_wrap}\NormalTok{(classification,}\DecValTok{30}\NormalTok{))) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{se=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"skyblue"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_mark\_ellipse}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color=}\FunctionTok{str\_wrap}\NormalTok{(classification,}\DecValTok{30}\NormalTok{)), }\AttributeTok{alpha=}\FloatTok{0.1}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.2}\NormalTok{, }\AttributeTok{expand=}\FloatTok{0.02}\NormalTok{, }\AttributeTok{fill=}\ConstantTok{NA}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{size=}\StringTok{"Similarity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{colour=}\StringTok{"Classification"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_cartesian}\NormalTok{(}\AttributeTok{clip =} \StringTok{"off"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size\_continuous}\NormalTok{( }\AttributeTok{trans=}\StringTok{"exp"}\NormalTok{, }\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"bubble.pdf"}\NormalTok{,}\AttributeTok{width=}\DecValTok{7}\NormalTok{,}\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggpmisc)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"0.5\_com\_compound.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{xlogp, }\AttributeTok{size=}\NormalTok{similarity, }\AttributeTok{fill=}\NormalTok{m.z, }\AttributeTok{color=}\NormalTok{classification)) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{se=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"skyblue"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size\_continuous}\NormalTok{(}\AttributeTok{trans=}\StringTok{"exp"}\NormalTok{, }\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}
   \AttributeTok{colour =} \StringTok{"none"}\NormalTok{, }
   \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\AttributeTok{order =} \DecValTok{1}\NormalTok{),}
   \AttributeTok{size =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{order =} \DecValTok{2}\NormalTok{)}
\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"sep\_bubble.pdf"}\NormalTok{,}\AttributeTok{width=}\DecValTok{7}\NormalTok{,}\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{library}\NormalTok{(ggforce)}
\FunctionTok{library}\NormalTok{(ggpmisc)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"0.5\_com\_compound.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{data\_sep }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{m.z}\SpecialCharTok{\textless{}=}\DecValTok{800} \SpecialCharTok{\&}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{m.z}\SpecialCharTok{\textgreater{}=}\DecValTok{400}\NormalTok{),]}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data\_sep, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{xlogp, }\AttributeTok{size=}\NormalTok{similarity, }\AttributeTok{fill=}\NormalTok{m.z, }\AttributeTok{color=}\NormalTok{classification)) }\SpecialCharTok{+}
  \FunctionTok{geom\_smooth}\NormalTok{(}\AttributeTok{method =} \StringTok{"lm"}\NormalTok{, }\AttributeTok{se=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"skyblue"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{, }\AttributeTok{size=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{formula =}\NormalTok{ y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ x) }\SpecialCharTok{+}
  
  \FunctionTok{stat\_cor}\NormalTok{(}\AttributeTok{method =} \StringTok{"pearson"}\NormalTok{,}\AttributeTok{label.x =} \DecValTok{3}\NormalTok{, }\AttributeTok{label.y =} \DecValTok{30}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{stat\_poly\_eq}\NormalTok{(}
    \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ ..eq.label..),}
    \AttributeTok{formula =}\NormalTok{ formula,}\AttributeTok{parse =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{geom =} \StringTok{"text"}\NormalTok{,}\AttributeTok{label.x =} \DecValTok{3}\NormalTok{,}\AttributeTok{label.y =} \DecValTok{28}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
     
  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{stroke=}\FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size\_continuous}\NormalTok{(}\AttributeTok{trans=}\StringTok{"exp"}\NormalTok{, }\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{)) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}
   \AttributeTok{colour =} \StringTok{"none"}\NormalTok{, }
   \AttributeTok{fill =} \FunctionTok{guide\_colourbar}\NormalTok{(}\AttributeTok{order =} \DecValTok{1}\NormalTok{),}
   \AttributeTok{size =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{order =} \DecValTok{2}\NormalTok{)}
\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"sep\_bubble\_400\_800.pdf"}\NormalTok{,}\AttributeTok{width=}\DecValTok{7}\NormalTok{,}\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\CommentTok{\#rank}
\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"rank.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rank, }\AttributeTok{y=}\NormalTok{log10\_raw, }\AttributeTok{size=}\NormalTok{similarity),}\AttributeTok{fill=}\StringTok{"\#99CCFF"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{stroke=}\FloatTok{0.001}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rank, }\AttributeTok{y=}\NormalTok{log10\_pro, }\AttributeTok{size=}\NormalTok{similarity),}\AttributeTok{fill=}\StringTok{"\#FF6666"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.4}\NormalTok{, }\AttributeTok{shape=}\DecValTok{21}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{stroke=}\FloatTok{0.001}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{scale\_size\_continuous}\NormalTok{(}\AttributeTok{trans=}\StringTok{"exp"}\NormalTok{, }\AttributeTok{range=}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{)) }\SpecialCharTok{+}
   \FunctionTok{guides}\NormalTok{(}
   \AttributeTok{colour =} \StringTok{"none"}\NormalTok{,}
   \AttributeTok{size =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{order =} \DecValTok{2}\NormalTok{)}
\NormalTok{ ) }\SpecialCharTok{+}
  \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =} \StringTok{"log10(area)"}\NormalTok{)}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{))}
\FunctionTok{pdf}\NormalTok{(}\StringTok{"rank.pdf"}\NormalTok{,}\AttributeTok{width=}\DecValTok{7}\NormalTok{,}\AttributeTok{height=}\DecValTok{5}\NormalTok{)}
\NormalTok{p}
\FunctionTok{dev.off}\NormalTok{()}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}

\FunctionTok{library}\NormalTok{(ggplot2)}

\FunctionTok{library}\NormalTok{(ggforce)}

\FunctionTok{library}\NormalTok{(ggrepel)}

\NormalTok{n}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ (x }\ControlFlowTok{in}\NormalTok{ n) \{}

\NormalTok{file }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(x, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}

\NormalTok{savename}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(file,}\StringTok{".svg"}\NormalTok{)}

\NormalTok{source}\OtherTok{\textless{}{-}}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(file,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\NormalTok{source\_anno}\OtherTok{=}\NormalTok{source[}\FunctionTok{which}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textless{}}\DecValTok{0}\NormalTok{),]}

\NormalTok{barplot}\OtherTok{\textless{}{-}}\FunctionTok{ggplot}\NormalTok{(source, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{rel.intensity)) }\SpecialCharTok{+} 

  \FunctionTok{geom\_bar}\NormalTok{(}\AttributeTok{stat=}\StringTok{"identity"}\NormalTok{,}\AttributeTok{width=}\FunctionTok{max}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{mz)}\SpecialCharTok{/}\DecValTok{150}\NormalTok{,}\AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"red"}\NormalTok{)) }\SpecialCharTok{+} 

  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size=}\FloatTok{1.3}\NormalTok{,}\AttributeTok{color=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{rel.intensity}\SpecialCharTok{\textgreater{}}\DecValTok{0}\NormalTok{,}\StringTok{"black"}\NormalTok{,}\StringTok{"red"}\NormalTok{),}\AttributeTok{alpha=}\FunctionTok{ifelse}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{match}\SpecialCharTok{==}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{+} 
  
  \FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FunctionTok{max}\NormalTok{(source}\SpecialCharTok{$}\NormalTok{mz, }\AttributeTok{na.rm=}\NormalTok{T)}\SpecialCharTok{+}\DecValTok{50}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{90}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,source[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(source) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"precursor.m.z"}\NormalTok{)]),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
            
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{78}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{, source[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(source) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"RT..min."}\NormalTok{)]),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
            
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \DecValTok{10}\NormalTok{, }\AttributeTok{y =} \DecValTok{66}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Tanimoto similarity: "}\NormalTok{, source[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(source) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"similarity"}\NormalTok{)]),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{source\_anno, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{mz, }\AttributeTok{y=}\NormalTok{rel.intensity, }\AttributeTok{label=}\FunctionTok{round}\NormalTok{(mz,}\DecValTok{2}\NormalTok{)),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{ylim=}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{), }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{,}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
  
  \CommentTok{\# annotate("curve", x = source\_anno$mz+1, xend = source\_anno$mz+4, y = source\_anno$rel.intensity{-}3, yend = source\_anno$y\_label,}
  \CommentTok{\#          colour = "black", curvature =0, size=0.1, alpha=0.5, arrow = arrow(length = unit(0.5, "mm"))) +}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}

  \AttributeTok{panel.background=}\FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill=}\StringTok{"transparent"}\NormalTok{,}\AttributeTok{color=}\StringTok{"white"}\NormalTok{),}

  \AttributeTok{panel.grid=}\FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color=}\StringTok{"grey85"}\NormalTok{), }

  \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}
  
\FunctionTok{ggsave}\NormalTok{(barplot,}\AttributeTok{file=}\NormalTok{savename,}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}

\FunctionTok{print}\NormalTok{(file)\}}

\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}


 
 
   
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\# line}
 
 \FunctionTok{library}\NormalTok{(ggplot2)}
 
 \FunctionTok{library}\NormalTok{(ggrepel)}
 
 \FunctionTok{library}\NormalTok{(ggsci)}
 
\NormalTok{ list }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ list)\{}
 
\NormalTok{ savename }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}
 
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group}\SpecialCharTok{!=}\StringTok{""}\NormalTok{),]}
 
\NormalTok{ data\_anno\_mz }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"mz"}\NormalTok{)]}
 
\NormalTok{ data\_anno\_rt }\OtherTok{\textless{}{-}}\NormalTok{ data[}\DecValTok{1}\NormalTok{,}\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"center\_rt"}\NormalTok{)]}
 
\NormalTok{ tolerance }\OtherTok{=} \FloatTok{0.005}
 
\NormalTok{ data\_label }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{label}\SpecialCharTok{==}\DecValTok{1}\NormalTok{),]}
 
\NormalTok{ anno\_x\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt))}
 
\NormalTok{ anno\_y\_range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity))}
 
\NormalTok{ delta }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}\SpecialCharTok{{-}}\FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt)}
 
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{group=}\NormalTok{sample, }\AttributeTok{colour=}\NormalTok{group)) }\SpecialCharTok{+}
 
  \FunctionTok{geom\_line}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_label\_repel}\NormalTok{(}\AttributeTok{data=}\NormalTok{data\_label, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{rt, }\AttributeTok{y=}\NormalTok{intensity, }\AttributeTok{label=}\NormalTok{sample),}
                      \AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{alpha=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{angle=} \DecValTok{0}\NormalTok{, }\AttributeTok{xlim=}\NormalTok{anno\_x\_range, }\AttributeTok{ylim=}\NormalTok{anno\_y\_range,}
                      \AttributeTok{direction=}\StringTok{"both"}\NormalTok{, }\AttributeTok{segment.size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{segment.alpha =} \FloatTok{0.3}\NormalTok{, }\AttributeTok{force =} \DecValTok{1}\NormalTok{,}
                      \AttributeTok{nudge\_x =} \FunctionTok{runif}\NormalTok{(}\DecValTok{1}\NormalTok{, }\AttributeTok{min=}\NormalTok{delta}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{18}\NormalTok{), }\AttributeTok{max=}\NormalTok{delta}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{)), }\AttributeTok{nudge\_y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{10}\NormalTok{),}
                      \AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{,}
                      \AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
                      
  \FunctionTok{scale\_color\_npg}\NormalTok{() }\SpecialCharTok{+}
  
  \FunctionTok{scale\_fill\_npg}\NormalTok{() }\SpecialCharTok{+}
  
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{color=}\StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x=}\StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{16}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Precursor m/z: "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{{-}}\NormalTok{tolerance,}\StringTok{" \textasciitilde{} "}\NormalTok{,data\_anno\_mz}\SpecialCharTok{+}\NormalTok{tolerance),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
  
  \FunctionTok{annotate}\NormalTok{(}\StringTok{"text"}\NormalTok{, }\AttributeTok{x =} \FunctionTok{min}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{rt), }\AttributeTok{y =} \FunctionTok{max}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{intensity)}\SpecialCharTok{*}\NormalTok{(}\DecValTok{15}\SpecialCharTok{/}\DecValTok{20}\NormalTok{), }
        \AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"RT (min): "}\NormalTok{,data\_anno\_rt),}
            \AttributeTok{color=}\StringTok{"black"}\NormalTok{,}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{ ) }\SpecialCharTok{+}
  
  \CommentTok{\#theme\_minimal() +}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
  
    \AttributeTok{legend.position =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.85}\NormalTok{,}\FloatTok{0.75}\NormalTok{),}
    
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}
    
    \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}

    \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}

 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
 
 \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"Finish \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,file))\}}

 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \CommentTok{\# python Draw smiles}
 
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 \CommentTok{\#change svg to pdf}
 
 \FunctionTok{library}\NormalTok{(rsvg)}
 
\NormalTok{ files}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.svg$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
           
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ files)\{}
 
\NormalTok{   name\_set}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".svg"}\NormalTok{)}
   
\NormalTok{   id}\OtherTok{=}\NormalTok{name\_set[}\DecValTok{1}\NormalTok{]}
   
\NormalTok{   savename}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(id,}\StringTok{".pdf"}\NormalTok{)}
   
   \FunctionTok{rsvg\_pdf}\NormalTok{(file, savename)}
\NormalTok{   \}}

 \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
 
 \FunctionTok{library}\NormalTok{(staplr)}
 
\NormalTok{ ms1}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"EIC\_rt\_during"}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.pdf$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 
 \ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ ms1)\{}
 
\NormalTok{ id}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".pdf"}\NormalTok{)}
 
\NormalTok{ ms1}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"EIC\_rt\_during/"}\NormalTok{,id,}\StringTok{".pdf"}\NormalTok{)}
 
\NormalTok{ ms2}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ms2\_figures\_label/"}\NormalTok{,id,}\StringTok{".pdf"}\NormalTok{)}
 
\NormalTok{ structure}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_2d/"}\NormalTok{,id,}\StringTok{".pdf"}\NormalTok{)}
 
\NormalTok{ gather}\OtherTok{=}\FunctionTok{c}\NormalTok{(ms1, ms2, structure)}
 
\NormalTok{ savename}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"report\_pdf/"}\NormalTok{,file)}
 
 \FunctionTok{staple\_pdf}\NormalTok{(}\AttributeTok{input\_files=}\NormalTok{gather, }\AttributeTok{output\_filepath=}\NormalTok{ savename)}
\NormalTok{ \}}


\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\#t.test and volcano}


\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\# Pearson correlation coefficient}



\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\# linear regression}



\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#}
\DocumentationTok{\#\#\# volcano plot}



\DocumentationTok{\#\#\#\#\#\#\#\# network}

\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(igraph)}
\FunctionTok{library}\NormalTok{(ggraph)}
\FunctionTok{library}\NormalTok{(tidygraph)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-annotate_child_nebula.r}{%
\section{File: annotate\_child\_nebula.R}\label{file-annotate_child_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annotate\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{compound\_class\_list =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{height =} \StringTok{"auto"}\NormalTok{,}
           \AttributeTok{width =} \StringTok{"auto"}\NormalTok{,}
           \AttributeTok{plot\_nodes\_id =}\NormalTok{ T,}
           \AttributeTok{plot\_structure =}\NormalTok{ T,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ T,}
           \AttributeTok{ratio\_df =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{merge\_image =}\NormalTok{ T,}
           \AttributeTok{return\_plot =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: annotate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# all nodes in graph}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}\SpecialCharTok{$}\StringTok{".id"}
    \DocumentationTok{\#\# get top compound class (nodes\_color data)}
    \DocumentationTok{\#\# as well as, collate metadata}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_class\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# as data.frame}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.id }\SpecialCharTok{\%in\%}\NormalTok{ nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# filter via nodes}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# push environment name into parent.env, let some data could be catch in sub{-}environment via \textquotesingle{}get\textquotesingle{} function}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# gather data for annotation (nebula\_name, hierarchy)}
\NormalTok{    hierarchy }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{head}\NormalTok{(}\AttributeTok{n =} \DecValTok{1}\NormalTok{)}
\NormalTok{    anno }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\AttributeTok{nebula\_index =}\NormalTok{ nebula\_name, }\AttributeTok{hierarchy =}\NormalTok{ hierarchy}\SpecialCharTok{$}\NormalTok{hierarchy)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# set a environment to store layout data}
\NormalTok{    envir\_layout }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{() }
    \DocumentationTok{\#\# set to remove nodes or not (set to 0, remove)}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{|}\NormalTok{ plot\_structure }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      remove\_nodes }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      remove\_nodes }\OtherTok{=} \ConstantTok{NULL}
\NormalTok{    \}}
    \DocumentationTok{\#\# plot origin network (child network, with legend)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{grid\_child\_nebula}\NormalTok{(}
\NormalTok{                           .MCn.child\_graph\_list[[nebula\_name]],}
                           \AttributeTok{anno =}\NormalTok{ anno,}
                           \AttributeTok{print\_into =}\NormalTok{ F,}
                           \AttributeTok{layout =}\NormalTok{ layout,}
                           \DocumentationTok{\#\# save layout data in this environment}
                           \AttributeTok{save\_layout\_df =}\NormalTok{ envir\_layout,}
                           \DocumentationTok{\#\# remove origin nodes}
                           \AttributeTok{remove\_nodes =}\NormalTok{ remove\_nodes, }
\NormalTok{                           ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# whether plot pie diagram}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(ratio\_df) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(ratio\_df) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{        plot\_ratio }\OtherTok{=}\NormalTok{ T}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
        \FunctionTok{cat}\NormalTok{(}\StringTok{"is.data.frame(ratio\_df) == F}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        plot\_ratio }\OtherTok{=}\NormalTok{ F}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      plot\_ratio }\OtherTok{=}\NormalTok{ F}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# tmp dir}
\NormalTok{    tmp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"tmp"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(tmp\_dir) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(tmp\_dir)}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# nodes id}
    \ControlFlowTok{if}\NormalTok{(plot\_nodes\_id }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{\&}\NormalTok{ (plot\_ppcp }\SpecialCharTok{==}\NormalTok{ F))\{}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ name), }\AttributeTok{size =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# require ChemmineOB and ChemmineR}
\NormalTok{    with\_structure }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ChemmineOB"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
      \DocumentationTok{\#\# structure}
\NormalTok{      tmp\_stru }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"structure"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(tmp\_stru) }\SpecialCharTok{==}\NormalTok{ F)\{}
        \FunctionTok{dir.create}\NormalTok{(tmp\_stru)}
\NormalTok{      \}}
      \ControlFlowTok{if}\NormalTok{(plot\_structure }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{        with\_structure }\OtherTok{\textless{}{-}} \DecValTok{1}
        \FunctionTok{batch\_mode\_structure}\NormalTok{(}\AttributeTok{metadata =}\NormalTok{ metadata, }\AttributeTok{tmp\_stru =}\NormalTok{ tmp\_stru)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# re draw nodes with or without ppcp bar}
\NormalTok{    tmp\_ppcp }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"ppcp"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(tmp\_ppcp) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(tmp\_ppcp)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{|}\NormalTok{ plot\_structure }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{|}\NormalTok{ plot\_ratio }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{batch\_mode\_nodes}\NormalTok{(}
                       \AttributeTok{metadata =}\NormalTok{ metadata,}
                       \AttributeTok{tmp\_ppcp =}\NormalTok{ tmp\_ppcp,}
                       \AttributeTok{with\_structure =}\NormalTok{ with\_structure,}
                       \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
                       \AttributeTok{plot\_ratio =}\NormalTok{ plot\_ratio,}
                       \AttributeTok{ratio\_df =}\NormalTok{ ratio\_df,}
\NormalTok{                       ...)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# merge image}
    \ControlFlowTok{if}\NormalTok{(merge\_image }\SpecialCharTok{==}\NormalTok{ T)\{}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ggimage"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T) }\SpecialCharTok{\&}
         \FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"gridExtra"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
        \DocumentationTok{\#\# remove legend of size}
\NormalTok{        p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{guides}\NormalTok{(}\AttributeTok{size =} \StringTok{"none"}\NormalTok{)}
        \FunctionTok{merge\_image}\NormalTok{(p, envir\_layout}\SpecialCharTok{$}\NormalTok{layout\_n, tmp\_ppcp)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# write\_output \#\# estimate width}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
      \ControlFlowTok{if}\NormalTok{(height }\SpecialCharTok{==} \StringTok{"auto"} \SpecialCharTok{|}\NormalTok{ width }\SpecialCharTok{==} \StringTok{"auto"}\NormalTok{)\{}
        \DocumentationTok{\#\# estimate width upon legend number of \textquotesingle{}fill\textquotesingle{}}
\NormalTok{        n }\OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(metadata}\SpecialCharTok{$}\NormalTok{vis\_class))}
\NormalTok{        height }\OtherTok{=} \DecValTok{8}
\NormalTok{        width }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{17}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DocumentationTok{\#\# \textquotesingle{}class\textquotesingle{} less than 17}
                       \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{34}\NormalTok{, }\FloatTok{12.5}\NormalTok{,}
                              \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{51}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{18}\NormalTok{)))}
\NormalTok{      \}}
      \DocumentationTok{\#\# output}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, nebula\_name, }\StringTok{"\_graph.svg"}\NormalTok{),}
             \AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    \}}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: annotate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(return\_plot }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
\NormalTok{  \}}
\DocumentationTok{\#\# function gather all subview}
\NormalTok{gather\_subview }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           subview,}
\NormalTok{           x,}
\NormalTok{           y,}
\NormalTok{           width,}
\NormalTok{           height,}
           \AttributeTok{p =} \FunctionTok{get}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggimage}\SpecialCharTok{::}\FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height,}
                          \AttributeTok{subview =}\NormalTok{ subview)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"p"}\NormalTok{, p, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
    \DocumentationTok{\#\#}
\NormalTok{  \}}
\DocumentationTok{\#\# funtion merge image, involves nodes (may include ppcp bar), structure, and network layout (with edges)}
\NormalTok{merge\_image }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           p, }\DocumentationTok{\#\# ggplot2 object}
\NormalTok{           layout\_n,}
\NormalTok{           tmp\_ppcp,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# check svg image}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(layout\_n, x, y, name, tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{nodes\_path =} \FunctionTok{paste0}\NormalTok{(tmp\_ppcp, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".svg"}\NormalTok{),}
                    \AttributeTok{check\_nodes =} \FunctionTok{file.exists}\NormalTok{(nodes\_path)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(check\_nodes }\SpecialCharTok{==}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# read\_cairo\_svg:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df), }\StringTok{"(number)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# read svg image}
\NormalTok{    subview\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{name, base\_read\_cairo,}
                                      \AttributeTok{path =}\NormalTok{ tmp\_ppcp, }
\NormalTok{                                      ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# calculate width and height for subview, according to attributes of tanimotoSimilarity}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df,}
                        \AttributeTok{width =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{==}\NormalTok{ T, }\DecValTok{1}\NormalTok{,}
                                       \DecValTok{1} \SpecialCharTok{+}\NormalTok{ tanimotoSimilarity),}
                        \AttributeTok{height =}\NormalTok{ width)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# as subview }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Advance visualization: gather\_subview}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
\NormalTok{                      gather\_subview, }\DocumentationTok{\#\# function}
\NormalTok{                      subview\_list,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{x,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{y,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{width,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{height}
\NormalTok{    )}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-batch_mode_nodes.r}{%
\section{File: batch\_mode\_nodes.R}\label{file-batch_mode_nodes.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{batch\_mode\_nodes }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metadata,}
\NormalTok{           tmp\_ppcp,}
           \AttributeTok{with\_structure =} \DecValTok{0}\NormalTok{,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
           \AttributeTok{plot\_ratio =}\NormalTok{ F,}
           \AttributeTok{ratio\_df =} \ConstantTok{NULL}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# remove exist files}
    \FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(tmp\_ppcp, }\AttributeTok{full.names =}\NormalTok{ T), file.remove)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# nodes color, which parallel to the nodes color in plot of visualize\_child\_nebula function}
\NormalTok{    meta\_color }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(metadata, vis\_class) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(vis\_class)}
\NormalTok{    meta\_color}\SpecialCharTok{$}\NormalTok{nodes\_color }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(meta\_color)]}
    \DocumentationTok{\#\# gather color data}
\NormalTok{    meta\_ppcp }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, meta\_color, }\AttributeTok{by =} \StringTok{"vis\_class"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# pick ppcp\_dataset}
\NormalTok{    ppcp\_dataset }\OtherTok{=}\NormalTok{ .MCn.ppcp\_dataset[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(.MCn.ppcp\_dataset) }\SpecialCharTok{\%in\%}\NormalTok{ meta\_ppcp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)]}
    \DocumentationTok{\#\# sort data}
\NormalTok{    meta\_ppcp}\SpecialCharTok{$}\StringTok{".id"} \OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(meta\_ppcp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                              \AttributeTok{levels =} \FunctionTok{names}\NormalTok{(ppcp\_dataset))}
\NormalTok{    meta\_ppcp }\OtherTok{\textless{}{-}}\NormalTok{ meta\_ppcp[}\FunctionTok{order}\NormalTok{(meta\_ppcp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{), ]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# ratio\_df, extra peak area data}
    \ControlFlowTok{if}\NormalTok{(plot\_ratio }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df, }\AttributeTok{.id =} \FunctionTok{as.character}\NormalTok{(.id))}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(meta\_ppcp, .id), ratio\_df, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
      \DocumentationTok{\#\# get list data}
\NormalTok{      ratio\_df\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(ratio\_df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, by\_group\_for\_list,}
                              \AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"ratio\_df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
                              \AttributeTok{col =} \StringTok{".id"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ratio\_df\_list }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_ppcp))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# annotate\_child\_nebulae: batch\_mode\_nodes}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
\NormalTok{                      base\_vis\_nodes, }\CommentTok{\# function}
\NormalTok{                      ppcp\_dataset, }\CommentTok{\# main 1}
\NormalTok{                      meta\_ppcp}\SpecialCharTok{$}\NormalTok{nodes\_color, }\CommentTok{\# main 2}
                      \FunctionTok{names}\NormalTok{(ppcp\_dataset), }\CommentTok{\# main 3, key\_id}
\NormalTok{                      ratio\_df\_list, }\CommentTok{\# main 4, draw pie diagram}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}
                                      \AttributeTok{path =} \FunctionTok{normalizePath}\NormalTok{(tmp\_ppcp),}
                                      \AttributeTok{with\_structure =}\NormalTok{ with\_structure,}
                                      \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
                                      \AttributeTok{plot\_ratio =}\NormalTok{ plot\_ratio,}
\NormalTok{                                      ...))}
\NormalTok{  \}}
\DocumentationTok{\#\# function mannually draw nodes}
\NormalTok{base\_vis\_nodes }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           ppcp, }\DocumentationTok{\#\# main 1}
\NormalTok{           nodes\_color, }\DocumentationTok{\#\# main 2}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{, }\DocumentationTok{\#\# main 3}
           \AttributeTok{ratio\_df =} \ConstantTok{NULL}\NormalTok{, }\DocumentationTok{\#\# main 4, draw pie diagram}
           \AttributeTok{plot\_ratio =}\NormalTok{ F,}
           \AttributeTok{plot\_nodes\_id =}\NormalTok{ T,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ T,}
           \AttributeTok{label\_color =} \StringTok{"black"}\NormalTok{,}
           \AttributeTok{with\_structure =} \DecValTok{0}\NormalTok{,}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{class\_index =} \FunctionTok{unique}\NormalTok{(.MCn.nebula\_index}\SpecialCharTok{$}\NormalTok{relativeIndex),}
           \AttributeTok{palette =} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(.MCn.palette))(}\FunctionTok{length}\NormalTok{(class\_index)),}
           \AttributeTok{palette\_stat =}\NormalTok{ .MCn.palette\_stat,}
           \AttributeTok{size\_adjust =} \FloatTok{0.7}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# filter via class\_index}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}}\NormalTok{ ppcp[ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ class\_index, ]}
    \DocumentationTok{\#\# as factor, for painting color}
\NormalTok{    ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex, }\AttributeTok{levels =} \FunctionTok{sort}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex))}
\NormalTok{    ppcp}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(ppcp))}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      ppcp}\SpecialCharTok{$}\NormalTok{V1 }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# plot nodes }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(ppcp, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ num, }\AttributeTok{y =}\NormalTok{ V1)) }\SpecialCharTok{+}
      \DocumentationTok{\#\# nodes color}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{geom\_ribbon}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ nodes\_color,}
                           \FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{,}
                               \AttributeTok{x =} \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
                                          \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \FunctionTok{nrow}\NormalTok{(ppcp), num }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, num)))) }\SpecialCharTok{+}
      \DocumentationTok{\#\# border color}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{geom\_ribbon}\NormalTok{(}\AttributeTok{fill =} \StringTok{"black"}\NormalTok{,}
                           \FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{,}
                               \AttributeTok{x =} \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
                                          \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \FunctionTok{nrow}\NormalTok{(ppcp), num }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, num)))) }\SpecialCharTok{+}
        \DocumentationTok{\#\# ppcp bar plot}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha =} \DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ relativeIndex), }\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.25}\NormalTok{) }\SpecialCharTok{+}
        \DocumentationTok{\#\# nodes border ratio}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
        \DocumentationTok{\#\# Polar coordinate transformation}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{coord\_polar}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{theme}\NormalTok{(}
              \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{),}
              \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
              \DocumentationTok{\#\# remove legend}
              \AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{,}
              \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
              \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
              \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{        )}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# draw pie diagram}
    \ControlFlowTok{if}\NormalTok{(plot\_ratio }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(ratio\_df, }\AttributeTok{id.vars =} \StringTok{".id"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"group"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
      \DocumentationTok{\#\# value stack}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df,}
                                \AttributeTok{xend =} \FunctionTok{stack\_sum}\NormalTok{(ratio\_df}\SpecialCharTok{$}\NormalTok{value),}
                                \AttributeTok{x =} \FunctionTok{stack\_sum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, ratio\_df}\SpecialCharTok{$}\NormalTok{value[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(ratio\_df)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)])))}
      \DocumentationTok{\#\# normalize x axis range and x value}
\NormalTok{      n\_factor }\OtherTok{=}\NormalTok{ (}\FunctionTok{max}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{num) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{/}\FunctionTok{max}\NormalTok{(ratio\_df}\SpecialCharTok{$}\NormalTok{xend)}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df,}
                         \AttributeTok{midd =}\NormalTok{ (x }\SpecialCharTok{+}\NormalTok{ value}\SpecialCharTok{/}\DecValTok{2}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ n\_factor,}
                         \AttributeTok{width =}\NormalTok{ value }\SpecialCharTok{*}\NormalTok{ n\_factor)}
      \DocumentationTok{\#\# add pie plot into ggplot2 project}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ratio\_df, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{,}
                                  \FunctionTok{aes}\NormalTok{(}\AttributeTok{y =} \SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\AttributeTok{x =}\NormalTok{ midd, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
        \DocumentationTok{\#\# add \textquotesingle{}fill\textquotesingle{} palette}
\NormalTok{        ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(palette, palette\_stat[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(ratio\_df)]))}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \DocumentationTok{\#\# add \textquotesingle{}fill\textquotesingle{} palette}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate Graphics Device}
\NormalTok{    savepath }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
\NormalTok{    svglite}\SpecialCharTok{::}\FunctionTok{svglite}\NormalTok{(savepath, }\AttributeTok{bg =} \StringTok{"transparent"}\NormalTok{)}
    \DocumentationTok{\#\# print nodes}
    \FunctionTok{print}\NormalTok{(p)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# print structure or not}
    \ControlFlowTok{if}\NormalTok{(with\_structure }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      s\_file }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{normalizePath}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/../structure"}\NormalTok{)), }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(s\_file))\{}
        \DocumentationTok{\#\# via grImport2 import Cairo svg}
\NormalTok{        ps }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(}\AttributeTok{file =}\NormalTok{ s\_file)}
        \DocumentationTok{\#\# grid draw}
\NormalTok{        grImport2}\SpecialCharTok{::}\FunctionTok{grid.picture}\NormalTok{(ps, }\AttributeTok{width =}\NormalTok{ size\_adjust, }\AttributeTok{height =}\NormalTok{ size\_adjust)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# grid nodes ID in nodes }
    \ControlFlowTok{if}\NormalTok{(plot\_nodes\_id }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# a grid object}
\NormalTok{      ps }\OtherTok{\textless{}{-}}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{textGrob}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, key\_id),}
                           \AttributeTok{y =} \FloatTok{0.25}\NormalTok{,}
                           \AttributeTok{gp =}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fontfamily =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{fontsize =} \DecValTok{20}\NormalTok{, }\AttributeTok{col =}\NormalTok{ label\_color))}
\NormalTok{      grid}\SpecialCharTok{::}\FunctionTok{grid.draw}\NormalTok{(ps)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{dev.off}\NormalTok{()}
    \CommentTok{\# as cairo svg}
\NormalTok{    rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(savepath, savepath)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{  \}}
\DocumentationTok{\#\# function read cairo svg}
\NormalTok{base\_read\_cairo }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           path,}
           \AttributeTok{suffix =} \StringTok{".svg"}
\NormalTok{           )\{}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{grobify}\NormalTok{(grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, suffix)))}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ gridExtra}\SpecialCharTok{::}\FunctionTok{arrangeGrob}\NormalTok{(svg)}
    \FunctionTok{return}\NormalTok{(svg)}
\NormalTok{  \}}
\NormalTok{stack\_sum }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector}
\NormalTok{           )\{}
\NormalTok{    stack }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(vector))\{}
\NormalTok{      stack[i] }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(vector[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i])}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(stack)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-batch_mode_structure.r}{%
\section{File: batch\_mode\_structure.R}\label{file-batch_mode_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{batch\_mode\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metadata,}
\NormalTok{           tmp\_stru}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# collate metadata}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(metadata,}
                               \AttributeTok{stru\_file =} \FunctionTok{paste0}\NormalTok{(tmp\_stru, }\StringTok{"/"}\NormalTok{, .id, }\StringTok{".svg"}\NormalTok{),}
                               \AttributeTok{stru\_check =} \FunctionTok{file.exists}\NormalTok{(stru\_file))}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(meta\_stru, .MCn.structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"smiles"}\NormalTok{)], }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_stru, }\FunctionTok{is.na}\NormalTok{(smiles) }\SpecialCharTok{==}\NormalTok{ F)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of structure set:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_stru), }\StringTok{"(compounds with structure)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(metadata), }\StringTok{"(all compounds)"}\NormalTok{),}
        \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_stru, stru\_check }\SpecialCharTok{==}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_stru) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
\NormalTok{                        base\_vis\_structure, }\CommentTok{\# function}
\NormalTok{                        meta\_stru}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\CommentTok{\# key\_id}
\NormalTok{                        meta\_stru}\SpecialCharTok{$}\NormalTok{smiles, }\CommentTok{\# smiles}
                        \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{( }\AttributeTok{path =} \FunctionTok{normalizePath}\NormalTok{(tmp\_stru) ))}
\NormalTok{    \}}
\NormalTok{  \}}
\DocumentationTok{\#\# function draw structure}
\NormalTok{base\_vis\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           smiles,}
\NormalTok{           path,}
           \AttributeTok{to\_file =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# openbabal. only support for linux}
\NormalTok{    ChemmineOB}\SpecialCharTok{::}\FunctionTok{convertToImage}\NormalTok{(}\StringTok{"SMI"}\NormalTok{, }\StringTok{"SVG"}\NormalTok{, }\AttributeTok{source =}\NormalTok{ smiles, }\AttributeTok{toFile =}\NormalTok{ to\_file)}
    \DocumentationTok{\#\# as transparent bg}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{file =}\NormalTok{ to\_file, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{quote =}\StringTok{""}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F)}
\NormalTok{    svg}\SpecialCharTok{$}\NormalTok{V1 }\OtherTok{=} \FunctionTok{sub}\NormalTok{(}\StringTok{\textquotesingle{}fill="white"\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fill="transparent"\textquotesingle{}}\NormalTok{, svg}\SpecialCharTok{$}\NormalTok{V1)}
    \FunctionTok{write.table}\NormalTok{(}\AttributeTok{x =}\NormalTok{ svg, }\AttributeTok{file =}\NormalTok{ to\_file, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ F, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
    \DocumentationTok{\#\# convert as cairo svg}
\NormalTok{    rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(to\_file, to\_file)}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-build_classes_tree_list.r}{%
\section{File: build\_classes\_tree\_list.R}\label{file-build_classes_tree_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{build\_classes\_tree\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{class\_index=}\StringTok{"canopus.tsv"}\NormalTok{, }\AttributeTok{path=}\NormalTok{.MCn.sirius}
\NormalTok{           )\{}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, class\_index))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# separate each levels of classes into sub{-}list}
\NormalTok{    root }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{parentId}\SpecialCharTok{==}\StringTok{""}\NormalTok{), ]}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{    n }\OtherTok{=} \DecValTok{1}
\NormalTok{    list[[n]] }\OtherTok{\textless{}{-}}\NormalTok{ root }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{parentId }\SpecialCharTok{\%in\%}\NormalTok{ root}\SpecialCharTok{$}\NormalTok{id, ]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      n }\OtherTok{=}\NormalTok{ n }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{      list[[n]] }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{parentId }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{id, ]}
\NormalTok{    \}}
\NormalTok{    .MCn.class\_tree\_list }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ list}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"INFO: Classification Index in.MCn.sirius project {-}{-}{-}\textgreater{}"}\NormalTok{, class\_index, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{A total of 11 levels. These classes (upon ClassyFire and CANOPUS) were separated into sub{-}lists.}
\StringTok{        Use following arguments to get some specific classes:}
\StringTok{        .MCn.class\_tree\_list[[3]] \textgreater{}\textgreater{}\textgreater{} superclass}
\StringTok{        .MCn.class\_tree\_list[[4]] \textgreater{}\textgreater{}\textgreater{} class}
\StringTok{        .MCn.class\_tree\_list[[5]] \textgreater{}\textgreater{}\textgreater{} subclass}
\StringTok{        .MCn.class\_tree\_list[[6]] \textgreater{}\textgreater{}\textgreater{} level 5 }\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_ppcp.r}{%
\section{File: collate\_ppcp.R}\label{file-collate_ppcp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# main function}
\NormalTok{collate\_ppcp }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{formula\_adduct =}\NormalTok{ .MCn.formula\_set,}
           \AttributeTok{path =}\NormalTok{ .MCn.sirius,}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{nebula\_class =}\NormalTok{ T,}
           \AttributeTok{nebula\_index =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: collate\_ppcp}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# check dirs {-}{-}{-}{-} canopus}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_ppcp: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(dirs }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{      dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern=}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"canopus"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"canopus"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# lock on file location}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{dir =} \StringTok{"."}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{sapply}\NormalTok{(dir, grep\_id)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(formula\_adduct, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{adduct\_trans =} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, adduct),}
             \AttributeTok{target =} \FunctionTok{paste0}\NormalTok{(precursorFormula, }\StringTok{"\_"}\NormalTok{, adduct\_trans, }\StringTok{".fpt"}\NormalTok{), }
             \AttributeTok{full.name =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"canopus"}\NormalTok{, }\StringTok{"/"}\NormalTok{, target), }
             \DocumentationTok{\#\# these files need to be check and filter (whether exist)}
             \DocumentationTok{\#\# note that some formula is no fingerprint computed}
             \AttributeTok{ppcp =} \FunctionTok{file.exists}\NormalTok{(full.name))}
\NormalTok{      meta\_dir\_filter }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, ppcp }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of PPCP dataset:"}\NormalTok{,}
          \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir\_filter), }\StringTok{"(formula with PPCP)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_dir), }\StringTok{"(all formula)"}\NormalTok{), }
          \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# load all ppcp dataset}
\NormalTok{    ppcp\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{full.name, read\_fpt)}
    \FunctionTok{names}\NormalTok{(ppcp\_dataset) }\OtherTok{\textless{}{-}}\NormalTok{ meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}
\NormalTok{    .MCn.ppcp\_dataset }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ ppcp\_dataset}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# summarize nebula\_class}
    \ControlFlowTok{if}\NormalTok{(nebula\_class }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\# Collate\_ppcp |"}\NormalTok{, }\FunctionTok{date}\NormalTok{(), }\StringTok{"| USE Method: method\_summarize\_nebula\_class.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(.MCn.class\_tree\_list, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{hierarchy =}\NormalTok{ .id)}
\NormalTok{      .MCn.class\_tree\_data }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(metadata)}
      \DocumentationTok{\#\# transmit environment}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
      \DocumentationTok{\#\# get nebula classes}
\NormalTok{      nebula\_class }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(ppcp\_dataset, method\_summarize\_nebula\_class, }
                             \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_data"}\NormalTok{,}
\NormalTok{                             ...)}
\NormalTok{      .MCn.nebula\_class }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ nebula\_class}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(nebula\_index }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\# Collate\_ppcp |"}\NormalTok{, }\FunctionTok{date}\NormalTok{(), }\StringTok{"| USE Method: method\_summarize\_nebula\_index.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# gather all nebula classes}
\NormalTok{      nebula\_index }\OtherTok{\textless{}{-}} \FunctionTok{method\_summarize\_nebula\_index}\NormalTok{(ppcp\_dataset,}
\NormalTok{                                                    ...)}
\NormalTok{      .MCn.nebula\_index }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ nebula\_index}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
        \FunctionTok{write\_tsv}\NormalTok{(nebula\_index, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"nebula\_index.tsv"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: collate\_ppcp.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(nebula\_index)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_structure.r}{%
\section{File: collate\_structure.R}\label{file-collate_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# main function}
\NormalTok{collate\_structure }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{path =}\NormalTok{ .MCn.sirius,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{write\_picked\_formula\_adduct =}\NormalTok{ T,}
           \AttributeTok{collate\_method =} \StringTok{"method\_pick\_formula\_excellent"}\NormalTok{, }\CommentTok{\# "top\_score", "top\_similarity", "top\_zodiac\_score"}
\NormalTok{           ...}
\NormalTok{           )\{}
  \FunctionTok{cat}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"[INFO] MCnebula run: collate\_structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) )}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \DocumentationTok{\#\# check dirs}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_structure: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(dirs }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{    dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern=}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{  \}}
\NormalTok{  dirs }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)]}
  \DocumentationTok{\#\# build a new envir to place data}
\NormalTok{  formula\_cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{  structure\_cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_structure:"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(collate\_method), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  method\_fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(collate\_method)}
  \DocumentationTok{\#\# method}
\NormalTok{  pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(dirs, method\_fun,}
                    \AttributeTok{return\_formula =}\NormalTok{ F,}
                    \DocumentationTok{\#\# the data are placed into cache envir}
                    \AttributeTok{formula\_cache =}\NormalTok{ formula\_cache,}
                    \AttributeTok{structure\_cache =}\NormalTok{ structure\_cache,}
\NormalTok{                    ...)}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \DocumentationTok{\#\# structure collate}
\NormalTok{  structure\_dataset }\OtherTok{\textless{}{-}} \FunctionTok{eapply}\NormalTok{(structure\_cache, data.table) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol=}\NormalTok{T)}
\NormalTok{  .MCn.structure\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(structure\_dataset,}
                                       \AttributeTok{tanimotoSimilarity =} \FunctionTok{as.numeric}\NormalTok{(tanimotoSimilarity)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
    \FunctionTok{write\_tsv}\NormalTok{( structure\_dataset, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, collate\_method, }\StringTok{".structure.tsv"}\NormalTok{))}
\NormalTok{  \}}
  \DocumentationTok{\#\# formula\_adduct collate}
\NormalTok{  formula\_adduct\_set }\OtherTok{\textless{}{-}} \FunctionTok{eapply}\NormalTok{(formula\_cache, data.table) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{  .MCn.formula\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(formula\_adduct\_set, }\FunctionTok{is.na}\NormalTok{(precursorFormula) }\SpecialCharTok{==}\NormalTok{ F)}
  \ControlFlowTok{if}\NormalTok{(write\_picked\_formula\_adduct }\SpecialCharTok{==}\NormalTok{ T)\{}
    \FunctionTok{write\_tsv}\NormalTok{(formula\_adduct\_set, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/picked\_"}\NormalTok{, collate\_method, }\StringTok{".tsv"}\NormalTok{))}
\NormalTok{  \}}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
  \FunctionTok{cat}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: collate\_structure.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) )}
\NormalTok{\}}
\DocumentationTok{\#\# extra function in this module}
\DocumentationTok{\#\# {-}{-}{-}{-}}
\NormalTok{grep\_id }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{)\{}
\NormalTok{  v }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(x, }\AttributeTok{split=}\StringTok{"\_"}\NormalTok{))}
\NormalTok{  id }\OtherTok{\textless{}{-}}\NormalTok{ v[}\FunctionTok{length}\NormalTok{(v)]}
  \FunctionTok{return}\NormalTok{(id)}
\NormalTok{\}}
\DocumentationTok{\#\# {-}{-}{-}{-}}
\NormalTok{check\_dir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dir, }\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{file =} \StringTok{"compound.info"}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, file)) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{    check }\OtherTok{=}\NormalTok{ T}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    check }\OtherTok{=}\NormalTok{ F}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(check)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generate_child_nebulae.r}{%
\section{File: generate\_child\_nebulae.R}\label{file-generate_child_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{generate\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{nodes =}\NormalTok{ .MCn.parent\_nodes,}
           \AttributeTok{edges =}\NormalTok{ .MCn.parent\_edges,}
           \AttributeTok{max\_edges =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{nebula\_index =}\NormalTok{ .MCn.nebula\_index,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: generate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# get names of all classes}
\NormalTok{    names }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(nebula\_index}\SpecialCharTok{$}\NormalTok{name)}
    \DocumentationTok{\#\# for using lapply, first, trans the data.frame into list}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(nebula\_index}\SpecialCharTok{$}\NormalTok{relativeIndex), by\_group\_for\_list)}
    \DocumentationTok{\#\# push names}
    \FunctionTok{names}\NormalTok{(nebula\_index) }\OtherTok{\textless{}{-}}\NormalTok{ names}
    \DocumentationTok{\#\# facet parent nebula}
    \DocumentationTok{\#\# create dir for placing graph file}
\NormalTok{    dir }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebula"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{    \}}
\NormalTok{    .MCn.child\_graph\_list }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(nebula\_index, separate\_nebula,}
                      \AttributeTok{output =}\NormalTok{ dir,}
                      \AttributeTok{max\_edges =}\NormalTok{ max\_edges,}
\NormalTok{                      ...)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: generate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{by\_group\_for\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"nebula\_index"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
           \AttributeTok{col =} \StringTok{"relativeIndex"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[col]] }\SpecialCharTok{==}\NormalTok{ x),]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{separate\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{nodes =} \FunctionTok{get}\NormalTok{(}\StringTok{"nodes"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
           \AttributeTok{edges =} \FunctionTok{get}\NormalTok{(}\StringTok{"edges"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebula"}\NormalTok{),}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
           \AttributeTok{max\_edges =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{write\_extra =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# get the child nebula name}
\NormalTok{    name }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{, }\StringTok{"name"}\NormalTok{]}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[nodes}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{\%in\%}\NormalTok{ id, ]}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[edges}\SpecialCharTok{$}\StringTok{".id\_1"} \SpecialCharTok{\%in\%}\NormalTok{ id }\SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\StringTok{".id\_2"} \SpecialCharTok{\%in\%}\NormalTok{ id, ] }
    \DocumentationTok{\#\# an edges number cut{-}off}
\NormalTok{    edges }\OtherTok{\textless{}{-}} \FunctionTok{better\_vis\_nebula}\NormalTok{(edges, }\AttributeTok{max\_edges =}\NormalTok{ max\_edges)}
\NormalTok{    child\_nebula }\OtherTok{\textless{}{-}}\NormalTok{ igraph}\SpecialCharTok{::}\FunctionTok{graph\_from\_data\_frame}\NormalTok{(edges, }\AttributeTok{directed =}\NormalTok{ T, }\AttributeTok{vertices =}\NormalTok{ nodes)}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{write\_graph}\NormalTok{(child\_nebula,}
                  \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"."}\NormalTok{, output\_format),}
                  \AttributeTok{format =}\NormalTok{ output\_format)}
      \ControlFlowTok{if}\NormalTok{(write\_extra }\SpecialCharTok{==}\NormalTok{ T)\{}
        \FunctionTok{write\_tsv}\NormalTok{(edges, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"\_edges.tsv"}\NormalTok{))}
        \FunctionTok{write\_tsv}\NormalTok{(nodes, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"\_nodes.tsv"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(child\_nebula)}
\NormalTok{  \}}
\NormalTok{better\_vis\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           edges,}
           \AttributeTok{max\_edges =} \DecValTok{5}
\NormalTok{           )\{}
    \DocumentationTok{\#\# order}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(edges, }\FunctionTok{desc}\NormalTok{(edges[,}\DecValTok{3}\NormalTok{]))}
\NormalTok{    ta }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]], edges[[}\DecValTok{2}\NormalTok{]]))}
    \DocumentationTok{\#\# at least loop number}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(}\FunctionTok{which}\NormalTok{(ta }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_edges))}
    \ControlFlowTok{if}\NormalTok{(n }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(edges)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# copy data for override}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], }\AttributeTok{SEQ =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(edges))}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# use sapply instead of while loop}
\NormalTok{    continue }\OtherTok{=} \DecValTok{1}
    \FunctionTok{sapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, edges\_cut\_off, }\AttributeTok{max\_edges =}\NormalTok{ max\_edges)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[df}\SpecialCharTok{$}\NormalTok{SEQ, ]}
    \FunctionTok{return}\NormalTok{(edges)}
\NormalTok{  \}}
\NormalTok{edges\_cut\_off }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           i,}
           \AttributeTok{max\_edges =} \DecValTok{5}
\NormalTok{           )\{}
\NormalTok{    continue }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\StringTok{"continue"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(continue }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      edges }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\StringTok{"df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
      \DocumentationTok{\#\# stat edges number of an id}
\NormalTok{      ta }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]], edges[[}\DecValTok{2}\NormalTok{]]))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{max}\NormalTok{(ta) }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_edges)\{ }\DocumentationTok{\#\# greater than threshold, hence perform exclude}
        \DocumentationTok{\#\# select an id to exclude its excess edges}
\NormalTok{        key\_id }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(ta[}\FunctionTok{which}\NormalTok{(ta }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(ta))])[}\DecValTok{1}\NormalTok{]}
        \DocumentationTok{\#\# get SEQ of the edges which need to be excluded}
\NormalTok{        incude\_id\_edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{==}\NormalTok{ key\_id }\SpecialCharTok{|}\NormalTok{ edges[[}\DecValTok{2}\NormalTok{]] }\SpecialCharTok{==}\NormalTok{ key\_id),]}
\NormalTok{        exclude\_edges\_seq }\OtherTok{\textless{}{-}}\NormalTok{ incude\_id\_edges[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{max\_edges), ]}\SpecialCharTok{$}\NormalTok{SEQ}
        \DocumentationTok{\#\# exclude edges}
\NormalTok{        edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(}\SpecialCharTok{!}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{SEQ }\SpecialCharTok{\%in\%}\NormalTok{ exclude\_edges\_seq), ]}
        \FunctionTok{assign}\NormalTok{(}\StringTok{"df"}\NormalTok{, edges, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
        \DocumentationTok{\#\# signature of stop exclude}
        \FunctionTok{assign}\NormalTok{(}\StringTok{"continue"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generate_parent_nebula.r}{%
\section{File: generate\_parent\_nebula.R}\label{file-generate_parent_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{generate\_parent\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{edges\_file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/parent\_nebula/parent\_nebula\_edges.tsv"}\NormalTok{), }\CommentTok{\# exists edges file}
           \AttributeTok{edges\_method =} \StringTok{"method\_formula\_based\_spec\_compare"}\NormalTok{, }\CommentTok{\# or NULL}
           \AttributeTok{nodes\_attributes =}\NormalTok{ .MCn.formula\_set,}
           \AttributeTok{nodes\_other\_attributes =}\NormalTok{ .MCn.structure\_set,}
           \AttributeTok{edge\_filter =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{cpu\_cores =} \DecValTok{8}\NormalTok{, }
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: generate\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# main body}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate edges data}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(edges\_method) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# no edges\_method}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\# generate\_parent\_nebula: no edges\_uethod used}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\StringTok{".id\_1"} \OtherTok{=}\NormalTok{ nodes\_other\_attributes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                     \StringTok{".id\_2"} \OtherTok{=}\NormalTok{ nodes\_other\_attributes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{dotproduct =} \DecValTok{1}\NormalTok{, }\AttributeTok{mass\_diff =} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(edges\_method }\SpecialCharTok{==} \StringTok{"method\_formula\_based\_spec\_compare"}\NormalTok{)\{}
      \DocumentationTok{\#\# with edges\_method}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(edges\_file) }\SpecialCharTok{==}\NormalTok{ F }\SpecialCharTok{\&} \FunctionTok{file.exists}\NormalTok{(edges\_file))\{}
        \FunctionTok{cat}\NormalTok{(}\StringTok{"\# generate\_parent\_nebula: file.exists(edges\_file) == T. Escape from time{-}consuming computation}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        edges }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(edges\_file) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id\_1"}\NormalTok{, }\StringTok{".id\_2"}\NormalTok{), as.character) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(edges)[}\DecValTok{3}\SpecialCharTok{:}\DecValTok{4}\NormalTok{]), as.numeric)}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        edges }\OtherTok{=} \FunctionTok{method\_formula\_based\_spec\_compare}\NormalTok{(}\AttributeTok{edge\_filter =}\NormalTok{ edge\_filter, }\AttributeTok{cpu\_cores =}\NormalTok{ cpu\_cores, ...)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate nodes data}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes\_attributes}
    \DocumentationTok{\#\# additional nodes attributes}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(nodes\_other\_attributes) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes, nodes\_other\_attributes, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# rename the column name, otherwise the column will be choosed as key column in igraph}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{compound\_name =}\NormalTok{ name)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# graph}
\NormalTok{    parent\_nebula }\OtherTok{\textless{}{-}}\NormalTok{ igraph}\SpecialCharTok{::}\FunctionTok{graph\_from\_data\_frame}\NormalTok{(edges, }\AttributeTok{directed =}\NormalTok{ T, }\AttributeTok{vertices =}\NormalTok{ nodes)}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      dir }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)\{}
        \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{      \}}
      \FunctionTok{write\_graph}\NormalTok{(parent\_nebula,}
                  \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula."}\NormalTok{, output\_format),}
                  \AttributeTok{format =}\NormalTok{ output\_format)}
      \FunctionTok{write\_tsv}\NormalTok{(edges, }\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula\_edges.tsv"}\NormalTok{))}
      \FunctionTok{write\_tsv}\NormalTok{(nodes, }\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula\_nodes.tsv"}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# set as global var for next stage}
\NormalTok{    .MCn.parent\_graph }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ parent\_nebula}
\NormalTok{    .MCn.parent\_nodes }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ nodes }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    .MCn.parent\_edges }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ edges }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: generate\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_formula.r}{%
\section{File: get\_formula.R}\label{file-get_formula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_formula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
           \AttributeTok{exclude\_element =} \ConstantTok{NULL}\NormalTok{, }\DocumentationTok{\#\# e.g., c("S", "B", "P", "Si")}
           \AttributeTok{formula\_method =} \StringTok{"top\_zodiac"}\NormalTok{,}
           \AttributeTok{rank =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\CommentTok{\# or "all"}
           \AttributeTok{ppm\_error =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{return\_col =} \FunctionTok{c}\NormalTok{(}\StringTok{"rank"}\NormalTok{, }\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{,}
                        \StringTok{"adduct"}\NormalTok{, }\StringTok{"ZodiacScore"}\NormalTok{, }\StringTok{"massErrorPrecursor(ppm)"}\NormalTok{),}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{pattern=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"*\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{), }\AttributeTok{full.names=}\NormalTok{T)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, }\StringTok{"formula\_candidates.tsv"}\NormalTok{))}
\NormalTok{    file}\SpecialCharTok{$}\NormalTok{rank }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{rank)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"ZodiacScore"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(file) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      file}\SpecialCharTok{$}\NormalTok{ZodiacScore }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(exclude\_element) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      file }\OtherTok{\textless{}{-}}\NormalTok{ file[}\SpecialCharTok{!}\FunctionTok{unname}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{precursorFormula, grep\_element,}
                                  \AttributeTok{exclude\_element =}\NormalTok{ exclude\_element)), ]}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(formula\_method }\SpecialCharTok{==} \StringTok{"top\_zodiac"}\NormalTok{)\{}
      \ControlFlowTok{if}\NormalTok{(rank[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{        rank }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{rank)}
\NormalTok{      \}}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ file[}\FunctionTok{which}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{rank }\SpecialCharTok{\%in\%}\NormalTok{ rank }\SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(file}\SpecialCharTok{$}\StringTok{"massErrorPrecursor(ppm)"}\NormalTok{) }\SpecialCharTok{\textless{}=}\NormalTok{ ppm\_error), }\FunctionTok{c}\NormalTok{(return\_col)]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{\}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{grep\_element }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           formula,}
           \AttributeTok{exclude\_element =} \FunctionTok{c}\NormalTok{(}\StringTok{"S"}\NormalTok{, }\StringTok{"P"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\FunctionTok{paste}\NormalTok{(exclude\_element, }\AttributeTok{collapse =} \StringTok{"|"}\NormalTok{), formula)) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(T)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{(F)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_ppcp.r}{%
\section{File: get\_ppcp.R}\label{file-get_ppcp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_ppcp }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{dir =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{precursor\_formula =} \StringTok{"method\_pick\_formula\_excellent"}\NormalTok{,}
           \AttributeTok{adduct =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{reformat =}\NormalTok{ T,}
           \AttributeTok{filter =}\NormalTok{ T,}
           \AttributeTok{filter\_threshold =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{class\_index =} \StringTok{"canopus.tsv"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# get dir path}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{\&} \FunctionTok{is.null}\NormalTok{(key\_id) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      dir }\OtherTok{\textless{}{-}} \FunctionTok{get\_dir}\NormalTok{(key\_id)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# aquire formula via the method}
    \ControlFlowTok{if}\NormalTok{( precursor\_formula }\SpecialCharTok{==} \StringTok{"method\_pick\_formula\_excellent"}\NormalTok{ )\{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{method\_pick\_formula\_excellent}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ dir)}
\NormalTok{      precursor\_formula }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{precursorFormula}
\NormalTok{      adduct }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{adduct}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# read ppcp data}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"canopus"}\NormalTok{),}
                       \AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}"}\NormalTok{, precursor\_formula, }\StringTok{"(.*)"}\NormalTok{, }\FunctionTok{escape\_ch}\NormalTok{(adduct), }\StringTok{"(.*)"}\NormalTok{, }\StringTok{".fpt$"}\NormalTok{),}
                       \AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}} \FunctionTok{read\_fpt}\NormalTok{(file)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# reformat section}
    \ControlFlowTok{if}\NormalTok{(reformat }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{return}\NormalTok{(ppcp)}
\NormalTok{    \}}
    \DocumentationTok{\#\# check meta list}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{".MCn.class\_tree\_list"}\NormalTok{) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{build\_classes\_tree\_list}\NormalTok{(}\AttributeTok{class\_index =}\NormalTok{ class\_index)}
\NormalTok{    \}}
    \DocumentationTok{\#\# get the environment name for lapply function to invoke data}
    \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"envir\_"}\NormalTok{, key\_id), }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# merge with meta table, and filter}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(.MCn.class\_tree\_list, merge\_class\_ppcp,}
                   \DocumentationTok{\#\# parameter}
                   \AttributeTok{key\_id =}\NormalTok{ key\_id, }\AttributeTok{filter =}\NormalTok{ filter, }\AttributeTok{filter\_threshold =}\NormalTok{ filter\_threshold)}
    \FunctionTok{return}\NormalTok{(ppcp)}
\NormalTok{  \}}
\DocumentationTok{\#\# a small function to get data of ppcp}
\NormalTok{read\_fpt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file)\{}
\NormalTok{  fpt }\OtherTok{=}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input =}\NormalTok{ file, }\AttributeTok{header =}\NormalTok{ F, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{  fpt}\SpecialCharTok{$}\NormalTok{relativeIndex }\OtherTok{=} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(fpt) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
  \FunctionTok{return}\NormalTok{(fpt)}
\NormalTok{\}}
\DocumentationTok{\#\# specific character in adduct description need to be revise, for pattern matching}
\NormalTok{escape\_ch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{["}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{["}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{+"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{{-}"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \FunctionTok{return}\NormalTok{(x)}
\NormalTok{\}}
\DocumentationTok{\#\# the function to merge raw ppcp with meta list}
\NormalTok{merge\_class\_ppcp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           class,}
           \AttributeTok{filter =}\NormalTok{ T,}
           \AttributeTok{filter\_threshold =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{values =} \FunctionTok{get}\NormalTok{(}\StringTok{"ppcp"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"envir\_"}\NormalTok{, key\_id))),}
           \AttributeTok{filter\_col =} \StringTok{"V1"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(class, values, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[filter\_col]] }\SpecialCharTok{\textgreater{}} \FunctionTok{ifelse}\NormalTok{(filter }\SpecialCharTok{==}\NormalTok{ T, filter\_threshold, }\DecValTok{0}\NormalTok{)),] }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_structure.r}{%
\section{File: get\_structure.R}\label{file-get_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
           \AttributeTok{precursor\_formula =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{adduct =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{structure\_method =} \StringTok{"top\_score"}\NormalTok{, }\CommentTok{\# or top\_similarity}
           \AttributeTok{order =}\NormalTok{ T,}
           \AttributeTok{return\_row =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\CommentTok{\# or "all"}
           \AttributeTok{path =}\NormalTok{ .MCn.sirius,}
           \AttributeTok{as\_tibble =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"*\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{), }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/fingerid"}\NormalTok{),}
                        \AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(precursor\_formula, }\StringTok{"(.*)"}\NormalTok{, }\FunctionTok{escape\_ch}\NormalTok{(adduct), }\StringTok{"(.*).tsv$"}\NormalTok{),}
                        \AttributeTok{full.names =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# read file}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/fingerid/"}\NormalTok{, files), read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{".tsv"}\NormalTok{, }\StringTok{""}\NormalTok{, files)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# reformat the data}
    \ControlFlowTok{if}\NormalTok{(order }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# bind row as data frame}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T)}
      \FunctionTok{colnames}\NormalTok{(df)[}\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{==} \StringTok{".id"}\NormalTok{)] }\OtherTok{\textless{}{-}} \StringTok{"file\_name"}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{(df)}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# order upon CSI:fingerID score}
      \ControlFlowTok{if}\NormalTok{(structure\_method }\SpecialCharTok{==} \StringTok{"top\_score"}\NormalTok{)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{score),]}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{structure\_rank }\OtherTok{=} \FunctionTok{as.numeric}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))}
      \DocumentationTok{\#\# order upon tanimoto similarity}
\NormalTok{      \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(structure\_method }\SpecialCharTok{==} \StringTok{"top\_similarity"}\NormalTok{)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{similarity),]}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{structure\_rank }\OtherTok{=} \FunctionTok{as.numeric}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \ControlFlowTok{if}\NormalTok{(as\_tibble }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df)}
\NormalTok{      \}}
      \CommentTok{\# return with top n}
      \ControlFlowTok{if}\NormalTok{(return\_row[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{!=} \StringTok{"all"}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{(df[}\FunctionTok{which}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\%in\%}\NormalTok{ return\_row),])}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
        \FunctionTok{return}\NormalTok{(df)}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-initialize_mcnebula.r}{%
\section{File: initialize\_mcnebula.R}\label{file-initialize_mcnebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{initialize\_mcnebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           sirius\_path,}
           \AttributeTok{output\_path =}\NormalTok{ sirius\_path,}
           \AttributeTok{output\_file =} \StringTok{"mcnebula\_results"}\NormalTok{,}
           \AttributeTok{palette =} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ggsci}\SpecialCharTok{::}\FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{), ggsci}\SpecialCharTok{::}\FunctionTok{pal\_igv}\NormalTok{(}\StringTok{"default"}\NormalTok{)(}\DecValTok{51}\NormalTok{))),}
           \AttributeTok{palette\_stat =}\NormalTok{ palette,}
           \AttributeTok{palette\_label =} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#C6DBEFFF"}\NormalTok{, }\StringTok{"\#3182BDFF"}\NormalTok{, }\StringTok{"red"}\NormalTok{))(}\DecValTok{10}\NormalTok{),}
           \AttributeTok{rm\_var =}\NormalTok{ F}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(rm\_var }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{ls}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ .GlobalEnv, }\AttributeTok{pattern =} \StringTok{"\^{}.MCn.(.*)"}\NormalTok{, }\AttributeTok{all.names =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{rm}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(sirius\_path)}\SpecialCharTok{==}\NormalTok{F }\SpecialCharTok{|} \FunctionTok{file.exists}\NormalTok{(output\_path)}\SpecialCharTok{==}\NormalTok{F)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"File path not find.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(sirius\_path, }\StringTok{"/"}\NormalTok{, }\StringTok{".format"}\NormalTok{))}\SpecialCharTok{==}\NormalTok{F)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"SIRIUS project not find.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    .MCn.sirius }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ sirius\_path}
\NormalTok{    .MCn.output }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ output\_path}
\NormalTok{    .MCn.results }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ output\_file}
\NormalTok{    .MCn.palette }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette}
\NormalTok{    .MCn.palette\_stat }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette\_stat}
\NormalTok{    .MCn.palette\_label }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette\_label}
    \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"MCnebula project has initialized at {-}\textgreater{}"}\NormalTok{, .MCn.output, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_formula_based_spec_compare.r}{%
\section{File: method\_formula\_based\_spec\_compare.R}\label{file-method_formula_based_spec_compare.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# main function}
\NormalTok{method\_formula\_based\_spec\_compare }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =}\NormalTok{ .MCn.sirius,}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{cpu\_cores =} \DecValTok{8}\NormalTok{, }
           \AttributeTok{compare\_fun =} \StringTok{"dotproduct"}\NormalTok{,}
           \AttributeTok{precursor\_mass\_diff =}\NormalTok{ T,}
           \AttributeTok{edge\_filter =} \FloatTok{0.3}\NormalTok{,}
           \AttributeTok{only\_identical\_class =}\NormalTok{ T, }\DocumentationTok{\#\# only identical classes will be compared (according to results of function:collate\_ppcp}
           \AttributeTok{min\_hierarchy =} \DecValTok{5}\NormalTok{, }\CommentTok{\# only hierarchy \textgreater{}= 5 (class, subclass...) will be considered)}
           \AttributeTok{filter\_only\_max =} \DecValTok{2000}\NormalTok{, }\CommentTok{\# only nodes number \textgreater{}= 2000, do zoidacScore and tanimotoSimilarity filter}
           \AttributeTok{min\_zodiac =} \FloatTok{0.9}\NormalTok{, }\CommentTok{\# only ZodiacScore \textgreater{}= 0.5 ...}
           \AttributeTok{min\_tanimoto =} \FloatTok{0.4}\NormalTok{, }\CommentTok{\# only the top structure tanimotoSimilarity \textgreater{}= 0.4 ...}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# check dirs {-}{-}{-}{-} spectra}
    \ControlFlowTok{if}\NormalTok{(dirs }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{      dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern=}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# method\_formula\_based\_spec\_compare: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"spectra"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"spectra"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# lock on file location}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{dir =} \StringTok{"."}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{sapply}\NormalTok{(dir, grep\_id)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(.MCn.formula\_set, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(.MCn.structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)], }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# some .id were Avoid time{-}consuming calculation}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir) }\SpecialCharTok{\textgreater{}=}\NormalTok{ filter\_only\_max)\{}
\NormalTok{      meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, ZodiacScore }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_zodiac, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_tanimoto)}
\NormalTok{    \}}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_dir, }\AttributeTok{adduct\_trans =} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, adduct),}
                              \AttributeTok{target =} \FunctionTok{paste0}\NormalTok{(precursorFormula, }\StringTok{"\_"}\NormalTok{, adduct\_trans, }\StringTok{".tsv"}\NormalTok{), }
                              \AttributeTok{full.name =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"spectra"}\NormalTok{, }\StringTok{"/"}\NormalTok{, target), }
                              \DocumentationTok{\#\# these files need to be check and filter (whether exist)}
                              \AttributeTok{spectra =} \FunctionTok{file.exists}\NormalTok{(full.name))}
\NormalTok{    meta\_dir\_filter }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, spectra }\SpecialCharTok{==}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of spectra dataset:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir\_filter), }\StringTok{"(formula with match spectra)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_dir), }\StringTok{"(all formula)"}\NormalTok{), }
        \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# load all spectra dataset}
\NormalTok{    spectra\_cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(read\_as\_spectrum2, }\CommentTok{\# function}
\NormalTok{                      meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{full.name,}
\NormalTok{                      meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}
                                      \AttributeTok{cache =}\NormalTok{ spectra\_cache}
\NormalTok{                                      ))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# enumeration combination}
    \ControlFlowTok{if}\NormalTok{(only\_identical\_class }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# enumeration combination in each hierarchy}
\NormalTok{      combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index,}
\NormalTok{                             hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_hierarchy,}
\NormalTok{                             .id }\SpecialCharTok{\%in\%}\NormalTok{ meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(hierarchy) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# dispose in each group}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), unique) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), sort) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# enumerate possible}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), combn\_edge) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{()}
      \DocumentationTok{\#\# this column has two sub{-}colunm}
\NormalTok{      combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(combn}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# this cost too much time !!!}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{combn\_edge}\NormalTok{(meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# compareSpectra (ms2) (via MSnbase)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: compare\_spectra: sum:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(combn), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    combn[[compare\_fun]] }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(combn, }\DecValTok{1}\NormalTok{, couple\_ms2\_compare,}
                                             \AttributeTok{fun =}\NormalTok{ compare\_fun,}
                                             \AttributeTok{cl =}\NormalTok{ cpu\_cores,}
                                             \AttributeTok{cache =}\NormalTok{ spectra\_cache,}
\NormalTok{                                             ...)}
    \DocumentationTok{\#\# filter via spectra similarity (edge\_filter)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    combn }\OtherTok{\textless{}{-}}\NormalTok{ combn[}\FunctionTok{which}\NormalTok{(combn[[compare\_fun]] }\SpecialCharTok{\textgreater{}=}\NormalTok{ edge\_filter), ]}
    \ControlFlowTok{if}\NormalTok{(precursor\_mass\_diff }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# dir}
\NormalTok{      info\_path }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"compound.info"}\NormalTok{)}
      \DocumentationTok{\#\# load file}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: load compound info file}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{compound\_mass }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(info\_path, get\_precursor\_mass) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{()}
      \DocumentationTok{\#\# transmit the environment name to parent.env for lapply}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_spectra"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
      \DocumentationTok{\#\# compute mass difference}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: diff\_precursor\_mass: sum:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(combn), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      combn[[}\StringTok{"mass\_diff"}\NormalTok{]] }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(combn[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], }\DecValTok{1}\NormalTok{, precursor\_mass\_diff)}
\NormalTok{    \}}
\NormalTok{    combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(combn)}
    \FunctionTok{return}\NormalTok{(combn)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  \}}
\NormalTok{read\_as\_spectrum2 }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(filename,}
\NormalTok{           key\_id,}
           \AttributeTok{cache =}\NormalTok{ spectra\_cache)\{}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(filename)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{new}\NormalTok{(}\StringTok{"Spectrum2"}\NormalTok{, }\AttributeTok{mz =}\NormalTok{ file}\SpecialCharTok{$}\NormalTok{mz, }\AttributeTok{intensity =}\NormalTok{ file}\SpecialCharTok{$}\NormalTok{rel.intensity)}
    \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(key\_id), file, }\AttributeTok{envir =}\NormalTok{ cache)}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{combn\_edge }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    combn }\OtherTok{\textless{}{-}} \FunctionTok{combn}\NormalTok{(x, }\DecValTok{2}\NormalTok{)}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(combn)}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(combn)}
      \FunctionTok{colnames}\NormalTok{(combn) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{".id\_1"}\NormalTok{, }\StringTok{".id\_2"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(combn)}
\NormalTok{  \}}
\NormalTok{couple\_ms2\_compare }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x,}
           \AttributeTok{fun =} \StringTok{"dotproduct"}\NormalTok{,}
           \AttributeTok{cache =}\NormalTok{ spectra\_cache,}
\NormalTok{           ...)\{}
\NormalTok{    simi }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{compareSpectra}\NormalTok{(}\FunctionTok{get}\NormalTok{(x[}\DecValTok{1}\NormalTok{], }\AttributeTok{envir =}\NormalTok{ cache),}
                                    \FunctionTok{get}\NormalTok{(x[}\DecValTok{2}\NormalTok{], }\AttributeTok{envir =}\NormalTok{ cache),}
                                    \AttributeTok{fun =}\NormalTok{ fun,}
\NormalTok{                                    ...)}
    \FunctionTok{return}\NormalTok{(simi)}
\NormalTok{  \}}
\NormalTok{get\_precursor\_mass }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(path)}
\NormalTok{    mass }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{index }\SpecialCharTok{==} \StringTok{"ionMass"}\NormalTok{), }\DecValTok{2}\NormalTok{]}
\NormalTok{    mass }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(mass)}
    \FunctionTok{return}\NormalTok{(mass)}
\NormalTok{  \}}
\NormalTok{precursor\_mass\_diff }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"meta\_dir\_filter"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_spectra"}\NormalTok{)))\{}
    \DocumentationTok{\#\#}
\NormalTok{    x1 }\OtherTok{=}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{==}\NormalTok{ x[}\DecValTok{1}\NormalTok{]), }\StringTok{"compound\_mass"}\NormalTok{]}
\NormalTok{    x2 }\OtherTok{=}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{==}\NormalTok{ x[}\DecValTok{2}\NormalTok{]), }\StringTok{"compound\_mass"}\NormalTok{]}
\NormalTok{    x }\OtherTok{=}\NormalTok{ x2 }\SpecialCharTok{{-}}\NormalTok{ x1}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_pick_formula_excellent.r}{%
\section{File: method\_pick\_formula\_excellent.R}\label{file-method_pick_formula_excellent.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{method\_pick\_formula\_excellent }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{dir =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{, }
           \AttributeTok{return\_formula =}\NormalTok{ T,}
           \AttributeTok{return\_structure =}\NormalTok{ F,}
           \AttributeTok{formula\_cache =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{structure\_cache =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{exclude\_element =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{ppm\_error =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{fc =} \FloatTok{1.5}\NormalTok{,}
           \AttributeTok{formula\_info =} \FunctionTok{c}\NormalTok{(}\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{, }\StringTok{"ZodiacScore"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# check parameter}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(key\_id) }\SpecialCharTok{==}\NormalTok{ T }\SpecialCharTok{\&} \FunctionTok{is.null}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(key\_id) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      dir }\OtherTok{=} \FunctionTok{get\_dir}\NormalTok{(key\_id)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      key\_id }\OtherTok{=} \FunctionTok{grep\_id}\NormalTok{(dir)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# first, test formula}
    \DocumentationTok{\#\# check whether.MCn.sirius compute formula for this id}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"formula\_candidates.tsv"}\NormalTok{)) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{return}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    formula\_df }\OtherTok{\textless{}{-}} \FunctionTok{get\_formula}\NormalTok{(key\_id,}
                              \AttributeTok{rank =} \StringTok{"all"}\NormalTok{,}
                              \AttributeTok{ppm\_error =}\NormalTok{ ppm\_error,}
                              \AttributeTok{exclude\_element =}\NormalTok{ exclude\_element)}
    \DocumentationTok{\#\# sometimes the top formula is not rank 1, but must be top}
\NormalTok{    n }\OtherTok{=}\NormalTok{ formula\_df[}\DecValTok{1}\NormalTok{, }\StringTok{"rank"}\NormalTok{] }
\NormalTok{    formula\_zodiac\_rank1 }\OtherTok{\textless{}{-}}\NormalTok{ formula\_df[ }\FunctionTok{which}\NormalTok{(formula\_df}\SpecialCharTok{$}\NormalTok{rank }\SpecialCharTok{==}\NormalTok{ n), }\FunctionTok{c}\NormalTok{(formula\_info) ]}
    \DocumentationTok{\#\# check whether there are fingerid structure files exist.}
\NormalTok{    structure\_df }\OtherTok{=} \StringTok{""}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"fingerid"}\NormalTok{)) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      check }\OtherTok{=}\NormalTok{ T}
\NormalTok{      structure\_df }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\FunctionTok{get\_structure}\NormalTok{(key\_id, }\AttributeTok{return\_row=} \StringTok{"all"}\NormalTok{), }\AttributeTok{silent =}\NormalTok{ T)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      check }\OtherTok{=}\NormalTok{ F}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(structure\_df)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{!=} \StringTok{"try{-}error"} \SpecialCharTok{\&}\NormalTok{ check }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# In sirius workflow, if some enforce setting (e.g., adduct enfoce) have done, max mass error (ppm) may too large. here to filter.}
\NormalTok{      structure\_df }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[structure\_df}\SpecialCharTok{$}\NormalTok{molecularFormula }\SpecialCharTok{\%in\%}\NormalTok{ formula\_df}\SpecialCharTok{$}\NormalTok{molecularFormula, ]}
      \DocumentationTok{\#\# get formula and adduct type (select from zodiac top score formula or formula of top score structure)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(structure\_df) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)\{}
        \DocumentationTok{\#\# get top score (of structure) formula}
\NormalTok{        top\_struc\_formula }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{molecularFormula}
        \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} get score}
\NormalTok{        formula\_structure\_rank1 }\OtherTok{\textless{}{-}}
\NormalTok{          formula\_df[ }\FunctionTok{which}\NormalTok{(formula\_df}\SpecialCharTok{$}\NormalTok{molecularFormula }\SpecialCharTok{==}\NormalTok{ top\_struc\_formula), }\FunctionTok{c}\NormalTok{(formula\_info)]}
\NormalTok{        score\_rank1\_zodiac }\OtherTok{\textless{}{-}}\NormalTok{ formula\_zodiac\_rank1[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{ZodiacScore }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# get score}
          \FunctionTok{as.numeric}\NormalTok{()}
\NormalTok{        score\_rank1\_structure }\OtherTok{\textless{}{-}}\NormalTok{ formula\_structure\_rank1[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{ZodiacScore }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# get score}
          \FunctionTok{as.numeric}\NormalTok{()}
        \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} comparation}
        \ControlFlowTok{if}\NormalTok{( score\_rank1\_zodiac }\SpecialCharTok{\textgreater{}=}\NormalTok{ (score\_rank1\_structure }\SpecialCharTok{*}\NormalTok{ fc) )\{}
\NormalTok{          use\_zodiac }\OtherTok{=}\NormalTok{ T}
          \DocumentationTok{\#\# sometimes rank 1 zodiac formulae are plural, due to complex adduct type}
          \DocumentationTok{\#\# hence based on structure score to filter them}
\NormalTok{          structure\_df }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[structure\_df}\SpecialCharTok{$}\NormalTok{molecularFormula }\SpecialCharTok{\%in\%}\NormalTok{ formula\_zodiac\_rank1}\SpecialCharTok{$}\NormalTok{molecularFormula, ]}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{          use\_zodiac }\OtherTok{=}\NormalTok{ F}
\NormalTok{        \}}
        \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} aquisition}
        \ControlFlowTok{if}\NormalTok{( }\FunctionTok{nrow}\NormalTok{(structure\_df) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{ )\{}
          \DocumentationTok{\#\# in rank 1 zodiac formula, top score (structure) formula were picked}
\NormalTok{          structure\_pick }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[}\DecValTok{1}\NormalTok{,]}
\NormalTok{          formula\_adduct }\OtherTok{\textless{}{-}} 
\NormalTok{            formula\_df[}\FunctionTok{which}\NormalTok{(formula\_df}\SpecialCharTok{$}\NormalTok{molecularFormula }\SpecialCharTok{==}\NormalTok{ structure\_pick}\SpecialCharTok{$}\NormalTok{molecularFormula), }\FunctionTok{c}\NormalTok{(formula\_info)]}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{          structure\_pick }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
\NormalTok{          formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ formula\_zodiac\_rank1[}\DecValTok{1}\NormalTok{,]}
\NormalTok{        \}}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{ }\CommentTok{\# nrow(structure\_df) == 0, no results}
\NormalTok{        use\_zodiac }\OtherTok{=}\NormalTok{ T}
\NormalTok{        structure\_pick }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
\NormalTok{        formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ formula\_zodiac\_rank1[}\DecValTok{1}\NormalTok{,]}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{ }\CommentTok{\# try{-}error or check == F, no such files}
\NormalTok{      use\_zodiac }\OtherTok{=}\NormalTok{ T}
\NormalTok{      structure\_pick }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{()}
\NormalTok{      formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ formula\_zodiac\_rank1[}\DecValTok{1}\NormalTok{,]}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# add annotation col}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(formula\_adduct, }\AttributeTok{use\_zodiac =}\NormalTok{ use\_zodiac)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(formula\_cache) }\SpecialCharTok{==}\NormalTok{ F }\SpecialCharTok{\&} \FunctionTok{is.null}\NormalTok{(structure\_cache) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(key\_id), formula\_adduct, }\AttributeTok{envir =}\NormalTok{ formula\_cache)}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(key\_id), structure\_pick, }\AttributeTok{envir =}\NormalTok{ structure\_cache)}
\NormalTok{    \}}
    \DocumentationTok{\#\# return data}
    \ControlFlowTok{if}\NormalTok{(return\_formula }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(formula\_adduct)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(return\_structure }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(structure\_pick)}
\NormalTok{    \}}
\NormalTok{  \}}
\DocumentationTok{\#\# get dir from key\_id}
\NormalTok{get\_dir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(key\_id, }\AttributeTok{path =}\NormalTok{ .MCn.sirius)\{}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{), }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{  check }\OtherTok{\textless{}{-}} \FunctionTok{check\_dir}\NormalTok{(dir)}
  \ControlFlowTok{if}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)\{}
    \FunctionTok{return}\NormalTok{(dir)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_rerank_binning_cluster.r}{%
\section{File: method\_rerank\_binning\_cluster.R}\label{file-method_rerank_binning_cluster.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param apset PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param cluster\_cutoff PARAM\_DESCRIPTION, Default: seq(0.9, 0.1, by = {-}0.1)}
\CommentTok{\#\textquotesingle{} @param least\_size PARAM\_DESCRIPTION, Default: 3}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[ChemmineR]\{cmp.cluster\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{arrange\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{distinct\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[reshape2]\{melt\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[tidyr]\{separate\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_rerank\_binning\_cluster}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom ChemmineR cmp.cluster}
\CommentTok{\#\textquotesingle{} @importFrom dplyr select mutate arrange filter distinct}
\CommentTok{\#\textquotesingle{} @importFrom reshape2 melt}
\CommentTok{\#\textquotesingle{} @importFrom tidyr separate}
\NormalTok{method\_rerank\_binning\_cluster }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           apset,}
\NormalTok{           reference\_compound,}
           \AttributeTok{cluster\_cutoff =} \FunctionTok{seq}\NormalTok{(}\FloatTok{0.9}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\AttributeTok{by =} \SpecialCharTok{{-}}\FloatTok{0.01}\NormalTok{),}
           \AttributeTok{least\_size =} \DecValTok{3}
\NormalTok{           )\{}
    \DocumentationTok{\#\# cluster via function of ChemmineR}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# method\_rerank\_binning\_cluster: ChemmineR::cmp.cluster}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ ChemmineR}\SpecialCharTok{::}\FunctionTok{cmp.cluster}\NormalTok{(}\AttributeTok{db =}\NormalTok{ apset, }\AttributeTok{cutoff =}\NormalTok{ cluster\_cutoff)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# preparation for calculating}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get cluster ID}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(meta\_rank, ids, }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"CLID"}\NormalTok{))}
    \DocumentationTok{\#\# reshape the data as long data frame}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(meta\_rank, }\AttributeTok{id.var =} \StringTok{"ids"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"name"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"number"}\NormalTok{)}
    \DocumentationTok{\#\# get the cutoff of cluster results}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_rank, }\AttributeTok{cutoff =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(name, }\StringTok{"(?\textless{}=\_).\{1,\}$"}\NormalTok{),}
                               \DocumentationTok{\#\# get origin .id}
                               \AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ids, }\StringTok{".*(?=\_)"}\NormalTok{),}
                               \DocumentationTok{\#\# get origin structure\_rank}
                               \AttributeTok{structure\_rank =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ids, }\StringTok{"(?\textless{}=\_)[0{-}9]\{1,\}$"}\NormalTok{),}
                               \DocumentationTok{\#\# whether reference compound}
                               \AttributeTok{reference =} \FunctionTok{ifelse}\NormalTok{(.id }\SpecialCharTok{\%in\%}\NormalTok{ reference\_compound}\SpecialCharTok{$}\NormalTok{.id }\SpecialCharTok{\&}\NormalTok{ structure\_rank }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, T, F))}
    \DocumentationTok{\#\# merge to get tanimotoSimilarity of reference compound}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(meta\_rank,}
\NormalTok{                       reference\_compound[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)],}
                       \AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# if the compound is reference compound, assign tanimotoSimilarity as reference\_score}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_rank,}
                               \AttributeTok{reference\_score =} \FunctionTok{ifelse}\NormalTok{(reference, tanimotoSimilarity, }\DecValTok{0}\NormalTok{),}
                               \DocumentationTok{\#\# set group, according to cutoff and cluster ID}
                               \AttributeTok{group =} \FunctionTok{paste0}\NormalTok{(name, }\StringTok{"\_"}\NormalTok{, number))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# to calculate score of each cluster, set group}
\NormalTok{    cluster\_score }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(meta\_rank, group)}
    \DocumentationTok{\#\# calculate}
\NormalTok{    cluster\_score }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(cluster\_score, }\StringTok{"reference\_score"}\NormalTok{, sum)}
    \DocumentationTok{\#\# rename}
\NormalTok{    cluster\_score }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(cluster\_score, }\AttributeTok{cluster\_score =}\NormalTok{ reference\_score)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# merge to get cluster\_score}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(meta\_rank, cluster\_score, }\AttributeTok{by =} \StringTok{"group"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# according to cutoff, re{-}size the score}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_rank, }\AttributeTok{cluster\_score =}\NormalTok{ cluster\_score }\SpecialCharTok{*} \FunctionTok{as.numeric}\NormalTok{(cutoff)}\SpecialCharTok{\^{}}\DecValTok{3}\NormalTok{)}
    \DocumentationTok{\#\# group via id and structure\_rank}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(meta\_rank, ids)}
    \DocumentationTok{\#\# for all scores of one id, get sum score}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(meta\_rank, }\StringTok{"cluster\_score"}\NormalTok{, sum)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# reformat and output}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_rank,}
                               \DocumentationTok{\#\# get origin .id}
                               \AttributeTok{.id =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ids, }\StringTok{".*(?=\_)"}\NormalTok{),}
                               \DocumentationTok{\#\# get origin structure\_rank}
                               \AttributeTok{structure\_rank =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ids, }\StringTok{"(?\textless{}=\_)[0{-}9]\{1,\}$"}\NormalTok{))}
    \DocumentationTok{\#\# by id as list}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(meta\_rank, }\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# normalize the score, via dividing by top score}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(meta\_rank, }\ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{                          dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{norm\_score =}\NormalTok{ cluster\_score }\SpecialCharTok{/} \FunctionTok{max}\NormalTok{(cluster\_score))}
\NormalTok{                               \})}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(meta\_rank)}
    \DocumentationTok{\#\# as tabble}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(meta\_rank)}
    \FunctionTok{return}\NormalTok{(meta\_rank)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ ChemmineR}\SpecialCharTok{::}\FunctionTok{cmp.cluster}\NormalTok{(}\AttributeTok{db =}\NormalTok{ apset, }\AttributeTok{cutoff =}\NormalTok{ cluster\_cutoff) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(ids, }\FunctionTok{starts\_with}\NormalTok{(}\StringTok{"CLSZ\_"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# convert into long table}
\NormalTok{      reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(}\AttributeTok{id.var =} \StringTok{"ids"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"cutoff"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"size"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# get \textquotesingle{}cutoff\textquotesingle{} and as.numeric}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{cutoff =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{gsub}\NormalTok{(}\StringTok{"CLSZ\_"}\NormalTok{, }\StringTok{""}\NormalTok{, cutoff))) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# get \textquotesingle{}.id\textquotesingle{} and \textquotesingle{}structure\_rank\textquotesingle{}}
\NormalTok{      tidyr}\SpecialCharTok{::}\FunctionTok{separate}\NormalTok{(}\AttributeTok{col =} \StringTok{"ids"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"structure\_rank"}\NormalTok{), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{, }\AttributeTok{remove =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{structure\_rank =} \FunctionTok{as.numeric}\NormalTok{(structure\_rank)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(cutoff), }\FunctionTok{desc}\NormalTok{(size), structure\_rank) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# at least, the size of cluster reach \textquotesingle{}least\_size\textquotesingle{}, contribute to re{-}rank}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\NormalTok{(cutoff }\SpecialCharTok{\textgreater{}=} \FunctionTok{min}\NormalTok{(cluster\_cutoff) }\SpecialCharTok{\&}\NormalTok{ size }\SpecialCharTok{\textless{}=}\NormalTok{ least\_size)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# for each .id, only the top 1 (according to \textquotesingle{}cutoff\textquotesingle{}, \textquotesingle{}size\textquotesingle{}, \textquotesingle{}structure\_rank\textquotesingle{}, sequentialy) retain}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(.id, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(meta\_rank)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_rerank_jarvis_patrick_cluster.r}{%
\section{File: method\_rerank\_jarvis\_patrick\_cluster.R}\label{file-method_rerank_jarvis_patrick_cluster.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param apset PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param cluster\_cutoff PARAM\_DESCRIPTION, Default: 0.7}
\CommentTok{\#\textquotesingle{} @param generate\_neighbors PARAM\_DESCRIPTION, Default: 20}
\CommentTok{\#\textquotesingle{} @param share\_numbers PARAM\_DESCRIPTION, Default: 10}
\CommentTok{\#\textquotesingle{} @param share\_limite PARAM\_DESCRIPTION, Default: \textquotesingle{}average\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[ChemmineR]\{jarvisPatrick\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{arrange\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{distinct\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[tidyr]\{separate\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_rerank\_jarvis\_patrick\_cluster}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom ChemmineR jarvisPatrick}
\CommentTok{\#\textquotesingle{} @importFrom dplyr rename mutate arrange distinct}
\CommentTok{\#\textquotesingle{} @importFrom tidyr separate}
\NormalTok{method\_rerank\_jarvis\_patrick\_cluster }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           apset,}
           \AttributeTok{cluster\_cutoff =} \FloatTok{0.7}\NormalTok{,}
           \AttributeTok{generate\_neighbors =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{share\_numbers =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{share\_limite =} \StringTok{"average"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# cluster via function of ChemmineR}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# method\_rerank\_jarvis\_patrick\_cluster: ChemmineR::jarvisPatrick}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}}\NormalTok{ ChemmineR}\SpecialCharTok{::}\FunctionTok{jarvisPatrick}\NormalTok{(}\FunctionTok{nearestNeighbors}\NormalTok{(apset,}
                                                \AttributeTok{numNbrs =}\NormalTok{ generate\_neighbors,}
                                                \AttributeTok{cutoff =}\NormalTok{ cluster\_cutoff),}
                               \AttributeTok{k =}\NormalTok{ share\_numbers,}
                               \AttributeTok{linkage =}\NormalTok{ share\_limite,}
                               \AttributeTok{mode =} \StringTok{"a1b"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{vector\_as\_df}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(., }\FunctionTok{vector\_as\_df}\NormalTok{(}\FunctionTok{table}\NormalTok{(.}\SpecialCharTok{$}\NormalTok{expr)), }\AttributeTok{by.x =} \StringTok{"expr"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"ids"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{cluster\_id =}\NormalTok{ expr, }\AttributeTok{size =}\NormalTok{ expr.y) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidyr}\SpecialCharTok{::}\FunctionTok{separate}\NormalTok{(}\AttributeTok{col =} \StringTok{"ids"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"structure\_rank"}\NormalTok{), }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{, }\AttributeTok{remove =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{structure\_rank =} \FunctionTok{as.numeric}\NormalTok{(structure\_rank)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(size), structure\_rank) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# for each .id, only the top 1 (according to \textquotesingle{}size\textquotesingle{}, \textquotesingle{}structure\_rank\textquotesingle{}, sequentialy) retain}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(.id, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(meta\_rank)}
\NormalTok{  \}}
\NormalTok{vector\_as\_df }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{data.table}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\AttributeTok{ids =} \FunctionTok{names}\NormalTok{(vector), }\AttributeTok{expr =} \FunctionTok{unname}\NormalTok{(vector)))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_summarize_nebula_class.r}{%
\section{File: method\_summarize\_nebula\_class.R}\label{file-method_summarize_nebula_class.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{method\_summarize\_nebula\_class }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           data,}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{max\_number =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{hierarchy\_priority =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{), }\DocumentationTok{\#\# level 5, subclass, class, superclass}
           \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_list"}\NormalTok{, }\DocumentationTok{\#\# or "classes\_tree\_data"}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# input data }
    \ControlFlowTok{if}\NormalTok{(class\_data\_type }\SpecialCharTok{==} \StringTok{"classes\_tree\_list"}\NormalTok{)\{}
\NormalTok{      class\_data }\OtherTok{=}\NormalTok{ .MCn.class\_tree\_list}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(class\_data, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{hierarchy =}\NormalTok{ .id)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(class\_data\_type }\SpecialCharTok{==} \StringTok{"classes\_tree\_data"}\NormalTok{)\{}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ class\_data }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"metadata"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# main body}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, V1 }\SpecialCharTok{\textgreater{}=}\NormalTok{ ppcp\_threshold) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(metadata[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(hierarchy }\SpecialCharTok{\%in\%}\NormalTok{ hierarchy\_priority)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{hierarchy, }\AttributeTok{levels =}\NormalTok{ hierarchy\_priority), }\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{V1), ] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{head}\NormalTok{(}\AttributeTok{n =}\NormalTok{ max\_number)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_summarize_nebula_index.r}{%
\section{File: method\_summarize\_nebula\_index.R}\label{file-method_summarize_nebula_index.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{method\_summarize\_nebula\_index }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           ppcp\_dataset,}
           \AttributeTok{nebula\_class =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}\NormalTok{,}
           \CommentTok{\# min number of compounds allowed exist in a child{-}nebula. if less than, filter the nebula}
           \AttributeTok{min\_possess =} \DecValTok{10}\NormalTok{, }
           \DocumentationTok{\#\# max percentage of compounds allowed exist in a child{-}nebula}
           \AttributeTok{max\_possess\_pct =} \FloatTok{0.2}\NormalTok{, }
           \AttributeTok{identical\_merge =}\NormalTok{ T,}
           \AttributeTok{identical\_factor =} \FloatTok{0.8}\NormalTok{,}
           \DocumentationTok{\#\# if set to 4 (class), the level of or below this hierarchy (e.g., subclass) will perform merge}
           \AttributeTok{merge\_allowed\_hierarchy =} \FunctionTok{c}\NormalTok{(}\StringTok{"top\_level"} \OtherTok{=} \DecValTok{4}\NormalTok{), }
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    classes }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(nebula\_class) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(relativeIndex)}
    \DocumentationTok{\#\# get classes}
\NormalTok{    classes }\OtherTok{\textless{}{-}}\NormalTok{ classes}\SpecialCharTok{$}\NormalTok{relativeIndex}
    \DocumentationTok{\#\# environment for lapply function}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_classes"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: class\_retrieve}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    index\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(ppcp\_dataset, class\_retrieve,}
\NormalTok{                         ...)}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(index\_list, }\AttributeTok{idcol =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# filter via max\_possess and min\_possess}
\NormalTok{    stat }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(index\_df}\SpecialCharTok{$}\NormalTok{relativeIndex)}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ stat[}\FunctionTok{which}\NormalTok{(stat }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_possess }\SpecialCharTok{\&}\NormalTok{ stat }\SpecialCharTok{\textless{}=}\NormalTok{ max\_possess\_pct }\SpecialCharTok{*} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(index\_df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)))]}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ index\_df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(relativeIndex }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(stat))}
    \DocumentationTok{\#\# gather with classes annotation}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(.MCn.class\_tree\_list, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{hierarchy =}\NormalTok{ .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(relativeIndex, name, hierarchy) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(index\_df, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(identical\_merge }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# filter identical or similar classes}
      \DocumentationTok{\#\# enumerate combination}
\NormalTok{      class\_for\_merge }\OtherTok{\textless{}{-}}\NormalTok{ index\_df }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ merge\_allowed\_hierarchy[[}\StringTok{"top\_level"}\NormalTok{]]) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(relativeIndex) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{combn}\NormalTok{(}\AttributeTok{m =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{t}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{data.frame}\NormalTok{()}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: identical\_filter}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      discard }\OtherTok{=} \FunctionTok{pbapply}\NormalTok{(class\_for\_merge, }\DecValTok{1}\NormalTok{, identical\_filter,}
                      \AttributeTok{identical\_factor =}\NormalTok{ identical\_factor,}
\NormalTok{                      ...) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unique}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ index\_df[}\SpecialCharTok{!}\NormalTok{index\_df}\SpecialCharTok{$}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ discard, ]}
    \DocumentationTok{\#\# cluster id in each classes}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(index\_df, relativeIndex)}
    \FunctionTok{return}\NormalTok{(nebula\_index)}
\NormalTok{  \}}
\NormalTok{class\_retrieve }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           data,}
           \AttributeTok{the\_relativeIndex =} \FunctionTok{get}\NormalTok{(}\StringTok{"classes"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_classes"}\NormalTok{)),}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    classes }\OtherTok{\textless{}{-}}\NormalTok{ the\_relativeIndex}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ classes, V1 }\SpecialCharTok{\textgreater{}=}\NormalTok{ ppcp\_threshold)}
    \FunctionTok{return}\NormalTok{(data)}
\NormalTok{  \}}
\NormalTok{identical\_filter }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           couple,}
           \AttributeTok{index\_df =} \FunctionTok{get}\NormalTok{(}\StringTok{"index\_df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_classes"}\NormalTok{)),}
           \AttributeTok{identical\_factor =} \FloatTok{0.7}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    x }\OtherTok{=} \FunctionTok{unique}\NormalTok{(index\_df[}\FunctionTok{which}\NormalTok{(index\_df}\SpecialCharTok{$}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ couple[}\DecValTok{1}\NormalTok{]), ]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    y }\OtherTok{=} \FunctionTok{unique}\NormalTok{(index\_df[}\FunctionTok{which}\NormalTok{(index\_df}\SpecialCharTok{$}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ couple[}\DecValTok{2}\NormalTok{]), ]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    p\_x }\OtherTok{=} \FunctionTok{table}\NormalTok{(x }\SpecialCharTok{\%in\%}\NormalTok{ y)}
\NormalTok{    p\_y }\OtherTok{=} \FunctionTok{table}\NormalTok{(y }\SpecialCharTok{\%in\%}\NormalTok{ x)}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"TRUE"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(p\_x) }\SpecialCharTok{==}\NormalTok{ F }\SpecialCharTok{|} \StringTok{"TRUE"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(p\_y) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    p\_x }\OtherTok{=} \FunctionTok{prop.table}\NormalTok{(p\_x)[[}\StringTok{"TRUE"}\NormalTok{]]}
\NormalTok{    p\_y }\OtherTok{=} \FunctionTok{prop.table}\NormalTok{(p\_y)[[}\StringTok{"TRUE"}\NormalTok{]]}
    \ControlFlowTok{if}\NormalTok{(p\_x }\SpecialCharTok{\textgreater{}=}\NormalTok{ identical\_factor }\SpecialCharTok{\&}\NormalTok{ p\_y }\SpecialCharTok{\textgreater{}=}\NormalTok{ identical\_factor)\{}
\NormalTok{      idn }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{\textgreater{}=} \FunctionTok{length}\NormalTok{(y), couple[}\DecValTok{2}\NormalTok{], couple[}\DecValTok{1}\NormalTok{])}
      \FunctionTok{return}\NormalTok{(idn)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-n_method_pick_formula_excellent.r}{%
\section{File: n\_method\_pick\_formula\_excellent.R}\label{file-n_method_pick_formula_excellent.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param dir PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param key\_id PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param return\_formula PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param return\_structure PARAM\_DESCRIPTION, Default: F}
\CommentTok{\#\textquotesingle{} @param formula\_cache PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param structure\_cache PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param exclude\_element PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param ppm\_error PARAM\_DESCRIPTION, Default: 20}
\CommentTok{\#\textquotesingle{} @param fc PARAM\_DESCRIPTION, Default: 1.5}
\CommentTok{\#\textquotesingle{} @param formula\_info PARAM\_DESCRIPTION, Default: c("precursorFormula", "molecularFormula", "adduct", "ZodiacScore")}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_pick\_formula\_excellent}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr mutate}
\NormalTok{method\_pick\_formula\_excellent }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{, }
           \AttributeTok{dir =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{return\_formula =}\NormalTok{ T,}
           \AttributeTok{return\_structure =}\NormalTok{ F,}
           \AttributeTok{formula\_cache =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{structure\_cache =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{exclude\_element =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{ppm\_error =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{fc =} \FloatTok{1.5}\NormalTok{,}
           \AttributeTok{formula\_info =} \FunctionTok{c}\NormalTok{(}\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{, }\StringTok{"ZodiacScore"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(dir) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{)\{}
\NormalTok{        meta }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ dir)}
\NormalTok{        meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta, }\AttributeTok{key\_id =} \FunctionTok{grep\_id}\NormalTok{(dir))}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      meta }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{key\_id =}\NormalTok{ key\_id, }\AttributeTok{dir =} \FunctionTok{get\_dir}\NormalTok{(key\_id))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta, }\AttributeTok{formula\_dir =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"formula\_candidates.tsv"}\NormalTok{),}
                          \AttributeTok{fingerid =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"fingerid"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# method part: check\_dir: formula set}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(meta}\SpecialCharTok{$}\NormalTok{formula\_dir, file.exists)}
\NormalTok{    meta}\SpecialCharTok{$}\NormalTok{check\_fm }\OtherTok{\textless{}{-}}\NormalTok{ check}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# method part: check\_dir: fingerid}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(meta}\SpecialCharTok{$}\NormalTok{fingerid, file.exists)}
\NormalTok{    meta}\SpecialCharTok{$}\NormalTok{check\_fd }\OtherTok{\textless{}{-}}\NormalTok{ check}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-nebula_re_rank.r}{%
\section{File: nebula\_re\_rank.R}\label{file-nebula_re_rank.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nebula\_re\_rank }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{top\_n =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{match\_pattern =} \FunctionTok{c}\NormalTok{(}\StringTok{"precursorFormula"}\NormalTok{), }\DocumentationTok{\#\# or c("precursorFormula", "adduct")}
           \AttributeTok{collate\_factor =} \FloatTok{0.85}\NormalTok{,}
           \AttributeTok{cluster\_method =} \StringTok{"method\_rerank\_binning\_cluster"}\NormalTok{,}
           \AttributeTok{revise\_MCn\_formula\_set =}\NormalTok{ T,}
           \AttributeTok{revise\_MCn\_structure\_set =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: nebula\_re\_rank}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# get formula}
\NormalTok{    id\_set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.formula\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ id\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# match patern}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"precursorFormula"} \SpecialCharTok{\%in\%}\NormalTok{ match\_pattern }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      formula\_adduct}\SpecialCharTok{$}\NormalTok{precursorFormula }\OtherTok{=} \ConstantTok{NULL}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"adduct"} \SpecialCharTok{\%in\%}\NormalTok{ match\_pattern }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      formula\_adduct}\SpecialCharTok{$}\NormalTok{adduct }\OtherTok{=} \ConstantTok{NULL}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# catch file}
    \DocumentationTok{\#\# due to the return data type of mapply, lapply is used instead}
    \DocumentationTok{\#\# first, as list}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(formula\_adduct}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, by\_group\_for\_list,}
                             \AttributeTok{col =} \StringTok{".id"}\NormalTok{,}
                             \AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"formula\_adduct"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)))}
    \DocumentationTok{\#\# then, use lapply match file}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# netbula\_re\_rank: get\_structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(formula\_adduct, df\_get\_structure,}
                                       \AttributeTok{top\_n =}\NormalTok{ top\_n,}
                                       \AttributeTok{collate\_factor =}\NormalTok{ collate\_factor,}
\NormalTok{                                       ...)}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(structure\_set, }\AttributeTok{fill =}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of structure\_set:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(structure\_set), }\StringTok{" (structure sum)/"}\NormalTok{, }\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(structure\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)), }\StringTok{"(.id sum)"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get sdfset, and further get apset via ChemmineR}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# convert data: SMILES\_set {-}\textgreater{} SDF\_set {-}\textgreater{} AP\_set}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    sdfset }\OtherTok{\textless{}{-}} \FunctionTok{smiles\_to\_sdfset}\NormalTok{(structure\_set)}
\NormalTok{    apset }\OtherTok{\textless{}{-}} \FunctionTok{sdf2ap}\NormalTok{(sdfset)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# cluster method}
\NormalTok{    method\_fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(cluster\_method)}
\NormalTok{    meta\_rank }\OtherTok{\textless{}{-}} \FunctionTok{method\_fun}\NormalTok{(apset, ...)}
    \FunctionTok{print}\NormalTok{(meta\_rank)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(structure\_set,}
\NormalTok{                           meta\_rank[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"structure\_rank"}\NormalTok{, }\StringTok{"size"}\NormalTok{)],}
                           \AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"structure\_rank"}\NormalTok{), }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(size) }\SpecialCharTok{==}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# revise .GlobalVar .MCn.formula\_set}
    \ControlFlowTok{if}\NormalTok{(revise\_MCn\_formula\_set }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# prepare replace data}
\NormalTok{      rp }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(structure\_set, .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        tidyr}\SpecialCharTok{::}\FunctionTok{separate}\NormalTok{(}\AttributeTok{col =} \StringTok{"file\_name"}\NormalTok{, }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{adduct =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+(?!$)"}\NormalTok{, }\StringTok{" }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+ "}\NormalTok{, adduct, }\AttributeTok{perl =}\NormalTok{ T),}
                      \AttributeTok{adduct =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}(?!$)"}\NormalTok{, }\StringTok{" }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-} "}\NormalTok{, adduct, }\AttributeTok{perl =}\NormalTok{ T)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, precursorFormula, adduct, molecularFormula)}
      \DocumentationTok{\#\# replace}
\NormalTok{      fset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(.MCn.formula\_set, .id)}
\NormalTok{      fset[fset}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{\%in\%}\NormalTok{ rp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{)] }\OtherTok{\textless{}{-}}\NormalTok{ rp}
\NormalTok{      .MCn.formula\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ fset}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# revise .GlobalVar .MCn.structure\_set {-}{-}{-}{-}{-}{-}{-}}
    \ControlFlowTok{if}\NormalTok{(revise\_MCn\_structure\_set }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      sset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(.MCn.structure\_set, .id)}
      \DocumentationTok{\#\# prepare replace data}
\NormalTok{      rp }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(structure\_set, .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(sset))}
      \DocumentationTok{\#\# replace}
\NormalTok{      sset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(rp, sset), .id, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
\NormalTok{      .MCn.structure\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ sset}
      \DocumentationTok{\#\# rename exist structure picture {-}{-}{-}{-}{-}{-}{-}}
\NormalTok{      tmp\_stru }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(tmp\_stru) }\SpecialCharTok{==}\NormalTok{ T)\{}
        \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(tmp\_stru, }\StringTok{"/"}\NormalTok{, rp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{".svg"}\NormalTok{), rename\_file)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: nebula\_re\_rank}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(structure\_set)}
\NormalTok{  \}}
\NormalTok{smiles\_to\_sdfset }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_set}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    smiles\_set }\OtherTok{\textless{}{-}}\NormalTok{ structure\_set}\SpecialCharTok{$}\NormalTok{smiles}
    \FunctionTok{names}\NormalTok{(smiles\_set) }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(structure\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{"\_"}\NormalTok{, structure\_set}\SpecialCharTok{$}\NormalTok{structure\_rank)}
    \DocumentationTok{\#\# this function automaticly set the vector name as name of each subset}
\NormalTok{    sdf\_set }\OtherTok{\textless{}{-}}\NormalTok{ ChemmineR}\SpecialCharTok{::}\FunctionTok{smiles2sdf}\NormalTok{(smiles\_set)}
    \FunctionTok{return}\NormalTok{(sdf\_set)}
\NormalTok{  \}}
\NormalTok{df\_get\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{top\_n =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{collate\_factor =} \FloatTok{0.85}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get\_structure}\NormalTok{(}
\NormalTok{                        x[[}\StringTok{".id"}\NormalTok{]],}
\NormalTok{                        x[[}\StringTok{"precursorFormula"}\NormalTok{]],}
\NormalTok{                        x[[}\StringTok{"adduct"}\NormalTok{]],}
                        \AttributeTok{return\_row =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{top\_n,}
\NormalTok{                        ...)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \}}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{.id =}\NormalTok{ x[[}\StringTok{".id"}\NormalTok{]]) }\DocumentationTok{\#\# add key\_id}
\NormalTok{    top\_simi }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{]}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ top\_simi }\SpecialCharTok{*}\NormalTok{ collate\_factor)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{rename\_file }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{suffix =} \StringTok{"prefix"}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(file) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{file.rename}\NormalTok{(file, }\FunctionTok{paste0}\NormalTok{(file, }\StringTok{"."}\NormalTok{, suffix))}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-read_tsv.r-1}{%
\section{File: read\_tsv.R}\label{file-read_tsv.r-1}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_tsv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input=}\NormalTok{path, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{quote=}\StringTok{""}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F)}
  \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}
\NormalTok{write\_tsv }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, filename)\{}
    \FunctionTok{write.table}\NormalTok{(x, }\AttributeTok{file =}\NormalTok{ filename, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-test.r}{%
\section{File: test.R}\label{file-test.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{compare\_score }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_df,}
\NormalTok{           formula\_df,}
\NormalTok{           formula\_zodiac\_rank1,}
\NormalTok{           formula\_info,}
\NormalTok{           fc}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(fc) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \DocumentationTok{\#\# get top score (of structure) formula}
\NormalTok{      top\_struc\_formula }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{molecularFormula}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} get score}
\NormalTok{      formula\_structure\_rank1 }\OtherTok{\textless{}{-}}
\NormalTok{        formula\_df[ molecularFormula }\SpecialCharTok{==}\NormalTok{ top\_struc\_formula, formula\_info, with }\OtherTok{=}\NormalTok{ F]}
      \DocumentationTok{\#\# get score}
      \DocumentationTok{\#\# the data.frame is a data.table project}
\NormalTok{      score\_rank1\_zodiac }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(formula\_zodiac\_rank1[}\DecValTok{1}\NormalTok{, ZodiacScore])}
\NormalTok{      score\_rank1\_structure }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(formula\_structure\_rank1[}\DecValTok{1}\NormalTok{, ZodiacScore])}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} comparation}
      \ControlFlowTok{if}\NormalTok{( score\_rank1\_zodiac }\SpecialCharTok{\textgreater{}=}\NormalTok{ (score\_rank1\_structure }\SpecialCharTok{*}\NormalTok{ fc) )\{}
\NormalTok{        use\_zodiac }\OtherTok{=}\NormalTok{ T}
        \DocumentationTok{\#\# sometimes rank 1 zodiac formulae are plural, due to complex adduct type}
        \DocumentationTok{\#\# hence based on structure score to filter them}
\NormalTok{        structure\_df }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[molecularFormula }\SpecialCharTok{\%in\%}\NormalTok{ formula\_zodiac\_rank1}\SpecialCharTok{$}\NormalTok{molecularFormula, ]}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        use\_zodiac }\OtherTok{=}\NormalTok{ F}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      use\_zodiac }\OtherTok{=}\NormalTok{ F}
\NormalTok{    \}}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(structure\_df, use\_zodiac)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-vis_via_molconvert.r}{%
\section{File: vis\_via\_molconvert.R}\label{file-vis_via_molconvert.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vis\_via\_molconvert\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}
\NormalTok{    stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.structure\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{vis\_via\_molconvert}\NormalTok{(stru}\SpecialCharTok{$}\NormalTok{smiles, stru}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{vis\_via\_molconvert }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(output) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results))}
      \FunctionTok{dir.create}\NormalTok{(output)}
\NormalTok{    \}}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(molconvert\_structure,}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{output =}\NormalTok{ output)}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{molconvert\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles,}
\NormalTok{           id,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{=} \FunctionTok{tempfile}\NormalTok{()}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"molconvert mol }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, smiles, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ {-}o "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"obabel "}\NormalTok{, file, }\StringTok{" {-}imol {-}osvg {-}O "}\NormalTok{, file, }\StringTok{" \textgreater{} /dev/null 2\textgreater{}\&1"}\NormalTok{))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"sed {-}i }\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{s/white/transparent/g}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{ "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cairosvg {-}f svg "}\NormalTok{, file, }\StringTok{" {-}o "}\NormalTok{, output, }\StringTok{"/"}\NormalTok{, id, }\StringTok{".svg"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_child_nebulae.r}{%
\section{File: visualize\_child\_nebulae.R}\label{file-visualize_child_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{visualize\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{graph\_list =}\NormalTok{ .MCn.child\_graph\_list,}
           \AttributeTok{compound\_class\_list =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{23}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{30}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: visualize\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# get top compound class (nodes\_color data)}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_class\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# draw network via ggplot, and print into grid palette}
    \DocumentationTok{\#\# number of child\_nebulae}
\NormalTok{    n }\OtherTok{=} \FunctionTok{length}\NormalTok{(graph\_list)}
    \DocumentationTok{\#\# specification of grid (cols * rows)}
\NormalTok{    cols }\OtherTok{=}\NormalTok{ n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(cols) }\SpecialCharTok{!=}\NormalTok{ cols)\{}
\NormalTok{      cols }\OtherTok{=} \FunctionTok{round}\NormalTok{(cols)}
\NormalTok{      rows }\OtherTok{=}\NormalTok{ cols }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      rows }\OtherTok{=}\NormalTok{ cols}
\NormalTok{    \}}
    \DocumentationTok{\#\# grid position of all child\_nebulae}
\NormalTok{    graph\_anno }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(graph\_list) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# names}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{nebula\_index =}\NormalTok{ value) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(.MCn.class\_tree\_data[,}\FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"hierarchy"}\NormalTok{)], }\AttributeTok{by.x =} \StringTok{"nebula\_index"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(hierarchy)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# calculate position}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{seq =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n, }
                    \AttributeTok{col =} \FunctionTok{ifelse}\NormalTok{(seq }\SpecialCharTok{\%\%}\NormalTok{ cols }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{, seq }\SpecialCharTok{\%\%}\NormalTok{ cols, cols),}
                    \AttributeTok{row =}\NormalTok{ (seq }\SpecialCharTok{{-}}\NormalTok{ col)}\SpecialCharTok{/}\NormalTok{cols }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
    \DocumentationTok{\#\# as list}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}}\NormalTok{ graph\_anno}\SpecialCharTok{$}\NormalTok{nebula\_index}
\NormalTok{    graph\_anno }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(nebula\_index, by\_group\_for\_list,}
                         \AttributeTok{df =} \FunctionTok{get}\NormalTok{(}\StringTok{"graph\_anno"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{)), }
                         \AttributeTok{col =} \StringTok{"nebula\_index"}\NormalTok{)}
    \DocumentationTok{\#\# re{-}order the graph list according to annotation}
\NormalTok{    graph\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(nebula\_index,}
                         \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{                           graph\_list[[x]]}
\NormalTok{                         \})}
    \DocumentationTok{\#\# prepare grid palette}
\NormalTok{    svglite}\SpecialCharTok{::}\FunctionTok{svglite}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebulae.svg"}\NormalTok{), }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{grid.newpage}\NormalTok{()}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(rows, cols)))}
    \DocumentationTok{\#\# draw child\_nebulae in grid}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(grid\_child\_nebula, }\DocumentationTok{\#\# function}
\NormalTok{                      graph\_list, }\DocumentationTok{\#\# graph list}
\NormalTok{                      graph\_anno, }\DocumentationTok{\#\# graph annotation}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{( }\DocumentationTok{\#\# args}
                                      \AttributeTok{layout =}\NormalTok{ layout,}
\NormalTok{                                      ...}
\NormalTok{                                      ))}
    \FunctionTok{dev.off}\NormalTok{()}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: visualize\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{grid\_child\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           graph,}
\NormalTok{           anno,}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{class =} \FunctionTok{get}\NormalTok{(}\StringTok{"metadata"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{)),}
           \AttributeTok{title\_palette =}\NormalTok{ .MCn.palette\_label,}
           \AttributeTok{print\_into =}\NormalTok{ T,}
           \AttributeTok{save\_layout\_df =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{remove\_nodes =} \ConstantTok{NULL}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# reformat graph, add with class}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
    \DocumentationTok{\#\# nodes {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(graph, class, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{ , }\AttributeTok{by.y =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(nodes)}
    \DocumentationTok{\#\# edges {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(graph, edges))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(edges) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{)\{}
      \DocumentationTok{\#\# "dotproduct" or other attributes of compare spectra method.}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(edges, }\AttributeTok{similarity =} \DecValTok{3}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(edges, }\AttributeTok{similarity =} \ConstantTok{NA}\NormalTok{) }
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# gather nodes and edges}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ nodes, }\AttributeTok{edges =}\NormalTok{ edges)}
    \DocumentationTok{\#\# create network layout}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{create\_layout}\NormalTok{(graph, }\AttributeTok{layout =}\NormalTok{ layout, ...)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(save\_layout\_df) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"layout\_n"}\NormalTok{, layout\_n, }\AttributeTok{envir =}\NormalTok{ save\_layout\_df)}
\NormalTok{    \}}
    \DocumentationTok{\#\# color palette}
\NormalTok{    palette }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.palette}
    \DocumentationTok{\#\# plot}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{base\_vis\_c\_nebula}\NormalTok{(layout\_n, palette,}
                           \AttributeTok{title =}\NormalTok{ anno[[}\StringTok{"nebula\_index"}\NormalTok{]],}
                           \AttributeTok{title\_fill =}\NormalTok{ title\_palette[}\FunctionTok{as.numeric}\NormalTok{(anno[[}\StringTok{"hierarchy"}\NormalTok{]])],}
                           \AttributeTok{remove\_nodes =}\NormalTok{ remove\_nodes,}
\NormalTok{                           ...)}
    \ControlFlowTok{if}\NormalTok{(print\_into }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
    \FunctionTok{print}\NormalTok{(p }\SpecialCharTok{+}\NormalTok{ ggplot2}\SpecialCharTok{::}\FunctionTok{guides}\NormalTok{(}\AttributeTok{size=}\StringTok{"none"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"none"}\NormalTok{),}
          \AttributeTok{vp =}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =}\NormalTok{ anno[[}\StringTok{"row"}\NormalTok{]], }\AttributeTok{layout.pos.col =}\NormalTok{ anno[[}\StringTok{"col"}\NormalTok{]]))}
\NormalTok{  \}}
\DocumentationTok{\#\# base visualization method}
\NormalTok{base\_vis\_c\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula,}
           \AttributeTok{title =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
           \AttributeTok{title\_fill =} \StringTok{"grey"}\NormalTok{,}
           \AttributeTok{nodes\_size\_range =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{),}
           \AttributeTok{edges\_width\_range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{),}
           \AttributeTok{title\_size =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{remove\_nodes =} \ConstantTok{NULL}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(remove\_nodes) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      nodes\_size\_range }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{ggraph}\NormalTok{(nebula) }\SpecialCharTok{+} 
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width =}\NormalTok{ similarity), }\AttributeTok{color =} \StringTok{"black"}\NormalTok{, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+} 
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{geom\_node\_point}\NormalTok{(}
                      \FunctionTok{aes}\NormalTok{(}
                          \AttributeTok{size =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{==}\NormalTok{ F, tanimotoSimilarity, }\FloatTok{0.2}\NormalTok{),}
                          \AttributeTok{fill =}\NormalTok{ vis\_class}
\NormalTok{                          ),}
                      \AttributeTok{shape =} \DecValTok{21}
\NormalTok{                      ) }\SpecialCharTok{+} 
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range =}\NormalTok{ edges\_width\_range) }\SpecialCharTok{+} 
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_size}\NormalTok{(}\AttributeTok{range =}\NormalTok{ nodes\_size\_range) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{ggtitle}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(title, }\AttributeTok{width =} \DecValTok{30}\NormalTok{)) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{labs}\NormalTok{(}\AttributeTok{size =} \StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Compound class"}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{plot.title =}\NormalTok{ ggtext}\SpecialCharTok{::}\FunctionTok{element\_textbox}\NormalTok{(}
                                         \AttributeTok{size =}\NormalTok{ title\_size,}
                                         \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ title\_fill, }\AttributeTok{box.color =} \StringTok{"white"}\NormalTok{,}
                                         \AttributeTok{halign =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{linetype =} \DecValTok{1}\NormalTok{, }\AttributeTok{r =} \FunctionTok{unit}\NormalTok{(}\DecValTok{5}\NormalTok{, }\StringTok{"pt"}\NormalTok{), }\AttributeTok{width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"npc"}\NormalTok{),}
                                         \AttributeTok{padding =} \FunctionTok{margin}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{margin =} \FunctionTok{margin}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{            )}
\NormalTok{      )}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_nebula.r}{%
\section{File: visualize\_nebula.R}\label{file-visualize_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{visualize\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{annotate\_child\_nebulae}\NormalTok{(}
                                \AttributeTok{nebula\_name =}\NormalTok{ nebula\_name,}
                                \AttributeTok{write\_output =}\NormalTok{ F,}
                                \AttributeTok{plot\_structure =}\NormalTok{ F,}
                                \AttributeTok{plot\_ppcp =}\NormalTok{ F,}
                                \AttributeTok{merge\_image =}\NormalTok{ F,}
                                \AttributeTok{return\_plot =}\NormalTok{ T,}
\NormalTok{                                ...)}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_parent_nebula.r}{%
\section{File: visualize\_parent\_nebula.R}\label{file-visualize_parent_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{visualize\_parent\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{graph =}\NormalTok{ .MCn.parent\_graph,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"mds"}\NormalTok{,}
           \AttributeTok{nodes\_color =} \FunctionTok{c}\NormalTok{(}\StringTok{"hierarchy"} \OtherTok{=} \DecValTok{4}\NormalTok{), }\DocumentationTok{\#\# default, use superclass as color.}
           \AttributeTok{width =} \DecValTok{15}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{12}\NormalTok{,}
           \AttributeTok{return\_plot =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: visualize\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# get nodes\_color data}
\NormalTok{    metadata }\OtherTok{=}\NormalTok{ .MCn.class\_tree\_data}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\# Visualize\_parent\_nebula |"}\NormalTok{, }\FunctionTok{date}\NormalTok{(), }\StringTok{"| USE Method: method\_summarize\_nebula\_index.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    class }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(.MCn.ppcp\_dataset, method\_summarize\_nebula\_class, }
                               \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_data"}\NormalTok{,}
                               \AttributeTok{max\_number =} \DecValTok{1}\NormalTok{,}
                               \AttributeTok{hierarchy\_priority =}\NormalTok{ nodes\_color[[}\StringTok{"hierarchy"}\NormalTok{]] )}
\NormalTok{    class }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(class, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# reformat graph, add with class}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ graph }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(class, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{ , }\AttributeTok{by.y =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x=}\ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{vis\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(vis\_class) }\SpecialCharTok{==}\NormalTok{ T, }\StringTok{"Unknown"}\NormalTok{, vis\_class)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ graph }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# rename the col of value of compare spectra}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{similarity =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ nodes, }\AttributeTok{edges =}\NormalTok{ edges)}
    \DocumentationTok{\#\# create network layout}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{create\_layout}\NormalTok{(graph, }\AttributeTok{layout =}\NormalTok{ layout, ...)}
    \DocumentationTok{\#\# palette}
\NormalTok{    palette }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.palette}
    \DocumentationTok{\#\# draw network via ggraph}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{base\_vis\_p\_nebula}\NormalTok{(layout\_n, palette)}
    \DocumentationTok{\#\# write\_output}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula.svg"}\NormalTok{),}
             \AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    \}}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: visualize\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(return\_plot }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
\NormalTok{  \}}
\DocumentationTok{\#\# base visualization method}
\NormalTok{base\_vis\_p\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{ggraph}\NormalTok{(nebula) }\SpecialCharTok{+} 
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width =}\NormalTok{ similarity), }\AttributeTok{color =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+} 
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{geom\_node\_point}\NormalTok{(}
                      \FunctionTok{aes}\NormalTok{(}
                          \AttributeTok{size =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{==}\NormalTok{ F, tanimotoSimilarity, }\FloatTok{0.2}\NormalTok{),}
                          \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(vis\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)}
\NormalTok{                          ),}
                      \AttributeTok{shape =} \DecValTok{21}
\NormalTok{                      ) }\SpecialCharTok{+} 
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
\NormalTok{      ggraph}\SpecialCharTok{::}\FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{labs}\NormalTok{(}\AttributeTok{fill=}\StringTok{"Class"}\NormalTok{, }\AttributeTok{size=}\StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{      ggplot2}\SpecialCharTok{::}\FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{),}
            \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
            \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-rcdk.r}{%
\section{File: rcdk.R}\label{file-rcdk.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#  R rcdk structure }

\DocumentationTok{\#\#\#\#  wd \textasciitilde{}/operation/back/0703\_all/results}

\FunctionTok{library}\NormalTok{(tidyverse)}

\FunctionTok{library}\NormalTok{(rcdk)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fingerid\_first\_score.tsv"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\NormalTok{data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{smiles)}\SpecialCharTok{==}\NormalTok{F), }\FunctionTok{colnames}\NormalTok{(data) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"smiles"}\NormalTok{)]}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data))\{}

\NormalTok{id }\OtherTok{\textless{}{-}}\NormalTok{ data[i, }\DecValTok{1}\NormalTok{]}

\NormalTok{stru }\OtherTok{\textless{}{-}}\NormalTok{ data[i, }\DecValTok{2}\NormalTok{]}

\NormalTok{mols }\OtherTok{\textless{}{-}} \FunctionTok{parse.smiles}\NormalTok{(stru)}

\CommentTok{\#mols \textless{}{-} generate.2d.coordinates(mols[[1]])}

\CommentTok{\#mols \textless{}{-} get.smiles(mols,smiles.flavors(c(\textquotesingle{}CxSmiles\textquotesingle{})))}

\FunctionTok{write.molecules}\NormalTok{(mols, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"structure\_2d/smiles\_draw/"}\NormalTok{, id, }\StringTok{"\_"}\NormalTok{), }\AttributeTok{together =}\NormalTok{ F, }\AttributeTok{write.props =}\NormalTok{ F)}

\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-read_xml.r}{%
\section{File: read\_xml.R}\label{file-read_xml.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(XML)}

\NormalTok{xml }\OtherTok{\textless{}{-}} \FunctionTok{xmlToDataFrame}\NormalTok{(}\StringTok{"sites.xml"}\NormalTok{)}

\FunctionTok{write.table}\NormalTok{(xml, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"data"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{), }\AttributeTok{quote =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{row.names =} \ConstantTok{FALSE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-sirius_db.r}{%
\section{File: sirius\_db.R}\label{file-sirius_db.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(tidyverse)}
\NormalTok{path1}\OtherTok{=}\StringTok{"cnumber\_cid.tsv"}
\NormalTok{path2}\OtherTok{=}\StringTok{"merge\_smiles.tsv"}
\NormalTok{df1 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{path1, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\NormalTok{df2 }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{path2, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df1, df2, }\AttributeTok{all.y=}\NormalTok{T, }\AttributeTok{by.x=}\StringTok{"pubchem.id"}\NormalTok{, }\AttributeTok{by.y=}\StringTok{"CID"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{T)}
\NormalTok{df }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{)]}
\FunctionTok{write.table}\NormalTok{(df, }\AttributeTok{file=}\StringTok{"sirius\_db.tsv"}\NormalTok{, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names=}\NormalTok{F, }\AttributeTok{row.names=}\NormalTok{F, }\AttributeTok{quote=}\NormalTok{F)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-superstart.r}{%
\section{File: superstart.R}\label{file-superstart.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(usethis)}
\FunctionTok{library}\NormalTok{(devtools)}
\FunctionTok{library}\NormalTok{(progress)}
\DocumentationTok{\#\# data reformat}
\FunctionTok{library}\NormalTok{(pbapply)}
\FunctionTok{library}\NormalTok{(data.table)}
\FunctionTok{library}\NormalTok{(dplyr)}
\FunctionTok{library}\NormalTok{(stringr)}
\FunctionTok{load\_all}\NormalTok{(}\StringTok{"\textasciitilde{}/MCnebula/R"}\NormalTok{)}
\FunctionTok{load\_all}\NormalTok{(}\StringTok{"\textasciitilde{}/extra/"}\NormalTok{)}

\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(grid)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-ttest_volcano.r}{%
\section{File: ttest\_volcano.R}\label{file-ttest_volcano.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(outliers)}
\NormalTok{grubbs}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x}\OtherTok{\textless{}{-}}\FunctionTok{round}\NormalTok{(x,}\DecValTok{4}\NormalTok{)}
\NormalTok{  grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{  grubbs\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
  \ControlFlowTok{while}\NormalTok{(grubbs\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{    grubbs\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_outliers,grubbs\_minormax)}
\NormalTok{    grubbs\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_p.value,grubbs\_pvalue)}
\NormalTok{    grubbs\_g}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(grubbs\_g,grubbs\_g.value)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{grubbs\_minormax)]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{    grubbs\_test}\OtherTok{\textless{}{-}}\FunctionTok{grubbs.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{10}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{    grubbs\_p}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{    grubbs\_g.value}\OtherTok{\textless{}{-}}\NormalTok{grubbs\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{    grubbs\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(grubbs\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{    grubbs\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(grubbs\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{  outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{grubbs\_outliers,}\AttributeTok{gvalue=}\NormalTok{grubbs\_g,}\AttributeTok{pvalue=}\NormalTok{grubbs\_p.value)}
  \FunctionTok{return}\NormalTok{(outliner\_res)}
\NormalTok{\}}
\NormalTok{dixon}\OtherTok{\textless{}{-}}\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_pvalue}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{()}
\NormalTok{    dixon\_p}\OtherTok{\textless{}{-}}\DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(dixon\_p}\SpecialCharTok{\textless{}}\FloatTok{0.05}\NormalTok{)\{}
\NormalTok{      dixon\_outliers}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_outliers,dixon\_minormax)}
\NormalTok{      dixon\_p.value}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_p.value,dixon\_pvalue)}
\NormalTok{      dixon\_q}\OtherTok{\textless{}{-}}\FunctionTok{c}\NormalTok{(dixon\_q,dixon\_q.value)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sum}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)}\SpecialCharTok{!=}\DecValTok{0}\NormalTok{)x}\OtherTok{\textless{}{-}}\NormalTok{x[}\SpecialCharTok{{-}}\FunctionTok{which}\NormalTok{(x}\SpecialCharTok{==}\NormalTok{dixon\_minormax)]}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{sd}\NormalTok{(x)}\SpecialCharTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{break}
\NormalTok{      dixon\_test}\OtherTok{\textless{}{-}}\FunctionTok{dixon.test}\NormalTok{(x,}\AttributeTok{type=}\DecValTok{0}\NormalTok{,}\AttributeTok{opposite=}\NormalTok{F,}\AttributeTok{two.sided=}\NormalTok{F)}
\NormalTok{      dixon\_p}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_pvalue}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{p.value}
\NormalTok{      dixon\_q.value}\OtherTok{\textless{}{-}}\NormalTok{dixon\_test}\SpecialCharTok{$}\NormalTok{statistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{      dixon\_a}\OtherTok{\textless{}{-}}\FunctionTok{strsplit}\NormalTok{(dixon\_test}\SpecialCharTok{$}\NormalTok{alternative,}\StringTok{" "}\NormalTok{,}\AttributeTok{fixed=}\NormalTok{T)}
\NormalTok{      dixon\_minormax}\OtherTok{\textless{}{-}}\FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(dixon\_a)[}\DecValTok{3}\NormalTok{])}
\NormalTok{    \}}
\NormalTok{    outliner\_res}\OtherTok{\textless{}{-}}\FunctionTok{data.frame}\NormalTok{(}\AttributeTok{outliers=}\NormalTok{dixon\_outliers,}\AttributeTok{qvalue=}\NormalTok{dixon\_q,}\AttributeTok{pvalue=}\NormalTok{dixon\_p.value)}
    \FunctionTok{return}\NormalTok{(outliner\_res)}
\NormalTok{  \}}
\NormalTok{savepath}\OtherTok{=}\StringTok{"volcano\_ttest"}
\ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(savepath)}\SpecialCharTok{==}\ConstantTok{FALSE}\NormalTok{)\{}\FunctionTok{dir.create}\NormalTok{(savepath)\}}
\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"fecal\_pos\_volcano.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}
\NormalTok{group }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup)}
\NormalTok{id\_set}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(data)}
\NormalTok{list}\OtherTok{=}\FunctionTok{rbind}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"raw"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"raw"}\NormalTok{,}\StringTok{"pro"}\NormalTok{),}\FunctionTok{c}\NormalTok{(}\StringTok{"model"}\NormalTok{,}\StringTok{"control"}\NormalTok{))}
\NormalTok{the\_filter}\OtherTok{=}\DecValTok{0}
\ControlFlowTok{for}\NormalTok{(row }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(list))\{}
\NormalTok{double}\OtherTok{=}\NormalTok{list[row,]}
\NormalTok{escape}\OtherTok{=}\DecValTok{0}
    \ControlFlowTok{for}\NormalTok{(k }\ControlFlowTok{in} \FunctionTok{c}\NormalTok{(}\StringTok{"low"}\NormalTok{,}\StringTok{"medium"}\NormalTok{,}\StringTok{"high"}\NormalTok{))\{}
    \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare2}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{1}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare2}\OtherTok{=}\NormalTok{double[}\DecValTok{1}\NormalTok{]\}}
    \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{!=}\StringTok{"model"}\NormalTok{)\{compare1}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(double[}\DecValTok{2}\NormalTok{],}\StringTok{"\_"}\NormalTok{,k)\}}\ControlFlowTok{else}\NormalTok{\{compare1}\OtherTok{=}\NormalTok{double[}\DecValTok{2}\NormalTok{]\}}
    \ControlFlowTok{if}\NormalTok{(double[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{==}\StringTok{"model"} \SpecialCharTok{\&}\NormalTok{ double[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{==}\StringTok{"control"}\NormalTok{)\{compare2}\OtherTok{=}\StringTok{"model"}\NormalTok{; compare1}\OtherTok{=}\StringTok{"control"}\NormalTok{; escape}\OtherTok{=}\DecValTok{1}\NormalTok{\}}
    \FunctionTok{sink}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(savepath,}\StringTok{"/"}\NormalTok{,compare2,}\StringTok{"@"}\NormalTok{,compare1),}\AttributeTok{append =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{split =} \ConstantTok{FALSE}\NormalTok{)}
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"|id|p{-}value|number|fold:"}\NormalTok{,compare2,}\StringTok{"/"}\NormalTok{,compare1,}\StringTok{"|"}\NormalTok{))}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data))\{}
\NormalTok{    X}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare1),i]}
\NormalTok{    n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{dixon}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{3}\NormalTok{)))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{grubbs}\NormalTok{(}\FunctionTok{round}\NormalTok{(X,}\DecValTok{3}\NormalTok{)))\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{out}\OtherTok{=}\ConstantTok{NULL}\NormalTok{\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))\{x\_filter}\OtherTok{=}\NormalTok{X\}}\ControlFlowTok{else}\NormalTok{\{x\_filter}\OtherTok{=}\NormalTok{X[}\FunctionTok{which}\NormalTok{(X}\SpecialCharTok{!=}\FunctionTok{c}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))];the\_filter}\OtherTok{=}\NormalTok{the\_filter}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{      num\_x}\OtherTok{=}\FunctionTok{length}\NormalTok{(x\_filter)}
\NormalTok{    Y}\OtherTok{=}\NormalTok{data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{subgroup}\SpecialCharTok{==}\NormalTok{compare2),i]}
\NormalTok{    n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{dixon}\NormalTok{(}\FunctionTok{round}\NormalTok{(Y,}\DecValTok{3}\NormalTok{)))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{n}\OtherTok{=}\FunctionTok{try}\NormalTok{(out}\OtherTok{\textless{}{-}}\FunctionTok{grubbs}\NormalTok{(}\FunctionTok{round}\NormalTok{(Y,}\DecValTok{3}\NormalTok{)))\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(n)}\SpecialCharTok{==}\StringTok{"try{-}error"}\NormalTok{)\{out}\OtherTok{=}\ConstantTok{NULL}\NormalTok{\}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))\{y\_filter}\OtherTok{=}\NormalTok{Y\}}\ControlFlowTok{else}\NormalTok{\{y\_filter}\OtherTok{=}\NormalTok{Y[}\FunctionTok{which}\NormalTok{(Y}\SpecialCharTok{!=}\FunctionTok{c}\NormalTok{(out}\SpecialCharTok{$}\NormalTok{outliers))];the\_filter}\OtherTok{=}\NormalTok{the\_filter}\SpecialCharTok{+}\DecValTok{1}\NormalTok{\}}
\NormalTok{      num\_y}\OtherTok{=}\FunctionTok{length}\NormalTok{(y\_filter)}
\NormalTok{    stat}\OtherTok{=}\FunctionTok{t.test}\NormalTok{(X, Y, }\AttributeTok{var.equal =}\NormalTok{ T, }\AttributeTok{paired =}\NormalTok{ F)}
\NormalTok{    fold}\OtherTok{=}\FunctionTok{mean}\NormalTok{(y\_filter)}\SpecialCharTok{/}\FunctionTok{mean}\NormalTok{(x\_filter)}
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"|"}\NormalTok{,id\_set[i],}\StringTok{"|"}\NormalTok{,stat}\SpecialCharTok{$}\NormalTok{p.value,}\StringTok{"|"}\NormalTok{,num\_x,}\StringTok{"\_"}\NormalTok{,num\_y,}\StringTok{"|"}\NormalTok{,fold,}\StringTok{"|"}\NormalTok{))\}}
    \FunctionTok{sink}\NormalTok{()}
    \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"fold change: "}\NormalTok{,compare2,}\StringTok{" divided by "}\NormalTok{,compare1))}
    \ControlFlowTok{if}\NormalTok{(escape}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}\ControlFlowTok{break}\NormalTok{\}}
\NormalTok{    \}}
\NormalTok{\}}
\FunctionTok{print}\NormalTok{(the\_filter)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-violin.r}{%
\section{File: violin.R}\label{file-violin.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(ggplot2)}
 \FunctionTok{library}\NormalTok{(ggrepel)}
 \FunctionTok{library}\NormalTok{(ggsci)}
 \FunctionTok{library}\NormalTok{(tidyr)}
 \FunctionTok{library}\NormalTok{(ggforce)}
 \FunctionTok{library}\NormalTok{(reshape2)}
 \FunctionTok{library}\NormalTok{(ggthemes)}
 \FunctionTok{library}\NormalTok{(stringr)}
\NormalTok{ file}\OtherTok{=}\StringTok{"for\_violin\_0.5.tsv"}
\NormalTok{ dfpath}\OtherTok{=}\StringTok{"fingerid\_first\_score.tsv"}
\NormalTok{ df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{dfpath, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ df }\OtherTok{\textless{}{-}}\NormalTok{ df[,}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\StringTok{"similarity"}\NormalTok{)]}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
 \FunctionTok{colnames}\NormalTok{(data)[}\DecValTok{3}\SpecialCharTok{:}\DecValTok{4}\NormalTok{]}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"Raw{-}Eucommia"}\NormalTok{, }\StringTok{"Pro{-}Eucommia"}\NormalTok{)}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{melt}\NormalTok{(data, }\AttributeTok{id.vars=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"classification"}\NormalTok{), }\AttributeTok{variable.name=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value.name=}\StringTok{"expr"}\NormalTok{)}
\NormalTok{ data}\SpecialCharTok{$}\NormalTok{expr[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{expr}\SpecialCharTok{=={-}}\ConstantTok{Inf}\NormalTok{)] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{ data }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(data, df, }\AttributeTok{all.x=}\NormalTok{T, }\AttributeTok{by=}\StringTok{"id"}\NormalTok{, }\AttributeTok{sort=}\NormalTok{F)}
\NormalTok{ data }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{similarity}\SpecialCharTok{\textgreater{}}\FloatTok{0.5}\NormalTok{), ]}
\NormalTok{ p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{classification, }\AttributeTok{y=}\NormalTok{expr, }\AttributeTok{fill=}\FunctionTok{ifelse}\NormalTok{(condition}\SpecialCharTok{==}\StringTok{"Raw{-}Eucommia"}\NormalTok{, }\StringTok{"1"}\NormalTok{, }\StringTok{"2"}\NormalTok{))) }\SpecialCharTok{+}
    \FunctionTok{geom\_violin}\NormalTok{(}\AttributeTok{trim=}\NormalTok{F,}\AttributeTok{color=}\StringTok{"transparent"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{geom\_boxplot}\NormalTok{(}\AttributeTok{width=}\FloatTok{0.2}\NormalTok{,}\AttributeTok{position=}\FunctionTok{position\_dodge}\NormalTok{(}\FloatTok{0.9}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\StringTok{"\#E64B35FF"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{scale\_x\_discrete}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{rev}\NormalTok{(}\FunctionTok{levels}\NormalTok{(}\FunctionTok{as.factor}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{classification)))) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Classification"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Log10(peak area)(Tanimoto similarity \textgreater{} 0.5; Posterior probability \textgreater{} 0.5)"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{), }
        \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
        \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust=}\FloatTok{1.7}\NormalTok{),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{0}\NormalTok{),}
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{12}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{condition, }\AttributeTok{ncol=}\DecValTok{2}\NormalTok{)}
  \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"violin.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{, }\AttributeTok{height=}\DecValTok{18}\NormalTok{)}
  \CommentTok{\#ggsave(p, file="violin.svg", width=10, height=15)}
  \DocumentationTok{\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#\#  geom\_density}
\NormalTok{  list}\OtherTok{=}\FunctionTok{grep}\NormalTok{(}\StringTok{"lignan|Iridoid"}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{classification, }\AttributeTok{ignore.case=}\NormalTok{T)}
\NormalTok{  df }\OtherTok{\textless{}{-}}\NormalTok{ data[list,]}
\NormalTok{  df}\SpecialCharTok{$}\NormalTok{classification }\OtherTok{\textless{}{-}} \FunctionTok{str\_wrap}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{classification, }\AttributeTok{width=}\DecValTok{25}\NormalTok{)}
\NormalTok{  pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{geom\_density}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{expr, }\AttributeTok{fill=}\NormalTok{condition), }\AttributeTok{alpha=}\FloatTok{0.3}\NormalTok{) }\SpecialCharTok{+} 
    \FunctionTok{facet\_grid}\NormalTok{(classification}\SpecialCharTok{\textasciitilde{}}\NormalTok{., }
           \AttributeTok{scales=}\StringTok{"free"}
\NormalTok{    ) }\SpecialCharTok{+}
    \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#4DBBD5FF"}\NormalTok{, }\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
    \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Log10(peak area)"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Density"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{ncol=}\DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{), }
        \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{0}\NormalTok{),}
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{),}
        \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{15}\NormalTok{), }
        \AttributeTok{legend.title =} \FunctionTok{element\_blank}\NormalTok{(), }
        \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
        \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{12}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{), }
        \AttributeTok{strip.background=}\FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{color=}\StringTok{"white"}\NormalTok{)}
\NormalTok{        ) }
  \FunctionTok{ggsave}\NormalTok{(pp, }\AttributeTok{file=}\StringTok{"density\_free.svg"}\NormalTok{, }\AttributeTok{width=}\DecValTok{8}\NormalTok{, }\AttributeTok{height=}\DecValTok{14}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-vip_p_facet.r}{%
\section{File: vip\_p\_facet.R}\label{file-vip_p_facet.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsci)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"vip\_p\_facet.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\ConstantTok{FALSE}\NormalTok{)}

\FunctionTok{colnames}\NormalTok{(df)[}\DecValTok{3}\NormalTok{]}\OtherTok{=}\StringTok{"p"}

\NormalTok{anno}\OtherTok{=}\FunctionTok{unique}\NormalTok{(df[,}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"group"}\NormalTok{,}\StringTok{"g1\_from"}\NormalTok{,}\StringTok{"g2\_deep"}\NormalTok{)])}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p, }\AttributeTok{y=}\NormalTok{vip, }\AttributeTok{color=}\NormalTok{FC)) }\SpecialCharTok{+}

    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{xlim}\NormalTok{(}\DecValTok{0}\NormalTok{,}\FloatTok{0.5}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\SpecialCharTok{+}\DecValTok{5}\NormalTok{), }
                       \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{+}\DecValTok{3}\NormalTok{), }
                       \AttributeTok{colours =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#E6550DFF"}\NormalTok{, }\StringTok{"\#79AF97FF"}\NormalTok{, }\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"VIP"}\NormalTok{, }\AttributeTok{x=}\StringTok{"p{-}value"}\NormalTok{, }\AttributeTok{color=}\StringTok{"FC"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{1}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FloatTok{0.05}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
    
    \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data=}\NormalTok{anno, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{p)}\SpecialCharTok{/}\DecValTok{4}\NormalTok{, }\AttributeTok{y=}\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{vip), }\AttributeTok{label=}\NormalTok{group), }
            \AttributeTok{hjust=}\FloatTok{0.5}\NormalTok{, }\AttributeTok{color=}\StringTok{"black"}\NormalTok{, }\AttributeTok{fontface=}\StringTok{"bold"}\NormalTok{,}\AttributeTok{alpha=}\FloatTok{0.6}\NormalTok{, }\AttributeTok{size=}\DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+} 
    
    \FunctionTok{ggtitle}\NormalTok{(}\StringTok{"VIP{-}P"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{facet\_grid}\NormalTok{(g2\_deep }\SpecialCharTok{\textasciitilde{}}\NormalTok{ g1\_from) }\SpecialCharTok{+}
    
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\StringTok{"vip\_p\_facet.svg"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-vip_p.r}{%
\section{File: vip\_p.R}\label{file-vip_p.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggsci)}

\NormalTok{args}\OtherTok{\textless{}{-}}\FunctionTok{commandArgs}\NormalTok{(}\ConstantTok{TRUE}\NormalTok{)}

\FunctionTok{setwd}\NormalTok{(args[}\DecValTok{1}\NormalTok{])}

\NormalTok{datas}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.vip\_p$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(datas))\{}

\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(datas[i],}\AttributeTok{split=}\StringTok{".vip\_p"}\NormalTok{)}

\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{datas[i],}\AttributeTok{header=}\NormalTok{ T,}\AttributeTok{sep=} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\ConstantTok{FALSE}\NormalTok{)}

\NormalTok{truenames}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(df)}

\NormalTok{set}\OtherTok{=}\FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(truenames[}\DecValTok{4}\NormalTok{],}\AttributeTok{split=}\StringTok{": "}\NormalTok{))}

\NormalTok{legend}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"VIP{-}P{-}FC: "}\NormalTok{,set[}\DecValTok{2}\NormalTok{])}

\FunctionTok{colnames}\NormalTok{(df)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"vip"}\NormalTok{,}\StringTok{"p"}\NormalTok{,}\StringTok{"fold"}\NormalTok{)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{p, }\AttributeTok{y=}\NormalTok{vip, }\AttributeTok{color=}\NormalTok{fold)) }\SpecialCharTok{+}

    \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{scale\_color\_gradientn}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\SpecialCharTok{+}\DecValTok{5}\NormalTok{), }
                       \AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{0}\NormalTok{, }\SpecialCharTok{+}\DecValTok{3}\NormalTok{),}
                       \AttributeTok{colours =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#E6550DFF"}\NormalTok{, }\StringTok{"\#79AF97FF"}\NormalTok{, }\StringTok{"\#3182BDFF"}\NormalTok{)) }\SpecialCharTok{+}
    \CommentTok{\#scale\_color\_npg() +}
    \CommentTok{\#scale\_fill\_npg() +}
    
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{y=}\StringTok{"VIP"}\NormalTok{, }\AttributeTok{x=}\StringTok{"p{-}value"}\NormalTok{, }\AttributeTok{color=}\StringTok{"FC"}\NormalTok{) }\SpecialCharTok{+}
    
    \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \DecValTok{1}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
    \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FloatTok{0.05}\NormalTok{,}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
    
    \FunctionTok{ggtitle}\NormalTok{(legend) }\SpecialCharTok{+}
    
    \CommentTok{\#xlim(0,0.5) +}
    
    \CommentTok{\#scale\_x\_continuous(limits=c({-}60 ,60)) +}
    
    \CommentTok{\#scale\_y\_continuous(limits=c({-}60 ,60)) +}
    
    \CommentTok{\#facet\_grid(g2\_deep \textasciitilde{} g1\_from) +}
    
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"right"}\NormalTok{,}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{), }\AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}

\FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{"\_vip\_p.svg"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-volcano_facet.r}{%
\section{File: volcano\_facet.R}\label{file-volcano_facet.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggrepel)}

\FunctionTok{setwd}\NormalTok{(}\StringTok{"volcano"}\NormalTok{)}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"volcano\_facet"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}

\CommentTok{\#data \textless{}{-} na.omit(data)}

\NormalTok{savename}\OtherTok{=}\StringTok{"volcano\_facet"}

\NormalTok{title}\OtherTok{=}\StringTok{"Volcano grid"}

\NormalTok{data}\SpecialCharTok{$}\NormalTok{change }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value }\SpecialCharTok{\textless{}} \FloatTok{0.05} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}
                      \FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{),}\StringTok{"stable"}\NormalTok{),}
                      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{,}\StringTok{"stable"}\NormalTok{))}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fold, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+} 

  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\FloatTok{1.5}\NormalTok{) }\SpecialCharTok{+} 
  
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}\StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}\StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
  
  \CommentTok{\#xlim({-}10,10) + }
  
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
   
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
  
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(foldchange)"}\NormalTok{,}\AttributeTok{y=}\StringTok{"{-}log10(p{-}value)"}\NormalTok{,}\AttributeTok{title=}\NormalTok{title) }\SpecialCharTok{+} 
  
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
                  \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ id),}\AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
                  
  \CommentTok{\#annotate("text", x = {-}10, y = max({-}log10(data$p.value))*0.8, label = paste0("Based on ",nrow(data)," features"),}
  \CommentTok{\#          color="black",size = 3, fontface="bold", family="Times", hjust = 0 ) +}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
    
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}

    \CommentTok{\#plot.margin = unit(c(3, 1, 3, 1), "cm")}
    
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{)) }\SpecialCharTok{+}
    
  \FunctionTok{facet\_grid}\NormalTok{(g2\_deep }\SpecialCharTok{\textasciitilde{}}\NormalTok{ g1\_from)}
    
 \CommentTok{\#svg(paste0(savename,".svg"),width=8,height=6.5)}
 \CommentTok{\#p}
 \CommentTok{\#dev.off()}
 
 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-volcano.r}{%
\section{File: volcano.R}\label{file-volcano.r}}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggrepel)}

\FunctionTok{setwd}\NormalTok{(}\StringTok{"volcano"}\NormalTok{)}

\NormalTok{files}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.tsv$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
           
\ControlFlowTok{for}\NormalTok{(file }\ControlFlowTok{in}\NormalTok{ files)\{}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{check.names=}\NormalTok{F)}

\CommentTok{\#data \textless{}{-} na.omit(data)}

\NormalTok{savename}\OtherTok{=}\FunctionTok{strsplit}\NormalTok{(file, }\AttributeTok{split=}\StringTok{".tsv"}\NormalTok{)}

\NormalTok{set}\OtherTok{=}\FunctionTok{colnames}\NormalTok{(data)}

\NormalTok{title}\OtherTok{=}\NormalTok{set[}\DecValTok{3}\NormalTok{]}

\FunctionTok{colnames}\NormalTok{(data)}\OtherTok{=}\FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{,}\StringTok{"p.value"}\NormalTok{,}\StringTok{"fold"}\NormalTok{)}

\NormalTok{data}\SpecialCharTok{$}\NormalTok{change }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(}\FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value }\SpecialCharTok{\textless{}} \FloatTok{0.05} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}
                      \FunctionTok{ifelse}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{,}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{),}\StringTok{"stable"}\NormalTok{),}
                      \AttributeTok{levels =} \FunctionTok{c}\NormalTok{(}\StringTok{"up"}\NormalTok{,}\StringTok{"down"}\NormalTok{,}\StringTok{"stable"}\NormalTok{))}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{fold, }\AttributeTok{y=}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(p.value),}\AttributeTok{color =}\NormalTok{ change)) }\SpecialCharTok{+} 

  \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{alpha=}\FloatTok{0.8}\NormalTok{, }\AttributeTok{stroke=}\DecValTok{0}\NormalTok{, }\AttributeTok{size=}\DecValTok{3}\NormalTok{) }\SpecialCharTok{+} 
  
  \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"down"}\OtherTok{=}\StringTok{"\#4DBBD5FF"}\NormalTok{,}\StringTok{"stable"}\OtherTok{=}\StringTok{"\#8491B4FF"}\NormalTok{,}\StringTok{"up"}\OtherTok{=}\StringTok{"\#DC0000FF"}\NormalTok{)) }\SpecialCharTok{+}
  
  \CommentTok{\#xlim({-}10,10) + }
  
  \FunctionTok{ylim}\NormalTok{(}\DecValTok{1}\NormalTok{,}\FunctionTok{max}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{p.value))) }\SpecialCharTok{+}
   
  \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \SpecialCharTok{{-}}\FunctionTok{log10}\NormalTok{(}\FloatTok{0.05}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
  
  \FunctionTok{geom\_vline}\NormalTok{(}\AttributeTok{xintercept =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{linetype=}\DecValTok{4}\NormalTok{,}\AttributeTok{size=}\FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+} 
  
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"log2(foldchange)"}\NormalTok{,}\AttributeTok{y=}\StringTok{"{-}log10(p{-}value)"}\NormalTok{,}\AttributeTok{title=}\NormalTok{title) }\SpecialCharTok{+} 
  
  \FunctionTok{geom\_text\_repel}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{p.value}\SpecialCharTok{\textless{}}\FloatTok{0.01} \SpecialCharTok{\&} \FunctionTok{abs}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fold) }\SpecialCharTok{\textgreater{}=} \DecValTok{2}\NormalTok{,],}
                  \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ id),}\AttributeTok{size =} \DecValTok{3}\NormalTok{,}\AttributeTok{family=}\StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
                  
  \CommentTok{\#annotate("text", x = {-}10, y = max({-}log10(data$p.value))*0.8, label = paste0("Based on ",nrow(data)," features"),}
  \CommentTok{\#          color="black",size = 3, fontface="bold", family="Times", hjust = 0 ) +}
  
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{),}
    
    \CommentTok{\#axis.line = element\_line(colour = "black", size=0.2),}

    \CommentTok{\#plot.margin = unit(c(3, 1, 3, 1), "cm")}
    
    \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.5}\NormalTok{))}
    
 \CommentTok{\#svg(paste0(savename,".svg"),width=8,height=6.5)}
 \CommentTok{\#p}
 \CommentTok{\#dev.off()}
 
 \FunctionTok{ggsave}\NormalTok{(p,}\AttributeTok{file=}\FunctionTok{paste0}\NormalTok{(savename,}\StringTok{".svg"}\NormalTok{),}\AttributeTok{width=}\DecValTok{8}\NormalTok{,}\AttributeTok{height=}\FloatTok{6.5}\NormalTok{)\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-xcms.r}{%
\section{File: xcms.R}\label{file-xcms.r}}

\begin{Shaded}
\begin{Highlighting}[]
 \FunctionTok{library}\NormalTok{(xcms)}
 \FunctionTok{setwd}\NormalTok{(}\StringTok{"/media/wizard/back/nanjing\_sample/fecal/pos\_mzml"}\NormalTok{)}
\NormalTok{ metadata }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\StringTok{"EIC\_metadata.tsv"}\NormalTok{,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\NormalTok{ dda\_file}\OtherTok{=}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"*.mzML$"}\NormalTok{, }\AttributeTok{all.files =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{full.names =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{recursive =} \ConstantTok{FALSE}\NormalTok{,}
           \AttributeTok{ignore.case =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{include.dirs =} \ConstantTok{FALSE}\NormalTok{)}
 \FunctionTok{dir.create}\NormalTok{(}\StringTok{"EIC"}\NormalTok{)}
\NormalTok{ tolerance}\OtherTok{=}\FloatTok{0.005}
 \ControlFlowTok{for}\NormalTok{(filename }\ControlFlowTok{in}\NormalTok{ dda\_file)\{}
\NormalTok{ dda\_data }\OtherTok{\textless{}{-}} \FunctionTok{readMSData}\NormalTok{(filename, }\AttributeTok{mode =} \StringTok{"onDisk"}\NormalTok{)}
 \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"EIC/EIC\_"}\NormalTok{,filename))}
   \ControlFlowTok{for}\NormalTok{(number }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(metadata))\{}
\NormalTok{   id }\OtherTok{\textless{}{-}}\NormalTok{ metadata[number,}\FunctionTok{colnames}\NormalTok{(metadata) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"id"}\NormalTok{)]}
\NormalTok{   mz }\OtherTok{\textless{}{-}}\NormalTok{ metadata[number,}\FunctionTok{colnames}\NormalTok{(metadata) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"m.z"}\NormalTok{)]}
\NormalTok{   mzrange }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(mz)}\SpecialCharTok{{-}}\NormalTok{tolerance,}\FunctionTok{as.numeric}\NormalTok{(mz)}\SpecialCharTok{+}\NormalTok{tolerance)}
\NormalTok{   ex\_data }\OtherTok{\textless{}{-}} \FunctionTok{chromatogram}\NormalTok{(dda\_data, }\AttributeTok{msLevel =}\NormalTok{ 1L, }\AttributeTok{mz =}\NormalTok{ mzrange, }\AttributeTok{aggregationFun =} \StringTok{"max"}\NormalTok{)}
\NormalTok{   ex\_data\_1 }\OtherTok{\textless{}{-}}\NormalTok{ ex\_data[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{]}
   \ControlFlowTok{if}\NormalTok{(number}\SpecialCharTok{==}\DecValTok{1}\NormalTok{)\{}
    \FunctionTok{write.table}\NormalTok{(}\FunctionTok{rtime}\NormalTok{(ex\_data\_1),}\FunctionTok{paste0}\NormalTok{(}\StringTok{"EIC/EIC\_"}\NormalTok{,filename,}\StringTok{"/rt"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{col.names =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)\}}
   \FunctionTok{write.table}\NormalTok{(}\FunctionTok{intensity}\NormalTok{(ex\_data\_1),}\FunctionTok{paste0}\NormalTok{(}\StringTok{"EIC/EIC\_"}\NormalTok{,filename,}\StringTok{"/"}\NormalTok{,id,}\StringTok{"\_intensity"}\NormalTok{,}\StringTok{".tsv"}\NormalTok{),}\AttributeTok{col.names =} \ConstantTok{FALSE}\NormalTok{,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
   \FunctionTok{print}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(filename,}\StringTok{" \textgreater{}\textgreater{}\textgreater{} "}\NormalTok{,number,}\StringTok{"/"}\NormalTok{,}\FunctionTok{nrow}\NormalTok{(metadata)))\}\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-zhu_heatmap.r}{%
\section{File: zhu\_heatmap.R}\label{file-zhu_heatmap.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\#\#  ggplot2\_heatmap.R}

\FunctionTok{library}\NormalTok{(ggplot2)}
\FunctionTok{library}\NormalTok{(ggtree)}
\FunctionTok{library}\NormalTok{(aplot)}
\FunctionTok{library}\NormalTok{(tidyr)}
\FunctionTok{library}\NormalTok{(rayshader)}
\FunctionTok{library}\NormalTok{(ggsci)}
\FunctionTok{library}\NormalTok{(stringr)}

\NormalTok{file}\OtherTok{=}\StringTok{"heatmap\_1.tsv"}

\NormalTok{savename}\OtherTok{=}\StringTok{"zhu\_heatmap.svg"}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}\AttributeTok{row.names=}\DecValTok{1}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}

\FunctionTok{colnames}\NormalTok{(data) }\OtherTok{\textless{}{-}} \FunctionTok{str\_wrap}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), }\AttributeTok{width=}\DecValTok{30}\NormalTok{)}

\NormalTok{phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(data)) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{)}

\NormalTok{phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(data))) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{ggtree}\NormalTok{(}\AttributeTok{layout=}\StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length=}\StringTok{"none"}\NormalTok{) }\SpecialCharTok{+} \FunctionTok{layout\_dendrogram}\NormalTok{()}

\NormalTok{data}\SpecialCharTok{$}\NormalTok{names }\OtherTok{\textless{}{-}} \FunctionTok{rownames}\NormalTok{(data)}

\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{gather}\NormalTok{(data, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(data)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{), }\AttributeTok{key=}\StringTok{"condition"}\NormalTok{, }\AttributeTok{value=}\StringTok{\textquotesingle{}expr\textquotesingle{}}\NormalTok{)  }\DocumentationTok{\#\# keep the last col}

\NormalTok{pp }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(p1,}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\NormalTok{condition,}\AttributeTok{y=}\NormalTok{names,}\AttributeTok{fill=}\NormalTok{expr)) }\SpecialCharTok{+} 
  \FunctionTok{geom\_tile}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\#theme\_minimal()+}
  \FunctionTok{scale\_fill\_gradient2}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\#scale\_fill\_npg() +}
  \FunctionTok{scale\_y\_discrete}\NormalTok{(}\AttributeTok{position=}\StringTok{"right"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Compounds"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Sample"}\NormalTok{, }\AttributeTok{fill=}\StringTok{"Log10(Peak area)"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle=}\DecValTok{90}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{1}\NormalTok{),}
    \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
    \AttributeTok{axis.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#axis.text = element\_blank(),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
    \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{4}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)}
    \CommentTok{\#axis.title.y = element\_text(size = 14),}
    \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{    )}

\NormalTok{pp\_com }\OtherTok{\textless{}{-}}\NormalTok{ pp }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{insert\_left}\NormalTok{(phr, }\AttributeTok{width=}\NormalTok{.}\DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{insert\_top}\NormalTok{(phc, }\AttributeTok{height=}\NormalTok{.}\DecValTok{1}\NormalTok{) }

\FunctionTok{ggsave}\NormalTok{(pp\_com,}\AttributeTok{file=}\NormalTok{savename, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{20}\NormalTok{)}

\CommentTok{\#plot\_gg(pp\_com, multicore = TRUE, width = 20 ,height=20, scale=250) \#加载图形}
\CommentTok{\#render\_depth(focallength=100,focus=0.72)}

\FunctionTok{library}\NormalTok{(ggupset)}

\NormalTok{file}\OtherTok{=}\StringTok{"instance\_norm\_random.tsv"}

\NormalTok{data }\OtherTok{\textless{}{-}} \FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file=}\NormalTok{file,}\AttributeTok{header=}\NormalTok{T,}\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{check.name=}\NormalTok{F)}

\NormalTok{data}\SpecialCharTok{$}\NormalTok{upset\_x}\OtherTok{=}\FunctionTok{paste0}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{names, }\StringTok{"\_"}\NormalTok{, data}\SpecialCharTok{$}\NormalTok{condition)}

\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x=}\FunctionTok{factor}\NormalTok{(upset\_x), }\AttributeTok{y=}\NormalTok{expr)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \CommentTok{\#scale\_x\_mergelist(sep = "\_") +}
  \FunctionTok{axis\_combmatrix}\NormalTok{(}\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{) }\SpecialCharTok{+}
  \CommentTok{\#coord\_flip() +}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x=}\StringTok{"Feature link"}\NormalTok{, }\AttributeTok{y=}\StringTok{"Normalized ftalign similarity"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}
    \CommentTok{\#axis.text.x = element\_text(angle=90),}
    \AttributeTok{axis.text.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{angle=}\DecValTok{90}\NormalTok{),}
    \AttributeTok{axis.title.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{30}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{angle=}\DecValTok{180}\NormalTok{),}
    \AttributeTok{axis.title.y =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{30}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \CommentTok{\#axis.text = element\_blank(),}
    \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{),}
    \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size=}\DecValTok{20}\NormalTok{),}
    \CommentTok{\#legend.key.width = unit(2, "cm"),}
        \CommentTok{\#legend.key.height = unit(4, "cm"),}
        \AttributeTok{text=}\FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{)}
    \CommentTok{\#axis.title.y = element\_text(size = 14),}
    \CommentTok{\#plot.title = element\_text(hjust = 1,vjust={-}40,size=14)}
\NormalTok{    ) }\SpecialCharTok{+}
  \FunctionTok{theme\_combmatrix}\NormalTok{(}\AttributeTok{combmatrix.panel.point.size =} \DecValTok{5}\NormalTok{, }
           \CommentTok{\#combmatrix.panel.margin = unit(c(0.5,0.5),"pt"),}
           \AttributeTok{combmatrix.panel.line.size =} \DecValTok{2}\NormalTok{,}
           \AttributeTok{combmatrix.label.height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{500}\NormalTok{, }\StringTok{"pt"}\NormalTok{), }
           \AttributeTok{combmatrix.label.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family=}\StringTok{"serif"}\NormalTok{, }\AttributeTok{angle=}\DecValTok{145}\NormalTok{, }\AttributeTok{size=}\DecValTok{12}\NormalTok{, }\AttributeTok{face=}\StringTok{"bold"}\NormalTok{, }\AttributeTok{hjust=}\DecValTok{0}\NormalTok{, }\AttributeTok{vjust=}\SpecialCharTok{{-}}\FloatTok{0.2}\NormalTok{),}
           \AttributeTok{combmatrix.label.make\_space =}\NormalTok{ F)}

\FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file=}\StringTok{"test1.pdf"}\NormalTok{, }\AttributeTok{width=}\DecValTok{20}\NormalTok{, }\AttributeTok{height=}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}


\end{document}
