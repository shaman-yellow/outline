% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{caption} \captionsetup{font={footnotesize},width=6in} \renewcommand{\dblfloatpagefraction}{.9} \makeatletter \renewenvironment{figure} {\def\@captype{figure}} \makeatletter \definecolor{shadecolor}{RGB}{242,242,242} \usepackage{xeCJK} \usepackage{setspace} \setstretch{1.3}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={R codes of utils.tool},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{R codes of utils.tool}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{3}
\tableofcontents
}
\hypertarget{file-aaa.r}{%
\section{File: aaa.R}\label{file-aaa.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# utilites}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases utilites}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title utilites for programming}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description This is a combination of tools that are not always used.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name utilites}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\NormalTok{reCallMethod }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(funName, args, ...)\{}
\NormalTok{    arg.order }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{(}\FunctionTok{getGeneric}\NormalTok{(funName)}\SpecialCharTok{@}\NormalTok{signature)}
\NormalTok{    args.missing }\OtherTok{\textless{}{-}} \SpecialCharTok{!}\NormalTok{arg.order }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(args)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(args.missing)) \{}
\NormalTok{      args.missing }\OtherTok{\textless{}{-}}\NormalTok{ arg.order[args.missing]}
\NormalTok{      args.missing }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(args.missing, }\AttributeTok{simplify =}\NormalTok{ F,}
                             \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{structure}\NormalTok{(0L, }\AttributeTok{class =} \StringTok{"missing"}\NormalTok{))}
\NormalTok{      args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(args, args.missing)}
\NormalTok{    \}}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(arg.order, }\ControlFlowTok{function}\NormalTok{(i) args[[i]])}
\NormalTok{    sig }\OtherTok{\textless{}{-}} \FunctionTok{get\_signature}\NormalTok{(args)}
\NormalTok{    method }\OtherTok{\textless{}{-}} \FunctionTok{selectMethod}\NormalTok{(funName, sig)}
\NormalTok{    last\_fun }\OtherTok{\textless{}{-}} \FunctionTok{sys.function}\NormalTok{(}\FunctionTok{sys.parent}\NormalTok{())}
\NormalTok{    n }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{ (}\FunctionTok{identical}\NormalTok{(last\_fun, method}\SpecialCharTok{@}\NormalTok{.Data, }\AttributeTok{ignore.environment =}\NormalTok{ T)) \{}
      \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
\NormalTok{        mlist }\OtherTok{\textless{}{-}} \FunctionTok{getMethodsForDispatch}\NormalTok{(}\FunctionTok{getGeneric}\NormalTok{(funName))}
\NormalTok{      \}}
\NormalTok{      n }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{+} \DecValTok{1}
      \FunctionTok{rm}\NormalTok{(}\AttributeTok{list =} \FunctionTok{paste0}\NormalTok{(method}\SpecialCharTok{@}\NormalTok{defined, }\AttributeTok{collapse =} \StringTok{"\#"}\NormalTok{), }\AttributeTok{envir =}\NormalTok{ mlist)}
\NormalTok{      method }\OtherTok{\textless{}{-}} \FunctionTok{selectMethod}\NormalTok{(funName, sig, }\AttributeTok{mlist =}\NormalTok{ mlist)}
\NormalTok{    \}}
\NormalTok{    expr }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"method@.Data("}\NormalTok{,}
                   \FunctionTok{paste0}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(arg.order, }\StringTok{" = args[["}\NormalTok{,}
                                 \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(arg.order), }\StringTok{"]]"}\NormalTok{),}
                          \AttributeTok{collapse =} \StringTok{", "}\NormalTok{),}
                   \StringTok{", ...)"}\NormalTok{)}
    \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ expr))}
\NormalTok{  \}}

\NormalTok{setMissing }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(generic, ..., }\AttributeTok{.SIG =} \StringTok{"missing"}\NormalTok{)\{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{    sig }\OtherTok{\textless{}{-}} \FunctionTok{getGeneric}\NormalTok{(generic)}\SpecialCharTok{@}\NormalTok{signature}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(sig, }\AttributeTok{FUN.VALUE =} \StringTok{"character"}\NormalTok{,}
                  \ControlFlowTok{function}\NormalTok{(name)\{}
                    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(args[[ name ]]))}
\NormalTok{                      .SIG}
                    \ControlFlowTok{else}
\NormalTok{                      args[[ name ]]}
\NormalTok{                  \})}
    \FunctionTok{names}\NormalTok{(res) }\OtherTok{\textless{}{-}}\NormalTok{ sig}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}

\NormalTok{.fresh\_param }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(default, args)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{missing}\NormalTok{(args))}
\NormalTok{      args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{parent.frame}\NormalTok{())}
\NormalTok{    args }\OtherTok{\textless{}{-}}\NormalTok{ args[ }\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(args, is.name, T) ]}
    \FunctionTok{sapply}\NormalTok{(}\FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{names}\NormalTok{(default), }\FunctionTok{names}\NormalTok{(args))),}
           \AttributeTok{simplify =}\NormalTok{ F,}
           \ControlFlowTok{function}\NormalTok{(name)\{}
             \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(name }\SpecialCharTok{==} \FunctionTok{names}\NormalTok{(args)))}
\NormalTok{               args[[ name ]]}
             \ControlFlowTok{else}
\NormalTok{               default[[ name ]]}
\NormalTok{           \})}
\NormalTok{  \}}

\NormalTok{.fresh\_param2 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(default, args)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{missing}\NormalTok{(args))}
      \FunctionTok{return}\NormalTok{(default)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(args) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(default)}
    \FunctionTok{.fresh\_param}\NormalTok{(default, args)}
\NormalTok{  \}}

\NormalTok{.fresh\_param2f }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(default, args, }\AttributeTok{class =} \StringTok{"gpar"}\NormalTok{)\{}
    \FunctionTok{structure}\NormalTok{(}\FunctionTok{.fresh\_param2}\NormalTok{(default, args), }\AttributeTok{class =}\NormalTok{ class)}
\NormalTok{  \}}

\NormalTok{.check\_columns }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(obj, lst, tip)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.data.frame}\NormalTok{(obj))}
      \FunctionTok{stop}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\textquotesingle{}"}\NormalTok{, tip, }\StringTok{"\textquotesingle{} must be a \textquotesingle{}data.frame\textquotesingle{}."}\NormalTok{))}
    \FunctionTok{lapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(col)\{}
             \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(obj[[ col ]]))}
               \FunctionTok{stop}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\textquotesingle{}"}\NormalTok{, tip, }\StringTok{"\textquotesingle{} must contains a column of \textquotesingle{}"}\NormalTok{, col, }\StringTok{"\textquotesingle{}."}\NormalTok{))}
\NormalTok{           \})}
\NormalTok{  \}}

\NormalTok{.message\_info\_viewport }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{info =} \StringTok{"info"}\NormalTok{)\{}
    \FunctionTok{.message\_info}\NormalTok{(info, }\StringTok{"current.viewport:"}\NormalTok{,}
                  \FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}t}\StringTok{"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(grid}\SpecialCharTok{::}\FunctionTok{current.viewport}\NormalTok{())))}
\NormalTok{  \}}

\NormalTok{.message\_info }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(main, sub, }\AttributeTok{arg =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{sig =} \StringTok{"\#\#"}\NormalTok{)\{}
    \FunctionTok{message}\NormalTok{(sig, }\StringTok{" "}\NormalTok{, main, }\StringTok{": "}\NormalTok{, sub, }\StringTok{" "}\NormalTok{, arg)}
\NormalTok{  \}}

\NormalTok{.suggest\_bio\_package }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(pkg)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{requireNamespace}\NormalTok{(pkg, }\AttributeTok{quietly =}\NormalTok{ T))}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"package \textquotesingle{}"}\NormalTok{, pkg, }\StringTok{"\textquotesingle{} not installed. use folloing to install:}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
           \StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}n}\StringTok{if (!require("BiocManager", quietly = TRUE))\textquotesingle{}}\NormalTok{,}
           \StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}n\textbackslash{}t}\StringTok{install.packages("BiocManager")\textquotesingle{}}\NormalTok{,}
           \StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}n}\StringTok{BiocManager::install("\textquotesingle{}}\NormalTok{, pkg, }\StringTok{\textquotesingle{}")}\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export tmp\_pdf}
\CommentTok{\#\textquotesingle{} @aliases tmp\_pdf}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{tmp\_pdf\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{tmp\_pdf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
  \FunctionTok{paste0}\NormalTok{(}\FunctionTok{tempdir}\NormalTok{(), }\StringTok{"/tmp\_pdf.pdf"}\NormalTok{)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export op}
\CommentTok{\#\textquotesingle{} @aliases op}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{op\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{op }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file) \{}
  \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"xdg{-}open "}\NormalTok{, file))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export .cairosvg\_to\_grob}
\CommentTok{\#\textquotesingle{} @aliases .cairosvg\_to\_grob}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.cairosvg\_to\_grob\}: Convert cairo svg to \textquotesingle{}grob\textquotesingle{}.}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{.cairosvg\_to\_grob }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{    grImport2}\SpecialCharTok{::}\FunctionTok{grobify}\NormalTok{(grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(path))}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export .as\_dic}
\CommentTok{\#\textquotesingle{} @aliases .as\_dic}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.as\_dic\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{.as\_dic }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(vec, names, default,}
           \AttributeTok{fill =}\NormalTok{ T, }\AttributeTok{as.list =}\NormalTok{ T, }\AttributeTok{na.rm =}\NormalTok{ F)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(vec)))}
      \FunctionTok{names}\NormalTok{(vec) }\OtherTok{\textless{}{-}}\NormalTok{ names[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(vec)]}
    \ControlFlowTok{if}\NormalTok{ (fill) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\SpecialCharTok{!}\NormalTok{names }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(vec))) \{}
\NormalTok{        ex.names }\OtherTok{\textless{}{-}}\NormalTok{ names[}\SpecialCharTok{!}\NormalTok{names }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(vec)]}
\NormalTok{        ex }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(default, }\FunctionTok{length}\NormalTok{(ex.names))}
        \FunctionTok{names}\NormalTok{(ex) }\OtherTok{\textless{}{-}}\NormalTok{ ex.names}
\NormalTok{        vec }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(vec, ex)}
\NormalTok{      \}}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (as.list) \{}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(vec))}
\NormalTok{        vec }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(vec)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (na.rm) \{}
\NormalTok{      vec }\OtherTok{\textless{}{-}}\NormalTok{ vec[}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(}\FunctionTok{names}\NormalTok{(vec))]}
\NormalTok{    \}}
\NormalTok{    vec}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export fill\_list}
\CommentTok{\#\textquotesingle{} @aliases fill\_list}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{fill\_list\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{fill\_list }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(names, vec, }\AttributeTok{default =}\NormalTok{ vec[}\DecValTok{1}\NormalTok{]) \{}
  \FunctionTok{.as\_dic}\NormalTok{(vec, names, default, }\AttributeTok{fill =}\NormalTok{ T, }\AttributeTok{as.list =}\NormalTok{ F, }\AttributeTok{na.rm =}\NormalTok{ F)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export n}
\CommentTok{\#\textquotesingle{} @aliases n}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{n\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{n }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, n)\{}
  \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
    \FunctionTok{return}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  name }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(name))}
  \FunctionTok{paste0}\NormalTok{(name, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{n)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export namel}
\CommentTok{\#\textquotesingle{} @aliases namel}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{namel\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{namel }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(...)\{}
\NormalTok{  call }\OtherTok{\textless{}{-}} \FunctionTok{substitute}\NormalTok{(}\FunctionTok{list}\NormalTok{(...))}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(call))) \{}
\NormalTok{    names }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(call), }\ControlFlowTok{function}\NormalTok{(n) }\FunctionTok{as.character}\NormalTok{(call)[n])}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    names }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(call), }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                    \ControlFlowTok{function}\NormalTok{(n) \{}
                      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{names}\NormalTok{(call)[n] }\SpecialCharTok{==} \StringTok{""}\NormalTok{)}
                        \FunctionTok{as.character}\NormalTok{(call)[n]}
                      \ControlFlowTok{else}
                        \FunctionTok{names}\NormalTok{(call)[n]}
\NormalTok{                    \})}
\NormalTok{  \}}
  \FunctionTok{names}\NormalTok{(lst) }\OtherTok{\textless{}{-}}\NormalTok{ names}
\NormalTok{  lst}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export repSuffix}
\CommentTok{\#\textquotesingle{} @aliases repSuffix}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{repSuffix\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{repSuffix }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(chs, }\AttributeTok{anno =} \StringTok{".rep."}\NormalTok{)\{}
    \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(anno, }\DecValTok{1}\NormalTok{, }\StringTok{"$"}\NormalTok{), }\StringTok{""}\NormalTok{,}
         \FunctionTok{vapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(chs), }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
                \ControlFlowTok{function}\NormalTok{(n)\{}
                  \FunctionTok{paste0}\NormalTok{(chs[n], anno, }\FunctionTok{length}\NormalTok{(chs[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n][ chs[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n] }\SpecialCharTok{==}\NormalTok{ chs[n] ]))}
\NormalTok{                \}))}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export \%\textgreater{}\%}
\CommentTok{\#\textquotesingle{} @aliases \%\textgreater{}\%}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{\%\textgreater{}\%\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\StringTok{\textasciigrave{}}\AttributeTok{\%\textgreater{}\%}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}}\NormalTok{ magrittr}\SpecialCharTok{::}\StringTok{\textasciigrave{}}\AttributeTok{\%\textgreater{}\%}\StringTok{\textasciigrave{}}

\CommentTok{\#\textquotesingle{} @export \%\textless{}\textgreater{}\%}
\CommentTok{\#\textquotesingle{} @aliases \%\textless{}\textgreater{}\%}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{\%\textless{}\textgreater{}\%\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\StringTok{\textasciigrave{}}\AttributeTok{\%\textless{}\textgreater{}\%}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}}\NormalTok{ magrittr}\SpecialCharTok{::}\StringTok{\textasciigrave{}}\AttributeTok{\%\textless{}\textgreater{}\%}\StringTok{\textasciigrave{}}

\CommentTok{\#\textquotesingle{} @export .expath}
\CommentTok{\#\textquotesingle{} @aliases .expath}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.expath\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{.expath }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{  .expath }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, }\StringTok{"."}\NormalTok{, }\AttributeTok{package =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.*:"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{environmentName}\NormalTok{(}\FunctionTok{topenv}\NormalTok{())))}
  \FunctionTok{assign}\NormalTok{(}\StringTok{\textquotesingle{}.expath\textquotesingle{}}\NormalTok{, .expath, }\AttributeTok{envir =} \FunctionTok{topenv}\NormalTok{())}
\NormalTok{\}}

\NormalTok{.onLoad }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(libname, pkgname) \{}
  \FunctionTok{.expath}\NormalTok{()}
  \FunctionTok{.expathsvg}\NormalTok{()}
  \FunctionTok{.check\_external\_svg}\NormalTok{()}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export agroup}
\CommentTok{\#\textquotesingle{} @aliases agroup}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{agroup\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{agroup }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(group, value, }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{)) \{}
\NormalTok{  ug }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(group)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(ug) }\SpecialCharTok{\textgreater{}} \FunctionTok{length}\NormalTok{(value))}
    \FunctionTok{stop}\NormalTok{( }\StringTok{"the length of \textquotesingle{}value\textquotesingle{} not enough to assign"}\NormalTok{ )}
\NormalTok{  dic }\OtherTok{\textless{}{-}} \FunctionTok{.as\_dic}\NormalTok{(value, ug, }\AttributeTok{fill =}\NormalTok{ F, }\AttributeTok{na.rm =}\NormalTok{ F)}
  \FunctionTok{vapply}\NormalTok{(group, }\ControlFlowTok{function}\NormalTok{(g) dic[[g]], FUN.VALUE)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export write\_tsv}
\CommentTok{\#\textquotesingle{} @aliases write\_tsv}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{write\_tsv\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{write\_tsv }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, filename, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names =}\NormalTok{ F)\{}
    \FunctionTok{write.table}\NormalTok{(x, }\AttributeTok{file =}\NormalTok{ filename, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}
                \AttributeTok{col.names =}\NormalTok{ col.names, }\AttributeTok{row.names =}\NormalTok{ row.names, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export read\_tsv}
\CommentTok{\#\textquotesingle{} @aliases read\_tsv}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{read\_tsv\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{read\_tsv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input =}\NormalTok{ path, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}
                            \AttributeTok{header =}\NormalTok{ T, }\AttributeTok{quote =} \StringTok{""}\NormalTok{, }\AttributeTok{check.names =}\NormalTok{ F)}
  \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export mapply\_rename\_col}
\CommentTok{\#\textquotesingle{} @aliases mapply\_rename\_col}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{mapply\_rename\_col\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{mapply\_rename\_col }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           mutate\_set,}
\NormalTok{           replace\_set,}
\NormalTok{           names,}
           \AttributeTok{fixed =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    envir }\OtherTok{\textless{}{-}} \FunctionTok{environment}\NormalTok{()}
    \FunctionTok{mapply}\NormalTok{(mutate\_set, replace\_set,}
           \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ envir, }\AttributeTok{fixed =}\NormalTok{ fixed),}
           \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(mutate, replace, envir,}
                          \AttributeTok{fixed =}\NormalTok{ F, }\AttributeTok{names =} \FunctionTok{get}\NormalTok{(}\StringTok{"names"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ envir))\{}
\NormalTok{             names }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(mutate, replace, names, }\AttributeTok{perl =} \FunctionTok{ifelse}\NormalTok{(fixed, F, T), }\AttributeTok{fixed =}\NormalTok{ fixed)}
             \FunctionTok{assign}\NormalTok{(}\StringTok{"names"}\NormalTok{, names, }\AttributeTok{envir =}\NormalTok{ envir)}
\NormalTok{           \})}
    \FunctionTok{return}\NormalTok{(names)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export turn\_vector}
\CommentTok{\#\textquotesingle{} @aliases turn\_vector}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{turn\_vector\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{turn\_vector }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(vec) \{}
\NormalTok{  names }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(vec)}
  \FunctionTok{names}\NormalTok{(vec) }\OtherTok{\textless{}{-}} \FunctionTok{unname}\NormalTok{(vec)}
\NormalTok{  vec[] }\OtherTok{\textless{}{-}}\NormalTok{ names}
\NormalTok{  vec}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export group\_switch}
\CommentTok{\#\textquotesingle{} @aliases group\_switch}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{group\_switch\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{group\_switch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, meta.lst, by) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.character}\NormalTok{(data[[ by ]]))}
    \FunctionTok{stop}\NormalTok{( }\StringTok{"is.character(data[[ by ]]) == F"}\NormalTok{ )}
\NormalTok{  meta }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(meta.lst)}
  \FunctionTok{names}\NormalTok{(meta) }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\FunctionTok{names}\NormalTok{(meta.lst), }\FunctionTok{lengths}\NormalTok{(meta.lst))}
\NormalTok{  meta }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{turn\_vector}\NormalTok{(meta))}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data[data[[by]] }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(meta), ]}
\NormalTok{  group }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{order =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(data[[ by ]]), }\AttributeTok{col =}\NormalTok{ data[[ by ]])}
\NormalTok{  group }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(group, }\SpecialCharTok{\textasciitilde{}}\NormalTok{ col)}
\NormalTok{  group }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(group),}
                  \ControlFlowTok{function}\NormalTok{(name)\{}
\NormalTok{                    data }\OtherTok{\textless{}{-}}\NormalTok{ group[[ name ]]}
\NormalTok{                    data}\SpecialCharTok{$}\NormalTok{col }\OtherTok{\textless{}{-}}\NormalTok{ meta[[ name ]]}
                    \FunctionTok{return}\NormalTok{(data)}
\NormalTok{                  \})}
\NormalTok{  group }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(group)}
\NormalTok{  group }\OtherTok{\textless{}{-}}\NormalTok{ group[}\FunctionTok{order}\NormalTok{(group}\SpecialCharTok{$}\NormalTok{order), ]}\SpecialCharTok{$}\NormalTok{col}
  \FunctionTok{split}\NormalTok{(data, group)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export .find\_and\_sort\_strings}
\CommentTok{\#\textquotesingle{} @aliases .find\_and\_sort\_strings}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.find\_and\_sort\_strings\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{.find\_and\_sort\_strings }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(strings, patterns)\{}
    \FunctionTok{lapply}\NormalTok{(patterns,}
           \ControlFlowTok{function}\NormalTok{(pattern)\{}
\NormalTok{             strings[}\FunctionTok{grepl}\NormalTok{(pattern, strings, }\AttributeTok{perl =}\NormalTok{ T)]}
\NormalTok{           \})}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export maps}
\CommentTok{\#\textquotesingle{} @aliases maps}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{maps\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{maps }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, value, from, to) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(value))}
\NormalTok{    value }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(value)}
  \FunctionTok{lapply}\NormalTok{(value,}
         \ControlFlowTok{function}\NormalTok{(value) \{}
\NormalTok{           data }\OtherTok{\textless{}{-}}\NormalTok{ data[data[[from]] }\SpecialCharTok{\%in\%}\NormalTok{ value, ]}
\NormalTok{           vec }\OtherTok{\textless{}{-}}\NormalTok{ data[[ to ]]}
           \FunctionTok{names}\NormalTok{(vec) }\OtherTok{\textless{}{-}}\NormalTok{ data[[ from ]]}
\NormalTok{           vec}
\NormalTok{         \})}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export order\_list}
\CommentTok{\#\textquotesingle{} @aliases order\_list}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{order\_list\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{order\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list}
\NormalTok{           )\{}
\NormalTok{    lt }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
    \FunctionTok{length}\NormalTok{(lt) }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(list)}
    \FunctionTok{names}\NormalTok{(lt) }\OtherTok{\textless{}{-}} \FunctionTok{sort}\NormalTok{(}\FunctionTok{names}\NormalTok{(list))}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{names}\NormalTok{(lt))\{}
\NormalTok{      lt[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ list[[i]]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(lt)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export molconvert\_structure}
\CommentTok{\#\textquotesingle{} @aliases molconvert\_structure}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{molconvert\_structure\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\DocumentationTok{\#\# use \textquotesingle{}molconvert\textquotesingle{} ...}
\DocumentationTok{\#\# https://chemaxon.com/marvin}
\NormalTok{molconvert\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(smile, path)\{}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"molconvert mol }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, smile, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ {-}o "}\NormalTok{, path))}
\NormalTok{    src }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(path), }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    ChemmineOB}\SpecialCharTok{::}\FunctionTok{convertToImage}\NormalTok{(}\StringTok{"MOL"}\NormalTok{, }\StringTok{"SVG"}\NormalTok{, }\AttributeTok{source =}\NormalTok{ src, }\AttributeTok{toFile =}\NormalTok{ path)}
\NormalTok{    rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(path, path)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export obj.size}
\CommentTok{\#\textquotesingle{} @aliases obj.size}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{obj.size\}: ...}
\CommentTok{\#\textquotesingle{} @rdname utilites}
\NormalTok{obj.size }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, ...) \{}
  \FunctionTok{format}\NormalTok{(}\FunctionTok{object.size}\NormalTok{(x), }\AttributeTok{units =} \StringTok{"MB"}\NormalTok{, ...)}
\NormalTok{\}}

\NormalTok{clearMatch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(strs)}
\NormalTok{\{}
\NormalTok{  strs }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(strs)}
\NormalTok{  strs }\OtherTok{\textless{}{-}}\NormalTok{ strs[ }\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(strs, is.na, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{)) ]}
\NormalTok{  strs}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-alignment_merge.r}{%
\section{File: alignment\_merge.R}\label{file-alignment_merge.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Merge data tables based on continuous variables.}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases align\_merge}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Alignment merge of \textquotesingle{}features\textquotesingle{} via m/z and RT}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Merge two data.frame of \textquotesingle{}features\textquotesingle{} according to m/z and RT.}
\CommentTok{\#\textquotesingle{} The formula is the same in MZmine2:}
\CommentTok{\#\textquotesingle{} Score = (1 {-} rt.difference / rt.tolerance) * rt.weight +}
\CommentTok{\#\textquotesingle{} (1 {-} mz.defference / mz.tolerance) * mz.weight}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name align\_merge}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export align\_merge}
\CommentTok{\#\textquotesingle{} @aliases align\_merge}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{align\_merge\}: ...}
\CommentTok{\#\textquotesingle{} @rdname align\_merge}
\NormalTok{align\_merge }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(main, sub, }\AttributeTok{id =} \StringTok{".features\_id"}\NormalTok{,}
    \AttributeTok{mz.main =} \StringTok{"mz"}\NormalTok{, }\AttributeTok{mz.sub =} \StringTok{"mz"}\NormalTok{,}
    \AttributeTok{rt.main =} \StringTok{"rt.min"}\NormalTok{, }\AttributeTok{rt.sub =} \StringTok{"rt.min"}\NormalTok{,}
    \AttributeTok{mz.tol =}\NormalTok{ .}\DecValTok{05}\NormalTok{, }\AttributeTok{rt.tol =}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\AttributeTok{mz.weight =} \DecValTok{75}\NormalTok{, }\AttributeTok{rt.weight =} \DecValTok{25}\NormalTok{,}
    \AttributeTok{unique =}\NormalTok{ T}
\NormalTok{    ) \{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{main =}\NormalTok{ main, }\AttributeTok{sub =}\NormalTok{ sub)}
\NormalTok{    check\_col }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(col.x, col.y, lst) \{}
      \ControlFlowTok{if}\NormalTok{ (col.x }\SpecialCharTok{==}\NormalTok{ col.y) \{}
\NormalTok{        lst }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{coln\_suffix}\NormalTok{(lst, col.x)}
\NormalTok{        cols }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(col.x, }\FunctionTok{c}\NormalTok{(}\StringTok{".main"}\NormalTok{, }\StringTok{".sub"}\NormalTok{))}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        cols }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(col.x, col.y)}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(cols)}
\NormalTok{    \}}
\NormalTok{    mz.cols }\OtherTok{\textless{}{-}} \FunctionTok{check\_col}\NormalTok{(mz.main, mz.sub, lst)}
\NormalTok{    rt.cols }\OtherTok{\textless{}{-}} \FunctionTok{check\_col}\NormalTok{(rt.main, rt.sub, lst)}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{tol\_merge}\NormalTok{(lst[[}\DecValTok{1}\NormalTok{]], lst[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{main\_col =}\NormalTok{ mz.cols[}\DecValTok{1}\NormalTok{],}
      \AttributeTok{sub\_col =}\NormalTok{ mz.cols[}\DecValTok{2}\NormalTok{], }\AttributeTok{tol =}\NormalTok{ mz.tol)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\AttributeTok{.rt\_diff =} \FunctionTok{abs}\NormalTok{(.data[[rt.cols[}\DecValTok{1}\NormalTok{]]] }\SpecialCharTok{{-}}\NormalTok{ .data[[rt.cols[}\DecValTok{2}\NormalTok{]]]),}
      \AttributeTok{.mz\_diff =} \FunctionTok{abs}\NormalTok{(.data[[mz.cols[}\DecValTok{1}\NormalTok{]]] }\SpecialCharTok{{-}}\NormalTok{ .data[[mz.cols[}\DecValTok{2}\NormalTok{]]]))}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, .rt\_diff }\SpecialCharTok{\textless{}} \SpecialCharTok{!!}\NormalTok{rt.tol)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\AttributeTok{.score =}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ .rt\_diff }\SpecialCharTok{/} \SpecialCharTok{!!}\NormalTok{rt.tol) }\SpecialCharTok{*}\NormalTok{ rt.weight }\SpecialCharTok{+}
\NormalTok{      (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ .mz\_diff }\SpecialCharTok{/} \SpecialCharTok{!!}\NormalTok{mz.tol) }\SpecialCharTok{*}\NormalTok{ mz.weight)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(data, .data[[id]], dplyr}\SpecialCharTok{::}\FunctionTok{desc}\NormalTok{(.score))}
    \ControlFlowTok{if}\NormalTok{ (unique)}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(data, .data[[id]], }\AttributeTok{.keep\_all =}\NormalTok{ T)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(data, }\SpecialCharTok{{-}}\NormalTok{.rt\_diff, }\SpecialCharTok{{-}}\NormalTok{.mz\_diff, }\SpecialCharTok{{-}}\NormalTok{.score)}
\NormalTok{    tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(data)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export tol\_merge}
\CommentTok{\#\textquotesingle{} @aliases tol\_merge}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{tol\_merge\}: ...}
\CommentTok{\#\textquotesingle{} @rdname align\_merge}
\NormalTok{tol\_merge }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(main,}
\NormalTok{    sub,}
    \AttributeTok{main\_col =} \StringTok{"mz"}\NormalTok{,}
    \AttributeTok{sub\_col =} \StringTok{"mz"}\NormalTok{,}
    \AttributeTok{tol =} \FloatTok{0.002}\NormalTok{,}
    \AttributeTok{bin\_size =} \DecValTok{1}
\NormalTok{    )\{}
    \ControlFlowTok{if}\NormalTok{ (main\_col }\SpecialCharTok{==}\NormalTok{ sub\_col) \{}
\NormalTok{      new\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(sub\_col, }\StringTok{".sub"}\NormalTok{)}
      \FunctionTok{colnames}\NormalTok{(sub)[}\FunctionTok{colnames}\NormalTok{(sub) }\SpecialCharTok{==}\NormalTok{ sub\_col] }\OtherTok{\textless{}{-}}\NormalTok{ new\_name}
\NormalTok{      sub\_col }\OtherTok{\textless{}{-}}\NormalTok{ new\_name}
\NormalTok{    \}}
\NormalTok{    main}\SpecialCharTok{$}\NormalTok{...seq }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(main)}
\NormalTok{    backup }\OtherTok{\textless{}{-}}\NormalTok{ main}
    \DocumentationTok{\#\# to reduce computation, round numeric for limitation}
    \DocumentationTok{\#\# main}
\NormalTok{    main}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(main[[ main\_col ]], bin\_size)}
    \DocumentationTok{\#\# sub}
\NormalTok{    sub.x }\OtherTok{\textless{}{-}}\NormalTok{ sub.y }\OtherTok{\textless{}{-}}\NormalTok{ sub}
\NormalTok{    sub.x}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(sub.x[[ sub\_col ]], bin\_size)}
\NormalTok{    sub.y}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}}\NormalTok{ sub.x}\SpecialCharTok{$}\NormalTok{...id }\SpecialCharTok{+}\NormalTok{ ( }\DecValTok{1} \SpecialCharTok{*} \DecValTok{10}\SpecialCharTok{\^{}{-}}\NormalTok{bin\_size )}
\NormalTok{    sub }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sub.x, sub.y)}
    \DocumentationTok{\#\# expand merge}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(main, sub, }\AttributeTok{by =} \StringTok{"...id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{allow.cartesian =}\NormalTok{ T)}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{...diff }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(df[[ main\_col ]] }\SpecialCharTok{{-}}\NormalTok{ df[[ sub\_col ]])}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, ...diff }\SpecialCharTok{\textless{}=} \SpecialCharTok{!!}\NormalTok{tol)}
    \DocumentationTok{\#\# get the non{-}merged}
\NormalTok{    backup }\OtherTok{\textless{}{-}}\NormalTok{ backup[}\SpecialCharTok{!}\NormalTok{backup}\SpecialCharTok{$}\NormalTok{...seq }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{...seq, ]}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(df, backup)}
    \DocumentationTok{\#\# remove the assist col}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, }\SpecialCharTok{{-}}\NormalTok{...id, }\SpecialCharTok{{-}}\NormalTok{...diff, }\SpecialCharTok{{-}}\NormalTok{...seq)}
\NormalTok{  \}}

\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}} \OtherTok{\textless{}{-}}\NormalTok{ rlang}\SpecialCharTok{::}\StringTok{\textasciigrave{}}\AttributeTok{:=}\StringTok{\textasciigrave{}}

\NormalTok{coln\_suffix }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(lst, col,}
    \AttributeTok{suffix =} \FunctionTok{c}\NormalTok{(}\StringTok{".main"}\NormalTok{, }\StringTok{".sub"}\NormalTok{,}
      \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{length}\NormalTok{(lst) }\SpecialCharTok{\textless{}=} \DecValTok{2}\NormalTok{, }\FunctionTok{character}\NormalTok{(}\DecValTok{0}\NormalTok{),}
        \FunctionTok{paste0}\NormalTok{(}\StringTok{".other"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(lst) }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{))))}
\NormalTok{    ) \{}
    \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(lst),}
      \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(lst[[n]], }\SpecialCharTok{!!}\FunctionTok{paste0}\NormalTok{(col, suffix[n]) }\SpecialCharTok{:}\ErrorTok{=}\NormalTok{ col)}
\NormalTok{      \})}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-build_docu_from_script.r}{%
\section{File: build\_docu\_from\_script.R}\label{file-build_docu_from_script.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{build\_docu\_from\_script }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/outline"}\NormalTok{,}
           \AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.R$"}\NormalTok{,}
           \AttributeTok{output =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"mcnebula\_results"}\NormalTok{), }\StringTok{"mcnebula\_results"}\NormalTok{, }\StringTok{"."}\NormalTok{),}
           \AttributeTok{ref.docu =} \StringTok{"mcnebula.workflow.Rmd"}\NormalTok{,}
           \AttributeTok{ref.path =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, ref.docu, }\AttributeTok{package =} \StringTok{"utils.tool"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    ref.cluster }\OtherTok{\textless{}{-}} \FunctionTok{msource}\NormalTok{(}\AttributeTok{script =}\NormalTok{ ref.path, }\AttributeTok{block =} \StringTok{"\^{}@.*"}\NormalTok{, }\AttributeTok{source =}\NormalTok{ F)}
\NormalTok{    ref }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(ref.path)}
    \DocumentationTok{\#\# metadata of inset}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{tag =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ref, }\StringTok{"\^{}@.*"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{nrow =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(tag)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(tag)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{tag.name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(tag, }\StringTok{"(?\textless{}=@).\{1,\}"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# build empty list}
\NormalTok{    merge }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
    \FunctionTok{length}\NormalTok{(merge) }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(ref.cluster) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{{-}} \DecValTok{1}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(merge))\{}
      \ControlFlowTok{if}\NormalTok{(i }\SpecialCharTok{\%\%} \DecValTok{2} \SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
\NormalTok{        merge[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ ref.cluster[[(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{]]}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
        \FunctionTok{names}\NormalTok{(merge)[i] }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{tag.name[i }\SpecialCharTok{/} \DecValTok{2}\NormalTok{]}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{    merge }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(merge, }\ControlFlowTok{function}\NormalTok{(vec)\{}
                      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(vec) }\SpecialCharTok{==} \StringTok{"numeric"}\NormalTok{)\{}
\NormalTok{                        ref[vec]}
\NormalTok{                      \}}
\NormalTok{           \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    script }\OtherTok{\textless{}{-}} \FunctionTok{find\_latest\_script}\NormalTok{(path, pattern)}\SpecialCharTok{$}\NormalTok{file[}\DecValTok{1}\NormalTok{]}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO]: Latest script is:"}\NormalTok{, script, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# catch tag in script}
\NormalTok{    code }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(script)}
\NormalTok{    tag.script }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}
      \AttributeTok{start =} \FunctionTok{grep}\NormalTok{(}\StringTok{"\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}[a{-}z]\{1,\}\_\{1,\}"}\NormalTok{, code),}
      \AttributeTok{end =} \FunctionTok{grep}\NormalTok{(}\StringTok{"\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{$[a{-}z]\{1,\}\_\{1,\}"}\NormalTok{, code)}
\NormalTok{    ) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{tag =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(code[start], }\StringTok{"(?\textless{}=\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{})[a{-}z]\{1,\}(?=\_)"}\NormalTok{),}
                    \AttributeTok{start =}\NormalTok{ start }\SpecialCharTok{+} \DecValTok{1}\NormalTok{,}
                    \AttributeTok{end =}\NormalTok{ end }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    insert.line }\OtherTok{\textless{}{-}}
        \FunctionTok{apply}\NormalTok{(tag.script, }\DecValTok{1}\NormalTok{, }\AttributeTok{simplify =}\NormalTok{ F,}
               \ControlFlowTok{function}\NormalTok{(vec)\{}
\NormalTok{                 start }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(vec[[}\StringTok{"start"}\NormalTok{]])}
\NormalTok{                 end }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(vec[[}\StringTok{"end"}\NormalTok{]])}
\NormalTok{                 code }\OtherTok{\textless{}{-}}\NormalTok{ code[start}\SpecialCharTok{:}\NormalTok{end]}
\NormalTok{                 cluster }\OtherTok{\textless{}{-}} \FunctionTok{msource}\NormalTok{(}\AttributeTok{CODE =}\NormalTok{ code, }\AttributeTok{source =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
                   \FunctionTok{lapply}\NormalTok{(}
                          \ControlFlowTok{function}\NormalTok{(num)\{}
\NormalTok{                            code }\OtherTok{\textless{}{-}}\NormalTok{ code[num] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{                              .[}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#\# {-}\{1,\}"}\NormalTok{, .)]}
\NormalTok{                            code.intr }\OtherTok{\textless{}{-}}\NormalTok{ code[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[introduction}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{] "}\NormalTok{, code)] }\SpecialCharTok{\%\textgreater{}\%} 
                              \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[introduction}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{] "}\NormalTok{, }\StringTok{""}\NormalTok{, .)}
                            \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{                            code.run }\OtherTok{\textless{}{-}}\NormalTok{ code[}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[[a{-}z]\{1,\}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{] "}\NormalTok{, code)]}
                            \DocumentationTok{\#\# show figure of table}
                            \ControlFlowTok{if}\NormalTok{(T }\SpecialCharTok{\%in\%} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#\# @[a{-}z]\{1,\}"}\NormalTok{, code))\{}
\NormalTok{                              code.run }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s\{0,\}\# |\^{}\#\# @[a{-}z]\{1,\}"}\NormalTok{, }\StringTok{""}\NormalTok{, code.run)}
                              \FunctionTok{return}\NormalTok{(}\FunctionTok{c}\NormalTok{(code.intr, code.run))}
\NormalTok{                            \}}
                            \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(code.run) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{)\{}
\NormalTok{                              code.run }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
                                \StringTok{""}\NormalTok{,}
                                \StringTok{"\textasciigrave{}\textasciigrave{}\textasciigrave{}\{r, eval = F\}"}\NormalTok{,}
\NormalTok{                                code.run,}
                                \StringTok{"\textasciigrave{}\textasciigrave{}\textasciigrave{}"}\NormalTok{,}
                                \StringTok{""}
\NormalTok{                              )}
\NormalTok{                            \}}
\NormalTok{                            code.eval }\OtherTok{\textless{}{-}}\NormalTok{ code[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#\# }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[echo}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, code)]}
                            \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(code.eval) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{)\{}
\NormalTok{                              code.eval }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
                                \StringTok{""}\NormalTok{,}
                                \StringTok{"\textasciigrave{}\textasciigrave{}\textasciigrave{}\{r, echo = T\}"}\NormalTok{,}
\NormalTok{                                code.eval,}
                                \StringTok{"\textasciigrave{}\textasciigrave{}\textasciigrave{}"}\NormalTok{,}
                                \StringTok{""}
\NormalTok{                              )}
\NormalTok{                            \}}
\NormalTok{                            gather }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(code.intr, code.run, code.eval)}
\NormalTok{                          \})}
\NormalTok{               \})}
    \FunctionTok{names}\NormalTok{(insert.line) }\OtherTok{\textless{}{-}}\NormalTok{ tag.script}\SpecialCharTok{$}\NormalTok{tag}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \FunctionTok{names}\NormalTok{(insert.line))\{}
\NormalTok{      merge[[i]] }\OtherTok{\textless{}{-}}\NormalTok{ insert.line[[i]]}
\NormalTok{    \}}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(merge, }\AttributeTok{use.names =}\NormalTok{ F, }\AttributeTok{recursive =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/reports.Rmd"}\NormalTok{)}
    \FunctionTok{writeLines}\NormalTok{(md, savename)}
    \DocumentationTok{\#\# output pdf}
\NormalTok{    rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(savename)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"Done}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-cat_to_clipboard.r}{%
\section{File: cat\_to\_clipboard.R}\label{file-cat_to_clipboard.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gett }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           obj}
\NormalTok{           )\{}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"echo"}\NormalTok{, obj, }\StringTok{"| xsel {-}b {-}i"}\NormalTok{))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-classify.gnps.r}{%
\section{File: classify.gnps.R}\label{file-classify.gnps.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{classify.gnps }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# url path}
\NormalTok{    url\_start }\OtherTok{\textless{}{-}} \StringTok{"https://gnps{-}classyfire.ucsd.edu/entities/"}
\NormalTok{    url\_end }\OtherTok{\textless{}{-}} \StringTok{".json"}
    \DocumentationTok{\#\# gather}
\NormalTok{    url }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(url\_start, inchikey, url\_end)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    check }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(check }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{|} \FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(json }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url), }\AttributeTok{silent =}\NormalTok{ T)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Key not found"}\NormalTok{, json))\{}
      \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# read json}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ rjson}\SpecialCharTok{::}\FunctionTok{fromJSON}\NormalTok{(}\AttributeTok{json\_str =}\NormalTok{ json, ...)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_codes_as_report.r}{%
\section{File: collate\_codes\_as\_report.R}\label{file-collate_codes_as_report.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# for codes as report output}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{rough\_records }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dir, rdname, title, }\AttributeTok{files=} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  codes }\OtherTok{\textless{}{-}} \FunctionTok{get\_codes.dir}\NormalTok{(dir, }\AttributeTok{files =}\NormalTok{ files)}
\NormalTok{  chunks }\OtherTok{\textless{}{-}} \FunctionTok{as\_chunk.codes}\NormalTok{(codes)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"{-}{-}{-}"}\NormalTok{, }\StringTok{"{-}{-}{-}"}\NormalTok{, }\StringTok{""}\NormalTok{, chunks)}
\NormalTok{  report }\OtherTok{\textless{}{-}} \FunctionTok{as\_report.rough}\NormalTok{(lines)}
  \CommentTok{\# write\_thesisDocx(report, "codes\_of\_mcnebula2Docx.Rmd", "R codes of MCnebula2")}
  \FunctionTok{write\_articlePdf}\NormalTok{(report, rdname, title)}
\NormalTok{\}}

\NormalTok{get\_codes.dir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dir, }\AttributeTok{files =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.R$"}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(files)) \{}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(dir, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{  \}}
\NormalTok{  files }\OtherTok{\textless{}{-}}\NormalTok{ files[}\FunctionTok{grepl}\NormalTok{(pattern, files)]}
\NormalTok{  codes }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(files, readLines, }\AttributeTok{simplify =}\NormalTok{ F)}
  \FunctionTok{names}\NormalTok{(codes) }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(codes), get\_filename, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  codes}
\NormalTok{\}}

\NormalTok{as\_chunk.codes }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst, }\AttributeTok{as\_lines =}\NormalTok{ T) \{}
\NormalTok{  name }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(lst)}
\NormalTok{  lines }\OtherTok{\textless{}{-}}\NormalTok{ lst}
\NormalTok{  fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines) \{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{sep\_list}\NormalTok{(lines, }\StringTok{"\^{}\# =*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*$"}\NormalTok{, }\AttributeTok{before =}\NormalTok{ T)}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst,}
      \ControlFlowTok{function}\NormalTok{(ch) \{}
        \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}\textasciigrave{}\textasciigrave{}\textasciigrave{}\{r eval = F, echo = T\}\textquotesingle{}}\NormalTok{, ch, }\StringTok{\textquotesingle{}\textasciigrave{}\textasciigrave{}\textasciigrave{}\textquotesingle{}}\NormalTok{, }\StringTok{""}\NormalTok{)}
\NormalTok{      \})}
    \FunctionTok{unlist}\NormalTok{(lst)}
\NormalTok{  \}}
\NormalTok{  chunks }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(name),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\# File: "}\NormalTok{, name[n]), }\StringTok{""}\NormalTok{, }\FunctionTok{fun}\NormalTok{(lines[[ n ]]))}
\NormalTok{    \})}
  \ControlFlowTok{if}\NormalTok{ (as\_lines) \{}
\NormalTok{    chunks }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(chunks)}
\NormalTok{  \}}
\NormalTok{  chunks}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-compress.r}{%
\section{File: compress.R}\label{file-compress.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# use about zip, gunzip, gzip, tar ... in R}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{update\_tgz }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(tar.gz, file) \{ \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-create_xlsx.r}{%
\section{File: create\_xlsx.R}\label{file-create_xlsx.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# create .xlsx via openxlsx2}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{xl\_dim }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(rows, cols) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{max}\NormalTok{(cols) }\SpecialCharTok{\textgreater{}} \DecValTok{26}\NormalTok{) \{}
    \FunctionTok{stop}\NormalTok{( }\StringTok{"max(cols) \textgreater{} 26"}\NormalTok{ )}
\NormalTok{  \}}
  \FunctionTok{paste0}\NormalTok{(LETTERS[}\FunctionTok{min}\NormalTok{(cols)], }\FunctionTok{min}\NormalTok{(rows),}
    \StringTok{":"}\NormalTok{, LETTERS[}\FunctionTok{max}\NormalTok{(cols)], }\FunctionTok{max}\NormalTok{(rows))}
\NormalTok{\}}

\NormalTok{xl\_table }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{  data, }\AttributeTok{title =} \StringTok{"Table"}\NormalTok{,}
  \AttributeTok{group\_by =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{font =} \StringTok{"Times New Roman"}\NormalTok{,}
  \AttributeTok{wb =}\NormalTok{ openxlsx2}\SpecialCharTok{::}\FunctionTok{wb\_workbook}\NormalTok{()) }
\NormalTok{\{}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_worksheet}\NormalTok{()}
  \DocumentationTok{\#\# title}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{merge\_cells}\NormalTok{(}\AttributeTok{rows =} \DecValTok{1}\NormalTok{, }\AttributeTok{cols =} \FunctionTok{seq\_along}\NormalTok{(data))}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_data}\NormalTok{(}\AttributeTok{x =}\NormalTok{ title)}
\NormalTok{  title\_dim }\OtherTok{\textless{}{-}} \FunctionTok{xl\_dim}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{seq\_along}\NormalTok{(data))}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_font}\NormalTok{(, title\_dim, font, }\AttributeTok{bold =} \StringTok{"double"}\NormalTok{)}
  \DocumentationTok{\#\# data}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_data\_table}\NormalTok{(}\AttributeTok{x =}\NormalTok{ data, }\AttributeTok{startRow =} \DecValTok{2}\NormalTok{, }\AttributeTok{withFilter =}\NormalTok{ F, }\AttributeTok{na.strings =} \StringTok{""}\NormalTok{)}
\NormalTok{  data\_dim }\OtherTok{\textless{}{-}} \FunctionTok{xl\_dim}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data) }\SpecialCharTok{+} \DecValTok{2}\NormalTok{), }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data))}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_font}\NormalTok{(, data\_dim, font)}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_cell\_style}\NormalTok{(, data\_dim, }\AttributeTok{horizontal =} \StringTok{"left"}\NormalTok{, }\AttributeTok{vertical =} \StringTok{"top"}\NormalTok{)}
  \DocumentationTok{\#\# group}
\NormalTok{  group\_col }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(group\_by, }\FunctionTok{colnames}\NormalTok{(data))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(group\_col) }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(data) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, data[[ group\_by ]])}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ group) \{}
\NormalTok{      wb}\SpecialCharTok{$}\FunctionTok{merge\_cells}\NormalTok{(}\AttributeTok{rows =}\NormalTok{ i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, }\AttributeTok{cols =}\NormalTok{ group\_col)}
\NormalTok{    \}}
\NormalTok{  \}}
  \DocumentationTok{\#\# width}
\NormalTok{  nchar }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(}\FunctionTok{nchar}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data)), }\FunctionTok{apply}\NormalTok{(data, }\DecValTok{2}\NormalTok{, nchar))}
\NormalTok{  nchar.max }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(nchar, }\DecValTok{2}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{max}\NormalTok{(x, }\AttributeTok{na.rm =}\NormalTok{ T))}
\NormalTok{  nchar.max }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(nchar.max, }\ControlFlowTok{function}\NormalTok{(x) }\ControlFlowTok{if}\NormalTok{ (x }\SpecialCharTok{\textgreater{}} \DecValTok{30}\NormalTok{) }\DecValTok{30} \ControlFlowTok{else}\NormalTok{ x, }\FunctionTok{numeric}\NormalTok{(}\DecValTok{1}\NormalTok{))}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(data)) \{}
\NormalTok{    wb}\SpecialCharTok{$}\FunctionTok{set\_col\_widths}\NormalTok{(, }\AttributeTok{cols =}\NormalTok{ i, }\AttributeTok{width =}\NormalTok{ nchar.max[i] }\SpecialCharTok{*} \DecValTok{1} \SpecialCharTok{+} \DecValTok{3}\NormalTok{)}
\NormalTok{  \}}
  \DocumentationTok{\#\# border}
\NormalTok{  header\_dim }\OtherTok{\textless{}{-}} \FunctionTok{xl\_dim}\NormalTok{(}\DecValTok{2}\NormalTok{, }\FunctionTok{seq\_along}\NormalTok{(data))}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_border}\NormalTok{( , header\_dim,}
    \AttributeTok{left\_border =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{right\_border =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{top\_border =} \StringTok{"double"}\NormalTok{, }\AttributeTok{bottom\_border =} \StringTok{"double"}
\NormalTok{  )}
\NormalTok{  end\_dim }\OtherTok{\textless{}{-}} \FunctionTok{xl\_dim}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(data) }\SpecialCharTok{+} \DecValTok{2}\NormalTok{, }\FunctionTok{seq\_along}\NormalTok{(data))}
\NormalTok{  wb}\SpecialCharTok{$}\FunctionTok{add\_border}\NormalTok{(, end\_dim,}
    \AttributeTok{left\_border =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{right\_border =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{top\_border =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{bottom\_border =} \StringTok{"double"}
\NormalTok{  )}
  \FunctionTok{return}\NormalTok{(wb)}
\NormalTok{\}}

\NormalTok{xl\_save }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(wb, path) \{}
\NormalTok{  openxlsx2}\SpecialCharTok{::}\FunctionTok{wb\_save}\NormalTok{(wb, path)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-cross_select.r}{%
\section{File: cross\_select.R}\label{file-cross_select.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# filter data according to colunm within another data.frame}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases select\_features}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Select \textquotesingle{}features\textquotesingle{} for MCnebula2}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Select significant \textquotesingle{}features\textquotesingle{} from MCnebula2 with}
\CommentTok{\#\textquotesingle{} statistic results for downstream analysis of metabolomics.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name select\_features}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export select\_features}
\CommentTok{\#\textquotesingle{} @aliases select\_features}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{select\_features\}: ...}
\CommentTok{\#\textquotesingle{} @rdname select\_features}
\NormalTok{select\_features }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{  mcn, }\AttributeTok{classes =} \FunctionTok{unique}\NormalTok{(}\FunctionTok{nebula\_index}\NormalTok{(mcn)}\SpecialCharTok{$}\NormalTok{class.name),}
  \AttributeTok{q.value =}\NormalTok{ .}\DecValTok{05}\NormalTok{, }\AttributeTok{logfc =}\NormalTok{ .}\DecValTok{3}\NormalTok{, }\AttributeTok{coef =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{tani.score\_cutoff =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{order\_by\_coef =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{togather =}\NormalTok{ F) }
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"MCnebula2"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"package \textquotesingle{}MCnebula2\textquotesingle{} must be available."}\NormalTok{)}
  \FunctionTok{.check\_data}\NormalTok{(}\FunctionTok{statistic\_set}\NormalTok{(mcn), }\FunctionTok{list}\NormalTok{(}\AttributeTok{top\_table =} \StringTok{"binary\_comparison"}\NormalTok{))}
  \FunctionTok{.check\_data}\NormalTok{(mcn, }\FunctionTok{list}\NormalTok{(}\AttributeTok{nebula\_index =} \StringTok{"create\_nebula\_index"}\NormalTok{,}
      \AttributeTok{features\_annotation =} \StringTok{"create\_features\_annotation"}\NormalTok{))}
\NormalTok{  stat }\OtherTok{\textless{}{-}} \FunctionTok{top\_table}\NormalTok{(}\FunctionTok{statistic\_set}\NormalTok{(mcn))}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(coef)) \{}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ stat[coef]}
\NormalTok{  \}}
\NormalTok{  stat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(stat))}
\NormalTok{  data.lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{nebula\_index}\NormalTok{(mcn), stat)}
\NormalTok{  filter.lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
\NormalTok{    rlang}\SpecialCharTok{::}\FunctionTok{quos}\NormalTok{(class.name }\SpecialCharTok{\%in\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(classes)),}
\NormalTok{    rlang}\SpecialCharTok{::}\FunctionTok{quos}\NormalTok{(adj.P.Val }\SpecialCharTok{\textless{}}\NormalTok{ q.value, }\FunctionTok{abs}\NormalTok{(logFC) }\SpecialCharTok{\textgreater{}}\NormalTok{ logfc)}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(tani.score\_cutoff)) \{}
\NormalTok{    data.lst[[}\DecValTok{3}\NormalTok{]] }\OtherTok{\textless{}{-}} \FunctionTok{features\_annotation}\NormalTok{(mcn)}
\NormalTok{    filter.lst[[}\DecValTok{3}\NormalTok{]] }\OtherTok{\textless{}{-}}\NormalTok{ rlang}\SpecialCharTok{::}\FunctionTok{quos}\NormalTok{(tani.score }\SpecialCharTok{\textgreater{}=}\NormalTok{ tani.score\_cutoff)}
\NormalTok{  \}}
\NormalTok{  res }\OtherTok{\textless{}{-}} \FunctionTok{cross\_select}\NormalTok{(data.lst, filter.lst, }\StringTok{".features\_id"}\NormalTok{, }\StringTok{"class.name"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(order\_by\_coef)) \{}
\NormalTok{    ranks }\OtherTok{\textless{}{-}} \FunctionTok{top\_table}\NormalTok{(}\FunctionTok{statistic\_set}\NormalTok{(mcn))[[ order\_by\_coef ]]}\SpecialCharTok{$}\NormalTok{.features\_id}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(res,}
      \ControlFlowTok{function}\NormalTok{(ids) \{}
\NormalTok{        ranks[ ranks }\SpecialCharTok{\%in\%}\NormalTok{ ids ]}
\NormalTok{      \})}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (togather) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(res, }\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{    res }\OtherTok{\textless{}{-}}\NormalTok{ ranks[ ranks }\SpecialCharTok{\%in\%}\NormalTok{ res ]}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export cross\_select}
\CommentTok{\#\textquotesingle{} @aliases cross\_select}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{cross\_select\}: ...}
\CommentTok{\#\textquotesingle{} @rdname select\_features}
\NormalTok{cross\_select }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data.lst, filter.lst, target, }\AttributeTok{split =} \ConstantTok{NULL}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(data.lst) }\SpecialCharTok{|} \SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(filter.lst))}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"\textasciigrave{}data.lst\textasciigrave{} and \textasciigrave{}filter.lst\textasciigrave{} must be \textquotesingle{}list\textquotesingle{}."}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(data.lst) }\SpecialCharTok{!=} \FunctionTok{length}\NormalTok{(filter.lst))}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"\textasciigrave{}data.lst\textasciigrave{} and \textasciigrave{}filter.lst\textasciigrave{} must be \textquotesingle{}list\textquotesingle{} with the same length."}\NormalTok{)}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(data.lst),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(filter.lst[[n]]))}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.lst[[n]], }\SpecialCharTok{!!!}\NormalTok{(filter.lst[[n]]))}
      \ControlFlowTok{else}
\NormalTok{        data.lst[[n]]}
\NormalTok{    \})}
\NormalTok{  fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(res, lst) \{}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(lst)) \{}
\NormalTok{      res }\OtherTok{\textless{}{-}}\NormalTok{ res[res }\SpecialCharTok{\%in\%}\NormalTok{ lst[[ i ]]]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(split)) \{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(data) data[[ target ]])}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(lst[[}\DecValTok{1}\NormalTok{]], lst)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(lst[[}\DecValTok{1}\NormalTok{]], lst[[}\DecValTok{1}\NormalTok{]][[ split ]]),}
      \ControlFlowTok{function}\NormalTok{(data) data[[ target ]])}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(data) data[[ target ]])}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(res, fun, }\AttributeTok{lst =}\NormalTok{ lst)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @importFrom rlang as\_label}
\NormalTok{.check\_data }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(object, lst, }\AttributeTok{tip =} \StringTok{"(...)"}\NormalTok{)\{}
\NormalTok{    target }\OtherTok{\textless{}{-}}\NormalTok{ rlang}\SpecialCharTok{::}\FunctionTok{as\_label}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(object))}
    \FunctionTok{mapply}\NormalTok{(lst, }\FunctionTok{names}\NormalTok{(lst), }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(value, name)\{}
\NormalTok{             obj }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(name)(object)}
             \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(obj)) \{}
               \FunctionTok{stop}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"is.null("}\NormalTok{, name, }\StringTok{"("}\NormalTok{, target, }\StringTok{")) == T. "}\NormalTok{,}
                           \StringTok{"use \textasciigrave{}"}\NormalTok{, value, tip, }\StringTok{"\textasciigrave{} previously."}\NormalTok{))}
\NormalTok{             \}}
             \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.list}\NormalTok{(obj)) \{}
               \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(obj) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
                 \FunctionTok{stop}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"length("}\NormalTok{, name, }\StringTok{"("}\NormalTok{, target, }\StringTok{")) == 0. "}\NormalTok{,}
                             \StringTok{"use \textasciigrave{}"}\NormalTok{, value, tip, }\StringTok{"\textasciigrave{} previously."}\NormalTok{))}
\NormalTok{               \}}
\NormalTok{             \}}
\NormalTok{           \})}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-discard.r}{%
\section{File: DISCARD.R}\label{file-discard.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# to deal with the bug in \textasciigrave{}grid.grep\textasciigrave{}}
\CommentTok{\# valide\_vp \textless{}{-} function(ch, chs, sort = F)\{}
  \CommentTok{\# check \textless{}{-} grid.grep(ch, viewports = T, strict = T, no.match = F)}
  \CommentTok{\# if (is(check, "logical")) \{}
  \CommentTok{\#   return(F)}
  \CommentTok{\# \}}
  \CommentTok{\# if (sort) \{}
  \CommentTok{\#   chs \textless{}{-} sort\_vpPaths(chs)}
  \CommentTok{\# \}}
  \CommentTok{\# nums \textless{}{-} vapply(chs, FUN.VALUE = 0,}
  \CommentTok{\#                function(ch) \{length(grepRaw("::", ch, all = T))\})}
  \CommentTok{\# parent.n \textless{}{-} min(nums)}
  \CommentTok{\# match \textless{}{-} grepRaw("::", ch, all = T)}
  \CommentTok{\# end \textless{}{-} match[ parent.n + 1 ] {-} 1}
  \CommentTok{\# if (!is.na(end)) \{}
  \CommentTok{\#   ch.parent \textless{}{-} stringr::str\_sub(ch, 1L, end)}
  \CommentTok{\# \} else \{}
  \CommentTok{\#   ch.parent \textless{}{-} ch}
  \CommentTok{\# \}}
  \CommentTok{\# chs \textless{}{-} chs[which( nums \textgreater{} parent.n )]}
  \CommentTok{\# if (length(chs) == 0)}
  \CommentTok{\#   return(F)}
  \CommentTok{\# if (any(!grepl(ch.parent, chs))) \{}
  \CommentTok{\#   return(F)}
  \CommentTok{\# \}}
  \CommentTok{\# return(ch)}
\CommentTok{\# \}}

\CommentTok{\# files \textless{}{-} c("mcn\_serum6501.rdata", "serum.tar.gz")}
\CommentTok{\#   urls \textless{}{-} paste0("https://raw.githubusercontent.com/Cao{-}lab{-}zcmu/utils\_tool/master/",}
\CommentTok{\#                 "inst/extdata/", files)}
\CommentTok{\#   lapply(1:length(files),}
\CommentTok{\#          function(n) \{}
\CommentTok{\#            url \textless{}{-} urls[n]}
\CommentTok{\#            data \textless{}{-} RCurl::getURLContent(url)}
\CommentTok{\#            file \textless{}{-} paste0(tmp, "/", files[n])}
\CommentTok{\#            target \textless{}{-} file(file, "wb")}
\CommentTok{\#            writeBin(data, target)}
\CommentTok{\#            close(target)}
\CommentTok{\#          \})}

\CommentTok{\# check\_pkg \textless{}{-}}
\CommentTok{\#   function(}
\CommentTok{\#            packages = c("data.table", "dplyr", "pbapply", "RCurl", "XML")}
\CommentTok{\#            )\{}
\CommentTok{\#     lapply(packages,}
\CommentTok{\#          function(pkg)\{}
\CommentTok{\#            if (!requireNamespace(pkg, quietly = T))}
\CommentTok{\#              install.packages(pkg)}
\CommentTok{\#          \})}
\CommentTok{\#     message("Job Done")}
\CommentTok{\# \}}

\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\CommentTok{\# add\_spanner \textless{}{-} }
\CommentTok{\#   function(}
\CommentTok{\#            t,}
\CommentTok{\#            names,}
\CommentTok{\#            group,}
\CommentTok{\#            col\_spanner}
\CommentTok{\#            )\{}
\CommentTok{\#     envir \textless{}{-} environment()}
\CommentTok{\#     mapply(base\_add\_spanner, group, col\_spanner,}
\CommentTok{\#            MoreArgs = list(envir = envir))}
\CommentTok{\#     return(t)}
\CommentTok{\#   \}}
\CommentTok{\# base\_add\_spanner \textless{}{-} }
\CommentTok{\#   function(}
\CommentTok{\#            the\_group,}
\CommentTok{\#            spanner,}
\CommentTok{\#            envir,}
\CommentTok{\#            names = get("names", envir = envir),}
\CommentTok{\#            t = get("t", envir = envir)}
\CommentTok{\#            )\{}
\CommentTok{\#     columns \textless{}{-} names \%\textgreater{}\%}
\CommentTok{\#       .[grepl(the\_group, .)]}
\CommentTok{\#     t \textless{}{-} t \%\textgreater{}\%}
\CommentTok{\#       tab\_spanner(label = spanner,}
\CommentTok{\#                   columns = columns)}
\CommentTok{\#     assign("t", t, envir = envir)}
\CommentTok{\#   \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\end{Highlighting}
\end{Shaded}

\hypertarget{file-dot_heatmap.r}{%
\section{File: dot\_heatmap.R}\label{file-dot_heatmap.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# heat map with ggplot2}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases plot\_heatmap}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Plot heat map with ggplot2}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description According to list of \textquotesingle{}ID\textquotesingle{} to draw mutiple heatmap...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name plot\_heatmap}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export plot\_heatmap}
\CommentTok{\#\textquotesingle{} @aliases plot\_heatmap}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{plot\_heatmap\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{plot\_heatmap }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id.lst, data, metadata,}
  \AttributeTok{pal\_class =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_futurama}\NormalTok{()(}\DecValTok{12}\NormalTok{), pal\_group,}
  \AttributeTok{clust\_row =}\NormalTok{ T, }\AttributeTok{clust\_col =}\NormalTok{ T, }\AttributeTok{method =} \StringTok{\textquotesingle{}complete\textquotesingle{}}\NormalTok{)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(id.lst))) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"is.null(names(id.lst)) == T. The names of \textasciigrave{}id.lst\textasciigrave{} should be chemical classes."}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(pal\_class))) \{}
\NormalTok{    pal\_class }\OtherTok{\textless{}{-}}\NormalTok{ pal\_class[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(id.lst)]}
    \FunctionTok{names}\NormalTok{(pal\_class) }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(id.lst)}
\NormalTok{  \}}
  \FunctionTok{.check\_columns}\NormalTok{(metadata, }\FunctionTok{c}\NormalTok{(}\StringTok{"sample"}\NormalTok{, }\StringTok{"group"}\NormalTok{), }\StringTok{"metadata"}\NormalTok{)}
  \FunctionTok{.check\_columns}\NormalTok{(data, }\FunctionTok{c}\NormalTok{(}\StringTok{".features\_id"}\NormalTok{, }\StringTok{"sample"}\NormalTok{, }\StringTok{"value"}\NormalTok{), }\StringTok{"data"}\NormalTok{)}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(id.lst), }\AttributeTok{simplify =}\NormalTok{ F,}
    \ControlFlowTok{function}\NormalTok{(class.name) \{}
      \DocumentationTok{\#\# basic heatmap}
\NormalTok{      ids }\OtherTok{\textless{}{-}}\NormalTok{ id.lst[[ class.name ]]}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, .data}\SpecialCharTok{$}\NormalTok{.features\_id }\SpecialCharTok{\%in\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(ids))}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{tile\_heatmap}\NormalTok{(data)}
      \DocumentationTok{\#\# chemical classes}
\NormalTok{      data.class }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{class =}\NormalTok{ class.name, }\AttributeTok{.features\_id =}\NormalTok{ ids)}
\NormalTok{      pal\_class }\OtherTok{\textless{}{-}}\NormalTok{ pal\_class[}\FunctionTok{names}\NormalTok{(pal\_class) }\SpecialCharTok{==}\NormalTok{ class.name]}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{add\_ygroup.tile.heatmap}\NormalTok{(data.class, p, pal\_class)}
      \DocumentationTok{\#\# cluster tree}
      \ControlFlowTok{if}\NormalTok{ (clust\_row }\SpecialCharTok{|}\NormalTok{ clust\_col) \{}
\NormalTok{        data.w }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{spread}\NormalTok{(data, .data}\SpecialCharTok{$}\NormalTok{sample, .data}\SpecialCharTok{$}\NormalTok{value)}
\NormalTok{        data.w }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(data.w)}
        \FunctionTok{rownames}\NormalTok{(data.w) }\OtherTok{\textless{}{-}}\NormalTok{ data.w}\SpecialCharTok{$}\NormalTok{.features\_id}
\NormalTok{        data.w }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(data.w, dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(metadata[[ }\StringTok{"sample"}\NormalTok{ ]]))}
\NormalTok{        p }\OtherTok{\textless{}{-}} \FunctionTok{add\_tree.heatmap}\NormalTok{(}
\NormalTok{          data.w, p, }\AttributeTok{method =}\NormalTok{ method,}
          \AttributeTok{clust\_row =}\NormalTok{ clust\_row, }\AttributeTok{clust\_col =}\NormalTok{ clust\_col}
\NormalTok{        )}
\NormalTok{      \}}
      \DocumentationTok{\#\# sample metadata}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{add\_xgroup.tile.heatmap}\NormalTok{(metadata, p, pal\_group)}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \})}
  \FunctionTok{return}\NormalTok{(lst)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export handling\_na}
\CommentTok{\#\textquotesingle{} @aliases handling\_na}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{handling\_na\}:}
\CommentTok{\#\textquotesingle{} For each subset of data, the missing values will be filled with the average}
\CommentTok{\#\textquotesingle{} value; if the set is all missing values, they will be filled with zero.}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{handling\_na }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{id.cols =} \FunctionTok{c}\NormalTok{(}\StringTok{".features\_id"}\NormalTok{),}
\NormalTok{  metadata, }\AttributeTok{sample.col =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{group.col =} \StringTok{"group"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  metadata }\OtherTok{\textless{}{-}}\NormalTok{ metadata[, }\FunctionTok{c}\NormalTok{(sample.col, group.col)]}
\NormalTok{  metadata }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(metadata, metadata[[ group.col ]])}
\NormalTok{  id.cols }\OtherTok{\textless{}{-}}\NormalTok{ data[, id.cols]}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(metadata),}
    \ControlFlowTok{function}\NormalTok{(group) \{}
\NormalTok{      meta }\OtherTok{\textless{}{-}}\NormalTok{ metadata[[ group ]]}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data[, meta[[ sample.col ]]]}
\NormalTok{      lst }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, }\AttributeTok{simplify =}\NormalTok{ F,}
        \ControlFlowTok{function}\NormalTok{(vec) \{}
          \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{all}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(vec))) \{}
\NormalTok{            vec[] }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{          \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(vec))) \{}
\NormalTok{            vec[}\FunctionTok{is.na}\NormalTok{(vec)] }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(vec, }\AttributeTok{na.rm =}\NormalTok{ T)}
\NormalTok{          \}}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(vec)}
\NormalTok{        \})}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst)}
\NormalTok{    \})}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{bind\_cols, data)}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{bind\_cols}\NormalTok{(id.cols, data)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export log\_trans}
\CommentTok{\#\textquotesingle{} @aliases log\_trans}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{log\_trans\}:}
\CommentTok{\#\textquotesingle{} Convert wide data to long data; log transform the values; if there is a}
\CommentTok{\#\textquotesingle{} value 0, replace it with 1/10 of the minimum value of the value column.}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{log\_trans }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{id.cols =} \FunctionTok{c}\NormalTok{(}\StringTok{".features\_id"}\NormalTok{),}
  \AttributeTok{key =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{value =} \StringTok{"value"}\NormalTok{,}
  \AttributeTok{set\_min =}\NormalTok{ T, }\AttributeTok{factor =} \DecValTok{10}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ log2, }\AttributeTok{center =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(data, }\SpecialCharTok{!!}\NormalTok{key, }\SpecialCharTok{!!}\NormalTok{value, }\SpecialCharTok{{-}}\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(id.cols))}
  \ControlFlowTok{if}\NormalTok{ (set\_min) \{}
\NormalTok{    min }\OtherTok{\textless{}{-}} \FunctionTok{min}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, .data[[ value ]] }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{)[[ value ]])}
\NormalTok{    data[[ value ]] }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(data[[ value ]] }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, min }\SpecialCharTok{/}\NormalTok{ factor, data[[ value ]])}
\NormalTok{  \}}
\NormalTok{  data[[ value ]] }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(data[[ value ]])}
  \ControlFlowTok{if}\NormalTok{ (center) \{}
\NormalTok{    data[[ value ]] }\OtherTok{\textless{}{-}} \FunctionTok{scale}\NormalTok{(data[[ value ]], }\AttributeTok{scale =}\NormalTok{ F)[, }\DecValTok{1}\NormalTok{]}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(data)}
\NormalTok{\}}

\NormalTok{dot\_heatmap }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{  p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ sample, }\AttributeTok{y =}\NormalTok{ .features\_id)) }\SpecialCharTok{+}
    \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{abs}\NormalTok{(value), }\AttributeTok{color =}\NormalTok{ value), }\AttributeTok{shape =} \DecValTok{16}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{guides}\NormalTok{(}\AttributeTok{size =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#3182BDFF"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#A73030FF"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font),}
      \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{angle =} \DecValTok{90}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{\}}

\DocumentationTok{\#\# long data}
\NormalTok{tile\_heatmap }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ sample, }\AttributeTok{y =}\NormalTok{ .features\_id)) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ value),}
        \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_gradient2}\NormalTok{(}\AttributeTok{low =} \StringTok{"\#3182BDFF"}\NormalTok{, }\AttributeTok{high =} \StringTok{"\#A73030FF"}\NormalTok{,}
        \AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\FunctionTok{min}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{value), }\FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{value))) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Sample"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Feature ID"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"log2 (Feature level)"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{axis.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"plain"}\NormalTok{),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{()}
\NormalTok{      )}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export add\_tree.heatmap}
\CommentTok{\#\textquotesingle{} @aliases add\_tree.heatmap}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{add\_tree.heatmap\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{add\_tree.heatmap }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, p, }\AttributeTok{clust\_row =}\NormalTok{ T, }\AttributeTok{clust\_col =}\NormalTok{ T, }\AttributeTok{method =} \StringTok{\textquotesingle{}complete\textquotesingle{}}\NormalTok{)\{}
    \ControlFlowTok{if}\NormalTok{ (clust\_row) \{}
\NormalTok{      phr }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(df), method)}
\NormalTok{      phr }\OtherTok{\textless{}{-}}\NormalTok{ ggtree}\SpecialCharTok{::}\FunctionTok{ggtree}\NormalTok{(phr, }\AttributeTok{layout =} \StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length =} \StringTok{"branch.length"}\NormalTok{) }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ aplot}\SpecialCharTok{::}\FunctionTok{insert\_left}\NormalTok{(p, phr, }\AttributeTok{width =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (clust\_col) \{}
\NormalTok{      phc }\OtherTok{\textless{}{-}} \FunctionTok{hclust}\NormalTok{(}\FunctionTok{dist}\NormalTok{(}\FunctionTok{t}\NormalTok{(df)), method)}
\NormalTok{      phc }\OtherTok{\textless{}{-}}\NormalTok{ ggtree}\SpecialCharTok{::}\FunctionTok{ggtree}\NormalTok{(phc, }\AttributeTok{layout =} \StringTok{"rectangular"}\NormalTok{, }\AttributeTok{branch.length =} \StringTok{"branch.length"}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{        ggtree}\SpecialCharTok{::}\FunctionTok{layout\_dendrogram}\NormalTok{() }\SpecialCharTok{+}
        \FunctionTok{theme}\NormalTok{(}\AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{))}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ aplot}\SpecialCharTok{::}\FunctionTok{insert\_top}\NormalTok{(p, phc, }\AttributeTok{height =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export add\_xgroup.heatmap}
\CommentTok{\#\textquotesingle{} @aliases add\_xgroup.heatmap}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{add\_xgroup.heatmap\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{add\_xgroup.heatmap }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, p)\{}
\NormalTok{    p.xgroup }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =} \StringTok{"Group"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ sample)) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ group), }\AttributeTok{size =} \DecValTok{6}\NormalTok{) }\SpecialCharTok{+}
\NormalTok{      ggsci}\SpecialCharTok{::}\FunctionTok{scale\_color\_simpsons}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
\NormalTok{      com }\OtherTok{\textless{}{-}}\NormalTok{ aplot}\SpecialCharTok{::}\FunctionTok{insert\_bottom}\NormalTok{(p, p.xgroup, }\AttributeTok{height =} \FloatTok{0.05}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(com)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export add\_xgroup.tile.heatmap}
\CommentTok{\#\textquotesingle{} @aliases add\_xgroup.tile.heatmap}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{add\_xgroup.tile.heatmap\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{add\_xgroup.tile.heatmap }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, p, }\AttributeTok{pal =} \ConstantTok{NA}\NormalTok{)\{}
\NormalTok{    expr.pal }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(pal),}
      \StringTok{\textquotesingle{}ggsci::scale\_fill\_simpsons()\textquotesingle{}}\NormalTok{,}
      \StringTok{\textquotesingle{}scale\_fill\_manual(values = pal)\textquotesingle{}}\NormalTok{)}
\NormalTok{    p.xgroup }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{y =} \StringTok{"Group"}\NormalTok{, }\AttributeTok{x =}\NormalTok{ sample)) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ group), }
        \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ expr.pal)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Group"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
\NormalTok{      com }\OtherTok{\textless{}{-}}\NormalTok{ aplot}\SpecialCharTok{::}\FunctionTok{insert\_bottom}\NormalTok{(p, p.xgroup, }\AttributeTok{height =} \FloatTok{0.05}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(com)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export add\_ygroup.tile.heatmap}
\CommentTok{\#\textquotesingle{} @aliases add\_ygroup.tile.heatmap}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{add\_ygroup.tile.heatmap\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_heatmap}
\NormalTok{add\_ygroup.tile.heatmap }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(df, p, }\AttributeTok{pal =} \ConstantTok{NA}\NormalTok{)\{}
\NormalTok{    expr.pal }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(pal),}
      \StringTok{\textquotesingle{}ggsci::scale\_fill\_npg()\textquotesingle{}}\NormalTok{,}
      \StringTok{\textquotesingle{}scale\_fill\_manual(values = pal)\textquotesingle{}}\NormalTok{)}
\NormalTok{    p.ygroup }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \StringTok{"Class"}\NormalTok{, }\AttributeTok{y =}\NormalTok{ .features\_id)) }\SpecialCharTok{+}
      \FunctionTok{geom\_tile}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ class),}
        \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{height =} \DecValTok{1}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{"From"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ expr.pal)) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.margin =} \FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{), }\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
\NormalTok{      com }\OtherTok{\textless{}{-}}\NormalTok{ aplot}\SpecialCharTok{::}\FunctionTok{insert\_left}\NormalTok{(p, p.ygroup, }\AttributeTok{width =} \FloatTok{0.02}\NormalTok{) }
      \FunctionTok{return}\NormalTok{(com)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-exreport.r}{%
\section{File: exReport.R}\label{file-exreport.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# extra tool for report system}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\# gather\_sections \textless{}{-} function(prefix = "s", envir = parent.frame(),}
\CommentTok{\#   sort = T, get = T)}
\CommentTok{\# \{}
\CommentTok{\#   objs \textless{}{-} ls(envir = envir)}
\CommentTok{\#   sections \textless{}{-} objs[ grepl(paste0("\^{}", prefix, "[0{-}9]"), objs) ]}
\CommentTok{\#   if (sort) \{}
\CommentTok{\#     num \textless{}{-} stringr::str\_extract(}
\CommentTok{\#       sections, paste0("(?\textless{}=", prefix, ")[0{-}9.]\{0,\}[0{-}9]")}
\CommentTok{\#     )}
\CommentTok{\#     sections \textless{}{-} sections[order(as.numeric(num))]}
\CommentTok{\#   \}}
\CommentTok{\#   if (get) \{}
\CommentTok{\#     sections \textless{}{-} sapply(sections, get, envir = envir, simplify = F)}
\CommentTok{\#   \}}
\CommentTok{\#   sections}
\CommentTok{\# \}}

\CommentTok{\#\textquotesingle{} @export .workflow\_name}
\NormalTok{.workflow\_name }\OtherTok{\textless{}{-}}
  \FunctionTok{substitute}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\StringTok{"Abstract"} \OtherTok{=} \DecValTok{1}\NormalTok{, }\StringTok{"Introduction"} \OtherTok{=} \DecValTok{1}\NormalTok{, }\StringTok{"Set{-}up"} \OtherTok{=} \DecValTok{1}\NormalTok{,}
      \StringTok{"Integrate data and Create Nebulae"} \OtherTok{=} \DecValTok{1}\NormalTok{,}
      \StringTok{"Initialize analysis"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Filter candidates"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Filter chemical classes"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Create Nebulae"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Visualize Nebulae"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Nebulae for Downstream analysis"} \OtherTok{=} \DecValTok{1}\NormalTok{,}
      \StringTok{"Statistic analysis"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Set tracer in Child{-}Nebulae"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Quantification in Child{-}Nebulae"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Annotate Nebulae"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Query compounds"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Pathway enrichment"} \OtherTok{=} \DecValTok{2}\NormalTok{,}
      \StringTok{"Session infomation"} \OtherTok{=} \DecValTok{1}
\NormalTok{      ))}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-exreport2.r}{%
\section{File: exReport2.R}\label{file-exreport2.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# for conversion of \textquotesingle{}report\textquotesingle{}}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}



\NormalTok{as\_report.rough }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines) \{}
\NormalTok{  yaml.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}{-}{-}{-}"}\NormalTok{, lines)}
\NormalTok{  yaml.pos }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(yaml.pos[}\DecValTok{2}\NormalTok{])}
\NormalTok{  yaml }\OtherTok{\textless{}{-}}\NormalTok{ lines[ yaml.pos ]}
\NormalTok{  lines }\OtherTok{\textless{}{-}}\NormalTok{ lines[}\SpecialCharTok{{-}}\NormalTok{yaml.pos]}
  \FunctionTok{new\_report}\NormalTok{(lines, }\AttributeTok{yaml =}\NormalTok{ yaml)}
\NormalTok{\}}

\NormalTok{write\_biocStyle }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{  report, savename, title, }\AttributeTok{change\_include\_fun =} \StringTok{"inclu.fig"}\NormalTok{,}
  \AttributeTok{bioyml =} \FunctionTok{readLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/"}\NormalTok{, }\StringTok{"biocstyle.yml"}\NormalTok{)),}
  \AttributeTok{origin\_include\_fun =} \StringTok{"knitr::include\_graphics"}\NormalTok{,}
  \AttributeTok{render =}\NormalTok{ rmarkdown}\SpecialCharTok{::}\NormalTok{render,}
  \AttributeTok{bib =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{\{}
  \FunctionTok{require}\NormalTok{(}\StringTok{"MCnebula2"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.character}\NormalTok{(report)) \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(report)) \{}
\NormalTok{      report }\OtherTok{\textless{}{-}} \FunctionTok{as\_report.rough}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(report))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
      \FunctionTok{stop}\NormalTok{( }\StringTok{"file.exists(report) == F"}\NormalTok{ )}
\NormalTok{    \}}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(x }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}title:"}\NormalTok{, bioyml)) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    bioyml }\OtherTok{\textless{}{-}}\NormalTok{ bioyml[}\SpecialCharTok{{-}}\NormalTok{x]}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(title)) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}title: "}\NormalTok{, title)) \{}
\NormalTok{      title }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"title: "}\NormalTok{, title)}
\NormalTok{    \}}
\NormalTok{    bioyml }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(title, bioyml)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(bib)) \{}
\NormalTok{    bioyml }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(bibliography:).*"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1 "}\NormalTok{, bib), bioyml)}
\NormalTok{  \}}
  \FunctionTok{yaml}\NormalTok{(report) }\OtherTok{\textless{}{-}}\NormalTok{ bioyml}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{call\_command}\NormalTok{(report)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(change\_include\_fun)) \{}
\NormalTok{    lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(origin\_include\_fun, change\_include\_fun, lines)}
\NormalTok{  \}}
  \FunctionTok{writeLines}\NormalTok{(lines, savename)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.function}\NormalTok{(render)) \{}
    \FunctionTok{render}\NormalTok{(savename)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{write\_thesisDocx }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(report, savename, title,}
  \AttributeTok{change\_include\_fun =} \StringTok{"inclu.fig"}\NormalTok{,}
  \AttributeTok{yml =} \FunctionTok{readLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/"}\NormalTok{, }\StringTok{"ch\_thesis.yml"}\NormalTok{)),}
  \AttributeTok{origin\_include\_fun =} \StringTok{"knitr::include\_graphics"}\NormalTok{, ...)}
\NormalTok{\{}
  \FunctionTok{write\_biocStyle}\NormalTok{(report, savename, title, change\_include\_fun, yml, origin\_include\_fun, ...)}
\NormalTok{\}}

\NormalTok{write\_thesisDocxEn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(report, savename, title,}
  \AttributeTok{change\_include\_fun =} \StringTok{"inclu.fig"}\NormalTok{,}
  \AttributeTok{yml =} \FunctionTok{readLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/"}\NormalTok{, }\StringTok{"en\_thesis.yml"}\NormalTok{)),}
  \AttributeTok{origin\_include\_fun =} \StringTok{"knitr::include\_graphics"}\NormalTok{, ...)}
\NormalTok{\{}
  \FunctionTok{write\_biocStyle}\NormalTok{(report, savename, title, change\_include\_fun, yml, origin\_include\_fun, ...)}
\NormalTok{\}}

\NormalTok{write\_articlePdf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(report, savename, title,}
  \AttributeTok{change\_include\_fun =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{yml =} \FunctionTok{readLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/"}\NormalTok{, }\StringTok{"articleWithCode.yml"}\NormalTok{)),}
  \AttributeTok{origin\_include\_fun =} \StringTok{"knitr::include\_graphics"}\NormalTok{, ...)}
\NormalTok{\{}
  \FunctionTok{write\_biocStyle}\NormalTok{(report, savename, title, change\_include\_fun, yml, origin\_include\_fun, ...)}
\NormalTok{\}}

\NormalTok{kable\_less }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, ...) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(x) }\SpecialCharTok{\textgreater{}} \DecValTok{50}\NormalTok{) \{}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(x, }\AttributeTok{n =} \DecValTok{25}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{kable}\NormalTok{(x, ...)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-find_latest_script.r}{%
\section{File: find\_latest\_script.R}\label{file-find_latest_script.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{find\_latest\_script }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/outline"}\NormalTok{,}
           \AttributeTok{pattern =} \StringTok{".*R$"}
\NormalTok{           )\{}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path,}
                     \AttributeTok{pattern =}\NormalTok{ pattern,}
                     \AttributeTok{full.names =}\NormalTok{ T, }\AttributeTok{recursive =}\NormalTok{ T)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{file.info}\NormalTok{(set) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{file =} \FunctionTok{rownames}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{relocate}\NormalTok{(file) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(mtime)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{ssource }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/outline"}\NormalTok{,}
           \AttributeTok{pattern =} \StringTok{".*R$"}
\NormalTok{           )\{}
\NormalTok{    script }\OtherTok{\textless{}{-}} \FunctionTok{find\_latest\_script}\NormalTok{(path, pattern)}\SpecialCharTok{$}\NormalTok{file[}\DecValTok{1}\NormalTok{]}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO]: Latest script is:"}\NormalTok{, script, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{source}\NormalTok{(script)}
\NormalTok{  \}}
\NormalTok{rrender }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/outline"}\NormalTok{,}
           \AttributeTok{pattern =} \StringTok{"md$"}\NormalTok{,}
           \AttributeTok{format =} \StringTok{"pdf\_document"}
\NormalTok{           )\{}
\NormalTok{    script }\OtherTok{\textless{}{-}} \FunctionTok{find\_latest\_script}\NormalTok{(path, pattern)}\SpecialCharTok{$}\NormalTok{file[}\DecValTok{1}\NormalTok{]}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO]: Latest script is:"}\NormalTok{, script, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(script, format)}
\NormalTok{  \}}
\NormalTok{msource }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/outline"}\NormalTok{,}
           \AttributeTok{pattern =} \StringTok{".*R$"}\NormalTok{,}
           \AttributeTok{block =} \StringTok{"\^{}\#\# {-}\{1,\}"}\NormalTok{,}
           \AttributeTok{symbol =} \StringTok{"\^{}\#\# ========== Run block =========="}\NormalTok{,}
           \AttributeTok{extra =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{script =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{CODE =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{source =}\NormalTok{ T}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(script))}
\NormalTok{      script }\OtherTok{\textless{}{-}} \FunctionTok{find\_latest\_script}\NormalTok{(path, pattern)}\SpecialCharTok{$}\NormalTok{file[}\DecValTok{1}\NormalTok{]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(CODE) }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&} \FunctionTok{is.na}\NormalTok{(CODE[}\DecValTok{1}\NormalTok{]))\{}
\NormalTok{      CODE }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{file =}\NormalTok{ script, }\AttributeTok{header =}\NormalTok{ F, }\AttributeTok{sep =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.data.frame}\NormalTok{(CODE))\{}
\NormalTok{      CODE }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(CODE)}
\NormalTok{    \}}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ CODE }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{code =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{valid =} \FunctionTok{ifelse}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(block, code), T, F),}
                    \AttributeTok{valid =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(symbol, code), T, valid),}
                    \AttributeTok{row =} \FunctionTok{rownames}\NormalTok{(.),}
                    \AttributeTok{line =} \FunctionTok{ifelse}\NormalTok{(valid, row, }\StringTok{","}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    cluster }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{line, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{gsub}\NormalTok{(}\StringTok{",\{2,\}"}\NormalTok{, }\StringTok{"{-}"}\NormalTok{, .) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{strsplit}\NormalTok{(}\AttributeTok{split =} \StringTok{"{-}"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{strsplit}\NormalTok{(}\AttributeTok{split =} \StringTok{","}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(as.numeric)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{source)}
      \FunctionTok{return}\NormalTok{(cluster)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    run.block }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(symbol, df}\SpecialCharTok{$}\NormalTok{code)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(class) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      run.block }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{code)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(extra))\{}
\NormalTok{      run.block }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(run.block, extra)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    script }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(cluster,}
                     \ControlFlowTok{function}\NormalTok{(vec)\{}
                       \ControlFlowTok{if}\NormalTok{(T }\SpecialCharTok{\%in\%}\NormalTok{ (run.block }\SpecialCharTok{\%in\%}\NormalTok{ vec))}
                         \FunctionTok{return}\NormalTok{(vec)}
\NormalTok{                     \}) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{code[.] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{paste}\NormalTok{(}\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ .)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{source}\NormalTok{(}\AttributeTok{exprs =}\NormalTok{ script)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \CommentTok{\# source(exprs = parse(text = script))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-flowchart.r}{%
\section{File: flowChart.R}\label{file-flowchart.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# help with drawing flow chart}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{sortSugi }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(values, }\AttributeTok{dec =}\NormalTok{ T) \{}
\NormalTok{  num }\OtherTok{\textless{}{-}}\NormalTok{ values}
\NormalTok{  i }\OtherTok{\textless{}{-}}\NormalTok{ 1L}
\NormalTok{  order }\OtherTok{\textless{}{-}} \FunctionTok{order}\NormalTok{(values, }\AttributeTok{decreasing =}\NormalTok{ dec)}
\NormalTok{  num[order] }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(num[order],}
    \AttributeTok{FUN.VALUE =} \FunctionTok{integer}\NormalTok{(}\DecValTok{1}\NormalTok{),}
    \ControlFlowTok{function}\NormalTok{(value) \{}
\NormalTok{      x }\OtherTok{\textless{}{-}}\NormalTok{ i}
\NormalTok{      i }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ i }\SpecialCharTok{+}\NormalTok{ 1L}
      \FunctionTok{return}\NormalTok{(x)}
\NormalTok{    \})}
\NormalTok{  num}
\NormalTok{\}}

\NormalTok{as\_network }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst, }\AttributeTok{layout =} \StringTok{\textquotesingle{}sugiyama\textquotesingle{}}\NormalTok{, }\AttributeTok{seed =} \DecValTok{100}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(ch) }\FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, ch), }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"::"}\NormalTok{, lst))) \{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(lst,}
        \ControlFlowTok{function}\NormalTok{(ch) \{}
          \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"::"}\NormalTok{, ch)) \{}
\NormalTok{            ch }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(ch, }\StringTok{"::"}\NormalTok{)[[ }\DecValTok{1}\NormalTok{ ]]}
\NormalTok{            ch }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(ch, }\AttributeTok{collapse =} \StringTok{":"}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\FunctionTok{rev}\NormalTok{(ch), }\AttributeTok{collapse =} \StringTok{":"}\NormalTok{))}
\NormalTok{          \} }\ControlFlowTok{else}\NormalTok{ ch}
\NormalTok{        \}))}
\NormalTok{  \}}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(lst, }\StringTok{":"}\NormalTok{)}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst,}
    \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{      ch }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(ch, }\StringTok{","}\NormalTok{)}
      \FunctionTok{names}\NormalTok{(ch) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"from"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\FunctionTok{n}\NormalTok{(attr, }\FunctionTok{length}\NormalTok{(ch) }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{))}
      \FunctionTok{do.call}\NormalTok{(data.frame, ch)}
\NormalTok{    \})}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(seed)) \{}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(seed,}
      \ControlFlowTok{function}\NormalTok{(s) \{}
        \FunctionTok{set.seed}\NormalTok{(s)}
        \FunctionTok{fast\_layout}\NormalTok{(data, layout)}
\NormalTok{      \})}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(seed) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ data[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{  \}}
\NormalTok{  data}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @import ggplot2}
\NormalTok{flowChart }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(graph, }\AttributeTok{scale.x =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{scale.y =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{node.size =} \DecValTok{4}\NormalTok{,}
  \AttributeTok{sc =} \DecValTok{8}\NormalTok{, }\AttributeTok{ec =} \DecValTok{8}\NormalTok{, }\AttributeTok{arr.len =} \DecValTok{2}\NormalTok{, }\AttributeTok{edge.color =} \StringTok{\textquotesingle{}lightblue\textquotesingle{}}\NormalTok{, }\AttributeTok{edge.width =} \DecValTok{1}\NormalTok{)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is}\NormalTok{(graph, }\StringTok{"layout\_tbl\_graph"}\NormalTok{)) \{}
\NormalTok{    graphs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(graph)}
\NormalTok{    num }\OtherTok{\textless{}{-}}\NormalTok{ 1L}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    graphs }\OtherTok{\textless{}{-}}\NormalTok{ graph}
\NormalTok{    num }\OtherTok{\textless{}{-}}\NormalTok{ 2L}
\NormalTok{  \}}
\NormalTok{  p.lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(graphs,}
    \ControlFlowTok{function}\NormalTok{(graph) \{}
\NormalTok{      p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(graph) }\SpecialCharTok{+}
        \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y),}
          \AttributeTok{start\_cap =} \FunctionTok{circle}\NormalTok{(sc, }\StringTok{\textquotesingle{}mm\textquotesingle{}}\NormalTok{),}
          \AttributeTok{end\_cap =} \FunctionTok{circle}\NormalTok{(ec, }\StringTok{\textquotesingle{}mm\textquotesingle{}}\NormalTok{),}
          \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(arr.len, }\StringTok{\textquotesingle{}mm\textquotesingle{}}\NormalTok{)),}
          \AttributeTok{color =}\NormalTok{ edge.color, }\AttributeTok{width =}\NormalTok{ edge.width) }\SpecialCharTok{+}
        \FunctionTok{geom\_node\_label}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{sortSugi}\NormalTok{(y), }\StringTok{". "}\NormalTok{, name)),}
          \AttributeTok{size =}\NormalTok{ node.size, }\AttributeTok{label.padding =} \FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, lines)) }\SpecialCharTok{+}
        \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{zoRange}\NormalTok{(graph}\SpecialCharTok{$}\NormalTok{x, scale.x)) }\SpecialCharTok{+}
        \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{zoRange}\NormalTok{(graph}\SpecialCharTok{$}\NormalTok{y, scale.y)) }\SpecialCharTok{+}
        \FunctionTok{theme\_void}\NormalTok{()}
\NormalTok{      p}
\NormalTok{    \})}
  \ControlFlowTok{if}\NormalTok{ (num }\SpecialCharTok{==}\NormalTok{ 1L) \{}
    \FunctionTok{return}\NormalTok{(p.lst[[}\DecValTok{1}\NormalTok{]])}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{preview.gl}\NormalTok{(p.lst)}
\NormalTok{  \}}
\NormalTok{  p.lst}
\NormalTok{\}}

\NormalTok{preview.gl }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p.lst) \{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(p.lst, as\_grob)}
  \FunctionTok{names}\NormalTok{(lst) }\OtherTok{\textless{}{-}} \FunctionTok{n}\NormalTok{(p, }\FunctionTok{length}\NormalTok{(lst))}
\NormalTok{  panel }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(}\FunctionTok{fill\_list}\NormalTok{(}\FunctionTok{names}\NormalTok{(lst), }\DecValTok{1}\NormalTok{), lst)}
\NormalTok{  legend }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(lst), }\AttributeTok{simplify =}\NormalTok{ F, gtext, }\AttributeTok{gp\_arg =} \FunctionTok{list}\NormalTok{(}\AttributeTok{cex =} \DecValTok{2}\NormalTok{))}
\NormalTok{  legend }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(}\FunctionTok{fill\_list}\NormalTok{(}\FunctionTok{names}\NormalTok{(legend), }\DecValTok{1}\NormalTok{), legend)}
\NormalTok{  frame }\OtherTok{\textless{}{-}} \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{legend =} \DecValTok{1}\NormalTok{, }\AttributeTok{panel =} \DecValTok{5}\NormalTok{), }\FunctionTok{namel}\NormalTok{(panel, legend))}
  \FunctionTok{dev.new}\NormalTok{(}\AttributeTok{width =} \DecValTok{20}\NormalTok{)}
  \FunctionTok{draw}\NormalTok{(frame)}
\NormalTok{\}}

\NormalTok{zoRange }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{ (x, factor) }
\NormalTok{\{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{range}\NormalTok{(x)}
\NormalTok{  ex }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{]) }\SpecialCharTok{*}\NormalTok{ (factor }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{  x[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ ex}
\NormalTok{  x[}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ x[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ ex}
  \FunctionTok{return}\NormalTok{(x)}
\NormalTok{\}}

\NormalTok{ll }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(str, }\AttributeTok{sep =} \StringTok{":"}\NormalTok{, }\AttributeTok{link =} \StringTok{":"}\NormalTok{) \{}
\NormalTok{  strs }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(str, }\AttributeTok{split =}\NormalTok{ sep)[[ }\DecValTok{1}\NormalTok{ ]]}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
  \FunctionTok{length}\NormalTok{(lst) }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(strs) }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(strs) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)) \{}
\NormalTok{    lst[[ i ]] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(strs[i], }\StringTok{":"}\NormalTok{, strs[i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{])}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(lst)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generate_slidy.r}{%
\section{File: generate\_slidy.R}\label{file-generate_slidy.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# slidy}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{generate\_slidy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, }\AttributeTok{path =} \StringTok{"/mnt/data/wizard/Documents/zcmu\_reports"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".Rmd"}\NormalTok{)}
\NormalTok{  meta }\OtherTok{\textless{}{-}} \FunctionTok{generate\_slidy\_meta}\NormalTok{()}
  \FunctionTok{cat}\NormalTok{(meta, }\AttributeTok{file =}\NormalTok{ file)}
\NormalTok{\}}

\NormalTok{make\_slidy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, }\AttributeTok{path =} \StringTok{"/mnt/data/wizard/Documents/zcmu\_reports"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".Rmd"}\NormalTok{)}
\NormalTok{  rmarkdown}\SpecialCharTok{::}\FunctionTok{render}\NormalTok{(file)}
\NormalTok{\}}

\NormalTok{preprocess\_bib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/library.bib"}\NormalTok{)) \{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{read\_bib}\NormalTok{(file)}
\NormalTok{  which }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}@[0{-}9]*$"}\NormalTok{, }\FunctionTok{names}\NormalTok{(lst))}
\NormalTok{  lst[which] }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst[which],}
    \ControlFlowTok{function}\NormalTok{(l) \{}
\NormalTok{      l[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{"}\NormalTok{, }\StringTok{"\{FIXN"}\NormalTok{, l[}\DecValTok{1}\NormalTok{])}
      \FunctionTok{return}\NormalTok{(l)}
\NormalTok{    \})}
  \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(lst), }\StringTok{"library.bib"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{reload\_bib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{file =} \StringTok{"library.bib"}\NormalTok{,}
  \AttributeTok{exclude =} \FunctionTok{c}\NormalTok{(}\StringTok{"doi"}\NormalTok{, }\StringTok{"urldate"}\NormalTok{, }\StringTok{"issn"}\NormalTok{, }\StringTok{"address"}\NormalTok{, }\StringTok{"isbn"}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  bib }\OtherTok{\textless{}{-}}\NormalTok{ bibtex}\SpecialCharTok{::}\FunctionTok{read.bib}\NormalTok{(file)}
\NormalTok{  bib }\OtherTok{\textless{}{-}} \FunctionTok{fix\_bib}\NormalTok{(bib, exclude)}
  \FunctionTok{assign}\NormalTok{(}\StringTok{".bib"}\NormalTok{, bib, }\AttributeTok{envir =} \FunctionTok{topenv}\NormalTok{())}
\NormalTok{\}}

\NormalTok{fix\_bib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(bib, }\AttributeTok{exclude =} \FunctionTok{c}\NormalTok{(}\StringTok{"doi"}\NormalTok{, }\StringTok{"urldate"}\NormalTok{, }\StringTok{"issn"}\NormalTok{, }\StringTok{"address"}\NormalTok{, }\StringTok{"isbn"}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  bib }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(bib,}
    \ControlFlowTok{function}\NormalTok{(b) \{}
\NormalTok{      expr }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"b$"}\NormalTok{, exclude, }\StringTok{" \textless{}{-} NULL"}\NormalTok{), }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ expr))}
      \FunctionTok{return}\NormalTok{(b)}
\NormalTok{    \})}
\NormalTok{  bib }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(c, bib)}
  \FunctionTok{return}\NormalTok{(bib)}
\NormalTok{\}}

\NormalTok{citethis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(..., }\AttributeTok{trunc =}\NormalTok{ T, }\AttributeTok{trunc.author =} \DecValTok{1}\NormalTok{, }\AttributeTok{trunc.title =}\NormalTok{ F,}
  \AttributeTok{prefix =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{tiny "}\NormalTok{, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{vspace\{0.5em\} }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{newline}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{,}
  \AttributeTok{pkgs =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{pkgs.fix =}\NormalTok{ fix\_bib, }\AttributeTok{exbibentry =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{postFun =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  keys }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(keys) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    keys }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(keys,}
      \ControlFlowTok{function}\NormalTok{(ch) \{}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.numeric}\NormalTok{(ch) }\SpecialCharTok{|} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[0{-}9]*$"}\NormalTok{, ch)) \{}
          \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"FIXN"}\NormalTok{, ch))}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{          ch}
\NormalTok{        \}}
\NormalTok{      \}, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{    keys }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(keys, }\StringTok{"."}\NormalTok{, keys)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{exists}\NormalTok{(}\StringTok{".bib"}\NormalTok{, }\AttributeTok{where =} \FunctionTok{topenv}\NormalTok{())) \{}
      \FunctionTok{reload\_bib}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    all }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(.bib)}
\NormalTok{    bib }\OtherTok{\textless{}{-}}\NormalTok{ .bib[ }\FunctionTok{match}\NormalTok{(keys, all) ]}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    bib }\OtherTok{\textless{}{-}} \FunctionTok{bibentry}\NormalTok{()}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(pkgs)) \{}
\NormalTok{    bib.pkg }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(pkgs,}
      \ControlFlowTok{function}\NormalTok{(pkg) \{}
        \FunctionTok{c}\NormalTok{(}\FunctionTok{citation}\NormalTok{(pkg))}
\NormalTok{      \})}
\NormalTok{    bib.pkg }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(c, bib.pkg)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(pkgs.fix)) \{}
\NormalTok{      bib.pkg }\OtherTok{\textless{}{-}} \FunctionTok{pkgs.fix}\NormalTok{(bib.pkg)}
\NormalTok{    \}}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    bib.pkg }\OtherTok{\textless{}{-}} \FunctionTok{bibentry}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{  bib }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(bib, bib.pkg)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(exbibentry)) \{}
\NormalTok{    bib }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(bib, exbibentry)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (trunc) \{}
\NormalTok{    bib }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(bib,}
      \ControlFlowTok{function}\NormalTok{(b) \{}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(b}\SpecialCharTok{$}\NormalTok{author) }\SpecialCharTok{\textgreater{}}\NormalTok{ trunc.author) \{}
\NormalTok{          b}\SpecialCharTok{$}\NormalTok{author }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(b}\SpecialCharTok{$}\NormalTok{author[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{trunc.author], }\FunctionTok{person}\NormalTok{(}\StringTok{"et al."}\NormalTok{))}
\NormalTok{        \}}
        \ControlFlowTok{if}\NormalTok{ (trunc.title) \{}
\NormalTok{          b}\SpecialCharTok{$}\NormalTok{title }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_trunc}\NormalTok{(}\FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{, }\StringTok{""}\NormalTok{, b}\SpecialCharTok{$}\NormalTok{title), }\DecValTok{20}\NormalTok{)}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{          b}\SpecialCharTok{$}\NormalTok{title }\OtherTok{\textless{}{-}} \StringTok{"\#"}\NormalTok{;}
\NormalTok{        \}}
\NormalTok{        b}\SpecialCharTok{$}\NormalTok{number }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{        b}\SpecialCharTok{$}\NormalTok{volume }\OtherTok{\textless{}{-}} \ConstantTok{NULL}\NormalTok{;}
\NormalTok{        b}\SpecialCharTok{$}\NormalTok{pages }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
        \FunctionTok{return}\NormalTok{(b)}
\NormalTok{      \})}
\NormalTok{    bib }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(c, bib)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(bib))}
    \FunctionTok{writeLines}\NormalTok{(prefix)}
\NormalTok{  text }\OtherTok{\textless{}{-}} \FunctionTok{format}\NormalTok{(bib, }\StringTok{"text"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{trunc.title) \{}
\NormalTok{    text }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"[}\SpecialCharTok{\textbackslash{}"}\StringTok{“”\#]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.*"}\NormalTok{, }\StringTok{""}\NormalTok{, text)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(postFun)) \{}
\NormalTok{    text }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(text, postFun, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \}}
  \FunctionTok{writeLines}\NormalTok{(text, }\AttributeTok{sep =}\NormalTok{ sep)}
\NormalTok{\}}

\NormalTok{testSection }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, pattern, }\AttributeTok{level =} \DecValTok{2}\NormalTok{, }\AttributeTok{render =}\NormalTok{ rmarkdown}\SpecialCharTok{::}\NormalTok{render) \{}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  yml }\OtherTok{\textless{}{-}} \FunctionTok{getyml}\NormalTok{(lines)}
\NormalTok{  getSecPos }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines, level) \{}
\NormalTok{    pattern }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\#\{"}\NormalTok{, level, }\StringTok{"\}[\^{}\#]"}\NormalTok{))}
    \FunctionTok{grep}\NormalTok{(pattern, lines)}
\NormalTok{  \}}
\NormalTok{  sec.pos }\OtherTok{\textless{}{-}} \FunctionTok{getSecPos}\NormalTok{(lines, level)}
\NormalTok{  tar.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(pattern, lines)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(tar.pos) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"length(tar.pos) == 0"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(tar.pos) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{warning}\NormalTok{(}\StringTok{"length(tar.pos) \textgreater{} 1"}\NormalTok{)}
\NormalTok{    tar.pos }\OtherTok{\textless{}{-}}\NormalTok{ tar.pos[}\DecValTok{1}\NormalTok{]}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (tar.pos }\SpecialCharTok{\textless{}}\NormalTok{ (yend }\OtherTok{\textless{}{-}} \FunctionTok{attr}\NormalTok{(yml, }\StringTok{"pos"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{end)) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"tar.pos \textless{} attr(yml, \textquotesingle{}pos\textquotesingle{})$end"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(sec.pos }\SpecialCharTok{==}\NormalTok{ tar.pos)) \{}
\NormalTok{    start.pos }\OtherTok{\textless{}{-}}\NormalTok{ tar.pos}
    \ControlFlowTok{if}\NormalTok{ (level }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) sec.pos }\OtherTok{\textless{}{-}} \FunctionTok{getSecPos}\NormalTok{(lines, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"1,"}\NormalTok{, level))}
\NormalTok{    end.pos }\OtherTok{\textless{}{-}}\NormalTok{ sec.pos[}\FunctionTok{head}\NormalTok{(}\FunctionTok{which}\NormalTok{(sec.pos }\SpecialCharTok{\textgreater{}}\NormalTok{ tar.pos), }\AttributeTok{n =} \DecValTok{1}\NormalTok{)]}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    start.pos }\OtherTok{\textless{}{-}}\NormalTok{ sec.pos[}\FunctionTok{tail}\NormalTok{(}\FunctionTok{which}\NormalTok{(sec.pos }\SpecialCharTok{\textless{}}\NormalTok{ tar.pos), }\AttributeTok{n =} \DecValTok{1}\NormalTok{)]}
    \ControlFlowTok{if}\NormalTok{ (level }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) sec.pos }\OtherTok{\textless{}{-}} \FunctionTok{getSecPos}\NormalTok{(lines, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"1,"}\NormalTok{, level))}
\NormalTok{    end.pos }\OtherTok{\textless{}{-}}\NormalTok{ sec.pos[}\FunctionTok{head}\NormalTok{(}\FunctionTok{which}\NormalTok{(sec.pos }\SpecialCharTok{\textgreater{}}\NormalTok{ tar.pos), }\AttributeTok{n =} \DecValTok{1}\NormalTok{)]}
\NormalTok{  \}}
\NormalTok{  end.pos }\OtherTok{\textless{}{-}}\NormalTok{ end.pos }\SpecialCharTok{{-}} \DecValTok{1}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(start.pos) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    start.pos }\OtherTok{\textless{}{-}}\NormalTok{ yend }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (start.pos }\SpecialCharTok{\textgreater{}} \FunctionTok{length}\NormalTok{(lines)) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"start.pos \textgreater{} length(lines)"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(end.pos) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    end.pos }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(lines)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (end.pos }\SpecialCharTok{\textless{}}\NormalTok{ start.pos) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"end.pos \textless{} start.pos"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  content }\OtherTok{\textless{}{-}}\NormalTok{ lines[ start.pos}\SpecialCharTok{:}\NormalTok{end.pos ]}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(yml, }\StringTok{""}\NormalTok{, content)}
  \FunctionTok{writeLines}\NormalTok{(lines, nfile }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\_temptest\_"}\NormalTok{, }\FunctionTok{get\_filename}\NormalTok{(file)))}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(render)) \{}
\NormalTok{    output }\OtherTok{\textless{}{-}} \FunctionTok{render}\NormalTok{(nfile)}
    \FunctionTok{op}\NormalTok{(output)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{getyml }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines) \{}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}{-}{-}{-}"}\NormalTok{, lines)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(pos) }\SpecialCharTok{!=} \DecValTok{2}\NormalTok{) \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"length(pos) != 2"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  yml }\OtherTok{\textless{}{-}}\NormalTok{ lines[pos[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\NormalTok{pos[}\DecValTok{2}\NormalTok{]]}
  \FunctionTok{attr}\NormalTok{(yml, }\StringTok{"pos"}\NormalTok{) }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{start =}\NormalTok{ pos[}\DecValTok{1}\NormalTok{], }\AttributeTok{end =}\NormalTok{ pos[}\DecValTok{2}\NormalTok{])}
\NormalTok{  yml}
\NormalTok{\}}

\NormalTok{arrange\_figsPath }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{pattern =} \StringTok{"\^{}!}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\AttributeTok{to =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{overwrite =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  path }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(file)}
\NormalTok{  filename }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(file)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(to)) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{dir.exists}\NormalTok{(to)) \{}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"dir.exists(to) == F"}\NormalTok{)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      dir }\OtherTok{\textless{}{-}}\NormalTok{ to}
\NormalTok{    \}}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, }\FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.[a{-}zA{-}Z]*$"}\NormalTok{, }\StringTok{""}\NormalTok{, filename))}
\NormalTok{  \}}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(pattern, lines)}
\NormalTok{  fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{    line }\OtherTok{\textless{}{-}}\NormalTok{ lines[n]}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\StringTok{""}\NormalTok{, stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(line, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{().*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{))"}\NormalTok{))}
\NormalTok{    filename }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(file)}
\NormalTok{    nfile }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, filename)}
\NormalTok{    line }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"]("}\NormalTok{, nfile, }\StringTok{")"}\NormalTok{), line)}
    \FunctionTok{file.copy}\NormalTok{(file, dir, overwrite)}
\NormalTok{    line}
\NormalTok{  \}}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ pos) \{}
\NormalTok{    lines[i] }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(i)}
\NormalTok{  \}}
  \FunctionTok{writeLines}\NormalTok{(lines, file)}
\NormalTok{\}}

\NormalTok{latexfig }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{caption =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{scale.width =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{scale.height =} \FloatTok{0.45}\NormalTok{)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, file)) \{}
\NormalTok{    info }\OtherTok{\textless{}{-}}\NormalTok{ pdftools}\SpecialCharTok{::}\FunctionTok{pdf\_pagesize}\NormalTok{(file)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    info }\OtherTok{\textless{}{-}} \FunctionTok{bitmap\_info}\NormalTok{(file)}
\NormalTok{  \}}
\NormalTok{  ratio }\OtherTok{\textless{}{-}}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{width }\SpecialCharTok{/}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{height}
\NormalTok{  width }\OtherTok{\textless{}{-}} \FunctionTok{normSize}\NormalTok{(ratio, }\FunctionTok{list}\NormalTok{(}\AttributeTok{width =}\NormalTok{ scale.width, }\AttributeTok{height =}\NormalTok{ scale.height))}\SpecialCharTok{$}\NormalTok{width}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"::: \{.col data{-}latex=}\SpecialCharTok{\textbackslash{}"}\StringTok{\{"}\NormalTok{, }\FunctionTok{round}\NormalTok{(width, }\DecValTok{2}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{textwidth\}}\SpecialCharTok{\textbackslash{}"}\StringTok{\}"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"!["}\NormalTok{, caption, }\StringTok{"]("}\NormalTok{, file, }\StringTok{")"}\NormalTok{),}
    \StringTok{":::"}\NormalTok{)}
  \FunctionTok{writeLines}\NormalTok{(md)}
\NormalTok{\}}

\NormalTok{hlName }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(text, }\AttributeTok{name =} \StringTok{"Huang L"}\NormalTok{) \{}
  \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"("}\NormalTok{, name, }\StringTok{")"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{underline\{}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{textbf\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1\}\}"}\NormalTok{, text)}
\NormalTok{\}}

\NormalTok{normSize }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ratio, scale)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ ((scale}\SpecialCharTok{$}\NormalTok{width }\SpecialCharTok{/}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{height) }\SpecialCharTok{\textgreater{}=}\NormalTok{ ratio) \{}
    \DocumentationTok{\#\# height as reference}
\NormalTok{    height }\OtherTok{\textless{}{-}}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{height}
\NormalTok{    width }\OtherTok{\textless{}{-}}\NormalTok{ height }\SpecialCharTok{*}\NormalTok{ ratio}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \DocumentationTok{\#\# width as reference}
\NormalTok{    width }\OtherTok{\textless{}{-}}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{width}
\NormalTok{    height }\OtherTok{\textless{}{-}}\NormalTok{ width }\SpecialCharTok{/}\NormalTok{ ratio}
\NormalTok{  \}}
  \FunctionTok{list}\NormalTok{(}\AttributeTok{height =}\NormalTok{ height, }\AttributeTok{width =}\NormalTok{ width)}
\NormalTok{\}}

\NormalTok{bitmap\_info }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file) \{}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(file)}
\NormalTok{  info }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_info}\NormalTok{(img)}
\NormalTok{  magick}\SpecialCharTok{::}\FunctionTok{image\_destroy}\NormalTok{(img)}
\NormalTok{  info}
\NormalTok{\}}

\NormalTok{get\_title }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file) \{}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\#"}\NormalTok{, lines)}
\NormalTok{  lines[pos]}
\NormalTok{\} }
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_hierarchy.in_df.r}{%
\section{File: get\_hierarchy.in\_df.R}\label{file-get_hierarchy.in_df.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_hierarchy.in\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{col =} \StringTok{"Classification"}
\NormalTok{           )\{}
\NormalTok{    deep }\OtherTok{\textless{}{-}} \FunctionTok{mutate\_get\_parent\_class}\NormalTok{(df[[col]], }\AttributeTok{class\_cutof =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(vec)\{}\FunctionTok{length}\NormalTok{(vec) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{\}) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{hierarchy =} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ col)),}
                                           \ControlFlowTok{function}\NormalTok{(class)\{}
\NormalTok{                                             deep[[class]]}
\NormalTok{                                           \})))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_metadata_from_names.r}{%
\section{File: get\_metadata\_from\_names.R}\label{file-get_metadata_from_names.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_metadata\_from\_names }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           names,}
\NormalTok{           meta.group}
\NormalTok{           )\{}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ meta.group }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(vec)\{}
\NormalTok{               str }\OtherTok{\textless{}{-}} \FunctionTok{.meta\_find\_and\_sort}\NormalTok{(names, vec)}
\NormalTok{           \})}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(metadata, }\FunctionTok{names}\NormalTok{(metadata), }\AttributeTok{SIMPLIFY =}\NormalTok{ F,}
                       \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(vec, name)\{}
\NormalTok{                         df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{group =}\NormalTok{ name, }\AttributeTok{sample =}\NormalTok{ vec)}
                         \FunctionTok{return}\NormalTok{(df)}
\NormalTok{                       \})}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(metadata)}
    \FunctionTok{return}\NormalTok{(metadata)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-grid_draw.r}{%
\section{File: grid\_draw.R}\label{file-grid_draw.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# class}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}
\CommentTok{\#\textquotesingle{} @exportClass graph}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @aliases graph}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title A class built on \textquotesingle{}grobs\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @rdname graph{-}class}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @examples}
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} new(\textquotesingle{}graph\textquotesingle{}, ...)}
\CommentTok{\#\textquotesingle{} \}}
\NormalTok{graph }\OtherTok{\textless{}{-}} 
  \FunctionTok{setClass}\NormalTok{(}\StringTok{"graph"}\NormalTok{, }
    \AttributeTok{contains =} \FunctionTok{character}\NormalTok{(),}
    \AttributeTok{representation =} 
      \FunctionTok{representation}\NormalTok{(}\AttributeTok{grob =} \StringTok{"ANY"}\NormalTok{,}
        \AttributeTok{cvp =} \StringTok{"ANY"}
\NormalTok{        ),}
      \AttributeTok{prototype =} \ConstantTok{NULL}
\NormalTok{  )}

\NormalTok{.grob\_class }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"grob"}\NormalTok{, }\StringTok{"frame"}\NormalTok{, }\StringTok{"gTree"}\NormalTok{, }\StringTok{"null"}\NormalTok{,}
  \StringTok{"text"}\NormalTok{, }\StringTok{"circle"}\NormalTok{, }\StringTok{"segments"}\NormalTok{, }\StringTok{"gtable"}\NormalTok{,}
  \StringTok{"curve"}\NormalTok{, }\StringTok{"polygon"}\NormalTok{, }\StringTok{"rastergrob"}\NormalTok{)}
\FunctionTok{setOldClass}\NormalTok{(.grob\_class)}
\FunctionTok{setOldClass}\NormalTok{(}\StringTok{"viewport"}\NormalTok{)}
\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"grob.obj"}\NormalTok{, .grob\_class)}

\NormalTok{.gg }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"gg"}\NormalTok{, }\StringTok{"ggplot"}\NormalTok{, }\StringTok{"ggraph"}\NormalTok{)}
\FunctionTok{setOldClass}\NormalTok{(.gg)}
\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"gg.obj"}\NormalTok{, .gg)}

\NormalTok{.class\_unit }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"unit"}\NormalTok{, }\StringTok{"simpleUnit"}\NormalTok{, }\StringTok{"unit\_v2"}\NormalTok{)}
\FunctionTok{setOldClass}\NormalTok{(.class\_unit)}
\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"units"}\NormalTok{, .class\_unit)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# color}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @export .default\_color}
\NormalTok{.default\_color }\OtherTok{\textless{}{-}}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# method}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases draw}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title draw class of \textquotesingle{}graph\textquotesingle{} and \textquotesingle{}grobs\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name draw{-}methods}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"draw"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, content)}
    \FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"draw"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod draw}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"draw"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"graph"}\NormalTok{, }\AttributeTok{content =} \StringTok{"grob.obj"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, content)\{}
    \FunctionTok{grid.draw}\NormalTok{(x}\SpecialCharTok{@}\NormalTok{grob)}
    \FunctionTok{pushViewport}\NormalTok{(x}\SpecialCharTok{@}\NormalTok{cvp)}
    \FunctionTok{grid.draw}\NormalTok{(content)}
    \FunctionTok{upViewport}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod draw}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"draw"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"draw"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"graph"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x)\{}
    \FunctionTok{grid.draw}\NormalTok{(x}\SpecialCharTok{@}\NormalTok{grob)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod draw}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"draw"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"grob.obj"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x)\{}
    \FunctionTok{grid.draw}\NormalTok{(x)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod into}
\CommentTok{\#\textquotesingle{} @title place \textquotesingle{}grobs\textquotesingle{} into \textquotesingle{}graph\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{} @rdname into{-}methods}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"into"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, content) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"into"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod into}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"into"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"graph"}\NormalTok{, }\AttributeTok{content =} \StringTok{"grob.obj"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, content)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(content}\SpecialCharTok{$}\NormalTok{vp)) \{}
\NormalTok{      content}\SpecialCharTok{$}\NormalTok{vp }\OtherTok{\textless{}{-}}\NormalTok{ x}\SpecialCharTok{@}\NormalTok{cvp}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      content}\SpecialCharTok{$}\NormalTok{vp }\OtherTok{\textless{}{-}} \FunctionTok{vpStack}\NormalTok{(x}\SpecialCharTok{@}\NormalTok{cvp, content}\SpecialCharTok{$}\NormalTok{vp)}
\NormalTok{    \}}
    \FunctionTok{gTree}\NormalTok{(}\AttributeTok{children =} \FunctionTok{gList}\NormalTok{(x}\SpecialCharTok{@}\NormalTok{grob, content))}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod setvp}
\CommentTok{\#\textquotesingle{} @title ...}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{} @rdname setvp{-}methods}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"setvp"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, ...) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"setvp"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod setvp}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"setvp"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"ANY"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, ...)\{}
    \FunctionTok{viewport}\NormalTok{(}\FunctionTok{grobX}\NormalTok{(x, }\DecValTok{90}\NormalTok{), }\FunctionTok{grobY}\NormalTok{(x, }\DecValTok{0}\NormalTok{),}
      \FunctionTok{grobWidth}\NormalTok{(x), }\FunctionTok{grobHeight}\NormalTok{(x), ...)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod weight}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, sub) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"weight"}\NormalTok{))}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"weight"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"ANY"}\NormalTok{, }\AttributeTok{sub =} \StringTok{"character"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, sub)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{isS4}\NormalTok{(x)) \{}
\NormalTok{      weight }\OtherTok{\textless{}{-}}
        \FunctionTok{sapply}\NormalTok{(sub, }\AttributeTok{simplify =}\NormalTok{ F, }\ControlFlowTok{function}\NormalTok{(sub) \{}
          \FunctionTok{get\_weight}\NormalTok{(}\FunctionTok{slot}\NormalTok{(x, sub))}
\NormalTok{      \})}
\NormalTok{    \}}
    \FunctionTok{as.list}\NormalTok{(}\FunctionTok{sort}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(weight), }\AttributeTok{decreasing =}\NormalTok{ T))}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod as\_grob}
\CommentTok{\#\textquotesingle{} @title convert \textquotesingle{}ggplot\textquotesingle{} object to \textquotesingle{}grobs\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{} @rdname as\_grob{-}methods}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"as\_grob"}\NormalTok{,}
  \ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"as\_grob"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod as\_grob}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"as\_grob"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{x =} \StringTok{"gg.obj"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    ggplot2}\SpecialCharTok{::}\FunctionTok{ggplot\_gtable}\NormalTok{(ggplot2}\SpecialCharTok{::}\FunctionTok{ggplot\_build}\NormalTok{(x))}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @export get\_weight}
\NormalTok{get\_weight }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{isS4}\NormalTok{(x)) \{}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(}\FunctionTok{slotNames}\NormalTok{(x))}
    \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.list}\NormalTok{(}\FunctionTok{slot}\NormalTok{(x, }\FunctionTok{slotNames}\NormalTok{(x)))) \{}
\NormalTok{        n }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{*} \FunctionTok{length}\NormalTok{(}\FunctionTok{slot}\NormalTok{(x, }\FunctionTok{slotNames}\NormalTok{(x)))}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(n)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.list}\NormalTok{(x)) \{}
    \FunctionTok{length}\NormalTok{(x)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{length}\NormalTok{(x)}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @aliases frame}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title draw in grid frame}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name frame}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export layout\_row}
\CommentTok{\#\textquotesingle{} @aliases layout\_row}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{layout\_row\}: ...}
\CommentTok{\#\textquotesingle{} @rdname frame}
\NormalTok{layout\_row }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(weight)\{}
  \FunctionTok{grid.layout}\NormalTok{(}\FunctionTok{length}\NormalTok{(weight), }\DecValTok{1}\NormalTok{, }\AttributeTok{heights =}\NormalTok{ weight)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export frame\_row}
\CommentTok{\#\textquotesingle{} @aliases frame\_row}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{frame\_row\}: ...}
\CommentTok{\#\textquotesingle{} @rdname frame}
\NormalTok{frame\_row }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(weight, data, if.ex)\{}
  \FunctionTok{do.call}\NormalTok{(frame\_place, }\FunctionTok{.fresh\_param}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{type =} \StringTok{"row"}\NormalTok{)))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export layout\_col}
\CommentTok{\#\textquotesingle{} @aliases layout\_col}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{layout\_col\}: ...}
\CommentTok{\#\textquotesingle{} @rdname frame}
\NormalTok{layout\_col }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(weight)\{}
  \FunctionTok{grid.layout}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(weight), }\AttributeTok{widths =}\NormalTok{ weight)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export frame\_col}
\CommentTok{\#\textquotesingle{} @aliases frame\_col}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{frame\_col\}: ...}
\CommentTok{\#\textquotesingle{} @rdname frame}
\NormalTok{frame\_col }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(weight, data, if.ex)\{}
  \FunctionTok{do.call}\NormalTok{(frame\_place, }\FunctionTok{.fresh\_param}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{type =} \StringTok{"col"}\NormalTok{)))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @exportMethod frame\_place}
\CommentTok{\#\textquotesingle{} @aliases frame\_place}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{frame\_place\}: ...}
\CommentTok{\#\textquotesingle{} @rdname frame}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(weight, data, type, if.ex) }
    \FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod frame\_place}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{,}
    \AttributeTok{weight =} \StringTok{"vector"}\NormalTok{,}
    \AttributeTok{data =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"character"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(weight, data, type)\{}
\NormalTok{    fun }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"layout\_"}\NormalTok{, type)}
\NormalTok{    layout }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(fun)(weight)}
\NormalTok{    frame }\OtherTok{\textless{}{-}} \FunctionTok{frameGrob}\NormalTok{(}\AttributeTok{layout =}\NormalTok{ layout)}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(data), }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(name) \{}
\NormalTok{        grob }\OtherTok{\textless{}{-}}\NormalTok{ data[[ name ]]}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is}\NormalTok{(grob, }\StringTok{"graph"}\NormalTok{))}
\NormalTok{          grob }\OtherTok{\textless{}{-}}\NormalTok{ grob}\SpecialCharTok{@}\NormalTok{grob}
        \FunctionTok{gTree}\NormalTok{(}\AttributeTok{children =} \FunctionTok{gList}\NormalTok{(grob),}
          \AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{name =}\NormalTok{ name))}
\NormalTok{      \})}
    \FunctionTok{names}\NormalTok{(weight) }\OtherTok{\textless{}{-}} \FunctionTok{repSuffix}\NormalTok{(}\FunctionTok{names}\NormalTok{(weight))}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(weight)) \{}
\NormalTok{      i.name }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(weight)[[ i ]]}
\NormalTok{      o.name }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.rep}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.[0{-}9]\{1,\}$"}\NormalTok{, }\StringTok{""}\NormalTok{, i.name)}
\NormalTok{      i.grob }\OtherTok{\textless{}{-}}\NormalTok{ data[[ o.name ]]}
\NormalTok{      i.grob}\SpecialCharTok{$}\NormalTok{vp}\SpecialCharTok{$}\NormalTok{name }\OtherTok{\textless{}{-}}\NormalTok{ i.name}
\NormalTok{      args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(frame, i.grob)}
\NormalTok{      args[[ type ]] }\OtherTok{\textless{}{-}}\NormalTok{ i}
\NormalTok{      frame }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(placeGrob, args)}
\NormalTok{    \}}
\NormalTok{    frame}
\NormalTok{  \})}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"frame\_place"}\NormalTok{,}
    \AttributeTok{weight =} \StringTok{"vector"}\NormalTok{,}
    \AttributeTok{data =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{type =} \StringTok{"character"}\NormalTok{,}
    \AttributeTok{if.ex =} \StringTok{"logical"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(weight, data, type, if.ex)\{}
\NormalTok{    main }\OtherTok{\textless{}{-}}\NormalTok{ weight[}\SpecialCharTok{!}\NormalTok{if.ex]}
\NormalTok{    sub }\OtherTok{\textless{}{-}}\NormalTok{ weight[if.ex]}
\NormalTok{    funs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(frame\_col, frame\_row)}
    \DocumentationTok{\#\# which function}
\NormalTok{    which }\OtherTok{\textless{}{-}}\NormalTok{ type }\SpecialCharTok{==} \FunctionTok{c}\NormalTok{(}\StringTok{"col"}\NormalTok{, }\StringTok{"row"}\NormalTok{)}
    \DocumentationTok{\#\# ex}
\NormalTok{    ex }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{names}\NormalTok{(sub), }\AttributeTok{collapse =} \StringTok{"\_\_"}\NormalTok{)}
\NormalTok{    data[[ ex ]] }\OtherTok{\textless{}{-}}\NormalTok{ funs[}\SpecialCharTok{!}\NormalTok{which][[}\DecValTok{1}\NormalTok{]](sub, data)}
\NormalTok{    ex.w }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{sum}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(sub)))}
    \FunctionTok{names}\NormalTok{(ex.w) }\OtherTok{\textless{}{-}}\NormalTok{ ex}
\NormalTok{    weight }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(main, ex.w)}
    \DocumentationTok{\#\# main}
\NormalTok{    funs[which][[}\DecValTok{1}\NormalTok{]](weight, data)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @aliases setnull}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Set markers crossover viewports}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name setnull}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export setnull}
\CommentTok{\#\textquotesingle{} @aliases setnull}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{setnull\}: ...}
\CommentTok{\#\textquotesingle{} @rdname setnull}
\NormalTok{setnull }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(target, args, }\AttributeTok{name =} \StringTok{"null"}\NormalTok{)\{}
\NormalTok{  gPath }\OtherTok{\textless{}{-}} \FunctionTok{grid.grep}\NormalTok{(}\FunctionTok{gPath}\NormalTok{(target), }\AttributeTok{vpPath =}\NormalTok{ T, }\AttributeTok{grep =}\NormalTok{ T)}
\NormalTok{  vpPath }\OtherTok{\textless{}{-}} \FunctionTok{attr}\NormalTok{(gPath, }\StringTok{"vpPath"}\NormalTok{)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{name =}\NormalTok{ name, }\AttributeTok{vp =}\NormalTok{ vpPath), args)}
  \FunctionTok{do.call}\NormalTok{(nullGrob, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export setnullvp}
\CommentTok{\#\textquotesingle{} @aliases setnullvp}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{setnullvp\}: ...}
\CommentTok{\#\textquotesingle{} @rdname setnull}
\NormalTok{setnullvp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pattern, args, x, }\AttributeTok{name =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{fix =}\NormalTok{ T, }\AttributeTok{perl =}\NormalTok{ F)\{}
  \ControlFlowTok{if}\NormalTok{ (fix) pattern }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"::"}\NormalTok{, pattern, }\StringTok{"$"}\NormalTok{)}
\NormalTok{  vpPath }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"ROOT::"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{grepPath}\NormalTok{(pattern, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{perl =}\NormalTok{ perl)[}\DecValTok{1}\NormalTok{])}
\NormalTok{  vpPath }\OtherTok{\textless{}{-}} \FunctionTok{vpPath}\NormalTok{(vpPath)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{name =}\NormalTok{ name, }\AttributeTok{vp =}\NormalTok{ vpPath), args)}
  \FunctionTok{do.call}\NormalTok{(nullGrob, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export ruler}
\NormalTok{ruler }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p1, p2)\{}
  \FunctionTok{segmentsGrob}\NormalTok{(}\FunctionTok{grobX}\NormalTok{(p1, }\DecValTok{0}\NormalTok{), }\FunctionTok{grobY}\NormalTok{(p1, }\DecValTok{0}\NormalTok{),}
    \FunctionTok{grobX}\NormalTok{(p2, }\DecValTok{0}\NormalTok{), }\FunctionTok{grobY}\NormalTok{(p2, }\DecValTok{0}\NormalTok{))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grepPath}
\CommentTok{\#\textquotesingle{} @aliases grepPath}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grepPath\}: ...}
\CommentTok{\#\textquotesingle{} @rdname setnull}
\NormalTok{grepPath }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{ (pattern, }\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{grobs =}\NormalTok{ T, }\AttributeTok{viewports =}\NormalTok{ T, }\AttributeTok{perl =}\NormalTok{ F) \{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{grobs =}\NormalTok{ grobs, }\AttributeTok{viewports =}\NormalTok{ viewports, }\AttributeTok{print =}\NormalTok{ F)}
\NormalTok{    dl }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(grid.ls, args)}
    \ControlFlowTok{if}\NormalTok{ (viewports) \{}
\NormalTok{      keep }\OtherTok{\textless{}{-}}\NormalTok{ dl}\SpecialCharTok{$}\NormalTok{type }\SpecialCharTok{==} \StringTok{"vpListing"} \SpecialCharTok{|}\NormalTok{ dl}\SpecialCharTok{$}\NormalTok{type }\SpecialCharTok{==} \StringTok{"grobListing"} \SpecialCharTok{|} 
\NormalTok{        dl}\SpecialCharTok{$}\NormalTok{type }\SpecialCharTok{==} \StringTok{"gTreeListing"}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      keep }\OtherTok{\textless{}{-}}\NormalTok{ dl}\SpecialCharTok{$}\NormalTok{type }\SpecialCharTok{==} \StringTok{"grobListing"} \SpecialCharTok{|}\NormalTok{ dl}\SpecialCharTok{$}\NormalTok{type }\SpecialCharTok{==} \StringTok{"gTreeListing"}
\NormalTok{    \}}
\NormalTok{    vpPaths }\OtherTok{\textless{}{-}}\NormalTok{ dl}\SpecialCharTok{$}\NormalTok{vpPath[keep]}
\NormalTok{    vpPaths[}\FunctionTok{grepl}\NormalTok{(pattern, vpPaths, }\AttributeTok{perl =}\NormalTok{ perl)]}
\NormalTok{  \}}


\CommentTok{\#\textquotesingle{} @export sort\_vpPaths}
\CommentTok{\#\textquotesingle{} @aliases sort\_vpPaths}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{sort\_vpPaths\}: ...}
\CommentTok{\#\textquotesingle{} @rdname setnull}
\NormalTok{sort\_vpPaths }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(vpPaths)\{}
\NormalTok{  nums }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(vpPaths, }\AttributeTok{FUN.VALUE =} \DecValTok{0}\NormalTok{,}
    \ControlFlowTok{function}\NormalTok{(ch) \{}\FunctionTok{length}\NormalTok{(}\FunctionTok{grepRaw}\NormalTok{(}\StringTok{"::"}\NormalTok{, ch, }\AttributeTok{all =}\NormalTok{ T))\})}
  \FunctionTok{lapply}\NormalTok{(}\FunctionTok{order}\NormalTok{(nums), }\ControlFlowTok{function}\NormalTok{(n) vpPaths[[ n ]])}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export u}
\NormalTok{u }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, unit)\{}
\NormalTok{  unit }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(}\FunctionTok{substitute}\NormalTok{(unit))}
  \FunctionTok{unit}\NormalTok{(n, unit)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export vptest}
\NormalTok{vptest }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{r =}\NormalTok{ .}\DecValTok{7}\NormalTok{, }\AttributeTok{fill =} \StringTok{"lightblue"}\NormalTok{)\{}
  \FunctionTok{x11}\NormalTok{(}\AttributeTok{width =} \DecValTok{7}\NormalTok{, }\AttributeTok{height =} \DecValTok{7} \SpecialCharTok{*}\NormalTok{ r,)}
  \FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(, , .}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ fill)))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export sym\_chem}
\NormalTok{sym\_chem }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(smi)\{}
\NormalTok{  tmpsvg }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{tempdir}\NormalTok{(), }\StringTok{"/tempsvg.svg"}\NormalTok{)}
\NormalTok{  ChemmineOB}\SpecialCharTok{::}\FunctionTok{convertToImage}\NormalTok{(}\StringTok{"SMI"}\NormalTok{, }\StringTok{"SVG"}\NormalTok{, }\AttributeTok{source =}\NormalTok{ smi, }\AttributeTok{toFile =}\NormalTok{ tmpsvg)}
\NormalTok{  svgtxt }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(tmpsvg)}
\NormalTok{  svgtxt }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"stroke{-}width=}\SpecialCharTok{\textbackslash{}"}\StringTok{2.0"}\NormalTok{, }\StringTok{"stroke{-}width=}\SpecialCharTok{\textbackslash{}"}\StringTok{4.0"}\NormalTok{, svgtxt)}
  \FunctionTok{writeLines}\NormalTok{(svgtxt, tmpsvg)}
\NormalTok{  rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(tmpsvg, tmpsvg)}
  \FunctionTok{.rm\_background}\NormalTok{(}\FunctionTok{.cairosvg\_to\_grob}\NormalTok{(tmpsvg))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @aliases ggather}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title a mutate of grid::gTree}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name ggather}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export ggather}
\CommentTok{\#\textquotesingle{} @aliases ggather}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{ggather\}: ...}
\CommentTok{\#\textquotesingle{} @rdname ggather}
\NormalTok{ggather }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(..., }\AttributeTok{vp =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{gp =} \ConstantTok{NULL}\NormalTok{)\{}
\NormalTok{  objs }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  objs }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(objs, }\ControlFlowTok{function}\NormalTok{(obj) \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is}\NormalTok{(obj, }\StringTok{"graph"}\NormalTok{))}
\NormalTok{      obj}\SpecialCharTok{@}\NormalTok{grob}
    \ControlFlowTok{else}
\NormalTok{      obj}
\NormalTok{    \})}
\NormalTok{  glist }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(gList, objs)}
  \FunctionTok{gTree}\NormalTok{(}\AttributeTok{children =}\NormalTok{ glist, }\AttributeTok{gp =}\NormalTok{ gp, }\AttributeTok{vp =}\NormalTok{ vp)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export zo}
\CommentTok{\#\textquotesingle{} @aliases zo}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{zo\}: ...}
\CommentTok{\#\textquotesingle{} @rdname ggather}
\NormalTok{zo }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{w =}\NormalTok{ .}\DecValTok{9}\NormalTok{, }\AttributeTok{h =}\NormalTok{ .}\DecValTok{9}\NormalTok{) \{}
  \FunctionTok{ggather}\NormalTok{(x, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(, , w, h))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# arrow}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases arrow}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title draw arrow}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name arrow}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export .gpar\_dashed\_line}
\NormalTok{.gpar\_dashed\_line }\OtherTok{\textless{}{-}} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \StringTok{"black"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{lwd =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{"line"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @export .gpar\_dotted\_line}
\NormalTok{.gpar\_dotted\_line }\OtherTok{\textless{}{-}} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \StringTok{"black"}\NormalTok{, }\AttributeTok{lty =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{lwd =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{"line"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @export parrow}
\CommentTok{\#\textquotesingle{} @aliases parrow}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{parrow\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{parrow }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, col, }\AttributeTok{type =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{lwd =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line))\{}
\NormalTok{  y }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{length.out =}\NormalTok{ n)[}\FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{n)]}
\NormalTok{  segs }\OtherTok{\textless{}{-}} \FunctionTok{segmentsGrob}\NormalTok{(}\FunctionTok{rep}\NormalTok{(.}\DecValTok{1}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), y,}
    \FunctionTok{rep}\NormalTok{(.}\DecValTok{9}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), y,}
    \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{lwd =}\NormalTok{ lwd, }\AttributeTok{fill =}\NormalTok{ col, }\AttributeTok{col =}\NormalTok{ col, }\AttributeTok{lty =}\NormalTok{ type)}
\NormalTok{  )}
\NormalTok{  arrs }\OtherTok{\textless{}{-}} \FunctionTok{segmentsGrob}\NormalTok{(}\FunctionTok{rep}\NormalTok{(.}\DecValTok{8}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), y,}
    \FunctionTok{rep}\NormalTok{(.}\DecValTok{9}\NormalTok{, n }\SpecialCharTok{{-}} \DecValTok{2}\NormalTok{), y,}
    \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{angle =} \DecValTok{15}\NormalTok{, }\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(.}\DecValTok{7}\NormalTok{, }\StringTok{"line"}\NormalTok{), }\AttributeTok{type =} \StringTok{"closed"}\NormalTok{),}
    \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{lwd =}\NormalTok{ lwd, }\AttributeTok{fill =}\NormalTok{ col, }\AttributeTok{col =}\NormalTok{ col)}
\NormalTok{  )}
  \FunctionTok{ggather}\NormalTok{(segs, arrs)}
\NormalTok{\}}

\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"maybe\_p1p2"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"null"}\NormalTok{, }\StringTok{"list"}\NormalTok{))}
\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"maybe\_function"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"NULL"}\NormalTok{, }\StringTok{"function"}\NormalTok{))}
\FunctionTok{setClassUnion}\NormalTok{(}\StringTok{"maybe\_list"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{"NULL"}\NormalTok{, }\StringTok{"list"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod garrow}
\CommentTok{\#\textquotesingle{} @aliases garrow}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{garrow\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(p1, p2, args\_line, args\_arrow, fun\_line, fun\_arrow, city)}
    \FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"garrow"}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @exportMethod garrow}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"garrow"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{()\{}
\NormalTok{    args\_line }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{square =}\NormalTok{ F, }\AttributeTok{ncp =} \DecValTok{10}\NormalTok{, }\AttributeTok{curvature =}\NormalTok{ .}\DecValTok{3}\NormalTok{,}
      \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \StringTok{"black"}\NormalTok{))}
\NormalTok{    args\_arrow }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{angle =} \DecValTok{15}\NormalTok{, }\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(.}\DecValTok{7}\NormalTok{, }\StringTok{"line"}\NormalTok{), }\AttributeTok{type =} \StringTok{"closed"}\NormalTok{)}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{args\_line =}\NormalTok{ args\_line,}
      \AttributeTok{args\_arrow =}\NormalTok{ args\_arrow,}
      \AttributeTok{fun\_line =} \FunctionTok{match.fun}\NormalTok{(curveGrob),}
      \AttributeTok{fun\_arrow =} \FunctionTok{match.fun}\NormalTok{(arrow),}
      \AttributeTok{city =} \ConstantTok{NULL}
\NormalTok{    )}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod garrow}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{p1 =} \StringTok{"maybe\_p1p2"}\NormalTok{, }\AttributeTok{p2 =} \StringTok{"maybe\_p1p2"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(p1, p2, args\_line, args\_arrow,}
\NormalTok{    fun\_line, fun\_arrow, city)\{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{    default }\OtherTok{\textless{}{-}} \FunctionTok{garrow}\NormalTok{()}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{args\_line }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(default}\SpecialCharTok{$}\NormalTok{args\_line, args\_line)}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{args\_arrow }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(default}\SpecialCharTok{$}\NormalTok{args\_arrow, args\_arrow)}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(default, args)}
    \FunctionTok{reCallMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, args)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod garrow}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{p1 =} \StringTok{"null"}\NormalTok{, }\AttributeTok{p2 =} \StringTok{"null"}\NormalTok{,}
    \AttributeTok{args\_line =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{args\_arrow =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{fun\_line =} \StringTok{"maybe\_function"}\NormalTok{,}
    \AttributeTok{fun\_arrow =} \StringTok{"maybe\_function"}\NormalTok{,}
    \AttributeTok{city =} \StringTok{"maybe\_list"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(p1, p2, args\_line, args\_arrow,}
\NormalTok{    fun\_line, fun\_arrow, city)\{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{p1 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x1 =} \FunctionTok{grobX}\NormalTok{(p1, }\DecValTok{0}\NormalTok{), }\AttributeTok{y1 =} \FunctionTok{grobY}\NormalTok{(p1, }\DecValTok{0}\NormalTok{))}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{p2 }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x2 =} \FunctionTok{grobX}\NormalTok{(p2, }\DecValTok{0}\NormalTok{), }\AttributeTok{y2 =} \FunctionTok{grobY}\NormalTok{(p2, }\DecValTok{0}\NormalTok{))}
    \FunctionTok{reCallMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, args)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @exportMethod garrow}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"garrow"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{c}\NormalTok{(}\AttributeTok{p1 =} \StringTok{"list"}\NormalTok{, }\AttributeTok{p2 =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{args\_line =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{args\_arrow =} \StringTok{"list"}\NormalTok{,}
    \AttributeTok{fun\_line =} \StringTok{"maybe\_function"}\NormalTok{,}
    \AttributeTok{fun\_arrow =} \StringTok{"maybe\_function"}\NormalTok{,}
    \AttributeTok{city =} \StringTok{"maybe\_list"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(p1, p2, args\_line, args\_arrow,}
\NormalTok{    fun\_line, fun\_arrow, city)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(fun\_arrow))}
\NormalTok{      args\_line}\SpecialCharTok{$}\NormalTok{arrow }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(fun\_arrow, args\_arrow)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(city)) \{}
\NormalTok{      city }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{garrow\_city\_args}\NormalTok{(), city)}
\NormalTok{      e }\OtherTok{\textless{}{-}} \FunctionTok{segmentsGrob}\NormalTok{(p1}\SpecialCharTok{$}\NormalTok{x1, p1}\SpecialCharTok{$}\NormalTok{y1, p2}\SpecialCharTok{$}\NormalTok{x2, p2}\SpecialCharTok{$}\NormalTok{y2)}
      \ControlFlowTok{if}\NormalTok{ (city}\SpecialCharTok{$}\NormalTok{axis }\SpecialCharTok{==} \StringTok{"x"}\NormalTok{) \{}
\NormalTok{        pm }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =}\NormalTok{ p1}\SpecialCharTok{$}\NormalTok{x1 }\SpecialCharTok{+}\NormalTok{ city}\SpecialCharTok{$}\NormalTok{shift, }\AttributeTok{y =} \FunctionTok{grobY}\NormalTok{(e, }\DecValTok{0}\NormalTok{))}
\NormalTok{      \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (city}\SpecialCharTok{$}\NormalTok{axis }\SpecialCharTok{==} \StringTok{"y"}\NormalTok{) \{}
\NormalTok{        pm }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FunctionTok{grobX}\NormalTok{(e, }\DecValTok{90}\NormalTok{), }\AttributeTok{y =}\NormalTok{ p1}\SpecialCharTok{$}\NormalTok{y1 }\SpecialCharTok{+}\NormalTok{ city}\SpecialCharTok{$}\NormalTok{shift)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
        \FunctionTok{stop}\NormalTok{(}\StringTok{"city$axis != x \& city$axis != y"}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{      args\_line }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(args\_line, city}\SpecialCharTok{$}\NormalTok{args\_line)}
\NormalTok{      args\_line\_mid }\OtherTok{\textless{}{-}}\NormalTok{ args\_line[}\FunctionTok{names}\NormalTok{(args\_line) }\SpecialCharTok{!=} \StringTok{"arrow"}\NormalTok{]}
      \FunctionTok{names}\NormalTok{(pm) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"x2"}\NormalTok{, }\StringTok{"y2"}\NormalTok{)}
\NormalTok{      a1 }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(fun\_line, }\FunctionTok{c}\NormalTok{(p1, pm, args\_line\_mid))}
      \FunctionTok{names}\NormalTok{(pm) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"x1"}\NormalTok{, }\StringTok{"y1"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{ (city}\SpecialCharTok{$}\NormalTok{rev) \{}
\NormalTok{        args\_line}\SpecialCharTok{$}\NormalTok{curvature }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{(args\_line}\SpecialCharTok{$}\NormalTok{curvature)}
\NormalTok{      \}}
\NormalTok{      a2 }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(fun\_line, }\FunctionTok{c}\NormalTok{(pm, p2, args\_line))}
      \DocumentationTok{\#\# as graph}
\NormalTok{      vp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(pm}\SpecialCharTok{$}\NormalTok{x, pm}\SpecialCharTok{$}\NormalTok{y, .}\DecValTok{1} \SpecialCharTok{*} \FunctionTok{grobHeight}\NormalTok{(e), .}\DecValTok{1} \SpecialCharTok{*} \FunctionTok{grobHeight}\NormalTok{(e))}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(city}\SpecialCharTok{$}\NormalTok{grob\_anno)) \{}
        \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(city}\SpecialCharTok{$}\NormalTok{vp\_anno)) \{}
\NormalTok{          vp }\OtherTok{\textless{}{-}} \FunctionTok{vpStack}\NormalTok{(vp, city}\SpecialCharTok{$}\NormalTok{vp\_anno)}
\NormalTok{        \}}
\NormalTok{        anno }\OtherTok{\textless{}{-}} \FunctionTok{ggather}\NormalTok{(city}\SpecialCharTok{$}\NormalTok{grob\_anno, }\AttributeTok{vp =}\NormalTok{ vp)}
        \FunctionTok{return}\NormalTok{(}\FunctionTok{ggather}\NormalTok{(a1, a2, anno))}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =} \FunctionTok{ggather}\NormalTok{(a1, a2), }\AttributeTok{cvp =}\NormalTok{ vp))}
\NormalTok{    \}}
\NormalTok{    args\_line }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(p1, p2, args\_line)}
    \FunctionTok{do.call}\NormalTok{(fun\_line, args\_line)}
\NormalTok{  \})}

\CommentTok{\#\textquotesingle{} @export garrow\_city}
\CommentTok{\#\textquotesingle{} @aliases garrow\_city}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{garrow\_city\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{garrow\_city }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p1, p2, up, left, shift, gp\_line)\{}
\NormalTok{  shift }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(shift)}
\NormalTok{  curvature }\OtherTok{\textless{}{-}} \DecValTok{1}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{up }\SpecialCharTok{\&}\NormalTok{ left) \{}
\NormalTok{    shift }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{shift}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{up }\SpecialCharTok{\&} \SpecialCharTok{!}\NormalTok{left) \{}
\NormalTok{    curvature }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (up }\SpecialCharTok{\&}\NormalTok{ left) \{}
\NormalTok{    curvature }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\DecValTok{1}
\NormalTok{    shift }\OtherTok{\textless{}{-}} \SpecialCharTok{{-}}\NormalTok{shift}
\NormalTok{  \}}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{curvature =}\NormalTok{ curvature,}
    \AttributeTok{square =}\NormalTok{ T,}
    \AttributeTok{ncp =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{garrow}\NormalTok{(p1, p2, }\FunctionTok{list}\NormalTok{(}\AttributeTok{gp =}\NormalTok{ gp\_line), }
    \AttributeTok{city =} \FunctionTok{list}\NormalTok{(}\AttributeTok{args\_line =}\NormalTok{ args, }\AttributeTok{shift =}\NormalTok{ shift))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export garrow\_snake}
\CommentTok{\#\textquotesingle{} @aliases garrow\_snake}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{garrow\_snake\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{garrow\_snake }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p1, p2, color, }\AttributeTok{lwd =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line), }\AttributeTok{cur =} \DecValTok{1}\NormalTok{)\{}
  \FunctionTok{garrow}\NormalTok{(p1, p2, }\FunctionTok{list}\NormalTok{(}\AttributeTok{curvature =}\NormalTok{ cur, }\AttributeTok{square =}\NormalTok{ T, }\AttributeTok{ncp =} \DecValTok{1}\NormalTok{, }\AttributeTok{inflect =}\NormalTok{ T,}
      \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{lwd =}\NormalTok{ lwd, }\AttributeTok{col =}\NormalTok{ color, }\AttributeTok{fill =}\NormalTok{ color)))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export garrow\_city\_args}
\CommentTok{\#\textquotesingle{} @aliases garrow\_city\_args}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{garrow\_city\_args\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{garrow\_city\_args }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{shift =} \FunctionTok{u}\NormalTok{(}\DecValTok{2}\NormalTok{, line), }\AttributeTok{axis =} \StringTok{"x"}\NormalTok{, }\AttributeTok{mid =}\NormalTok{ .}\DecValTok{5}\NormalTok{,}
    \AttributeTok{args\_line =} \FunctionTok{list}\NormalTok{(}\AttributeTok{ncp =} \DecValTok{1}\NormalTok{, }\AttributeTok{curvature =} \DecValTok{1}\NormalTok{, }\AttributeTok{square =}\NormalTok{ T),}
    \AttributeTok{grob\_anno =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{vp\_anno =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{rev =}\NormalTok{ F}
\NormalTok{    )\{}
    \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export sagnage}
\CommentTok{\#\textquotesingle{} @aliases sagnage}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{sagnage\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{sagnage }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(grob, }\AttributeTok{left =}\NormalTok{ T, l\_gpar, }\AttributeTok{borderF =} \FloatTok{1.5}\NormalTok{, }\AttributeTok{front\_len =}\NormalTok{ .}\DecValTok{1}\NormalTok{,}
  \AttributeTok{vp\_shift =} \FunctionTok{u}\NormalTok{(}\FloatTok{1.5}\NormalTok{, line), ...)\{}
\NormalTok{  l\_gpar }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2f}\NormalTok{(}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{linejoin =} \StringTok{"round"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"grey85"}\NormalTok{,}
      \AttributeTok{col =} \StringTok{"transparent"}\NormalTok{), l\_gpar)}
\NormalTok{  w }\OtherTok{\textless{}{-}} \FunctionTok{grobWidth}\NormalTok{(grob) }\SpecialCharTok{*}\NormalTok{ borderF}
\NormalTok{  h }\OtherTok{\textless{}{-}} \FunctionTok{grobHeight}\NormalTok{(grob) }\SpecialCharTok{*}\NormalTok{ borderF}
\NormalTok{  vp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(, , w }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ front\_len), h)}
\NormalTok{  shift }\OtherTok{\textless{}{-}}\NormalTok{ front\_len }\SpecialCharTok{/}\NormalTok{ (front\_len }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{  cw }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{/}\NormalTok{ (front\_len }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (left) \{}
\NormalTok{    poly }\OtherTok{\textless{}{-}} \FunctionTok{polygonGrob}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, front\_len, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, front\_len), }\FunctionTok{c}\NormalTok{(.}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
      \AttributeTok{vp =}\NormalTok{ vp, }\AttributeTok{gp =}\NormalTok{ l\_gpar)}
\NormalTok{    cvp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(.}\DecValTok{5} \SpecialCharTok{+}\NormalTok{ shift, }\AttributeTok{width =}\NormalTok{ cw)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    poly }\OtherTok{\textless{}{-}} \FunctionTok{polygonGrob}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ front\_len, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ front\_len),}
      \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{vp =}\NormalTok{ vp, }\AttributeTok{gp =}\NormalTok{ l\_gpar)}
\NormalTok{    cvp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(.}\DecValTok{5} \SpecialCharTok{{-}}\NormalTok{ shift, }\AttributeTok{width =}\NormalTok{ cw)}
\NormalTok{  \}}
\NormalTok{  ggrob }\OtherTok{\textless{}{-}} \FunctionTok{into}\NormalTok{(}\FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =}\NormalTok{ poly, }\AttributeTok{cvp =} \FunctionTok{vpStack}\NormalTok{(vp, cvp)), grob)}
  \ControlFlowTok{if}\NormalTok{ (left) \{}
\NormalTok{    vp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(vp\_shift, }\AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"centre"}\NormalTok{))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    vp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{vp\_shift, }\AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"centre"}\NormalTok{))}
\NormalTok{  \}}
  \FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{grob\_anno =}\NormalTok{ ggrob, }\AttributeTok{vp\_anno =}\NormalTok{ vp), }\FunctionTok{list}\NormalTok{(...))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export sagnage\_shiny}
\CommentTok{\#\textquotesingle{} @aliases sagnage\_shiny}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{sagnage\_shiny\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{sagnage\_shiny }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, left, color)\{}
  \FunctionTok{sagnage}\NormalTok{(}\FunctionTok{gtext}\NormalTok{(label, }\FunctionTok{gpar}\NormalTok{(}\AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"plain"}\NormalTok{)), }
\NormalTok{    left, }\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ color))}\SpecialCharTok{$}\NormalTok{grob\_anno}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export maparrow}
\CommentTok{\#\textquotesingle{} @aliases maparrow}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{maparrow\}: ...}
\CommentTok{\#\textquotesingle{} @rdname arrow}
\NormalTok{maparrow }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(obj, data, }\AttributeTok{pattern =} \FunctionTok{list}\NormalTok{(), }\AttributeTok{round\_cur =}\NormalTok{ .}\DecValTok{3}\NormalTok{,}
    \AttributeTok{pos =} \FunctionTok{list}\NormalTok{(}\AttributeTok{r =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \DecValTok{1}\NormalTok{), }\AttributeTok{l =} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{),}
      \AttributeTok{t =} \FunctionTok{list}\NormalTok{(}\AttributeTok{y =} \DecValTok{1}\NormalTok{), }\AttributeTok{b =} \FunctionTok{list}\NormalTok{(}\AttributeTok{y =} \DecValTok{0}\NormalTok{))}
\NormalTok{    )\{}
    \FunctionTok{.check\_columns}\NormalTok{(data, }\FunctionTok{c}\NormalTok{(}\StringTok{"from"}\NormalTok{, }\StringTok{"to"}\NormalTok{, }\StringTok{"group"}\NormalTok{, }\StringTok{"fun"}\NormalTok{, }\StringTok{"color"}\NormalTok{, }\StringTok{"left"}\NormalTok{, }\StringTok{"up"}\NormalTok{,}
        \StringTok{"shift"}\NormalTok{), }\StringTok{"data"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{dup))}
\NormalTok{      data}\SpecialCharTok{$}\NormalTok{dup }\OtherTok{\textless{}{-}} \FunctionTok{duplicated}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{group)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{sag))}
\NormalTok{      data}\SpecialCharTok{$}\NormalTok{sag }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{substr}\NormalTok{(}\FunctionTok{form}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{fun), }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{), }\StringTok{"."}\NormalTok{)}
\NormalTok{    target }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{from, data}\SpecialCharTok{$}\NormalTok{to))}
\NormalTok{    nulls }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(target, }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(name) \{}
\NormalTok{        pattern }\OtherTok{\textless{}{-}} 
          \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(pattern[[ name ]]))}
\NormalTok{            pattern[[ name ]]}
          \ControlFlowTok{else}
\NormalTok{            name}
        \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(pos), }\AttributeTok{simplify =}\NormalTok{ F,}
          \ControlFlowTok{function}\NormalTok{(p)\{}
            \FunctionTok{setnullvp}\NormalTok{(pattern, pos[[p]], obj)}
\NormalTok{          \})}
\NormalTok{      \})}
\NormalTok{    bafs }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(target, }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(name) \{}
\NormalTok{        null }\OtherTok{\textless{}{-}}\NormalTok{ nulls[[ name ]]}
\NormalTok{        null }\OtherTok{\textless{}{-}}\NormalTok{ null[}\FunctionTok{names}\NormalTok{(null) }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"l"}\NormalTok{, }\StringTok{"r"}\NormalTok{)]}
        \FunctionTok{lapply}\NormalTok{(null, }\ControlFlowTok{function}\NormalTok{(null) \{}
          \ControlFlowTok{function}\NormalTok{(}\AttributeTok{w =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line), }\AttributeTok{h =} \FunctionTok{u}\NormalTok{(}\DecValTok{3}\NormalTok{, line)) \{}
            \FunctionTok{baf}\NormalTok{(}\FunctionTok{grobX}\NormalTok{(null, }\DecValTok{0}\NormalTok{), }\FunctionTok{grobY}\NormalTok{(null, }\DecValTok{0}\NormalTok{), w, h)}
\NormalTok{          \}}
\NormalTok{          \})}
\NormalTok{      \})}
\NormalTok{    bafs }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(bafs, F)}
\NormalTok{    keep }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"from"}\NormalTok{, }\StringTok{"to"}\NormalTok{),}
      \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{        pos }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(data[[ }\StringTok{"left"}\NormalTok{ ]], }\StringTok{"l"}\NormalTok{, }\StringTok{"r"}\NormalTok{)}
        \FunctionTok{paste0}\NormalTok{(data[[ ch ]], }\StringTok{"."}\NormalTok{, pos)}
\NormalTok{      \})}
\NormalTok{    bafs }\OtherTok{\textless{}{-}}\NormalTok{ bafs[}\FunctionTok{names}\NormalTok{(bafs) }\SpecialCharTok{\%in\%} \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(keep))]}
\NormalTok{    arr\_city }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{1}\NormalTok{, }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(v) \{}
\NormalTok{        pos }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{as.logical}\NormalTok{(v[[ }\StringTok{"left"}\NormalTok{ ]]), }\StringTok{"l"}\NormalTok{, }\StringTok{"r"}\NormalTok{)}
        \FunctionTok{garrow\_city}\NormalTok{(nulls[[ v[[}\StringTok{"from"}\NormalTok{]] ]][[ pos ]],}
\NormalTok{          nulls[[ v[[}\StringTok{"to"}\NormalTok{]] ]][[ pos ]],}
          \FunctionTok{as.logical}\NormalTok{(v[[ }\StringTok{"up"}\NormalTok{ ]]), }\FunctionTok{as.logical}\NormalTok{(v[[ }\StringTok{"left"}\NormalTok{ ]]),}
          \FunctionTok{u}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(v[[}\StringTok{"shift"}\NormalTok{]]), line),}
          \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ v[[}\StringTok{"color"}\NormalTok{]], }\AttributeTok{col =}\NormalTok{ v[[}\StringTok{"color"}\NormalTok{]],}
            \AttributeTok{lwd =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line))}
\NormalTok{        )}
\NormalTok{      \})}
\NormalTok{    arr\_round }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(data, }\DecValTok{1}\NormalTok{, }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(v) \{}
\NormalTok{        pos }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{as.logical}\NormalTok{(v[[ }\StringTok{"left"}\NormalTok{ ]]), }\StringTok{"l"}\NormalTok{, }\StringTok{"r"}\NormalTok{)}
\NormalTok{        cur }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (pos }\SpecialCharTok{==} \StringTok{"l"}\NormalTok{) round\_cur }\ControlFlowTok{else} \SpecialCharTok{{-}}\NormalTok{round\_cur}
\NormalTok{        cur }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{as.logical}\NormalTok{(v[[ }\StringTok{"up"}\NormalTok{ ]])) }\SpecialCharTok{{-}}\NormalTok{cur }\ControlFlowTok{else}\NormalTok{ cur}
        \FunctionTok{garrow}\NormalTok{(nulls[[ v[[}\StringTok{"from"}\NormalTok{]] ]][[ pos ]],}
\NormalTok{          nulls[[ v[[}\StringTok{"to"}\NormalTok{]] ]][[ pos ]],}
          \FunctionTok{list}\NormalTok{(}\AttributeTok{curvature =}\NormalTok{ cur,}
            \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ v[[}\StringTok{"color"}\NormalTok{]], }\AttributeTok{col =}\NormalTok{ v[[}\StringTok{"color"}\NormalTok{]],}
              \AttributeTok{lwd =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line)))}
\NormalTok{        )}
\NormalTok{      \})}
\NormalTok{    sags }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(arr\_city),}
      \ControlFlowTok{function}\NormalTok{(n) \{}
        \ControlFlowTok{if}\NormalTok{ (data}\SpecialCharTok{$}\NormalTok{dup[[n]]) }\FunctionTok{return}\NormalTok{()}
\NormalTok{        left }\OtherTok{\textless{}{-}} \SpecialCharTok{!}\NormalTok{data}\SpecialCharTok{$}\NormalTok{left[[n]]}
\NormalTok{        up }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{up[[n]]}
\NormalTok{        col }\OtherTok{\textless{}{-}}\NormalTok{ data}\SpecialCharTok{$}\NormalTok{color[[n]]}
\NormalTok{        gtext }\OtherTok{\textless{}{-}} \FunctionTok{gtext}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{sag[[n]], }\FunctionTok{gpar}\NormalTok{(}\AttributeTok{col =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"plain"}\NormalTok{))}
\NormalTok{        sag }\OtherTok{\textless{}{-}} \FunctionTok{sagnage}\NormalTok{(gtext, left, }\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ col), }\FloatTok{1.5}\NormalTok{)}\SpecialCharTok{$}\NormalTok{grob\_anno}
\NormalTok{        vp }\OtherTok{\textless{}{-}}\NormalTok{ arr\_city[[n]]}\SpecialCharTok{@}\NormalTok{cvp}
\NormalTok{        x }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (left) }\FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{+} \FunctionTok{u}\NormalTok{(}\DecValTok{2}\NormalTok{, line) }\ControlFlowTok{else} \FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{{-}} \FunctionTok{u}\NormalTok{(}\DecValTok{2}\NormalTok{, line)}
\NormalTok{        y }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (up) .}\DecValTok{5} \SpecialCharTok{+} \DecValTok{5} \ControlFlowTok{else}\NormalTok{ .}\DecValTok{5} \SpecialCharTok{{-}}\DecValTok{5}
\NormalTok{        vp }\OtherTok{\textless{}{-}} \FunctionTok{vpStack}\NormalTok{(vp, }\FunctionTok{viewport}\NormalTok{(x, y))}
        \FunctionTok{ggather}\NormalTok{(sag, }\AttributeTok{vp =}\NormalTok{ vp)}
\NormalTok{      \})}
\NormalTok{    sags }\OtherTok{\textless{}{-}}\NormalTok{ sags[}\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(sags, is.null, T)]}
    \FunctionTok{namel}\NormalTok{(nulls, bafs, arr\_city, arr\_round, sags, data)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export baf}
\NormalTok{baf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, y, }\AttributeTok{width =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, line), }\AttributeTok{height =} \FunctionTok{u}\NormalTok{(}\DecValTok{3}\NormalTok{, line)) \{}
\NormalTok{  rect }\OtherTok{\textless{}{-}} \FunctionTok{grectn}\NormalTok{(}\AttributeTok{bgp\_args =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{))}\SpecialCharTok{@}\NormalTok{grob}
\NormalTok{  clip }\OtherTok{\textless{}{-}} \FunctionTok{clipGrob}\NormalTok{(, , .}\DecValTok{7}\NormalTok{)}
  \FunctionTok{ggather}\NormalTok{(clip, rect, }\AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(x, y, width, height))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# text}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases text}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title a mutate of grid::textGrob}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name text}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export .font}
\NormalTok{.font }\OtherTok{\textless{}{-}} \StringTok{"Times"}

\CommentTok{\#\textquotesingle{} @export .title\_gp}
\NormalTok{.title\_gp }\OtherTok{\textless{}{-}} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{fontfamily =}\NormalTok{ .font, }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{)}

\CommentTok{\#\textquotesingle{} @export gtext}
\CommentTok{\#\textquotesingle{} @aliases gtext}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{gtext\}: ...}
\CommentTok{\#\textquotesingle{} @rdname text}
\NormalTok{gtext }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, gp\_arg, }\AttributeTok{form =}\NormalTok{ T, ...)\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.5}\NormalTok{), args)}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{label }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (form) }\FunctionTok{form}\NormalTok{(label) }\ControlFlowTok{else}\NormalTok{ label}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{gp }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2f}\NormalTok{(.title\_gp, gp\_arg)}
  \FunctionTok{do.call}\NormalTok{(textGrob, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export gtextp}
\CommentTok{\#\textquotesingle{} @aliases gtextp}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{gtextp\}: ...}
\CommentTok{\#\textquotesingle{} @rdname text}
\NormalTok{gtextp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, gp\_arg, }\AttributeTok{form =}\NormalTok{ T, ...)\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{missing}\NormalTok{(gp\_arg))}
\NormalTok{    gp\_arg }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{  gp\_arg}\SpecialCharTok{$}\NormalTok{font }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{plain =} \DecValTok{1}\NormalTok{)}
  \FunctionTok{gtext}\NormalTok{(label, gp\_arg, form, ...)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export gtext0}
\CommentTok{\#\textquotesingle{} @aliases gtext0}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{gtext0\}: ...}
\CommentTok{\#\textquotesingle{} @rdname text}
\NormalTok{gtext0 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, gp\_arg, }\AttributeTok{form =}\NormalTok{ T, ...) \{}
  \FunctionTok{gtext}\NormalTok{(label, gp\_arg, form, }\AttributeTok{x =}\NormalTok{ .}\DecValTok{1}\NormalTok{, }\AttributeTok{hjust =} \DecValTok{0}\NormalTok{, ...)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export form}
\CommentTok{\#\textquotesingle{} @aliases form}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{form\}: ...}
\CommentTok{\#\textquotesingle{} @rdname text}
\NormalTok{form }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label)\{}
\NormalTok{  Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(}\FunctionTok{gsub}\NormalTok{(}\StringTok{"\_"}\NormalTok{, }\StringTok{" "}\NormalTok{,  label))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export gltext}
\CommentTok{\#\textquotesingle{} @aliases gltext}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{gltext\}: ...}
\CommentTok{\#\textquotesingle{} @rdname text}
\NormalTok{gltext }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{gp\_arg =} \FunctionTok{list}\NormalTok{(), }\AttributeTok{args =} \FunctionTok{list}\NormalTok{(),}
  \AttributeTok{l\_gp =}\NormalTok{ .gpar\_dotted\_line, }\AttributeTok{flip =}\NormalTok{ F, }\AttributeTok{borderF =} \FloatTok{1.2}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{ (flip) args}\SpecialCharTok{$}\NormalTok{rot }\OtherTok{\textless{}{-}} \DecValTok{90}
\NormalTok{  title }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(gtext, }\FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(label, gp\_arg), args))}
  \ControlFlowTok{if}\NormalTok{ (flip) \{}
\NormalTok{    height }\OtherTok{\textless{}{-}} \FunctionTok{grobHeight}\NormalTok{(title) }\SpecialCharTok{*}\NormalTok{ borderF}
\NormalTok{    seg }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(.}\DecValTok{5}\NormalTok{, }\DecValTok{0}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{{-}}\NormalTok{ height }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{    seg. }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(.}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{+}\NormalTok{ height }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    width }\OtherTok{\textless{}{-}} \FunctionTok{grobWidth}\NormalTok{(title) }\SpecialCharTok{*}\NormalTok{ borderF}
\NormalTok{    seg }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{{-}}\NormalTok{ width }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{)}
\NormalTok{    seg. }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\FunctionTok{u}\NormalTok{(.}\DecValTok{5}\NormalTok{, npc) }\SpecialCharTok{+}\NormalTok{ width }\SpecialCharTok{/} \DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  line }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(segmentsGrob, }\FunctionTok{c}\NormalTok{(seg, }\FunctionTok{list}\NormalTok{(}\AttributeTok{gp =}\NormalTok{ l\_gp)))}
\NormalTok{  line. }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(segmentsGrob, }\FunctionTok{c}\NormalTok{(seg., }\FunctionTok{list}\NormalTok{(}\AttributeTok{gp =}\NormalTok{ l\_gp)))}
  \FunctionTok{ggather}\NormalTok{(title, line, line.)}
\NormalTok{\}}

\CommentTok{\# grid.draw(gtext("test", list(cex = 5)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# rect}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases rect}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title a mutate of grid::rectGrob}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name rect}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export .rect\_gp}
\NormalTok{.rect\_gp }\OtherTok{\textless{}{-}} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{)}
\CommentTok{\#\textquotesingle{} @export .rect.r}
\NormalTok{.rect.r }\OtherTok{\textless{}{-}} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.3}\NormalTok{, }\StringTok{"lines"}\NormalTok{)}
\CommentTok{\#\textquotesingle{} @export .vp.sep}
\NormalTok{.vp.sep }\OtherTok{\textless{}{-}} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.25}\NormalTok{, }\StringTok{"lines"}\NormalTok{)}

\CommentTok{\#\textquotesingle{} @export .grecti.vp.p}
\NormalTok{.grecti.vp.p }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"npc"}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ .vp.sep,}
  \AttributeTok{height =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"npc"}\NormalTok{) }\SpecialCharTok{{-}}\NormalTok{ .vp.sep,}
  \AttributeTok{clip =} \StringTok{"on"}\NormalTok{)}
\CommentTok{\#\textquotesingle{} @export .grecti.vp}
\NormalTok{.grecti.vp }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(viewport, .grecti.vp.p)}
\CommentTok{\#\textquotesingle{} @export .grecto.vp}
\NormalTok{.grecto.vp }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(viewport, }\FunctionTok{.fresh\_param2}\NormalTok{(.grecti.vp.p, }\FunctionTok{list}\NormalTok{(}\AttributeTok{clip =} \StringTok{"inherit"}\NormalTok{)))}

\CommentTok{\#\textquotesingle{} @export grect}
\CommentTok{\#\textquotesingle{} @aliases grect}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grect\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grect }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, }\AttributeTok{tfill =} \StringTok{"\#E18727FF"}\NormalTok{, }\AttributeTok{bfill =} \StringTok{"white"}\NormalTok{,}
\NormalTok{  t\_args, tgp\_args, }\AttributeTok{t =}\NormalTok{ roundrectGrob,}
\NormalTok{  b\_args, bgp\_args, }\AttributeTok{b =}\NormalTok{ roundrectGrob,}
  \AttributeTok{order =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{vp =} \ConstantTok{NULL}\NormalTok{)\{}
\NormalTok{  t }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(t)}
\NormalTok{  t\_args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{width =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{height =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{r =}\NormalTok{ .rect.r),}
\NormalTok{    t\_args)}
\NormalTok{  t\_args}\SpecialCharTok{$}\NormalTok{gp }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2f}\NormalTok{(}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ tfill), tgp\_args)}
\NormalTok{  trect }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(t, t\_args)}
  \DocumentationTok{\#\# b}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(b)}
\NormalTok{  b\_args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{r =}\NormalTok{ .rect.r),}
\NormalTok{    b\_args)}
\NormalTok{  b\_args}\SpecialCharTok{$}\NormalTok{gp }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2f}\NormalTok{(}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ bfill), bgp\_args)}
\NormalTok{  brect }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(b, b\_args)}
  \FunctionTok{gTree}\NormalTok{(}\AttributeTok{children =} \FunctionTok{gList}\NormalTok{(trect, brect)[order], }\AttributeTok{name =}\NormalTok{ name, }\AttributeTok{vp =}\NormalTok{ vp)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grecti}
\CommentTok{\#\textquotesingle{} @aliases grecti}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grecti\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grecti }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{1.005}\NormalTok{,}
  \AttributeTok{borderF =} \DecValTok{2}\NormalTok{, }\AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"center"}\NormalTok{, }\StringTok{"top"}\NormalTok{),}
  \AttributeTok{tfill =} \StringTok{"\#E18727FF"}\NormalTok{, }\AttributeTok{vp =}\NormalTok{ .grecti.vp,}
  \AttributeTok{order =} \FunctionTok{c}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{), }\AttributeTok{cvp\_clip =} \StringTok{"on"}\NormalTok{,}
  \AttributeTok{cvp\_fix =}\NormalTok{ T, ...)\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.list}\NormalTok{(borderF)) \{}
\NormalTok{    borderF }\OtherTok{\textless{}{-}}\NormalTok{ borderF[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{    xmax }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    xmax }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is}\NormalTok{(label, }\StringTok{"grob"}\NormalTok{)) \{}
\NormalTok{    gtext }\OtherTok{\textless{}{-}}\NormalTok{ label}
\NormalTok{    label }\OtherTok{\textless{}{-}}\NormalTok{ label}\SpecialCharTok{$}\NormalTok{label}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    gtext }\OtherTok{\textless{}{-}} \FunctionTok{gtext}\NormalTok{(label, }\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{gp\_arg =} \FunctionTok{list}\NormalTok{(}\AttributeTok{cex =}\NormalTok{ cex }\SpecialCharTok{*}\NormalTok{ borderF), }\AttributeTok{just =}\NormalTok{ just)}
\NormalTok{  \}}
\NormalTok{  t\_args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FunctionTok{grobX}\NormalTok{(gtext, }\DecValTok{90}\NormalTok{), }\AttributeTok{y =} \FunctionTok{grobY}\NormalTok{(gtext, }\DecValTok{0}\NormalTok{),}
    \AttributeTok{width =} \FunctionTok{grobWidth}\NormalTok{(gtext), }\AttributeTok{height =} \FunctionTok{grobHeight}\NormalTok{(gtext))}
  \ControlFlowTok{if}\NormalTok{ (xmax) \{}
\NormalTok{    t\_args}\SpecialCharTok{$}\NormalTok{width }\OtherTok{\textless{}{-}} \FunctionTok{u}\NormalTok{(}\FloatTok{1.2}\NormalTok{, npc)}
\NormalTok{  \}}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{t\_args =}\NormalTok{ t\_args, }\AttributeTok{tfill =}\NormalTok{ tfill, }\AttributeTok{order =}\NormalTok{ order)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(lst, args)}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{name }\OtherTok{\textless{}{-}}\NormalTok{ label}
\NormalTok{  grect }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(grect, args)}
\NormalTok{  gtext }\OtherTok{\textless{}{-}} \FunctionTok{gtext}\NormalTok{(label, }\FunctionTok{list}\NormalTok{(}\AttributeTok{cex =}\NormalTok{ cex, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{), }\AttributeTok{vp =} \FunctionTok{setvp}\NormalTok{(gtext))}
\NormalTok{  grob }\OtherTok{\textless{}{-}} \FunctionTok{gTree}\NormalTok{(}\AttributeTok{children =} \FunctionTok{gList}\NormalTok{(grect, gtext), }\AttributeTok{name =}\NormalTok{ label, }\AttributeTok{vp =}\NormalTok{ vp)}
\NormalTok{  g }\OtherTok{\textless{}{-}}\NormalTok{ grect}\SpecialCharTok{$}\NormalTok{children[[ order[}\DecValTok{2}\NormalTok{] ]]}
\NormalTok{  cvp\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{form}\NormalTok{(label), }\StringTok{"\_content"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (cvp\_fix) \{}
\NormalTok{    cvp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{,}
      \AttributeTok{width =} \FunctionTok{grobWidth}\NormalTok{(g),}
      \AttributeTok{height =} \FunctionTok{grobHeight}\NormalTok{(g) }\SpecialCharTok{{-}}\NormalTok{ t\_args}\SpecialCharTok{$}\NormalTok{height,}
      \AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"center"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
      \AttributeTok{clip =}\NormalTok{ cvp\_clip,}
      \AttributeTok{name =}\NormalTok{ cvp\_name)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    cvp }\OtherTok{\textless{}{-}} \FunctionTok{setvp}\NormalTok{(g, }\AttributeTok{clip =}\NormalTok{ cvp\_clip, }\AttributeTok{name =}\NormalTok{ cvp\_name)}
\NormalTok{  \}}
  \FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =}\NormalTok{ grob, }\AttributeTok{cvp =}\NormalTok{ cvp)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grecti2}
\CommentTok{\#\textquotesingle{} @aliases grecti2}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grecti2\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grecti2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{tfill =} \StringTok{"\#E18727FF"}\NormalTok{,}
  \AttributeTok{borderF =} \FunctionTok{list}\NormalTok{(}\DecValTok{2}\NormalTok{), ...)\{}
\NormalTok{  tgp\_args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ tfill)}
\NormalTok{  bgp\_args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =}\NormalTok{ tfill)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{namel}\NormalTok{(label, cex, borderF, tfill, tgp\_args, bgp\_args), args)}
  \FunctionTok{do.call}\NormalTok{(grecti, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grecti3}
\CommentTok{\#\textquotesingle{} @aliases grecti3}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grecti3\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grecti3 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{tfill =} \StringTok{"\#E18727FF"}\NormalTok{,}
  \AttributeTok{borderF =} \FunctionTok{list}\NormalTok{(}\DecValTok{2}\NormalTok{), ...)\{}
\NormalTok{  tgp\_args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"black"}\NormalTok{)}
\NormalTok{  bgp\_args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{namel}\NormalTok{(label, cex, borderF, tfill, tgp\_args, bgp\_args), args)}
  \FunctionTok{do.call}\NormalTok{(grecti, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grecto}
\CommentTok{\#\textquotesingle{} @aliases grecto}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grecto\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grecto }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{cex =} \DecValTok{1}\NormalTok{, }\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.995}\NormalTok{,}
  \AttributeTok{borderF =} \DecValTok{2}\NormalTok{, }\AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"center"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
  \AttributeTok{tfill =} \StringTok{"\#E18727FF"}\NormalTok{, }\AttributeTok{vp =}\NormalTok{ .grecto.vp,}
  \AttributeTok{order =} \FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }\AttributeTok{cvp\_clip =} \StringTok{"on"}\NormalTok{, }\AttributeTok{cvp\_fix =}\NormalTok{ F, ...)\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{()), }\FunctionTok{list}\NormalTok{(...))}
  \FunctionTok{do.call}\NormalTok{(grecti, args)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grectn}
\CommentTok{\#\textquotesingle{} @aliases grectn}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grectn\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grectn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{bfill =} \StringTok{"white"}\NormalTok{, b\_args, bgp\_args, }\AttributeTok{b =}\NormalTok{ roundrectGrob,}
  \AttributeTok{cvp\_clip =} \StringTok{"inherit"}\NormalTok{) \{}
\NormalTok{  b }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(b)}
\NormalTok{  b\_args }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{x =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{y =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{r =}\NormalTok{ .rect.r), b\_args)}
\NormalTok{  b\_args}\SpecialCharTok{$}\NormalTok{gp }\OtherTok{\textless{}{-}} \FunctionTok{.fresh\_param2f}\NormalTok{(}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ bfill, }\AttributeTok{lty =} \StringTok{"dotted"}\NormalTok{), bgp\_args)}
\NormalTok{  brect }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(b, b\_args)}
  \FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =}\NormalTok{ brect, }\AttributeTok{cvp =} \FunctionTok{setvp}\NormalTok{(brect, }\AttributeTok{clip =}\NormalTok{ cvp\_clip))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grectn\_frame}
\CommentTok{\#\textquotesingle{} @aliases grectn\_frame}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grectn\_frame\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grectn\_frame }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(content, title, }\AttributeTok{zo =}\NormalTok{ T)\{}
  \ControlFlowTok{if}\NormalTok{ (zo) content }\OtherTok{\textless{}{-}} \FunctionTok{zo}\NormalTok{(content)}
\NormalTok{  content }\OtherTok{\textless{}{-}} \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{title =}\NormalTok{ .}\DecValTok{2}\NormalTok{, }\AttributeTok{content =} \DecValTok{1}\NormalTok{), }\FunctionTok{namel}\NormalTok{(title, content))}
\NormalTok{  rect }\OtherTok{\textless{}{-}} \FunctionTok{grectn}\NormalTok{(, , }\FunctionTok{list}\NormalTok{(}\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{))}
  \FunctionTok{into}\NormalTok{(rect, content)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export lst\_grecti}
\CommentTok{\#\textquotesingle{} @aliases lst\_grecti}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{lst\_grecti\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{lst\_grecti }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(names, pal, }\AttributeTok{tar =} \StringTok{"slot"}\NormalTok{, }\AttributeTok{fun =}\NormalTok{ grecti, ...)\{}
  \FunctionTok{sapply}\NormalTok{(names, }\AttributeTok{simplify =}\NormalTok{ F,}
    \ControlFlowTok{function}\NormalTok{(name)\{}
\NormalTok{      graph }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(fun)(}\FunctionTok{form}\NormalTok{(name), , }\AttributeTok{tfill =}\NormalTok{ pal[[ tar ]], ...)}
\NormalTok{    \})}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grectN}
\CommentTok{\#\textquotesingle{} @aliases grectN}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grectN\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grectN }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lab}\FloatTok{.1}\NormalTok{, lab}\FloatTok{.2}\NormalTok{, }\AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fontface =} \StringTok{"plain"}\NormalTok{),}
  \AttributeTok{bfill =} \StringTok{"white"}\NormalTok{)\{}
\NormalTok{  frame }\OtherTok{\textless{}{-}} \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{lab.1 =} \DecValTok{1}\NormalTok{, }\AttributeTok{seg =}\NormalTok{ .}\DecValTok{1}\NormalTok{, }\AttributeTok{lab.2 =} \DecValTok{1}\NormalTok{),}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{lab.1 =} \FunctionTok{gtext}\NormalTok{(lab}\FloatTok{.1}\NormalTok{, gp),}
      \AttributeTok{seg =} \FunctionTok{segmentsGrob}\NormalTok{(}\DecValTok{0}\NormalTok{, .}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, .}\DecValTok{5}\NormalTok{),}
      \AttributeTok{lab.2 =} \FunctionTok{gtext}\NormalTok{(lab}\FloatTok{.2}\NormalTok{, gp)))}
  \FunctionTok{into}\NormalTok{(}\FunctionTok{grectn}\NormalTok{(bfill, , }\FunctionTok{list}\NormalTok{(}\AttributeTok{lty =} \StringTok{"solid"}\NormalTok{)), frame)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export grecta}
\CommentTok{\#\textquotesingle{} @aliases grecta}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grecta\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{grecta }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, }\AttributeTok{cex =} \DecValTok{4}\NormalTok{) \{}
\NormalTok{  grob }\OtherTok{\textless{}{-}} \FunctionTok{gtext}\NormalTok{(}
\NormalTok{    label, }\FunctionTok{list}\NormalTok{(}\AttributeTok{cex =}\NormalTok{ cex), }\AttributeTok{form =}\NormalTok{ F,}
    \AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =} \FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, npc),}
    \AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"top"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  cvp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}
    \FunctionTok{grobWidth}\NormalTok{(grob), }\DecValTok{0}\NormalTok{, }\FunctionTok{u}\NormalTok{(}\DecValTok{1}\NormalTok{, npc) }\SpecialCharTok{{-}} \FunctionTok{grobWidth}\NormalTok{(grob), .}\DecValTok{95}\NormalTok{,}
    \AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =}\NormalTok{ grob, }\AttributeTok{cvp =}\NormalTok{ cvp)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export gshiny}
\CommentTok{\#\textquotesingle{} @aliases gshiny}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{gshiny\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{gshiny }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{xn =} \DecValTok{4}\NormalTok{, }\AttributeTok{yn =} \DecValTok{3}\NormalTok{,}
  \AttributeTok{xps =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, , xn), }\AttributeTok{yps =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, , yn),}
  \AttributeTok{size =} \FunctionTok{c}\NormalTok{(.}\DecValTok{15}\NormalTok{, .}\DecValTok{02}\NormalTok{),}
  \AttributeTok{color =}\NormalTok{ .default\_color,}
  \AttributeTok{rect =} \FunctionTok{rectGrob}\NormalTok{(),}
  \AttributeTok{vp =} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{clip =} \StringTok{"off"}\NormalTok{),}
  \AttributeTok{cvp =} \FunctionTok{viewport}\NormalTok{(, , .}\DecValTok{9}\NormalTok{, .}\DecValTok{9}\NormalTok{)}
\NormalTok{  )\{}
\NormalTok{  size }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(size[}\DecValTok{1}\NormalTok{], size[}\DecValTok{2}\NormalTok{], }\AttributeTok{length.out =} \FunctionTok{floor}\NormalTok{(}\FunctionTok{max}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{length}\NormalTok{(xps), }\FunctionTok{length}\NormalTok{(yps))) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{  xsize }\OtherTok{\textless{}{-}} \FunctionTok{sym\_fill}\NormalTok{(xps, size)}
\NormalTok{  xpal }\OtherTok{\textless{}{-}} \FunctionTok{sym\_fill}\NormalTok{(xps, color)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(xps, xps), }\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(xps)), }\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(xps))),}
    \FunctionTok{c}\NormalTok{(xsize, xsize), }\FunctionTok{c}\NormalTok{(xpal, xpal))}
\NormalTok{  fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
    \FunctionTok{circleGrob}\NormalTok{(args[[}\DecValTok{1}\NormalTok{]][n], args[[}\DecValTok{2}\NormalTok{]][n], args[[}\DecValTok{3}\NormalTok{]][n],}
      \AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ args[[}\DecValTok{4}\NormalTok{]][n], }\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{))}
\NormalTok{  \}}
\NormalTok{  xcir }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*} \FunctionTok{length}\NormalTok{(xps)), fun)}
\NormalTok{  rep }\OtherTok{\textless{}{-}}\NormalTok{ xps[xps }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)]}
\NormalTok{  rep }\OtherTok{\textless{}{-}}\NormalTok{ yps[yps }\SpecialCharTok{\%in\%}\NormalTok{ rep]}
\NormalTok{  yps }\OtherTok{\textless{}{-}}\NormalTok{ yps[}\SpecialCharTok{!}\NormalTok{yps }\SpecialCharTok{\%in\%}\NormalTok{ rep]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(rep) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    size }\OtherTok{\textless{}{-}}\NormalTok{ size[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    color }\OtherTok{\textless{}{-}}\NormalTok{ color[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{  \}}
\NormalTok{  ysize }\OtherTok{\textless{}{-}} \FunctionTok{sym\_fill}\NormalTok{(yps, size)}
\NormalTok{  ypal }\OtherTok{\textless{}{-}} \FunctionTok{sym\_fill}\NormalTok{(yps, color)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{length}\NormalTok{(yps)), }\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(yps))), }\FunctionTok{c}\NormalTok{(yps, yps),}
    \FunctionTok{c}\NormalTok{(ysize, ysize), }\FunctionTok{c}\NormalTok{(ypal, ypal))}
\NormalTok{  ycir }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\DecValTok{2} \SpecialCharTok{*} \FunctionTok{length}\NormalTok{(yps)), fun)}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(rect), xcir, ycir, }\FunctionTok{list}\NormalTok{(}\AttributeTok{vp =}\NormalTok{ vp))}
  \FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =} \FunctionTok{do.call}\NormalTok{(ggather, args), }\AttributeTok{cvp =}\NormalTok{ cvp)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export sym\_fill}
\NormalTok{sym\_fill }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(long, short)\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(long) }\SpecialCharTok{\%\%} \DecValTok{2} \SpecialCharTok{==} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    short }\OtherTok{\textless{}{-}}\NormalTok{ short[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(long) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{)]}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(short, }\FunctionTok{rev}\NormalTok{(short))}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    half }\OtherTok{\textless{}{-}}\NormalTok{ (}\FunctionTok{length}\NormalTok{(long) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(short[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(half }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)], }\FunctionTok{rev}\NormalTok{(short[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{half]))}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(res)))}
    \FunctionTok{stop}\NormalTok{( }\StringTok{"any(is.na(res)) == T"}\NormalTok{ )}
  \ControlFlowTok{else}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# get external grob}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @export .expathsvg}
\NormalTok{.expathsvg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{  .expathsvg }\OtherTok{\textless{}{-}} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, }\StringTok{"svg"}\NormalTok{, }\AttributeTok{package =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.*:"}\NormalTok{, }\StringTok{""}\NormalTok{,}
      \FunctionTok{environmentName}\NormalTok{(}\FunctionTok{topenv}\NormalTok{())))}
  \FunctionTok{assign}\NormalTok{(}\StringTok{\textquotesingle{}.expathsvg\textquotesingle{}}\NormalTok{, .expathsvg, }\AttributeTok{envir =} \FunctionTok{topenv}\NormalTok{())}
\NormalTok{\}}

\NormalTok{prefix }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}

\CommentTok{\#\textquotesingle{} @export .check\_external\_svg}
\NormalTok{.check\_external\_svg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{()\{}
\NormalTok{  files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(.expathsvg, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.svg$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{  log.path }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.expathsvg, }\StringTok{"/log"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(log.path)) \{}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(log.path)}
\NormalTok{    log }\OtherTok{\textless{}{-}}\NormalTok{ log[}\FunctionTok{vapply}\NormalTok{(log, file.exists, T)]}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(files) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    new.log }\OtherTok{\textless{}{-}}
      \FunctionTok{lapply}\NormalTok{(files,}
        \ControlFlowTok{function}\NormalTok{(file) \{}
          \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{file }\SpecialCharTok{\%in\%}\NormalTok{ log) \{}
\NormalTok{            rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(file, file)}
\NormalTok{            file}
\NormalTok{          \}}
\NormalTok{        \})}
\NormalTok{    new.log }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(new.log)}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(log, new.log)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(log))}
    \FunctionTok{writeLines}\NormalTok{(log, log.path)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export ex\_grob}
\NormalTok{ex\_grob }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, }\AttributeTok{fun =}\NormalTok{ .cairosvg\_to\_grob)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.expathsvg, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".svg"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(file)) \{}
    \FunctionTok{fun}\NormalTok{(file)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"file.exsits(file) == F"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export ex\_pic}
\NormalTok{ex\_pic }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name)\{}
  \FunctionTok{ex\_grob}\NormalTok{(name, }\AttributeTok{fun =}\NormalTok{ grImport2}\SpecialCharTok{::}\NormalTok{readPicture)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# layers}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @export glayer}
\CommentTok{\#\textquotesingle{} @aliases glayer}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{glayer\}: ...}
\CommentTok{\#\textquotesingle{} @rdname rect}
\NormalTok{glayer }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{n =} \DecValTok{5}\NormalTok{, }\AttributeTok{to =}\NormalTok{ .}\DecValTok{2}\NormalTok{, }\AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{), }\AttributeTok{fun =}\NormalTok{ rectGrob)\{}
\NormalTok{    grob }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(}\AttributeTok{x =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, to, }\AttributeTok{length.out =}\NormalTok{ n),}
      \AttributeTok{y =} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, to, }\AttributeTok{length.out =}\NormalTok{ n),}
      \AttributeTok{height =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ to,}
      \AttributeTok{width =} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ to,}
      \AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
      \AttributeTok{gp =}\NormalTok{ gp}
\NormalTok{    )}
\NormalTok{    cvp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(to, to, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ to, }\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ to, }\AttributeTok{just =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{), }\AttributeTok{clip =} \StringTok{"on"}\NormalTok{)}
    \FunctionTok{graph}\NormalTok{(}\AttributeTok{grob =}\NormalTok{ grob, }\AttributeTok{cvp =}\NormalTok{ cvp)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# network}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases network}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Quickly draw random network diagrams}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name network}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export fast\_layout}
\CommentTok{\#\textquotesingle{} @aliases fast\_layout}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{fast\_layout\}: ...}
\CommentTok{\#\textquotesingle{} @rdname network}
\NormalTok{fast\_layout }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(edges, }\AttributeTok{layout =} \StringTok{"fr"}\NormalTok{, }\AttributeTok{nodes =} \ConstantTok{NULL}\NormalTok{)\{}
\NormalTok{  graph }\OtherTok{\textless{}{-}}\NormalTok{ igraph}\SpecialCharTok{::}\FunctionTok{graph\_from\_data\_frame}\NormalTok{(edges, }\AttributeTok{directed =}\NormalTok{ T, }\AttributeTok{vertices =}\NormalTok{ nodes)}
\NormalTok{  graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
\NormalTok{  ggraph}\SpecialCharTok{::}\FunctionTok{create\_layout}\NormalTok{(graph, layout)}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export random\_graph}
\CommentTok{\#\textquotesingle{} @aliases random\_graph}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{random\_graph\}: ...}
\CommentTok{\#\textquotesingle{} @rdname network}
\NormalTok{random\_graph }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ids, }\AttributeTok{n =} \FunctionTok{length}\NormalTok{(ids), }\AttributeTok{e =} \DecValTok{4}\NormalTok{, }\AttributeTok{layout =} \StringTok{"fr"}\NormalTok{) \{}
\NormalTok{  df }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =}\NormalTok{ ids, }\AttributeTok{size =} \FunctionTok{rnorm}\NormalTok{(n, .}\DecValTok{5}\NormalTok{, .}\DecValTok{2}\NormalTok{))}
\NormalTok{  edges }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id1 =} \FunctionTok{sample}\NormalTok{(ids, e), }\AttributeTok{id2 =} \FunctionTok{sample}\NormalTok{(ids, e),}
    \AttributeTok{width =} \FunctionTok{rnorm}\NormalTok{(e, .}\DecValTok{5}\NormalTok{, .}\DecValTok{2}\NormalTok{))}
  \FunctionTok{fast\_layout}\NormalTok{(edges, layout, df)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# others}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @export sep\_legend}
\NormalTok{sep\_legend }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, theme) \{}
\NormalTok{  p.l }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.get\_legend}\NormalTok{(p }\SpecialCharTok{+}\NormalTok{ theme)}
\NormalTok{  theme}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"none"}
\NormalTok{  p.m }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ theme}
\NormalTok{  p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ theme}
  \FunctionTok{return}\NormalTok{(}\FunctionTok{namel}\NormalTok{(p.l, p.m, p))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @aliases zoom\_pdf}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Zoom in locally pdf to png}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description ...}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name zoom\_pdf}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export zoom\_pdf}
\CommentTok{\#\textquotesingle{} @aliases zoom\_pdf}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{zoom\_pdf\}: ...}
\CommentTok{\#\textquotesingle{} @rdname zoom\_pdf}
\NormalTok{zoom\_pdf }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{position =} \FunctionTok{c}\NormalTok{(.}\DecValTok{5}\NormalTok{, .}\DecValTok{5}\NormalTok{), }\AttributeTok{size =} \FunctionTok{c}\NormalTok{(.}\DecValTok{15}\NormalTok{, .}\DecValTok{1}\NormalTok{), }\AttributeTok{page =} \DecValTok{1}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{2000}\NormalTok{,}
  \AttributeTok{as.grob =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  position[}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}} \DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ position[}\DecValTok{2}\NormalTok{]}
\NormalTok{  png }\OtherTok{\textless{}{-}}\NormalTok{ pdftools}\SpecialCharTok{::}\FunctionTok{pdf\_render\_page}\NormalTok{(file, }\AttributeTok{page =}\NormalTok{ page, }\AttributeTok{dpi =}\NormalTok{ dpi)}
\NormalTok{  png }\OtherTok{\textless{}{-}}\NormalTok{ png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(png}\SpecialCharTok{::}\FunctionTok{writePNG}\NormalTok{(png))}
\NormalTok{  wxh }\OtherTok{\textless{}{-}} \FunctionTok{dim}\NormalTok{(png)[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{1}\NormalTok{]}
\NormalTok{  sel }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{,}
    \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{      center }\OtherTok{\textless{}{-}}\NormalTok{ wxh[n] }\SpecialCharTok{*}\NormalTok{ position[n]}
\NormalTok{      long }\OtherTok{\textless{}{-}}\NormalTok{ wxh[n] }\SpecialCharTok{*}\NormalTok{ size[n]}
\NormalTok{      start }\OtherTok{\textless{}{-}}\NormalTok{ center }\SpecialCharTok{{-}}\NormalTok{ long }\SpecialCharTok{/} \DecValTok{2}
\NormalTok{      end }\OtherTok{\textless{}{-}}\NormalTok{ center }\SpecialCharTok{+}\NormalTok{ long }\SpecialCharTok{/} \DecValTok{2}
      \FunctionTok{round}\NormalTok{(start)}\SpecialCharTok{:}\FunctionTok{round}\NormalTok{(end)}
\NormalTok{    \})}
\NormalTok{  res }\OtherTok{\textless{}{-}}\NormalTok{ png[sel[[}\DecValTok{2}\NormalTok{]], sel[[}\DecValTok{1}\NormalTok{]], ]}
  \ControlFlowTok{if}\NormalTok{ (as.grob) \{}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{rasterGrob}\NormalTok{(res)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(res)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# shape}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{simulate\_peaks }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{all\_range =} \FunctionTok{list}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{30}\NormalTok{, }\DecValTok{31}\SpecialCharTok{:}\DecValTok{60}\NormalTok{, }\DecValTok{61}\SpecialCharTok{:}\DecValTok{100}\NormalTok{, }\DecValTok{101}\SpecialCharTok{:}\DecValTok{140}\NormalTok{),}
  \AttributeTok{shift =} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(shift, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(shift), }\AttributeTok{SIMPLIFY =}\NormalTok{ F, }\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(shift, id)\{}
\NormalTok{    peak }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(all\_range, }\AttributeTok{SIMPLIFY =}\NormalTok{ F,}
      \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(range)\{}
\NormalTok{        peak }\OtherTok{\textless{}{-}} \FunctionTok{dnorm}\NormalTok{(range, }\FunctionTok{median}\NormalTok{(range) }\SpecialCharTok{+}\NormalTok{ shift, }\FunctionTok{rnorm}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\FloatTok{1.2}\NormalTok{)) }\SpecialCharTok{*}
          \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\FloatTok{0.15}\NormalTok{)}
\NormalTok{      \})}
\NormalTok{    feature }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(all\_range), }\FunctionTok{lengths}\NormalTok{(all\_range),}
      \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(seq, rep)\{}
        \FunctionTok{rep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"peak"}\NormalTok{, seq), rep)}
\NormalTok{      \})}
\NormalTok{    tibble}\SpecialCharTok{::}\FunctionTok{tibble}\NormalTok{(}\AttributeTok{x =} \FunctionTok{unlist}\NormalTok{(all\_range), }\AttributeTok{y =} \FunctionTok{unlist}\NormalTok{(peak),}
      \AttributeTok{sample =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"sample"}\NormalTok{, id),}
      \AttributeTok{peak =} \FunctionTok{unlist}\NormalTok{(feature)}
\NormalTok{    )}
\NormalTok{  \})}
\NormalTok{  data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# get\_ggsets}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @export nebulae\_as\_grob}
\CommentTok{\#\textquotesingle{} @aliases nebulae\_as\_grob}
\CommentTok{\#\textquotesingle{} @title Convert Nebulae as \textquotesingle{}grob\textquotesingle{} object}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{nebulae\_as\_grob\}: This will convert Child{-}Nebulae}
\CommentTok{\#\textquotesingle{} as a \textquotesingle{}grob\textquotesingle{} object. See package \textasciigrave{}grid\textasciigrave{} about \textquotesingle{}grob\textquotesingle{} object.}
\CommentTok{\#\textquotesingle{} @param x [mcnebula{-}class] object.}
\CommentTok{\#\textquotesingle{} @rdname nebulae\_as\_grob}
\NormalTok{nebulae\_as\_grob }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{  chAsGrob }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ch, x) \{}
\NormalTok{    ggset }\OtherTok{\textless{}{-}} \FunctionTok{modify\_default\_child}\NormalTok{(ch)}
    \FunctionTok{as\_grob}\NormalTok{(}\FunctionTok{call\_command}\NormalTok{(ggset))}
\NormalTok{  \}}
\NormalTok{  sets }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{ggset}\NormalTok{(}\FunctionTok{child\_nebulae}\NormalTok{(x)), chAsGrob, }\AttributeTok{x =}\NormalTok{ x)}
\NormalTok{  sets }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(sets),}
    \ControlFlowTok{function}\NormalTok{(name) \{}
      \FunctionTok{ggather}\NormalTok{(sets[[name]],}
        \AttributeTok{vp =} \FunctionTok{viewports}\NormalTok{(}\FunctionTok{child\_nebulae}\NormalTok{(x))[[name]])}
\NormalTok{    \})}
\NormalTok{  sets\_vp }\OtherTok{\textless{}{-}} \FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid\_layout}\NormalTok{(}\FunctionTok{child\_nebulae}\NormalTok{(x)))}
\NormalTok{  sets }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(ggather, }\FunctionTok{c}\NormalTok{(sets, }\FunctionTok{list}\NormalTok{(}\AttributeTok{vp =}\NormalTok{ sets\_vp)))}
\NormalTok{  legendH }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.legend\_hierarchy}\NormalTok{(}\FunctionTok{child\_nebulae}\NormalTok{(x), x)}
\NormalTok{  legendG }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.get\_legend}\NormalTok{(}
    \FunctionTok{call\_command}\NormalTok{(}\FunctionTok{modify\_default\_child}\NormalTok{(}\FunctionTok{ggset}\NormalTok{(}\FunctionTok{child\_nebulae}\NormalTok{(x))[[}\DecValTok{1}\NormalTok{]], x))}
\NormalTok{  )}
  \DocumentationTok{\#\# integrate}
\NormalTok{  vis }\OtherTok{\textless{}{-}} \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{sets =} \DecValTok{5}\NormalTok{, }\AttributeTok{legendH =}\NormalTok{ .}\DecValTok{5}\NormalTok{), }\FunctionTok{namel}\NormalTok{(sets, legendH))}
\NormalTok{  vis }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{vis =} \DecValTok{4}\NormalTok{, }\AttributeTok{legendG =} \DecValTok{1}\NormalTok{), }\FunctionTok{namel}\NormalTok{(vis, legendG))}
\NormalTok{  vis}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-hugo_doks.r}{%
\section{File: hugo\_doks.R}\label{file-hugo_doks.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{set\_hugoDir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path) \{}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"hugoDir"}\NormalTok{, path, }\FunctionTok{topenv}\NormalTok{())}
\NormalTok{\}}

\NormalTok{hugoDir }\OtherTok{\textless{}{-}} \StringTok{"\textasciitilde{}/siteBlog/"}

\NormalTok{new\_notes }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(scene, weight, }\AttributeTok{parent =} \StringTok{"notes"}\NormalTok{) \{}
  \FunctionTok{names}\NormalTok{(scene) }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(parent, }\FunctionTok{length}\NormalTok{(scene))}
\NormalTok{  weight }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(weight, }\FunctionTok{length}\NormalTok{(scene))}
\NormalTok{  ex\_weight }\OtherTok{\textless{}{-}}\NormalTok{ weight }\SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(scene)}
  \FunctionTok{new\_scene}\NormalTok{(scene, weight, ex\_weight)}
\NormalTok{\}}

\NormalTok{new\_scene }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(scene, }\AttributeTok{weight =} \FunctionTok{rep}\NormalTok{(}\DecValTok{100}\NormalTok{, }\FunctionTok{length}\NormalTok{(scene)), }\AttributeTok{ex\_weight =}\NormalTok{ weight,}
    \AttributeTok{path =}\NormalTok{ hugoDir, }\AttributeTok{suffix =} \StringTok{"/content/en"}\NormalTok{, }\AttributeTok{tar =} \StringTok{"docs"}\NormalTok{, }\AttributeTok{index\_Draft =}\NormalTok{ T)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.vector}\NormalTok{(scene)) \{}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"is.vector(scene) == F"}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.character}\NormalTok{(}\FunctionTok{names}\NormalTok{(scene)))\{}
      \FunctionTok{stop}\NormalTok{( }\StringTok{"is.character(names(scene)) == F"}\NormalTok{ )}
\NormalTok{    \}}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, suffix)}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{target\_dir}\NormalTok{(path, tar)}
    \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(scene),}
      \ControlFlowTok{function}\NormalTok{(n)\{}
\NormalTok{        name }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(scene)[n]}
\NormalTok{        dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name)}
        \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{dir.exists}\NormalTok{(dir)) \{}
          \FunctionTok{dir.create}\NormalTok{(dir)}
          \ControlFlowTok{if}\NormalTok{ (index\_Draft) \{}
\NormalTok{            index }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/\_index.Rmd"}\NormalTok{)}
            \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{index\_Draft}\NormalTok{(name, weight[[n]]), index)}
\NormalTok{          \}}
\NormalTok{        \}}
\NormalTok{        file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, scene[[n]], }\StringTok{".Rmd"}\NormalTok{)}
        \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(file)) \{}
          \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{Draft}\NormalTok{(scene[[n]], ex\_weight[[n]], tar, name), file)}
\NormalTok{        \}}
\NormalTok{      \})}
    \FunctionTok{message}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}

\NormalTok{target\_dir }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(path, tar)\{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{list.dirs}\NormalTok{(path, }\AttributeTok{recursive =}\NormalTok{ T)}
\NormalTok{    lst }\OtherTok{\textless{}{-}}\NormalTok{ lst[}\FunctionTok{grepl}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}=/)"}\NormalTok{, tar, }\StringTok{"$"}\NormalTok{), lst, }\AttributeTok{perl =}\NormalTok{ T)][}\DecValTok{1}\NormalTok{]}
\NormalTok{    lst}
\NormalTok{  \}}

\NormalTok{record\_time }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{()\{}
  \FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\StringTok{"\%Y \%b \%e \%H:\%M:\%S | \%a"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{Draft }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(title, }\AttributeTok{weight =} \DecValTok{100}\NormalTok{, tar, name)\{}
\NormalTok{  title }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\_"}\NormalTok{, }\StringTok{" "}\NormalTok{, title)}
  \FunctionTok{c}\NormalTok{(}\StringTok{"{-}{-}{-}"}\NormalTok{,}
    \StringTok{"contributors:}\SpecialCharTok{\textbackslash{}n}\StringTok{{-} LiChuang Huang"}\NormalTok{,}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"title: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"date: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\FunctionTok{record\_time}\NormalTok{(), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"lastmod: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\FunctionTok{record\_time}\NormalTok{(), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \StringTok{"draft: false"}\NormalTok{,}
    \StringTok{"images: []"}\NormalTok{,}
    \StringTok{"menu:"}\NormalTok{,}
    \FunctionTok{strwrap}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(tar, }\StringTok{":"}\NormalTok{), }\AttributeTok{indent =} \DecValTok{2}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{strwrap}\NormalTok{(}\StringTok{"parent:"}\NormalTok{, }\AttributeTok{indent =} \DecValTok{4}\NormalTok{), }\StringTok{" }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, name, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"weight: "}\NormalTok{, weight),}
    \StringTok{"toc: true"}\NormalTok{,}
    \StringTok{"{-}{-}{-}"}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{index\_Draft }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(title, }\AttributeTok{weight =} \DecValTok{100}\NormalTok{)\{}
\NormalTok{  title }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\_"}\NormalTok{, }\StringTok{" "}\NormalTok{, title)}
  \FunctionTok{c}\NormalTok{(}\StringTok{"{-}{-}{-}"}\NormalTok{,}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"title: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"date: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{record\_time}\NormalTok{()), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"lastmod: "}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\FunctionTok{format}\NormalTok{(}\FunctionTok{Sys.time}\NormalTok{(), }\FunctionTok{record\_time}\NormalTok{()), }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{),}
    \StringTok{"draft: false"}\NormalTok{,}
    \StringTok{"images: []"}\NormalTok{,}
    \FunctionTok{paste0}\NormalTok{(}\StringTok{"weight: "}\NormalTok{, weight),}
    \StringTok{"toc: true"}\NormalTok{,}
    \StringTok{"{-}{-}{-}"}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{target\_file }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(path, tar)\{}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{recursive =}\NormalTok{ T, }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    lst }\OtherTok{\textless{}{-}}\NormalTok{ lst[}\FunctionTok{grepl}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}=/)"}\NormalTok{, tar, }\StringTok{"$"}\NormalTok{), lst, }\AttributeTok{perl =}\NormalTok{ T)][}\DecValTok{1}\NormalTok{]}
\NormalTok{    lst}
\NormalTok{  \}}

\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, ...) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{))}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{()\{}
    \ControlFlowTok{function}\NormalTok{(}\AttributeTok{path =} \FunctionTok{paste0}\NormalTok{(hugoDir, }\StringTok{"/config"}\NormalTok{), }\AttributeTok{tar =} \StringTok{"params.toml"}\NormalTok{) \{}
      \FunctionTok{target\_file}\NormalTok{(path, tar)}
\NormalTok{    \}}
\NormalTok{  \})}

\FunctionTok{setMethod}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"set\_home"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"vector"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, ...)\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{set\_home}\NormalTok{()(...)}
\NormalTok{    lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(path)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{names}\NormalTok{(x)) \{}
\NormalTok{      lines }\OtherTok{\textless{}{-}} \FunctionTok{repl\_huto}\NormalTok{(i, x[[i]], lines)}
\NormalTok{    \}}
    \FunctionTok{writeLines}\NormalTok{(lines, path)}
\NormalTok{  \})}

\NormalTok{repl\_huto }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(key, content, lines,}
    \AttributeTok{left =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\AttributeTok{right =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\AttributeTok{link =} \StringTok{" = "}\NormalTok{)\{}
\NormalTok{    pattern }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s\{0,\}"}\NormalTok{, key, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s\{0,\}(?![a{-}z|A{-}Z|0{-}9|\_|.])"}\NormalTok{)}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(pattern, lines, }\AttributeTok{perl =}\NormalTok{ T)}
\NormalTok{    pattern }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}="}\NormalTok{, link, left, }\StringTok{")"}\NormalTok{, }\StringTok{"[\^{}}\SpecialCharTok{\textbackslash{}"}\StringTok{]\{1,\}"}\NormalTok{, }\StringTok{"(?="}\NormalTok{, right, }\StringTok{")"}\NormalTok{)}
\NormalTok{    lines[n] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(pattern, content, lines[n], }\AttributeTok{perl =}\NormalTok{ T)}
\NormalTok{    lines}
\NormalTok{  \}}
\NormalTok{repl\_yaml }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(key, content, lines)\{}
  \FunctionTok{repl\_huto}\NormalTok{(key, content, lines, }\AttributeTok{link =} \StringTok{": |: }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,}
    \AttributeTok{left =} \StringTok{""}\NormalTok{, }\AttributeTok{right =} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{|$"}
\NormalTok{  )}
\NormalTok{\}}

\FunctionTok{setGeneric}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{, }
  \ControlFlowTok{function}\NormalTok{(x, tar, ...) }\FunctionTok{standardGeneric}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{))}
\FunctionTok{setMethod}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{()\{}
    \ControlFlowTok{function}\NormalTok{(}\AttributeTok{tar =} \StringTok{"en/\_index.Rmd"}\NormalTok{, }\AttributeTok{path =} \FunctionTok{paste0}\NormalTok{(hugoDir, }\StringTok{"/content/en"}\NormalTok{)) \{}
      \FunctionTok{target\_file}\NormalTok{(path, tar)}
\NormalTok{    \}}
\NormalTok{  \})}

\FunctionTok{setMethod}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{, }
  \AttributeTok{signature =} \FunctionTok{setMissing}\NormalTok{(}\StringTok{"set\_index"}\NormalTok{,}
    \AttributeTok{x =} \StringTok{"vector"}\NormalTok{,}
    \AttributeTok{tar =} \StringTok{"character"}\NormalTok{),}
  \ControlFlowTok{function}\NormalTok{(x, tar, ...)\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{set\_index}\NormalTok{()(tar, ...)}
\NormalTok{    lines }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(path)}
\NormalTok{    time }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}lastmod|\^{}date"}\NormalTok{, lines)}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ time) \{}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{": }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, lines[i]))}
\NormalTok{        lines[i] }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{": "}\NormalTok{, }\StringTok{": }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, lines[i])}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{$"}\NormalTok{, lines[i]))}
\NormalTok{        lines[i] }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{"$"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, lines[i])}
\NormalTok{    \}}
    \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \FunctionTok{names}\NormalTok{(x)) \{}
\NormalTok{      lines }\OtherTok{\textless{}{-}} \FunctionTok{repl\_yaml}\NormalTok{(i, x[[i]], lines)}
\NormalTok{    \}}
    \FunctionTok{writeLines}\NormalTok{(lines, path)}
\NormalTok{  \})}

\NormalTok{inht2 }\OtherTok{\textless{}{-}}\NormalTok{ inclu.fig.ht2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(src, }\AttributeTok{caption =} \StringTok{"..."}\NormalTok{,}
  \AttributeTok{file =} \FunctionTok{get\_filename}\NormalTok{(src), }\AttributeTok{parent =} \StringTok{"/docs/notes/"}\NormalTok{,}
  \AttributeTok{parent.ex =} \StringTok{"figs"}\NormalTok{, }\AttributeTok{width =} \StringTok{"100\%"}\NormalTok{, }\AttributeTok{height =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{rel.path =} \FunctionTok{paste0}\NormalTok{(hugoDir, }\StringTok{"/content/en"}\NormalTok{))}
\NormalTok{\{}
  \FunctionTok{inclu.fig.ht}\NormalTok{(src, }\AttributeTok{to =} \FunctionTok{paste0}\NormalTok{(parent, }\StringTok{"/"}\NormalTok{, parent.ex, }\StringTok{"/"}\NormalTok{, file), caption,}
\NormalTok{    width, height, rel.path)}
\NormalTok{\}}

\NormalTok{smallsvg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(p, file, }\AttributeTok{width =} \DecValTok{4}\NormalTok{, }\AttributeTok{height =} \DecValTok{3}\NormalTok{, }\AttributeTok{mkdir =} \StringTok{"figs"}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(mkdir))}
    \FunctionTok{dir.create}\NormalTok{(mkdir)}
  \FunctionTok{ggsave}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(mkdir, }\StringTok{"/"}\NormalTok{, file), p, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{\}}

\NormalTok{inclu.fig.ht }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(src, to, }\AttributeTok{caption =} \StringTok{"This is a figure"}\NormalTok{,}
  \AttributeTok{width =} \StringTok{"100\%"}\NormalTok{, }\AttributeTok{height =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{rel.path =} \FunctionTok{paste0}\NormalTok{(hugoDir, }\StringTok{"/content/en"}\NormalTok{))}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(rel.path, to))) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(src)) \{}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"file.exists("}\NormalTok{, src, }\StringTok{") == F"}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, src)) \{}
      \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"pdf2svg "}\NormalTok{, src, }\StringTok{" "}\NormalTok{, rel.path, to, }\StringTok{" 1"}\NormalTok{))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
      \FunctionTok{file.copy}\NormalTok{(src, }\FunctionTok{paste0}\NormalTok{(rel.path, to))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  draft }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"\textless{}figure\textgreater{}"}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{""}\NormalTok{, }\StringTok{"\textless{}/figure\textgreater{}"}\NormalTok{)}
\NormalTok{  img }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textless{}center\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}img src=}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, to, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, }\StringTok{"\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}/center\textgreater{}"}\NormalTok{)}
\NormalTok{  cap }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textless{}center\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}figcaption\textgreater{}"}\NormalTok{, caption, }\StringTok{"\textless{}/figcaption\textgreater{}"}\NormalTok{, }\StringTok{"\textless{}/center\textgreater{}"}\NormalTok{)}
\NormalTok{  draft[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(img, cap)}
  \FunctionTok{writeLines}\NormalTok{(draft)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-lite_research.r}{%
\section{File: lite\_research.R}\label{file-lite_research.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# plot or ...}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{bibnetwork }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(db, save, }\AttributeTok{topic =} \StringTok{"keywords"}\NormalTok{, }\AttributeTok{n =} \DecValTok{30}\NormalTok{,}
  \AttributeTok{labelsize =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{seed =} \DecValTok{20}\NormalTok{, }\AttributeTok{cluster =} \StringTok{"none"}\NormalTok{, }\AttributeTok{width =} \DecValTok{12}\NormalTok{, }\AttributeTok{height =} \DecValTok{7}\NormalTok{,}
  \AttributeTok{title =} \StringTok{""}\NormalTok{, ...)}
\NormalTok{\{}
\NormalTok{  NetMatrix }\OtherTok{\textless{}{-}}\NormalTok{ bibliometrix}\SpecialCharTok{::}\FunctionTok{biblioNetwork}\NormalTok{(}
\NormalTok{    db, }\AttributeTok{analysis =} \StringTok{"co{-}occurrences"}\NormalTok{, }\AttributeTok{network =}\NormalTok{ topic, }\AttributeTok{sep =} \StringTok{";"}
\NormalTok{  )}
  \FunctionTok{pdf}\NormalTok{(save, width, height)}
  \FunctionTok{set.seed}\NormalTok{(seed)}
\NormalTok{  net }\OtherTok{\textless{}{-}}\NormalTok{ bibliometrix}\SpecialCharTok{::}\FunctionTok{networkPlot}\NormalTok{(}
\NormalTok{    NetMatrix, }\AttributeTok{normalize =} \StringTok{"association"}\NormalTok{,}
    \AttributeTok{weighted =}\NormalTok{ T, }\AttributeTok{n =}\NormalTok{ n, }\AttributeTok{Title =}\NormalTok{ title,}
    \AttributeTok{type =} \StringTok{"fruchterman"}\NormalTok{, }\AttributeTok{size =}\NormalTok{ T, }\AttributeTok{edgesize =} \DecValTok{5}\NormalTok{, }\AttributeTok{labelsize =}\NormalTok{ labelsize,}
    \AttributeTok{cluster =}\NormalTok{ cluster, ...}
\NormalTok{  )}
  \FunctionTok{dev.off}\NormalTok{()}
  \FunctionTok{return}\NormalTok{(net)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-lite.citation.r}{%
\section{File: lite.citation.R}\label{file-lite.citation.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# manualy set figure number in artical}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}
\NormalTok{pandoc.docx }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    file.md,}
    \AttributeTok{format =} \StringTok{".docx"}\NormalTok{,}
    \AttributeTok{output =} \FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.[a{-}z]*$"}\NormalTok{, format, file.md),}
    \AttributeTok{deal\_with =}\NormalTok{ T,}
    \AttributeTok{script =} \StringTok{"pandoc.sh"}\NormalTok{,}
    \AttributeTok{script\_path =} \FunctionTok{system.file}\NormalTok{(}\StringTok{"extdata"}\NormalTok{, script, }\AttributeTok{package =} \StringTok{"utils.tool"}\NormalTok{),}
    \AttributeTok{template =} \StringTok{"template.tex"}\NormalTok{,}
    \AttributeTok{hasLink =}\NormalTok{ T}
\NormalTok{  )}
\NormalTok{  \{}
    \DocumentationTok{\#\# read md}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file.md)}
    \ControlFlowTok{if}\NormalTok{ (deal\_with) \{}
\NormalTok{      citation }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(md, }\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[citation}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]: .*$"}\NormalTok{)}
      \DocumentationTok{\#\# get all citation}
\NormalTok{      citation }\OtherTok{\textless{}{-}}\NormalTok{ citation[}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(citation)]}
\NormalTok{      citation.key }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(citation, }\StringTok{"(?\textless{}=@).\{1,20\}(?=:)"}\NormalTok{)}
      \DocumentationTok{\#\# unique}
\NormalTok{      citation.key }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(citation.key)}
      \DocumentationTok{\#\# paste as pattern.set}
\NormalTok{      pattern.set }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}
        \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{@"}\NormalTok{, citation.key, }\StringTok{":[\^{}\{]\{1,50\}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{,}
        \ControlFlowTok{if}\NormalTok{ (hasLink) }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{nolink=True}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"} \ControlFlowTok{else} \ConstantTok{NULL}
\NormalTok{      )}
\NormalTok{      record }\OtherTok{\textless{}{-}}  \FunctionTok{lapply}\NormalTok{(pattern.set,}
        \ControlFlowTok{function}\NormalTok{(pattern)\{}
\NormalTok{          cite }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(citation, pattern)}
\NormalTok{          cite }\OtherTok{\textless{}{-}}\NormalTok{ cite[}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(cite)]}
          \DocumentationTok{\#\# as table}
\NormalTok{          df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{cite =}\NormalTok{ cite, }\AttributeTok{seq =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(cite))}
          \DocumentationTok{\#\# replace}
\NormalTok{          md }\OtherTok{\textless{}{-}} \FunctionTok{mapply\_rename\_col}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{cite, df}\SpecialCharTok{$}\NormalTok{seq, md)}
          \DocumentationTok{\#\# push to parent envir}
          \FunctionTok{assign}\NormalTok{(}\StringTok{"md"}\NormalTok{, md, }\AttributeTok{envir =} \FunctionTok{parent.frame}\NormalTok{(}\DecValTok{2}\NormalTok{))}
          \FunctionTok{return}\NormalTok{(df)}
\NormalTok{        \})}
\NormalTok{    \}}
    \FunctionTok{cat}\NormalTok{(md, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{file =} \StringTok{".TMP.md"}\NormalTok{)}
\NormalTok{    tmp\_script }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{".TMP."}\NormalTok{, script)}
    \FunctionTok{file.copy}\NormalTok{(script\_path, tmp\_script)}
    \FunctionTok{file.copy}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/custom{-}reference.docx"}\NormalTok{), }\StringTok{"custom{-}reference.docx"}\NormalTok{)}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"bash "}\NormalTok{, tmp\_script, }\StringTok{" .TMP.md "}\NormalTok{, output, }\StringTok{" "}\NormalTok{, template))}
    \FunctionTok{file.remove}\NormalTok{(tmp\_script, }\StringTok{"custom{-}reference.docx"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (deal\_with)}
      \FunctionTok{return}\NormalTok{(record)}
\NormalTok{  \}}

\NormalTok{read\_captions }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file.md, }\AttributeTok{sig =} \StringTok{"Fig. }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{@.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{|"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{sep\_list}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(file.md))}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(lst, }\ControlFlowTok{function}\NormalTok{(ch) }\FunctionTok{grepl}\NormalTok{(sig, ch[}\DecValTok{1}\NormalTok{]), }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst[pos],}
    \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{      ch }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(ch, }\AttributeTok{collapse =} \StringTok{" "}\NormalTok{)}
      \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.* }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{| "}\NormalTok{, }\StringTok{"**"}\NormalTok{, ch)}
\NormalTok{    \})}
\NormalTok{  lst}
\NormalTok{\}}

\NormalTok{read\_bib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(bib) \{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{sep\_list}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(bib))}
  \FunctionTok{getKey.biblst}\NormalTok{(lst)}
\NormalTok{\}}

\NormalTok{shunt\_bib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(bib, keys, }\AttributeTok{export =} \StringTok{"library.bib"}\NormalTok{)\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{read\_bib}\NormalTok{(bib)}
\NormalTok{  lst }\OtherTok{\textless{}{-}}\NormalTok{ lst[}\FunctionTok{names}\NormalTok{(lst) }\SpecialCharTok{\%in\%}\NormalTok{ keys]}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(lst)}
  \FunctionTok{writeLines}\NormalTok{(lst, export)}
\NormalTok{\}}

\NormalTok{asTex.rmd }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file.md, }\AttributeTok{yaml =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/"}\NormalTok{, }\StringTok{"article.yml"}\NormalTok{),}
  \AttributeTok{export =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"tex\_"}\NormalTok{, }\FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.[a{-}z]*$"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{get\_filename}\NormalTok{(file.md))),}
  \AttributeTok{bib =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/library.bib"}\NormalTok{), }\AttributeTok{style =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/style.csl"}\NormalTok{))}
\NormalTok{\{}
  \FunctionTok{dir.create}\NormalTok{(export)}
  \FunctionTok{file.copy}\NormalTok{(file.md, nfile.md }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(export, }\StringTok{"/"}\NormalTok{,}
      \FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.[a{-}z]*$"}\NormalTok{, }\StringTok{".Rmd"}\NormalTok{, }\FunctionTok{get\_filename}\NormalTok{(file.md))), T)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(nfile.md)}
\NormalTok{  fig.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}!}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)"}\NormalTok{, md)}
\NormalTok{  fig.num }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{  md[fig.pos] }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(md[fig.pos], }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
    \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{      file }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ch, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{().*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{))"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}!}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, ch)) \{}
\NormalTok{        prefix }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"fig"}\NormalTok{, fig.num, }\StringTok{"."}\NormalTok{)}
\NormalTok{        fig.num }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ fig.num }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        prefix }\OtherTok{\textless{}{-}} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{      nfile }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"fig[0{-}9]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{, prefix, }\FunctionTok{get\_filename}\NormalTok{(file))}
\NormalTok{      whether }\OtherTok{\textless{}{-}} \FunctionTok{file.copy}\NormalTok{(file, }\FunctionTok{paste0}\NormalTok{(export, }\StringTok{"/"}\NormalTok{, nfile), T)}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{whether) }\FunctionTok{stop}\NormalTok{(}\StringTok{"The file of figure not found"}\NormalTok{)}
      \FunctionTok{gsub}\NormalTok{(file, nfile, ch, }\AttributeTok{fixed =}\NormalTok{ T)}
\NormalTok{    \})}
\NormalTok{  yml }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"{-}{-}{-}"}\NormalTok{, }\FunctionTok{readLines}\NormalTok{(yaml), }\StringTok{"{-}{-}{-}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{c}\NormalTok{(yml, md), nfile.md)}
  \FunctionTok{shunt\_bib}\NormalTok{(bib, }\FunctionTok{extract\_ref}\NormalTok{(nfile.md), }\FunctionTok{paste0}\NormalTok{(export, }\StringTok{"/"}\NormalTok{, }\StringTok{"library.bib"}\NormalTok{))}
  \FunctionTok{file.copy}\NormalTok{(style, }\FunctionTok{paste0}\NormalTok{(export, }\StringTok{"/"}\NormalTok{, }\FunctionTok{get\_filename}\NormalTok{(style)), T)}
  \FunctionTok{writeLines}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{sep\_list }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines, }\AttributeTok{sep =} \StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*$"}\NormalTok{, }\AttributeTok{before =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  seps }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(sep, lines) }\SpecialCharTok{+} \ControlFlowTok{if}\NormalTok{ (before) }\DecValTok{0} \ControlFlowTok{else} \DecValTok{1}
\NormalTok{  group }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{  groups }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(lines), }\AttributeTok{FUN.VALUE =} \FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(n }\SpecialCharTok{==}\NormalTok{ seps)) }
\NormalTok{        group }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ group }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{      group}
\NormalTok{    \})}
  \FunctionTok{split}\NormalTok{(lines, groups)}
\NormalTok{\}}

\NormalTok{getKey.biblst }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst)\{}
  \FunctionTok{names}\NormalTok{(lst) }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(lst, }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
    \ControlFlowTok{function}\NormalTok{(lines) \{}
      \FunctionTok{paste0}\NormalTok{(}\StringTok{"@"}\NormalTok{, stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(lines[}\DecValTok{1}\NormalTok{], }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{).*(?=,$)"}\NormalTok{))}
\NormalTok{    \})}
\NormalTok{  lst}
\NormalTok{\}}

\NormalTok{getFilePath.biblst }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst)\{}
  \FunctionTok{lapply}\NormalTok{(lst,}
    \ControlFlowTok{function}\NormalTok{(lines)\{}
\NormalTok{      n.file }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*file"}\NormalTok{, lines)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(n.file) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) \{}
\NormalTok{        stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(lines[n.file], }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{).*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}\NormalTok{)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
        \ConstantTok{NULL}
\NormalTok{      \}}
\NormalTok{    \})}
\NormalTok{\}}

\NormalTok{fix\_ch2en }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md)\{}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"（"}\NormalTok{, }\StringTok{" ("}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"）"}\NormalTok{, }\StringTok{") "}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"："}\NormalTok{, }\StringTok{": "}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"[\textbackslash{}u2002]"}\NormalTok{, }\StringTok{" "}\NormalTok{, md)}
\NormalTok{  md}
\NormalTok{\}}

\NormalTok{cite\_extract }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data) \{}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{    data, }\AttributeTok{cite =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(cite, }\StringTok{"(?\textless{}=:)[a{-}zA{-}Z0{-}9\_.]\{1,\}(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{.as\_dic}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{seq, data}\SpecialCharTok{$}\NormalTok{cite)}
\NormalTok{\}}

\NormalTok{fts\_copy }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ft, seq.lst, path, }\AttributeTok{prefix =} \StringTok{"fig"}\NormalTok{, }\AttributeTok{sub\_target =} \StringTok{"fts"}\NormalTok{) \{}
  \FunctionTok{lapply}\NormalTok{(ft, }\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    name }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{..*$"}\NormalTok{, }\StringTok{""}\NormalTok{, x[}\DecValTok{2}\NormalTok{])}
    \FunctionTok{file.copy}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, x[}\DecValTok{1}\NormalTok{]),}
      \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, sub\_target, }\StringTok{"/"}\NormalTok{, prefix, seq.lst[[ name ]], }\StringTok{"."}\NormalTok{, x[}\DecValTok{2}\NormalTok{]), T)}
\NormalTok{  \})}
\NormalTok{\}}

\NormalTok{insert\_tocg }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md, fig) \{}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}\#\# Abstract"}\NormalTok{, md)}
\NormalTok{  blanks }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*$"}\NormalTok{, md)}
\NormalTok{  pos }\OtherTok{\textless{}{-}}\NormalTok{ blanks[blanks }\SpecialCharTok{\textgreater{}}\NormalTok{ pos }\SpecialCharTok{+} \DecValTok{1}\NormalTok{][}\DecValTok{1}\NormalTok{]}
\NormalTok{  md[pos] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(md[pos], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{includegraphics"}\NormalTok{, }\StringTok{"\{"}\NormalTok{, fig, }\StringTok{"\}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  md}
\NormalTok{\}}

\NormalTok{insert\_figs }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md, ids, figs, captions,}
  \AttributeTok{patterns =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Fig}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{. "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ids)),}
  \AttributeTok{at\_ref =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"Fig. \{@fig:"}\NormalTok{, ids, }\StringTok{"\}"}\NormalTok{),}
  \AttributeTok{figs\_command =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"!["}\NormalTok{, }\FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\StringTok{""}\NormalTok{, captions), }\StringTok{"]"}\NormalTok{,}
    \StringTok{"("}\NormalTok{, figs, }\StringTok{")"}\NormalTok{, }\StringTok{"\{\#fig:"}\NormalTok{, ids, }\StringTok{"\}"}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  fb }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, blanks) \{}
\NormalTok{    blanks[blanks }\SpecialCharTok{\textgreater{}}\NormalTok{ n][}\DecValTok{1}\NormalTok{]}
\NormalTok{  \}}
\NormalTok{  insert }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(i, ch) \{}
    \FunctionTok{paste0}\NormalTok{(ch, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, figs\_command[i], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  rp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ch, i)\{}
    \FunctionTok{gsub}\NormalTok{(patterns[i], at\_ref[i], ch)}
\NormalTok{  \}}
\NormalTok{  blanks }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*$"}\NormalTok{, md)}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ids)) \{}
\NormalTok{    ns }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(patterns[i], md)}
\NormalTok{    md[ns] }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{vapply}\NormalTok{(md[ns], rp, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{i =}\NormalTok{ i))}
\NormalTok{    insert.pos }\OtherTok{\textless{}{-}} \FunctionTok{fb}\NormalTok{(ns[}\DecValTok{1}\NormalTok{], blanks)}
\NormalTok{    md[insert.pos] }\OtherTok{\textless{}{-}} \FunctionTok{insert}\NormalTok{(i, md[insert.pos])}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(md)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# post modification (reference version dependent)}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\DocumentationTok{\#\# Science bulletin}

\NormalTok{extract\_ref\_pan2md.sci\_bull }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md)\{}
\NormalTok{  ref }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(md, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[.*?}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{))}
  \FunctionTok{generate\_ref\_key}\NormalTok{(ref)}
\NormalTok{\}}

\DocumentationTok{\#\# Vancouver (superscript); ac}

\NormalTok{revise\_pan2md.vanco }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{output =} \StringTok{"tmp.md"}\NormalTok{)\{}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{revise\_symbol\_pan2md}\NormalTok{(md)}
  \DocumentationTok{\#\# ref}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"log2"}\NormalTok{, }\StringTok{"log\textasciitilde{}2\textasciitilde{}"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"log10"}\NormalTok{, }\StringTok{"log\textasciitilde{}10\textasciitilde{}"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(\#ref{-}[0{-}9a{-}zA{-}Z\_.]*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)"}\NormalTok{, }\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{l)"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}"}\NormalTok{, }\StringTok{"\^{}["}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{l}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)"}\NormalTok{, }\StringTok{"](}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{l)\^{}"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\StringTok{"]\^{}"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{l}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)(?!,}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{})"}\NormalTok{, }\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{l)\^{}"}\NormalTok{, md, }\AttributeTok{perl =}\NormalTok{ T)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(?\textless{}!}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}|l}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{),|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-})}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[(?=[0{-}9])"}\NormalTok{, }\StringTok{"\^{}["}\NormalTok{, md, }\AttributeTok{perl =}\NormalTok{ T)}
  \FunctionTok{return}\NormalTok{(md)}
\NormalTok{\}}

\NormalTok{extract\_ref\_pan2md.vanco }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md) \{}
\NormalTok{  ref }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(md, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[.*?}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[[0{-}9}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}]*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\^{}"}\NormalTok{))}
  \FunctionTok{generate\_ref\_key}\NormalTok{(ref)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# utilites for revise}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{revise\_pan2md }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{output =} \StringTok{"tmp.md"}\NormalTok{) \{}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{revise\_symbol\_pan2md}\NormalTok{(md)}
\NormalTok{\}}

\NormalTok{revise\_symbol\_pan2md }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md) \{}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{\textless{}"}\NormalTok{, }\StringTok{"\&lt;"}\NormalTok{, md)}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{\textgreater{}"}\NormalTok{, }\StringTok{"\&gt;"}\NormalTok{, md)}
\NormalTok{  md}
\NormalTok{\}}

\DocumentationTok{\#\# the sep is ",|{-}{-}"}
\NormalTok{generate\_ref\_key }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ref, }\AttributeTok{pattern =} \StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[)[0{-}9]\{1,\}(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{])"}\NormalTok{) \{}
\NormalTok{  ref\_num }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(ref, pattern)}
\NormalTok{  ref\_sep }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(ref, }\StringTok{",|{-}{-}"}\NormalTok{)}
\NormalTok{  key }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ref\_num),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{      ch }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\StringTok{""}\NormalTok{, }\FunctionTok{length}\NormalTok{(ref\_num[[n]]) }\SpecialCharTok{*} \DecValTok{2} \SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
      \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(ch)) \{}
        \ControlFlowTok{if}\NormalTok{ (i }\SpecialCharTok{\%\%} \DecValTok{2} \SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{          ch[i] }\OtherTok{\textless{}{-}}\NormalTok{ ref\_num[[n]][(i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \DecValTok{2}\NormalTok{]}
        \ControlFlowTok{else}
\NormalTok{          ch[i] }\OtherTok{\textless{}{-}}\NormalTok{ ref\_sep[[n]][i }\SpecialCharTok{/} \DecValTok{2}\NormalTok{]}
\NormalTok{      \}}
\NormalTok{      set }\OtherTok{\textless{}{-}} \FunctionTok{integer}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\NormalTok{      i }\OtherTok{\textless{}{-}} \DecValTok{1}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(ch) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) \{}
        \ControlFlowTok{while}\NormalTok{(i }\SpecialCharTok{\textless{}} \FunctionTok{length}\NormalTok{(ch)) \{}
          \ControlFlowTok{if}\NormalTok{ (ch[ i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{ ] }\SpecialCharTok{==} \StringTok{","}\NormalTok{) \{}
\NormalTok{            set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(set, }\FunctionTok{as.integer}\NormalTok{(ch[i]))}
\NormalTok{          \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (ch[ i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"{-}{-}"}\NormalTok{) \{}
\NormalTok{            set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(set, }\FunctionTok{as.integer}\NormalTok{(ch[i])}\SpecialCharTok{:}\FunctionTok{as.integer}\NormalTok{(ch[i }\SpecialCharTok{+} \DecValTok{2}\NormalTok{]))}
\NormalTok{          \}}
\NormalTok{          i }\OtherTok{\textless{}{-}}\NormalTok{ i }\SpecialCharTok{+} \DecValTok{2}
\NormalTok{        \}}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        set }\OtherTok{\textless{}{-}} \FunctionTok{as.integer}\NormalTok{(ch)}
\NormalTok{      \}}
\NormalTok{      set}
\NormalTok{    \})}
  \FunctionTok{names}\NormalTok{(key) }\OtherTok{\textless{}{-}}\NormalTok{ ref}
\NormalTok{  key}
\NormalTok{\}}

\NormalTok{extract\_ref }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file) \{}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{  key }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(md, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{[|; |\^{})@[0{-}9|a{-}z|A{-}Z|\_}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}]*(?=;|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{])"}\NormalTok{)}
\NormalTok{  key }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(key))}
\NormalTok{  key[}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"@fig|@tab|@.*fig$|@.*tab$"}\NormalTok{, key)]}
\NormalTok{\}}

\NormalTok{comb\_ref }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n, ref) \{}
\NormalTok{  com }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(ref[n], }\AttributeTok{collapse =} \StringTok{"; "}\NormalTok{)}
  \FunctionTok{paste0}\NormalTok{(}\StringTok{" ["}\NormalTok{, com, }\StringTok{"]"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{get\_path }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path\_str)\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"/"}\NormalTok{, path\_str))}
    \FunctionTok{return}\NormalTok{(}\StringTok{"."}\NormalTok{)}
\NormalTok{  stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(path\_str, }\StringTok{".*(?=/)"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{get\_filename }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path\_str)\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"/"}\NormalTok{, path\_str))}
    \FunctionTok{return}\NormalTok{(path\_str)}
\NormalTok{  stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(path\_str, }\StringTok{"(?\textless{}=/)[\^{}/]*$"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# modify figure citation}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{rm.instFig }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md, }\AttributeTok{getID =}\NormalTok{ T) \{}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}!}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{["}\NormalTok{, md)}
\NormalTok{  target }\OtherTok{\textless{}{-}}\NormalTok{ md[pos]}
\NormalTok{  md[pos] }\OtherTok{\textless{}{-}} \StringTok{""}
  \ControlFlowTok{if}\NormalTok{ (getID) \{}
\NormalTok{    ids }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(}
\NormalTok{      target, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{\#).*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}
\NormalTok{    )}
\NormalTok{    notes }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{\textquotesingle{}[citation]: \{@\textquotesingle{}}\NormalTok{, ids, }\StringTok{\textquotesingle{}\}}\SpecialCharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(md, notes)}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(md)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-make_temp.r}{%
\section{File: make\_temp.R}\label{file-make_temp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Backing up temporary files}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{backup.tmp }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(tmp, }\AttributeTok{backup\_path =} \StringTok{"\textasciitilde{}/tmp\_backup/R"}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(backup\_path))}
    \FunctionTok{dir.create}\NormalTok{(backup\_path, }\AttributeTok{recursive =}\NormalTok{ T)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tmp))}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"file.exists(tmp) == F"}\NormalTok{)}
  \FunctionTok{file.copy}\NormalTok{(tmp, backup\_path, T, T)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-metabo_collate.r}{%
\section{File: metabo\_collate.R}\label{file-metabo_collate.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{metabo\_collate }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =} \StringTok{"\textasciitilde{}/Desktop"}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# read file}
\NormalTok{    compound }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =} \StringTok{"compound\_all.\{0,5\}.csv$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{()}
\NormalTok{    pathway }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =} \StringTok{"pathway\_enrichment.\{0,5\}.csv$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    pathway }\OtherTok{\textless{}{-}} \FunctionTok{metabo\_collate\_pathway}\NormalTok{(pathway)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    compound }\OtherTok{\textless{}{-}} \FunctionTok{metabo\_collate\_compound}\NormalTok{(compound)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# gather pathway and compound}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(pathway, merge, }\AttributeTok{y =}\NormalTok{ compound,}
                   \AttributeTok{by.x =} \StringTok{"compound"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"Empirical.Compound"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{as\_tibble)}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{metabo\_collate\_pathway }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           pathway}
\NormalTok{           )\{}
\NormalTok{    db }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(pathway, }\AttributeTok{pathway =}\NormalTok{ V1) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{by\_group\_as\_list}\NormalTok{(}\StringTok{"pathway"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(add\_row\_via\_separate\_col, }\AttributeTok{only\_split =}\NormalTok{ F)}
    \FunctionTok{return}\NormalTok{(db)}
\NormalTok{  \}}
\NormalTok{add\_row\_via\_separate\_col }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df\_row,}
           \AttributeTok{col =} \StringTok{"EC.Hits"}\NormalTok{,}
           \AttributeTok{only\_split =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}}\NormalTok{ df\_row[[col]] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{strsplit}\NormalTok{(}\AttributeTok{split =} \StringTok{";"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(only\_split }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(vector)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ vector }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{compound =}\NormalTok{ .)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    df\_row }\OtherTok{\textless{}{-}}\NormalTok{ df\_row }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      .[, }\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(.) }\SpecialCharTok{!=}\NormalTok{ col)] }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      .[}\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df)), ] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{bind\_cols}\NormalTok{(df) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(pathway, Hits.sig, Gamma, compound) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df\_row)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{metabo\_collate\_compound }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           compound}
\NormalTok{           )\{}
    \DocumentationTok{\#\# BiGG database download}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"bigg\_compound.tsv"}\NormalTok{) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{system}\NormalTok{(}\StringTok{"curl http://bigg.ucsd.edu/static/namespace/bigg\_models\_metabolites.txt \textgreater{} bigg\_compound.tsv"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    bigg }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\StringTok{"bigg\_compound.tsv"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(universal\_bigg\_id, name)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    part\_bigg }\OtherTok{\textless{}{-}}\NormalTok{ compound[[}\StringTok{"Matched.Compound"}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{bigg =}\NormalTok{ .) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{merge}\NormalTok{(bigg, }\AttributeTok{by.x =} \StringTok{"bigg"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"universal\_bigg\_id"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{distinct}\NormalTok{(bigg, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# main header: universal\_bigg\_id name}
    \DocumentationTok{\#\# API: KEGGREST::keggGet(vector) \#\# return a list}
\NormalTok{    part\_kegg }\OtherTok{\textless{}{-}}\NormalTok{ compound[[}\StringTok{"Matched.Compound"}\NormalTok{]] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}C[0{-}9]\{1,100\}$"}\NormalTok{, .)] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unique}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{kegg =}\NormalTok{ .) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =} \FunctionTok{batch\_kegg\_get}\NormalTok{(kegg))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    compound }\OtherTok{\textless{}{-}}\NormalTok{ compound }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# merge bigg compound name}
      \FunctionTok{merge}\NormalTok{(part\_bigg, }\AttributeTok{by.x =} \StringTok{"Matched.Compound"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"bigg"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# merge kegg compound name}
      \FunctionTok{merge}\NormalTok{(part\_kegg, }\AttributeTok{by.x =} \StringTok{"Matched.Compound"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"kegg"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(Query.Mass, Retention.Time, Matched.Compound, }\AttributeTok{.keep\_all =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{name =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(name.y), name.x, name.y)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{name.x, }\SpecialCharTok{{-}}\NormalTok{name.y) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{return}\NormalTok{(compound)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{batch\_kegg\_get }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           kegg}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# kegg compound query}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    db }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{kegg =}\NormalTok{ kegg, }\AttributeTok{seq =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(kegg)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{index =}\NormalTok{ (seq }\SpecialCharTok{{-}}\NormalTok{ seq }\SpecialCharTok{\%\%} \DecValTok{10}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{by\_group\_as\_list}\NormalTok{(}\StringTok{"index"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(select, kegg) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(unlist) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(unname) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(.meta\_kegg\_check\_kegg\_get) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unname}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{.meta\_kegg\_check\_kegg\_get }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           id\_set}
\NormalTok{           )\{}
\NormalTok{    db }\OtherTok{\textless{}{-}}\NormalTok{ KEGGREST}\SpecialCharTok{::}\FunctionTok{keggGet}\NormalTok{(id\_set) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(.meta\_kegg\_check\_get\_name) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{kegg =} \FunctionTok{names}\NormalTok{(.), }\AttributeTok{compound =} \FunctionTok{unname}\NormalTok{(.))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{kegg =}\NormalTok{ id\_set) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{merge}\NormalTok{(db, }\AttributeTok{by =} \StringTok{"kegg"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F)}
    \FunctionTok{return}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{compound)}
\NormalTok{  \}}
\NormalTok{.meta\_kegg\_check\_get\_name }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           list,}
           \AttributeTok{id =} \StringTok{"ENTRY"}\NormalTok{,}
           \AttributeTok{name =} \StringTok{"NAME"}
\NormalTok{           )\{}
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ list[[id]][}\DecValTok{1}\NormalTok{]}
\NormalTok{    compound }\OtherTok{\textless{}{-}}\NormalTok{ list[[name]][}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(compound))}
\NormalTok{      compound }\OtherTok{\textless{}{-}} \ConstantTok{NA}
    \FunctionTok{names}\NormalTok{(compound) }\OtherTok{\textless{}{-}}\NormalTok{ id}
    \FunctionTok{return}\NormalTok{(compound)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{.meta\_sort\_uniq\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           col,}
\NormalTok{           pattern\_set}
\NormalTok{           )\{}
\NormalTok{    levels }\OtherTok{\textless{}{-}}\NormalTok{ df[[col]] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{.meta\_find\_and\_sort}\NormalTok{(., pattern\_set) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unique}\NormalTok{()}
\NormalTok{    df[[col]] }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(df[[col]], }\AttributeTok{levels =}\NormalTok{ levels)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(df[[col]]), ] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\SpecialCharTok{!}\FunctionTok{duplicated}\NormalTok{(.[[col]]), ]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-output_identification.r}{%
\section{File: output\_identification.R}\label{file-output_identification.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# output compounds identification table }
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases format\_table}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Format table via dplyr::*}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Format the data.frame via: \textbackslash{}code\{dplyr::filter\}, \textbackslash{}code\{dplyr::arrange\},}
\CommentTok{\#\textquotesingle{} \textbackslash{}code\{dplyr::distinct\}, \textbackslash{}code\{dplyr::mutate\}, \textbackslash{}code\{dplyr::select\},}
\CommentTok{\#\textquotesingle{} \textbackslash{}code\{dplyr::rename\}.}
\CommentTok{\#\textquotesingle{} @param data data.frame. From \textbackslash{}code\{features\_annotation(mcn)\}.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name format\_table}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export rename\_table}
\CommentTok{\#\textquotesingle{} @aliases rename\_table}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{rename\_table\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{rename\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{export\_name =}\NormalTok{ .export\_name) \{}
    \FunctionTok{format\_table}\NormalTok{(data, }\ConstantTok{NULL}\NormalTok{, }\ConstantTok{NULL}\NormalTok{, }\ConstantTok{NULL}\NormalTok{, }\ConstantTok{NULL}\NormalTok{, }\ConstantTok{NULL}\NormalTok{, export\_name)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export format\_table}
\CommentTok{\#\textquotesingle{} @aliases format\_table}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{format\_table\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{format\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{filter =}\NormalTok{ .filter\_format, }\AttributeTok{arrange =}\NormalTok{ .arrange\_format,}
    \AttributeTok{distinct =}\NormalTok{ .distinct\_format, }\AttributeTok{mutate =}\NormalTok{ .mutate\_format,}
    \AttributeTok{select =}\NormalTok{ .select\_format, }\AttributeTok{export\_name =}\NormalTok{ .export\_name) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(filter))}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, }\SpecialCharTok{!!!}\NormalTok{filter)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(arrange)) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(data)}\SpecialCharTok{$}\NormalTok{arrange.rank))}
\NormalTok{        data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\AttributeTok{arrange.rank =} \ConstantTok{NA}\NormalTok{)}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(data, }\SpecialCharTok{!!!}\NormalTok{arrange)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(distinct))}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(data, }\SpecialCharTok{!!!}\NormalTok{distinct, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(mutate))}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\SpecialCharTok{!!!}\NormalTok{mutate)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(select)) \{}
\NormalTok{      select }\OtherTok{\textless{}{-}}\NormalTok{ select[select }\SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(data)]}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(select))}
\NormalTok{        data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(data, dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(select))}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(export\_name)) \{}
\NormalTok{      export\_name }\OtherTok{\textless{}{-}}\NormalTok{ export\_name[}\FunctionTok{names}\NormalTok{(export\_name) }\SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(data)]}
\NormalTok{      export\_name }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{turn\_vector}\NormalTok{(export\_name))}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(data, }\SpecialCharTok{!!!}\NormalTok{export\_name)}
\NormalTok{    \}}
\NormalTok{    tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(data)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export .filter\_format}
\CommentTok{\#\textquotesingle{} @aliases .filter\_format}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.filter\_format\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.filter\_format }\OtherTok{\textless{}{-}} 
  \FunctionTok{list}\NormalTok{(}\FunctionTok{quote}\NormalTok{(tani.score }\SpecialCharTok{\textgreater{}=}\NormalTok{ .}\DecValTok{5}\NormalTok{))}

\CommentTok{\#\textquotesingle{} @export .arrange\_format}
\CommentTok{\#\textquotesingle{} @aliases .arrange\_format}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.arrange\_format\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.arrange\_format }\OtherTok{\textless{}{-}} 
  \FunctionTok{list}\NormalTok{(}
    \FunctionTok{quote}\NormalTok{(arrange.rank),}
    \FunctionTok{quote}\NormalTok{(inchikey2d),}
    \FunctionTok{quote}\NormalTok{(}\FunctionTok{desc}\NormalTok{(tani.score))}
\NormalTok{  )}

\CommentTok{\#\textquotesingle{} @export .distinct\_format}
\CommentTok{\#\textquotesingle{} @aliases .distinct\_format}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.distinct\_format\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.distinct\_format }\OtherTok{\textless{}{-}} 
  \FunctionTok{list}\NormalTok{(}\FunctionTok{quote}\NormalTok{(inchikey2d))}

\CommentTok{\#\textquotesingle{} @export .mutate\_format}
\CommentTok{\#\textquotesingle{} @aliases .mutate\_format}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.mutate\_format\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.mutate\_format }\OtherTok{\textless{}{-}} 
  \FunctionTok{list}\NormalTok{(}\AttributeTok{mz =} \FunctionTok{quote}\NormalTok{(}\FunctionTok{round}\NormalTok{(mz, }\DecValTok{4}\NormalTok{)),}
    \AttributeTok{error.mass =} \FunctionTok{quote}\NormalTok{(}\FunctionTok{floor}\NormalTok{(error.mass }\SpecialCharTok{*} \DecValTok{10}\NormalTok{) }\SpecialCharTok{/} \DecValTok{10}\NormalTok{),}
    \AttributeTok{tani.score =} \FunctionTok{quote}\NormalTok{(}\FunctionTok{floor}\NormalTok{(tani.score }\SpecialCharTok{*} \DecValTok{100}\NormalTok{) }\SpecialCharTok{/} \DecValTok{100}\NormalTok{),}
    \AttributeTok{rt.min =} \FunctionTok{quote}\NormalTok{(}\FunctionTok{round}\NormalTok{(rt.secound }\SpecialCharTok{/} \DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\NormalTok{  )}

\CommentTok{\#\textquotesingle{} @export .select\_format}
\CommentTok{\#\textquotesingle{} @aliases .select\_format}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.select\_format\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.select\_format }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"No."}\NormalTok{, }\StringTok{"synonym"}\NormalTok{, }\StringTok{".features\_id"}\NormalTok{, }\StringTok{"mz"}\NormalTok{, }\StringTok{"error.mass"}\NormalTok{,}
  \StringTok{"rt.min"}\NormalTok{, }\StringTok{"mol.formula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{, }\StringTok{"tani.score"}\NormalTok{, }\StringTok{"inchikey2d"}\NormalTok{,}
  \StringTok{"class"}\NormalTok{, }\StringTok{"logFC"}\NormalTok{, }\StringTok{"P.Value"}\NormalTok{, }\StringTok{"adj.P.Val"}
\NormalTok{)}

\CommentTok{\#\textquotesingle{} @export .export\_name}
\CommentTok{\#\textquotesingle{} @aliases .export\_name}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.export\_name\}: ...}
\CommentTok{\#\textquotesingle{} @rdname format\_table}
\NormalTok{.export\_name }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{mz =} \StringTok{"Precursor m/z"}\NormalTok{,}
  \AttributeTok{rt.min =} \StringTok{"RT (min)"}\NormalTok{,}
  \AttributeTok{similarity =} \StringTok{"Spectral similarity"}\NormalTok{,}
  \AttributeTok{tani.score =} \StringTok{"Tanimoto similarity"}\NormalTok{,}
  \AttributeTok{rel.index =} \StringTok{"Relative index"}\NormalTok{,}
  \AttributeTok{rel.int. =} \StringTok{"Relative intensity"}\NormalTok{,}
  \AttributeTok{group =} \StringTok{"Group"}\NormalTok{,}
  \AttributeTok{.features\_id =} \StringTok{"ID"}\NormalTok{,}
  \AttributeTok{mol.formula =} \StringTok{"Formula"}\NormalTok{,}
  \AttributeTok{inchikey2d =} \StringTok{"InChIKey planar"}\NormalTok{,}
  \AttributeTok{error.mass =} \StringTok{"Mass error (ppm)"}\NormalTok{,}
  \AttributeTok{synonym =} \StringTok{"Synonym"}\NormalTok{,}
  \AttributeTok{adduct =} \StringTok{"Adduct"}\NormalTok{,}
  \AttributeTok{class =} \StringTok{"Class"}\NormalTok{,}
  \AttributeTok{logFC =} \StringTok{"log2(FC)"}\NormalTok{,}
  \AttributeTok{P.Value =} \StringTok{"P{-}value"}\NormalTok{,}
  \AttributeTok{adj.P.Val =} \StringTok{"Q{-}value"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pathway_enrichment.r}{%
\section{File: pathway\_enrichment.R}\label{file-pathway_enrichment.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Combining multiple tools for pathway enrichment analysis.}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases pathway\_enrichment}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Perform pathway enrichment via package of \textquotesingle{}FELLA\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Pathway enrichment analysis was performed using KEGG ID}
\CommentTok{\#\textquotesingle{} via package of \textquotesingle{}FELLA\textquotesingle{}.}
\CommentTok{\#\textquotesingle{} (Convert CID to KEGG ID using the \textquotesingle{}MetaboAnalystR\textquotesingle{} package.}
\CommentTok{\#\textquotesingle{} See \textless{}https://github.com/xia{-}lab/MetaboAnalystR\textgreater{} for installation.)}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name pathway\_enrichment}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export init\_fella}
\CommentTok{\#\textquotesingle{} @aliases init\_fella}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{init\_fella\}: ...}
\CommentTok{\#\textquotesingle{} @seealso [FELLA::buildDataFromGraph()], [FELLA::buildGraphFromKEGGREST()]}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{init\_fella }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(dir, }\AttributeTok{org =} \FunctionTok{c}\NormalTok{(}\StringTok{"hsa"}\NormalTok{, }\StringTok{"mmu"}\NormalTok{, }\StringTok{"rno"}\NormalTok{), }\AttributeTok{seed =} \DecValTok{1}\NormalTok{, }\AttributeTok{rebuild =}\NormalTok{ F) \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(dir))}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"file.exists(dir) == F"}\NormalTok{)}
\NormalTok{    dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/fella\_pathway"}\NormalTok{)}
    \FunctionTok{dir.create}\NormalTok{(dir, F)}
\NormalTok{    org }\OtherTok{\textless{}{-}} \FunctionTok{match.arg}\NormalTok{(org)}
\NormalTok{    db.dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, org, }\StringTok{".db.dir"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(db.dir) }\SpecialCharTok{\&} \SpecialCharTok{!}\NormalTok{rebuild) \{}
      \FunctionTok{return}\NormalTok{(db.dir)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      graph.file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, org, }\StringTok{".graph.Rdata"}\NormalTok{)}
      \FunctionTok{unlink}\NormalTok{(db.dir, T)}
      \FunctionTok{set.seed}\NormalTok{(seed)}
\NormalTok{      graph }\OtherTok{\textless{}{-}}\NormalTok{ FELLA}\SpecialCharTok{::}\FunctionTok{buildGraphFromKEGGREST}\NormalTok{(}\AttributeTok{organism =}\NormalTok{ org)}
      \FunctionTok{save}\NormalTok{(graph, }\AttributeTok{file =}\NormalTok{ graph.file)}
\NormalTok{      FELLA}\SpecialCharTok{::}\FunctionTok{buildDataFromGraph}\NormalTok{(}
        \AttributeTok{keggdata.graph =}\NormalTok{ graph,}
        \AttributeTok{databaseDir =}\NormalTok{ db.dir, }\AttributeTok{internalDir =} \ConstantTok{FALSE}\NormalTok{,}
        \AttributeTok{matrices =} \FunctionTok{c}\NormalTok{(}\StringTok{"hypergeom"}\NormalTok{, }\StringTok{"diffusion"}\NormalTok{, }\StringTok{"pagerank"}\NormalTok{),}
        \AttributeTok{normality =} \FunctionTok{c}\NormalTok{(}\StringTok{"diffusion"}\NormalTok{, }\StringTok{"pagerank"}\NormalTok{),}
        \AttributeTok{dampingFactor =} \FloatTok{0.85}\NormalTok{, }\AttributeTok{niter =} \DecValTok{100}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(db.dir)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export load\_fella}
\CommentTok{\#\textquotesingle{} @aliases load\_fella}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{load\_fella\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{load\_fella }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dir) \{}
  \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(dir))\{}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"file.exists(dir) == F"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{  FELLA}\SpecialCharTok{::}\FunctionTok{loadKEGGdata}\NormalTok{(}
    \AttributeTok{databaseDir =}\NormalTok{ dir, }\AttributeTok{internalDir =} \ConstantTok{FALSE}\NormalTok{, }
    \AttributeTok{loadMatrix =} \FunctionTok{c}\NormalTok{(}\StringTok{"hypergeom"}\NormalTok{, }\StringTok{"diffusion"}\NormalTok{, }\StringTok{"pagerank"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export enrich\_fella}
\CommentTok{\#\textquotesingle{} @aliases enrich\_fella}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{enrich\_fella\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{enrich\_fella }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(id.lst, data) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.list}\NormalTok{(id.lst)) \{}
\NormalTok{    id.lst }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(id.lst)}
\NormalTok{  \}}
  \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(id.lst),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \FunctionTok{message}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{========="}\NormalTok{, }\StringTok{"Enrichment:"}\NormalTok{, n, }\StringTok{"========="}\NormalTok{)}
\NormalTok{      id }\OtherTok{\textless{}{-}}\NormalTok{ id.lst[[n]]}
\NormalTok{      res }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}
\NormalTok{        FELLA}\SpecialCharTok{::}\FunctionTok{enrich}\NormalTok{(}
\NormalTok{          id, }\AttributeTok{data =}\NormalTok{ data,}
          \AttributeTok{method =}\NormalTok{ FELLA}\SpecialCharTok{::}\FunctionTok{listMethods}\NormalTok{(),}
          \AttributeTok{approx =} \StringTok{"normality"}
\NormalTok{        )}
\NormalTok{      )}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{inherits}\NormalTok{(res, }\StringTok{"try{-}error"}\NormalTok{))}
        \FunctionTok{return}\NormalTok{(}\ConstantTok{NULL}\NormalTok{)}
      \ControlFlowTok{else}
\NormalTok{        res}
\NormalTok{    \})}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export graph\_fella}
\CommentTok{\#\textquotesingle{} @aliases graph\_fella}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{graph\_fella\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{graph\_fella }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{( obj.lst, data, }\AttributeTok{method =} \FunctionTok{c}\NormalTok{(}\StringTok{"pagerank"}\NormalTok{, }\StringTok{"diffusion"}\NormalTok{, }\StringTok{"hypergeom"}\NormalTok{),}
  \AttributeTok{threshold =}\NormalTok{ .}\DecValTok{1}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  method }\OtherTok{\textless{}{-}} \FunctionTok{match.arg}\NormalTok{(method)}
\NormalTok{  graph.lst }\OtherTok{\textless{}{-}}
    \FunctionTok{lapply}\NormalTok{(obj.lst,}
      \ControlFlowTok{function}\NormalTok{(obj) \{}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(obj))}
          \FunctionTok{return}\NormalTok{()}
\NormalTok{        inmap }\OtherTok{\textless{}{-}}\NormalTok{ FELLA}\SpecialCharTok{::}\FunctionTok{getInput}\NormalTok{(obj)}
\NormalTok{        graph }\OtherTok{\textless{}{-}}\NormalTok{ FELLA}\SpecialCharTok{::}\FunctionTok{generateResultsGraph}\NormalTok{(}
          \AttributeTok{object =}\NormalTok{ obj,}
          \AttributeTok{method =}\NormalTok{ method,}
          \AttributeTok{threshold =}\NormalTok{ threshold,}
          \AttributeTok{data =}\NormalTok{ data}
\NormalTok{        )}
\NormalTok{        graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
\NormalTok{        graph }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(graph, }\SpecialCharTok{{-}}\NormalTok{entrez)}
\NormalTok{        graph }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{          graph, }\AttributeTok{NAME =} \FunctionTok{vapply}\NormalTok{(NAME, }\ControlFlowTok{function}\NormalTok{(c) c[}\DecValTok{1}\NormalTok{], }\StringTok{""}\NormalTok{),}
          \AttributeTok{abbrev.name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_trunc}\NormalTok{(NAME, }\DecValTok{15}\NormalTok{),}
          \AttributeTok{input =} \FunctionTok{ifelse}\NormalTok{(input, }\StringTok{"Input"}\NormalTok{, }\StringTok{"Others"}\NormalTok{),}
          \AttributeTok{type =} \FunctionTok{vapply}\NormalTok{(}
\NormalTok{            name, }\AttributeTok{FUN.VALUE =} \StringTok{""}\NormalTok{, }\AttributeTok{USE.NAMES =}\NormalTok{ F,}
            \ControlFlowTok{function}\NormalTok{(str)\{}
\NormalTok{              str }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(str, }\StringTok{"\^{}[\^{}[0{-}9]]\{1,3\}|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{)}
\NormalTok{              str }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{nchar}\NormalTok{(str) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{, }\StringTok{"pathway"}\NormalTok{, str)}
              \ControlFlowTok{switch}\NormalTok{(}
\NormalTok{                str, }\AttributeTok{pathway =} \StringTok{"Pathway"}\NormalTok{,}
                \AttributeTok{M =} \StringTok{"Module"}\NormalTok{,}
                \StringTok{"."} \OtherTok{=} \StringTok{"Enzyme"}\NormalTok{,}
                \AttributeTok{C =} \StringTok{"Compound"}\NormalTok{,}
                \AttributeTok{R =} \StringTok{"Reaction"}\NormalTok{)}
\NormalTok{            \}))}
\NormalTok{      \})}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @import ggraph}
\CommentTok{\#\textquotesingle{} @export plotGraph\_fella}
\CommentTok{\#\textquotesingle{} @aliases plotGraph\_fella}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{plotGraph\_fella\}: Draw the graph via}
\CommentTok{\#\textquotesingle{} package of \textquotesingle{}ggplot2\textquotesingle{}.}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{plotGraph\_fella }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{  graph, }\AttributeTok{layout =} \StringTok{"graphopt"}\NormalTok{, }\AttributeTok{seed =} \DecValTok{1}\NormalTok{,}
  \AttributeTok{shape =} \FunctionTok{c}\NormalTok{(}\AttributeTok{Input =} \DecValTok{15}\NormalTok{, }\AttributeTok{Others =} \DecValTok{16}\NormalTok{),}
  \AttributeTok{color =} \FunctionTok{c}\NormalTok{(}
    \AttributeTok{Pathway =} \StringTok{"\#E64B35FF"}\NormalTok{,}
    \AttributeTok{Module =} \StringTok{"\#E377C2"}\NormalTok{,}
    \AttributeTok{Enzyme =} \StringTok{"\#EFC000"}\NormalTok{,}
    \AttributeTok{Reaction =} \StringTok{"\#4DBBD5FF"}\NormalTok{,}
    \AttributeTok{Compound =} \StringTok{"\#00A087FF"}\NormalTok{),}
  \AttributeTok{size =} \FunctionTok{c}\NormalTok{(}
    \AttributeTok{Pathway =} \DecValTok{7}\NormalTok{,}
    \AttributeTok{Module =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{Enzyme =} \DecValTok{6}\NormalTok{,}
    \AttributeTok{Reaction =} \DecValTok{5}\NormalTok{,}
    \AttributeTok{Compound =} \DecValTok{10}\NormalTok{))}
\NormalTok{\{}
  \FunctionTok{set.seed}\NormalTok{(seed)}
\NormalTok{  layout }\OtherTok{\textless{}{-}}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{create\_layout}\NormalTok{(graph, }\AttributeTok{layout =}\NormalTok{ layout)}
  \FunctionTok{ggraph}\NormalTok{(layout) }\SpecialCharTok{+} 
    \FunctionTok{geom\_edge\_fan}\NormalTok{(}
      \FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width =}\NormalTok{ weight),}
      \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
      \AttributeTok{show.legend =}\NormalTok{ F,}
      \AttributeTok{end\_cap =}\NormalTok{ ggraph}\SpecialCharTok{::}\FunctionTok{circle}\NormalTok{(}\DecValTok{3}\NormalTok{, }\StringTok{\textquotesingle{}mm\textquotesingle{}}\NormalTok{),}
      \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\DecValTok{2}\NormalTok{, }\StringTok{\textquotesingle{}mm\textquotesingle{}}\NormalTok{))) }\SpecialCharTok{+} 
    \FunctionTok{geom\_node\_point}\NormalTok{(}
      \FunctionTok{aes}\NormalTok{(}\AttributeTok{color =}\NormalTok{ type,}
        \AttributeTok{shape =}\NormalTok{ input,}
        \AttributeTok{size =}\NormalTok{ type),}
      \AttributeTok{stroke =} \FloatTok{0.1}\NormalTok{) }\SpecialCharTok{+} 
\NormalTok{    ggraph}\SpecialCharTok{::}\FunctionTok{geom\_node\_text}\NormalTok{(}
      \FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(}
\NormalTok{          abbrev.name, }\DecValTok{15}\NormalTok{)),}
      \AttributeTok{size =} \DecValTok{3}\NormalTok{,}
      \AttributeTok{family =}\NormalTok{ .font,}
      \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{scale\_shape\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ shape) }\SpecialCharTok{+}
    \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ color) }\SpecialCharTok{+}
    \FunctionTok{scale\_size\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ size) }\SpecialCharTok{+}
    \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.3}\NormalTok{)) }\SpecialCharTok{+} 
    \FunctionTok{guides}\NormalTok{(}
      \AttributeTok{size =} \StringTok{"none"}\NormalTok{,}
      \AttributeTok{shape =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{4}\NormalTok{)),}
      \AttributeTok{color =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{4}\NormalTok{))) }\SpecialCharTok{+}
    \FunctionTok{labs}\NormalTok{(}\AttributeTok{color =} \StringTok{"Category"}\NormalTok{, }\AttributeTok{shape =} \StringTok{"Type"}\NormalTok{) }\SpecialCharTok{+}
    \FunctionTok{theme\_void}\NormalTok{() }\SpecialCharTok{+}
    \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font))}
\NormalTok{\}}

\CommentTok{\#\textquotesingle{} @export cid.to.kegg}
\CommentTok{\#\textquotesingle{} @aliases cid.to.kegg}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{cid.to.kegg\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pathway\_enrichment}
\NormalTok{cid.to.kegg }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(cids)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"MetaboAnalystR"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T)) \{}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"package \textquotesingle{}MetaboAnalystR\textquotesingle{} not available."}\NormalTok{,}
        \StringTok{"See \textless{}https://github.com/xia{-}lab/MetaboAnalystR\textgreater{} for installation."}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    obj }\OtherTok{\textless{}{-}}\NormalTok{ MetaboAnalystR}\SpecialCharTok{::}\FunctionTok{InitDataObjects}\NormalTok{(}\StringTok{"conc"}\NormalTok{, }\StringTok{"msetora"}\NormalTok{, F)}
\NormalTok{    obj }\OtherTok{\textless{}{-}}\NormalTok{ MetaboAnalystR}\SpecialCharTok{::}\FunctionTok{Setup.MapData}\NormalTok{(obj, cids)}
\NormalTok{    obj }\OtherTok{\textless{}{-}}\NormalTok{ MetaboAnalystR}\SpecialCharTok{::}\FunctionTok{CrossReferencing}\NormalTok{(obj, }\StringTok{"pubchem"}\NormalTok{)}
\NormalTok{    obj }\OtherTok{\textless{}{-}}\NormalTok{ MetaboAnalystR}\SpecialCharTok{::}\FunctionTok{CreateMappingResultTable}\NormalTok{(obj)}
\NormalTok{    obj }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(obj}\SpecialCharTok{$}\NormalTok{dataSet}\SpecialCharTok{$}\NormalTok{map.table)}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(obj, KEGG }\SpecialCharTok{!=} \StringTok{"NA"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pick_annotation.r}{%
\section{File: pick\_annotation.R}\label{file-pick_annotation.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Following a preset algorithm to get a unique value from the candidate items.}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases pick\_annotation}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Pick unique annotation for compounds}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Pick unique chemical class or synonyms for \textquotesingle{}features\textquotesingle{}.}
\CommentTok{\#\textquotesingle{} @family queries}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name pick\_annotation}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export pick\_class}
\CommentTok{\#\textquotesingle{} @aliases pick\_class}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{pick\_class\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{pick\_class }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(inchikey2d, class.rdata, }\AttributeTok{filter =}\NormalTok{ .filter\_pick.class, }
    \AttributeTok{fun =}\NormalTok{ PickClass)\{}
\NormalTok{    class }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(class.rdata, inchikey2d)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(filter)) \{}
\NormalTok{      class }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(class, }\AttributeTok{idcol =}\NormalTok{ T))}
\NormalTok{      class }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(class, }\SpecialCharTok{!!!}\NormalTok{filter)}
\NormalTok{      class }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(class, }\SpecialCharTok{\textasciitilde{}}\NormalTok{ .id)}
\NormalTok{    \}}
\NormalTok{    class }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(inchikey2d, }\AttributeTok{simplify =}\NormalTok{ F,}
      \ControlFlowTok{function}\NormalTok{(key2d) \{}
\NormalTok{        class[[ key2d ]]}\SpecialCharTok{$}\NormalTok{Classification}
\NormalTok{      \})}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(fun)) \{}
\NormalTok{      class }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(class, fun)}
\NormalTok{    \}}
    \FunctionTok{unlist}\NormalTok{(class)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export .filter\_pick.class}
\CommentTok{\#\textquotesingle{} @aliases .filter\_pick.class}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.filter\_pick.class\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{.filter\_pick.class }\OtherTok{\textless{}{-}} 
  \FunctionTok{list}\NormalTok{(}\FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\NormalTok{Level }\SpecialCharTok{\%in\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"kingdom"}\NormalTok{, }\StringTok{"level 7"}\NormalTok{, }\StringTok{"level 8"}\NormalTok{, }\StringTok{"level 9"}\NormalTok{))),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"[0{-}9]|Organ"}\NormalTok{, Classification))}
\NormalTok{  )}

\CommentTok{\#\textquotesingle{} @export PickClass}
\CommentTok{\#\textquotesingle{} @aliases PickClass}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{PickClass\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{PickClass }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(class)\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(class)) }\ConstantTok{NA}
    \ControlFlowTok{else} \FunctionTok{tail}\NormalTok{(class, }\AttributeTok{n =} \DecValTok{1}\NormalTok{)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export pick\_synonym}
\CommentTok{\#\textquotesingle{} @aliases pick\_synonym}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{pick\_synonym\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{pick\_synonym }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{inchikey2d =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{inchikey.rdata =} \ConstantTok{NULL}\NormalTok{,}
\NormalTok{    synonym.rdata, }\AttributeTok{iupac.rdata =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{filter =}\NormalTok{ .filter\_pick.general, }\AttributeTok{fun =}\NormalTok{ PickGeneral) \{}
\NormalTok{    syno }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(synonym.rdata)}
\NormalTok{    syno }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(syno))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(filter)) \{}
\NormalTok{      syno }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(syno, }\SpecialCharTok{!!!}\NormalTok{filter)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(inchikey2d)) \{}
\NormalTok{      inchikey }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(inchikey.rdata, inchikey2d)}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(inchikey, }\AttributeTok{simplify =}\NormalTok{ F, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{as.character}\NormalTok{(x}\SpecialCharTok{$}\NormalTok{CID))}
\NormalTok{      syno}\SpecialCharTok{$}\NormalTok{cid }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(syno}\SpecialCharTok{$}\NormalTok{cid)}
\NormalTok{      syno }\OtherTok{\textless{}{-}} \FunctionTok{group\_switch}\NormalTok{(syno, meta, }\AttributeTok{by =} \StringTok{"cid"}\NormalTok{)}
\NormalTok{      syno }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(inchikey2d, }\AttributeTok{simplify =}\NormalTok{ F,}
        \ControlFlowTok{function}\NormalTok{(key2d) \{}
          \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(syno[[ key2d ]]))}
            \FunctionTok{return}\NormalTok{()}
          \ControlFlowTok{else}
\NormalTok{            syno[[ key2d ]]}\SpecialCharTok{$}\NormalTok{syno}
\NormalTok{        \})}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      syno }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(syno, }\SpecialCharTok{\textasciitilde{}}\NormalTok{ cid), }\ControlFlowTok{function}\NormalTok{(set) set}\SpecialCharTok{$}\NormalTok{syno)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(iupac.rdata)) \{}
\NormalTok{      iupac }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(iupac.rdata, inchikey2d)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(inchikey2d)) \{}
\NormalTok{        iupac }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(iupac)}
\NormalTok{        iupac }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{split}\NormalTok{(iupac, }\SpecialCharTok{\textasciitilde{}}\NormalTok{ CID), }\ControlFlowTok{function}\NormalTok{(set) set}\SpecialCharTok{$}\NormalTok{IUPACName)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{        iupac }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(iupac, }\ControlFlowTok{function}\NormalTok{(set) set}\SpecialCharTok{$}\NormalTok{IUPACName)}
\NormalTok{      \}}
\NormalTok{      syno }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(syno), }\AttributeTok{simplify =}\NormalTok{ F,}
        \ControlFlowTok{function}\NormalTok{(name) \{}
          \FunctionTok{c}\NormalTok{(syno[[ name ]], iupac[[ name ]])}
\NormalTok{        \})}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(fun)) \{}
\NormalTok{      syno }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(syno, fun)}
\NormalTok{    \}}
    \FunctionTok{unlist}\NormalTok{(syno)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export .filter\_pick.general}
\CommentTok{\#\textquotesingle{} @aliases .filter\_pick.general}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{.filter\_pick.general\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{.filter\_pick.general }\OtherTok{\textless{}{-}}
  \FunctionTok{list}\NormalTok{(}\FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(syno)),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}[0{-}9]\{3\}\textquotesingle{}}\NormalTok{, syno)),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}\^{}[A{-}Z{-}]\{1,5\}$\textquotesingle{}}\NormalTok{, syno)),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}\^{}[A{-}Z0{-}9]\{1,\}$\textquotesingle{}}\NormalTok{, syno)),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}(?\textless{}={-})[A{-}Z0{-}9]\{5,\}$\textquotesingle{}}\NormalTok{, syno, }\AttributeTok{perl =}\NormalTok{ T)),}
    \FunctionTok{quote}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}\^{}[0{-}9{-}]*$\textquotesingle{}}\NormalTok{, syno))}
\NormalTok{  )}

\CommentTok{\#\textquotesingle{} @export PickGeneral}
\CommentTok{\#\textquotesingle{} @aliases PickGeneral}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{PickGeneral\}: ...}
\CommentTok{\#\textquotesingle{} @rdname pick\_annotation}
\NormalTok{PickGeneral }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(syno,}
  \AttributeTok{ps =} \FunctionTok{c}\NormalTok{(}\StringTok{"\^{}[a{-}zA{-}Z]*$"}\NormalTok{, }\StringTok{"\^{}[a{-}zA{-}Z{-}]*$"}\NormalTok{,}
    \StringTok{"\^{}[a{-}zA{-}Z0{-}9{-}]*$"}\NormalTok{, }\StringTok{"\^{}[\^{}:]*$"}\NormalTok{)}
\NormalTok{  )\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(syno)) }\FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
  \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(ps, }\ControlFlowTok{function}\NormalTok{(p) syno[}\FunctionTok{grepl}\NormalTok{(p, syno)]))[}\DecValTok{1}\NormalTok{]}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-plot_eic_stack.r}{%
\section{File: plot\_EIC\_stack.R}\label{file-plot_eic_stack.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# plot extracted ions chromatograph (EIC) for features using \textasciigrave{}MSnbase\textasciigrave{}}
\CommentTok{\# to extract mass data.}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases plot\_EIC\_stack}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Draw extracted ions chromatography for \textquotesingle{}features\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Use quantification table (with peak start time and end time)}
\CommentTok{\#\textquotesingle{} exported by MCmine to draw EIC plot.}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name plot\_EIC\_stack}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export plot\_EIC\_stack}
\CommentTok{\#\textquotesingle{} @aliases plot\_EIC\_stack}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{plot\_EIC\_stack\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_EIC\_stack}
\NormalTok{plot\_EIC\_stack }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    idset,}
\NormalTok{    metadata,}
\NormalTok{    quant.path,}
\NormalTok{    mzml.path,}
    \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{10}\NormalTok{),}
    \AttributeTok{mz.tol =} \FloatTok{0.01}\NormalTok{,}
    \AttributeTok{rt.tol =} \FloatTok{0.1}\NormalTok{,}
    \AttributeTok{cl =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{data =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(data)) \{}
      \FunctionTok{.suggest\_bio\_package}\NormalTok{(}\StringTok{"MSnbase"}\NormalTok{)}
      \DocumentationTok{\#\# metadata}
      \FunctionTok{.check\_columns}\NormalTok{(metadata, }\FunctionTok{c}\NormalTok{(}\StringTok{"file"}\NormalTok{, }\StringTok{"sample"}\NormalTok{, }\StringTok{"group"}\NormalTok{), }\StringTok{"metadata"}\NormalTok{)}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(metadata, sample)}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(quant.path)}
      \FunctionTok{.check\_columns}\NormalTok{(}
\NormalTok{        feature, }\FunctionTok{c}\NormalTok{(}\StringTok{"row ID"}\NormalTok{,    }\StringTok{"row m/z"}\NormalTok{, }\StringTok{"row retention time"}\NormalTok{),}
        \StringTok{"data.table::fread(quant.path)"}
\NormalTok{      )}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}
\NormalTok{        feature, }\AttributeTok{.features\_id =} \DecValTok{1}\NormalTok{, }\AttributeTok{mz =} \DecValTok{2}\NormalTok{, }\AttributeTok{rt =} \DecValTok{3}\NormalTok{,}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{contains}\NormalTok{(metadata}\SpecialCharTok{$}\NormalTok{sample) }\SpecialCharTok{\&}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{contains}\NormalTok{(}\StringTok{"Peak RT"}\NormalTok{)}
\NormalTok{      )}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{ncol}\NormalTok{(feature) }\SpecialCharTok{==} \DecValTok{3}\NormalTok{) \{}
        \FunctionTok{stop}\NormalTok{(}\StringTok{"\textasciigrave{}feature\textasciigrave{} get by data.table::fread(quant.path) not contains \textquotesingle{}Peak RT\textquotesingle{} information."}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(feature, }\AttributeTok{.features\_id =} \FunctionTok{as.character}\NormalTok{(.features\_id))}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(feature, .features\_id }\SpecialCharTok{\%in\%}\NormalTok{ idset)}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(feature, type, time, }\SpecialCharTok{{-}}\NormalTok{.features\_id, }\SpecialCharTok{{-}}\NormalTok{mz, }\SpecialCharTok{{-}}\NormalTok{rt)}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ feature.rt.during }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{        feature, }\AttributeTok{time =} \FunctionTok{ifelse}\NormalTok{(time }\SpecialCharTok{==} \DecValTok{0}\NormalTok{, }\ConstantTok{NA}\NormalTok{, time),}
        \AttributeTok{sub.type =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(type, }\StringTok{"(?\textless{}=RT ).*?$"}\NormalTok{),}
        \AttributeTok{sample =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.mz.\{{-}\}ML Peak RT.*$"}\NormalTok{, }\StringTok{""}\NormalTok{, type)}
\NormalTok{      )}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(feature, .features\_id, mz, rt, sub.type)}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarize}\NormalTok{(}
\NormalTok{        feature, }\AttributeTok{sub.type.min =} \FunctionTok{min}\NormalTok{(time, }\AttributeTok{na.rm =}\NormalTok{ T),}
        \AttributeTok{sub.type.max =} \FunctionTok{max}\NormalTok{(time, }\AttributeTok{na.rm =}\NormalTok{ T),}
        \AttributeTok{.groups =} \StringTok{"drop\_last"}
\NormalTok{      )}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{        feature, }\AttributeTok{time =} \FunctionTok{ifelse}\NormalTok{(sub.type }\SpecialCharTok{==} \StringTok{"start"}\NormalTok{, sub.type.min, sub.type.max)}
\NormalTok{      )}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(feature, }\SpecialCharTok{{-}}\FunctionTok{contains}\NormalTok{(}\StringTok{"sub.type."}\NormalTok{))}
\NormalTok{      feature }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{spread}\NormalTok{(feature, sub.type, time)}
      \DocumentationTok{\#\# read data}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(cl))}
        \FunctionTok{bioc.par}\NormalTok{(cl)}
\NormalTok{      data }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{readMSData}\NormalTok{(}
        \FunctionTok{paste0}\NormalTok{(mzml.path, }\StringTok{"/"}\NormalTok{, metadata}\SpecialCharTok{$}\NormalTok{file),}
        \AttributeTok{pdata =} \FunctionTok{new}\NormalTok{(}\StringTok{"NAnnotatedDataFrame"}\NormalTok{, metadata),}
        \AttributeTok{mode =} \StringTok{"onDisk"}
\NormalTok{      )}
      \DocumentationTok{\#\# extract EIC}
\NormalTok{      rt.tol.sec }\OtherTok{\textless{}{-}}\NormalTok{ rt.tol }\SpecialCharTok{*} \DecValTok{60}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(cl))}
        \FunctionTok{bioc.par}\NormalTok{(cl)}
\NormalTok{      eic.list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(}
\NormalTok{        feature, }\DecValTok{1}\NormalTok{,}
        \ControlFlowTok{function}\NormalTok{(vec)\{}
          \DocumentationTok{\#\# mz range for EIC}
\NormalTok{          mz }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(vec[[}\StringTok{"mz"}\NormalTok{]])}
\NormalTok{          mz.range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(mz }\SpecialCharTok{{-}}\NormalTok{ mz.tol, mz }\SpecialCharTok{+}\NormalTok{ mz.tol)}
          \DocumentationTok{\#\# rt range for EIC}
\NormalTok{          rt.range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(vec[[}\StringTok{"start"}\NormalTok{]], vec[[}\StringTok{"end"}\NormalTok{]])}
\NormalTok{          rt.range }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(rt.range) }\SpecialCharTok{*} \DecValTok{60}
\NormalTok{          rt.range }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(rt.range[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{{-}}\NormalTok{ rt.tol.sec, rt.range[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{+}\NormalTok{ rt.tol.sec)}
\NormalTok{          ms1.vec }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{chromatogram}\NormalTok{(data, }\AttributeTok{msLevel =}\NormalTok{ 1L, }\AttributeTok{mz =}\NormalTok{ mz.range,}
            \AttributeTok{rt =}\NormalTok{ rt.range, }\AttributeTok{aggregationFun =} \StringTok{"max"}\NormalTok{)}
\NormalTok{          data.list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(ms1.vec),}
            \ControlFlowTok{function}\NormalTok{(chr)\{}
\NormalTok{              int }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{intensity}\NormalTok{(chr)}
\NormalTok{              rt }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{rtime}\NormalTok{(chr)}
              \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{real.time =}\NormalTok{ rt, }\AttributeTok{int =}\NormalTok{ int)}
\NormalTok{            \})}
          \FunctionTok{names}\NormalTok{(data.list) }\OtherTok{\textless{}{-}}\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{sample}
\NormalTok{          df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(data.list, }\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{          df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(df, }\AttributeTok{sample =}\NormalTok{ .id)}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{.features\_id =}\NormalTok{ vec[[}\StringTok{".features\_id"}\NormalTok{]])}
\NormalTok{        \})}
      \DocumentationTok{\#\# define whether the peak belong to the feature}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(eic.list)}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(}
\NormalTok{        eic.df, feature.rt.during, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{".features\_id"}\NormalTok{, }\StringTok{"sample"}\NormalTok{), }\AttributeTok{allow.cartesian =}\NormalTok{ T}
\NormalTok{      )}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(eic.df, }\SpecialCharTok{{-}}\NormalTok{type)}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{spread}\NormalTok{(eic.df, }\AttributeTok{key =}\NormalTok{ sub.type, }\AttributeTok{value =}\NormalTok{ time)}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(eic.df, metadata, }\AttributeTok{by =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{      eic.df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{        eic.df, }\AttributeTok{real.time.min =}\NormalTok{ real.time }\SpecialCharTok{/} \DecValTok{60}\NormalTok{,}
        \AttributeTok{feature =} \FunctionTok{ifelse}\NormalTok{(real.time.min }\SpecialCharTok{\textgreater{}=}\NormalTok{ start }\SpecialCharTok{\&}\NormalTok{ real.time.min }\SpecialCharTok{\textless{}=}\NormalTok{ end,}
\NormalTok{          sample, }\StringTok{"Non feature"}\NormalTok{),}
        \AttributeTok{fill =} \FunctionTok{ifelse}\NormalTok{(feature }\SpecialCharTok{==} \StringTok{"Non feature"}\NormalTok{, feature, group),}
        \AttributeTok{mz =} \FunctionTok{round}\NormalTok{(mz, }\DecValTok{4}\NormalTok{),}
        \AttributeTok{anno.mz =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Precursor m/z:}\SpecialCharTok{\textbackslash{}n}\StringTok{  "}\NormalTok{, mz }\SpecialCharTok{{-}}\NormalTok{ mz.tol, }\StringTok{"\textasciitilde{}"}\NormalTok{, mz }\SpecialCharTok{+}\NormalTok{ mz.tol),}
        \AttributeTok{anno.rt =} \FunctionTok{paste}\NormalTok{(}\StringTok{"RT (min):"}\NormalTok{, }\FunctionTok{round}\NormalTok{(rt, }\DecValTok{1}\NormalTok{)),}
        \AttributeTok{anno =} \FunctionTok{paste0}\NormalTok{(anno.mz, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, anno.rt)}
\NormalTok{      )}
      \DocumentationTok{\#\# annotation (mz and rt)}
\NormalTok{      anno }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(eic.df, .features\_id, int, real.time.min, }\FunctionTok{contains}\NormalTok{(}\StringTok{"anno"}\NormalTok{))}
\NormalTok{      anno }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(anno, .features\_id)}
\NormalTok{      anno }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarize}\NormalTok{(}
\NormalTok{        anno, }\AttributeTok{anno.x =} \FunctionTok{min}\NormalTok{(real.time.min, }\AttributeTok{na.rm =}\NormalTok{ T),}
        \AttributeTok{anno.y =} \FunctionTok{max}\NormalTok{(int, }\AttributeTok{na.rm =}\NormalTok{ T) }\SpecialCharTok{*} \DecValTok{3} \SpecialCharTok{/} \DecValTok{4}\NormalTok{,}
        \AttributeTok{anno =} \FunctionTok{unique}\NormalTok{(anno)}
\NormalTok{      )}
\NormalTok{      data }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{eic.df =}\NormalTok{ eic.df, }\AttributeTok{anno =}\NormalTok{ anno)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{any}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette) }\SpecialCharTok{==} \StringTok{"Non feature"}\NormalTok{)) \{}
\NormalTok{      palette[[ }\StringTok{"Non feature"}\NormalTok{ ]] }\OtherTok{\textless{}{-}} \StringTok{"grey95"}
\NormalTok{    \}}
\NormalTok{    data}\SpecialCharTok{$}\NormalTok{p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data[[ }\StringTok{"eic.df"}\NormalTok{ ]]) }\SpecialCharTok{+}
      \FunctionTok{geom\_line}\NormalTok{(}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ real.time.min,}
          \AttributeTok{y =}\NormalTok{ int,}
          \AttributeTok{group =}\NormalTok{ sample,}
          \AttributeTok{color =}\NormalTok{ fill),}
        \AttributeTok{lineend =} \StringTok{"round"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{color =} \StringTok{"Peak attribution"}\NormalTok{, }\AttributeTok{x =} \StringTok{"RT (min)"}\NormalTok{, }\AttributeTok{y =} \StringTok{"Intensity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ data[[ }\StringTok{"anno"}\NormalTok{ ]],}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ anno.x, }\AttributeTok{y =}\NormalTok{ anno.y, }\AttributeTok{label =}\NormalTok{ anno),}
        \AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{labels =}\NormalTok{ scales}\SpecialCharTok{::}\NormalTok{scientific) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{( }\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, .features\_id), }\AttributeTok{scales =} \StringTok{"free"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font),}
        \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{0}\NormalTok{, }\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
        \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{12}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{geom\_blank}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(data)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export bioc.par}
\CommentTok{\#\textquotesingle{} @aliases bioc.par}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{bioc.par\}: ...}
\CommentTok{\#\textquotesingle{} @rdname plot\_EIC\_stack}
\NormalTok{bioc.par }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{cl =} \DecValTok{4}\NormalTok{)\{}
\NormalTok{    BiocParallel}\SpecialCharTok{::}\FunctionTok{register}\NormalTok{(}
\NormalTok{      BiocParallel}\SpecialCharTok{::}\FunctionTok{bpstart}\NormalTok{(}
\NormalTok{        BiocParallel}\SpecialCharTok{::}\FunctionTok{MulticoreParam}\NormalTok{(cl)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-png_add_margin.r}{%
\section{File: png\_add\_margin.R}\label{file-png_add_margin.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{png\_gather\_two }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           png\_file1,}
           \AttributeTok{png\_file2 =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{5000}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{3500}\NormalTok{,}
           \AttributeTok{internal =} \FloatTok{0.06}
\NormalTok{           )\{}
    \DocumentationTok{\#\# read png1}
\NormalTok{    png1 }\OtherTok{\textless{}{-}}\NormalTok{ png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(png\_file1)}
\NormalTok{    ratio}\FloatTok{.1} \OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png1) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(png1)}
    \DocumentationTok{\#\# read png2}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(png\_file2))\{}
\NormalTok{      png2 }\OtherTok{\textless{}{-}}\NormalTok{ png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(png\_file2)}
\NormalTok{      ratio}\FloatTok{.2} \OtherTok{\textless{}{-}} \FunctionTok{ncol}\NormalTok{(png2) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(png2)}
      \DocumentationTok{\#\# filename fix}
\NormalTok{      fix }\OtherTok{\textless{}{-}} \StringTok{"gather\_"}
      \DocumentationTok{\#\# png postion shift}
\NormalTok{      position\_shift }\OtherTok{\textless{}{-}} \StringTok{"0"}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ratio}\FloatTok{.2} \OtherTok{\textless{}{-}} \ConstantTok{NULL}
      \DocumentationTok{\#\# filename fix}
\NormalTok{      fix }\OtherTok{\textless{}{-}} \StringTok{"ps\_"}
      \DocumentationTok{\#\# png postion shift}
\NormalTok{      position\_shift }\OtherTok{\textless{}{-}} \StringTok{"(unit.width / 2 + internal / 2) / width.adjust"}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    max }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(}\FunctionTok{c}\NormalTok{(ratio}\FloatTok{.1}\NormalTok{, ratio}\FloatTok{.2}\NormalTok{))}
    \DocumentationTok{\#\# according to height, calculate needed width}
\NormalTok{    expect.width }\OtherTok{\textless{}{-}}\NormalTok{ height }\SpecialCharTok{*}\NormalTok{ max }\SpecialCharTok{/}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ internal) }\SpecialCharTok{*} \DecValTok{2}
    \DocumentationTok{\#\# if width not enough}
    \ControlFlowTok{if}\NormalTok{(width }\SpecialCharTok{\textless{}}\NormalTok{ expect.width)\{}
\NormalTok{      width }\OtherTok{\textless{}{-}}\NormalTok{ expect.width}
\NormalTok{      width.adjust }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      width.adjust }\OtherTok{\textless{}{-}}\NormalTok{ expect.width }\SpecialCharTok{/}\NormalTok{ width}
\NormalTok{    \}}
    \DocumentationTok{\#\# save path and savename}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(png\_file1)}
\NormalTok{    name }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(png\_file1)}
    \FunctionTok{png}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, fix, name), }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{plot.new}\NormalTok{()}
    \DocumentationTok{\#\# x, y, xend, yend}
\NormalTok{    unit.width }\OtherTok{\textless{}{-}}\NormalTok{ (}\FloatTok{0.5} \SpecialCharTok{{-}}\NormalTok{ internal }\SpecialCharTok{/} \DecValTok{2}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ width.adjust}
    \FunctionTok{rasterImage}\NormalTok{(png1,}
                \AttributeTok{xleft =}\NormalTok{ unit.width }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ ratio}\FloatTok{.1} \SpecialCharTok{/}\NormalTok{ max) }\SpecialCharTok{+}
                  \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ position\_shift)),}
                \AttributeTok{ybottom =} \DecValTok{0}\NormalTok{,}
                \AttributeTok{xright =}\NormalTok{ unit.width }\SpecialCharTok{+} 
                  \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ position\_shift)),}
                \AttributeTok{ytop =} \DecValTok{1}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(png\_file2))\{}
      \DocumentationTok{\#\# x, y, xend, yend}
      \FunctionTok{rasterImage}\NormalTok{(png2,}
                  \AttributeTok{xleft =}\NormalTok{ unit.width }\SpecialCharTok{+}\NormalTok{ internal,}
                  \AttributeTok{ybottom =} \DecValTok{0}\NormalTok{,}
                  \AttributeTok{xright =}\NormalTok{ unit.width }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{+}\NormalTok{ ratio}\FloatTok{.2} \SpecialCharTok{/}\NormalTok{ max) }\SpecialCharTok{+}\NormalTok{ internal, }
                  \AttributeTok{ytop =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}

\NormalTok{png\_to\_pdf }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file}
\NormalTok{           )\{}
\NormalTok{    file.pdf }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.png"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf"}\NormalTok{, file)}
    \FunctionTok{pdf}\NormalTok{(}\AttributeTok{file =}\NormalTok{ file.pdf)}
\NormalTok{    png }\OtherTok{\textless{}{-}}\NormalTok{ EBImage}\SpecialCharTok{::}\FunctionTok{readImage}\NormalTok{(file)}
\NormalTok{    EBImage}\SpecialCharTok{::}\FunctionTok{display}\NormalTok{(png, }\AttributeTok{method =} \StringTok{"raster"}\NormalTok{, }\AttributeTok{all =}\NormalTok{ T)}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-pretty_table.r}{%
\section{File: pretty\_table.R}\label{file-pretty_table.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# format table as .tex .html ...}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}
\CommentTok{\#\textquotesingle{} @import gt}
\NormalTok{pretty\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    df, }\AttributeTok{title =} \StringTok{"compounds summary"}\NormalTok{, }\AttributeTok{subtitle =} \StringTok{"LC{-}MS"}\NormalTok{,}
    \AttributeTok{footnote =} \StringTok{"..."}\NormalTok{, }\AttributeTok{spanner =}\NormalTok{ F, }\AttributeTok{default =}\NormalTok{ F,}
    \AttributeTok{filename =} \StringTok{"tmp.html"}\NormalTok{, }\AttributeTok{path =} \FunctionTok{tempdir}\NormalTok{(),}
    \AttributeTok{font =} \StringTok{"Times New Roman"}\NormalTok{, }\AttributeTok{widths =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{caption =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(title)) \{}
\NormalTok{      title }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(title), }\StringTok{"**"}\NormalTok{)}
\NormalTok{      subtitle }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(subtitle), }\StringTok{"**"}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df))}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{default)\{}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{gt\_solid\_line}\NormalTok{(df, }\AttributeTok{title =}\NormalTok{ title, }\AttributeTok{subtitle =}\NormalTok{ subtitle,}
        \AttributeTok{footnote =}\NormalTok{ footnote, }\AttributeTok{font =}\NormalTok{ font, }\AttributeTok{widths =}\NormalTok{ widths, }\AttributeTok{caption =}\NormalTok{ caption)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(default)\{}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{opt\_table\_font}\NormalTok{(}\FunctionTok{gt}\NormalTok{(df), }\AttributeTok{font=}\FunctionTok{list}\NormalTok{(font))}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_header}\NormalTok{(t, }\AttributeTok{title =} \FunctionTok{md}\NormalTok{(title), }\AttributeTok{subtitle =} \FunctionTok{md}\NormalTok{(subtitle))}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{opt\_align\_table\_header}\NormalTok{(t, }\AttributeTok{align =} \StringTok{"left"}\NormalTok{)}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_footnote}\NormalTok{(t, }\AttributeTok{footnote =}\NormalTok{ footnote,}
        \AttributeTok{locations =} \FunctionTok{cells\_title}\NormalTok{(}\AttributeTok{groups =} \FunctionTok{c}\NormalTok{(}\StringTok{"title"}\NormalTok{)))}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(spanner)\{}
\NormalTok{      columns }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        .[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\#"}\NormalTok{, .)]}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_spanner\_delim}\NormalTok{(t, }\AttributeTok{columns =}\NormalTok{ columns,}
        \AttributeTok{delim =} \StringTok{"\#"}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(filename)) \{}
      \FunctionTok{gtsave}\NormalTok{(t, filename, path)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(t)}
\NormalTok{  \}}

\NormalTok{footnote }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(gt, text, columns)\{}
  \FunctionTok{tab\_footnote}\NormalTok{(gt, }\AttributeTok{footnote =}\NormalTok{ text,}
    \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}\AttributeTok{columns =} \SpecialCharTok{!!}\NormalTok{columns))}
\NormalTok{\}}

\NormalTok{gt\_solid\_line }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{title =} \StringTok{"Table"}\NormalTok{, }\AttributeTok{subtitle =} \StringTok{"Table"}\NormalTok{, }\AttributeTok{footnote =} \StringTok{"..."}\NormalTok{,}
    \AttributeTok{font =} \StringTok{"Times New Roman"}\NormalTok{, }\AttributeTok{widths =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{caption =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \{}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{opt\_table\_font}\NormalTok{(}\FunctionTok{gt}\NormalTok{(df, }\AttributeTok{caption =}\NormalTok{ caption), }\AttributeTok{font =} \FunctionTok{list}\NormalTok{(font))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(title)) \{}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_header}\NormalTok{(t, }\AttributeTok{title =} \FunctionTok{md}\NormalTok{(title),}
        \AttributeTok{subtitle =} \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(subtitle)) }\FunctionTok{md}\NormalTok{(subtitle) }\ControlFlowTok{else} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(footnote)) \{}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_footnote}\NormalTok{(t, }\AttributeTok{footnote =}\NormalTok{ footnote,}
        \AttributeTok{locations =} \FunctionTok{cells\_title}\NormalTok{(}\AttributeTok{groups =} \FunctionTok{c}\NormalTok{(}\StringTok{"title"}\NormalTok{)))}
\NormalTok{    \}}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{opt\_align\_table\_header}\NormalTok{(t, }\AttributeTok{align =} \StringTok{"left"}\NormalTok{)}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{cols\_align}\NormalTok{(t, }\AttributeTok{align =} \StringTok{"left"}\NormalTok{,}
      \AttributeTok{columns =} \FunctionTok{everything}\NormalTok{()) }
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_style}\NormalTok{(t, }\AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{v\_align =} \StringTok{"top"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{everything}\NormalTok{())) }
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{opt\_table\_lines}\NormalTok{(t, }\AttributeTok{extent =} \FunctionTok{c}\NormalTok{(}\StringTok{"none"}\NormalTok{))}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_style}\NormalTok{(t, }\AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}\AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"top"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{()) }
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_style}\NormalTok{(t, }\AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}\AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\FloatTok{1.5}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_body}\NormalTok{(}\AttributeTok{columns =} \FunctionTok{everything}\NormalTok{(),}
        \AttributeTok{rows =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{nrow}\NormalTok{(df)))))}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_style}\NormalTok{(t, }\AttributeTok{style =} \FunctionTok{cell\_text}\NormalTok{(}\AttributeTok{align =} \StringTok{"center"}\NormalTok{,}
        \AttributeTok{weight =} \StringTok{"bold"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_row\_groups}\NormalTok{(}\AttributeTok{groups =} \FunctionTok{everything}\NormalTok{()))}
\NormalTok{    t }\OtherTok{\textless{}{-}} \FunctionTok{tab\_style}\NormalTok{(t, }\AttributeTok{style =} \FunctionTok{cell\_borders}\NormalTok{(}\AttributeTok{sides =} \FunctionTok{c}\NormalTok{(}\StringTok{"top"}\NormalTok{, }\StringTok{"bottom"}\NormalTok{),}
        \AttributeTok{color =} \StringTok{"grey"}\NormalTok{,}
        \AttributeTok{weight =} \FunctionTok{px}\NormalTok{(}\DecValTok{1}\NormalTok{),}
        \AttributeTok{style =} \StringTok{"solid"}\NormalTok{),}
      \AttributeTok{locations =} \FunctionTok{cells\_row\_groups}\NormalTok{(}\AttributeTok{groups =} \FunctionTok{everything}\NormalTok{()))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(widths)) \{}
\NormalTok{      t }\OtherTok{\textless{}{-}} \FunctionTok{cols\_width}\NormalTok{(t, }\AttributeTok{.list =}\NormalTok{ widths)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(t)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# for kable usage}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{kroup\_row }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data, }\AttributeTok{group =} \StringTok{"Group"}\NormalTok{, }\AttributeTok{order =} \FunctionTok{unique}\NormalTok{(data[[ group ]]))}
\NormalTok{\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(data), data[[ group ]])}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst,}
    \ControlFlowTok{function}\NormalTok{(data) \{}
\NormalTok{      data[[ group ]] }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(data[[ group ]][}\DecValTok{1}\NormalTok{], }\FunctionTok{rep}\NormalTok{(}\StringTok{""}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(data) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}
\NormalTok{      data}
\NormalTok{    \})}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(order, }\ControlFlowTok{function}\NormalTok{(name) lst[[ name ]])}
\NormalTok{  tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-qi_get_format.r}{%
\section{File: qi\_get\_format.R}\label{file-qi_get_format.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{qi\_get\_format }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{metadata =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(file) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta.ori }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(df, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}
    \DocumentationTok{\#\# group}
\NormalTok{    meta.group }\OtherTok{\textless{}{-}}\NormalTok{ meta.ori[}\DecValTok{2}\NormalTok{, ] }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\FunctionTok{which}\NormalTok{(. }\SpecialCharTok{!=} \StringTok{""}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      .[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(.) }\SpecialCharTok{/} \DecValTok{2} \SpecialCharTok{+} \DecValTok{1}\NormalTok{)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{group =}\NormalTok{ ., }\AttributeTok{col =} \FunctionTok{names}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# from col to col\_end is the sample of group}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{col\_end =} \FunctionTok{c}\NormalTok{(col[}\DecValTok{2}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(col)], }\ConstantTok{NA}\NormalTok{),}
                    \AttributeTok{col =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(col, }\StringTok{"[0{-}9]\{1,\}"}\NormalTok{),}
                    \AttributeTok{col\_end =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(col\_end, }\StringTok{"[0{-}9]\{1,\}"}\NormalTok{),}
                    \AttributeTok{col =} \FunctionTok{as.numeric}\NormalTok{(col),}
                    \AttributeTok{col\_end =} \FunctionTok{as.numeric}\NormalTok{(col\_end) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(.) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(metadata)\{}
\NormalTok{      meta.sample }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(from, to)\{}
\NormalTok{                              name }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(meta.ori[}\DecValTok{3}\NormalTok{, ], }\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{                              data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{sample =}\NormalTok{ name[from}\SpecialCharTok{:}\NormalTok{to])}
\NormalTok{                    \}, meta.group}\SpecialCharTok{$}\NormalTok{col, meta.group}\SpecialCharTok{$}\NormalTok{col\_end,}
                    \AttributeTok{SIMPLIFY =}\NormalTok{ F)}
      \FunctionTok{names}\NormalTok{(meta.sample) }\OtherTok{\textless{}{-}}\NormalTok{ meta.group}\SpecialCharTok{$}\NormalTok{group}
\NormalTok{      meta.sample }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(meta.sample, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{group =}\NormalTok{ .id)}
      \FunctionTok{return}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(meta.sample))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{fread}\NormalTok{(file, }\AttributeTok{skip =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}Compound$|m/z|Retention time"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(.)),}
\NormalTok{                    meta.group}\SpecialCharTok{$}\NormalTok{col[}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\NormalTok{meta.group}\SpecialCharTok{$}\NormalTok{col\_end[}\FunctionTok{nrow}\NormalTok{(meta.group)])}
    \FunctionTok{return}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df))}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{qi\_as\_metabo\_inte.table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           metadata,}
\NormalTok{           select}
\NormalTok{           )\{}
\NormalTok{    select.sam }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(metadata, group }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(select))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    anno }\OtherTok{\textless{}{-}}\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{group}
    \FunctionTok{names}\NormalTok{(anno) }\OtherTok{\textless{}{-}}\NormalTok{ metadata}\SpecialCharTok{$}\NormalTok{sample}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    mz\_rt }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, }\DecValTok{2}\SpecialCharTok{:}\DecValTok{3}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{mz =} \DecValTok{1}\NormalTok{, }\AttributeTok{rt =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{Sample =} \FunctionTok{paste0}\NormalTok{(mz, }\StringTok{"\_\_"}\NormalTok{, rt)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(Sample)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    df.data }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\DecValTok{4}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(df)] }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_all}\NormalTok{(as.character)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# bind id}
\NormalTok{    qi\_format.id }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{Sample =} \StringTok{"Lable"}\NormalTok{), mz\_rt)}
    \DocumentationTok{\#\# bind data}
\NormalTok{    qi\_format.df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(anno, df.data) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(.)[}\FunctionTok{colnames}\NormalTok{(.) }\SpecialCharTok{\%in\%}\NormalTok{ select.sam}\SpecialCharTok{$}\NormalTok{sample])}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    qi\_format }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_cols}\NormalTok{(qi\_format.id, qi\_format.df)}
    \FunctionTok{return}\NormalTok{(qi\_format)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-query_classification.r}{%
\section{File: query\_classification.R}\label{file-query_classification.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# query classification for compounds using classyfire API}
\CommentTok{\# run after query\_inchikey}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases query\_classification}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Query classification of compounds via packgage of \textquotesingle{}classifyerR\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description The used function is:}
\CommentTok{\#\textquotesingle{} \textbackslash{}code\{classyfireR::get\_classification(inchikey)\}}
\CommentTok{\#\textquotesingle{} @family queries}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name query\_classification}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export query\_classification}
\CommentTok{\#\textquotesingle{} @aliases query\_classification}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{query\_classification\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_classification}
\NormalTok{query\_classification }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    inchikey2d,}
\NormalTok{    dir,}
    \AttributeTok{inchikey.rdata =} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/inchikey.rdata"}\NormalTok{),}
    \AttributeTok{rdata.name =} \StringTok{"classification.rdata"}\NormalTok{,}
    \AttributeTok{classyfire\_cl =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name)}
\NormalTok{    classes }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(classes))}
\NormalTok{      inchikey2d }\OtherTok{\textless{}{-}}\NormalTok{ inchikey2d[}\SpecialCharTok{!}\NormalTok{inchikey2d }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(classes)]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(inchikey2d) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{    inchikey\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(inchikey.rdata, inchikey2d)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(inchikey\_set))}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"is.null(inchikey\_set) == T. File \textasciigrave{}inchikey.rdata\textasciigrave{} may not exists."}\NormalTok{)}
\NormalTok{    sets }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(inchikey\_set, }\ControlFlowTok{function}\NormalTok{(df)\{}
      \ControlFlowTok{if}\NormalTok{(}\StringTok{"InChIKey"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(df))}
        \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \})}
\NormalTok{    sets }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(sets)}
\NormalTok{    sets }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(sets, }\AttributeTok{inchikey2d =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(InChIKey, }\StringTok{"\^{}[A{-}Z]\{1,\}"}\NormalTok{))}
\NormalTok{    l }\OtherTok{\textless{}{-}} \FunctionTok{classyfire\_get\_classification}\NormalTok{(sets, dir, }\AttributeTok{classyfire\_cl =}\NormalTok{ classyfire\_cl, ...)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.logical}\NormalTok{(l))}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
    \ControlFlowTok{if}\NormalTok{ (gather\_as\_rdata) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# gather data}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z]\{14\}$"}\NormalTok{,}
        \AttributeTok{rdata =}\NormalTok{ rdata.name, }\AttributeTok{extra =}\NormalTok{ classes)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export classyfire\_get\_classification}
\CommentTok{\#\textquotesingle{} @aliases classyfire\_get\_classification}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{classyfire\_get\_classification\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_classification}
\NormalTok{classyfire\_get\_classification }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    sets,}
\NormalTok{    dir,}
    \AttributeTok{classyfire\_cl =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{log\_file =} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/classyfire.log"}\NormalTok{),}
\NormalTok{    ...}
\NormalTok{    )\{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{file.exists}\NormalTok{(log\_file))\{}
\NormalTok{      log\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(log\_file)}
\NormalTok{      sets }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(sets, }\SpecialCharTok{!}\NormalTok{InChIKey }\SpecialCharTok{\%in\%}\NormalTok{ log\_df}\SpecialCharTok{$}\NormalTok{log)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(sets) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
        \FunctionTok{return}\NormalTok{(F)}
\NormalTok{    \}}
\NormalTok{    sets }\OtherTok{\textless{}{-}} \FunctionTok{split}\NormalTok{(}\FunctionTok{data.frame}\NormalTok{(sets), }\SpecialCharTok{\textasciitilde{}}\NormalTok{ inchikey2d)}
\NormalTok{    log }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(sets), }\AttributeTok{cl =}\NormalTok{ classyfire\_cl,}
      \ControlFlowTok{function}\NormalTok{(inchikey2d) \{}
\NormalTok{        set }\OtherTok{\textless{}{-}}\NormalTok{ sets[[ inchikey2d ]]}
        \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(set[[}\StringTok{"InChIKey"}\NormalTok{]], .get\_classification,}
            \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, inchikey2d)),}
          \AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{      \})}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(log, }\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{log =}\NormalTok{ log)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{exists}\NormalTok{(}\StringTok{"log\_df"}\NormalTok{))}
\NormalTok{      log }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(log\_df, log)}
    \FunctionTok{write\_tsv}\NormalTok{(log, }\AttributeTok{file =}\NormalTok{ log\_file)}
\NormalTok{  \}}

\NormalTok{.get\_classification }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(inchikey, file)\{}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(file))\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{get\_classification}\NormalTok{(inchikey)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(ch))\{}
      \FunctionTok{return}\NormalTok{(inchikey)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{classification}\NormalTok{(ch)}
      \FunctionTok{write\_tsv}\NormalTok{(ch, file)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-query_inchikey.r}{%
\section{File: query\_inchikey.R}\label{file-query_inchikey.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# query inchikey for compounds using pubchem API}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases query\_inchikey}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Query InChIkey of compounds via \textquotesingle{}InChIkey 2D\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description }
\CommentTok{\#\textquotesingle{} The API:}
\CommentTok{\#\textquotesingle{} url\_start = paste0("https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/", type, "/")}
\CommentTok{\#\textquotesingle{} url\_end = paste0("/property/", paste(get, collapse = ","), "/CSV")}
\CommentTok{\#\textquotesingle{} url = paste0(url\_start, "/", inchikey2d, "/", url\_end)}
\CommentTok{\#\textquotesingle{} }
\CommentTok{\#\textquotesingle{} @family queries}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name query\_inchikey}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export query\_inchikey}
\CommentTok{\#\textquotesingle{} @aliases query\_inchikey}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{query\_inchikey\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_inchikey}
\NormalTok{query\_inchikey }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           dir,}
           \AttributeTok{rdata.name =} \StringTok{"inchikey.rdata"}\NormalTok{,}
           \AttributeTok{curl\_cl =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name)}
\NormalTok{    inchikey\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(inchikey\_set))}
\NormalTok{      inchikey2d }\OtherTok{\textless{}{-}}\NormalTok{ inchikey2d[}\SpecialCharTok{!}\NormalTok{inchikey2d }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(inchikey\_set)]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(inchikey2d) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(inchikey2d, pubchem\_get\_inchikey,}
                      \AttributeTok{dir =}\NormalTok{ dir, }\AttributeTok{cl =}\NormalTok{ curl\_cl, ...)}
    \ControlFlowTok{if}\NormalTok{ (gather\_as\_rdata) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# gather data}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z]\{14\}$"}\NormalTok{,}
                            \AttributeTok{rdata =}\NormalTok{ rdata.name, }\AttributeTok{extra =}\NormalTok{ inchikey\_set)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export pubchem\_get\_inchikey}
\CommentTok{\#\textquotesingle{} @aliases pubchem\_get\_inchikey}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{pubchem\_get\_inchikey\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_inchikey}
\NormalTok{pubchem\_get\_inchikey }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           dir,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, inchikey2d)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(file))\{}
\NormalTok{      csv }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(file)}
      \ControlFlowTok{if}\NormalTok{(}\StringTok{"CID"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(csv))}
        \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    url\_start }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/"}\NormalTok{, type, }\StringTok{"/"}\NormalTok{)}
\NormalTok{    url\_end }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/property/"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(get, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"/CSV"}\NormalTok{)}
\NormalTok{    url }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(url\_start, }\StringTok{"/"}\NormalTok{, inchikey2d, }\StringTok{"/"}\NormalTok{, url\_end)}
\NormalTok{    check }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(check }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{|} \FunctionTok{inherits}\NormalTok{(check, }\StringTok{"try{-}error"}\NormalTok{))\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(csv }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url), }\AttributeTok{silent =}\NormalTok{ T)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status: 404"}\NormalTok{, csv))\{}
      \FunctionTok{write\_tsv}\NormalTok{(csv, }\AttributeTok{file =}\NormalTok{ file)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status:    503"}\NormalTok{, csv))\{}
\NormalTok{      csv }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url)}
\NormalTok{    \}}
\NormalTok{    csv }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{text =}\NormalTok{ csv)}
    \FunctionTok{write\_tsv}\NormalTok{(csv, }\AttributeTok{file =}\NormalTok{ file)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-query_others.r}{%
\section{File: query\_others.R}\label{file-query_others.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# query other property for compounds using pubchem API}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases query\_iupac}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Query IUPAC name of compounds via \textquotesingle{}InChIkey 2D\textquotesingle{}}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Similar to [query\_inchikey()], but get \textquotesingle{}IUPACName\textquotesingle{}.}
\CommentTok{\#\textquotesingle{} @family queries}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name query\_iupac}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export query\_iupac}
\CommentTok{\#\textquotesingle{} @aliases query\_iupac}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{query\_iupac\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_iupac}
\NormalTok{query\_iupac }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(inchikey2d,}
\NormalTok{           dir,}
           \AttributeTok{rdata.name =} \StringTok{"iupac.rdata"}\NormalTok{,}
           \AttributeTok{curl\_cl =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           ) \{}
    \FunctionTok{query\_inchikey}\NormalTok{(inchikey2d, dir, rdata.name, curl\_cl, gather\_as\_rdata,}
                   \AttributeTok{get =} \StringTok{"IUPACName"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-query_synonyms.r}{%
\section{File: query\_synonyms.R}\label{file-query_synonyms.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# query synonyms for compounds using pubchem API}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\CommentTok{\#\textquotesingle{} @aliases query\_synonyms}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @title Query synonyms of compounds via CID}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @description Bulk search for compound synonyms via pubchem API.}
\CommentTok{\#\textquotesingle{} (https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/.../synonyms/XML)}
\CommentTok{\#\textquotesingle{} @family queries}
\CommentTok{\#\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @name query\_synonyms}
\ConstantTok{NULL}
\CommentTok{\#\textgreater{} NULL}

\CommentTok{\#\textquotesingle{} @export query\_synonyms}
\CommentTok{\#\textquotesingle{} @aliases query\_synonyms}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{query\_synonyms\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_synonyms}
\NormalTok{query\_synonyms }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    cid,}
\NormalTok{    dir,}
    \AttributeTok{rdata.name =} \StringTok{"synonyms.rdata"}\NormalTok{,}
    \AttributeTok{curl\_cl =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
    \AttributeTok{group\_number =} \DecValTok{50}\NormalTok{,}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name)}
\NormalTok{    cid\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(cid\_set)) \{}
\NormalTok{      cid\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(cid\_set)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{nrow}\NormalTok{(cid\_set) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{        extra }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(cid\_set)}
      \ControlFlowTok{else}
\NormalTok{        extra }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
      \ControlFlowTok{if}\NormalTok{(}\StringTok{"cid"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(cid\_set))\{}
\NormalTok{        cid\_set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(cid\_set, cid, syno)}
\NormalTok{      \}}
\NormalTok{      cid }\OtherTok{\textless{}{-}}\NormalTok{ cid[}\SpecialCharTok{!}\NormalTok{cid }\SpecialCharTok{\%in\%}\NormalTok{ cid\_set}\SpecialCharTok{$}\NormalTok{cid]}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(cid) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }
        \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      extra }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{    \}}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{grouping\_vec2list}\NormalTok{(cid, }\AttributeTok{group\_number =}\NormalTok{ group\_number)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(group, pubchem\_get\_synonyms,}
      \AttributeTok{dir =}\NormalTok{ dir, ..., }\AttributeTok{cl =}\NormalTok{ curl\_cl)}
    \ControlFlowTok{if}\NormalTok{ (gather\_as\_rdata) \{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# gather data}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir, }\AttributeTok{pattern =} \StringTok{"\^{}G[0{-}9]\{1,\}$"}\NormalTok{,}
        \AttributeTok{dedup =}\NormalTok{ F,}
        \AttributeTok{rdata =}\NormalTok{ rdata.name,}
        \AttributeTok{extra =}\NormalTok{ extra)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, rdata.name))}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export pubchem\_get\_synonyms}
\CommentTok{\#\textquotesingle{} @aliases pubchem\_get\_synonyms}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{pubchem\_get\_synonyms\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_synonyms}
\NormalTok{pubchem\_get\_synonyms }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    cid,}
\NormalTok{    dir,}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{attr}\NormalTok{(cid, }\StringTok{"name"}\NormalTok{)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, savename)}
\NormalTok{    cid }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(cid, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{)}
\NormalTok{    url\_start }\OtherTok{\textless{}{-}} \StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"}
\NormalTok{    url\_end }\OtherTok{\textless{}{-}} \StringTok{"/synonyms/XML"}
\NormalTok{    url }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(url\_start, cid, url\_end)}
\NormalTok{    check }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(check }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{|} \FunctionTok{inherits}\NormalTok{(check, }\StringTok{"try{-}error"}\NormalTok{))\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(text }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url), }\AttributeTok{silent =}\NormalTok{ T)}
\NormalTok{    \}}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status:    503"}\NormalTok{, text))\{}
\NormalTok{      text }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url)}
\NormalTok{    \}}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlToList}\NormalTok{(text)}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ text[}\FunctionTok{names}\NormalTok{(text) }\SpecialCharTok{==} \StringTok{"Information"}\NormalTok{]}
\NormalTok{    text }\OtherTok{\textless{}{-}}
      \FunctionTok{lapply}\NormalTok{(text,}
        \ControlFlowTok{function}\NormalTok{(list)\{}
\NormalTok{          syno }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{==} \StringTok{"Synonym"}\NormalTok{]}
\NormalTok{          syno }\OtherTok{\textless{}{-}}
            \FunctionTok{lapply}\NormalTok{(syno,}
              \ControlFlowTok{function}\NormalTok{(char)\{}
                \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(char))\{}
                  \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{                \}}\ControlFlowTok{else}\NormalTok{\{}
                  \FunctionTok{return}\NormalTok{(char)}
\NormalTok{                \}}
\NormalTok{              \})}
\NormalTok{          data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{cid =}\NormalTok{ list}\SpecialCharTok{$}\NormalTok{CID, }\AttributeTok{syno =} \FunctionTok{unlist}\NormalTok{(syno))}
\NormalTok{        \})}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(text, }\AttributeTok{fill =}\NormalTok{ T)}
    \FunctionTok{write\_tsv}\NormalTok{(text, }\AttributeTok{filename =}\NormalTok{ file)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export grouping\_vec2list}
\CommentTok{\#\textquotesingle{} @aliases grouping\_vec2list}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{grouping\_vec2list\}: ...}
\CommentTok{\#\textquotesingle{} @rdname query\_synonyms}
\NormalTok{grouping\_vec2list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    vector,}
\NormalTok{    group\_number,}
    \AttributeTok{byrow =}\NormalTok{ F}
\NormalTok{    )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{\textless{}}\NormalTok{ group\_number)\{}
      \FunctionTok{attr}\NormalTok{(vector, }\StringTok{"name"}\NormalTok{) }\OtherTok{\textless{}{-}} \StringTok{"G1"}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(vector))}
\NormalTok{    \}}
\NormalTok{    rest }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{\%\%}\NormalTok{ group\_number}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(vector[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{{-}}\NormalTok{ rest)],}
      \AttributeTok{ncol =}\NormalTok{ group\_number,}
      \AttributeTok{byrow =}\NormalTok{ byrow)}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(group, }\DecValTok{1}\NormalTok{, c, }\AttributeTok{simplify =}\NormalTok{ F)}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(group, }\FunctionTok{list}\NormalTok{(}\FunctionTok{tail}\NormalTok{(vector, }\AttributeTok{n =}\NormalTok{ rest)))}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(group),}
      \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{        vec }\OtherTok{\textless{}{-}}\NormalTok{ group[[n]]}
        \FunctionTok{attr}\NormalTok{(vec, }\StringTok{"name"}\NormalTok{) }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"G"}\NormalTok{, n)}
\NormalTok{        vec}
\NormalTok{      \})}
    \ControlFlowTok{if}\NormalTok{(rest }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{      group }\OtherTok{\textless{}{-}}\NormalTok{ group[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(group) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)]}
    \FunctionTok{return}\NormalTok{(group)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export extract\_rdata\_list}
\CommentTok{\#\textquotesingle{} @aliases extract\_rdata\_list}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{extract\_rdata\_list\}: extract results from .rdata}
\CommentTok{\#\textquotesingle{} @rdname query\_synonyms}
\NormalTok{extract\_rdata\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    rdata,}
    \AttributeTok{names =} \ConstantTok{NA}
\NormalTok{    )\{}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(rdata))}
      \FunctionTok{return}\NormalTok{()}
    \FunctionTok{load}\NormalTok{(rdata)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(names[}\DecValTok{1}\NormalTok{]))\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{\%in\%}\NormalTok{ names]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}

\CommentTok{\#\textquotesingle{} @export packing\_as\_rdata\_list}
\CommentTok{\#\textquotesingle{} @aliases packing\_as\_rdata\_list}
\CommentTok{\#\textquotesingle{} @description \textbackslash{}code\{packing\_as\_rdata\_list\}: gather table as .rdata}
\CommentTok{\#\textquotesingle{} @rdname query\_synonyms}
\NormalTok{packing\_as\_rdata\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    path,}
\NormalTok{    pattern,}
\NormalTok{    rdata,}
    \AttributeTok{extra =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{rm\_files =}\NormalTok{ T,}
    \AttributeTok{dedup =}\NormalTok{ T}
\NormalTok{    )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =}\NormalTok{ pattern)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(file\_set) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file\_set), read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ file\_set}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(extra, list)}
    \ControlFlowTok{if}\NormalTok{(dedup)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{names}\NormalTok{(list), }\AttributeTok{n =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(list))}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(df, name, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[df}\SpecialCharTok{$}\NormalTok{n]}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(rm\_files)\{}
      \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file\_set), file.remove)}
\NormalTok{    \}}
    \FunctionTok{save}\NormalTok{(list, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, rdata))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-set_export.no.r}{%
\section{File: set\_export.no.R}\label{file-set_export.no.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{set\_export.no }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{col =} \StringTok{"name"}
\NormalTok{           )\{}
\NormalTok{    tmp }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{unique}\NormalTok{(df[[col]])) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(., }\AttributeTok{No =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(No, name)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, tmp, }\AttributeTok{by.x =}\NormalTok{ col, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{relocate}\NormalTok{(No) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-show_png.r}{%
\section{File: show\_png.R}\label{file-show_png.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{show\_png }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{size =} \StringTok{"500x"}\NormalTok{,}
           \AttributeTok{path =} \StringTok{"."}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.svg$"}\NormalTok{, file))\{}
\NormalTok{      tofile }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.svg$"}\NormalTok{, }\StringTok{".png"}\NormalTok{, file)}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tofile))\{}
\NormalTok{        path }\OtherTok{\textless{}{-}} \FunctionTok{normalizePath}\NormalTok{(path)}
        \FunctionTok{system}\NormalTok{(}
               \FunctionTok{paste0}\NormalTok{(}\StringTok{"cairosvg {-}i "}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, file, }\StringTok{" {-}d 300"}\NormalTok{, }\StringTok{" {-}o "}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, tofile)}
\NormalTok{        )}
\NormalTok{      \}}
\NormalTok{      file }\OtherTok{\textless{}{-}}\NormalTok{ tofile}
\NormalTok{    \}}
\NormalTok{    png }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(file)}
\NormalTok{    png }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_resize}\NormalTok{(png, size)}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{grid.raster}\NormalTok{(png)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-shunt_package.r}{%
\section{File: shunt\_package.R}\label{file-shunt_package.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Used to shift a series of functions (from files) from one package to another.}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{new\_package.fromFiles }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pkg.path, files, }\AttributeTok{path =} \ConstantTok{NULL}\NormalTok{,}
  \AttributeTok{depends =} \FunctionTok{c}\NormalTok{(}\StringTok{"ggplot2"}\NormalTok{, }\StringTok{"grid"}\NormalTok{),}
  \AttributeTok{exclude =} \FunctionTok{c}\NormalTok{(}\StringTok{"MSnbase"}\NormalTok{),}
\NormalTok{  ...) \{}
\NormalTok{  imports }\OtherTok{\textless{}{-}} \FunctionTok{parent\_packs}\NormalTok{(files, path)}
\NormalTok{  imports }\OtherTok{\textless{}{-}}\NormalTok{ imports[ }\SpecialCharTok{!}\NormalTok{imports }\SpecialCharTok{\%in\%}\NormalTok{ exclude ]}
  \FunctionTok{new\_package}\NormalTok{(pkg.path, imports, depends, ...)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(path))}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, files)}
  \FunctionTok{file.copy}\NormalTok{(files, }\FunctionTok{paste0}\NormalTok{(pkg.path, }\StringTok{"/R"}\NormalTok{), T)}
\NormalTok{\}}

\NormalTok{new\_package }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path, }\AttributeTok{imports =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{depends =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{extdata =}\NormalTok{ T,}
  \AttributeTok{fields =} \FunctionTok{.new\_package\_fields}\NormalTok{(),}
  \AttributeTok{gitignore\_templ =} \FunctionTok{.gitignore\_templ}\NormalTok{()}
\NormalTok{  ) \{}
\NormalTok{  pre.wd }\OtherTok{\textless{}{-}} \FunctionTok{getwd}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(path)) \{}
\NormalTok{    usethis}\SpecialCharTok{::}\FunctionTok{create\_package}\NormalTok{(path, fields)}
\NormalTok{    usethis}\SpecialCharTok{::}\FunctionTok{use\_mit\_license}\NormalTok{()}
    \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/inst/extdata"}\NormalTok{), }\AttributeTok{recursive =}\NormalTok{ T)}
    \FunctionTok{file.copy}\NormalTok{(gitignore\_templ, }\StringTok{"."}\NormalTok{)}
    \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\# "}\NormalTok{, stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(path, }\StringTok{"[\^{}/]*$"}\NormalTok{)),}
        \StringTok{""}\NormalTok{, }\StringTok{"Under preparation..."}\NormalTok{, }\StringTok{""}\NormalTok{), }\StringTok{"README.md"}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{setwd}\NormalTok{(path)}
\NormalTok{  \}}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"Now:"}\NormalTok{, }\FunctionTok{getwd}\NormalTok{(), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(depends)) \{}
    \FunctionTok{lapply}\NormalTok{(depends, usethis}\SpecialCharTok{::}\NormalTok{use\_package, }\AttributeTok{type =} \StringTok{"depends"}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(imports)) \{}
    \FunctionTok{lapply}\NormalTok{(imports, usethis}\SpecialCharTok{::}\NormalTok{use\_package)}
\NormalTok{  \}}
  \FunctionTok{setwd}\NormalTok{(pre.wd)}
\NormalTok{\}}

\NormalTok{parent\_packs }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(files, }\AttributeTok{path =} \ConstantTok{NULL}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(path))}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, files)}
\NormalTok{  names }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(files,}
    \ControlFlowTok{function}\NormalTok{(file)\{}
\NormalTok{      file }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(file)}
\NormalTok{      names }\OtherTok{\textless{}{-}} \FunctionTok{grep\_operater}\NormalTok{(file)}
\NormalTok{      names}
\NormalTok{    \})}
  \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(names))}
\NormalTok{\}}

\NormalTok{grep\_operater }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(txt)\{}
\NormalTok{  packs }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(txt, }\StringTok{"[a{-}zA{-}Z][a{-}zA{-}Z0{-}9.\_]\{0,\}(?=::)"}\NormalTok{)}
\NormalTok{  packs }\OtherTok{\textless{}{-}}\NormalTok{ packs[}\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(packs, is.na, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{))]}
\NormalTok{  packs }\OtherTok{\textless{}{-}}\NormalTok{ packs[}\FunctionTok{vapply}\NormalTok{(packs, requireNamespace, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{quietly =}\NormalTok{ T)]}
\NormalTok{\}}

\NormalTok{match\_function }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(txt)\{}
\NormalTok{  funs }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(txt, }\StringTok{"[.a{-}zA{-}Z][a{-}zA{-}Z0{-}9.\_]\{0,\}(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{()"}\NormalTok{)}
\NormalTok{  funs }\OtherTok{\textless{}{-}}\NormalTok{ funs[}\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(funs, is.na, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{))]}
\NormalTok{  funs }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(funs)}
\NormalTok{  parent }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(funs, findFunction)}
\NormalTok{  parent }\OtherTok{\textless{}{-}}\NormalTok{ parent[}\FunctionTok{vapply}\NormalTok{(parent, }\ControlFlowTok{function}\NormalTok{(p) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(p) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) T }\ControlFlowTok{else}\NormalTok{ F, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{))]}
\NormalTok{  parent }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(parent, }\ControlFlowTok{function}\NormalTok{(envs) \{}
\NormalTok{    name }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(envs,}
      \ControlFlowTok{function}\NormalTok{(env) \{}
        \FunctionTok{attr}\NormalTok{(env, }\StringTok{"name"}\NormalTok{)}
\NormalTok{      \})}
    \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.*:"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{unlist}\NormalTok{(name))}
\NormalTok{    \})}
  \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(parent))}
\NormalTok{\}}

\NormalTok{.new\_package\_fields }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{  author }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\FunctionTok{person}\NormalTok{(}\AttributeTok{given =} \StringTok{"LiChuang"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Huang"}\NormalTok{,}
      \AttributeTok{email =} \StringTok{"shaman.yellow@foxmail.com"}\NormalTok{,}
      \AttributeTok{role =} \FunctionTok{c}\NormalTok{(}\StringTok{"aut"}\NormalTok{),}
      \AttributeTok{comment =} \FunctionTok{c}\NormalTok{(}\AttributeTok{ORCID =} \StringTok{"0000{-}0002{-}5445{-}1988"}\NormalTok{)),}
    \FunctionTok{person}\NormalTok{(}\AttributeTok{given =} \StringTok{"Gang"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Cao"}\NormalTok{,}
      \AttributeTok{role =} \FunctionTok{c}\NormalTok{(}\StringTok{"cre"}\NormalTok{)))}
  \FunctionTok{list}\NormalTok{(}\StringTok{\textasciigrave{}}\AttributeTok{Authors@R}\StringTok{\textasciigrave{}} \OtherTok{=}\NormalTok{ author, }\AttributeTok{Author =}\NormalTok{ author,}
    \AttributeTok{Maintainer =} \StringTok{"LiChuang Huang \textless{}shaman.yellow@foxmail.com\textgreater{}"}
\NormalTok{  )}
\NormalTok{\}}

\NormalTok{.gitignore\_templ }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() \{}
  \StringTok{"\textasciitilde{}/MCnebula2/.gitignore"}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-simulate_and_evaluate.r}{%
\section{File: simulate\_and\_evaluate.R}\label{file-simulate_and_evaluate.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# simulate .mgf from .msp for evaluation}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}
\DocumentationTok{\#\# main function}
\NormalTok{msp\_to\_mgf }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    name,}
\NormalTok{    id\_prefix,}
    \AttributeTok{path =} \StringTok{"\textasciitilde{}/Downloads/msp/MoNA/"}\NormalTok{,}
    \AttributeTok{write\_meta\_data =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".meta.tsv"}\NormalTok{),}
    \AttributeTok{fun =} \StringTok{"mutate\_deal\_with\_msp\_record"}\NormalTok{,}
    \AttributeTok{pre\_modify =}\NormalTok{ T,}
\NormalTok{    ...}
\NormalTok{    )\{}
    \ControlFlowTok{if}\NormalTok{(pre\_modify }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"sed {-}i \textquotesingle{}s/}\SpecialCharTok{\textbackslash{}r}\StringTok{//g\textquotesingle{} "}\NormalTok{, path, }\StringTok{"/"}\NormalTok{, name))}
\NormalTok{    \}}
\NormalTok{    msp }\OtherTok{\textless{}{-}} \FunctionTok{read\_msp}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name))}
\NormalTok{    cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{    store }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{    mgf }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".mgf"}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{""}\NormalTok{, }\AttributeTok{file =}\NormalTok{ mgf)}
\NormalTok{    ms\_fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(fun)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(msp[[}\DecValTok{1}\NormalTok{]], ms\_fun, }
      \AttributeTok{id\_prefix =}\NormalTok{ id\_prefix,}
      \AttributeTok{cache =}\NormalTok{ cache,}
      \AttributeTok{store =}\NormalTok{ store,}
\NormalTok{      ...)}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(set, get\_envir\_df,}
      \AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    meta\_data }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(meta\_data, }\AttributeTok{fill =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(write\_meta\_data) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{write\_tsv}\NormalTok{(meta\_data, write\_meta\_data)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(meta\_data)}
\NormalTok{  \}}
\NormalTok{read\_msp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    filepath}
\NormalTok{    )\{}
\NormalTok{    msp }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(filepath, }\AttributeTok{sep =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F)}
\NormalTok{  \}}
\NormalTok{get\_envir\_df }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    var,}
\NormalTok{    envir}
\NormalTok{    )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(var, }\AttributeTok{envir =}\NormalTok{ envir)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}

\DocumentationTok{\#\# deal with each line}
\NormalTok{mutate\_deal\_with\_msp\_record }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    ...}
\NormalTok{    )\{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...,}
      \AttributeTok{mass\_sep =} \StringTok{" "}\NormalTok{,}
      \AttributeTok{input =} \FunctionTok{c}\NormalTok{(}
        \AttributeTok{name =} \StringTok{"Name"}\NormalTok{,}
        \AttributeTok{mass =} \StringTok{"PrecursorMZ"}\NormalTok{, }
        \AttributeTok{adduct =} \StringTok{"Precursor\_type"}\NormalTok{,}
        \AttributeTok{formula =} \StringTok{"Formula"}\NormalTok{,}
        \AttributeTok{rt =} \StringTok{"NA"}\NormalTok{),}
      \AttributeTok{other =} \FunctionTok{c}\NormalTok{(}
        \StringTok{"Name"}\NormalTok{, }\StringTok{"Synon"}\NormalTok{, }\StringTok{"DB\#"}\NormalTok{, }\StringTok{"InChIKey"}\NormalTok{,}
        \StringTok{"Precursor\_type"}\NormalTok{, }\StringTok{"Spectrum\_type"}\NormalTok{, }\StringTok{"PrecursorMZ"}\NormalTok{,}
        \StringTok{"Instrument\_type"}\NormalTok{, }\StringTok{"Instrument"}\NormalTok{, }\StringTok{"Ion\_mode"}\NormalTok{,}
        \StringTok{"Collision\_energy"}\NormalTok{, }\StringTok{"Formula"}\NormalTok{,}
        \StringTok{"MW"}\NormalTok{, }\StringTok{"ExactMass"}\NormalTok{, }\StringTok{"Comments"}\NormalTok{)}
\NormalTok{    )}
    \FunctionTok{do.call}\NormalTok{(deal\_with\_msp\_record, args)}
\NormalTok{  \}}
\NormalTok{deal\_with\_msp\_record }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
\NormalTok{    id\_prefix,}
\NormalTok{    cache,}
\NormalTok{    store,}
    \AttributeTok{mass\_level =} \DecValTok{2}\NormalTok{,}
    \AttributeTok{set\_rt =} \ConstantTok{NA}\NormalTok{,}
    \AttributeTok{mass\_sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{,}
    \AttributeTok{id =} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache),}
    \AttributeTok{input =} \FunctionTok{c}\NormalTok{(}\AttributeTok{name =} \StringTok{"NAME"}\NormalTok{,}
      \AttributeTok{mass =} \StringTok{"PRECURSORMZ"}\NormalTok{,}
      \AttributeTok{adduct =} \StringTok{"PRECURSORTYPE"}\NormalTok{,}
      \AttributeTok{formula =} \StringTok{"FORMULA"}\NormalTok{,}
      \AttributeTok{rt =} \StringTok{"RETENTIONTIME"}\NormalTok{),}
    \AttributeTok{other =} \FunctionTok{c}\NormalTok{(}\StringTok{"NAME"}\NormalTok{, }\StringTok{"PRECURSORMZ"}\NormalTok{, }\StringTok{"PRECURSORTYPE"}\NormalTok{,}
      \StringTok{"FORMULA"}\NormalTok{, }\StringTok{"Ontology"}\NormalTok{, }\StringTok{"INCHIKEY"}\NormalTok{, }\StringTok{"SMILES"}\NormalTok{,}
      \StringTok{"RETENTIONTIME"}\NormalTok{, }\StringTok{"CCS"}\NormalTok{, }\StringTok{"IONMODE"}\NormalTok{,}
      \StringTok{"INSTRUMENTTYPE"}\NormalTok{,}\StringTok{"INSTRUMENT"}\NormalTok{,}
      \StringTok{"COLLISIONENERGY"}\NormalTok{, }\StringTok{"Comment"}\NormalTok{, }\StringTok{"Num Peaks"}\NormalTok{),}
    \AttributeTok{output =} \FunctionTok{c}\NormalTok{(}\AttributeTok{begin =} \StringTok{"BEGIN IONS"}\NormalTok{,}
      \AttributeTok{id =} \StringTok{"FEATURE\_ID="}\NormalTok{,}
      \AttributeTok{mass =} \StringTok{"PEPMASS="}\NormalTok{,}
      \AttributeTok{charge =} \StringTok{"CHARGE="}\NormalTok{,}
      \AttributeTok{rt =} \StringTok{"RTINSECONDS="}\NormalTok{,}
      \AttributeTok{level =} \StringTok{"MSLEVEL="}\NormalTok{,}
      \AttributeTok{end =} \StringTok{"END IONS"}\NormalTok{),}
    \AttributeTok{add\_scans =}\NormalTok{ F}
\NormalTok{    )\{}
    \DocumentationTok{\#\# get name and value}
\NormalTok{    name }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string)}
\NormalTok{    name }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(name) }\SpecialCharTok{==}\NormalTok{ T, }\StringTok{""}\NormalTok{, name)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[A{-}Z]"}\NormalTok{, name) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      value }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string)}
\NormalTok{    \}}
\NormalTok{    cat }\OtherTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"name"}\NormalTok{]])\{}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# id update}
\NormalTok{      id }\OtherTok{=}\NormalTok{ id }\SpecialCharTok{+} \DecValTok{1}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"id"}\NormalTok{, id, }\AttributeTok{envir =}\NormalTok{ cache)}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\DecValTok{1}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
      \DocumentationTok{\#\# output}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"id"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(id\_prefix, id)}
      \DocumentationTok{\#\# new var in envir: store}
\NormalTok{      info }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ s, }\AttributeTok{name =}\NormalTok{ value)}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"mass"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"mass"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=}\NormalTok{ value}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"adduct"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"charge"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}|]+"}\NormalTok{, value) }\SpecialCharTok{==}\NormalTok{ F, }\StringTok{"0"}\NormalTok{,}
        \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"]{-}"}\NormalTok{, value), }\StringTok{"1{-}"}\NormalTok{, }\StringTok{"1+"}\NormalTok{))}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[}\StringTok{"charge"}\NormalTok{]] }\OtherTok{=}\NormalTok{ s}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"adduct"}\NormalTok{, value, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"formula"}\NormalTok{]])\{}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"formula"}\NormalTok{, value, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==}\NormalTok{ input[[}\StringTok{"rt"}\NormalTok{]])\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"rt"}\NormalTok{]]}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(set\_rt))\{}
\NormalTok{        s }\OtherTok{=}\NormalTok{ value}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        s }\OtherTok{=}\NormalTok{ set\_rt}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{==} \StringTok{"Num Peaks"}\NormalTok{)\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{0}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
      \ControlFlowTok{if}\NormalTok{(mass\_level }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"1}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"100}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
        \DocumentationTok{\#\# here, use rcdk to simulate calculate the isotope pattern}
\NormalTok{        adduct }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"adduct"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
        \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"FA|ACN"}\NormalTok{, adduct))\{}
\NormalTok{          adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"FA"}\NormalTok{, }\StringTok{"CO2H2"}\NormalTok{, adduct)}
\NormalTok{          adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"ACN"}\NormalTok{, }\StringTok{"C2H3N"}\NormalTok{, adduct)}
\NormalTok{        \}}
        \ControlFlowTok{if}\NormalTok{(adduct }\SpecialCharTok{!=} \StringTok{"[M+H{-}99]+"}\NormalTok{)\{}
\NormalTok{          formula }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"formula"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
          \DocumentationTok{\#\# according to adduct to revise formula}
\NormalTok{          formula }\OtherTok{\textless{}{-}} \FunctionTok{formula\_reshape\_with\_adduct}\NormalTok{(formula, adduct)}
          \DocumentationTok{\#\# rcdk function}
\NormalTok{          array }\OtherTok{\textless{}{-}}\NormalTok{ rcdk}\SpecialCharTok{::}\FunctionTok{get.isotopes.pattern}\NormalTok{(rcdk}\SpecialCharTok{::}\FunctionTok{get.formula}\NormalTok{(formula))}
          \FunctionTok{apply}\NormalTok{(array, }\DecValTok{1}\NormalTok{, cat\_isotope)}
\NormalTok{        \}}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"end"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \DocumentationTok{\#\# begin mass level 2}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"begin"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"id"}\NormalTok{]], info[[}\StringTok{".id"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"mass"}\NormalTok{]], info[[}\StringTok{"PRECURSORMZ"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
        \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"charge"}\NormalTok{]], info[[}\StringTok{"charge"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      \}}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(set\_rt))}
\NormalTok{        info[[}\StringTok{"RETENTIONTIME"}\NormalTok{]] }\OtherTok{=}\NormalTok{ set\_rt}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"rt"}\NormalTok{]], info[[}\StringTok{"RETENTIONTIME"}\NormalTok{]], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(output[[}\StringTok{"level"}\NormalTok{]], }\StringTok{"2}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{catapp}\NormalTok{(}\StringTok{"MERGED\_STATS=1 / 1 (0 removed due to low quality, 0 removed due to low cosine)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}[0{-}9]"}\NormalTok{, string))\{}
\NormalTok{      cat }\OtherTok{=} \DecValTok{2}
\NormalTok{      p }\OtherTok{=} \FunctionTok{get\_name}\NormalTok{(string, }\AttributeTok{sep =}\NormalTok{ mass\_sep)}
\NormalTok{      s }\OtherTok{=} \FunctionTok{get\_value}\NormalTok{(string, }\AttributeTok{sep =}\NormalTok{ mass\_sep)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(string }\SpecialCharTok{==} \StringTok{""}\NormalTok{)\{}
\NormalTok{      ion }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
      \ControlFlowTok{if}\NormalTok{(ion }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{()}
\NormalTok{      \}}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"ion"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      cat }\OtherTok{=} \DecValTok{1}
\NormalTok{      p }\OtherTok{=}\NormalTok{ output[[}\StringTok{"end"}\NormalTok{]]}
\NormalTok{      s }\OtherTok{=} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(add\_scans }\SpecialCharTok{==}\NormalTok{ T)\{}
        \ControlFlowTok{if}\NormalTok{(p }\SpecialCharTok{==}\NormalTok{ output[[}\StringTok{"mass"}\NormalTok{]])\{}
\NormalTok{          id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
          \FunctionTok{catapp}\NormalTok{(}\StringTok{"SCANS="}\NormalTok{, id, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(cat }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)\{}
      \FunctionTok{catapp}\NormalTok{(p, s, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# data store}
    \ControlFlowTok{if}\NormalTok{(name }\SpecialCharTok{\%in\%}\NormalTok{ other }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      id }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"id"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ cache)}
\NormalTok{      info }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{      info[[name]] }\OtherTok{=}\NormalTok{ value}
      \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(id), info, }\AttributeTok{envir =}\NormalTok{ store)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# output}
\NormalTok{  \}}
\NormalTok{catapp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    ...,}
    \AttributeTok{sep =} \StringTok{""}\NormalTok{,}
    \AttributeTok{mgf =} \FunctionTok{get}\NormalTok{(}\StringTok{"mgf"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{    )\{}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste}\NormalTok{(..., }\AttributeTok{sep =}\NormalTok{ sep), }\AttributeTok{file =}\NormalTok{ mgf, }\AttributeTok{append =}\NormalTok{ T)}
\NormalTok{  \}}
\NormalTok{cat\_isotope }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    vector}
\NormalTok{    )\{}
    \FunctionTok{catapp}\NormalTok{(vector[}\DecValTok{1}\NormalTok{], vector[}\DecValTok{2}\NormalTok{] }\SpecialCharTok{*} \DecValTok{100}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{get\_value }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
    \AttributeTok{sep =} \StringTok{": "}
\NormalTok{    )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{2}\NormalTok{])}
\NormalTok{  \}}
\NormalTok{get\_name }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    string,}
    \AttributeTok{sep =} \StringTok{": "}
\NormalTok{    )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(string, }\AttributeTok{split =}\NormalTok{ sep))}
    \FunctionTok{return}\NormalTok{(string[}\DecValTok{1}\NormalTok{])}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# Calculate ion mass of formula with adduct}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{formula\_adduct\_mass }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
    \AttributeTok{formula =} \ConstantTok{NA}\NormalTok{,}
    \AttributeTok{compound\_weight =} \ConstantTok{NA}\NormalTok{,}
    \AttributeTok{get\_formula\_weight =}\NormalTok{ F,}
    \AttributeTok{iontype =} \StringTok{"neg"}\NormalTok{,}
    \AttributeTok{db\_adduct =} \StringTok{"[M+H]+,[M+K]+,[M+Na]+,[M+H{-}H2O]+,[M+H{-}H4O2]+,[M+NH4]+,[M{-}H]{-},[M+Cl]{-},[M{-}H2O{-}H]{-},}
\StringTok{    [M+Br]{-},[M+FA{-}H]{-},[M+ACN{-}H]{-}"}
\NormalTok{    )\{}
\NormalTok{    welement }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{H =} \FloatTok{1.007825}\NormalTok{,}
      \AttributeTok{C =} \FloatTok{12.0}\NormalTok{,}
      \AttributeTok{N =} \FloatTok{14.003074}\NormalTok{,}
      \AttributeTok{O =} \FloatTok{15.994915}\NormalTok{,}
      \AttributeTok{F =} \FloatTok{18.998403}\NormalTok{,}
      \AttributeTok{P =} \FloatTok{30.973762}\NormalTok{,}
      \AttributeTok{S =} \FloatTok{31.972071}\NormalTok{,}
      \AttributeTok{Cl =} \FloatTok{34.968853}\NormalTok{,}
      \AttributeTok{Br =} \FloatTok{78.918336}\NormalTok{,}
      \AttributeTok{Na =} \FloatTok{22.989770}\NormalTok{,}
      \AttributeTok{K =} \FloatTok{38.963708}\NormalTok{)}
\NormalTok{    db\_adduct }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{strsplit}\NormalTok{(db\_adduct, }\AttributeTok{split =} \StringTok{","}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(iontype }\SpecialCharTok{==} \StringTok{"neg"}\NormalTok{)\{}
\NormalTok{      db\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ db\_adduct[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]){-}$"}\NormalTok{, db\_adduct, }\AttributeTok{perl =}\NormalTok{ T)]}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      db\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ db\_adduct[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{])}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+$"}\NormalTok{, db\_adduct, }\AttributeTok{perl =}\NormalTok{ T)]}
\NormalTok{    \}}
\NormalTok{    db\_adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"FA"}\NormalTok{, }\StringTok{"CO2H2"}\NormalTok{, db\_adduct)}
\NormalTok{    db\_adduct }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"ACN"}\NormalTok{, }\StringTok{"C2H3N"}\NormalTok{, db\_adduct)}
    \FunctionTok{cat}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"[INFO] use adduct: "}\NormalTok{, }\FunctionTok{paste}\NormalTok{(db\_adduct, }\AttributeTok{collapse =} \StringTok{" | "}\NormalTok{), }\StringTok{" }\SpecialCharTok{\textbackslash{}n\textbackslash{}n}\StringTok{"}\NormalTok{))}
    \DocumentationTok{\#\# calculate adduct mass}
\NormalTok{    adduct\_mass }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(db\_adduct, get\_adduct\_mass))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(compound\_weight))\{}
\NormalTok{      compound\_weight }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(formula, element\_extract)}
\NormalTok{      compound\_weight }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(compound\_weight, element\_calculate, }\AttributeTok{welement =}\NormalTok{ welement))}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(get\_formula\_weight)\{}
      \FunctionTok{return}\NormalTok{(compound\_weight)}
\NormalTok{    \}}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_weight, }\ControlFlowTok{function}\NormalTok{(x, plus)\{x }\SpecialCharTok{+}\NormalTok{ plus\}, adduct\_mass)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list,}
      \ControlFlowTok{function}\NormalTok{(mass, adduct)\{}
\NormalTok{        data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{adduct =}\NormalTok{ adduct, }\AttributeTok{mass =}\NormalTok{ mass)}
\NormalTok{      \}, }\AttributeTok{adduct =}\NormalTok{ db\_adduct)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ formula}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{get\_adduct\_mass }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    adduct}
\NormalTok{    )\{}
\NormalTok{    welement }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{H =} \FloatTok{1.007825}\NormalTok{,}
      \AttributeTok{C =} \FloatTok{12.0}\NormalTok{,}
      \AttributeTok{N =} \FloatTok{14.003074}\NormalTok{,}
      \AttributeTok{O =} \FloatTok{15.994915}\NormalTok{,}
      \AttributeTok{F =} \FloatTok{18.998403}\NormalTok{,}
      \AttributeTok{P =} \FloatTok{30.973762}\NormalTok{,}
      \AttributeTok{S =} \FloatTok{31.972071}\NormalTok{,}
      \AttributeTok{Cl =} \FloatTok{34.968853}\NormalTok{,}
      \AttributeTok{Br =} \FloatTok{78.918336}\NormalTok{,}
      \AttributeTok{K =} \FloatTok{38.963708}\NormalTok{,}
      \AttributeTok{Na =} \FloatTok{22.989770}\NormalTok{)}
\NormalTok{    com }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(adduct, }\StringTok{"(?\textless{}=[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+])[A{-}Z\&a{-}z\&0{-}9]\{1,\}(?=[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]])"}\NormalTok{)}
\NormalTok{    com }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(com)}
\NormalTok{    ufunc }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(adduct, }\StringTok{"(?\textless{}=[0{-}9|a{-}z|A{-}Z])}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+|{-}(?=[0{-}9|a{-}z|A{-}Z])"}\NormalTok{)}
\NormalTok{    ufunc }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(ufunc)}
\NormalTok{    mass }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(com, element\_extract)}
\NormalTok{    mass }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(mass, element\_calculate, }\AttributeTok{welement =}\NormalTok{ welement)}
\NormalTok{    mass }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(mass)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{ufunc =}\NormalTok{ ufunc, }\AttributeTok{mass =}\NormalTok{ mass)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =} \FunctionTok{ifelse}\NormalTok{(ufunc }\SpecialCharTok{==} \StringTok{"+"}\NormalTok{, mass, mass }\SpecialCharTok{*}\NormalTok{ (}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)))}
\NormalTok{    sum }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{mass)}
    \FunctionTok{return}\NormalTok{(sum)}
\NormalTok{  \}}
\NormalTok{element\_calculate }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    df,}
\NormalTok{    welement}
\NormalTok{    )\{}
\NormalTok{    weight }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(element, number, welement)\{}
\NormalTok{      welement[[element]] }\SpecialCharTok{*}\NormalTok{ number\},}
\NormalTok{      df}\SpecialCharTok{$}\NormalTok{element, df}\SpecialCharTok{$}\NormalTok{number,}
      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{welement =}\NormalTok{ welement))}
\NormalTok{    weight }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(weight)}
    \FunctionTok{return}\NormalTok{(weight)}
\NormalTok{  \}}
\NormalTok{element\_extract }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    formula}
\NormalTok{    )\{}
\NormalTok{    element }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(formula, }\StringTok{"[A{-}Z]\{1\}[a{-}z]\{0,1\}"}\NormalTok{))}
\NormalTok{    number }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}="}\NormalTok{, element, }\StringTok{")[0{-}9]\{0,\}[0{-}9]\{0,\}[0{-}9]\{0,\}"}\NormalTok{),}
\NormalTok{        mutate\_extract, }\AttributeTok{db =}\NormalTok{ formula))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{element =}\NormalTok{ element, }\AttributeTok{number =}\NormalTok{ number)}
    \DocumentationTok{\#\# if is NA, set as 1}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{number =} \FunctionTok{ifelse}\NormalTok{(number }\SpecialCharTok{==} \StringTok{""}\NormalTok{, }\DecValTok{1}\NormalTok{, }\FunctionTok{as.numeric}\NormalTok{(number)))}
    \ControlFlowTok{if}\NormalTok{(T }\SpecialCharTok{\%in\%} \FunctionTok{duplicated}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{element))}
\NormalTok{      error}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{mutate\_extract }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    pattern,}
\NormalTok{    db}
\NormalTok{    )\{}
\NormalTok{    ch }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(db, pattern)}
    \FunctionTok{return}\NormalTok{(ch)}
\NormalTok{  \}}
\NormalTok{get\_adduct\_df }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    adduct}
\NormalTok{    )\{}
\NormalTok{    com }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(adduct, }\StringTok{"(?\textless{}=[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+])[A{-}Z\&a{-}z\&0{-}9]\{1,\}(?=[}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]])"}\NormalTok{)}
\NormalTok{    com }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(com)}
\NormalTok{    com }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(com, element\_extract)}
\NormalTok{    ufunc }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(adduct, }\StringTok{"(?\textless{}=[0{-}9|a{-}z|A{-}Z])}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+|{-}(?=[0{-}9|a{-}z|A{-}Z])"}\NormalTok{)}
\NormalTok{    ufunc }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(ufunc)}
    \FunctionTok{names}\NormalTok{(com) }\OtherTok{\textless{}{-}}\NormalTok{ ufunc}
\NormalTok{    com }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(com, }\AttributeTok{idcol =}\NormalTok{ T)}
    \FunctionTok{return}\NormalTok{(com)}
\NormalTok{  \}}
\NormalTok{formula\_reshape\_with\_adduct }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    formula,}
\NormalTok{    adduct,}
    \AttributeTok{order =}\NormalTok{ F}
\NormalTok{    )\{}
\NormalTok{    adduct }\OtherTok{\textless{}{-}} \FunctionTok{get\_adduct\_df}\NormalTok{(adduct)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(adduct) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(formula)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{element\_extract}\NormalTok{(formula)}
\NormalTok{    meta }\OtherTok{\textless{}{-}} \FunctionTok{environment}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, adduct, }\AttributeTok{by =} \StringTok{"element"}\NormalTok{, }\AttributeTok{all =}\NormalTok{ T)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{number =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(.id), number.x,}
        \FunctionTok{ifelse}\NormalTok{(.id }\SpecialCharTok{==} \StringTok{"{-}"}\NormalTok{, number.x }\SpecialCharTok{{-}}\NormalTok{ number.y,}
          \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(number.x), number.y, number.x }\SpecialCharTok{+}\NormalTok{ number.y))))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[, }\FunctionTok{c}\NormalTok{(}\StringTok{"element"}\NormalTok{, }\StringTok{"number"}\NormalTok{)]}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(df, element), }\StringTok{"number"}\NormalTok{, sum)}
    \ControlFlowTok{if}\NormalTok{(order)\{}
\NormalTok{      levels }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"C"}\NormalTok{, }\StringTok{"H"}\NormalTok{, }\StringTok{"Cl"}\NormalTok{, }\StringTok{"F"}\NormalTok{, }\StringTok{"I"}\NormalTok{, }\StringTok{"K"}\NormalTok{, }\StringTok{"N"}\NormalTok{, }\StringTok{"Na"}\NormalTok{, }\StringTok{"O"}\NormalTok{, }\StringTok{"P"}\NormalTok{, }\StringTok{"S"}\NormalTok{)}
\NormalTok{      levels }\OtherTok{\textless{}{-}}\NormalTok{ levels[levels }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{element]}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(df, }\FunctionTok{factor}\NormalTok{(element, }\AttributeTok{levels =}\NormalTok{ levels))}
\NormalTok{    \}}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{number }\OtherTok{\textless{}{-}} \FunctionTok{as.character}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{number)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, paste0)}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(ch, }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(ch)}
    \CommentTok{\# apply(adduct, 1, base\_formula\_reshape\_with\_adduct, envir = meta)}
    \CommentTok{\# return(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# add noise to mgf}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{collate\_as\_noise\_pool }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    origin\_list,}
\NormalTok{    valid\_list}
\NormalTok{    )\{}
    \DocumentationTok{\#\# filter origin\_list}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{list =}\NormalTok{ origin\_list, }\AttributeTok{discard\_level1 =}\NormalTok{ T, }\AttributeTok{only\_peak\_info =}\NormalTok{ T, }\AttributeTok{mass\_shift =}\NormalTok{ F)}
    \DocumentationTok{\#\# get mz and intensity}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Catch main peak information}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(spectrum\_add\_noise, args)}
    \DocumentationTok{\#\# discard the NULL data}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Discard empty dataset}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    order\_list }\OtherTok{\textless{}{-}}\NormalTok{ origin\_list[}\FunctionTok{vapply}\NormalTok{(origin\_list, is.data.frame, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{USE.NAMES =}\NormalTok{ F)]}
    \DocumentationTok{\#\# order the origin\_list and valid\_list according to .id}
    \DocumentationTok{\#\# first, filter the origin\_list, only the .id in valid\_list is reserved.}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}}\NormalTok{ origin\_list[}\FunctionTok{names}\NormalTok{(origin\_list) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(valid\_list)]}
    \DocumentationTok{\#\# keep identical}
\NormalTok{    valid\_list }\OtherTok{\textless{}{-}}\NormalTok{ valid\_list[}\FunctionTok{names}\NormalTok{(valid\_list) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(origin\_list)]}
    \DocumentationTok{\#\# order}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Order the lists...}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}} \FunctionTok{order\_list}\NormalTok{(origin\_list)}
\NormalTok{    valid\_list }\OtherTok{\textless{}{-}} \FunctionTok{order\_list}\NormalTok{(valid\_list)}
\NormalTok{    origin\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(origin\_list,}
      \ControlFlowTok{function}\NormalTok{(df) \{}
\NormalTok{        df[[ }\StringTok{"mass"}\NormalTok{ ]] }\OtherTok{\textless{}{-}} \FunctionTok{as.double}\NormalTok{(df[[ }\StringTok{"mass"}\NormalTok{ ]])}
\NormalTok{        df[[ }\StringTok{"inte"}\NormalTok{ ]] }\OtherTok{\textless{}{-}} \FunctionTok{as.double}\NormalTok{(df[[ }\StringTok{"inte"}\NormalTok{ ]])}
\NormalTok{        df}
\NormalTok{      \})}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Merge to get noise list}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    noise\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(origin\_list),}
      \ControlFlowTok{function}\NormalTok{(name) \{}
\NormalTok{        df }\OtherTok{\textless{}{-}} \FunctionTok{tol\_mergeEx}\NormalTok{(}
\NormalTok{          origin\_list[[ name ]], valid\_list[[ name ]],}
          \AttributeTok{main\_col =} \StringTok{"mass"}\NormalTok{, }\AttributeTok{sub\_col =} \StringTok{"mz"}
\NormalTok{        )}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{rel.int. }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{inte }\SpecialCharTok{/} \FunctionTok{max}\NormalTok{(origin\_list[[ name ]]}\SpecialCharTok{$}\NormalTok{inte)}
\NormalTok{        df}
\NormalTok{      \})}
\NormalTok{    noise\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(noise\_list, }\AttributeTok{fill =}\NormalTok{ T)}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(noise\_df, }\AttributeTok{mass =} \FunctionTok{as.numeric}\NormalTok{(mass), }\AttributeTok{inte =} \FunctionTok{as.numeric}\NormalTok{(inte))}
\NormalTok{  \}}

\NormalTok{filter\_mgf }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{filter\_id =} \FunctionTok{prapare\_inst\_data}\NormalTok{(.MCn.structure\_set)}\SpecialCharTok{$}\NormalTok{.id,}
\NormalTok{           file}
\NormalTok{           )\{}
\NormalTok{    mgf }\OtherTok{\textless{}{-}} \FunctionTok{read\_msp}\NormalTok{(file)}
\NormalTok{    start }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(mgf}\SpecialCharTok{$}\NormalTok{V1 }\SpecialCharTok{==} \StringTok{"BEGIN IONS"}\NormalTok{)}
\NormalTok{    end }\OtherTok{\textless{}{-}} \FunctionTok{which}\NormalTok{(mgf}\SpecialCharTok{$}\NormalTok{V1 }\SpecialCharTok{==} \StringTok{""}\NormalTok{)}
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ mgf[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"FEATURE\_ID"}\NormalTok{, mgf}\SpecialCharTok{$}\NormalTok{V1), ]}
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(id, }\StringTok{"(?\textless{}==).*$"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
      \ControlFlowTok{function}\NormalTok{(start, end, mgf) \{}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(mgf, start}\SpecialCharTok{:}\NormalTok{end)}
\NormalTok{      \}, start, end, }\AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{mgf =}\NormalTok{ mgf), }\AttributeTok{SIMPLIFY =}\NormalTok{ F}
\NormalTok{    )}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ id}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(filter\_id) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{\%in\%}\NormalTok{ filter\_id]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}

\DocumentationTok{\#\# mutate function of tol\_merge, get the non{-}merged data}
\NormalTok{tol\_mergeEx }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(main,}
\NormalTok{           sub,}
           \AttributeTok{main\_col =} \StringTok{"mz"}\NormalTok{,}
           \AttributeTok{sub\_col =} \StringTok{"mz"}\NormalTok{,}
           \AttributeTok{tol =} \FloatTok{0.002}\NormalTok{,}
           \AttributeTok{bin\_size =} \DecValTok{1}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{ (main\_col }\SpecialCharTok{==}\NormalTok{ sub\_col) \{}
\NormalTok{      new\_name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(sub\_col, }\StringTok{".sub"}\NormalTok{)}
      \FunctionTok{colnames}\NormalTok{(sub)[}\FunctionTok{colnames}\NormalTok{(sub) }\SpecialCharTok{==}\NormalTok{ sub\_col] }\OtherTok{\textless{}{-}}\NormalTok{ new\_name}
\NormalTok{      sub\_col }\OtherTok{\textless{}{-}}\NormalTok{ new\_name}
\NormalTok{    \}}
\NormalTok{    main}\SpecialCharTok{$}\NormalTok{...seq }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(main)}
\NormalTok{    backup }\OtherTok{\textless{}{-}}\NormalTok{ main}
    \DocumentationTok{\#\# to reduce computation, round numeric for limitation}
    \DocumentationTok{\#\# main}
\NormalTok{    main}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(main[[ main\_col ]], bin\_size)}
    \DocumentationTok{\#\# sub}
\NormalTok{    sub.x }\OtherTok{\textless{}{-}}\NormalTok{ sub.y }\OtherTok{\textless{}{-}}\NormalTok{ sub}
\NormalTok{    sub.x}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(sub.x[[ sub\_col ]], bin\_size)}
\NormalTok{    sub.y}\SpecialCharTok{$}\NormalTok{...id }\OtherTok{\textless{}{-}}\NormalTok{ sub.x}\SpecialCharTok{$}\NormalTok{...id }\SpecialCharTok{+}\NormalTok{ ( }\DecValTok{1} \SpecialCharTok{*} \DecValTok{10}\SpecialCharTok{\^{}{-}}\NormalTok{bin\_size )}
\NormalTok{    sub }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(sub.x, sub.y)}
    \DocumentationTok{\#\# expand merge}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(main, sub, }\AttributeTok{by =} \StringTok{"...id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{allow.cartesian =}\NormalTok{ T)}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{...diff }\OtherTok{\textless{}{-}} \FunctionTok{abs}\NormalTok{(df[[ main\_col ]] }\SpecialCharTok{{-}}\NormalTok{ df[[ sub\_col ]])}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, ...diff }\SpecialCharTok{\textless{}=} \SpecialCharTok{!!}\NormalTok{tol)}
    \DocumentationTok{\#\# get the non{-}merged}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ backup[}\SpecialCharTok{!}\NormalTok{backup}\SpecialCharTok{$}\NormalTok{...seq }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{...seq, ]}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{...seq }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{    df}
\NormalTok{  \}}

\NormalTok{mass\_shift }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{merge =}\NormalTok{ T,}
           \AttributeTok{sep =} \StringTok{" "}\NormalTok{,}
           \AttributeTok{int.sigma =} \DecValTok{1}\NormalTok{,}
           \AttributeTok{re.ppm =} \FloatTok{1e{-}6}\NormalTok{,}
           \AttributeTok{global.sigma =} \DecValTok{10}\SpecialCharTok{/}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ re.ppm,}
           \AttributeTok{indivi.sigma =} \DecValTok{10}\SpecialCharTok{/}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ re.ppm,}
           \AttributeTok{sub.factor =} \FloatTok{0.03}\NormalTok{,}
           \AttributeTok{.noise\_pool =}\NormalTok{ noise\_pool,}
           \AttributeTok{alpha =} \FloatTok{0.2}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =} \FunctionTok{as.numeric}\NormalTok{(mass), }\AttributeTok{inte =} \FunctionTok{as.numeric}\NormalTok{(inte))}
    \DocumentationTok{\#\# intensity variation}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df), }\DecValTok{1}\NormalTok{, int.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{inte =}\NormalTok{ inte }\SpecialCharTok{*}\NormalTok{ var)}
    \DocumentationTok{\#\# subtract according to max intensity}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{inte =} \FunctionTok{round}\NormalTok{(inte }\SpecialCharTok{{-}} \FunctionTok{max}\NormalTok{(inte) }\SpecialCharTok{*}\NormalTok{ sub.factor, }\DecValTok{0}\NormalTok{))}
    \DocumentationTok{\#\# if intensity less than 0, discard}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, inte }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
    \DocumentationTok{\#\# almost one peak, discard the data}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\textless{}=} \DecValTok{1}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# global shift}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{, global.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =}\NormalTok{ mass }\SpecialCharTok{+}\NormalTok{ mass }\SpecialCharTok{*}\NormalTok{ var)}
    \DocumentationTok{\#\# individual shift}
\NormalTok{    var }\OtherTok{\textless{}{-}} \FunctionTok{rnorm}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df), }\DecValTok{0}\NormalTok{, indivi.sigma)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{mass =} \FunctionTok{round}\NormalTok{(mass }\SpecialCharTok{+}\NormalTok{ mass }\SpecialCharTok{*}\NormalTok{ var, }\DecValTok{4}\NormalTok{))}
    \DocumentationTok{\#\# add noise peak}
    \DocumentationTok{\#\# random drawn noise peak from noise pool}
\NormalTok{    noise }\OtherTok{\textless{}{-}}\NormalTok{ .noise\_pool[}\FunctionTok{sample}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(.noise\_pool), }\FunctionTok{round}\NormalTok{(alpha }\SpecialCharTok{*} \FunctionTok{nrow}\NormalTok{(df))), ]}
    \DocumentationTok{\#\# re{-}size intensity}
\NormalTok{    noise }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(noise, }\AttributeTok{inte =} \FunctionTok{max}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{inte) }\SpecialCharTok{*}\NormalTok{ rel.int.)}
    \DocumentationTok{\#\# bind into df}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{bind\_rows}\NormalTok{(df, dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(noise, mass, inte))}
    \ControlFlowTok{if}\NormalTok{(merge)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(mass, sep, inte))}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(df, V1)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# spectra add noise}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\DocumentationTok{\#\# for .mgf data}
\NormalTok{spectrum\_add\_noise }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(list, }\AttributeTok{cl =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{filter\_empty =}\NormalTok{ T, ...)}
\NormalTok{  \{}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list,}
      \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{discard\_level1 =}\NormalTok{ F, }\AttributeTok{mass\_process\_level\_1 =}\NormalTok{ F,}
        \AttributeTok{mass\_process\_level\_2 =}\NormalTok{ T, ...)}
\NormalTok{      \{}
\NormalTok{        mass\_level }\OtherTok{\textless{}{-}}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{V1[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"MSLEVEL"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)]}
        \DocumentationTok{\#\# process level 1}
        \ControlFlowTok{if}\NormalTok{(mass\_level }\SpecialCharTok{==} \StringTok{"MSLEVEL=1"}\NormalTok{)\{}
          \ControlFlowTok{if}\NormalTok{(discard\_level1)}
            \FunctionTok{return}\NormalTok{()}
          \ControlFlowTok{if}\NormalTok{(mass\_process\_level\_1)}
\NormalTok{            df }\OtherTok{\textless{}{-}} \FunctionTok{mass\_process\_level\_1}\NormalTok{(df, ...)}
          \FunctionTok{return}\NormalTok{(df)}
          \DocumentationTok{\#\# process level 2}
\NormalTok{        \}}\ControlFlowTok{else}\NormalTok{\{}
          \ControlFlowTok{if}\NormalTok{(mass\_process\_level\_2)}
\NormalTok{            df }\OtherTok{\textless{}{-}} \FunctionTok{mass\_process\_level\_2}\NormalTok{(df, ...)}
          \FunctionTok{return}\NormalTok{(df)}
\NormalTok{        \}}
\NormalTok{      \}, }\AttributeTok{cl =}\NormalTok{ cl, ...)}
    \DocumentationTok{\#\# filter the empty spectrum}
    \ControlFlowTok{if}\NormalTok{(filter\_empty)\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(list, is.null, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{USE.NAMES =}\NormalTok{ F)]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}

\NormalTok{discard\_level1 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(list) \{}
    \FunctionTok{spectrum\_add\_noise}\NormalTok{(}
      \AttributeTok{list =}\NormalTok{ list, }\AttributeTok{mass\_process\_level\_2 =}\NormalTok{ F, }\AttributeTok{discard\_level1 =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{  \}}

\NormalTok{mass\_process\_level\_1 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, ...)\{\}}

\NormalTok{mass\_process\_level\_2 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{mass\_shift =}\NormalTok{ T, ...)\{}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{separate\_peak\_info}\NormalTok{(df, ...)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{mass\_shift)}
      \FunctionTok{return}\NormalTok{(list)}
\NormalTok{    list[[}\DecValTok{2}\NormalTok{]] }\OtherTok{\textless{}{-}} \FunctionTok{mass\_shift}\NormalTok{(list[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{merge =}\NormalTok{ T, ...)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(list) }\SpecialCharTok{==} \DecValTok{2}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{rbindlist}\NormalTok{(list)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}

\NormalTok{separate\_peak\_info }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\AttributeTok{only\_peak\_info =}\NormalTok{ F, ...)}
\NormalTok{  \{}
\NormalTok{    peak\_row }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}[0{-}9]"}\NormalTok{, df}\SpecialCharTok{$}\NormalTok{V1)}
\NormalTok{    peak\_info }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(df, peak\_row)}
\NormalTok{    peak\_info }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{separate}\NormalTok{(peak\_info, }\AttributeTok{col =} \StringTok{"V1"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{"mass"}\NormalTok{, }\StringTok{"inte"}\NormalTok{), }\AttributeTok{sep =}\NormalTok{ sep)}
    \ControlFlowTok{if}\NormalTok{(only\_peak\_info }\SpecialCharTok{==}\NormalTok{ T)}
      \FunctionTok{return}\NormalTok{(peak\_info)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(df, }\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{min}\NormalTok{(peak\_row) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)),}
\NormalTok{      peak\_info,}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(df, (}\FunctionTok{max}\NormalTok{(peak\_row) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df))}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# other}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{mgf\_add\_anno.gnps }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{    slice\_line }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\StringTok{"1:3"}\NormalTok{, }\StringTok{"4:6"}\NormalTok{, }\StringTok{"7:nrow(df)"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(slice\_line, }\ControlFlowTok{function}\NormalTok{(lines)\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(df, }\FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ lines)))}
      \FunctionTok{return}\NormalTok{(list)}
\NormalTok{    \})}
    \DocumentationTok{\#\# scans}
\NormalTok{    scans }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]][}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{], }\StringTok{"[0{-}9]\{1,\}$"}\NormalTok{)}
\NormalTok{    scans }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"SCANS="}\NormalTok{, scans))}
    \DocumentationTok{\#\# merge}
\NormalTok{    merge }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}
      \AttributeTok{V1 =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"MERGED\_STATS=1 / 1 "}\NormalTok{,}
        \StringTok{"(0 removed due to low quality, 0 removed due to low cosine)"}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], scans, list[[}\DecValTok{2}\NormalTok{]], merge, list[[}\DecValTok{3}\NormalTok{]])}
\NormalTok{  \}}

\NormalTok{simulate\_gnps\_quant }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           meta,}
\NormalTok{           save\_path,}
           \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(save\_path, }\StringTok{"/"}\NormalTok{, }\StringTok{"quant.csv"}\NormalTok{),}
           \AttributeTok{rt =} \DecValTok{1000}\NormalTok{,}
           \AttributeTok{area =} \DecValTok{10000}\NormalTok{,}
           \AttributeTok{id =} \StringTok{".id"}\NormalTok{,}
           \AttributeTok{mz =} \StringTok{"PRECURSORMZ"}\NormalTok{,}
           \AttributeTok{simu\_id =} \StringTok{"row ID"}\NormalTok{,}
           \AttributeTok{simu\_mz =} \StringTok{"row m/z"}\NormalTok{,}
           \AttributeTok{simu\_rt =} \StringTok{"row retention time"}\NormalTok{,}
           \AttributeTok{simu\_quant =} \StringTok{"sample.mzML Peak area"}\NormalTok{,}
           \AttributeTok{return\_df =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(meta, }\FunctionTok{all\_of}\NormalTok{(}\FunctionTok{c}\NormalTok{(id, mz)))}
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta, }\AttributeTok{rt =}\NormalTok{ rt, }\AttributeTok{sample =}\NormalTok{ area)}
    \FunctionTok{colnames}\NormalTok{(meta) }\OtherTok{\textless{}{-}} 
      \FunctionTok{mapply\_rename\_col}\NormalTok{(}
        \FunctionTok{.find\_and\_sort\_strings}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(meta), }\FunctionTok{c}\NormalTok{(id, mz, }\StringTok{"rt"}\NormalTok{, }\StringTok{"sample"}\NormalTok{)),}
        \FunctionTok{c}\NormalTok{(simu\_id, simu\_mz, simu\_rt, simu\_quant),}
        \FunctionTok{colnames}\NormalTok{(meta)}
\NormalTok{      )}
    \ControlFlowTok{if}\NormalTok{(return\_df)}
      \FunctionTok{return}\NormalTok{(meta)}
    \FunctionTok{write.table}\NormalTok{(meta, }\AttributeTok{file =}\NormalTok{ file, }\AttributeTok{sep =} \StringTok{","}\NormalTok{, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# evaluate}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{stat\_classify }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(id\_set, resClass, id2Key, mcn, ref)}
\NormalTok{  \{}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{get\_parent\_classes}\NormalTok{(resClass, mcn)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"stat:"}\NormalTok{, resClass, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}
\NormalTok{      id\_set,}
      \ControlFlowTok{function}\NormalTok{(id) \{}
\NormalTok{        class }\OtherTok{\textless{}{-}}\NormalTok{ ref[[ id2Key[[ id ]] ]]}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(class)) \{}
\NormalTok{          stat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =} \ConstantTok{NA}\NormalTok{)}
          \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{        \}}
        \ControlFlowTok{if}\NormalTok{ (resClass }\SpecialCharTok{\%in\%}\NormalTok{ class[[}\StringTok{"Classification"}\NormalTok{]])\{}
\NormalTok{          stat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =} \StringTok{"true"}\NormalTok{)}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
          \ControlFlowTok{if}\NormalTok{ (class[}\DecValTok{3}\NormalTok{,]}\SpecialCharTok{$}\NormalTok{Classification }\SpecialCharTok{\%in\%}\NormalTok{ set)\{}
            \DocumentationTok{\#\# at least the cluster is T in "class" level}
\NormalTok{            evaluate }\OtherTok{\textless{}{-}} \StringTok{"latent"}
\NormalTok{          \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{            evaluate }\OtherTok{\textless{}{-}} \StringTok{"false"}
\NormalTok{          \}}
\NormalTok{          stat }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{id =}\NormalTok{ id, }\AttributeTok{evaluate =}\NormalTok{ evaluate)}
\NormalTok{        \}}
        \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{      \}}
\NormalTok{    )}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}

\NormalTok{table\_app }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, }\AttributeTok{col =} \StringTok{"evaluate"}\NormalTok{, }\AttributeTok{prop =}\NormalTok{ T)\{}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.data.frame}\NormalTok{(df))}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    stat }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(df[[col]])}
    \ControlFlowTok{if}\NormalTok{ (prop) \{}
\NormalTok{      sum }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(stat)}
\NormalTok{      stat }\OtherTok{\textless{}{-}} \FunctionTok{prop.table}\NormalTok{(stat)}
\NormalTok{    \}}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(stat)}
\NormalTok{    stat}\SpecialCharTok{$}\NormalTok{sum }\OtherTok{\textless{}{-}}\NormalTok{ sum}
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}

\NormalTok{stat\_identification }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(id\_lst, id\_key2d, ref)}
\NormalTok{  \{}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_lst, merge, }\AttributeTok{y =}\NormalTok{ id\_key2d, }\AttributeTok{by =} \StringTok{".features\_id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, merge, }\AttributeTok{y =}\NormalTok{ ref, }\AttributeTok{by =} \StringTok{".features\_id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    id\_stat }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
      \AttributeTok{evaluate =} \FunctionTok{ifelse}\NormalTok{(inchikey2d.x }\SpecialCharTok{==}\NormalTok{ inchikey2d.y, }\StringTok{"true"}\NormalTok{, }\StringTok{"false"}\NormalTok{))}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(id\_stat, table\_app)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst, }\AttributeTok{idcol =}\NormalTok{ T, }\AttributeTok{fill =}\NormalTok{ T)}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(df, }\AttributeTok{class.name =}\NormalTok{ .id)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# visualize the results of evaluation}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{visualize\_stat }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df, mcn,}
           \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
           \AttributeTok{group\_palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{),}
           \AttributeTok{ylab =} \StringTok{"ratio"}\NormalTok{,}
           \AttributeTok{xlab =} \StringTok{"classes"}\NormalTok{,}
           \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
           \AttributeTok{col\_max =} \DecValTok{500}\NormalTok{,}
           \AttributeTok{weight =} \FunctionTok{c}\NormalTok{(}\AttributeTok{pl =} \DecValTok{1}\NormalTok{, }\AttributeTok{pm =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{pr =} \DecValTok{1}\NormalTok{)}
\NormalTok{           )}
\NormalTok{  \{}
\NormalTok{    parent\_class }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}
      \FunctionTok{lapply}\NormalTok{(}\FunctionTok{get\_parent\_classes}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class.name, mcn),}
        \ControlFlowTok{function}\NormalTok{(vec) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(vec) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\ConstantTok{NA} \ControlFlowTok{else} \FunctionTok{tail}\NormalTok{(vec, }\AttributeTok{n =} \DecValTok{1}\NormalTok{)),}
      \AttributeTok{use.names =}\NormalTok{ F}
\NormalTok{    )}
\NormalTok{    df.back }\OtherTok{\textless{}{-}}\NormalTok{ df}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      df, }\AttributeTok{parent\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(parent\_class), class.name, }\SpecialCharTok{!!}\NormalTok{parent\_class)}
\NormalTok{    )}
\NormalTok{    annotation }\OtherTok{\textless{}{-}}\NormalTok{ df}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(df, }\StringTok{"type"}\NormalTok{, }\StringTok{"value"}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{class.name, }\SpecialCharTok{{-}}\NormalTok{parent\_class, }\SpecialCharTok{{-}}\NormalTok{sum)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      df, }\AttributeTok{class.name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(class.name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
      \AttributeTok{parent\_class =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
      \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
      \AttributeTok{type =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type)}
\NormalTok{    )}
\NormalTok{    pm }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{fill =}\NormalTok{ type)) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{width =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{position =} \StringTok{"stack"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
        \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
        \AttributeTok{fill =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)}
\NormalTok{        ) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{()}
\NormalTok{    pm.theme }\OtherTok{\textless{}{-}}\NormalTok{ pm.theme2 }\OtherTok{\textless{}{-}} \FunctionTok{theme}\NormalTok{(}
      \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
      \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    pm.theme}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"none"}
\NormalTok{    pm.theme2}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"bottom"}
\NormalTok{    pm.legend }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.get\_legend}\NormalTok{(pm }\SpecialCharTok{+}\NormalTok{ pm.theme2)}
\NormalTok{    pm }\OtherTok{\textless{}{-}}\NormalTok{ pm }\SpecialCharTok{+}\NormalTok{ pm.theme}
\NormalTok{    pr }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df.back) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name,}
          \AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(sum }\SpecialCharTok{\textgreater{}=}\NormalTok{ col\_max, col\_max, sum)),}
        \AttributeTok{width =} \FloatTok{0.7}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#709AE1FF"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.7}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, col\_max) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"Classified number"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{geom\_blank}\NormalTok{()}
\NormalTok{    pl }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(annotation) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(class.name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{), }\AttributeTok{y =} \DecValTok{1}\NormalTok{,}
          \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)),}
        \AttributeTok{width =}\NormalTok{ .}\DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"Super Classes"}\NormalTok{, }\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"Classes"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}
        \AttributeTok{values =} \FunctionTok{colorRampPalette}\NormalTok{(group\_palette)(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(annotation}\SpecialCharTok{$}\NormalTok{parent\_class)))}
\NormalTok{        ) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
        \AttributeTok{axis.ticks.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{()}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{namel}\NormalTok{(pl, pm, pr), as\_grob)}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(weight, lst)}
    \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{lst =} \DecValTok{10}\NormalTok{, }\AttributeTok{pm.legend =}\NormalTok{ .}\DecValTok{5}\NormalTok{), }\FunctionTok{namel}\NormalTok{(lst, pm.legend))}
\NormalTok{  \}}

\NormalTok{visualize\_statComplex }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    df\_list,}
\NormalTok{    mcn,}
    \AttributeTok{weight =} \FunctionTok{c}\NormalTok{(}\AttributeTok{pl =} \DecValTok{1}\NormalTok{, }\AttributeTok{pm =} \DecValTok{1}\NormalTok{, }\AttributeTok{pr =} \DecValTok{1}\NormalTok{),}
    \AttributeTok{ylab =} \StringTok{"ratio"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"classes"}\NormalTok{,}
    \AttributeTok{fill\_lab =} \StringTok{"type"}\NormalTok{,}
    \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
    \AttributeTok{mutate\_palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"true"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{3}\NormalTok{], }\StringTok{"latent"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{2}\NormalTok{], }\StringTok{"false"} \OtherTok{=}\NormalTok{ palette[}\DecValTok{1}\NormalTok{],}
      \StringTok{"medium\_noise"} \OtherTok{=} \StringTok{"\#FED439FF"}\NormalTok{, }\StringTok{"high\_noise"} \OtherTok{=} \StringTok{"\#8A4198FF"}\NormalTok{),}
    \AttributeTok{extra\_palette =} \FunctionTok{c}\NormalTok{(}\StringTok{"sum"} \OtherTok{=} \StringTok{"\#95CC5EFF"}\NormalTok{,}
      \StringTok{"medium\_noise"} \OtherTok{=} \StringTok{"\#FED439FF"}\NormalTok{, }\StringTok{"high\_noise"} \OtherTok{=} \StringTok{"\#8A4198FF"}\NormalTok{),}
    \AttributeTok{group\_palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_rickandmorty}\NormalTok{()(}\DecValTok{12}\NormalTok{),}
    \AttributeTok{y\_cut\_left =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\DecValTok{450}\NormalTok{),}
    \AttributeTok{y\_cut\_right =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{y\_cut\_left\_breaks =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{, }\FunctionTok{seq}\NormalTok{(}\DecValTok{100}\NormalTok{, }\DecValTok{450}\NormalTok{, }\AttributeTok{by =} \DecValTok{100}\NormalTok{)),}
    \AttributeTok{y\_cut\_right\_breaks =} \ConstantTok{NULL}
\NormalTok{  )}
\NormalTok{  \{}
    \DocumentationTok{\#\# get parent class}
\NormalTok{    df\_list.back }\OtherTok{\textless{}{-}}\NormalTok{ df\_list}
\NormalTok{    df\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(df\_list,}
      \ControlFlowTok{function}\NormalTok{(df)\{}
\NormalTok{        parent\_class }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(}
          \FunctionTok{lapply}\NormalTok{(}\FunctionTok{get\_parent\_classes}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{class.name, mcn),}
            \ControlFlowTok{function}\NormalTok{(vec) }\ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(vec) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{) }\ConstantTok{NA} \ControlFlowTok{else} \FunctionTok{tail}\NormalTok{(vec, }\AttributeTok{n =} \DecValTok{1}\NormalTok{)),}
          \AttributeTok{use.names =}\NormalTok{ F}
\NormalTok{        )}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{          df, }\AttributeTok{parent\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(parent\_class), class.name, }\SpecialCharTok{!!}\NormalTok{parent\_class),}
          \AttributeTok{st.true =} \DecValTok{0}\NormalTok{, }\AttributeTok{en.true =}\NormalTok{ true,}
          \AttributeTok{st.latent =}\NormalTok{ en.true, }\AttributeTok{en.latent =}\NormalTok{ st.latent }\SpecialCharTok{+}\NormalTok{ latent,}
          \AttributeTok{st.false =}\NormalTok{ en.latent, }\AttributeTok{en.false =}\NormalTok{ st.false }\SpecialCharTok{+}\NormalTok{ false}
\NormalTok{        )}
\NormalTok{      \})}
    \DocumentationTok{\#\# group draw}
\NormalTok{    annotation }\OtherTok{\textless{}{-}}\NormalTok{ df\_list[[}\StringTok{"origin"}\NormalTok{]]}
\NormalTok{    pl }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(annotation) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(class.name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{), }\AttributeTok{y =} \DecValTok{1}\NormalTok{,}
          \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(parent\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)),}
        \AttributeTok{width =}\NormalTok{ .}\DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"Super classes"}\NormalTok{, }\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"Classes"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}
        \AttributeTok{values =} \FunctionTok{colorRampPalette}\NormalTok{(group\_palette)(}\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(annotation}\SpecialCharTok{$}\NormalTok{parent\_class)))}
\NormalTok{        ) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{face =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font),}
        \AttributeTok{axis.text.x =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{color =} \StringTok{"transparent"}\NormalTok{),}
        \AttributeTok{axis.ticks.x =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
        \AttributeTok{legend.position =} \StringTok{"left"}\NormalTok{,}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{()) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{()}
    \DocumentationTok{\#\# initial stat}
\NormalTok{    mutate\_origin }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(}
\NormalTok{      df\_list[[ }\StringTok{"origin"}\NormalTok{ ]], }\StringTok{"type"}\NormalTok{, }\StringTok{"value"}\NormalTok{, true, false, latent}
\NormalTok{    )}
\NormalTok{    mutate\_origin }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      mutate\_origin,}
      \AttributeTok{y =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(mutate\_origin, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v) v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"st."}\NormalTok{, v[[}\StringTok{"type"}\NormalTok{]])]] )),}
      \AttributeTok{yend =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(mutate\_origin, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v) v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"type"}\NormalTok{]])]] ))}
\NormalTok{    )}
    \DocumentationTok{\#\# medium noise dirft}
\NormalTok{    mergeMutate }\OtherTok{\textless{}{-}}
      \ControlFlowTok{function}\NormalTok{(v1, v2, df\_list)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df\_list[[v1]], df\_list[[v2]], }\AttributeTok{by =} \StringTok{"class.name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{flow1 =} \StringTok{"true"}\NormalTok{, }\AttributeTok{flow2 =} \StringTok{"latent"}\NormalTok{)}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(df, }\StringTok{"type"}\NormalTok{, }\StringTok{"value"}\NormalTok{, flow1, flow2)}
        \DocumentationTok{\#\# calculate segment from y to yend}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{          df, }\AttributeTok{y =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v) v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"value"}\NormalTok{]], }\StringTok{".x"}\NormalTok{)]] )),}
          \AttributeTok{yend =} \FunctionTok{as.numeric}\NormalTok{(}\FunctionTok{apply}\NormalTok{(df, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(v) v[[}\FunctionTok{paste0}\NormalTok{(}\StringTok{"en."}\NormalTok{, v[[}\StringTok{"value"}\NormalTok{]], }\StringTok{".y"}\NormalTok{)]] )),}
          \AttributeTok{exclude =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), T, F), }\AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), }\DecValTok{0}\NormalTok{, y),}
          \AttributeTok{yend =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(yend), }\DecValTok{1}\NormalTok{, yend)}
\NormalTok{        )}
\NormalTok{      \}}
\NormalTok{    medium\_noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mergeMutate}\NormalTok{(}\StringTok{"origin"}\NormalTok{, }\StringTok{"medium\_noise"}\NormalTok{, df\_list)}
\NormalTok{    medium\_noise\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{      medium\_noise\_df, y }\SpecialCharTok{!=}\NormalTok{ yend, }\SpecialCharTok{!}\NormalTok{exclude, class.name }\SpecialCharTok{\%in\%}\NormalTok{ mutate\_origin}\SpecialCharTok{$}\NormalTok{class.name}
\NormalTok{    )}
    \DocumentationTok{\#\# high noise drift}
\NormalTok{    high\_noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{mergeMutate}\NormalTok{(}\StringTok{"medium\_noise"}\NormalTok{, }\StringTok{"high\_noise"}\NormalTok{, df\_list)}
\NormalTok{    high\_noise\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{      high\_noise\_df, y }\SpecialCharTok{!=}\NormalTok{ yend, }\SpecialCharTok{!}\NormalTok{exclude, class.name }\SpecialCharTok{\%in\%}\NormalTok{ mutate\_origin}\SpecialCharTok{$}\NormalTok{class.name}
\NormalTok{    )}
\NormalTok{    pm }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
      \DocumentationTok{\#\# origin}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ mutate\_origin,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend, }\AttributeTok{color =}\NormalTok{ type),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# medium noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ medium\_noise\_df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend, }\AttributeTok{color =} \StringTok{"medium\_noise"}\NormalTok{),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# high noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ high\_noise\_df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{yend =}\NormalTok{ yend, }\AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# the point indicate the start of noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ medium\_noise\_df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(yend }\SpecialCharTok{\textgreater{}}\NormalTok{ y, y }\SpecialCharTok{{-}} \FloatTok{0.001}\NormalTok{, y }\SpecialCharTok{+} \FloatTok{0.001}\NormalTok{),}
          \AttributeTok{yend =}\NormalTok{ y, }\AttributeTok{color =} \StringTok{"medium\_noise"}\NormalTok{),}
        \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\DecValTok{10}\NormalTok{, }\StringTok{"pt"}\NormalTok{)), }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{lineend =} \StringTok{"round"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# the point indicate the start of high noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ high\_noise\_df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =} \FunctionTok{ifelse}\NormalTok{(yend }\SpecialCharTok{\textgreater{}}\NormalTok{ y, y }\SpecialCharTok{{-}} \FloatTok{0.001}\NormalTok{, y }\SpecialCharTok{+} \FloatTok{0.001}\NormalTok{),}
          \AttributeTok{yend =}\NormalTok{ y, }\AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
        \AttributeTok{arrow =} \FunctionTok{arrow}\NormalTok{(}\AttributeTok{length =} \FunctionTok{unit}\NormalTok{(}\DecValTok{10}\NormalTok{, }\StringTok{"pt"}\NormalTok{)), }\AttributeTok{size =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{lineend =} \StringTok{"round"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}
        \AttributeTok{values =}\NormalTok{ mutate\_palette,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\AttributeTok{sum =} \StringTok{"Sum"}\NormalTok{,}
          \AttributeTok{true =} \StringTok{"True"}\NormalTok{,}
          \AttributeTok{false =} \StringTok{"False"}\NormalTok{,}
          \AttributeTok{latent =} \StringTok{"Latent"}\NormalTok{,}
          \AttributeTok{medium\_noise =} \StringTok{"Medium noise"}\NormalTok{,}
          \AttributeTok{high\_noise =} \StringTok{"High noise"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}
        \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
        \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
        \AttributeTok{color =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(fill\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{()}
\NormalTok{    pm.theme }\OtherTok{\textless{}{-}} \FunctionTok{theme}\NormalTok{(}
      \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
      \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
      \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    pm.legend }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.get\_legend}\NormalTok{(pm }\SpecialCharTok{+}\NormalTok{ pm.theme)}
\NormalTok{    pm.theme}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"none"}
\NormalTok{    pm }\OtherTok{\textless{}{-}}\NormalTok{ pm }\SpecialCharTok{+}\NormalTok{ pm.theme}
\NormalTok{    extra\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(df\_list.back, dplyr}\SpecialCharTok{::}\NormalTok{select, class.name, sum)}
\NormalTok{    extra.noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(}
\NormalTok{      extra\_list[[ }\StringTok{"medium\_noise"}\NormalTok{ ]], extra\_list[[ }\StringTok{"high\_noise"}\NormalTok{ ]],}
      \AttributeTok{by =} \StringTok{"class.name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{    extra.noise\_df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(}
\NormalTok{      extra.noise\_df, extra\_list[[ }\StringTok{"origin"}\NormalTok{ ]], }\AttributeTok{by =} \StringTok{"class.name"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{    pr }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
      \DocumentationTok{\#\# origin sum}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ extra\_list[[}\StringTok{"origin"}\NormalTok{]],}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{yend =}\NormalTok{ sum, }\AttributeTok{color =} \StringTok{"sum"}\NormalTok{),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# medium\_noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(extra.noise\_df, }\AttributeTok{sum.x =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.x), }\DecValTok{0}\NormalTok{, sum.x)),}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ sum, }\AttributeTok{yend =}\NormalTok{ sum.x, }\AttributeTok{color =} \StringTok{"medium\_noise"}\NormalTok{),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# high\_noise drift}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(extra.noise\_df, }\FunctionTok{is.na}\NormalTok{(sum.x) }\SpecialCharTok{==}\NormalTok{ F),}
          \AttributeTok{sum.x =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.y), }\DecValTok{0}\NormalTok{, sum.x),}
          \AttributeTok{sum.y =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum.y), sum.x, sum.y)),}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ sum.x, }\AttributeTok{yend =}\NormalTok{ sum.y, }\AttributeTok{color =} \StringTok{"high\_noise"}\NormalTok{),}
        \AttributeTok{size =} \DecValTok{7}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}
        \AttributeTok{values =}\NormalTok{ extra\_palette,}
        \AttributeTok{labels =} \FunctionTok{c}\NormalTok{(}\AttributeTok{sum =} \StringTok{"Sum"}\NormalTok{, }\AttributeTok{medium\_noise =} \StringTok{"Medium noise"}\NormalTok{, }\AttributeTok{high\_noise =} \StringTok{"High noise"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{geom\_blank}\NormalTok{()}
\NormalTok{    pr.lab }\OtherTok{\textless{}{-}}\NormalTok{ pr.lab1 }\OtherTok{\textless{}{-}}\NormalTok{ pr.lab2 }\OtherTok{\textless{}{-}} \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{y =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{color =} \StringTok{"Type"}\NormalTok{)}
\NormalTok{    pr.lab1}\SpecialCharTok{$}\NormalTok{y }\OtherTok{\textless{}{-}} \StringTok{"Classified number"}
\NormalTok{    pr.lab2}\SpecialCharTok{$}\NormalTok{y }\OtherTok{\textless{}{-}} \StringTok{"..."}
\NormalTok{    pr.theme }\OtherTok{\textless{}{-}} \FunctionTok{theme}\NormalTok{(}
      \AttributeTok{axis.text.y =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
      \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    pr.legend }\OtherTok{\textless{}{-}}\NormalTok{ MCnebula2}\SpecialCharTok{:::}\FunctionTok{.get\_legend}\NormalTok{(pr }\SpecialCharTok{+}\NormalTok{ pr.theme }\SpecialCharTok{+}\NormalTok{ pr.lab)}
\NormalTok{    pr.theme}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"none"}
\NormalTok{    pr }\OtherTok{\textless{}{-}}\NormalTok{ pr }\SpecialCharTok{+}\NormalTok{ pr.theme}
\NormalTok{    pr1 }\OtherTok{\textless{}{-}}\NormalTok{ pr }\SpecialCharTok{+}\NormalTok{ pr.lab1 }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =}\NormalTok{ y\_cut\_left) }\SpecialCharTok{+}
      \FunctionTok{geom\_hline}\NormalTok{(}\AttributeTok{yintercept =} \FunctionTok{c}\NormalTok{(}\DecValTok{50}\NormalTok{), }\AttributeTok{linetype =} \StringTok{"dashed"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.7}\NormalTok{,}
        \AttributeTok{color =} \StringTok{"grey"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ y\_cut\_left\_breaks)}
\NormalTok{    pr1 }\OtherTok{\textless{}{-}} \FunctionTok{as\_grob}\NormalTok{(pr1)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(y\_cut\_right)) \{}
\NormalTok{      pr2 }\OtherTok{\textless{}{-}} \FunctionTok{nullGrob}\NormalTok{()}
\NormalTok{      pr.w }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{pr1 =} \DecValTok{2}\NormalTok{, }\AttributeTok{pr.legend =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      pr2 }\OtherTok{\textless{}{-}}\NormalTok{ pr }\SpecialCharTok{+}\NormalTok{ pr.lab2 }\SpecialCharTok{+}
        \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =}\NormalTok{ y\_cut\_right) }\SpecialCharTok{+}
        \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =}\NormalTok{ y\_cut\_right\_breaks)}
\NormalTok{      pr2 }\OtherTok{\textless{}{-}} \FunctionTok{as\_grob}\NormalTok{(pr2)}
\NormalTok{      pr.w }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\AttributeTok{pr1 =} \DecValTok{2}\NormalTok{, }\AttributeTok{pr2 =} \DecValTok{1}\NormalTok{, }\AttributeTok{pr.legend =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    pr }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(pr.w, }\FunctionTok{namel}\NormalTok{(pr1, pr2, pr.legend))}
    \DocumentationTok{\#\# gather all}
\NormalTok{    pl }\OtherTok{\textless{}{-}} \FunctionTok{as\_grob}\NormalTok{(pl)}
\NormalTok{    pm }\OtherTok{\textless{}{-}} \FunctionTok{as\_grob}\NormalTok{(pm)}
\NormalTok{    lst }\OtherTok{\textless{}{-}} \FunctionTok{frame\_col}\NormalTok{(weight, }\FunctionTok{namel}\NormalTok{(pl, pm, pr))}
    \FunctionTok{frame\_row}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\AttributeTok{lst =} \DecValTok{10}\NormalTok{, }\AttributeTok{pm.legend =}\NormalTok{ .}\DecValTok{5}\NormalTok{), }\FunctionTok{namel}\NormalTok{(lst, pm.legend))}
\NormalTok{  \}}

\NormalTok{visualize\_comparison }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    list1,}
\NormalTok{    list2,}
    \AttributeTok{ylim\_min =} \DecValTok{50}\NormalTok{,}
    \AttributeTok{from =} \FunctionTok{c}\NormalTok{(}\StringTok{"MCnebula2"}\NormalTok{, }\StringTok{"GNPS"}\NormalTok{),}
    \AttributeTok{ylab =} \StringTok{"Classified number (TP + FP)"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Classes"}\NormalTok{,}
    \AttributeTok{color\_lab =} \StringTok{"Methods"}\NormalTok{,}
    \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_npg}\NormalTok{()(}\DecValTok{9}\NormalTok{)}
\NormalTok{    )}
\NormalTok{  \{}
    \DocumentationTok{\#\# select in common classification}
\NormalTok{    common.class }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{merge}\NormalTok{(list1[[}\DecValTok{1}\NormalTok{]], list2[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{by =} \StringTok{"class.name"}\NormalTok{), }\DecValTok{1}\NormalTok{)}
    \DocumentationTok{\#\# filter classification}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(list1, list2)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, }\ControlFlowTok{function}\NormalTok{(lst)\{}
\NormalTok{      lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, dplyr}\SpecialCharTok{::}\NormalTok{select, class.name, sum)}
\NormalTok{      lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, merge, }\AttributeTok{y =}\NormalTok{ common.class, }\AttributeTok{by =} \StringTok{"class.name"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T)}
\NormalTok{      lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst, dplyr}\SpecialCharTok{::}\NormalTok{mutate, }\AttributeTok{sum =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sum), }\DecValTok{0}\NormalTok{, sum))}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(lst, }\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(df, }\AttributeTok{group =}\NormalTok{ .id)}
\NormalTok{    \})}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(list, from, }\AttributeTok{SIMPLIFY =}\NormalTok{ F,}
      \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(df, VALUE) \{}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{from =} \SpecialCharTok{!!}\NormalTok{VALUE)}
\NormalTok{      \})}
    \DocumentationTok{\#\# for segment}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], list[[}\DecValTok{2}\NormalTok{]], }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"group"}\NormalTok{, }\StringTok{"class.name"}\NormalTok{))}
\NormalTok{    group\_levels }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\AttributeTok{origin =} \StringTok{"Origin"}\NormalTok{, }\AttributeTok{medium\_noise =} \StringTok{"Medium noise"}\NormalTok{,}
      \AttributeTok{high\_noise =} \StringTok{"High noise"}\NormalTok{)}
\NormalTok{    df}\SpecialCharTok{$}\NormalTok{group }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{group, }\ControlFlowTok{function}\NormalTok{(x) group\_levels[[ x ]], }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    \DocumentationTok{\#\# for point}
\NormalTok{    df2 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(list[[}\DecValTok{1}\NormalTok{]], list[[}\DecValTok{2}\NormalTok{]])}
\NormalTok{    df2}\SpecialCharTok{$}\NormalTok{group }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(df2}\SpecialCharTok{$}\NormalTok{group, }\ControlFlowTok{function}\NormalTok{(x) group\_levels[[ x ]], }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
    \DocumentationTok{\#\# plot figure}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{geom\_segment}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ sum.x, }\AttributeTok{yend =}\NormalTok{ sum.y),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}
        \AttributeTok{data =}\NormalTok{ df2,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ sum, }\AttributeTok{color =}\NormalTok{ from),}
        \AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{position =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{breaks =} \FunctionTok{c}\NormalTok{(ylim\_min, }\DecValTok{300}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{900}\NormalTok{, }\DecValTok{1200}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}
        \AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
        \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
        \AttributeTok{color =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(color\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(ylim\_min, }\FunctionTok{max}\NormalTok{(df2}\SpecialCharTok{$}\NormalTok{sum) }\SpecialCharTok{*} \FloatTok{1.1}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{factor}\NormalTok{(group, }\AttributeTok{levels =}\NormalTok{ group\_levels)) }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
        \AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{geom\_blank}\NormalTok{()}
\NormalTok{    grob }\OtherTok{\textless{}{-}} \FunctionTok{as\_grob}\NormalTok{(p)}
    \FunctionTok{attr}\NormalTok{(grob, }\StringTok{"data"}\NormalTok{) }\OtherTok{\textless{}{-}}\NormalTok{ list}
    \FunctionTok{return}\NormalTok{(grob)}
\NormalTok{  \}}

\NormalTok{visualize\_summary }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(summary)\{}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\FunctionTok{do.call}\NormalTok{(rbind, summary))}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_if}\NormalTok{(data, is.list, unlist)}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      data, }\AttributeTok{type =} \FunctionTok{form}\NormalTok{(}\FunctionTok{rownames}\NormalTok{(data)),}
      \AttributeTok{type =} \FunctionTok{factor}\NormalTok{(type, }\AttributeTok{levels =}\NormalTok{ type)}
\NormalTok{    )}
    \DocumentationTok{\#\# draw plot of classified number}
\NormalTok{    theme1 }\OtherTok{\textless{}{-}}\NormalTok{ theme2 }\OtherTok{\textless{}{-}} \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font))}
\NormalTok{    theme2}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"none"}
\NormalTok{    p.num }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\AttributeTok{type =} \FunctionTok{factor}\NormalTok{(type, }\AttributeTok{levels =} \FunctionTok{rev}\NormalTok{(type)))) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ type, }\AttributeTok{y =}\NormalTok{ sum, }\AttributeTok{fill =}\NormalTok{ type), }\AttributeTok{width =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{fill =} \StringTok{"\#709AE1FF"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ type, }\AttributeTok{y =}\NormalTok{ sum, }\AttributeTok{label =} \FunctionTok{round}\NormalTok{(sum)),}
        \AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{hjust =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }\AttributeTok{y =} \StringTok{"Sum"}\NormalTok{) }\SpecialCharTok{+} 
      \FunctionTok{coord\_flip}\NormalTok{(}\AttributeTok{ylim =} \FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{250}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{theme\_classic}\NormalTok{() }\SpecialCharTok{+}\NormalTok{ theme2}
\NormalTok{    theme3 }\OtherTok{\textless{}{-}}\NormalTok{ theme1}
\NormalTok{    theme3}\SpecialCharTok{$}\NormalTok{legend.position }\OtherTok{\textless{}{-}} \StringTok{"bottom"}
\NormalTok{    theme3}\SpecialCharTok{$}\NormalTok{panel.spacing }\OtherTok{\textless{}{-}} \FunctionTok{u}\NormalTok{(}\DecValTok{0}\NormalTok{, line)}
\NormalTok{    data.ratioFal }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(data, }\StringTok{\textasciigrave{}}\AttributeTok{non{-}false}\StringTok{\textasciigrave{}} \OtherTok{=} \DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ false)}
\NormalTok{    data.ratioFal }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{gather}\NormalTok{(data.ratioFal, evaluate, value, }\SpecialCharTok{{-}}\NormalTok{sum, }\SpecialCharTok{{-}}\NormalTok{type)}
\NormalTok{    data.ratioSt }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      data.ratioFal, }\AttributeTok{change =}\NormalTok{ (}\FunctionTok{max}\NormalTok{(sum) }\SpecialCharTok{{-}}\NormalTok{ sum ) }\SpecialCharTok{/} \FunctionTok{max}\NormalTok{(sum) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{,}
      \AttributeTok{evaluate =} \FunctionTok{ifelse}\NormalTok{(evaluate }\SpecialCharTok{==} \StringTok{"false"}\NormalTok{, }\StringTok{"lost"}\NormalTok{, }\StringTok{"non{-}lost"}\NormalTok{),}
      \AttributeTok{change =} \FunctionTok{ifelse}\NormalTok{(evaluate }\SpecialCharTok{==} \StringTok{"lost"}\NormalTok{, change, }\DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ change),}
      \AttributeTok{change =} \FunctionTok{round}\NormalTok{(change, }\DecValTok{1}\NormalTok{)}
\NormalTok{    )}
    \DocumentationTok{\#\# draw plot of stability}
\NormalTok{    data.ratioSt }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.ratioSt, type }\SpecialCharTok{!=} \StringTok{"Origin"}\NormalTok{)}
\NormalTok{    p.ratioSt }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data.ratioSt) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =}\NormalTok{ change, }\AttributeTok{fill =} \FunctionTok{form}\NormalTok{(evaluate))) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.ratioSt, evaluate }\SpecialCharTok{==} \StringTok{"non{-}lost"}\NormalTok{),}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(change, }\StringTok{"\%"}\NormalTok{)),}
        \AttributeTok{hjust =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{theta =} \StringTok{"y"}\NormalTok{, }\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{xlim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"grey95"}\NormalTok{, }\StringTok{"\#91D1C2"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ type, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_void}\NormalTok{()}
\NormalTok{    p.ratioSt }\OtherTok{\textless{}{-}} \FunctionTok{sep\_legend}\NormalTok{(p.ratioSt, theme3)}
    \DocumentationTok{\#\# draw precision (1 {-} relative false rate)}
\NormalTok{    lostRate }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.ratioSt, evaluate }\SpecialCharTok{==} \StringTok{"lost"}\NormalTok{)}\SpecialCharTok{$}\NormalTok{change) }\SpecialCharTok{/} \DecValTok{100}
\NormalTok{    data.ratioRelFal }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      data.ratioFal, }\AttributeTok{rel.value =} \FunctionTok{ifelse}\NormalTok{(evaluate }\SpecialCharTok{==} \StringTok{"false"}\NormalTok{,}
        \DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ (}\DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ value) }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ lostRate),}
\NormalTok{        value }\SpecialCharTok{*}\NormalTok{ (}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ lostRate)}
\NormalTok{        ),}
      \AttributeTok{prec.value =} \DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ rel.value}
\NormalTok{    )}
\NormalTok{    p.precision }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data.ratioRelFal) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =}\NormalTok{ prec.value, }\AttributeTok{fill =} \FunctionTok{form}\NormalTok{(evaluate))) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.ratioRelFal, evaluate }\SpecialCharTok{==} \StringTok{"false"}\NormalTok{),}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(prec.value, }\DecValTok{1}\NormalTok{), }\StringTok{"\%"}\NormalTok{)),}
        \AttributeTok{hjust =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{theta =} \StringTok{"y"}\NormalTok{, }\AttributeTok{direction =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{xlim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"\#FED439FF"}\NormalTok{, }\StringTok{"grey95"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ type, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_void}\NormalTok{()}
\NormalTok{    p.precision }\OtherTok{\textless{}{-}} \FunctionTok{sep\_legend}\NormalTok{(p.precision, theme3)}
    \DocumentationTok{\#\# precision = TP. = 1 {-} rel.value; FP. = rel.value; FN. = lostRate}
    \DocumentationTok{\#\# recall = TP / (TP + FN)}
\NormalTok{    data.recall }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.ratioRelFal, evaluate }\SpecialCharTok{==} \StringTok{"non{-}false"}\NormalTok{), }
      \AttributeTok{recall.value =}\NormalTok{ rel.value }\SpecialCharTok{*} \DecValTok{100} \SpecialCharTok{/}\NormalTok{ (rel.value }\SpecialCharTok{+}\NormalTok{ lostRate }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data) \{}
\NormalTok{      data2 }\OtherTok{\textless{}{-}}\NormalTok{ data}
\NormalTok{      data2}\SpecialCharTok{$}\NormalTok{evaluate }\OtherTok{\textless{}{-}} \StringTok{\textquotesingle{}false\textquotesingle{}}
\NormalTok{      data2}\SpecialCharTok{$}\NormalTok{recall.value }\OtherTok{\textless{}{-}} \DecValTok{100} \SpecialCharTok{{-}}\NormalTok{ data2}\SpecialCharTok{$}\NormalTok{recall.value}
      \FunctionTok{rbind}\NormalTok{(data, data2)}
\NormalTok{    \}}
\NormalTok{    tt }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ data.recall }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(data.recall)}
\NormalTok{    p.recall }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(data.recall) }\SpecialCharTok{+}
      \FunctionTok{geom\_col}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \DecValTok{0}\NormalTok{, }\AttributeTok{y =}\NormalTok{ recall.value, }\AttributeTok{fill =} \FunctionTok{form}\NormalTok{(evaluate))) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data.recall, evaluate }\SpecialCharTok{==} \StringTok{"non{-}false"}\NormalTok{),}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =} \SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, }\AttributeTok{y =} \DecValTok{0}\NormalTok{, }\AttributeTok{label =} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{round}\NormalTok{(recall.value, }\DecValTok{1}\NormalTok{), }\StringTok{"\%"}\NormalTok{)),}
        \AttributeTok{hjust =}\NormalTok{ .}\DecValTok{5}\NormalTok{, }\AttributeTok{family =}\NormalTok{ .font) }\SpecialCharTok{+}
      \FunctionTok{coord\_polar}\NormalTok{(}\AttributeTok{theta =} \StringTok{"y"}\NormalTok{, }\AttributeTok{direction =} \SpecialCharTok{{-}}\DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{xlim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\NormalTok{, .}\DecValTok{5}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{ylim}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{""}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(}\StringTok{"grey95"}\NormalTok{, }\StringTok{"\#D5E4A2FF"}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{ type, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_void}\NormalTok{()}
\NormalTok{    p.recall }\OtherTok{\textless{}{-}} \FunctionTok{sep\_legend}\NormalTok{(p.recall, theme3)}
    \FunctionTok{namel}\NormalTok{(p.num, p.ratioSt, p.precision, p.recall)}
\NormalTok{  \}}

\NormalTok{visualize\_idRes }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    list,}
    \AttributeTok{palette =}\NormalTok{ ggsci}\SpecialCharTok{::}\FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{9}\NormalTok{),}
    \AttributeTok{ylab =} \StringTok{"Ratio"}\NormalTok{,}
    \AttributeTok{xlab =} \StringTok{"Classes"}\NormalTok{,}
    \AttributeTok{color\_lab =} \StringTok{"type"}
\NormalTok{  )}
\NormalTok{  \{}
\NormalTok{    list.name }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(list)}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, tidyr}\SpecialCharTok{::}\NormalTok{gather,}
      \StringTok{"type"}\NormalTok{, }\StringTok{"value"}\NormalTok{, }\SpecialCharTok{{-}}\NormalTok{class.name}
\NormalTok{    )}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(list, dplyr}\SpecialCharTok{::}\NormalTok{mutate,}
      \AttributeTok{class.name =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(class.name, }\AttributeTok{width =} \DecValTok{25}\NormalTok{),}
      \AttributeTok{type =} \FunctionTok{as.character}\NormalTok{(type),}
      \AttributeTok{type =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(type))}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, type }\SpecialCharTok{==} \StringTok{"True"}\NormalTok{)}
\NormalTok{    line\_df }\OtherTok{\textless{}{-}}\NormalTok{ tidyr}\SpecialCharTok{::}\FunctionTok{spread}\NormalTok{(df, .id, value)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(}\AttributeTok{data =}\NormalTok{ df, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{y =}\NormalTok{ value, }\AttributeTok{color =}\NormalTok{ .id)) }\SpecialCharTok{+}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ line\_df,}
        \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class.name, }\AttributeTok{xend =}\NormalTok{ class.name,}
          \AttributeTok{y =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciigrave{}"}\NormalTok{, list.name[}\DecValTok{1}\NormalTok{], }\StringTok{"\textasciigrave{}"}\NormalTok{))),}
          \AttributeTok{yend =} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciigrave{}"}\NormalTok{, list.name[}\DecValTok{2}\NormalTok{], }\StringTok{"\textasciigrave{}"}\NormalTok{)))),}
        \AttributeTok{color =} \StringTok{"black"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{size =} \DecValTok{3}\NormalTok{, }\AttributeTok{position =} \StringTok{"identity"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{scale\_color\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{y =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(ylab),}
        \AttributeTok{x =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(xlab),}
        \AttributeTok{color =}\NormalTok{ Hmisc}\SpecialCharTok{::}\FunctionTok{capitalize}\NormalTok{(color\_lab)) }\SpecialCharTok{+}
      \FunctionTok{coord\_flip}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"bottom"}\NormalTok{,}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =}\NormalTok{ .font, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
        \AttributeTok{plot.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{hjust =} \FloatTok{0.3}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{geom\_blank}\NormalTok{()}
    \FunctionTok{as\_grob}\NormalTok{(p)}
\NormalTok{  \}}

\NormalTok{gtext90 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(label, fill, }\AttributeTok{rot =} \DecValTok{90}\NormalTok{) \{}
\NormalTok{  rect\_mcnebula }\OtherTok{\textless{}{-}} \FunctionTok{roundrectGrob}\NormalTok{(}\AttributeTok{gp =} \FunctionTok{gpar}\NormalTok{(}\AttributeTok{col =} \StringTok{"transparent"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ fill))}
\NormalTok{  gtext }\OtherTok{\textless{}{-}} \FunctionTok{gtext}\NormalTok{(label, }\FunctionTok{list}\NormalTok{(}\AttributeTok{cex =} \FloatTok{1.2}\NormalTok{, }\AttributeTok{col =} \StringTok{"white"}\NormalTok{), }\AttributeTok{rot =}\NormalTok{ rot)}
  \FunctionTok{ggather}\NormalTok{(rect\_mcnebula, gtext)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-stack_ms2.r}{%
\section{File: stack\_ms2.R}\label{file-stack_ms2.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stack\_ms2 }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           idset,}
           \AttributeTok{raw.color =} \StringTok{"black"}\NormalTok{,}
           \AttributeTok{sig.color =} \StringTok{"\#E6550DFF"}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{13} \SpecialCharTok{*} \FloatTok{1.5}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{10} \SpecialCharTok{*} \FloatTok{1.5}\NormalTok{,}
           \AttributeTok{struc.size.factor =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{struc.x =} \FloatTok{0.7}\NormalTok{,}
           \AttributeTok{struc.y =} \FloatTok{0.3}\NormalTok{,}
           \AttributeTok{filename =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\StringTok{"mcnebula\_results"}\NormalTok{),}
                             \FunctionTok{paste0}\NormalTok{(}\StringTok{"mcnebula\_results"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\StringTok{"mirror.ms2.svg"}\NormalTok{), }\StringTok{"mirror.ms2.svg"}\NormalTok{),}
           \AttributeTok{merge\_via\_int =}\NormalTok{ T}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{require}\NormalTok{(}\StringTok{"MCnebula"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"MCnebula not loaded}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}} \FunctionTok{method\_formula\_based\_spec\_compare}\NormalTok{(}
        \AttributeTok{target\_ids =}\NormalTok{ idset,}
        \AttributeTok{filter\_only\_max =} \ConstantTok{Inf}\NormalTok{,}
        \AttributeTok{get\_meta\_dir =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{ms.spec =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"spectra/[\^{}/]\{1,\}$"}\NormalTok{, }\StringTok{"spectrum.ms"}\NormalTok{, full.name))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    spec.list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(}
\NormalTok{       meta\_dir, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(vec) \{}
         \DocumentationTok{\#\# read sig spectra}
\NormalTok{         sig.spec }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(vec[[}\StringTok{"full.name"}\NormalTok{]])}
         \DocumentationTok{\#\# read raw spectra}
\NormalTok{         raw.spec }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(vec[[}\StringTok{"ms.spec"}\NormalTok{]])}
         \DocumentationTok{\#\# mz}
\NormalTok{         line.mz }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}\textgreater{}parentmass"}\NormalTok{, raw.spec)}
\NormalTok{         mz }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(raw.spec[line.mz], }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s)[0{-}9|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.]\{1,\}[ ]\{0,\}$"}\NormalTok{)}
\NormalTok{         mz }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(mz), }\DecValTok{4}\NormalTok{)}
         \DocumentationTok{\#\# rt}
\NormalTok{         line.rt }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}\textgreater{}rt"}\NormalTok{, raw.spec)}
\NormalTok{         rt }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(raw.spec[line.rt], }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s)[0{-}9|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.]\{1,\}(?=s)"}\NormalTok{)}
\NormalTok{         rt }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{as.numeric}\NormalTok{(rt) }\SpecialCharTok{/} \DecValTok{60}\NormalTok{, }\DecValTok{1}\NormalTok{)}
         \DocumentationTok{\#\# ms2 db}
\NormalTok{         line.ms2 }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}\textgreater{}ms2peaks"}\NormalTok{, raw.spec)}
\NormalTok{         ms2 }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(raw.spec[(line.ms2 }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(raw.spec))], }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{         ms2 }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(ms2)}
\NormalTok{         ms2 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(ms2, }\AttributeTok{mass =} \DecValTok{1}\NormalTok{, }\AttributeTok{int =} \DecValTok{2}\NormalTok{)}
\NormalTok{         ms2 }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ms2, }\AttributeTok{rel.int =}\NormalTok{ int }\SpecialCharTok{/} \FunctionTok{max}\NormalTok{(int) }\SpecialCharTok{*} \DecValTok{100}\NormalTok{)}
         \DocumentationTok{\#\# merge raw with assigned ms2}
\NormalTok{         ms2.merge }\OtherTok{\textless{}{-}} \FunctionTok{numeric\_round\_merge}\NormalTok{(ms2, sig.spec, }\AttributeTok{main\_col =} \StringTok{"mass"}\NormalTok{, }\AttributeTok{sub\_col =} \StringTok{"mz"}\NormalTok{)}
         \ControlFlowTok{if}\NormalTok{(merge\_via\_int)}
\NormalTok{           ms2.merge }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(ms2.merge, }\FunctionTok{abs}\NormalTok{(rel.int }\SpecialCharTok{{-}}\NormalTok{ rel.intensity) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{)}
\NormalTok{         ms2.merge }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(ms2.merge, ms2)}
\NormalTok{         ms2.merge }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(ms2.merge, mass, int, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
         \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\AttributeTok{mz =}\NormalTok{ mz, }\AttributeTok{rt =}\NormalTok{ rt, }\AttributeTok{ms2 =}\NormalTok{ ms2.merge))}
\NormalTok{       \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    ms2.set }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(spec.list, }\StringTok{\textasciigrave{}}\AttributeTok{[[}\StringTok{\textasciigrave{}}\NormalTok{, }\DecValTok{3}\NormalTok{)}
    \FunctionTok{names}\NormalTok{(ms2.set) }\OtherTok{\textless{}{-}}\NormalTok{ meta\_dir}\SpecialCharTok{$}\NormalTok{.id}
\NormalTok{    ms2.set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(ms2.set, }\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{    sig.ms2.set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(ms2.set, }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(mz))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    anno }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(spec.list,}
                   \ControlFlowTok{function}\NormalTok{(lst)\{}
\NormalTok{                     data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{precur.mz =}\NormalTok{ lst[[}\DecValTok{1}\NormalTok{]], }\AttributeTok{rt =}\NormalTok{ lst[[}\DecValTok{2}\NormalTok{]])}
\NormalTok{                   \}) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =}\NormalTok{ meta\_dir}\SpecialCharTok{$}\NormalTok{.id,}
                  \AttributeTok{anno.mz =} \FunctionTok{paste}\NormalTok{(}\StringTok{"Precursor m/z:"}\NormalTok{, precur.mz),}
                  \AttributeTok{anno.rt =} \FunctionTok{paste}\NormalTok{(}\StringTok{"RT (min):"}\NormalTok{, rt),}
                  \AttributeTok{anno =} \FunctionTok{paste0}\NormalTok{(anno.mz, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, anno.rt),}
                  \AttributeTok{anno.x =} \DecValTok{0}\NormalTok{, }\AttributeTok{anno.y =} \DecValTok{65}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# add tanimotoSimilarity}
\NormalTok{    anno }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(anno, .MCn.structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)],}
                  \AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{ts =} \FunctionTok{round}\NormalTok{(tanimotoSimilarity, }\DecValTok{2}\NormalTok{),}
                    \AttributeTok{anno.ts =} \FunctionTok{paste}\NormalTok{(}\StringTok{"TS:"}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(ts), }\StringTok{"{-}"}\NormalTok{, ts)),}
                    \AttributeTok{anno =} \FunctionTok{paste0}\NormalTok{(anno, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, anno.ts))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{() }\SpecialCharTok{+}
  \DocumentationTok{\#\# raw mass2 peak}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ms2.set,}
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mass,}
                       \AttributeTok{xend =}\NormalTok{ mass,}
                       \AttributeTok{y =} \DecValTok{0}\NormalTok{,}
                       \AttributeTok{yend =}\NormalTok{ rel.int),}
                   \AttributeTok{color =}\NormalTok{ raw.color,}
                   \AttributeTok{size =} \FloatTok{0.8}\NormalTok{,}
                   \AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# sig mass2 peak}
      \FunctionTok{geom\_segment}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sig.ms2.set,}
                   \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mz,}
                       \AttributeTok{xend =}\NormalTok{ mz,}
                       \AttributeTok{y =} \DecValTok{0}\NormalTok{,}
                       \AttributeTok{yend =} \SpecialCharTok{{-}}\NormalTok{rel.intensity),}
                   \AttributeTok{color =}\NormalTok{ sig.color,}
                   \AttributeTok{size =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# match in raw}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sig.ms2.set,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mass,}
                     \AttributeTok{y =}\NormalTok{ rel.int),}
                 \AttributeTok{size =} \FloatTok{0.8}\NormalTok{,}
                 \AttributeTok{color =}\NormalTok{ raw.color,}
                 \AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# match in sig}
      \FunctionTok{geom\_point}\NormalTok{(}\AttributeTok{data =}\NormalTok{ sig.ms2.set,}
                 \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ mz,}
                     \AttributeTok{y =} \SpecialCharTok{{-}}\NormalTok{rel.intensity),}
                 \AttributeTok{size =} \FloatTok{0.8}\NormalTok{,}
                 \AttributeTok{color =}\NormalTok{ sig.color) }\SpecialCharTok{+}
      \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ anno,}
                \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ anno.x,}
                    \AttributeTok{y =}\NormalTok{ anno.y,}
                    \AttributeTok{label =}\NormalTok{ anno),}
                \AttributeTok{hjust =} \DecValTok{0}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{family =} \StringTok{"Times"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# theme}
      \FunctionTok{scale\_y\_continuous}\NormalTok{(}\AttributeTok{limits =} \FunctionTok{c}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{100}\NormalTok{, }\DecValTok{100}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{12}\NormalTok{),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_line}\NormalTok{(}\AttributeTok{color =} \StringTok{"grey85"}\NormalTok{),}
            \AttributeTok{plot.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \DecValTok{0}\NormalTok{)}
\NormalTok{            ) }\SpecialCharTok{+}
      \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}} \FunctionTok{paste}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, .id), }\AttributeTok{scales =} \StringTok{"free"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# visualize structure}
\NormalTok{    struc.dir }\OtherTok{\textless{}{-}} \StringTok{"mcnebula\_results/tmp/structure"}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(struc.dir))\{}
\NormalTok{      struc.vis }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(struc.dir, }\StringTok{"/"}\NormalTok{, meta\_dir}\SpecialCharTok{$}\NormalTok{.id, }\StringTok{".svg"}\NormalTok{), file.exists)}
      \ControlFlowTok{if}\NormalTok{(T }\SpecialCharTok{\%in\%}\NormalTok{ check)\{}
\NormalTok{        struc.vis }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        struc.vis }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{    struc.set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.structure\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ meta\_dir}\SpecialCharTok{$}\NormalTok{.id)}
    \ControlFlowTok{if}\NormalTok{(struc.vis)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Draw structure via Molconvert and Openbabal}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{vis\_via\_molconvert}\NormalTok{(struc.set}\SpecialCharTok{$}\NormalTok{smiles, struc.set}\SpecialCharTok{$}\NormalTok{.id)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# draw page}
    \FunctionTok{svg}\NormalTok{(filename, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] BEGIN: current.viewport:"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\FunctionTok{current.viewport}\NormalTok{()), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# the main picture}
    \FunctionTok{print}\NormalTok{(p)}
    \DocumentationTok{\#\# structure mapping}
\NormalTok{    df.vp }\OtherTok{\textless{}{-}} \FunctionTok{get\_facet.wrap.vp}\NormalTok{(meta\_dir}\SpecialCharTok{$}\NormalTok{.id)}
    \FunctionTok{apply}\NormalTok{(df.vp, }\DecValTok{1}\NormalTok{, }\ControlFlowTok{function}\NormalTok{(vec)\{}
\NormalTok{            struc.path }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(struc.dir, }\StringTok{"/"}\NormalTok{, vec[[}\StringTok{"strip"}\NormalTok{]], }\StringTok{".svg"}\NormalTok{)}
            \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(struc.path))\{}
              \DocumentationTok{\#\# read structure}
\NormalTok{              svg }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(struc.path)}
              \DocumentationTok{\#\# estimate size of chem.}
\NormalTok{              lwd }\OtherTok{\textless{}{-}}\NormalTok{ svg[[}\DecValTok{1}\NormalTok{]][[}\DecValTok{1}\NormalTok{]]}\SpecialCharTok{@}\NormalTok{gp}\SpecialCharTok{$}\NormalTok{lwd}
              \DocumentationTok{\#\# to according viewport}
              \FunctionTok{downViewport}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(vec[[}\StringTok{"vp"}\NormalTok{]]))}
\NormalTok{              grImport2}\SpecialCharTok{::}\FunctionTok{grid.picture}\NormalTok{(svg, }\AttributeTok{width =} \FloatTok{0.5} \SpecialCharTok{/}\NormalTok{ lwd }\SpecialCharTok{*}\NormalTok{ struc.size.factor,}
                                      \AttributeTok{height =}\NormalTok{ width, }\AttributeTok{x =}\NormalTok{ struc.x, }\AttributeTok{y =}\NormalTok{ struc.y)}
              \DocumentationTok{\#\# return to ROOT}
              \FunctionTok{upViewport}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\NormalTok{            \}}
\NormalTok{            \})}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] END: current.viewport:"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\FunctionTok{current.viewport}\NormalTok{()), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{get\_facet.wrap.vp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           strip,}
           \AttributeTok{grid.force =}\NormalTok{ T}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(grid.force)\{}
\NormalTok{      grid}\SpecialCharTok{::}\FunctionTok{grid.force}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# grep vp of panel}
\NormalTok{    panel }\OtherTok{\textless{}{-}}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{grid.grep}\NormalTok{(}\StringTok{"panel"}\NormalTok{, }\AttributeTok{grep =}\NormalTok{ T, }\AttributeTok{global=}\NormalTok{ T, }\AttributeTok{viewports =}\NormalTok{ T, }\AttributeTok{grobs =}\NormalTok{ F)}
    \DocumentationTok{\#\# vp name}
\NormalTok{    panel }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(panel, paste)}
    \DocumentationTok{\#\# the specific seq number of vp}
\NormalTok{    panel.seq }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(panel, }\StringTok{"(?\textless{}=panel{-})[0{-}9]\{1,\}(?={-})"}\NormalTok{)}
\NormalTok{    panel.seq }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(}\FunctionTok{as.integer}\NormalTok{(panel.seq))}
    \DocumentationTok{\#\# number stat}
\NormalTok{    len }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(strip)}
\NormalTok{    len.p }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(panel)}
    \DocumentationTok{\#\# the number of blank panel}
\NormalTok{    na }\OtherTok{\textless{}{-}}\NormalTok{ len.p }\SpecialCharTok{{-}}\NormalTok{ (len }\SpecialCharTok{\%\%}\NormalTok{ len.p)}
    \ControlFlowTok{if}\NormalTok{(na }\SpecialCharTok{==}\NormalTok{ len.p)}
\NormalTok{      na }\OtherTok{\textless{}{-}} \DecValTok{0}
    \DocumentationTok{\#\# as matrix}
\NormalTok{    mat }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{sort}\NormalTok{(strip), }\FunctionTok{rep}\NormalTok{(}\ConstantTok{NA}\NormalTok{, na)), }\AttributeTok{ncol =}\NormalTok{ panel.seq, }\AttributeTok{byrow =}\NormalTok{ T)}
\NormalTok{    vec }\OtherTok{\textless{}{-}} \FunctionTok{as.vector}\NormalTok{(mat)}
    \DocumentationTok{\#\# as data.frame}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{vp =}\NormalTok{ panel, }\AttributeTok{strip =}\NormalTok{ vec)}
    \DocumentationTok{\#\# filter out the NA}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(strip))}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-tmp.ahr.r}{%
\section{File: tmp.ahr.R}\label{file-tmp.ahr.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{set.sig.wd }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(gse)}
\NormalTok{  \{}
\NormalTok{    path.work }\OtherTok{\textless{}{-}} \StringTok{"\textasciitilde{}/operation/geo\_db/ahr\_sig"}
\NormalTok{    path.de}\FloatTok{.1} \OtherTok{\textless{}{-}} \StringTok{"/ftp.ncbi.nlm.nih.gov/geo/series/"}
\NormalTok{    gse.dir }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"[0{-}9]\{3\}$"}\NormalTok{, }\StringTok{"nnn"}\NormalTok{, gse)}
\NormalTok{    wd }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path.work, path.de}\FloatTok{.1}\NormalTok{, gse.dir, }\StringTok{"/"}\NormalTok{, gse, }\StringTok{"/suppl"}\NormalTok{)}
    \FunctionTok{setwd}\NormalTok{(wd)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# The work directory at:"}\NormalTok{, }\FunctionTok{getwd}\NormalTok{(), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{print}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(}\AttributeTok{all.files =}\NormalTok{ T))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Done}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
 
\NormalTok{set.initial.wd }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
    \AttributeTok{wd =} \StringTok{"\textasciitilde{}/operation/geo\_db/ahr\_sig"}
\NormalTok{    )}
\NormalTok{  \{}
    \FunctionTok{setwd}\NormalTok{(wd)}
\NormalTok{  \}}
\NormalTok{decomp\_tar2txt }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{()\{}
    \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"\_RAW}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.tar$"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      utils}\SpecialCharTok{::}\FunctionTok{untar}\NormalTok{(}\AttributeTok{exdir =} \StringTok{"."}\NormalTok{)}
    \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.gz$"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{lapply}\NormalTok{(R.utils}\SpecialCharTok{::}\NormalTok{gunzip)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{pattern =} \StringTok{"\^{}GSM.*txt$"}\NormalTok{)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{file =}\NormalTok{ file)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
 
\NormalTok{anno.gene.biomart }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
    \AttributeTok{db =} \StringTok{"hsapiens\_gene\_ensembl"}\NormalTok{,}
    \AttributeTok{host =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{attr =} \ConstantTok{NA}\NormalTok{,}
    \AttributeTok{ex.attr =} \ConstantTok{NA}
\NormalTok{    )}
\NormalTok{  \{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(host))\{}
\NormalTok{      ensembl }\OtherTok{\textless{}{-}}\NormalTok{ biomaRt}\SpecialCharTok{::}\FunctionTok{useEnsembl}\NormalTok{(}\AttributeTok{biomart =} \StringTok{"ensembl"}\NormalTok{, }\AttributeTok{dataset =}\NormalTok{ db)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ensembl }\OtherTok{\textless{}{-}}\NormalTok{ biomaRt}\SpecialCharTok{::}\FunctionTok{useEnsembl}\NormalTok{(}\AttributeTok{biomart =} \StringTok{"ensembl"}\NormalTok{, }\AttributeTok{dataset =}\NormalTok{ db, }\AttributeTok{host =}\NormalTok{ host)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.character}\NormalTok{(attr))\{}
\NormalTok{      attr }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{"ensembl\_gene\_id"}\NormalTok{,}
        \StringTok{"hgnc\_symbol"}\NormalTok{,}
        \StringTok{"chromosome\_name"}\NormalTok{,}
        \StringTok{"start\_position"}\NormalTok{,}
        \StringTok{"end\_position"}\NormalTok{,}
        \StringTok{"description"}
\NormalTok{      )}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.character}\NormalTok{(ex.attr))}
\NormalTok{      attr }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(attr, ex.attr)}
\NormalTok{    anno }\OtherTok{\textless{}{-}}\NormalTok{ biomaRt}\SpecialCharTok{::}\FunctionTok{getBM}\NormalTok{(attr, }\AttributeTok{mart =}\NormalTok{ ensembl)}
\NormalTok{    anno }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(anno)}
    \FunctionTok{return}\NormalTok{(anno)}
\NormalTok{  \}}
 
\NormalTok{anno.gene.edb }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(keys,}
    \AttributeTok{package =} \StringTok{"EnsDb.Hsapiens.v86"}\NormalTok{,}
    \AttributeTok{columns =} \FunctionTok{c}\NormalTok{(}\StringTok{"GENEID"}\NormalTok{, }\StringTok{"SYMBOL"}\NormalTok{, }\StringTok{"EXONID"}\NormalTok{,}
      \StringTok{"EXONSEQSTART"}\NormalTok{, }\StringTok{"EXONSEQEND"}\NormalTok{),}
    \AttributeTok{keytype =} \StringTok{"GENEID"}\NormalTok{,}
    \AttributeTok{ex.attr =} \ConstantTok{NA}
\NormalTok{    )}
\NormalTok{  \{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.character}\NormalTok{(ex.attr))}
\NormalTok{      columns }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(columns, ex.attr)}
\NormalTok{    obj }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(package, }\StringTok{"::"}\NormalTok{, package)}
\NormalTok{    obj }\OtherTok{\textless{}{-}} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ obj))}
\NormalTok{    genes }\OtherTok{\textless{}{-}}\NormalTok{ AnnotationDbi}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(obj,}
      \AttributeTok{keytype =}\NormalTok{ keytype,}
      \AttributeTok{keys =}\NormalTok{ keys,}
      \AttributeTok{columns =}\NormalTok{ columns)}
\NormalTok{    genes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(}
\NormalTok{      genes, dplyr}\SpecialCharTok{::}\FunctionTok{across}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(keytype)), }\AttributeTok{.keep\_all =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{  \}}

\NormalTok{anno.into.list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{dge =}\NormalTok{ dge.list, }\AttributeTok{anno =}\NormalTok{ gene.anno, }\AttributeTok{col =} \StringTok{"ensembl\_gene\_id"}\NormalTok{)}
\NormalTok{  \{}
\NormalTok{    genes }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{col =} \FunctionTok{rownames}\NormalTok{(dge))}
    \FunctionTok{colnames}\NormalTok{(genes) }\OtherTok{\textless{}{-}}\NormalTok{ col}
\NormalTok{    genes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(genes, anno, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =}\NormalTok{ col, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    genes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(genes, dplyr}\SpecialCharTok{::}\FunctionTok{across}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{all\_of}\NormalTok{(col)), }\AttributeTok{.keep\_all =}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# is.na:}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    check.col }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(genes)[}\DecValTok{2}\NormalTok{]}
\NormalTok{    check.na }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(}
\NormalTok{      genes, }\FunctionTok{is.na}\NormalTok{(}\SpecialCharTok{!!!}\NormalTok{rlang}\SpecialCharTok{::}\FunctionTok{syms}\NormalTok{(check.col))) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{print}\NormalTok{(check.na)}
\NormalTok{    dge}\SpecialCharTok{$}\NormalTok{genes }\OtherTok{\textless{}{-}}\NormalTok{ genes}
    \FunctionTok{return}\NormalTok{(dge)}
\NormalTok{  \}}

\NormalTok{re.sample.group }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{dge =}\NormalTok{ dge.list, }\AttributeTok{meta =}\NormalTok{ meta.df)}
\NormalTok{  \{}
    \FunctionTok{colnames}\NormalTok{(dge) }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{sample}
\NormalTok{    dge}\SpecialCharTok{$}\NormalTok{samples}\SpecialCharTok{$}\NormalTok{group }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{group}
    \FunctionTok{return}\NormalTok{(dge)}
\NormalTok{  \}}
\CommentTok{\# fpkm2count \textless{}{-} }
\CommentTok{\# function(}
\CommentTok{\#          dge = dge.list,}
\CommentTok{\#          eff.len = "eff.len",}
\CommentTok{\#          lim.min = 0.0001}
\CommentTok{\#          )\{}
\CommentTok{\#   num \textless{}{-} nrow(dge$counts)}
\CommentTok{\#   eff.len \textless{}{-} dge$genes[[eff.len]]}
\CommentTok{\#   \#\# counts...}
\CommentTok{\#   cset \textless{}{-} apply(dge$counts, 2,}
\CommentTok{\#                 function(vec)\{}
\CommentTok{\#                   vec \textless{}{-} log(vec + lim.min, base = exp(1))}
\CommentTok{\#                   vec \textless{}{-} vec {-} log(1e9) + log(eff.len)}
\CommentTok{\#                   sum.counts.delog \textless{}{-} sum(vec) / (1 {-} num)}
\CommentTok{\#                   vec \textless{}{-} vec + sum.counts.delog}
\CommentTok{\#                   round(10 \^{} vec)}
\CommentTok{\#                 \})}
\CommentTok{\#   dge$counts \textless{}{-} cset}
\CommentTok{\#   return(dge)}
\CommentTok{\# \}}

\NormalTok{fpkm\_log2tpm }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{dge =}\NormalTok{ dge.list)}
\NormalTok{  \{}
\NormalTok{    cset }\OtherTok{\textless{}{-}} \FunctionTok{apply}\NormalTok{(dge}\SpecialCharTok{$}\NormalTok{counts, }\DecValTok{2}\NormalTok{,}
      \ControlFlowTok{function}\NormalTok{(vec)\{}
        \FunctionTok{log2}\NormalTok{(}
          \CommentTok{\# vec / sum(vec) * 1e6 + 1}
          \FunctionTok{exp}\NormalTok{(}\FunctionTok{log}\NormalTok{(vec) }\SpecialCharTok{{-}} \FunctionTok{log}\NormalTok{(}\FunctionTok{sum}\NormalTok{(vec, }\AttributeTok{na.rm =}\NormalTok{ T)) }\SpecialCharTok{+} \FunctionTok{log}\NormalTok{(}\FloatTok{1e6}\NormalTok{)) }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{        )}
\NormalTok{      \})}
\NormalTok{    dge}\SpecialCharTok{$}\NormalTok{counts }\OtherTok{\textless{}{-}}\NormalTok{ cset}
    \FunctionTok{return}\NormalTok{(dge)}
\NormalTok{  \}}

\NormalTok{get\_gsm.data }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(info)}
\NormalTok{  \{}
    \FunctionTok{lapply}\NormalTok{(info, }\ControlFlowTok{function}\NormalTok{(obj)\{}
\NormalTok{      gsm }\OtherTok{\textless{}{-}}\NormalTok{ Biobase}\SpecialCharTok{::}\FunctionTok{phenoData}\NormalTok{(obj) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        Biobase}\SpecialCharTok{::}\FunctionTok{sampleNames}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
        \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(gsm)\{}
\NormalTok{          gsm.dir }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"[0{-}9]\{3\}$"}\NormalTok{, }\StringTok{"nnn"}\NormalTok{, gsm)}
\NormalTok{          ftp }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"ftp://ftp.ncbi.nlm.nih.gov/geo/samples/"}\NormalTok{,}
\NormalTok{            gsm.dir, }\StringTok{"/"}\NormalTok{, gsm, }\StringTok{"/suppl/"}\NormalTok{)}
          \FunctionTok{system}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"wget {-}np {-}m"}\NormalTok{, ftp))}
\NormalTok{        \})}
\NormalTok{    \})}
\NormalTok{  \}}

\NormalTok{limma\_downstream }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(dge.list, group., design, contr.matrix,}
    \AttributeTok{min.count =} \DecValTok{10}\NormalTok{, }\AttributeTok{voom =}\NormalTok{ T, }\AttributeTok{cut.q =} \FloatTok{0.05}\NormalTok{, }\AttributeTok{cut.fc =} \FloatTok{0.3}\NormalTok{,}
    \AttributeTok{get\_ebayes =}\NormalTok{ F, }\AttributeTok{get\_normed.exprs =}\NormalTok{ F, }\AttributeTok{block =} \ConstantTok{NULL}\NormalTok{)}
\NormalTok{  \{ }\CommentTok{\# if(NA \%in\% dge.list$samples[["lib.size"]])\{}
    \CommentTok{\# dge.list$samples[["lib.size"]] \textless{}{-} apply(dge.list$counts, 2, sum, na.rm = T)}
    \CommentTok{\# \}}
\NormalTok{    keep.exprs }\OtherTok{\textless{}{-}}\NormalTok{ edgeR}\SpecialCharTok{::}\FunctionTok{filterByExpr}\NormalTok{(dge.list, }\AttributeTok{group =}\NormalTok{ group., }\AttributeTok{min.count =}\NormalTok{ min.count)}
\NormalTok{    dge.list }\OtherTok{\textless{}{-}}\NormalTok{ edgeR}\SpecialCharTok{::}\StringTok{\textasciigrave{}}\AttributeTok{[.DGEList}\StringTok{\textasciigrave{}}\NormalTok{(dge.list, keep.exprs, , }\AttributeTok{keep.lib.sizes =}\NormalTok{ F)}
    \ControlFlowTok{if}\NormalTok{(voom)\{}
\NormalTok{      dge.list }\OtherTok{\textless{}{-}}\NormalTok{ edgeR}\SpecialCharTok{::}\FunctionTok{calcNormFactors}\NormalTok{(dge.list, }\AttributeTok{method =} \StringTok{"TMM"}\NormalTok{)}
\NormalTok{      dge.list }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{voom}\NormalTok{(dge.list, design)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      genes }\OtherTok{\textless{}{-}}\NormalTok{ dge.list}\SpecialCharTok{$}\NormalTok{genes}
\NormalTok{      targets }\OtherTok{\textless{}{-}}\NormalTok{ dge.list}\SpecialCharTok{$}\NormalTok{samples}
\NormalTok{      dge.list }\OtherTok{\textless{}{-}} \FunctionTok{scale}\NormalTok{(dge.list}\SpecialCharTok{$}\NormalTok{counts, }\AttributeTok{scale =}\NormalTok{ F, }\AttributeTok{center =}\NormalTok{ T)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(get\_normed.exprs)}
      \FunctionTok{return}\NormalTok{(dge.list)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(block))\{}
\NormalTok{      dupcor }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{duplicateCorrelation}\NormalTok{(dge.list, design, }\AttributeTok{block =}\NormalTok{ block)}
\NormalTok{      cor }\OtherTok{\textless{}{-}}\NormalTok{ dupcor}\SpecialCharTok{$}\NormalTok{consensus.correlation}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Within{-}donor correlation:"}\NormalTok{, cor, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      cor }\OtherTok{\textless{}{-}} \ConstantTok{NULL}
\NormalTok{    \}}
\NormalTok{    fit }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{lmFit}\NormalTok{(dge.list, design, }\AttributeTok{block =}\NormalTok{ block, }\AttributeTok{correlation =}\NormalTok{ cor)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{voom)\{}
\NormalTok{      fit}\SpecialCharTok{$}\NormalTok{genes }\OtherTok{\textless{}{-}}\NormalTok{ genes}
\NormalTok{      fit}\SpecialCharTok{$}\NormalTok{targets }\OtherTok{\textless{}{-}}\NormalTok{ targets}
\NormalTok{    \}}
\NormalTok{    fit.cont }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{contrasts.fit}\NormalTok{(fit, }\AttributeTok{contrasts =}\NormalTok{ contr.matrix)}
\NormalTok{    ebayes }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{eBayes}\NormalTok{(fit.cont)}
    \ControlFlowTok{if}\NormalTok{(get\_ebayes)}
      \FunctionTok{return}\NormalTok{(ebayes)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(contr.matrix), }\ControlFlowTok{function}\NormalTok{(coef)\{}
\NormalTok{      results }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{topTable}\NormalTok{(ebayes, }\AttributeTok{coef =}\NormalTok{ coef, }\AttributeTok{number =} \ConstantTok{Inf}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(adj.P.Val }\SpecialCharTok{\textless{}}\NormalTok{ cut.q, }\FunctionTok{abs}\NormalTok{(logFC) }\SpecialCharTok{\textgreater{}}\NormalTok{ cut.fc) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{() }
      \FunctionTok{return}\NormalTok{(results)}
\NormalTok{    \})}
    \FunctionTok{names}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(contr.matrix)}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}
 
\NormalTok{limma\_downstream.eset }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{    eset,}
\NormalTok{    design,}
\NormalTok{    contr.matrix,}
    \AttributeTok{cut.q =} \FloatTok{0.05}\NormalTok{,}
    \AttributeTok{cut.fc =} \FloatTok{0.3}
\NormalTok{    )\{}
\NormalTok{    fit }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{lmFit}\NormalTok{(eset, design)}
\NormalTok{    fit.cont }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{contrasts.fit}\NormalTok{(fit, }\AttributeTok{contrasts =}\NormalTok{ contr.matrix)}
\NormalTok{    ebayes }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{eBayes}\NormalTok{(fit.cont)}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{ncol}\NormalTok{(contr.matrix), }\ControlFlowTok{function}\NormalTok{(coef)\{}
\NormalTok{      results }\OtherTok{\textless{}{-}}\NormalTok{ limma}\SpecialCharTok{::}\FunctionTok{topTable}\NormalTok{(ebayes, }\AttributeTok{coef =}\NormalTok{ coef, }\AttributeTok{number =} \ConstantTok{Inf}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(adj.P.Val }\SpecialCharTok{\textless{}}\NormalTok{ cut.q, }\FunctionTok{abs}\NormalTok{(logFC) }\SpecialCharTok{\textgreater{}}\NormalTok{ cut.fc) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{() }
      \FunctionTok{return}\NormalTok{(results)}
\NormalTok{    \})}
    \FunctionTok{names}\NormalTok{(res) }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(contr.matrix)}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}

\NormalTok{list.attr.biomart }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}\AttributeTok{biomart =} \StringTok{"ensembl"}\NormalTok{, }\AttributeTok{dataset =} \StringTok{"hsapiens\_gene\_ensembl"}\NormalTok{)}
\NormalTok{  \{}
\NormalTok{    attr }\OtherTok{\textless{}{-}}\NormalTok{ biomaRt}\SpecialCharTok{::}\FunctionTok{useEnsembl}\NormalTok{(}\AttributeTok{biomart =}\NormalTok{ biomart,}
      \AttributeTok{dataset =}\NormalTok{ dataset) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    biomaRt}\SpecialCharTok{::}\FunctionTok{listAttributes}\NormalTok{(}\AttributeTok{mart =}\NormalTok{ .) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
  \FunctionTok{return}\NormalTok{(attr)}
\NormalTok{  \}}

\NormalTok{show\_boxplot }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(df)}
\NormalTok{  \{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{id =} \FunctionTok{rownames}\NormalTok{(df)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(}\AttributeTok{id.vars =} \StringTok{"id"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"class"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(df) }\SpecialCharTok{+}
      \FunctionTok{geom\_boxplot}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ class, }\AttributeTok{y =}\NormalTok{ value))}
\NormalTok{    p }
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-try_do.r}{%
\section{File: try\_do.R}\label{file-try_do.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{try\_do }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           text,}
\NormalTok{           envir}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    n }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(check }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      n }\OtherTok{\textless{}{-}}\NormalTok{ n }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(res }\OtherTok{\textless{}{-}} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ text), }\AttributeTok{envir =}\NormalTok{ envir), }\AttributeTok{silent =}\NormalTok{ T)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{        check }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        check }\OtherTok{\textless{}{-}} \DecValTok{1}
\NormalTok{      \}}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\#"}\NormalTok{, }\StringTok{"Try..."}\NormalTok{, n, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-write_thesis.r}{%
\section{File: write\_thesis.R}\label{file-write_thesis.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# tools for fastly write formatting thesis}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{inclu.fig }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(image, }\AttributeTok{land =}\NormalTok{ F, }\AttributeTok{saveDir =} \StringTok{"thesis\_fig"}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{,}
  \AttributeTok{scale =} \ControlFlowTok{if}\NormalTok{ (land) \{}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \DecValTok{10}\NormalTok{, }\AttributeTok{height =} \FloatTok{6.2}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \FunctionTok{list}\NormalTok{(}\AttributeTok{width =} \FloatTok{6.2}\NormalTok{, }\AttributeTok{height =} \DecValTok{10}\NormalTok{)}
\NormalTok{  \})}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(saveDir))}
    \FunctionTok{dir.create}\NormalTok{(saveDir)}
\NormalTok{  upper }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(image)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.na}\NormalTok{(upper))}
\NormalTok{    upper }\OtherTok{\textless{}{-}} \StringTok{"."}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(image)}
  \DocumentationTok{\#\# backup for figure}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, file)) \{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(saveDir, }\StringTok{"/"}\NormalTok{, }\FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, }\StringTok{".png"}\NormalTok{, file))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(savename)) \{}
      \FunctionTok{pdf\_convert}\NormalTok{(image, }\AttributeTok{filenames =}\NormalTok{ savename, }\AttributeTok{dpi =}\NormalTok{ dpi, }\AttributeTok{pages =} \DecValTok{1}\NormalTok{)}
\NormalTok{      need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(saveDir, }\StringTok{"/"}\NormalTok{, file)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(savename)) \{}
      \FunctionTok{file.copy}\NormalTok{(image, savename)}
\NormalTok{      need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  \}}
  \DocumentationTok{\#\# trim the border}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{need\_trim) \{}
    \FunctionTok{gc}\NormalTok{()}
    \FunctionTok{pic\_trim}\NormalTok{(savename)}
\NormalTok{  \}}
  \DocumentationTok{\#\# record image info}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(image\_info[[ savename ]])) \{}
\NormalTok{    img }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(savename)}
\NormalTok{    info }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_info}\NormalTok{(img)}
\NormalTok{    magick}\SpecialCharTok{::}\FunctionTok{image\_destroy}\NormalTok{(img)}
\NormalTok{    image\_info[[ savename ]] }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{width =}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{width, }\AttributeTok{height =}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{height)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"image\_info"}\NormalTok{, image\_info, }\AttributeTok{envir =}\NormalTok{ .env)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    info }\OtherTok{\textless{}{-}}\NormalTok{ image\_info[[ savename ]]}
\NormalTok{  \}}
  \DocumentationTok{\#\# set figure display}
\NormalTok{  ratio }\OtherTok{\textless{}{-}}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{width }\SpecialCharTok{/}\NormalTok{ info}\SpecialCharTok{$}\NormalTok{height}
  \ControlFlowTok{if}\NormalTok{ ((scale}\SpecialCharTok{$}\NormalTok{width }\SpecialCharTok{/}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{height) }\SpecialCharTok{\textgreater{}=}\NormalTok{ ratio) \{}
    \DocumentationTok{\#\# height as reference}
\NormalTok{    height }\OtherTok{\textless{}{-}}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{height}
\NormalTok{    width }\OtherTok{\textless{}{-}}\NormalTok{ height }\SpecialCharTok{*}\NormalTok{ ratio}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
    \DocumentationTok{\#\# width as reference}
\NormalTok{    width }\OtherTok{\textless{}{-}}\NormalTok{ scale}\SpecialCharTok{$}\NormalTok{width}
\NormalTok{    height }\OtherTok{\textless{}{-}}\NormalTok{ width }\SpecialCharTok{/}\NormalTok{ ratio}
\NormalTok{  \}}
\NormalTok{  knitr}\SpecialCharTok{::}\NormalTok{opts\_current}\SpecialCharTok{$}\FunctionTok{set}\NormalTok{(}\AttributeTok{fig.height =}\NormalTok{ height, }\AttributeTok{fig.width =}\NormalTok{ width)}
\NormalTok{  knitr}\SpecialCharTok{::}\FunctionTok{include\_graphics}\NormalTok{(savename)}
\NormalTok{\}}

\NormalTok{prepare.fig }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(image, }\AttributeTok{saveDir =} \StringTok{"thesis\_fig"}\NormalTok{, }\AttributeTok{dpi =} \DecValTok{300}\NormalTok{)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(saveDir))}
    \FunctionTok{dir.create}\NormalTok{(saveDir)}
\NormalTok{  upper }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(image)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.na}\NormalTok{(upper))}
\NormalTok{    upper }\OtherTok{\textless{}{-}} \StringTok{"."}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(image)}
  \DocumentationTok{\#\# backup for figure}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, file)) \{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(saveDir, }\StringTok{"/"}\NormalTok{, }\FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.pdf$"}\NormalTok{, }\StringTok{".png"}\NormalTok{, file))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(savename)) \{}
      \FunctionTok{pdf\_convert}\NormalTok{(image, }\AttributeTok{filenames =}\NormalTok{ savename, }\AttributeTok{dpi =}\NormalTok{ dpi, }\AttributeTok{pages =} \DecValTok{1}\NormalTok{)}
\NormalTok{      need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(saveDir, }\StringTok{"/"}\NormalTok{, file)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(savename)) \{}
      \FunctionTok{file.copy}\NormalTok{(image, savename)}
\NormalTok{      need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ need\_trim }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  \}}
  \DocumentationTok{\#\# trim the border}
  \ControlFlowTok{if}\NormalTok{ (need\_trim) \{}
    \FunctionTok{gc}\NormalTok{()}
    \FunctionTok{pic\_trim}\NormalTok{(savename)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{inclu.capt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(img, }\AttributeTok{saveDir =} \StringTok{"thesis\_fig"}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(saveDir)) \{}
    \FunctionTok{dir.create}\NormalTok{(saveDir)}
\NormalTok{  \}}
\NormalTok{  filename }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(img)}
\NormalTok{  savename }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(saveDir, }\StringTok{"/"}\NormalTok{, filename)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(savename)) \{}
    \FunctionTok{png}\NormalTok{(savename, }\DecValTok{1000}\NormalTok{, }\DecValTok{1000}\NormalTok{, }\AttributeTok{res =} \DecValTok{150}\NormalTok{)}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{grid.raster}\NormalTok{(png}\SpecialCharTok{::}\FunctionTok{readPNG}\NormalTok{(img))}
    \FunctionTok{dev.off}\NormalTok{()}
\NormalTok{  \}}
  \FunctionTok{inclu.fig}\NormalTok{(savename)}
\NormalTok{\}}

\NormalTok{.env }\OtherTok{\textless{}{-}} \FunctionTok{topenv}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}

\NormalTok{image\_info }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}

\NormalTok{pic\_trim }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file)\{}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_read}\NormalTok{(file)}
\NormalTok{  img }\OtherTok{\textless{}{-}}\NormalTok{ magick}\SpecialCharTok{::}\FunctionTok{image\_trim}\NormalTok{(img)}
\NormalTok{  magick}\SpecialCharTok{::}\FunctionTok{image\_write}\NormalTok{(img, file)}
\NormalTok{  magick}\SpecialCharTok{::}\FunctionTok{image\_destroy}\NormalTok{(img)}
\NormalTok{\}}

\NormalTok{pretty\_flex2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data,}
  \AttributeTok{caption =} \StringTok{"This is table"}\NormalTok{, }\AttributeTok{footer =} \ConstantTok{NULL}\NormalTok{,  }\AttributeTok{bold\_header =}\NormalTok{ F,}
  \AttributeTok{weight =} \FunctionTok{sc}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), }\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(data))), }\AttributeTok{width =} \DecValTok{6}\NormalTok{,}
  \AttributeTok{family =} \StringTok{"Times New Roman"}\NormalTok{, }\AttributeTok{e.family =} \StringTok{"SimSun"}\NormalTok{, }\AttributeTok{font.size =} \FloatTok{10.5}\NormalTok{,}
  \AttributeTok{caption\_style =} \StringTok{"Table Caption"}\NormalTok{, }\AttributeTok{form\_body =}\NormalTok{ F, }\AttributeTok{form\_header =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
  \FunctionTok{do.call}\NormalTok{(pretty\_flex, args)}
\NormalTok{\}}

\NormalTok{pretty\_flex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(data,}
  \AttributeTok{caption =} \StringTok{"This is table"}\NormalTok{, }\AttributeTok{footer =} \StringTok{"This is footer"}\NormalTok{,  }\AttributeTok{bold\_header =}\NormalTok{ F,}
  \AttributeTok{weight =} \FunctionTok{sc}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data), }\FunctionTok{rep}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(data))), }\AttributeTok{width =} \DecValTok{6}\NormalTok{,}
  \AttributeTok{family =} \StringTok{"Times New Roman"}\NormalTok{, }\AttributeTok{e.family =} \StringTok{"SimSun"}\NormalTok{, }\AttributeTok{font.size =} \FloatTok{10.5}\NormalTok{,}
  \AttributeTok{caption\_style =} \StringTok{"Table Caption"}\NormalTok{, }\AttributeTok{form\_body =}\NormalTok{ T, }\AttributeTok{form\_header =}\NormalTok{ T)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (form\_body) \{}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_if}\NormalTok{(}
\NormalTok{      data, }\ControlFlowTok{function}\NormalTok{(x) }\FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.character}\NormalTok{(x) }\SpecialCharTok{|} \FunctionTok{is.factor}\NormalTok{(x), T, F), form}
\NormalTok{    )}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (form\_header) \{}
    \FunctionTok{colnames}\NormalTok{(data) }\OtherTok{\textless{}{-}} \FunctionTok{form}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data))}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(weight)))}
      \FunctionTok{names}\NormalTok{(weight) }\OtherTok{\textless{}{-}} \FunctionTok{form}\NormalTok{(}\FunctionTok{names}\NormalTok{(weight))}
\NormalTok{  \}}
\NormalTok{  weight }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(weight)}
\NormalTok{  weight }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(data),}
    \ControlFlowTok{function}\NormalTok{(name) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(weight[[ name ]])) }\DecValTok{1} \ControlFlowTok{else}\NormalTok{ weight[[ name ]]}
\NormalTok{    \}, }\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{), }\AttributeTok{USE.NAMES =}\NormalTok{ F)}
\NormalTok{  w.width }\OtherTok{\textless{}{-}}\NormalTok{ weight }\SpecialCharTok{*}\NormalTok{ (width }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(weight))}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{flextable}\NormalTok{(data)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{valign}\NormalTok{(data, }\AttributeTok{valign =} \StringTok{"top"}\NormalTok{, }\AttributeTok{part =} \StringTok{"body"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (bold\_header) \{}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{bold}\NormalTok{(data, }\AttributeTok{part =} \StringTok{"header"}\NormalTok{, }\AttributeTok{bold =} \ConstantTok{TRUE}\NormalTok{)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(footer)) \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.character}\NormalTok{(footer)) \{}
\NormalTok{      footer }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(footer, }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{add\_footer\_lines}\NormalTok{(data, footer)}
\NormalTok{  \}}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{width}\NormalTok{(data, }\AttributeTok{width =}\NormalTok{ w.width)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{font}\NormalTok{(}
\NormalTok{    data, }\AttributeTok{fontname =}\NormalTok{ family, }\AttributeTok{eastasia.family =}\NormalTok{ e.family, }\AttributeTok{part =} \StringTok{\textquotesingle{}all\textquotesingle{}}
\NormalTok{  )}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{fontsize}\NormalTok{(data, }\AttributeTok{size =}\NormalTok{ font.size, }\AttributeTok{part =} \StringTok{\textquotesingle{}all\textquotesingle{}}\NormalTok{)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ flextable}\SpecialCharTok{::}\FunctionTok{set\_caption}\NormalTok{(data, caption, }\AttributeTok{word\_stylename =}\NormalTok{ caption\_style)}
\NormalTok{  data}
\NormalTok{\}}

\NormalTok{flex\_footer }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, }\AttributeTok{props =} \FunctionTok{fp\_text}\NormalTok{(}\AttributeTok{font.size =} \FloatTok{10.5}\NormalTok{, }\AttributeTok{font.family =} \StringTok{"SimSun"}\NormalTok{)) \{}
\NormalTok{  flextable}\SpecialCharTok{::}\FunctionTok{as\_chunk}\NormalTok{(x, }\AttributeTok{props =}\NormalTok{ props)}
\NormalTok{\}}

\NormalTok{match\_fun2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(txt, }\AttributeTok{pattern =} \StringTok{"\^{}[0{-}9\_.A{-}Za{-}z]*(?= \textless{}{-})"}\NormalTok{)\{}
\NormalTok{  res }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(txt, pattern)}
\NormalTok{  res }\OtherTok{\textless{}{-}}\NormalTok{ res[ }\SpecialCharTok{!}\FunctionTok{vapply}\NormalTok{(res, is.na, }\FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{)) ]}
\NormalTok{\}}

\NormalTok{match\_method2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(txt)\{}
  \FunctionTok{match\_fun2}\NormalTok{(txt, }\StringTok{"(?\textless{}=setMethod}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}"}\StringTok{)[\^{}}\SpecialCharTok{\textbackslash{}"}\StringTok{]*(?=}\SpecialCharTok{\textbackslash{}"}\StringTok{)"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{match\_class }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(txt)\{}
\NormalTok{  class }\OtherTok{\textless{}{-}} \FunctionTok{match\_fun2}\NormalTok{(txt, }\StringTok{"(?\textless{}=setClass}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}"}\StringTok{).*(?=}\SpecialCharTok{\textbackslash{}"}\StringTok{)"}\NormalTok{)}
  \FunctionTok{sapply}\NormalTok{(class,}
    \ControlFlowTok{function}\NormalTok{(x) \{}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{isVirtualClass}\NormalTok{(x))}
        \FunctionTok{slotNames}\NormalTok{(}\FunctionTok{new}\NormalTok{(x))}
\NormalTok{    \}, }\AttributeTok{simplify =}\NormalTok{ F)}
\NormalTok{\}}

\NormalTok{as\_code\_list }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(names, }\AttributeTok{value =} \FunctionTok{rep}\NormalTok{(}\StringTok{""}\NormalTok{, }\FunctionTok{length}\NormalTok{(names)), }\AttributeTok{prefix =} \StringTok{"c"}\NormalTok{)\{}
  \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(prefix, }\StringTok{"("}\NormalTok{))}
  \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(names),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{      end }\OtherTok{\textless{}{-}} \ControlFlowTok{if}\NormalTok{ (n }\SpecialCharTok{==} \FunctionTok{length}\NormalTok{(names)) }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"} \ControlFlowTok{else} \StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{,"}
      \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"  "}\NormalTok{, names[[ n ]], }\StringTok{" = }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, value[[ n ]], end))}
\NormalTok{    \})}
  \FunctionTok{writeLines}\NormalTok{(}\StringTok{")"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{as\_code\_list2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst)\{}
  \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(lst),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\#\# "}\NormalTok{, }\FunctionTok{names}\NormalTok{(lst[n])))}
      \FunctionTok{as\_code\_list}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\FunctionTok{names}\NormalTok{(lst[n]), }\FunctionTok{length}\NormalTok{(lst[[ n ]])),}
\NormalTok{        lst[[ n ]])}
      \FunctionTok{writeLines}\NormalTok{(}\StringTok{""}\NormalTok{)}
\NormalTok{    \})}
\NormalTok{\}}

\NormalTok{as\_pander.flex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(obj, }\AttributeTok{page.width =} \DecValTok{12}\NormalTok{) \{}
  \FunctionTok{require}\NormalTok{(pander)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{body}\SpecialCharTok{$}\NormalTok{dataset}
\NormalTok{  caption }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{caption}\SpecialCharTok{$}\NormalTok{value}
  \FunctionTok{pandoc.table}\NormalTok{(data, caption)}
\NormalTok{\}}

\NormalTok{as\_kable.flex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(obj, }\AttributeTok{page.width =} \DecValTok{14}\NormalTok{, }\AttributeTok{landscape.width =} \DecValTok{19}\NormalTok{) \{}
  \FunctionTok{require}\NormalTok{(kableExtra)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{body}\SpecialCharTok{$}\NormalTok{dataset}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(n }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"InChIKey"}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(data))) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    data[[ n ]] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"([A{-}Z]\{7\})([A{-}Z]\{1,\})"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1{-} }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, data[[ n ]])}
\NormalTok{  \}}
\NormalTok{  caption }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{caption}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{  kable }\OtherTok{\textless{}{-}} \FunctionTok{kable}\NormalTok{(}
\NormalTok{    data, }\StringTok{"latex"}\NormalTok{, }\AttributeTok{booktabs =} \ConstantTok{TRUE}\NormalTok{,}
    \AttributeTok{longtable =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{caption =}\NormalTok{ caption}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{ncol}\NormalTok{(data) }\SpecialCharTok{\textgreater{}} \DecValTok{8}\NormalTok{) \{}
\NormalTok{    page.width }\OtherTok{\textless{}{-}}\NormalTok{ landscape.width}
\NormalTok{  \}}
\NormalTok{  widths }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{body}\SpecialCharTok{$}\NormalTok{colwidths}
\NormalTok{  widths }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}
    \FunctionTok{paste0}\NormalTok{(widths }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(widths) }\SpecialCharTok{*}\NormalTok{ page.width, }\StringTok{"cm"}\NormalTok{)}
\NormalTok{  )}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(widths)) \{}
\NormalTok{    kable }\OtherTok{\textless{}{-}} \FunctionTok{column\_spec}\NormalTok{(kable, i, }\AttributeTok{width =}\NormalTok{ widths[[ i ]])}
\NormalTok{  \}}
\NormalTok{  kable }\OtherTok{\textless{}{-}} \FunctionTok{kable\_styling}\NormalTok{(}
\NormalTok{    kable, }\AttributeTok{latex\_options =} \FunctionTok{c}\NormalTok{(}\StringTok{"hold\_position"}\NormalTok{, }\StringTok{"repeat\_header"}\NormalTok{),}
    \AttributeTok{font\_size =} \FloatTok{10.5}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(footnotes }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{footer}\SpecialCharTok{$}\NormalTok{dataset[[ }\DecValTok{1}\NormalTok{ ]]) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{ ) \{}
\NormalTok{    footnotes }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(footnotes, }\AttributeTok{split =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{    kable }\OtherTok{\textless{}{-}}\NormalTok{ kableExtra}\SpecialCharTok{::}\FunctionTok{footnote}\NormalTok{(}
\NormalTok{      kable, }\AttributeTok{number =}\NormalTok{ footnotes, }\AttributeTok{fixed\_small\_size =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{  \}}
\NormalTok{  kable}
\NormalTok{\}}

\NormalTok{as\_gt.flex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(obj, }\AttributeTok{page.width =} \DecValTok{650}\NormalTok{) \{}
  \FunctionTok{require}\NormalTok{(gt)}
\NormalTok{  data }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{body}\SpecialCharTok{$}\NormalTok{dataset}
\NormalTok{  colnames }\OtherTok{\textless{}{-}} \FunctionTok{colnames}\NormalTok{(data)}
\NormalTok{  widths }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{body}\SpecialCharTok{$}\NormalTok{colwidths}
\NormalTok{  widths }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(widths }\SpecialCharTok{/} \FunctionTok{sum}\NormalTok{(widths) }\SpecialCharTok{*}\NormalTok{ page.width)}
\NormalTok{  widths }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(widths),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\textasciigrave{}"}\NormalTok{, colnames[n], }\StringTok{"\textasciigrave{}"}\NormalTok{, }\StringTok{" \textasciitilde{} "}\NormalTok{,}
            \StringTok{"px("}\NormalTok{, widths[n], }\StringTok{")"}\NormalTok{)))}
\NormalTok{    \})}
\NormalTok{  caption }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{caption}\SpecialCharTok{$}\NormalTok{value}
\NormalTok{  gt }\OtherTok{\textless{}{-}} \FunctionTok{pretty\_table}\NormalTok{(}
\NormalTok{    data, }\AttributeTok{title =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{footnote =} \ConstantTok{NULL}\NormalTok{,}
    \AttributeTok{filename =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{caption =} \FunctionTok{md}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"**"}\NormalTok{, caption, }\StringTok{"**"}\NormalTok{)), }\AttributeTok{widths =}\NormalTok{ widths}
\NormalTok{  )}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(footnotes }\OtherTok{\textless{}{-}}\NormalTok{ obj}\SpecialCharTok{$}\NormalTok{footer}\SpecialCharTok{$}\NormalTok{dataset[[ }\DecValTok{1}\NormalTok{ ]]) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{ ) \{}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{":|："}\NormalTok{, footnotes)) \{}
\NormalTok{      footnotes }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(footnotes, }\AttributeTok{split =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{      locates }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(footnotes, }\StringTok{"\^{}.*?(?=:|：)"}\NormalTok{)}
\NormalTok{      footnotes }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}.*?[:：]"}\NormalTok{, }\StringTok{""}\NormalTok{, footnotes)}
      \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(footnotes)) \{}
\NormalTok{        gt }\OtherTok{\textless{}{-}} \FunctionTok{tab\_footnote}\NormalTok{(gt, }\AttributeTok{footnote =}\NormalTok{ footnotes[i],}
          \AttributeTok{locations =} \FunctionTok{cells\_column\_labels}\NormalTok{(}\AttributeTok{columns =}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{starts\_with}\NormalTok{(locates[i])))}
\NormalTok{      \}}
\NormalTok{    \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{      gt }\OtherTok{\textless{}{-}} \FunctionTok{tab\_footnote}\NormalTok{(gt, }\AttributeTok{footnote =}\NormalTok{ footnotes)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  gt }\OtherTok{\textless{}{-}} \FunctionTok{tab\_options}\NormalTok{(gt, }\AttributeTok{table.font.size =} \FunctionTok{px}\NormalTok{(}\FloatTok{10.5}\NormalTok{), }\AttributeTok{footnotes.font.size =} \FunctionTok{px}\NormalTok{(}\DecValTok{8}\NormalTok{))}
  \ControlFlowTok{if}\NormalTok{ (knitr}\SpecialCharTok{::}\FunctionTok{is\_latex\_output}\NormalTok{()) \{}
\NormalTok{    chunk\_label }\OtherTok{\textless{}{-}}\NormalTok{ knitr}\SpecialCharTok{::}\NormalTok{opts\_current}\SpecialCharTok{$}\FunctionTok{get}\NormalTok{(}\StringTok{"tab.id"}\NormalTok{)}
\NormalTok{    gt }\OtherTok{\textless{}{-}} \FunctionTok{as\_latex\_with\_caption}\NormalTok{(gt, chunk\_label, caption)}
\NormalTok{  \}}
\NormalTok{  gt}
\NormalTok{\}}

\NormalTok{as\_latex\_with\_caption }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(gt, chunk\_label, caption) \{}
\NormalTok{  gt }\OtherTok{\textless{}{-}}\NormalTok{ gt}\SpecialCharTok{::}\FunctionTok{as\_latex}\NormalTok{(gt)}
\NormalTok{  caption }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{caption\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{label\{tab:"}\NormalTok{, chunk\_label, }\StringTok{"\}"}\NormalTok{, caption, }\StringTok{"\}}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{"}\NormalTok{)}
\NormalTok{  latex }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(gt[}\DecValTok{1}\NormalTok{], }\AttributeTok{split =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{  pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{begin}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{longtable}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{, latex)}
  \CommentTok{\# pos.end \textless{}{-} grep("\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}end\textbackslash{}\textbackslash{}\{longtable\textbackslash{}\textbackslash{}\}", latex)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{length}\NormalTok{(pos) }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)}
    \FunctionTok{stop}\NormalTok{(}\StringTok{"length(pos) != 1"}\NormalTok{)}
  \CommentTok{\# if (!length(pos.end) == 1)}
    \CommentTok{\# stop("length(pos.end) != 1")}
\NormalTok{  latex[pos] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(latex[pos], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, caption, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \CommentTok{\# latex[pos] \textless{}{-} paste0("\textbackslash{}\textbackslash{}resizebox\{\textbackslash{}\textbackslash{}linewidth\}\{!\}\{\textbackslash{}n", latex[pos], "\textbackslash{}n", caption, "\textbackslash{}n")}
  \CommentTok{\# latex[pos.end] \textless{}{-} paste0(latex[pos.end], "\textbackslash{}n", "\}")}
\NormalTok{  latex }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(latex, }\AttributeTok{collapse =} \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  gt[}\DecValTok{1}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ latex}
  \FunctionTok{return}\NormalTok{(gt)}
\NormalTok{\}}

\NormalTok{thesis\_as\_latex.word }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md, }\AttributeTok{flex\_as\_kable =} \StringTok{"(\^{}flex\_.*)"}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(md) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{) \{}
    \FunctionTok{message}\NormalTok{(}\StringTok{"Guess \textasciigrave{}md\textasciigrave{} has been read by readLines."}\NormalTok{)}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}!{-}{-}{-}BLOCK\_LANDSCAPE\_START{-}{-}{-}\textgreater{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{landstart"}\NormalTok{, md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}!{-}{-}{-}BLOCK\_LANDSCAPE\_STOP{-}{-}{-}\textgreater{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{landend"}\NormalTok{, md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}!{-}{-}{-}BLOCK\_TOC{-}{-}{-}\textgreater{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{tableofcontents"}\NormalTok{, md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}!{-}{-}{-}BLOCK\_TOC}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{seq\_id: \textquotesingle{}fig\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}{-}{-}{-}\textgreater{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{listoffigures"}\NormalTok{, md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textless{}!{-}{-}{-}BLOCK\_TOC}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{seq\_id: \textquotesingle{}tab\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}{-}{-}{-}\textgreater{}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{listoftables"}\NormalTok{, md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{*.*?[:：]}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{*)"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{noindent}\SpecialCharTok{\textbackslash{}n\textbackslash{}\textbackslash{}}\StringTok{1"}\NormalTok{, md)}
    \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(flex\_as\_kable)) \{}
\NormalTok{      md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(flex\_as\_kable, }\StringTok{"as\_kable.flex(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1)"}\NormalTok{, md)}
\NormalTok{    \}}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}(\textasciigrave{}\textasciigrave{}\textasciigrave{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{r.*)tab.id"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1label"}\NormalTok{, md)}
    \CommentTok{\# md \textless{}{-} gsub("tab.id\textbackslash{}\textbackslash{}s*=\textbackslash{}\textbackslash{}s*\textbackslash{}"(.*?)\textbackslash{}"", "\textbackslash{}\textbackslash{}1", md)}
\NormalTok{    md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\&emsp;\&emsp;}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*"}\NormalTok{, }\StringTok{""}\NormalTok{, md)}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{insert\_pdf.tex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines, pos, pdf, }\AttributeTok{set\_pagenumber =}\NormalTok{ T) \{}
  \ControlFlowTok{if}\NormalTok{ (set\_pagenumber) \{}
\NormalTok{    command }\OtherTok{\textless{}{-}} \StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{includepdfset\{pagecommand=\{}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{thispagestyle\{fancy\}\}\}"}
\NormalTok{    lines[pos] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(lines[pos], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, command)}
\NormalTok{  \}}
\NormalTok{  pages }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"1{-}"}\NormalTok{, pdftools}\SpecialCharTok{::}\FunctionTok{pdf\_info}\NormalTok{(pdf)}\SpecialCharTok{$}\NormalTok{pages)}
\NormalTok{  command }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{includepdfmerge\{"}\NormalTok{, pdf, }\StringTok{","}\NormalTok{, pages, }\StringTok{"\}}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  lines[pos] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(lines[pos], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, command)}
  \FunctionTok{return}\NormalTok{(lines)}
\NormalTok{\}}

\NormalTok{insert\_tocCont.tex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines, pos, name, }\AttributeTok{style =} \StringTok{"section"}\NormalTok{) \{}
\NormalTok{  command }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}n\textbackslash{}\textbackslash{}}\StringTok{newpage}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{addcontentsline\{toc\}\{"}\NormalTok{, style, }\StringTok{"\}\{"}\NormalTok{, name, }\StringTok{"\}"}\NormalTok{)}
\NormalTok{  lines[pos] }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(lines[pos], }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{, command)}
  \FunctionTok{return}\NormalTok{(lines)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# insert text}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{ftext }\OtherTok{\textless{}{-}}\NormalTok{ officer}\SpecialCharTok{::}\NormalTok{ftext}
\NormalTok{fp\_text }\OtherTok{\textless{}{-}}\NormalTok{ officer}\SpecialCharTok{::}\NormalTok{fp\_text}
\NormalTok{fpar }\OtherTok{\textless{}{-}}\NormalTok{ officer}\SpecialCharTok{::}\NormalTok{fpar}
\NormalTok{fp\_par }\OtherTok{\textless{}{-}}\NormalTok{ officer}\SpecialCharTok{::}\NormalTok{fp\_par}

\NormalTok{st.index }\OtherTok{\textless{}{-}} \FunctionTok{fp\_text}\NormalTok{(}\AttributeTok{font.size =} \DecValTok{14}\NormalTok{, }\AttributeTok{font.family =} \StringTok{"SimHei"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# custom render}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{custom\_render }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file, }\AttributeTok{theme =} \StringTok{\textquotesingle{}thesis\textquotesingle{}}\NormalTok{, }\AttributeTok{fix =}\NormalTok{ fix\_spell,}
  \AttributeTok{fun\_render =}\NormalTok{ rmarkdown}\SpecialCharTok{::}\NormalTok{render, }\AttributeTok{heading\_mark =} \StringTok{"\#"}\NormalTok{) \{}
  \DocumentationTok{\#\# initialize}
\NormalTok{  global }\OtherTok{\textless{}{-}} \FunctionTok{environment}\NormalTok{()}
\NormalTok{  clear }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ns) \{}
    \FunctionTok{lapply}\NormalTok{(ns, }\ControlFlowTok{function}\NormalTok{(n) }\FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"n"}\NormalTok{, n), }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ global))}
\NormalTok{  \}}
  \FunctionTok{clear}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
  \FunctionTok{attr}\NormalTok{(n1, }\StringTok{\textquotesingle{}part\textquotesingle{}}\NormalTok{) }\OtherTok{\textless{}{-}} \DecValTok{0}
  \DocumentationTok{\#\# numbering heading}
\NormalTok{  md }\OtherTok{\textless{}{-}} \FunctionTok{fix}\NormalTok{(}\FunctionTok{readLines}\NormalTok{(file))}
\NormalTok{  h.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}"}\NormalTok{, heading\_mark), md)}
\NormalTok{  chunk.pos }\OtherTok{\textless{}{-}} \FunctionTok{get\_chunkPos}\NormalTok{(md)}
\NormalTok{  h.pos }\OtherTok{\textless{}{-}}\NormalTok{ h.pos[ }\SpecialCharTok{!}\NormalTok{h.pos }\SpecialCharTok{\%in\%}\NormalTok{ chunk.pos ]}
\NormalTok{  toc }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(md[h.pos],}
    \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{      level }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(ch, heading\_mark)[[ }\DecValTok{1}\NormalTok{ ]])}
\NormalTok{      fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"rheader"}\NormalTok{, }\FunctionTok{ifelse}\NormalTok{(level }\SpecialCharTok{\textgreater{}} \DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{, level), }\StringTok{"."}\NormalTok{, theme))}
\NormalTok{      nch }\OtherTok{\textless{}{-}} \FunctionTok{fun}\NormalTok{(ch, }\AttributeTok{level =}\NormalTok{ level, }\AttributeTok{global =}\NormalTok{ global, }\AttributeTok{clear =}\NormalTok{ clear)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"@@part"}\NormalTok{, ch)) level }\OtherTok{\textless{}{-}} \DecValTok{0}
      \FunctionTok{list}\NormalTok{(}\AttributeTok{heading =}\NormalTok{ nch, }\AttributeTok{level =}\NormalTok{ level)}
\NormalTok{    \})}
\NormalTok{  md[h.pos] }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(toc, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{heading, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
  \DocumentationTok{\#\# cross{-}reference}
\NormalTok{  ids }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(md, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{@@id:)[a{-}zA{-}Z.\_0{-}9]*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}\NormalTok{)}
\NormalTok{  ids.pos }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(md))[ }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(ids) ]}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(ids.pos) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{    ids.relToc }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(ids.pos, }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
      \ControlFlowTok{function}\NormalTok{(pos) \{}
        \FunctionTok{as\_ref.ch}\NormalTok{(}\FunctionTok{search\_toc}\NormalTok{(pos, }\AttributeTok{toc =}\NormalTok{ toc, }\AttributeTok{toc.pos =}\NormalTok{ h.pos))}
\NormalTok{      \})}
\NormalTok{    ids.db }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{sc}\NormalTok{(ids[ }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(ids) ], ids.relToc))}
\NormalTok{    md[ ids.pos ] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{@@id:[a{-}zA{-}Z.\_0{-}9]*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{, }\StringTok{""}\NormalTok{, md[ ids.pos ])}
\NormalTok{    refs }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(md, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{@@ref:)[a{-}zA{-}Z.\_0{-}9]*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}\NormalTok{)}
\NormalTok{    refs }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(refs))}
\NormalTok{    refs }\OtherTok{\textless{}{-}}\NormalTok{ refs[ }\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(refs) ]}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(refs) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{) \{}
\NormalTok{      refs.content }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(refs, }\AttributeTok{FUN.VALUE =} \FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{),}
        \ControlFlowTok{function}\NormalTok{(ref) \{}
\NormalTok{          content }\OtherTok{\textless{}{-}}\NormalTok{ ids.db[[ ref ]]}
          \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(content)) \{}
            \FunctionTok{stop}\NormalTok{(}\StringTok{"The reference id: "}\NormalTok{, ref, }\StringTok{" not found."}\NormalTok{)}
\NormalTok{          \}}
\NormalTok{          content}
\NormalTok{        \})}
      \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(refs)) \{}
\NormalTok{        md }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\{@@ref:"}\NormalTok{, refs[i], }\StringTok{"\}"}\NormalTok{), refs.content[i], md, }\AttributeTok{fixed =}\NormalTok{ T)}
\NormalTok{      \}}
\NormalTok{    \}}
\NormalTok{  \}}
  \DocumentationTok{\#\# output}
\NormalTok{  filename }\OtherTok{\textless{}{-}} \FunctionTok{get\_filename}\NormalTok{(file)}
\NormalTok{  filepath }\OtherTok{\textless{}{-}} \FunctionTok{get\_path}\NormalTok{(file)}
  \FunctionTok{writeLines}\NormalTok{(md, nfile }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(filepath, }\StringTok{"/"}\NormalTok{, }\StringTok{"\_temp\_"}\NormalTok{, filename))}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(fun\_render))}
    \FunctionTok{fun\_render}\NormalTok{(nfile)}
\NormalTok{\}}

\NormalTok{get\_chunkPos }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md) \{}
\NormalTok{  chunk.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}\textasciigrave{}\textasciigrave{}\textasciigrave{}"}\NormalTok{, md)}
  \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{length}\NormalTok{(chunk.pos), }\AttributeTok{by =} \DecValTok{2}\NormalTok{),}
      \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{        chunk.pos[n]}\SpecialCharTok{:}\NormalTok{chunk.pos[ n }\SpecialCharTok{+} \DecValTok{1}\NormalTok{ ]}
\NormalTok{      \}))}
\NormalTok{\}}

\DocumentationTok{\#\# chinese \textbackslash{}u4e00{-}\textbackslash{}u9fa5}
\DocumentationTok{\#\# double [\^{}\textbackslash{}x00{-}\textbackslash{}xff] }

\NormalTok{pch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{() }\StringTok{"[\textbackslash{}u4e00{-}\textbackslash{}u9fa5]"}

\NormalTok{fix\_spell }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(md) \{}
\NormalTok{  chunk.pos }\OtherTok{\textless{}{-}} \FunctionTok{get\_chunkPos}\NormalTok{(md)}
\NormalTok{  yaml.pos }\OtherTok{\textless{}{-}} \FunctionTok{grep}\NormalTok{(}\StringTok{"\^{}{-}{-}{-}"}\NormalTok{, md)}
\NormalTok{  yaml.pos }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(yaml.pos[}\DecValTok{2}\NormalTok{])}
\NormalTok{  pos }\OtherTok{\textless{}{-}}\NormalTok{ (}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(md))}
\NormalTok{  pos }\OtherTok{\textless{}{-}}\NormalTok{ pos[ }\SpecialCharTok{!}\NormalTok{pos }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(chunk.pos, yaml.pos) ]}
\NormalTok{  md[ pos ] }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{,  }\StringTok{"}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{"}\NormalTok{, md[ pos ])}
\NormalTok{  md[ pos ] }\OtherTok{\textless{}{-}} \FunctionTok{fix\_quote}\NormalTok{(md[ pos ])}
\NormalTok{  md}
\NormalTok{\}}

\NormalTok{fix\_quote }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines, }\AttributeTok{left =} \StringTok{"‘"}\NormalTok{, }\AttributeTok{right =} \StringTok{"’"}\NormalTok{, }\AttributeTok{extra =} \StringTok{"：、，。+（）"}\NormalTok{) \{}
\NormalTok{  pattern }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\StringTok{"[\textbackslash{}u4e00{-}\textbackslash{}u9fa5"}\NormalTok{, extra, }\StringTok{"]"}\NormalTok{)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}="}\NormalTok{, pattern, }\StringTok{")}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*}\SpecialCharTok{\textbackslash{}\textquotesingle{}\textbackslash{}\textbackslash{}}\StringTok{s*(?=[a{-}zA{-}Z])"}\NormalTok{), left, lines, }\AttributeTok{perl =}\NormalTok{ T)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"(?\textless{}=[a{-}zA{-}Z0{-}9])}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*}\SpecialCharTok{\textbackslash{}\textquotesingle{}\textbackslash{}\textbackslash{}}\StringTok{s*(?="}\NormalTok{, pattern, }\StringTok{")"}\NormalTok{), right, lines, }\AttributeTok{perl =}\NormalTok{ T)}
\NormalTok{  lines}
\NormalTok{\}}

\NormalTok{fix\_quote.latex }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lines) \{}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{\textquotesingle{}‘\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\textasciigrave{}\textquotesingle{}}\NormalTok{, lines)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{\textquotesingle{}’\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{\textquotesingle{}}\NormalTok{, lines)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{([a{-}zA{-}Z\_.}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)0{-}9]\{1,\})}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{"}\NormalTok{, }\StringTok{"\textasciigrave{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{"}\NormalTok{, lines)}
\NormalTok{  lines }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\textasciigrave{}([a{-}zA{-}Z\_.}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{(}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{)0{-}9]\{1,\})\textasciigrave{}"}\NormalTok{, }\StringTok{"\textasciigrave{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{"}\NormalTok{, lines)}
\NormalTok{  lines}
\NormalTok{\}}

\NormalTok{as\_ref.ch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(rel.toc, }\AttributeTok{sep =} \StringTok{" \&gt; "}\NormalTok{) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.list}\NormalTok{(rel.toc)) \{}
\NormalTok{    rel.toc }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(rel.toc, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{heading, }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  \}}
\NormalTok{  heading }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}\#*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{, }\StringTok{""}\NormalTok{, rel.toc)}
  \FunctionTok{paste0}\NormalTok{(heading, }\AttributeTok{collapse =}\NormalTok{ sep)}
\NormalTok{\}}

\NormalTok{search\_toc }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(pos, toc, toc.pos)}
\NormalTok{\{}
\NormalTok{  previous }\OtherTok{\textless{}{-}}\NormalTok{ toc[toc.pos }\SpecialCharTok{\textless{}=}\NormalTok{ pos]}
\NormalTok{  pre.levels }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(previous, }\ControlFlowTok{function}\NormalTok{(x) x}\SpecialCharTok{$}\NormalTok{level, }\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  top.level }\OtherTok{\textless{}{-}} \FunctionTok{tail}\NormalTok{(pre.levels, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{  is.rel }\OtherTok{\textless{}{-}} \FunctionTok{rev}\NormalTok{(}\FunctionTok{vapply}\NormalTok{(}\FunctionTok{rev}\NormalTok{(pre.levels), }\AttributeTok{FUN.VALUE =} \FunctionTok{logical}\NormalTok{(}\DecValTok{1}\NormalTok{),}
    \ControlFlowTok{function}\NormalTok{(level) \{}
      \ControlFlowTok{if}\NormalTok{ (level }\SpecialCharTok{\textless{}}\NormalTok{ top.level) \{}
\NormalTok{        top.level }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ level}
        \FunctionTok{return}\NormalTok{(T)}
\NormalTok{      \} }\ControlFlowTok{else}\NormalTok{ F}
\NormalTok{    \}))}
\NormalTok{  previous[ is.rel ]}
\NormalTok{\}}

\NormalTok{rheader1.thesis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, global, clear, ...,}
  \AttributeTok{fun.part =} \ControlFlowTok{function}\NormalTok{() \{}
\NormalTok{    x }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{"\# @@part "}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\# "}\NormalTok{, }\StringTok{"第"}\NormalTok{, }\FunctionTok{chn}\NormalTok{(}\FunctionTok{attr}\NormalTok{(n, }\StringTok{\textquotesingle{}part\textquotesingle{}}\NormalTok{)), }\StringTok{"部分 "}\NormalTok{), x)}
    \FunctionTok{paste0}\NormalTok{(x, }\StringTok{" \{{-}\}"}\NormalTok{)}
\NormalTok{  \},}
  \AttributeTok{fun.normal =} \ControlFlowTok{function}\NormalTok{() \{}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{sub}\NormalTok{(}\StringTok{"\# "}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\# "}\NormalTok{, }\FunctionTok{chn}\NormalTok{(n), }\StringTok{"、"}\NormalTok{), x), }\StringTok{"\{{-}\}"}\NormalTok{)}
\NormalTok{  \})}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}\textquotesingle{}}\NormalTok{, x)) \{}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{\textquotesingle{}@@part \textquotesingle{}}\NormalTok{, x)) \{}
\NormalTok{    n }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    n1 }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"n1"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ global)}
    \FunctionTok{attr}\NormalTok{(n, }\StringTok{\textquotesingle{}part\textquotesingle{}}\NormalTok{) }\OtherTok{\textless{}{-}} \FunctionTok{attr}\NormalTok{(n1, }\StringTok{\textquotesingle{}part\textquotesingle{}}\NormalTok{) }\SpecialCharTok{+} \DecValTok{1}
    \FunctionTok{clear}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"n1"}\NormalTok{, n, }\AttributeTok{envir =}\NormalTok{ global)}
    \FunctionTok{fun.part}\NormalTok{()}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"n1"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ global) }\SpecialCharTok{+} \DecValTok{1}
    \FunctionTok{clear}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"n1"}\NormalTok{, n, }\AttributeTok{envir =}\NormalTok{ global)}
    \FunctionTok{fun.normal}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{\}}

\NormalTok{rheader2.thesis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, global, clear, ...,}
  \AttributeTok{fun =} \ControlFlowTok{function}\NormalTok{() \{}
    \FunctionTok{sub}\NormalTok{(}\StringTok{"\#\# "}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\#\# "}\NormalTok{, }\StringTok{"（"}\NormalTok{, }\FunctionTok{chn}\NormalTok{(n), }\StringTok{"）"}\NormalTok{), }\FunctionTok{sub}\NormalTok{(}\StringTok{"$"}\NormalTok{, }\StringTok{" \{{-}\}"}\NormalTok{, x))}
\NormalTok{  \})}
\NormalTok{\{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"n2"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ global) }\SpecialCharTok{+} \DecValTok{1}
  \FunctionTok{clear}\NormalTok{(}\DecValTok{2}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"n2"}\NormalTok{, n, }\AttributeTok{envir =}\NormalTok{ global)}
  \FunctionTok{fun}\NormalTok{()}
\NormalTok{\}}

\NormalTok{rheader3.thesis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, global, clear, ...,}
  \AttributeTok{fun =} \ControlFlowTok{function}\NormalTok{() \{}
    \FunctionTok{sub}\NormalTok{(}\StringTok{"\#\#\# "}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\#\#\# "}\NormalTok{, n, }\StringTok{". "}\NormalTok{), }\FunctionTok{sub}\NormalTok{(}\StringTok{"$"}\NormalTok{, }\StringTok{" \{{-}\}"}\NormalTok{, x))}
\NormalTok{  \}) }
\NormalTok{\{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"n3"}\NormalTok{, }\AttributeTok{envir =}\NormalTok{ global) }\SpecialCharTok{+} \DecValTok{1}
  \FunctionTok{clear}\NormalTok{(}\DecValTok{3}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
  \FunctionTok{assign}\NormalTok{(}\StringTok{"n3"}\NormalTok{, n, }\AttributeTok{envir =}\NormalTok{ global)}
  \FunctionTok{fun}\NormalTok{()}
\NormalTok{\}}

\NormalTok{rheader4.thesis }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x, global, clear, }\AttributeTok{level =} \DecValTok{4}\NormalTok{, ...) \{}
\NormalTok{  n }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"n"}\NormalTok{, level), }\AttributeTok{envir =}\NormalTok{ global) }\SpecialCharTok{+} \DecValTok{1}
  \FunctionTok{clear}\NormalTok{(level}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)}
  \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"n"}\NormalTok{, level), n, }\AttributeTok{envir =}\NormalTok{ global)}
\NormalTok{  num }\OtherTok{\textless{}{-}} \FunctionTok{vapply}\NormalTok{(}\DecValTok{3}\SpecialCharTok{:}\NormalTok{level, }\ControlFlowTok{function}\NormalTok{(n) }\FunctionTok{get}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"n"}\NormalTok{, n), }\AttributeTok{envir =}\NormalTok{ global), }\FunctionTok{double}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{  num }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(num, }\AttributeTok{collapse =} \StringTok{"."}\NormalTok{)}
  \FunctionTok{sub}\NormalTok{(}\StringTok{"\#* "}\NormalTok{,}
    \FunctionTok{paste0}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\FunctionTok{rep}\NormalTok{(}\StringTok{"\#"}\NormalTok{, level), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{), }\StringTok{" "}\NormalTok{, num, }\StringTok{" "}\NormalTok{),}
    \FunctionTok{sub}\NormalTok{(}\StringTok{"$"}\NormalTok{, }\StringTok{" \{{-}\}"}\NormalTok{, x))}
\NormalTok{\}}

\NormalTok{chn }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n) \{}
  \ControlFlowTok{switch}\NormalTok{(n,}
    \StringTok{"1"} \OtherTok{=} \StringTok{"一"}\NormalTok{, }\StringTok{"2"} \OtherTok{=} \StringTok{"二"}\NormalTok{, }\StringTok{"3"} \OtherTok{=} \StringTok{"三"}\NormalTok{, }\StringTok{"4"} \OtherTok{=} \StringTok{"四"}\NormalTok{, }\StringTok{"5"} \OtherTok{=} \StringTok{"五"}\NormalTok{,}
    \StringTok{"6"} \OtherTok{=} \StringTok{"六"}\NormalTok{, }\StringTok{"7"} \OtherTok{=} \StringTok{"七"}\NormalTok{, }\StringTok{"8"} \OtherTok{=} \StringTok{"八"}\NormalTok{, }\StringTok{"9"} \OtherTok{=} \StringTok{"九"}\NormalTok{, }\StringTok{"10"} \OtherTok{=} \StringTok{"十"}
\NormalTok{  )}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# custom docx tools}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{custom\_docx\_document }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(...)\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  expr }\OtherTok{\textless{}{-}}\NormalTok{ args}\SpecialCharTok{$}\NormalTok{reference\_docx}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\textasciigrave{}r "}\NormalTok{, expr)) \{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}\textasciigrave{}r |\textasciigrave{}$"}\NormalTok{, }\StringTok{""}\NormalTok{, expr)))}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{reference\_docx }\OtherTok{\textless{}{-}}\NormalTok{ path}
\NormalTok{  \}}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{reference\_docx =}\NormalTok{ args}\SpecialCharTok{$}\NormalTok{reference\_docx,}
    \AttributeTok{df\_print =} \StringTok{"tibble"}\NormalTok{,}
    \AttributeTok{tables =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{style =} \StringTok{"Table"}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{topcaption =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{tab.lp =} \StringTok{"tab:"}\NormalTok{,}
      \AttributeTok{caption =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{style =} \StringTok{"Table Caption"}\NormalTok{, }\AttributeTok{pre =} \StringTok{"表"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\AttributeTok{tnd =} \DecValTok{0}\NormalTok{, }\AttributeTok{tns =} \StringTok{"{-}"}\NormalTok{,}
        \AttributeTok{fp\_text =} \FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
          \AttributeTok{font.size =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{italic =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{underlined =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{font.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold.cs =} \ConstantTok{FALSE}\NormalTok{,}
          \AttributeTok{font.size.cs =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{vertical.align =} \StringTok{\textquotesingle{}baseline\textquotesingle{}}\NormalTok{, }\AttributeTok{shading.color =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{hansi.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{eastasia.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{cs.family =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{lang.val =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.eastasia =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.bidi =} \ConstantTok{NA}
\NormalTok{        ), }\AttributeTok{structure =} \StringTok{"fp\_text"}\NormalTok{)}
\NormalTok{      )),}
    \AttributeTok{plots =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{style =} \StringTok{"Normal"}\NormalTok{, }\AttributeTok{align =} \StringTok{"center"}\NormalTok{, }\AttributeTok{fig.lp =} \StringTok{"fig:"}\NormalTok{, }\AttributeTok{topcaption =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{caption =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{style =} \StringTok{"Image Caption"}\NormalTok{, }\AttributeTok{pre =} \StringTok{"图"}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\AttributeTok{tnd =} \DecValTok{0}\NormalTok{, }\AttributeTok{tns =} \StringTok{"{-}"}\NormalTok{,}
        \AttributeTok{fp\_text =} \FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
          \AttributeTok{font.size =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold =} \ConstantTok{FALSE}\NormalTok{, }\AttributeTok{italic =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{underlined =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{font.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold.cs =} \ConstantTok{FALSE}\NormalTok{,}
          \AttributeTok{font.size.cs =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{vertical.align =} \StringTok{\textquotesingle{}baseline\textquotesingle{}}\NormalTok{, }\AttributeTok{shading.color =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{hansi.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{eastasia.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{cs.family =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{lang.val =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.eastasia =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.bidi =} \ConstantTok{NA}
\NormalTok{        ), }\AttributeTok{structure =} \StringTok{"fp\_text"}\NormalTok{)}
\NormalTok{        )),}
    \AttributeTok{page\_margins =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{bottom =} \DecValTok{1}\NormalTok{, }\AttributeTok{top =} \DecValTok{1}\NormalTok{, }\AttributeTok{right =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{left =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{header =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{footer =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{gutter =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{do.call}\NormalTok{(officedown}\SpecialCharTok{::}\NormalTok{rdocx\_document, }\FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bookdown::word\_document2\textquotesingle{}}\NormalTok{), args))}
\NormalTok{\}}

\NormalTok{custom\_docx\_document2 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(...)\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(...)}
\NormalTok{  expr }\OtherTok{\textless{}{-}}\NormalTok{ args}\SpecialCharTok{$}\NormalTok{reference\_docx}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}\textasciigrave{}r "}\NormalTok{, expr)) \{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}\textasciigrave{}r |\textasciigrave{}$"}\NormalTok{, }\StringTok{""}\NormalTok{, expr)))}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{reference\_docx }\OtherTok{\textless{}{-}}\NormalTok{ path}
\NormalTok{  \}}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
    \AttributeTok{reference\_docx =}\NormalTok{ args}\SpecialCharTok{$}\NormalTok{reference\_docx,}
    \AttributeTok{df\_print =} \StringTok{"tibble"}\NormalTok{,}
    \AttributeTok{tables =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{style =} \StringTok{"Table"}\NormalTok{, }\AttributeTok{width =} \DecValTok{1}\NormalTok{, }\AttributeTok{topcaption =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{tab.lp =} \StringTok{"tab:"}\NormalTok{,}
      \AttributeTok{caption =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{style =} \StringTok{"Table Caption"}\NormalTok{, }\AttributeTok{pre =} \StringTok{"Tab. "}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\AttributeTok{tnd =} \DecValTok{0}\NormalTok{, }\AttributeTok{tns =} \StringTok{"{-}"}\NormalTok{,}
        \AttributeTok{fp\_text =} \FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
          \AttributeTok{font.size =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{italic =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{underlined =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{font.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold.cs =} \ConstantTok{FALSE}\NormalTok{,}
          \AttributeTok{font.size.cs =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{vertical.align =} \StringTok{\textquotesingle{}baseline\textquotesingle{}}\NormalTok{, }\AttributeTok{shading.color =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{hansi.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{eastasia.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{cs.family =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{lang.val =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.eastasia =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.bidi =} \ConstantTok{NA}
\NormalTok{        ), }\AttributeTok{structure =} \StringTok{"fp\_text"}\NormalTok{)}
\NormalTok{      )),}
    \AttributeTok{plots =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{style =} \StringTok{"Normal"}\NormalTok{, }\AttributeTok{align =} \StringTok{"center"}\NormalTok{, }\AttributeTok{fig.lp =} \StringTok{"fig:"}\NormalTok{, }\AttributeTok{topcaption =} \ConstantTok{FALSE}\NormalTok{,}
      \AttributeTok{caption =} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{style =} \StringTok{"Image Caption"}\NormalTok{, }\AttributeTok{pre =} \StringTok{"Fig. "}\NormalTok{, }\AttributeTok{sep =} \StringTok{" "}\NormalTok{, }\AttributeTok{tnd =} \DecValTok{0}\NormalTok{, }\AttributeTok{tns =} \StringTok{"{-}"}\NormalTok{,}
        \AttributeTok{fp\_text =} \FunctionTok{structure}\NormalTok{(}\FunctionTok{list}\NormalTok{(}
          \AttributeTok{font.size =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{italic =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{underlined =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{color =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{font.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{bold.cs =} \ConstantTok{FALSE}\NormalTok{,}
          \AttributeTok{font.size.cs =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{vertical.align =} \StringTok{\textquotesingle{}baseline\textquotesingle{}}\NormalTok{, }\AttributeTok{shading.color =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{hansi.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{eastasia.family =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{cs.family =} \ConstantTok{NA}\NormalTok{,}
          \AttributeTok{lang.val =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.eastasia =} \ConstantTok{NA}\NormalTok{, }\AttributeTok{lang.bidi =} \ConstantTok{NA}
\NormalTok{        ), }\AttributeTok{structure =} \StringTok{"fp\_text"}\NormalTok{)}
\NormalTok{        )),}
    \AttributeTok{page\_margins =} \FunctionTok{list}\NormalTok{(}
      \AttributeTok{bottom =} \DecValTok{1}\NormalTok{, }\AttributeTok{top =} \DecValTok{1}\NormalTok{, }\AttributeTok{right =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{left =} \FloatTok{1.25}\NormalTok{, }\AttributeTok{header =} \FloatTok{0.5}\NormalTok{,}
      \AttributeTok{footer =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{gutter =} \FloatTok{0.5}\NormalTok{)}
\NormalTok{  )}
  \FunctionTok{do.call}\NormalTok{(officedown}\SpecialCharTok{::}\NormalTok{rdocx\_document, }\FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bookdown::word\_document2\textquotesingle{}}\NormalTok{), args))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# xml tools}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{touch\_docSt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{file =} \StringTok{"templ\_zcmu\_thesis.docx"}\NormalTok{,}
  \AttributeTok{path =} \StringTok{"."}\NormalTok{, }\AttributeTok{to =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, }\StringTok{".templ"}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  utils}\SpecialCharTok{::}\FunctionTok{unzip}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file), }\AttributeTok{exdir =}\NormalTok{ to)}
\NormalTok{  style }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(to, }\StringTok{"/word/styles.xml"}\NormalTok{)}
  \FunctionTok{attr}\NormalTok{(style, }\StringTok{"dir"}\NormalTok{) }\OtherTok{\textless{}{-}}\NormalTok{ to}
\NormalTok{  style}
\NormalTok{\}}

\NormalTok{update\_docSt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(st, xml)\{}
\NormalTok{  XML}\SpecialCharTok{::}\FunctionTok{saveXML}\NormalTok{(xml, st, }\AttributeTok{prefix =} \StringTok{\textquotesingle{}\textless{}?xml version="1.0" encoding="UTF{-}8" standalone="yes"?\textgreater{}}\SpecialCharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{  file }\OtherTok{\textless{}{-}} \FunctionTok{readLines}\NormalTok{(st)}
\NormalTok{  content }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(file[}\DecValTok{1}\NormalTok{], }\StringTok{""}\NormalTok{)}
\NormalTok{  xml }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{gsub}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*|}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*$"}\NormalTok{, }\StringTok{""}\NormalTok{, file[}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{]), }\AttributeTok{collapse =} \StringTok{""}\NormalTok{)}
\NormalTok{  pat }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_extract\_all}\NormalTok{(xml, }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s)[a{-}zA{-}Z]*="}\NormalTok{)))}
  \ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in}\NormalTok{ pat) \{}
\NormalTok{    xml }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s"}\NormalTok{, i), }\FunctionTok{paste0}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{"w:"}\NormalTok{, i), xml)}
\NormalTok{  \}}
\NormalTok{  content[}\DecValTok{2}\NormalTok{] }\OtherTok{\textless{}{-}}\NormalTok{ xml}
  \FunctionTok{writeLines}\NormalTok{(content, st)}
\NormalTok{\}}

\NormalTok{pack\_docSt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(st, }\AttributeTok{file =} \StringTok{"temple.docx"}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(file)) \{}
    \FunctionTok{file.create}\NormalTok{(file)}
\NormalTok{  \}}
\NormalTok{  to\_file }\OtherTok{\textless{}{-}} \FunctionTok{normalizePath}\NormalTok{(file)}
  \FunctionTok{file.remove}\NormalTok{(file)}
\NormalTok{  wd }\OtherTok{\textless{}{-}} \FunctionTok{getwd}\NormalTok{()}
  \FunctionTok{setwd}\NormalTok{(}\FunctionTok{attr}\NormalTok{(st, }\StringTok{"dir"}\NormalTok{))}
\NormalTok{  utils}\SpecialCharTok{::}\FunctionTok{zip}\NormalTok{(to\_file, }\StringTok{"./"}\NormalTok{)}
  \FunctionTok{setwd}\NormalTok{(wd)}
\NormalTok{\}}

\NormalTok{readxml }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file)\{}
\NormalTok{  xml }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlRoot}\NormalTok{(XML}\SpecialCharTok{::}\FunctionTok{xmlTreeParse}\NormalTok{(file))}
  \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"XML length:"}\NormalTok{, }\FunctionTok{length}\NormalTok{(xml)))}
\NormalTok{  xml}
\NormalTok{\}}

\NormalTok{ft }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml, target)\{}
\NormalTok{  names }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlSApply}\NormalTok{(xml, xmlName)}
  \FunctionTok{unname}\NormalTok{(}\FunctionTok{which}\NormalTok{(names }\SpecialCharTok{==}\NormalTok{ target))}
\NormalTok{\}}

\NormalTok{sc }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(name, value) \{}
  \FunctionTok{names}\NormalTok{(value) }\OtherTok{\textless{}{-}}\NormalTok{ name}
  \FunctionTok{return}\NormalTok{(value)}
\NormalTok{\}}

\NormalTok{allnames }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml2) \{}
  \FunctionTok{vapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml2), }\ControlFlowTok{function}\NormalTok{(n) XML}\SpecialCharTok{::}\FunctionTok{xmlName}\NormalTok{(xml2[[ n ]]), }\FunctionTok{character}\NormalTok{(}\DecValTok{1}\NormalTok{))}
\NormalTok{\}}

\NormalTok{cp\_xml.style }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml, }\AttributeTok{target =} \StringTok{"Table"}\NormalTok{, }\AttributeTok{src =} \StringTok{"Plain Table 1"}\NormalTok{)\{}
\NormalTok{  src.n }\OtherTok{\textless{}{-}} \FunctionTok{st.search}\NormalTok{(xml, src)}
\NormalTok{  target.n }\OtherTok{\textless{}{-}} \FunctionTok{st.search}\NormalTok{(xml, target)}
\NormalTok{  xml[[ target.n ]] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{removeChildren}\NormalTok{(}
\NormalTok{    xml[[ target.n ]], }\AttributeTok{kids =} \FunctionTok{allnames}\NormalTok{(xml[[ target.n ]])[ }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{ ]}
\NormalTok{  )}
\NormalTok{  xml[[ target.n ]] }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}
\NormalTok{    XML}\SpecialCharTok{::}\NormalTok{addChildren,}
    \FunctionTok{c}\NormalTok{(}\FunctionTok{list}\NormalTok{(xml[[ target.n ]]), XML}\SpecialCharTok{::}\FunctionTok{xmlChildren}\NormalTok{(xml[[ src.n ]])[ }\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{ ])}
\NormalTok{  )}
  \FunctionTok{return}\NormalTok{(xml)}
\NormalTok{\}}

\NormalTok{st.search }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml, name) \{}
  \FunctionTok{unlist}\NormalTok{(}\FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml),}
      \ControlFlowTok{function}\NormalTok{(n) \{}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{st.name}\NormalTok{(xml[[ n ]]) }\SpecialCharTok{==}\NormalTok{ name) n}
\NormalTok{      \}))}
\NormalTok{\}}

\NormalTok{st.name}\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml2)\{}
\NormalTok{  nametag }\OtherTok{\textless{}{-}}\NormalTok{ xml2[[ }\StringTok{"name"}\NormalTok{ ]]}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(nametag)) \{}
    \FunctionTok{return}\NormalTok{(XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(nametag)[[ }\StringTok{"val"}\NormalTok{ ]])}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(}\StringTok{"\_NULL\_"}\NormalTok{)}
\NormalTok{\}}

\NormalTok{repl\_xml.fontShd }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"fill"}\NormalTok{, }\AttributeTok{as =} \StringTok{"ededed"}\NormalTok{, }\AttributeTok{name =} \FunctionTok{show\_allTok}\NormalTok{(xml),}
  \AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"shd"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{insert\_xml.tabs }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(xml,}
    \AttributeTok{param =} \FunctionTok{c}\NormalTok{(}\StringTok{"val"}\NormalTok{, }\StringTok{"pos"}\NormalTok{), }\AttributeTok{as =} \FunctionTok{c}\NormalTok{(}\StringTok{"left"}\NormalTok{, }\DecValTok{240}\NormalTok{), }\AttributeTok{name =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{),}
    \AttributeTok{target =} \StringTok{"pPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"tabs"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
    \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(}\StringTok{"tabs"}\NormalTok{,}
\NormalTok{      XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(}\StringTok{"tab"}\NormalTok{, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
      \AttributeTok{namespace =}\NormalTok{ namespace))}
\NormalTok{  \{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
    \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{  \}}

\NormalTok{insert\_xml.praNum }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(xml,}
    \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \DecValTok{20}\NormalTok{, }\AttributeTok{name =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{),}
    \AttributeTok{target =} \StringTok{"pPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"numPr"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
    \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(}\StringTok{"numPr"}\NormalTok{,}
\NormalTok{      XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(}\StringTok{"numId"}\NormalTok{, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
      \AttributeTok{namespace =}\NormalTok{ namespace))}
\NormalTok{  \{}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{    args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
    \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{  \}}

\NormalTok{repl\_xml.fontSpace }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"after"}\NormalTok{, }\AttributeTok{as =} \StringTok{"0"}\NormalTok{, }\AttributeTok{name =} \StringTok{"caption"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"pPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"spacing"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(ttag, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
  \AttributeTok{force\_target =}\NormalTok{ F, }\AttributeTok{insert\_param =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{repl\_xml.fontOutl }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \DecValTok{0}\NormalTok{, }\AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)),}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"pPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"outlineLvl"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(ttag, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
  \AttributeTok{force\_target =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{repl\_xml.fontAlign }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \StringTok{"center"}\NormalTok{, }\AttributeTok{name =} \StringTok{"caption"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"pPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"jc"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(ttag, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
  \AttributeTok{force\_target =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{repl\_xml.fontSz }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \StringTok{"18"}\NormalTok{, }\AttributeTok{name =} \StringTok{"heading 1"}\NormalTok{,}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"sz"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(ttag, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
  \AttributeTok{force\_target =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{repl\_xml.fontSzCs }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \StringTok{"24"}\NormalTok{, }\AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)),}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"szCs"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{insert\_ttag =}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(ttag, }\AttributeTok{attrs =} \FunctionTok{sc}\NormalTok{(param, as), }\AttributeTok{namespace =}\NormalTok{ namespace),}
  \AttributeTok{force\_target =}\NormalTok{ F)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{dele\_xml.lang }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{name =} \StringTok{"Normal"}\NormalTok{, }\AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"lang"}\NormalTok{, }\AttributeTok{delete\_ttag =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{dele\_xml.ital }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{name =} \StringTok{"caption"}\NormalTok{, }\AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"i"}\NormalTok{, }\AttributeTok{delete\_ttag =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{dele\_xml.szCs }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)),}
  \AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"szCs"}\NormalTok{, }\AttributeTok{delete\_ttag =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{dele\_xml.qform }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)),}
  \AttributeTok{target =} \StringTok{"qFormat"}\NormalTok{, }\AttributeTok{delete\_target =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{dele\_xml.unhide }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)),}
  \AttributeTok{target =} \StringTok{"unhideWhenUsed"}\NormalTok{, }\AttributeTok{delete\_target =}\NormalTok{ T)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{reset\_xml.fontCol }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml,}
  \AttributeTok{param =} \StringTok{"val"}\NormalTok{, }\AttributeTok{as =} \StringTok{"000000"}\NormalTok{,}
  \AttributeTok{ttag =} \StringTok{"color"}\NormalTok{, }\AttributeTok{name =} \StringTok{"TOC Heading"}\NormalTok{,}
  \AttributeTok{remove\_ttagAttr =}\NormalTok{ T, ...)}
\NormalTok{\{}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{as.list}\NormalTok{(}\FunctionTok{environment}\NormalTok{())}
\NormalTok{  args}\SpecialCharTok{$}\NormalTok{match.arg }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{  args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(args, }\FunctionTok{list}\NormalTok{(...))}
  \FunctionTok{do.call}\NormalTok{(repl\_xml.font, args)}
\NormalTok{\}}

\NormalTok{repl\_xml.font }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml, }
  \AttributeTok{param =} \FunctionTok{c}\NormalTok{(}\StringTok{"eastAsia"}\NormalTok{, }\StringTok{"ascii"}\NormalTok{, }\StringTok{"hAnsi"}\NormalTok{, }\StringTok{"cs"}\NormalTok{),}
  \AttributeTok{as =} \FunctionTok{c}\NormalTok{(}\StringTok{"SimHei"}\NormalTok{, }\StringTok{"SimSun"}\NormalTok{, }\StringTok{"Times New Roman"}\NormalTok{),}
  \AttributeTok{name =} \FunctionTok{show\_allName}\NormalTok{(xml),}
  \AttributeTok{main =} \StringTok{"style"}\NormalTok{, }\AttributeTok{target =} \StringTok{"rPr"}\NormalTok{, }\AttributeTok{ttag =} \StringTok{"rFonts"}\NormalTok{, }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{,}
  \AttributeTok{match.arg =}\NormalTok{ T, }\AttributeTok{delete\_target =}\NormalTok{ F,}
  \AttributeTok{insert\_ttag =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{force\_target =}\NormalTok{ F, }\AttributeTok{delete\_ttag =}\NormalTok{ F, }\AttributeTok{insert\_param =}\NormalTok{ F,}
  \AttributeTok{remove\_ttagAttr =}\NormalTok{ F)}
\NormalTok{\{}
  \ControlFlowTok{if}\NormalTok{ (match.arg) \{}
\NormalTok{    param }\OtherTok{\textless{}{-}} \FunctionTok{match.arg}\NormalTok{(param)}
\NormalTok{    as }\OtherTok{\textless{}{-}} \FunctionTok{match.arg}\NormalTok{(as)}
\NormalTok{  \}}
\NormalTok{  xml[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml)] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlSApply}\NormalTok{(xml,}
    \ControlFlowTok{function}\NormalTok{(xml2) \{}
      \ControlFlowTok{if}\NormalTok{ (XML}\SpecialCharTok{::}\FunctionTok{xmlName}\NormalTok{(xml2) }\SpecialCharTok{==}\NormalTok{ main) \{}
\NormalTok{        xml2.name }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml2[[ }\StringTok{"name"}\NormalTok{ ]])[[ }\StringTok{"val"}\NormalTok{ ]]}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(xml2.name }\SpecialCharTok{==}\NormalTok{ name)) \{}
          \ControlFlowTok{if}\NormalTok{ (delete\_target) \{}
            \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(xml2[[ target ]]))}
\NormalTok{              xml2 }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{removeChildren}\NormalTok{(xml2, target)}
            \FunctionTok{return}\NormalTok{(xml2)}
\NormalTok{          \}}
\NormalTok{          tag }\OtherTok{\textless{}{-}}\NormalTok{ xml2[[ target ]][[ ttag ]]}
          \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(tag)) \{}
            \ControlFlowTok{if}\NormalTok{ (delete\_ttag) \{}
              \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(xml2[[ target ]])) \{}
\NormalTok{                xml2[[ target ]] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{removeChildren}\NormalTok{(xml2[[ target ]], ttag)}
\NormalTok{              \}}
              \FunctionTok{return}\NormalTok{(xml2)}
\NormalTok{            \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (remove\_ttagAttr) \{}
\NormalTok{              xml2[[ target ]][[ ttag ]] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{removeAttributes}\NormalTok{(xml2[[ target ]][[ ttag ]])}
\NormalTok{            \}}
\NormalTok{            tag.attr }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(tag)}
            \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(param }\SpecialCharTok{==} \FunctionTok{names}\NormalTok{(tag.attr)) }\SpecialCharTok{|}\NormalTok{ insert\_param) \{}
\NormalTok{              XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml2[[ target ]][[ ttag ]])[[ param ]] }\OtherTok{\textless{}{-}}\NormalTok{ as}
\NormalTok{            \}}
\NormalTok{          \} }\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(insert\_ttag)) \{}
            \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(xml2[[ target ]]) }\SpecialCharTok{\&}\NormalTok{ force\_target) \{}
\NormalTok{              node }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(target, }\AttributeTok{namespace =}\NormalTok{ namespace)}
\NormalTok{              xml2 }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{append.xmlNode}\NormalTok{(xml2, node)}
\NormalTok{            \}}
            \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(xml2[[ target ]])) \{}
\NormalTok{              xml2[[ target ]] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{append.xmlNode}\NormalTok{(xml2[[ target ]], insert\_ttag)}
\NormalTok{            \}}
\NormalTok{          \}}
\NormalTok{        \}}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(xml2)}
\NormalTok{    \})}
  \FunctionTok{return}\NormalTok{(xml)}
\NormalTok{\}}

\NormalTok{rm\_xml.lsdAttr }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml2,}
  \AttributeTok{name =} \FunctionTok{c}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"heading "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{), }\FunctionTok{paste0}\NormalTok{(}\StringTok{"toc "}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{9}\NormalTok{)), }\AttributeTok{attrs =} \StringTok{"qFormat"}\NormalTok{)}
\NormalTok{\{}
\NormalTok{  xml2[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml2)] }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlSApply}\NormalTok{(xml2,}
    \ControlFlowTok{function}\NormalTok{(xml3) \{}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml3)[[ }\StringTok{"name"}\NormalTok{ ]] }\SpecialCharTok{==}\NormalTok{ name)) \{}
\NormalTok{        vals }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml3)}
\NormalTok{        vals }\OtherTok{\textless{}{-}}\NormalTok{ vals[ }\FunctionTok{names}\NormalTok{(vals) }\SpecialCharTok{!=}\NormalTok{ attrs ]}
\NormalTok{        xml3 }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{removeAttributes}\NormalTok{(xml3)}
\NormalTok{        XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml3) }\OtherTok{\textless{}{-}}\NormalTok{ vals}
\NormalTok{      \}}
      \FunctionTok{return}\NormalTok{(xml3)}
\NormalTok{    \})}
  \FunctionTok{return}\NormalTok{(xml2)}
\NormalTok{\}}

\NormalTok{show\_allName }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml)\{}
\NormalTok{  obj }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlSApply}\NormalTok{(xml,}
    \ControlFlowTok{function}\NormalTok{(x) \{}
\NormalTok{      x.name }\OtherTok{\textless{}{-}}\NormalTok{ x[[ }\StringTok{"name"}\NormalTok{ ]]}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(x.name)) \{}
        \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(x[[ }\StringTok{"rPr"}\NormalTok{ ]]) }\SpecialCharTok{|} \SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(x[[ }\StringTok{"pPr"}\NormalTok{ ]]))}
\NormalTok{          XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(x.name)[[ }\StringTok{"val"}\NormalTok{ ]]}
\NormalTok{      \}}
\NormalTok{    \})}
  \FunctionTok{unlist}\NormalTok{(obj)}
\NormalTok{\}}

\NormalTok{list\_allName }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml)\{}
  \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{      xml[[n]][[ }\StringTok{"name"}\NormalTok{]]}
\NormalTok{    \})}
\NormalTok{\}}

\NormalTok{show\_allTok }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml)\{}
\NormalTok{  all }\OtherTok{\textless{}{-}} \FunctionTok{show\_allName}\NormalTok{(xml)}
  \FunctionTok{c}\NormalTok{(all[ }\FunctionTok{grep}\NormalTok{(}\StringTok{"Tok$"}\NormalTok{, all) ])}
\NormalTok{\}}

\NormalTok{.xmlFont }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlNode}\NormalTok{(}\StringTok{"rFonts"}\NormalTok{,}
  \AttributeTok{attrs =} \FunctionTok{c}\NormalTok{(}\AttributeTok{ascii =} \StringTok{"Times New Roman"}\NormalTok{,}
    \AttributeTok{hAnsi =} \StringTok{"Times New Roman"}\NormalTok{,}
    \AttributeTok{eastAsia =} \StringTok{"SimSun"}\NormalTok{,}
    \AttributeTok{cs =} \StringTok{"Nimbus Roman"}\NormalTok{), }\AttributeTok{namespace =} \StringTok{"w"}\NormalTok{)}

\NormalTok{all\_tableStyle }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(xml)\{}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(xml),}
    \ControlFlowTok{function}\NormalTok{(n) \{}
\NormalTok{      attr }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml[[n]])}
      \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(attr)) \{}
        \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(}\FunctionTok{names}\NormalTok{(attr) }\SpecialCharTok{==} \StringTok{"type"}\NormalTok{)) \{}
          \ControlFlowTok{if}\NormalTok{ (attr[[ }\StringTok{"type"}\NormalTok{ ]] }\SpecialCharTok{==} \StringTok{"table"}\NormalTok{)}
\NormalTok{            XML}\SpecialCharTok{::}\FunctionTok{xmlAttrs}\NormalTok{(xml[[ n ]][[ }\StringTok{"name"}\NormalTok{ ]])[[ }\StringTok{"val"}\NormalTok{ ]]}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{    \})}
  \FunctionTok{unlist}\NormalTok{(lst)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# others}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{mutate\_get\_fun }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{ (x) \{}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.function}\NormalTok{(x)) \{}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{grepl}\NormalTok{(}\StringTok{"::"}\NormalTok{, x, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)) \{}
\NormalTok{    coumpounds }\OtherTok{\textless{}{-}} \FunctionTok{strsplit}\NormalTok{(x, }\AttributeTok{split =} \StringTok{"::"}\NormalTok{, x, }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{)[[}\DecValTok{1}\NormalTok{]]}
\NormalTok{    z }\OtherTok{\textless{}{-}} \FunctionTok{getFromNamespace}\NormalTok{(coumpounds[}\DecValTok{2}\NormalTok{], }\AttributeTok{ns =}\NormalTok{ coumpounds[}\DecValTok{1}\NormalTok{])}
\NormalTok{  \} }\ControlFlowTok{else}\NormalTok{ \{}
\NormalTok{    z }\OtherTok{\textless{}{-}} \FunctionTok{getAnywhere}\NormalTok{(x)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(z}\SpecialCharTok{$}\NormalTok{objs) }\SpecialCharTok{\textless{}} \DecValTok{1}\NormalTok{) \{}
      \FunctionTok{stop}\NormalTok{(}\StringTok{"could not find any function named "}\NormalTok{, }\FunctionTok{shQuote}\NormalTok{(z}\SpecialCharTok{$}\NormalTok{name), }
        \StringTok{" in loaded namespaces or in the search path. If the package is installed, specify name w}
\StringTok{        ith \textasciigrave{}packagename::function\_name\textasciigrave{}."}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{  z}
\NormalTok{\}}

\NormalTok{pdf\_convert }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{ (pdf, }\AttributeTok{format =} \StringTok{"png"}\NormalTok{, }\AttributeTok{pages =} \ConstantTok{NULL}\NormalTok{, }\AttributeTok{filenames =} \ConstantTok{NULL}\NormalTok{, }
    \AttributeTok{dpi =} \DecValTok{72}\NormalTok{, }\AttributeTok{antialias =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{opw =} \StringTok{""}\NormalTok{, }\AttributeTok{upw =} \StringTok{""}\NormalTok{, }\AttributeTok{verbose =} \ConstantTok{TRUE}\NormalTok{) }
\NormalTok{\{}
\NormalTok{  config }\OtherTok{\textless{}{-}}\NormalTok{ pdftools}\SpecialCharTok{::}\FunctionTok{poppler\_config}\NormalTok{()}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\NormalTok{config}\SpecialCharTok{$}\NormalTok{can\_render }\SpecialCharTok{||} \SpecialCharTok{!}\FunctionTok{length}\NormalTok{(config}\SpecialCharTok{$}\NormalTok{supported\_image\_formats)) }
    \FunctionTok{stop}\NormalTok{(}\StringTok{"You version of libppoppler does not support rendering"}\NormalTok{)}
\NormalTok{  format }\OtherTok{\textless{}{-}} \FunctionTok{match.arg}\NormalTok{(format, config}\SpecialCharTok{$}\NormalTok{supported\_image\_formats)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(pages)) }
\NormalTok{    pages }\OtherTok{\textless{}{-}} \FunctionTok{seq\_len}\NormalTok{(pdftools}\SpecialCharTok{::}\FunctionTok{pdf\_info}\NormalTok{(pdf, }\AttributeTok{opw =}\NormalTok{ opw, }\AttributeTok{upw =}\NormalTok{ upw)}\SpecialCharTok{$}\NormalTok{pages)}
  \ControlFlowTok{if}\NormalTok{ (}\SpecialCharTok{!}\FunctionTok{is.numeric}\NormalTok{(pages) }\SpecialCharTok{||} \SpecialCharTok{!}\FunctionTok{length}\NormalTok{(pages)) }
    \FunctionTok{stop}\NormalTok{(}\StringTok{"Argument \textquotesingle{}pages\textquotesingle{} must be a one{-}indexed vector of page numbers"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(filenames) }\SpecialCharTok{\textless{}} \DecValTok{2}\NormalTok{) \{}
\NormalTok{    input }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.raw}\NormalTok{(pdf), }\StringTok{"output"}\NormalTok{, }\FunctionTok{sub}\NormalTok{(}\StringTok{".pdf"}\NormalTok{, }\StringTok{""}\NormalTok{, }
        \FunctionTok{basename}\NormalTok{(pdf), }\AttributeTok{fixed =} \ConstantTok{TRUE}\NormalTok{))}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{is.null}\NormalTok{(filenames)) \{}
\NormalTok{    filenames }\OtherTok{\textless{}{-}} \FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%s\_\%d.\%s"}\NormalTok{, input, pages, format)}
\NormalTok{  \}}
  \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{length}\NormalTok{(filenames) }\SpecialCharTok{!=} \FunctionTok{length}\NormalTok{(pages)) }
    \FunctionTok{stop}\NormalTok{(}\StringTok{"Length of \textquotesingle{}filenames\textquotesingle{} must be one or equal to \textquotesingle{}pages\textquotesingle{}"}\NormalTok{)}
\NormalTok{  antialiasing }\OtherTok{\textless{}{-}} \FunctionTok{isTRUE}\NormalTok{(antialias) }\SpecialCharTok{||} \FunctionTok{isTRUE}\NormalTok{(antialias }\SpecialCharTok{==} 
    \StringTok{"draw"}\NormalTok{)}
\NormalTok{  text\_antialiasing }\OtherTok{\textless{}{-}} \FunctionTok{isTRUE}\NormalTok{(antialias) }\SpecialCharTok{||} \FunctionTok{isTRUE}\NormalTok{(antialias }\SpecialCharTok{==} 
    \StringTok{"text"}\NormalTok{)}
\NormalTok{  pdftools}\SpecialCharTok{:::}\FunctionTok{poppler\_convert}\NormalTok{(pdftools}\SpecialCharTok{:::}\FunctionTok{loadfile}\NormalTok{(pdf), format, pages, filenames, }
\NormalTok{    dpi, opw, upw, antialiasing, text\_antialiasing, verbose)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ==========================================================================}
\CommentTok{\# other tools}
\CommentTok{\# {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-} {-}}

\NormalTok{as\_df.lst }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(lst, }\AttributeTok{col.name =} \StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{, }\AttributeTok{col.value =} \StringTok{\textquotesingle{}name\textquotesingle{}}\NormalTok{) \{}
\NormalTok{  data }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}
    \AttributeTok{x =} \FunctionTok{rep}\NormalTok{(}\FunctionTok{names}\NormalTok{(lst), }\FunctionTok{lengths}\NormalTok{(lst), }\AttributeTok{each =}\NormalTok{ T), }
    \AttributeTok{y =} \FunctionTok{unlist}\NormalTok{(lst, }\AttributeTok{use.names =}\NormalTok{ F)}
\NormalTok{  )}
  \FunctionTok{colnames}\NormalTok{(data) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(col.name, col.value)}
\NormalTok{  data}
\NormalTok{\}}

\NormalTok{cutWords }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(ch, }\AttributeTok{len =} \DecValTok{15}\NormalTok{, }\AttributeTok{len.post =} \DecValTok{3}\NormalTok{, }\AttributeTok{max =}\NormalTok{ len }\SpecialCharTok{+}\NormalTok{ len.post }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) \{}
  \ControlFlowTok{while}\NormalTok{( }\FunctionTok{any}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"[\^{} \^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}]\{"}\NormalTok{, max, }\StringTok{"\}"}\NormalTok{), ch)) ) \{}
\NormalTok{    ch }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b([\^{} \^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}]\{"}\NormalTok{, len, }\StringTok{"\})([\^{} \^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}]\{"}\NormalTok{, len.post, }\StringTok{",\})}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{b"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{1{-}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{2"}\NormalTok{, ch)}
\NormalTok{  \}}
\NormalTok{  ch}
\NormalTok{\}}

\NormalTok{formatBib }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}\AttributeTok{bib =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/library.bib"}\NormalTok{), }\AttributeTok{savename =} \StringTok{"tmp.bib"}\NormalTok{, }
  \AttributeTok{journalAbb\_file =} \FunctionTok{paste0}\NormalTok{(.expath, }\StringTok{"/endlib.txt"}\NormalTok{))}
\NormalTok{\{}
\NormalTok{  endlib }\OtherTok{\textless{}{-}}\NormalTok{ tibble}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(journalAbb\_file, }\AttributeTok{header =}\NormalTok{ F))}
\NormalTok{  dics }\OtherTok{\textless{}{-}} \FunctionTok{.as\_dic}\NormalTok{(endlib[[}\DecValTok{2}\NormalTok{]], endlib[[}\DecValTok{1}\NormalTok{]])}
  \FunctionTok{names}\NormalTok{(dics) }\OtherTok{\textless{}{-}} \FunctionTok{tolower}\NormalTok{(}\FunctionTok{names}\NormalTok{(dics))}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{read\_bib}\NormalTok{(bib)}
\NormalTok{  lst }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(lst,}
    \ControlFlowTok{function}\NormalTok{(ch) \{}
\NormalTok{      pos }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*journal ="}\NormalTok{, ch)}
      \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{any}\NormalTok{(pos)) \{}
\NormalTok{        journal }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(ch[pos], }\StringTok{"(?\textless{}=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{).*(?=}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\})"}\NormalTok{)}
\NormalTok{        journal }\OtherTok{\textless{}{-}} \FunctionTok{tolower}\NormalTok{(journal)}
        \ControlFlowTok{if}\NormalTok{ (journal }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(dics)) \{}
\NormalTok{          abb }\OtherTok{\textless{}{-}}\NormalTok{ dics[[ journal ]]}
\NormalTok{          ch[pos] }\OtherTok{\textless{}{-}} \FunctionTok{sub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\{.*}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{\}"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(}\StringTok{"\{"}\NormalTok{, abb, }\StringTok{"\}"}\NormalTok{), ch[pos])}
\NormalTok{        \} }\ControlFlowTok{else}\NormalTok{ \{}
          \FunctionTok{message}\NormalTok{(}\StringTok{"No journal abbrev: "}\NormalTok{, journal)}
\NormalTok{        \}}
\NormalTok{      \}}
\NormalTok{      pos }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{s*doi ="}\NormalTok{, ch)}
\NormalTok{      ch[ }\SpecialCharTok{!}\NormalTok{pos ]}
\NormalTok{    \})}
  \FunctionTok{writeLines}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(lst), savename)}
  \FunctionTok{return}\NormalTok{(savename)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}


\end{document}
