% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{caption} \captionsetup{font={footnotesize},width=6in} \renewcommand{\dblfloatpagefraction}{.9} \makeatletter \renewenvironment{figure} {\def\@captype{figure}} \makeatletter \definecolor{shadecolor}{RGB}{242,242,242} \usepackage{xeCJK} \usepackage{setspace} \setstretch{1.3}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={R codes of MCnebula},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{R codes of MCnebula}
\author{}
\date{\vspace{-2.5em}}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{3}
\tableofcontents
}
\hypertarget{file-annotate_child_nebula.r}{%
\section{File: annotate\_child\_nebula.R}\label{file-annotate_child_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title annotate\_child\_nebulae}
\CommentTok{\#\textquotesingle{} @description Visualization of structure, PPCP and statistic data in child{-}nebula.}
\CommentTok{\#\textquotesingle{} @param nebula\_name Character. The name of child{-}nebula.}
\CommentTok{\#\textquotesingle{} @param compound\_class\_list A list, generaged by \textasciigrave{}collate\_ppcp\textasciigrave{}, Default: .MCn.nebula\_class}
\CommentTok{\#\textquotesingle{} @param write\_output Logic. Write output to a directory, Default: T}
\CommentTok{\#\textquotesingle{} @param output Character, Default: paste0(.MCn.output, "/", .MCn.results)}
\CommentTok{\#\textquotesingle{} @param layout Character, \textquotesingle{}igraph\textquotesingle{} layout, Default: \textquotesingle{}fr\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param height A number, Default: \textquotesingle{}auto\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param width A number, Default: \textquotesingle{}auto\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param plot\_nodes\_id Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param plot\_structure Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param plot\_ppcp Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param ratio\_df A data.frame, Default: NA}
\CommentTok{\#\textquotesingle{} @param merge\_image Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param return\_plot Logic, Default: F}
\CommentTok{\#\textquotesingle{} @param nodes\_mark A is.data.frame, Default: NA}
\CommentTok{\#\textquotesingle{} @param global.node.size A number, Default: 0.6}
\CommentTok{\#\textquotesingle{} @param theme\_args A list, Default: NA}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{} @rdname annotate\_child\_nebulae}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr filter select rename mutate}
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\NormalTok{annotate\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{compound\_class\_list =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{nebula\_index =}\NormalTok{ .MCn.nebula\_index,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{height =} \StringTok{"auto"}\NormalTok{,}
           \AttributeTok{width =} \StringTok{"auto"}\NormalTok{,}
           \AttributeTok{plot\_nodes\_id =}\NormalTok{ T,}
           \AttributeTok{plot\_structure =}\NormalTok{ T,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ T,}
           \AttributeTok{ratio\_df =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{merge\_image =}\NormalTok{ T,}
           \AttributeTok{return\_plot =}\NormalTok{ F,}
           \AttributeTok{nodes\_mark =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{global.node.size =} \FloatTok{0.6}\NormalTok{,}
           \AttributeTok{theme\_args =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: annotate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# all nodes in graph}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}\SpecialCharTok{$}\StringTok{".id"}
    \DocumentationTok{\#\# get top compound class (nodes\_color data)}
    \DocumentationTok{\#\# as well as, collate metadata}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_class\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# as data.frame}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.id }\SpecialCharTok{\%in\%}\NormalTok{ nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# filter via nodes}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# mark nodes in color}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(nodes\_mark))\{}
      \DocumentationTok{\#\# the secound col as mark col}
      \FunctionTok{colnames}\NormalTok{(nodes\_mark) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"mark"}\NormalTok{)}
      \DocumentationTok{\#\# merge with metadata}
\NormalTok{      metadata }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, nodes\_mark, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{vis\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(mark), }\StringTok{"Others"}\NormalTok{, mark))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# push environment name into parent.env,}
    \DocumentationTok{\#\# let some data could be catch in sub{-}environment via \textquotesingle{}get\textquotesingle{} function}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# gather data for annotation (nebula\_name, hierarchy)}
\NormalTok{    hierarchy }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name), }\AttributeTok{n =} \DecValTok{1}\NormalTok{)}
\NormalTok{    anno }\OtherTok{=} \FunctionTok{c}\NormalTok{(}\AttributeTok{nebula\_index =}\NormalTok{ nebula\_name, }\AttributeTok{hierarchy =}\NormalTok{ hierarchy}\SpecialCharTok{$}\NormalTok{hierarchy)}
    \DocumentationTok{\#\# set a environment to store layout data}
\NormalTok{    envir\_layout }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{() }
    \DocumentationTok{\#\# set to remove nodes or not (set to 0, remove)}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{|}\NormalTok{ plot\_structure)\{}
\NormalTok{      remove\_nodes }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      remove\_nodes }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{    \}}
    \DocumentationTok{\#\# plot origin network (child network, with legend)}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{grid\_child\_nebula}\NormalTok{(.MCn.child\_graph\_list[[nebula\_name]],}
                           \AttributeTok{anno =}\NormalTok{ anno,}
                           \AttributeTok{class =}\NormalTok{ metadata,}
                           \AttributeTok{print\_into =}\NormalTok{ F,}
                           \AttributeTok{layout =}\NormalTok{ layout,}
                           \DocumentationTok{\#\# save layout data in this environment}
                           \AttributeTok{save\_layout\_df =}\NormalTok{ envir\_layout,}
                           \DocumentationTok{\#\# remove origin nodes}
                           \AttributeTok{remove\_nodes =}\NormalTok{ remove\_nodes, }
                           \AttributeTok{theme\_args =}\NormalTok{ theme\_args,}
\NormalTok{                           ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# whether plot pie diagram}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(ratio\_df))\{}
\NormalTok{      plot\_ratio }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      plot\_ratio }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# tmp dir}
\NormalTok{    tmp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"tmp"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tmp\_dir))\{}
      \FunctionTok{dir.create}\NormalTok{(tmp\_dir)}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# nodes id}
    \ControlFlowTok{if}\NormalTok{(plot\_nodes\_id  }\SpecialCharTok{\&} \SpecialCharTok{!}\NormalTok{plot\_ppcp)\{}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{geom\_node\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ name), }\AttributeTok{size =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# plot 2D structure, require ChemmineOB and ChemmineR}
\NormalTok{    with\_structure }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ChemmineOB"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
      \DocumentationTok{\#\# structure}
\NormalTok{      tmp\_stru }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"structure"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tmp\_stru))\{}
        \FunctionTok{dir.create}\NormalTok{(tmp\_stru)}
\NormalTok{      \}}
      \ControlFlowTok{if}\NormalTok{(plot\_structure)\{}
\NormalTok{        with\_structure }\OtherTok{\textless{}{-}} \DecValTok{1}
        \FunctionTok{batch\_mode\_structure}\NormalTok{(}\AttributeTok{metadata =}\NormalTok{ metadata, }\AttributeTok{tmp\_stru =}\NormalTok{ tmp\_stru)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# add annotation {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# re draw nodes with or without ppcp bar}
\NormalTok{    tmp\_ppcp }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"ppcp"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tmp\_ppcp))\{}
      \FunctionTok{dir.create}\NormalTok{(tmp\_ppcp)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{|}\NormalTok{ plot\_structure }\SpecialCharTok{|}\NormalTok{ plot\_ratio )\{}
      \FunctionTok{batch\_mode\_nodes}\NormalTok{(}
                       \AttributeTok{metadata =}\NormalTok{ metadata,}
                       \AttributeTok{tmp\_ppcp =}\NormalTok{ tmp\_ppcp,}
                       \AttributeTok{with\_structure =}\NormalTok{ with\_structure,}
                       \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
                       \AttributeTok{plot\_ratio =}\NormalTok{ plot\_ratio,}
                       \AttributeTok{ratio\_df =}\NormalTok{ ratio\_df,}
\NormalTok{                       ...)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# merge image}
    \ControlFlowTok{if}\NormalTok{(merge\_image)\{}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ggimage"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T) }\SpecialCharTok{\&}
         \FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"gridExtra"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
        \DocumentationTok{\#\# remove legend of size}
\NormalTok{        p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{guides}\NormalTok{(}\AttributeTok{size =} \StringTok{"none"}\NormalTok{)}
        \FunctionTok{merge\_image}\NormalTok{(p, envir\_layout}\SpecialCharTok{$}\NormalTok{layout\_n, tmp\_ppcp, }
                    \AttributeTok{global.node.size =}\NormalTok{ global.node.size)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# write\_output \#\# estimate width}
    \ControlFlowTok{if}\NormalTok{(write\_output)\{}
      \ControlFlowTok{if}\NormalTok{(height }\SpecialCharTok{==} \StringTok{"auto"} \SpecialCharTok{|}\NormalTok{ width }\SpecialCharTok{==} \StringTok{"auto"}\NormalTok{)\{}
        \DocumentationTok{\#\# estimate width upon legend number of \textquotesingle{}fill\textquotesingle{}}
\NormalTok{        n }\OtherTok{=} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(metadata}\SpecialCharTok{$}\NormalTok{vis\_class))}
\NormalTok{        height }\OtherTok{=} \DecValTok{8}
\NormalTok{        width }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{17}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DocumentationTok{\#\# \textquotesingle{}class\textquotesingle{} less than 17}
                       \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{34}\NormalTok{, }\FloatTok{12.5}\NormalTok{,}
                              \FunctionTok{ifelse}\NormalTok{(n }\SpecialCharTok{\textless{}=} \DecValTok{51}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{18}\NormalTok{)))}
\NormalTok{      \}}
      \DocumentationTok{\#\# output}
      \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, nebula\_name, }\StringTok{"\_graph.svg"}\NormalTok{),}
             \AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{rm}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: annotate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(return\_plot)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{gather\_subview }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           subview,}
\NormalTok{           x,}
\NormalTok{           y,}
\NormalTok{           width,}
\NormalTok{           height,}
           \AttributeTok{p =} \FunctionTok{get}\NormalTok{(}\StringTok{"p"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+}\NormalTok{ ggimage}\SpecialCharTok{::}\FunctionTok{geom\_subview}\NormalTok{(}\AttributeTok{x =}\NormalTok{ x, }\AttributeTok{y =}\NormalTok{ y, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height,}
                          \AttributeTok{subview =}\NormalTok{ subview)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"p"}\NormalTok{, p, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
    \DocumentationTok{\#\#}
\NormalTok{  \}}
\NormalTok{merge\_image }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           p, }\DocumentationTok{\#\# ggplot2 object}
\NormalTok{           layout\_n,}
\NormalTok{           tmp\_ppcp,}
           \AttributeTok{global.node.size =} \DecValTok{1}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# check svg image}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(layout\_n, x, y, name, tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{nodes\_path =} \FunctionTok{paste0}\NormalTok{(tmp\_ppcp, }\StringTok{"/"}\NormalTok{, name, }\StringTok{".svg"}\NormalTok{),}
                    \AttributeTok{check\_nodes =} \FunctionTok{file.exists}\NormalTok{(nodes\_path)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(check\_nodes }\SpecialCharTok{==}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# read\_cairo\_svg:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(df), }\StringTok{"(number)}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# read svg image}
\NormalTok{    subview\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{name, base\_read\_cairo,}
                                      \AttributeTok{path =}\NormalTok{ tmp\_ppcp, }
\NormalTok{                                      ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# calculate width and height for subview, according to attributes of tanimotoSimilarity}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df,}
                        \AttributeTok{width =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{==}\NormalTok{ T, }\DecValTok{1}\NormalTok{,}
                                       \DecValTok{1} \SpecialCharTok{+}\NormalTok{ tanimotoSimilarity) }\SpecialCharTok{*}\NormalTok{ global.node.size,}
                        \AttributeTok{height =}\NormalTok{ width)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# as subview }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Advance visualization: gather\_subview}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(gather\_subview, }\DocumentationTok{\#\# function}
\NormalTok{                      subview\_list,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{x,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{y,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{width,}
\NormalTok{                      df}\SpecialCharTok{$}\NormalTok{height}
\NormalTok{    )}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-batch_mode_nodes.r}{%
\section{File: batch\_mode\_nodes.R}\label{file-batch_mode_nodes.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{batch\_mode\_nodes }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metadata,}
\NormalTok{           tmp\_ppcp,}
           \AttributeTok{with\_structure =} \DecValTok{0}\NormalTok{,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
           \AttributeTok{plot\_ratio =}\NormalTok{ F,}
           \AttributeTok{ratio\_df =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
           \AttributeTok{palette\_stat =}\NormalTok{ .MCn.palette\_stat,}
           \AttributeTok{annotate\_ppcp.class.id =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# remove exist files}
    \FunctionTok{lapply}\NormalTok{(}\FunctionTok{list.files}\NormalTok{(tmp\_ppcp, }\AttributeTok{full.names =}\NormalTok{ T), file.remove)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# nodes color setting, which parallel to the nodes color in plot of visualize\_child\_nebula function}
\NormalTok{    meta\_color }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(metadata, vis\_class) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(vis\_class)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.vector}\NormalTok{(}\FunctionTok{attr}\NormalTok{(palette, }\StringTok{"name"}\NormalTok{)))\{}
      \DocumentationTok{\#\# filter palette}
\NormalTok{      palette }\OtherTok{\textless{}{-}}\NormalTok{ palette[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette) }\SpecialCharTok{\%in\%}\NormalTok{ meta\_color}\SpecialCharTok{$}\NormalTok{vis\_class)]}
      \DocumentationTok{\#\# sort according to the order of \textquotesingle{}vis\_class\textquotesingle{}}
\NormalTok{      palette }\OtherTok{\textless{}{-}}\NormalTok{ palette[}\FunctionTok{order}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette), }\AttributeTok{levels =}\NormalTok{ meta\_color}\SpecialCharTok{$}\NormalTok{vis\_class)]}
      \DocumentationTok{\#\# set color}
\NormalTok{      meta\_color}\SpecialCharTok{$}\NormalTok{nodes\_color }\OtherTok{\textless{}{-}}\NormalTok{ palette}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      meta\_color}\SpecialCharTok{$}\NormalTok{nodes\_color }\OtherTok{\textless{}{-}}\NormalTok{ palette[}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(meta\_color)]}
\NormalTok{    \}}
    \DocumentationTok{\#\# gather color data}
\NormalTok{    meta\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, meta\_color, }\AttributeTok{by =} \StringTok{"vis\_class"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# pick ppcp\_dataset}
\NormalTok{    ppcp\_dataset }\OtherTok{=}\NormalTok{ .MCn.ppcp\_dataset[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(.MCn.ppcp\_dataset) }\SpecialCharTok{\%in\%}\NormalTok{ meta\_nodes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)]}
    \DocumentationTok{\#\# sort data}
\NormalTok{    meta\_nodes}\SpecialCharTok{$}\StringTok{".id"} \OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(meta\_nodes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                              \AttributeTok{levels =} \FunctionTok{names}\NormalTok{(ppcp\_dataset))}
\NormalTok{    meta\_nodes }\OtherTok{\textless{}{-}}\NormalTok{ meta\_nodes[}\FunctionTok{order}\NormalTok{(meta\_nodes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{), ]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# ratio\_df, extra peak area data}
    \ControlFlowTok{if}\NormalTok{(plot\_ratio)\{}
      \DocumentationTok{\#\# adjust palette\_stat}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette\_stat)[}\DecValTok{1}\NormalTok{]))\{}
\NormalTok{        palette\_stat }\OtherTok{\textless{}{-}}\NormalTok{ palette\_stat[}\FunctionTok{names}\NormalTok{(palette\_stat) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(ratio\_df)]}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{        palette\_stat[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{ncol}\NormalTok{(ratio\_df)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)]}
\NormalTok{      \}}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df, }\AttributeTok{.id =} \FunctionTok{as.character}\NormalTok{(.id))}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(meta\_nodes, .id), ratio\_df, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
      \DocumentationTok{\#\# get list data}
\NormalTok{      ratio\_df\_list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(ratio\_df, }\StringTok{".id"}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ratio\_df\_list }\OtherTok{\textless{}{-}} \FunctionTok{rep}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_nodes))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# annotate\_child\_nebulae: batch\_mode\_nodes}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(base\_vis\_nodes, }\CommentTok{\# function}
\NormalTok{                      ppcp\_dataset, }\CommentTok{\# main 1}
\NormalTok{                      meta\_nodes}\SpecialCharTok{$}\NormalTok{nodes\_color, }\CommentTok{\# main 2}
                      \FunctionTok{names}\NormalTok{(ppcp\_dataset), }\CommentTok{\# main 3, key\_id}
\NormalTok{                      ratio\_df\_list, }\CommentTok{\# main 4, draw pie diagram}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}
                                      \AttributeTok{path =} \FunctionTok{normalizePath}\NormalTok{(tmp\_ppcp),}
                                      \AttributeTok{with\_structure =}\NormalTok{ with\_structure,}
                                      \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
                                      \AttributeTok{plot\_ratio =}\NormalTok{ plot\_ratio,}
                                      \AttributeTok{palette\_stat =}\NormalTok{ palette\_stat,}
                                      \AttributeTok{annotate\_ppcp.class.id =}\NormalTok{ annotate\_ppcp.class.id,}
\NormalTok{                                      ...))}
\NormalTok{  \}}
\DocumentationTok{\#\# function mannually draw nodes}
\NormalTok{base\_vis\_nodes }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           ppcp, }\DocumentationTok{\#\# main 1}
\NormalTok{           nodes\_color, }\DocumentationTok{\#\# main 2}
           \AttributeTok{key\_id =} \ConstantTok{NA}\NormalTok{, }\DocumentationTok{\#\# main 3}
           \AttributeTok{ratio\_df =} \ConstantTok{NA}\NormalTok{, }\DocumentationTok{\#\# main 4, draw pie diagram}
           \AttributeTok{plot\_ratio =}\NormalTok{ F,}
           \AttributeTok{plot\_nodes\_id =}\NormalTok{ T,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ T,}
           \AttributeTok{label\_color =} \StringTok{"black"}\NormalTok{,}
           \AttributeTok{with\_structure =} \DecValTok{0}\NormalTok{,}
           \AttributeTok{path =} \StringTok{"."}\NormalTok{,}
           \AttributeTok{class\_index =} \FunctionTok{unique}\NormalTok{(.MCn.nebula\_index}\SpecialCharTok{$}\NormalTok{relativeIndex),}
           \AttributeTok{palette\_ppcp =} \FunctionTok{colorRampPalette}\NormalTok{(.MCn.palette\_ppcp)(}\FunctionTok{length}\NormalTok{(class\_index)),}
           \AttributeTok{palette\_stat =}\NormalTok{ .MCn.palette\_stat,}
           \AttributeTok{annotate\_ppcp.class.id =}\NormalTok{ F,}
           \AttributeTok{size\_adjust =} \FloatTok{0.7}\NormalTok{,}
           \AttributeTok{get\_ppcp\_legend =}\NormalTok{ F}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# filter via class\_index}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}}\NormalTok{ ppcp[ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ class\_index, ]}
    \DocumentationTok{\#\# as factor, for painting color}
\NormalTok{    ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex }\OtherTok{\textless{}{-}} \FunctionTok{factor}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex, }\AttributeTok{levels =} \FunctionTok{sort}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex))}
\NormalTok{    ppcp}\SpecialCharTok{$}\NormalTok{num }\OtherTok{\textless{}{-}} \FunctionTok{seq}\NormalTok{(}\DecValTok{1}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(ppcp))}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      ppcp}\SpecialCharTok{$}\NormalTok{V1 }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# plot nodes }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(ppcp, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ num, }\AttributeTok{y =}\NormalTok{ V1)) }\SpecialCharTok{+}
      \DocumentationTok{\#\# nodes color}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ nodes\_color,}
                           \FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\AttributeTok{ymax =} \DecValTok{0}\NormalTok{,}
                               \AttributeTok{x =} \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
                                          \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \FunctionTok{nrow}\NormalTok{(ppcp), num }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, num)))) }\SpecialCharTok{+}
      \DocumentationTok{\#\# border color}
      \FunctionTok{geom\_ribbon}\NormalTok{(}\AttributeTok{fill =} \StringTok{"black"}\NormalTok{,}
                           \FunctionTok{aes}\NormalTok{(}\AttributeTok{ymin =} \DecValTok{0}\NormalTok{, }\AttributeTok{ymax =} \FloatTok{1.1}\NormalTok{,}
                               \AttributeTok{x =} \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{,}
                                          \FunctionTok{ifelse}\NormalTok{(num }\SpecialCharTok{==} \FunctionTok{nrow}\NormalTok{(ppcp), num }\SpecialCharTok{+} \DecValTok{1}\NormalTok{, num)))) }\SpecialCharTok{+}
        \DocumentationTok{\#\# ppcp bar plot}
        \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{alpha =} \DecValTok{1}\NormalTok{, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{fill =}\NormalTok{ relativeIndex), }\AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{size =} \FloatTok{0.25}\NormalTok{) }\SpecialCharTok{+}
        \DocumentationTok{\#\# nodes border ratio}
        \FunctionTok{ylim}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{5}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\SpecialCharTok{+}
        \DocumentationTok{\#\# Polar coordinate transformation}
        \FunctionTok{coord\_polar}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# draw pie diagram}
    \ControlFlowTok{if}\NormalTok{(plot\_ratio)\{}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(ratio\_df, }\AttributeTok{id.vars =} \StringTok{".id"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"group"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"value"}\NormalTok{)}
      \DocumentationTok{\#\# mutate NA as 0}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df, }\AttributeTok{value =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(value), }\DecValTok{0}\NormalTok{, value))}
      \DocumentationTok{\#\# value stack}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df,}
                                \AttributeTok{xend =} \FunctionTok{stack\_sum}\NormalTok{(ratio\_df}\SpecialCharTok{$}\NormalTok{value),}
                                \AttributeTok{x =} \FunctionTok{stack\_sum}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{, ratio\_df}\SpecialCharTok{$}\NormalTok{value[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(ratio\_df)}\SpecialCharTok{{-}}\DecValTok{1}\NormalTok{)])))}
      \DocumentationTok{\#\# normalize x axis range and x value}
\NormalTok{      n\_factor }\OtherTok{=}\NormalTok{ (}\FunctionTok{max}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{num) }\SpecialCharTok{+} \DecValTok{1}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{max}\NormalTok{(ratio\_df}\SpecialCharTok{$}\NormalTok{xend)}
\NormalTok{      ratio\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(ratio\_df,}
                         \AttributeTok{midd =}\NormalTok{ (x }\SpecialCharTok{+}\NormalTok{ value}\SpecialCharTok{/}\DecValTok{2}\NormalTok{) }\SpecialCharTok{*}\NormalTok{ n\_factor,}
                         \AttributeTok{width =}\NormalTok{ value }\SpecialCharTok{*}\NormalTok{ n\_factor)}
      \DocumentationTok{\#\# add pie plot into ggplot2 project}
      \FunctionTok{names}\NormalTok{(palette\_ppcp) }\OtherTok{\textless{}{-}}\NormalTok{ class\_index}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{geom\_tile}\NormalTok{(}\AttributeTok{data =}\NormalTok{ ratio\_df, }\AttributeTok{size =} \FloatTok{0.2}\NormalTok{, }\AttributeTok{color =} \StringTok{"white"}\NormalTok{,}
                         \FunctionTok{aes}\NormalTok{(}\AttributeTok{y =} \SpecialCharTok{{-}}\FloatTok{2.5}\NormalTok{, }\AttributeTok{x =}\NormalTok{ midd, }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =} \FloatTok{2.5}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ group)) }\SpecialCharTok{+}
        \DocumentationTok{\#\# add \textquotesingle{}fill\textquotesingle{} palette}
        \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =} \FunctionTok{c}\NormalTok{(palette\_ppcp, palette\_stat))}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \DocumentationTok{\#\# add \textquotesingle{}fill\textquotesingle{} palette}
      \FunctionTok{names}\NormalTok{(palette\_ppcp) }\OtherTok{\textless{}{-}}\NormalTok{ class\_index}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette\_ppcp)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# add ppcp class name id}
    \ControlFlowTok{if}\NormalTok{(annotate\_ppcp.class.id)\{}
      \DocumentationTok{\#\# label metadata}
\NormalTok{      label\_data }\OtherTok{\textless{}{-}}\NormalTok{ ppcp}
      \DocumentationTok{\#\# calculate angle in circle}
\NormalTok{      angle }\OtherTok{\textless{}{-}}  \DecValTok{90} \SpecialCharTok{{-}} \DecValTok{360} \SpecialCharTok{*}\NormalTok{ ((}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(label\_data)) }\SpecialCharTok{{-}} \FloatTok{0.5}\NormalTok{) }\SpecialCharTok{/} \FunctionTok{nrow}\NormalTok{(label\_data)}
      \DocumentationTok{\#\# flip}
\NormalTok{      label\_data}\SpecialCharTok{$}\NormalTok{angle }\OtherTok{\textless{}{-}} \FunctionTok{ifelse}\NormalTok{(angle }\SpecialCharTok{\textless{}}\NormalTok{ (}\SpecialCharTok{{-}}\DecValTok{90}\NormalTok{), angle }\SpecialCharTok{+} \DecValTok{180}\NormalTok{, angle)}
      \DocumentationTok{\#\# mapped into plot}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{geom\_text}\NormalTok{(}\AttributeTok{data =}\NormalTok{ label\_data,}
                         \FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ num, }\AttributeTok{y =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{label =}\NormalTok{ relativeIndex, }\AttributeTok{angle =}\NormalTok{ angle), }
                         \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fontface =} \StringTok{"bold"}\NormalTok{, }\AttributeTok{alpha =} \FloatTok{0.8}\NormalTok{,}
                         \AttributeTok{size =} \DecValTok{2}\NormalTok{, }\AttributeTok{inherit.aes =} \ConstantTok{FALSE}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# add theme}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{mc.blank\_theme}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate Graphics Device}
\NormalTok{    savepath }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
\NormalTok{    svglite}\SpecialCharTok{::}\FunctionTok{svglite}\NormalTok{(savepath, }\AttributeTok{bg =} \StringTok{"transparent"}\NormalTok{)}
    \DocumentationTok{\#\# print nodes }
    \FunctionTok{print}\NormalTok{(p)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# print structure or not}
    \ControlFlowTok{if}\NormalTok{(with\_structure }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      s\_file }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\FunctionTok{normalizePath}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/../structure"}\NormalTok{)), }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(s\_file))\{}
        \DocumentationTok{\#\# via grImport2 import Cairo svg}
\NormalTok{        ps }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(}\AttributeTok{file =}\NormalTok{ s\_file)}
        \DocumentationTok{\#\# grid draw}
\NormalTok{        grImport2}\SpecialCharTok{::}\FunctionTok{grid.picture}\NormalTok{(ps, }\AttributeTok{width =}\NormalTok{ size\_adjust, }\AttributeTok{height =}\NormalTok{ size\_adjust)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# grid nodes ID in nodes }
    \ControlFlowTok{if}\NormalTok{(plot\_nodes\_id)\{}
      \DocumentationTok{\#\# a grid object}
\NormalTok{      ps }\OtherTok{\textless{}{-}}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{textGrob}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"ID:"}\NormalTok{, key\_id),}
                           \AttributeTok{y =} \FloatTok{0.25}\NormalTok{,}
                           \AttributeTok{gp =}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{gpar}\NormalTok{(}\AttributeTok{fontfamily =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{fontsize =} \DecValTok{20}\NormalTok{, }\AttributeTok{col =}\NormalTok{ label\_color))}
\NormalTok{      grid}\SpecialCharTok{::}\FunctionTok{grid.draw}\NormalTok{(ps)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{dev.off}\NormalTok{()}
    \CommentTok{\# as cairo svg}
\NormalTok{    rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(savepath, savepath)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get ppcp legend}
    \ControlFlowTok{if}\NormalTok{(get\_ppcp\_legend)\{}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ggpubr"}\NormalTok{, }\AttributeTok{quietly =} \ConstantTok{TRUE}\NormalTok{))\{}
        \DocumentationTok{\#\# select the corresponding palette}
\NormalTok{        palette\_ppcp }\OtherTok{\textless{}{-}}\NormalTok{ palette\_ppcp[}\FunctionTok{names}\NormalTok{(palette\_ppcp) }\SpecialCharTok{\%in\%}\NormalTok{ ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex]}
        \DocumentationTok{\#\# order according to label}
\NormalTok{        palette\_ppcp }\OtherTok{\textless{}{-}}\NormalTok{ palette\_ppcp[}\FunctionTok{order}\NormalTok{(}\FunctionTok{factor}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette\_ppcp), }\AttributeTok{levels =}\NormalTok{ ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex))]}
        \DocumentationTok{\#\# get class name metadata}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.class\_tree\_data[, }\FunctionTok{c}\NormalTok{(}\StringTok{"relativeIndex"}\NormalTok{, }\StringTok{"name"}\NormalTok{)]}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{relativeIndex }\OtherTok{\textless{}{-}} \FunctionTok{as.factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{relativeIndex)}
        \DocumentationTok{\#\# merge to get class name}
\NormalTok{        ppcp }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(ppcp, df, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F)}
        \DocumentationTok{\#\# paste merge relativeIndex and name}
\NormalTok{        ppcp}\SpecialCharTok{$}\NormalTok{name }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{relativeIndex, }\StringTok{": "}\NormalTok{, ppcp}\SpecialCharTok{$}\NormalTok{name)}
\NormalTok{        ppcp}\SpecialCharTok{$}\NormalTok{name }\OtherTok{\textless{}{-}}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(ppcp}\SpecialCharTok{$}\NormalTok{name, }\AttributeTok{width =} \DecValTok{30}\NormalTok{)}
        \DocumentationTok{\#\# rename palette}
        \FunctionTok{names}\NormalTok{(palette\_ppcp) }\OtherTok{\textless{}{-}}\NormalTok{ ppcp}\SpecialCharTok{$}\NormalTok{name}
        \DocumentationTok{\#\# draw legend}
\NormalTok{        legend }\OtherTok{\textless{}{-}} \FunctionTok{ggplot}\NormalTok{(ppcp, }\FunctionTok{aes}\NormalTok{(}\AttributeTok{x =}\NormalTok{ num, }\AttributeTok{y =}\NormalTok{ V1, }\AttributeTok{fill =}\NormalTok{ name)) }\SpecialCharTok{+}
          \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
          \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"Structural classes"}\NormalTok{) }\SpecialCharTok{+}
          \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
          \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette\_ppcp) }\SpecialCharTok{+}
          \FunctionTok{theme}\NormalTok{(}\AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
                \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{0.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{)}
\NormalTok{          )}
\NormalTok{        legend }\OtherTok{\textless{}{-}}\NormalTok{ ggpubr}\SpecialCharTok{::}\FunctionTok{get\_legend}\NormalTok{(legend)}
\NormalTok{        legend }\OtherTok{\textless{}{-}}\NormalTok{ ggpubr}\SpecialCharTok{::}\FunctionTok{as\_ggplot}\NormalTok{(legend)}
        \FunctionTok{ggsave}\NormalTok{(legend, }\AttributeTok{filename =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, }\StringTok{"legend\_"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{), }\AttributeTok{width =} \DecValTok{15}\NormalTok{, }\AttributeTok{height =} \DecValTok{10}\NormalTok{)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{  \}}
\DocumentationTok{\#\# function read cairo svg}
\NormalTok{base\_read\_cairo }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           path,}
           \AttributeTok{suffix =} \StringTok{".svg"}
\NormalTok{           )\{}
\NormalTok{    prefix }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ grImport2}\SpecialCharTok{::}\FunctionTok{grobify}\NormalTok{(grImport2}\SpecialCharTok{::}\FunctionTok{readPicture}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, suffix)))}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ gridExtra}\SpecialCharTok{::}\FunctionTok{arrangeGrob}\NormalTok{(svg)}
    \FunctionTok{return}\NormalTok{(svg)}
\NormalTok{  \}}
\NormalTok{stack\_sum }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector}
\NormalTok{           )\{}
\NormalTok{    stack }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
    \ControlFlowTok{for}\NormalTok{(i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(vector))\{}
\NormalTok{      stack[i] }\OtherTok{\textless{}{-}} \FunctionTok{sum}\NormalTok{(vector[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{i])}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(stack)}
\NormalTok{  \}}
\NormalTok{mc.blank\_theme }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{legend.position =} \StringTok{"none"}
\NormalTok{           )\{}
    \FunctionTok{theme\_minimal}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \DocumentationTok{\#\# remove legend}
            \AttributeTok{legend.position =}\NormalTok{ legend.position,}
            \AttributeTok{panel.border =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{plot.margin =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{panel.spacing =}\FunctionTok{unit}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{,}\DecValTok{0}\NormalTok{),}\StringTok{"cm"}\NormalTok{)}
\NormalTok{      )}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-batch_mode_structure.r}{%
\section{File: batch\_mode\_structure.R}\label{file-batch_mode_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{batch\_mode\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           metadata,}
\NormalTok{           tmp\_stru}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# collate metadata}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(metadata,}
                               \AttributeTok{stru\_file =} \FunctionTok{paste0}\NormalTok{(tmp\_stru, }\StringTok{"/"}\NormalTok{, .id, }\StringTok{".svg"}\NormalTok{),}
                               \AttributeTok{stru\_check =} \FunctionTok{file.exists}\NormalTok{(stru\_file))}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(meta\_stru, .MCn.structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"smiles"}\NormalTok{)], }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_stru, }\FunctionTok{is.na}\NormalTok{(smiles) }\SpecialCharTok{==}\NormalTok{ F)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of structure set:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_stru), }\StringTok{"(compounds with structure)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(metadata), }\StringTok{"(all compounds)"}\NormalTok{),}
        \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    meta\_stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_stru, stru\_check }\SpecialCharTok{==}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_stru) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(}
\NormalTok{                        base\_vis\_structure, }\CommentTok{\# function}
\NormalTok{                        meta\_stru}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\CommentTok{\# key\_id}
\NormalTok{                        meta\_stru}\SpecialCharTok{$}\NormalTok{smiles, }\CommentTok{\# smiles}
                        \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{( }\AttributeTok{path =} \FunctionTok{normalizePath}\NormalTok{(tmp\_stru) ))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{base\_vis\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           smiles,}
\NormalTok{           path,}
           \AttributeTok{to\_file =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, key\_id, }\StringTok{".svg"}\NormalTok{)}
\NormalTok{           )\{}
    \DocumentationTok{\#\# openbabal. only support for linux}
\NormalTok{    ChemmineOB}\SpecialCharTok{::}\FunctionTok{convertToImage}\NormalTok{(}\StringTok{"SMI"}\NormalTok{, }\StringTok{"SVG"}\NormalTok{, }\AttributeTok{source =}\NormalTok{ smiles, }\AttributeTok{toFile =}\NormalTok{ to\_file)}
    \DocumentationTok{\#\# as transparent bg}
\NormalTok{    svg }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{file =}\NormalTok{ to\_file, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{quote =}\StringTok{""}\NormalTok{, }\AttributeTok{header =}\NormalTok{ F)}
\NormalTok{    svg}\SpecialCharTok{$}\NormalTok{V1 }\OtherTok{=} \FunctionTok{sub}\NormalTok{(}\StringTok{\textquotesingle{}fill="white"\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fill="transparent"\textquotesingle{}}\NormalTok{, svg}\SpecialCharTok{$}\NormalTok{V1)}
    \FunctionTok{write.table}\NormalTok{(}\AttributeTok{x =}\NormalTok{ svg, }\AttributeTok{file =}\NormalTok{ to\_file, }\AttributeTok{sep =} \StringTok{""}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ F, }\AttributeTok{row.names =}\NormalTok{ F, }\AttributeTok{quote =}\NormalTok{ F)}
    \DocumentationTok{\#\# convert as cairo svg}
\NormalTok{    rsvg}\SpecialCharTok{::}\FunctionTok{rsvg\_svg}\NormalTok{(to\_file, to\_file)}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.annotate_node.r}{%
\section{File: beta.annotate\_node.R}\label{file-beta.annotate_node.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annotate\_node }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           node\_id,}
           \AttributeTok{compound\_class\_list =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{plot\_nodes\_id =}\NormalTok{ T,}
           \AttributeTok{plot\_structure =}\NormalTok{ T,}
           \AttributeTok{plot\_ppcp =}\NormalTok{ T,}
           \AttributeTok{ratio\_df =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{nodes\_mark =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{annotate\_ppcp.class.id =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ node\_id}
    \DocumentationTok{\#\# get top compound class (nodes\_color data)}
    \DocumentationTok{\#\# as well as, collate metadata}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_class\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# as data.frame}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.id }\SpecialCharTok{\%in\%}\NormalTok{ nodes) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# filter via nodes}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# mark nodes in color}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(nodes\_mark))\{}
      \DocumentationTok{\#\# the secound col as mark col}
      \FunctionTok{colnames}\NormalTok{(nodes\_mark) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"mark"}\NormalTok{)}
      \DocumentationTok{\#\# merge with metadata}
\NormalTok{      metadata }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, nodes\_mark, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{vis\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(mark), }\StringTok{"Others"}\NormalTok{, mark))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(ratio\_df))\{}
\NormalTok{      plot\_ratio }\OtherTok{\textless{}{-}}\NormalTok{ T}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      plot\_ratio }\OtherTok{\textless{}{-}}\NormalTok{ F}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    tmp\_dir }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"tmp"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# plot 2D structure, require ChemmineOB and ChemmineR}
\NormalTok{    with\_structure }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{requireNamespace}\NormalTok{(}\StringTok{"ChemmineOB"}\NormalTok{, }\AttributeTok{quietly =}\NormalTok{ T))\{}
      \DocumentationTok{\#\# structure}
\NormalTok{      tmp\_stru }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"structure"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(tmp\_stru))\{}
        \FunctionTok{dir.create}\NormalTok{(tmp\_stru)}
\NormalTok{      \}}
      \ControlFlowTok{if}\NormalTok{(plot\_structure)\{}
\NormalTok{        with\_structure }\OtherTok{\textless{}{-}} \DecValTok{1}
        \FunctionTok{batch\_mode\_structure}\NormalTok{(}\AttributeTok{metadata =}\NormalTok{ metadata, }\AttributeTok{tmp\_stru =}\NormalTok{ tmp\_stru)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    tmp\_ppcp }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"ppcp"}\NormalTok{)}
    \DocumentationTok{\#\# draw nodes with class id number}
    \ControlFlowTok{if}\NormalTok{(plot\_ppcp }\SpecialCharTok{|}\NormalTok{ plot\_structure }\SpecialCharTok{|}\NormalTok{ plot\_ratio )\{}
      \FunctionTok{do.call}\NormalTok{(batch\_mode\_nodes, }\FunctionTok{list}\NormalTok{(}\AttributeTok{metadata =}\NormalTok{ metadata,}
                                     \AttributeTok{tmp\_ppcp =}\NormalTok{ tmp\_ppcp,}
                                     \AttributeTok{with\_structure =}\NormalTok{ with\_structure,}
                                     \AttributeTok{plot\_ppcp =}\NormalTok{ plot\_ppcp,}
                                     \AttributeTok{plot\_ratio =}\NormalTok{ plot\_ratio,}
                                     \AttributeTok{ratio\_df =}\NormalTok{ ratio\_df,}
                                     \AttributeTok{annotate\_ppcp.class.id =}\NormalTok{ annotate\_ppcp.class.id,}
                                     \AttributeTok{get\_ppcp\_legend =}\NormalTok{ T,}
\NormalTok{                                     ...))}
\NormalTok{      filepath }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(tmp\_ppcp, }\StringTok{"/"}\NormalTok{, node\_id, }\StringTok{".svg"}\NormalTok{)}
      \DocumentationTok{\#\# mv file}
      \FunctionTok{file.copy}\NormalTok{(filepath, output)}
      \FunctionTok{file.copy}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(tmp\_ppcp, }\StringTok{"/legend\_"}\NormalTok{, node\_id, }\StringTok{".svg"}\NormalTok{), output)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.call_fun_mc.space.r}{%
\section{File: beta.call\_fun\_mc.space.R}\label{file-beta.call_fun_mc.space.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# set some empty var to local to storage var}
\NormalTok{call\_fun\_mc.space }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           FUN,}
\NormalTok{           args,}
           \AttributeTok{clear\_start =}\NormalTok{ T,}
           \AttributeTok{clear\_end =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    local }\OtherTok{\textless{}{-}} \FunctionTok{environment}\NormalTok{()}
    \ControlFlowTok{if}\NormalTok{(clear\_start)\{}
      \FunctionTok{rm\_mc.set}\NormalTok{(}\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(local))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    overall\_set }\OtherTok{\textless{}{-}} \FunctionTok{get\_mc.global\_meta}\NormalTok{()}
\NormalTok{    set }\OtherTok{\textless{}{-}}\NormalTok{ overall\_set[}\FunctionTok{names}\NormalTok{(overall\_set) }\SpecialCharTok{==}\NormalTok{ FUN]}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(set, }\AttributeTok{use.names =}\NormalTok{ F) }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{lapply}\NormalTok{(set, }\ControlFlowTok{function}\NormalTok{(var)\{}
             \FunctionTok{assign}\NormalTok{(var, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(local))}
\NormalTok{    \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(}\FunctionTok{match.fun}\NormalTok{(FUN), args)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    res }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(local), }\AttributeTok{results =}\NormalTok{ res)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(clear\_end)\{}
      \FunctionTok{rm\_mc.set}\NormalTok{(}\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(local))}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(res)}
\NormalTok{  \}}
\NormalTok{get\_mc.global\_meta }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{()\{}
\NormalTok{    overall\_set }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\AttributeTok{build\_classes\_tree\_list =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.class\_tree\_list"}\NormalTok{),}
                        \AttributeTok{collate\_ppcp =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.ppcp\_dataset"}\NormalTok{,}
                                         \StringTok{".MCn.class\_tree\_data"}\NormalTok{,}
                                         \StringTok{".MCn.nebula\_class"}\NormalTok{,}
                                         \StringTok{".MCn.nebula\_index"}\NormalTok{),}
                        \AttributeTok{collate\_structure =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.formula\_set"}\NormalTok{,}
                                              \StringTok{".MCn.structure\_set"}\NormalTok{),}
                        \AttributeTok{generate\_child\_nebulae =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.child\_graph\_list"}\NormalTok{),}
                        \AttributeTok{generate\_parent\_nebula =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.parent\_graph"}\NormalTok{,}
                                                   \StringTok{".MCn.parent\_nodes"}\NormalTok{,}
                                                   \StringTok{".MCn.parent\_edges"}\NormalTok{),}
                        \AttributeTok{initialize\_mcnebula =} \FunctionTok{c}\NormalTok{(}\StringTok{".MCn.sirius"}\NormalTok{,}
                                                \StringTok{".MCn.output"}\NormalTok{,}
                                                \StringTok{".MCn.results"}\NormalTok{,}
                                                \StringTok{".MCn.palette"}\NormalTok{,}
                                                \StringTok{".MCn.palette\_stat"}\NormalTok{,}
                                                \StringTok{".MCn.palette\_ppcp"}\NormalTok{,}
                                                \StringTok{".MCn.palette\_label"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{(overall\_set)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.classyfire.batch_get_classification.r}{%
\section{File: beta.classyfire.batch\_get\_classification.R}\label{file-beta.classyfire.batch_get_classification.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# classyfire curl classification}
\NormalTok{batch\_get\_classification }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           dir\_pubchem,}
\NormalTok{           dir\_classyfire,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir\_classyfire, }\StringTok{"/"}\NormalTok{, }\StringTok{"class.rdata"}\NormalTok{)}
\NormalTok{    classes }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    inchikey2d }\OtherTok{\textless{}{-}}\NormalTok{ inchikey2d[}\SpecialCharTok{!}\NormalTok{inchikey2d }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(classes)]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(inchikey2d) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    inchikey\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(dir\_pubchem, }\StringTok{"/"}\NormalTok{, }\StringTok{"inchikey.rdata"}\NormalTok{), inchikey2d)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(inchikey\_set, }\ControlFlowTok{function}\NormalTok{(df)\{}
                     \ControlFlowTok{if}\NormalTok{(}\StringTok{"InChIKey"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(df))}
                       \FunctionTok{return}\NormalTok{(df)}
                     \FunctionTok{return}\NormalTok{()}
\NormalTok{           \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get classyfire classification}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{inchikey2d =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(InChIKey, }\StringTok{"\^{}[A{-}Z]\{1,\}"}\NormalTok{))}
    \DocumentationTok{\#\# use the function which writed based on classyfireR::get\_classification}
    \FunctionTok{auto\_classyfire}\NormalTok{(df, dir\_classyfire, ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather classes}
    \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir\_classyfire, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z]\{14\}$"}\NormalTok{, }\AttributeTok{rdata =} \StringTok{"class.rdata"}\NormalTok{, }\AttributeTok{extra =}\NormalTok{ classes)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{auto\_classyfire }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           dir\_classyfire,}
           \AttributeTok{classyfire\_cl =} \ConstantTok{NULL}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# create access log}
\NormalTok{    log\_file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir\_classyfire, }\StringTok{"/log"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(log\_file))\{}
\NormalTok{      log\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(log\_file)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, }\SpecialCharTok{!}\NormalTok{InChIKey }\SpecialCharTok{\%in\%}\NormalTok{ log\_df}\SpecialCharTok{$}\NormalTok{log)}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
        \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(df, }\StringTok{"inchikey2d"}\NormalTok{)}
    \DocumentationTok{\#\# this part can be multi{-}threads}
\NormalTok{    log }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, base\_auto\_classyfire,}
                             \AttributeTok{dir\_classyfire =}\NormalTok{ dir\_classyfire,}
                             \AttributeTok{cl =}\NormalTok{ classyfire\_cl) }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{unlist}\NormalTok{(}\AttributeTok{use.names =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{log =}\NormalTok{ .)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{exists}\NormalTok{(}\StringTok{"log\_df"}\NormalTok{))}
\NormalTok{      log }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(log\_df, log)}
    \FunctionTok{write\_tsv}\NormalTok{(log, }\AttributeTok{file =}\NormalTok{ log\_file)}
\NormalTok{  \}}
\NormalTok{base\_auto\_classyfire }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           dir\_classyfire}
\NormalTok{           )\{}
\NormalTok{    inchikey2d }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{,][[}\StringTok{"inchikey2d"}\NormalTok{]]}
\NormalTok{    log }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(df[[}\StringTok{"InChIKey"}\NormalTok{]], base2\_classyfire,}
                  \AttributeTok{inchikey2d =}\NormalTok{ inchikey2d,}
                  \AttributeTok{dir\_classyfire =}\NormalTok{ dir\_classyfire)}
    \FunctionTok{return}\NormalTok{(}\FunctionTok{unlist}\NormalTok{(log, }\AttributeTok{use.names =}\NormalTok{ F))}
\NormalTok{  \}}
\NormalTok{base2\_classyfire }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey,}
\NormalTok{           inchikey2d,}
\NormalTok{           dir\_classyfire}
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(dir\_classyfire, }\StringTok{"/"}\NormalTok{, inchikey2d)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(file) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \DocumentationTok{\#\# if not exists}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{get\_classification}\NormalTok{(inchikey)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(ch))\{}
      \FunctionTok{return}\NormalTok{(inchikey)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ch }\OtherTok{\textless{}{-}}\NormalTok{ classyfireR}\SpecialCharTok{::}\FunctionTok{classification}\NormalTok{(ch)}
      \FunctionTok{write\_tsv}\NormalTok{(ch, file)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.format_quant_table.r}{%
\section{File: beta.format\_quant\_table.R}\label{file-beta.format_quant_table.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{format\_quant\_table }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{meta.group =} \FunctionTok{c}\NormalTok{(}\AttributeTok{blank =} \StringTok{"blank"}\NormalTok{, }\AttributeTok{raw =} \StringTok{"raw"}\NormalTok{, }\AttributeTok{pro =} \StringTok{"pro"}\NormalTok{),}
           \AttributeTok{from =} \StringTok{"mzmine"}\NormalTok{,}
           \AttributeTok{get\_metadata =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(file) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{.id =} \DecValTok{1}\NormalTok{, }\AttributeTok{mz =} \DecValTok{2}\NormalTok{, }\AttributeTok{rt =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\FunctionTok{contains}\NormalTok{(}\StringTok{"Peak area"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{colnames}\NormalTok{(df) }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.mz.\{0,1\}ML Peak area"}\NormalTok{, }\StringTok{""}\NormalTok{, }\FunctionTok{colnames}\NormalTok{(df))}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ meta.group }\SpecialCharTok{\%\textgreater{}\%} 
      \FunctionTok{lapply}\NormalTok{(}\ControlFlowTok{function}\NormalTok{(vec)\{}
\NormalTok{               str }\OtherTok{\textless{}{-}} \FunctionTok{.meta\_find\_and\_sort}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df), vec)}
\NormalTok{           \})}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{mapply}\NormalTok{(metadata, }\FunctionTok{names}\NormalTok{(metadata), }\AttributeTok{SIMPLIFY =}\NormalTok{ F,}
                       \AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(vec, name)\{}
\NormalTok{                         df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{group =}\NormalTok{ name, }\AttributeTok{sample =}\NormalTok{ vec)}
                         \FunctionTok{return}\NormalTok{(df)}
\NormalTok{                       \})}
\NormalTok{    metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(metadata)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(get\_metadata)}
      \FunctionTok{return}\NormalTok{(metadata)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{mz, }\SpecialCharTok{{-}}\NormalTok{rt) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# as long table}
\NormalTok{      reshape2}\SpecialCharTok{::}\FunctionTok{melt}\NormalTok{(}\AttributeTok{id.vars =} \StringTok{".id"}\NormalTok{, }\AttributeTok{variable.name =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{value.name =} \StringTok{"value"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(metadata, }\AttributeTok{by =} \StringTok{"sample"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# as data.table}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{value =} \FunctionTok{as.numeric}\NormalTok{(value)) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# calculate average}
\NormalTok{      .[, }\FunctionTok{list}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{mean}\NormalTok{(value, }\AttributeTok{na.rm =}\NormalTok{ T)), by }\OtherTok{=} \FunctionTok{list}\NormalTok{(.id, group)] }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# NAN as 0}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{mean =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.nan}\NormalTok{(mean), }\DecValTok{0}\NormalTok{, mean)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# as wide data}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{dcast}\NormalTok{(.id }\SpecialCharTok{\textasciitilde{}}\NormalTok{ group, }\AttributeTok{value.var =} \StringTok{"mean"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# .id is character}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{as.character}\NormalTok{(.id)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{() }
    \FunctionTok{return}\NormalTok{(stat)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{.meta\_find\_and\_sort }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           name\_set,}
\NormalTok{           pattern\_set}
\NormalTok{           )\{}
\NormalTok{    name\_set }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(pattern\_set, .meta\_mutate\_grep\_get,}
                       \AttributeTok{string\_set =}\NormalTok{ name\_set) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unlist}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(name\_set)}
\NormalTok{  \}}
\NormalTok{.meta\_mutate\_grep\_get }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           pattern,}
\NormalTok{           string\_set}
\NormalTok{           )\{}
\NormalTok{    string }\OtherTok{\textless{}{-}}\NormalTok{ string\_set }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      .[}\FunctionTok{grepl}\NormalTok{(pattern, .)]}
    \FunctionTok{return}\NormalTok{(string)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.method_target_spec_compare.r}{%
\section{File: beta.method\_target\_spec\_compare.R}\label{file-beta.method_target_spec_compare.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# target compare specture in classes}
\NormalTok{method\_target\_spec\_compare }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{nebula\_index =}\NormalTok{ .MCn.nebula\_index,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/"}\NormalTok{, nebula\_name, }\StringTok{".spec.tsv"}\NormalTok{),}
           \AttributeTok{edge\_filter =} \FloatTok{0.5}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    idset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(nebula\_index, name }\SpecialCharTok{\%in\%}\NormalTok{ nebula\_name)}\SpecialCharTok{$}\NormalTok{.id}
\NormalTok{    edges }\OtherTok{\textless{}{-}} \FunctionTok{method\_formula\_based\_spec\_compare}\NormalTok{(}
      \AttributeTok{target\_ids =}\NormalTok{ idset,}
      \AttributeTok{only\_identical\_class =}\NormalTok{ F,}
      \AttributeTok{min\_hierarchy =} \DecValTok{1}\NormalTok{,}
\NormalTok{      ...}
\NormalTok{    )}
    \FunctionTok{write\_tsv}\NormalTok{(edges, output)}
    \FunctionTok{return}\NormalTok{(output)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.nebula_get_candidate.r}{%
\section{File: beta.nebula\_get\_candidate.R}\label{file-beta.nebula_get_candidate.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nebula\_get\_candidate }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           ...,}
           \AttributeTok{path =} \StringTok{"mcnebula\_results"}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/candidates"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(path) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{dir.create}\NormalTok{(path)}
\NormalTok{    args }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
\NormalTok{                 ...,}
                 \AttributeTok{top\_n =} \DecValTok{50}\NormalTok{,}
                 \AttributeTok{match\_pattern =} \ConstantTok{NULL}\NormalTok{, }\DocumentationTok{\#\# or c("precursorFormula", "adduct") or NULL}
                 \AttributeTok{collate\_factor =} \ConstantTok{NA}\NormalTok{,}
                 \AttributeTok{revise\_MCn\_formula\_set =}\NormalTok{ F,}
                 \AttributeTok{revise\_MCn\_structure\_set =}\NormalTok{ F,}
                 \AttributeTok{only\_gather\_structure =}\NormalTok{ T}
\NormalTok{    )}
\NormalTok{    candidates }\OtherTok{\textless{}{-}} \FunctionTok{do.call}\NormalTok{(nebula\_re\_rank, args)}
    \FunctionTok{write\_tsv}\NormalTok{(candidates, }\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, args[[}\DecValTok{1}\NormalTok{]], }\StringTok{".tsv"}\NormalTok{))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.packing_as_rdata_list.r}{%
\section{File: beta.packing\_as\_rdata\_list.R}\label{file-beta.packing_as_rdata_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{extract\_rdata\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           rdata,}
           \AttributeTok{names =} \ConstantTok{NA}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(rdata))}
      \FunctionTok{return}\NormalTok{()}
    \FunctionTok{load}\NormalTok{(rdata)}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(names[}\DecValTok{1}\NormalTok{]))\{}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{\%in\%}\NormalTok{ names]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{packing\_as\_rdata\_list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           path,}
\NormalTok{           pattern,}
\NormalTok{           rdata,}
           \AttributeTok{extra =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{rm\_files =}\NormalTok{ T,}
           \AttributeTok{dedup =}\NormalTok{ T}
\NormalTok{           )\{}
\NormalTok{    file\_set }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(path, }\AttributeTok{pattern =}\NormalTok{ pattern)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(file\_set) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# read as list}
\NormalTok{    list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file\_set), read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ file\_set}
    \DocumentationTok{\#\# merge}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(extra, list)}
    \DocumentationTok{\#\# according to name, unique}
    \ControlFlowTok{if}\NormalTok{(dedup)\{}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{name =} \FunctionTok{names}\NormalTok{(list), }\AttributeTok{n =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(list))}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(df, name, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
\NormalTok{      list }\OtherTok{\textless{}{-}}\NormalTok{ list[df}\SpecialCharTok{$}\NormalTok{n]}
\NormalTok{    \}}
    \DocumentationTok{\#\# rm origin file sets}
    \ControlFlowTok{if}\NormalTok{(rm\_files)\{}
      \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, file\_set), file.remove)}
\NormalTok{    \}}
    \DocumentationTok{\#\# save as rdata}
    \FunctionTok{save}\NormalTok{(list, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, rdata))}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.pubchem_curl_inchikey.r}{%
\section{File: beta.pubchem\_curl\_inchikey.R}\label{file-beta.pubchem_curl_inchikey.r}}

\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\DocumentationTok{\#\# pubchem curl inchikey}
\NormalTok{pubchem\_curl\_inchikey }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           dir,}
           \AttributeTok{curl\_cl =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"inchikey.rdata"}\NormalTok{)}
\NormalTok{    inchikey\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    inchikey2d }\OtherTok{\textless{}{-}}\NormalTok{ inchikey2d[}\SpecialCharTok{!}\NormalTok{inchikey2d }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(inchikey\_set)]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(inchikey2d) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(inchikey2d, base\_pubchem\_curl\_inchikey,}
                      \AttributeTok{dir =}\NormalTok{ dir, }\AttributeTok{cl =}\NormalTok{ curl\_cl, ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# gather InChIKey}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir, }\AttributeTok{pattern =} \StringTok{"\^{}[A{-}Z]\{14\}$"}\NormalTok{,}
                          \AttributeTok{rdata =} \StringTok{"inchikey.rdata"}\NormalTok{, }\AttributeTok{extra =}\NormalTok{ inchikey\_set)}
\NormalTok{  \}}
\NormalTok{base\_pubchem\_curl\_inchikey }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           inchikey2d,}
\NormalTok{           dir,}
           \AttributeTok{type =} \StringTok{"inchikey"}\NormalTok{,}
           \AttributeTok{get =} \StringTok{"InChIkey"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, inchikey2d)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# if exists and valid, return}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(file))\{}
\NormalTok{      csv }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(file)}
      \ControlFlowTok{if}\NormalTok{(}\StringTok{"CID"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(csv))}
        \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# curl via inchikey2d, which the same as InChIKey }
\NormalTok{    url\_start }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/"}\NormalTok{, type, }\StringTok{"/"}\NormalTok{)}
    \DocumentationTok{\#\# to get InChIKey, and get data as csv format}
\NormalTok{    url\_end }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(}\StringTok{"/property/"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(get, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{), }\StringTok{"/CSV"}\NormalTok{)}
    \DocumentationTok{\#\# gather url}
\NormalTok{    url }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(url\_start, }\StringTok{"/"}\NormalTok{, inchikey2d, }\StringTok{"/"}\NormalTok{, url\_end)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    csv }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# check results, if 404, return()}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status: 404"}\NormalTok{, csv))\{}
      \FunctionTok{write\_tsv}\NormalTok{(csv, }\AttributeTok{file =}\NormalTok{ file)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# if 503, system busy, try again}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status:    503"}\NormalTok{, csv))\{}
\NormalTok{      csv }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    csv }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{text =}\NormalTok{ csv)}
    \FunctionTok{write\_tsv}\NormalTok{(csv, }\AttributeTok{file =}\NormalTok{ file)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.pubchem_get_synonyms.r}{%
\section{File: beta.pubchem\_get\_synonyms.R}\label{file-beta.pubchem_get_synonyms.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pubchem\_get\_synonyms }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           cid,}
\NormalTok{           dir,}
           \AttributeTok{curl\_cl =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{gather\_as\_rdata =}\NormalTok{ T,}
           \AttributeTok{group\_number =} \DecValTok{50}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    rdata }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"cid.rdata"}\NormalTok{)}
    \DocumentationTok{\#\# extract as list}
\NormalTok{    cid\_set }\OtherTok{\textless{}{-}} \FunctionTok{extract\_rdata\_list}\NormalTok{(rdata)}
    \DocumentationTok{\#\# as data.table}
\NormalTok{    cid\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(cid\_set)}
    \DocumentationTok{\#\# !duplicated}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"cid"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(cid\_set))\{}
\NormalTok{      cid\_set }\OtherTok{\textless{}{-}}\NormalTok{ cid\_set }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(cid, syno)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# exclude existing}
\NormalTok{    cid }\OtherTok{\textless{}{-}}\NormalTok{ cid[}\SpecialCharTok{!}\NormalTok{cid }\SpecialCharTok{\%in\%}\NormalTok{ cid\_set}\SpecialCharTok{$}\NormalTok{cid]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(cid) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{grouping\_vec2list}\NormalTok{(cid, }\AttributeTok{group\_number =}\NormalTok{ group\_number)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(group, base\_pubchem\_get\_synonyms,}
                      \AttributeTok{dir =}\NormalTok{ dir, }\AttributeTok{cl =}\NormalTok{ curl\_cl, ...)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# gather synonyms}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{packing\_as\_rdata\_list}\NormalTok{(dir, }\AttributeTok{pattern =} \StringTok{"\^{}G[0{-}9]\{1,\}$"}\NormalTok{,}
                          \AttributeTok{dedup =}\NormalTok{ F,}
                          \AttributeTok{rdata =} \StringTok{"cid.rdata"}\NormalTok{,}
                          \DocumentationTok{\#\# data.table as list}
                          \AttributeTok{extra =} \FunctionTok{list}\NormalTok{(cid\_set))}
\NormalTok{  \}}
\NormalTok{base\_pubchem\_get\_synonyms }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           cid,}
\NormalTok{           dir,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    savename }\OtherTok{\textless{}{-}} \FunctionTok{attr}\NormalTok{(cid, }\StringTok{"name"}\NormalTok{)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, savename)}
    \DocumentationTok{\#\# gather cid and sep by ,}
\NormalTok{    cid }\OtherTok{\textless{}{-}} \FunctionTok{paste}\NormalTok{(cid, }\AttributeTok{collapse =} \StringTok{","}\NormalTok{)}
    \DocumentationTok{\#\# use cid}
\NormalTok{    url\_start }\OtherTok{\textless{}{-}} \StringTok{"https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/"}
    \DocumentationTok{\#\# get as XML}
\NormalTok{    url\_end }\OtherTok{\textless{}{-}} \StringTok{"/synonyms/XML"}
    \DocumentationTok{\#\# paste as url}
\NormalTok{    url }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(url\_start, cid, url\_end)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    check }\OtherTok{\textless{}{-}} \DecValTok{0}
    \ControlFlowTok{while}\NormalTok{(check }\SpecialCharTok{==} \DecValTok{0} \SpecialCharTok{|} \FunctionTok{class}\NormalTok{(check)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
\NormalTok{      check }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(text }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url), }\AttributeTok{silent =}\NormalTok{ T)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"Status:    503"}\NormalTok{, text))\{}
\NormalTok{      text }\OtherTok{\textless{}{-}}\NormalTok{ RCurl}\SpecialCharTok{::}\FunctionTok{getURL}\NormalTok{(url)}
\NormalTok{    \}}
    \DocumentationTok{\#\# "PUGREST.BadRequest"}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# convert to list}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ XML}\SpecialCharTok{::}\FunctionTok{xmlToList}\NormalTok{(text)}
    \DocumentationTok{\#\# only \textquotesingle{}information\textquotesingle{}}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ text[}\FunctionTok{names}\NormalTok{(text) }\SpecialCharTok{==} \StringTok{"Information"}\NormalTok{]}
    \DocumentationTok{\#\# in list to separate data}
\NormalTok{    text }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(text, }\ControlFlowTok{function}\NormalTok{(list)\{}
\NormalTok{                     syno }\OtherTok{\textless{}{-}}\NormalTok{ list[}\FunctionTok{names}\NormalTok{(list) }\SpecialCharTok{==} \StringTok{"Synonym"}\NormalTok{]}
\NormalTok{                     syno }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(syno,}
                                    \ControlFlowTok{function}\NormalTok{(char)\{}
                                      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(char))\{}
                                        \FunctionTok{return}\NormalTok{(}\ConstantTok{NA}\NormalTok{)}
\NormalTok{                                      \}}\ControlFlowTok{else}\NormalTok{\{}
                                        \FunctionTok{return}\NormalTok{(char)}
\NormalTok{                                      \}}
\NormalTok{                                    \})}
\NormalTok{                     data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{cid =}\NormalTok{ list}\SpecialCharTok{$}\NormalTok{CID, }\AttributeTok{syno =} \FunctionTok{unlist}\NormalTok{(syno))}
\NormalTok{           \})}
\NormalTok{    text }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(text, }\AttributeTok{fill =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# save data}
    \FunctionTok{write\_tsv}\NormalTok{(text, }\AttributeTok{filename =}\NormalTok{ file)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{grouping\_vec2list }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           vector,}
\NormalTok{           group\_number,}
           \AttributeTok{byrow =}\NormalTok{ F}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{\textless{}}\NormalTok{ group\_number)\{}
      \FunctionTok{attr}\NormalTok{(vector, }\StringTok{"name"}\NormalTok{) }\OtherTok{\textless{}{-}} \StringTok{"G1"}
      \FunctionTok{return}\NormalTok{(}\FunctionTok{list}\NormalTok{(vector))}
\NormalTok{    \}}
    \DocumentationTok{\#\# if grouped, the rest number}
\NormalTok{    rest }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{\%\%}\NormalTok{ group\_number}
    \DocumentationTok{\#\# assign group}
\NormalTok{    group }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(vector[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(vector) }\SpecialCharTok{{-}}\NormalTok{ rest)],}
                    \AttributeTok{ncol =}\NormalTok{ group\_number,}
                    \AttributeTok{byrow =}\NormalTok{ byrow) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# use apply to multiple list}
      \FunctionTok{apply}\NormalTok{(}\DecValTok{1}\NormalTok{, c, }\AttributeTok{simplify =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# gather the rest vector}
      \FunctionTok{c}\NormalTok{(., }\FunctionTok{list}\NormalTok{(}\FunctionTok{tail}\NormalTok{(vector, }\AttributeTok{n =}\NormalTok{ rest))) }\SpecialCharTok{\%\textgreater{}\%} 
      \DocumentationTok{\#\# add group name}
      \FunctionTok{mapply}\NormalTok{(}\AttributeTok{FUN =} \ControlFlowTok{function}\NormalTok{(vec, name)\{}
               \FunctionTok{attr}\NormalTok{(vec, }\StringTok{"name"}\NormalTok{) }\OtherTok{\textless{}{-}}\NormalTok{ name}
               \FunctionTok{return}\NormalTok{(vec)}
\NormalTok{           \}, ., }\FunctionTok{paste0}\NormalTok{(}\StringTok{"G"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\FunctionTok{length}\NormalTok{(.)),}
           \AttributeTok{SIMPLIFY =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(rest }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)}
\NormalTok{      group }\OtherTok{\textless{}{-}}\NormalTok{ group[}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{length}\NormalTok{(group) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)]}
    \FunctionTok{return}\NormalTok{(group)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-beta.vis_via_molconvert.r}{%
\section{File: beta.vis\_via\_molconvert.R}\label{file-beta.vis_via_molconvert.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vis\_via\_molconvert\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}
\NormalTok{    stru }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.structure\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{vis\_via\_molconvert}\NormalTok{(stru}\SpecialCharTok{$}\NormalTok{smiles, stru}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{vis\_via\_molconvert }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(output))\{}
      \FunctionTok{dir.create}\NormalTok{(output, }\AttributeTok{recursive =}\NormalTok{ T)}
\NormalTok{    \}}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(molconvert\_structure,}
\NormalTok{           smiles\_set,}
\NormalTok{           id\_set,}
           \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}\AttributeTok{output =}\NormalTok{ output)}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(}\StringTok{"Done"}\NormalTok{)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{molconvert\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           smiles,}
\NormalTok{           id,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    file }\OtherTok{=} \FunctionTok{tempfile}\NormalTok{()}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"molconvert mol }\SpecialCharTok{\textbackslash{}"}\StringTok{"}\NormalTok{, smiles, }\StringTok{"}\SpecialCharTok{\textbackslash{}"}\StringTok{ {-}o "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"obabel "}\NormalTok{, file, }\StringTok{" {-}imol {-}osvg {-}O "}\NormalTok{, file, }\StringTok{" \textgreater{} /dev/null 2\textgreater{}\&1"}\NormalTok{))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"sed {-}i }\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{s/white/transparent/g}\SpecialCharTok{\textbackslash{}\textquotesingle{}}\StringTok{ "}\NormalTok{, file))}
    \FunctionTok{system}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(}\StringTok{"cairosvg {-}f svg "}\NormalTok{, file, }\StringTok{" {-}o "}\NormalTok{, output, }\StringTok{"/"}\NormalTok{, id, }\StringTok{".svg"}\NormalTok{))}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-build_classes_tree_list.r}{%
\section{File: build\_classes\_tree\_list.R}\label{file-build_classes_tree_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title build\_classes\_tree\_list}
\CommentTok{\#\textquotesingle{} @description According to source data (table) of classification in SIRIUS project to build list in hierarchy.}
\CommentTok{\#\textquotesingle{} @param class\_index Character, source data name, Default: \textquotesingle{}canopus.tsv\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param path SIRIUS project path, Default: .MCn.sirius}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{} @rdname build\_classes\_tree\_list}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr as\_tibble}
\NormalTok{build\_classes\_tree\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{class\_index=}\StringTok{"canopus.tsv"}\NormalTok{, }\AttributeTok{path=}\NormalTok{.MCn.sirius}
\NormalTok{           )\{}
\NormalTok{    data }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, class\_index))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# separate each levels of classes into sub{-}list}
\NormalTok{    root }\OtherTok{\textless{}{-}}\NormalTok{ data[}\FunctionTok{which}\NormalTok{(data}\SpecialCharTok{$}\NormalTok{parentId}\SpecialCharTok{==}\StringTok{""}\NormalTok{), ]}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{    n }\OtherTok{=} \DecValTok{1}
\NormalTok{    list[[n]] }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(root)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{parentId }\SpecialCharTok{\%in\%}\NormalTok{ root}\SpecialCharTok{$}\NormalTok{id, ]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{)\{}
\NormalTok{      n }\OtherTok{=}\NormalTok{ n }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{      list[[n]] }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df)}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data[data}\SpecialCharTok{$}\NormalTok{parentId }\SpecialCharTok{\%in\%}\NormalTok{ df}\SpecialCharTok{$}\NormalTok{id, ]}
\NormalTok{    \}}
\NormalTok{    .MCn.class\_tree\_list }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ list}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"INFO: Classification Index in.MCn.sirius project {-}{-}{-}\textgreater{}"}\NormalTok{, class\_index, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{A total of 11 levels.}\SpecialCharTok{\textbackslash{}n}\StringTok{These classes (upon ClassyFire and CANOPUS) were separated into sub{-}lists.}
\StringTok{        Use following arguments to get some specific classes:}
\StringTok{        .MCn.class\_tree\_list[[3]] \textgreater{}\textgreater{}\textgreater{} superclass}
\StringTok{        .MCn.class\_tree\_list[[4]] \textgreater{}\textgreater{}\textgreater{} class}
\StringTok{        .MCn.class\_tree\_list[[5]] \textgreater{}\textgreater{}\textgreater{} subclass}
\StringTok{        .MCn.class\_tree\_list[[6]] \textgreater{}\textgreater{}\textgreater{} level 5 }\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-by_group_as_list.r}{%
\section{File: by\_group\_as\_list.R}\label{file-by_group_as_list.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{by\_group\_as\_list }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
\NormalTok{           colnames}
\NormalTok{           )\{}
\NormalTok{    vector }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(df[[colnames]])}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(vector, by\_group\_as\_list\_select,}
                   \AttributeTok{df =}\NormalTok{ df,}
                   \AttributeTok{colNames =}\NormalTok{ colnames)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}}\NormalTok{ vector}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{  \}}
\NormalTok{by\_group\_as\_list\_select }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           KEY,}
\NormalTok{           df,}
\NormalTok{           colNames}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[colNames]] }\SpecialCharTok{==}\NormalTok{ KEY), ]}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_ppcp.r}{%
\section{File: collate\_ppcp.R}\label{file-collate_ppcp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title collate\_ppcp}
\CommentTok{\#\textquotesingle{} @description Collate posterior probability of classification prediction (PPCP) from SIRIUS project}
\CommentTok{\#\textquotesingle{} and conduct integration to get nebula\_class and nebula{-}index.}
\CommentTok{\#\textquotesingle{} @param dirs Vector, Default: \textquotesingle{}all\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param write\_output Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param nebula\_class Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param nebula\_index Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{} @rdname collate\_ppcp}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom pbapply pbsapply pblapply}
\CommentTok{\#\textquotesingle{} @importFrom dplyr rename mutate filter as\_tibble}
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\NormalTok{collate\_ppcp }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{nebula\_class =}\NormalTok{ T,}
           \AttributeTok{nebula\_index =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: collate\_ppcp}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# check dirs {-}{-}{-}{-} canopus}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_ppcp: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(dirs) }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ dirs[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{      dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{pattern =} \StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"canopus"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"canopus"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# lock on file location}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{dir =} \StringTok{"."}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{grep\_id}\NormalTok{(dir)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(.MCn.formula\_set, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{adduct\_trans =} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, adduct),}
             \AttributeTok{target =} \FunctionTok{paste0}\NormalTok{(precursorFormula, }\StringTok{"\_"}\NormalTok{, adduct\_trans, }\StringTok{".fpt"}\NormalTok{), }
             \AttributeTok{full.name =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"canopus"}\NormalTok{, }\StringTok{"/"}\NormalTok{, target), }
             \DocumentationTok{\#\# these files need to be check and filter (whether exist)}
             \DocumentationTok{\#\# note that some formula is no fingerprint computed}
             \AttributeTok{ppcp =} \FunctionTok{file.exists}\NormalTok{(full.name))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta\_dir\_filter }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, ppcp }\SpecialCharTok{==}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of PPCP dataset:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir\_filter), }\StringTok{"(formula with PPCP)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_dir), }\StringTok{"(all formula)"}\NormalTok{), }
        \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# load all ppcp dataset}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{exists}\NormalTok{(}\StringTok{".MCn.ppcp\_dataset"}\NormalTok{))\{}
\NormalTok{      ppcp\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{full.name, read\_fpt)}
      \FunctionTok{names}\NormalTok{(ppcp\_dataset) }\OtherTok{\textless{}{-}}\NormalTok{ meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}
\NormalTok{      .MCn.ppcp\_dataset }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ ppcp\_dataset}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      ppcp\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.ppcp\_dataset}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# summarize nebula\_class}
    \ControlFlowTok{if}\NormalTok{(nebula\_class)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_ppcp: method\_summarize\_nebula\_class}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(.MCn.class\_tree\_list, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{hierarchy =}\NormalTok{ .id)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# set as global var}
\NormalTok{      .MCn.class\_tree\_data }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(metadata)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
      \DocumentationTok{\#\# get nebula classes}
\NormalTok{      nebula\_class }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(ppcp\_dataset, method\_summarize\_nebula\_class, }
                             \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_data"}\NormalTok{,}
\NormalTok{                             ...)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{      .MCn.nebula\_class }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ nebula\_class}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(nebula\_index)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_ppcp: method\_summarize\_nebula\_index.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \DocumentationTok{\#\# gather all nebula classes}
\NormalTok{      nebula\_index }\OtherTok{\textless{}{-}} \FunctionTok{method\_summarize\_nebula\_index}\NormalTok{(ppcp\_dataset,}
\NormalTok{                                                    ...)}
\NormalTok{      .MCn.nebula\_index }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ nebula\_index}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(write\_output)\{}
\NormalTok{        output }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results)}
        \FunctionTok{write\_tsv}\NormalTok{(nebula\_index, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"nebula\_index.tsv"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{rm}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: collate\_ppcp.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(nebula\_index)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-collate_structure.r}{%
\section{File: collate\_structure.R}\label{file-collate_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title collate\_structure}
\CommentTok{\#\textquotesingle{} @description Collate chemical structure data from SIRIUS project}
\CommentTok{\#\textquotesingle{} @param dirs Vector, Default: \textquotesingle{}all\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param write\_output Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{relocate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{} @rdname collate\_structure}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom pbapply pbsapply pbmapply}
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr mutate relocate as\_tibble}
\NormalTok{collate\_structure }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
\NormalTok{           ...}
\NormalTok{           )\{}
  \FunctionTok{cat}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"[INFO] MCnebula run: collate\_structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) )}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# check dirs}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_structure: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(dirs) }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{|}\NormalTok{ dirs[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{    dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{pattern=}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unname}\NormalTok{()}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{unname}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{  dirs }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)]}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_structure: method\_pick\_formula\_excellent}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  formula\_set }\OtherTok{\textless{}{-}} \FunctionTok{method\_pick\_formula\_excellent}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ dirs, ...)}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# set as global var}
\NormalTok{  .MCn.formula\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ formula\_set}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# structure collate}
  \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# collate\_structure: re{-}collate structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  structure\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(mutate2\_get\_structure,}
\NormalTok{                                         formula\_set}\SpecialCharTok{$}\NormalTok{.id,}
\NormalTok{                                         formula\_set}\SpecialCharTok{$}\NormalTok{precursorFormula,}
\NormalTok{                                         formula\_set}\SpecialCharTok{$}\NormalTok{adduct,}
                                         \AttributeTok{SIMPLIFY =}\NormalTok{ F)}
\NormalTok{  structure\_dataset }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(structure\_dataset, }\AttributeTok{fill =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
    \DocumentationTok{\#\# debug}
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{tanimotoSimilarity =} \FunctionTok{as.numeric}\NormalTok{(tanimotoSimilarity)) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{relocate}\NormalTok{(.id) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{    dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# set as global var}
\NormalTok{  .MCn.structure\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ structure\_dataset}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \DocumentationTok{\#\# write output}
  \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{    output }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results)}
    \FunctionTok{write\_tsv}\NormalTok{(structure\_dataset, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"method\_pick\_formula\_excellent"}\NormalTok{, }\StringTok{".structure.tsv"}\NormalTok{))}
    \FunctionTok{write\_tsv}\NormalTok{(formula\_set, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"method\_pick\_formula\_excellent"}\NormalTok{, }\StringTok{".tsv"}\NormalTok{))}
\NormalTok{  \}}
  \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
  \FunctionTok{cat}\NormalTok{( }\FunctionTok{paste0}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: collate\_structure.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{) )}
\NormalTok{\}}
\NormalTok{grep\_id }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  stringr}\SpecialCharTok{::}\FunctionTok{str\_extract}\NormalTok{(x, }\StringTok{"(?\textless{}=\_)[\^{}\_]\{1,\}$"}\NormalTok{)}
\NormalTok{\}}
\NormalTok{check\_dir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(dir, }\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{file =} \StringTok{"compound.info"}\NormalTok{)\{}
  \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, file)) }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{    check }\OtherTok{=}\NormalTok{ T}
\NormalTok{  \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{    check }\OtherTok{=}\NormalTok{ F}
\NormalTok{  \}}
  \FunctionTok{return}\NormalTok{(check)}
\NormalTok{\}}
\NormalTok{mutate2\_get\_structure }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           formula,}
\NormalTok{           adduct}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\AttributeTok{silent =}\NormalTok{ T, }\FunctionTok{get\_structure}\NormalTok{(key\_id,}
                                        \AttributeTok{precursor\_formula =}\NormalTok{ formula,}
                                        \AttributeTok{adduct =}\NormalTok{ adduct,}
                                        \AttributeTok{return\_row =} \DecValTok{1}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(df)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      df}\SpecialCharTok{$}\StringTok{".id"} \OtherTok{\textless{}{-}}\NormalTok{ key\_id}
      \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generate_child_nebulae.r}{%
\section{File: generate\_child\_nebulae.R}\label{file-generate_child_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title generate\_child\_nebulae}
\CommentTok{\#\textquotesingle{} @description According to nodes and edges data of parent{-}nebula and nebula{-}index to generate child{-}nebula.}
\CommentTok{\#\textquotesingle{} @param nodes A data.frame, Default: .MCn.parent\_nodes}
\CommentTok{\#\textquotesingle{} @param edges A data.frame, Default: .MCn.parent\_edges}
\CommentTok{\#\textquotesingle{} @param max\_edges A number, Default: 5}
\CommentTok{\#\textquotesingle{} @param nebula\_index A data.frame, Default: .MCn.nebula\_index}
\CommentTok{\#\textquotesingle{} @param output Character, Default: paste0(.MCn.output, "/", .MCn.results)}
\CommentTok{\#\textquotesingle{} @param output\_format Character, \textquotesingle{}igraph\textquotesingle{} supported format, Default: \textquotesingle{}graphml\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{} @rdname generate\_child\_nebulae}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom pbapply pblapply}
\NormalTok{generate\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{nodes =}\NormalTok{ .MCn.parent\_nodes,}
           \AttributeTok{edges =}\NormalTok{ .MCn.parent\_edges,}
           \AttributeTok{max\_edges =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{nebula\_index =}\NormalTok{ .MCn.nebula\_index,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: generate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# get names of all classes}
\NormalTok{    names }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(nebula\_index}\SpecialCharTok{$}\NormalTok{name)}
    \DocumentationTok{\#\# for using lapply, first, trans the data.frame into list}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(nebula\_index, }\StringTok{"relativeIndex"}\NormalTok{)}
    \DocumentationTok{\#\# push names}
    \FunctionTok{names}\NormalTok{(nebula\_index) }\OtherTok{\textless{}{-}}\NormalTok{ names}
    \DocumentationTok{\#\# facet parent nebula}
    \DocumentationTok{\#\# create dir for placing graph file}
\NormalTok{    dir }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebula"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(dir) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{    \}}
\NormalTok{    .MCn.child\_graph\_list }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(nebula\_index, separate\_nebula,}
                      \AttributeTok{output =}\NormalTok{ dir,}
                      \AttributeTok{max\_edges =}\NormalTok{ max\_edges,}
                      \AttributeTok{output\_format =}\NormalTok{ output\_format,}
\NormalTok{                      ...)}
    \FunctionTok{rm}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: generate\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\NormalTok{separate\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{nodes =} \FunctionTok{get}\NormalTok{(}\StringTok{"nodes"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
           \AttributeTok{edges =} \FunctionTok{get}\NormalTok{(}\StringTok{"edges"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_nebula"}\NormalTok{)),}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebula"}\NormalTok{),}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
           \AttributeTok{max\_edges =} \DecValTok{5}\NormalTok{,}
           \AttributeTok{write\_extra =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    id }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# get the child nebula name}
    \DocumentationTok{\#\# note that some character in name caused fail to write as file into dir}
\NormalTok{    name }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"/"}\NormalTok{, }\StringTok{"\#"}\NormalTok{, df[}\DecValTok{1}\NormalTok{,]}\SpecialCharTok{$}\StringTok{"name"}\NormalTok{)}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes[nodes}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{\%in\%}\NormalTok{ id, ]}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[edges}\SpecialCharTok{$}\StringTok{".id\_1"} \SpecialCharTok{\%in\%}\NormalTok{ id }\SpecialCharTok{\&}\NormalTok{ edges}\SpecialCharTok{$}\StringTok{".id\_2"} \SpecialCharTok{\%in\%}\NormalTok{ id, ] }
    \DocumentationTok{\#\# an edges number cut{-}off}
\NormalTok{    edges }\OtherTok{\textless{}{-}} \FunctionTok{better\_vis\_nebula}\NormalTok{(edges, }\AttributeTok{max\_edges =}\NormalTok{ max\_edges)}
\NormalTok{    child\_nebula }\OtherTok{\textless{}{-}}\NormalTok{ igraph}\SpecialCharTok{::}\FunctionTok{graph\_from\_data\_frame}\NormalTok{(edges, }\AttributeTok{directed =}\NormalTok{ T, }\AttributeTok{vertices =}\NormalTok{ nodes)}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{      igraph}\SpecialCharTok{::}\FunctionTok{write\_graph}\NormalTok{(child\_nebula,}
                  \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"."}\NormalTok{, output\_format),}
                  \AttributeTok{format =}\NormalTok{ output\_format)}
      \ControlFlowTok{if}\NormalTok{(write\_extra }\SpecialCharTok{==}\NormalTok{ T)\{}
        \FunctionTok{write\_tsv}\NormalTok{(edges, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"\_edges.tsv"}\NormalTok{))}
        \FunctionTok{write\_tsv}\NormalTok{(nodes, }\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, name, }\StringTok{"\_nodes.tsv"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(child\_nebula)}
\NormalTok{  \}}
\NormalTok{better\_vis\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           edges,}
           \AttributeTok{max\_edges =} \DecValTok{5}
\NormalTok{           )\{}
    \DocumentationTok{\#\# order}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(edges, }\FunctionTok{desc}\NormalTok{(edges[,}\DecValTok{3}\NormalTok{]))}
\NormalTok{    ta }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]], edges[[}\DecValTok{2}\NormalTok{]]))}
    \DocumentationTok{\#\# at least loop number}
\NormalTok{    n }\OtherTok{\textless{}{-}} \FunctionTok{length}\NormalTok{(}\FunctionTok{which}\NormalTok{(ta }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_edges))}
    \ControlFlowTok{if}\NormalTok{(n }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(edges)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# copy data for override}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(edges[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], }\AttributeTok{SEQ =} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(edges))}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# use sapply instead of while loop}
\NormalTok{    continue }\OtherTok{=} \DecValTok{1}
    \FunctionTok{sapply}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{n, edges\_cut\_off, }\AttributeTok{max\_edges =}\NormalTok{ max\_edges)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[df}\SpecialCharTok{$}\NormalTok{SEQ, ]}
    \FunctionTok{rm}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{return}\NormalTok{(edges)}
\NormalTok{  \}}
\NormalTok{edges\_cut\_off }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           i,}
           \AttributeTok{max\_edges =} \DecValTok{5}
\NormalTok{           )\{}
\NormalTok{    continue }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\StringTok{"continue"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
    \ControlFlowTok{if}\NormalTok{(continue }\SpecialCharTok{==} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      edges }\OtherTok{=} \FunctionTok{get}\NormalTok{(}\StringTok{"df"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
      \DocumentationTok{\#\# stat edges number of an id}
\NormalTok{      ta }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]], edges[[}\DecValTok{2}\NormalTok{]]))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{max}\NormalTok{(ta) }\SpecialCharTok{\textgreater{}}\NormalTok{ max\_edges)\{ }\DocumentationTok{\#\# greater than threshold, hence perform exclude}
        \DocumentationTok{\#\# select an id to exclude its excess edges}
\NormalTok{        key\_id }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(ta[}\FunctionTok{which}\NormalTok{(ta }\SpecialCharTok{==} \FunctionTok{max}\NormalTok{(ta))])[}\DecValTok{1}\NormalTok{]}
        \DocumentationTok{\#\# get SEQ of the edges which need to be excluded}
\NormalTok{        incude\_id\_edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(edges[[}\DecValTok{1}\NormalTok{]] }\SpecialCharTok{==}\NormalTok{ key\_id }\SpecialCharTok{|}\NormalTok{ edges[[}\DecValTok{2}\NormalTok{]] }\SpecialCharTok{==}\NormalTok{ key\_id),]}
\NormalTok{        exclude\_edges\_seq }\OtherTok{\textless{}{-}}\NormalTok{ incude\_id\_edges[}\SpecialCharTok{{-}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{max\_edges), ]}\SpecialCharTok{$}\NormalTok{SEQ}
        \DocumentationTok{\#\# exclude edges}
\NormalTok{        edges }\OtherTok{\textless{}{-}}\NormalTok{ edges[}\FunctionTok{which}\NormalTok{(}\SpecialCharTok{!}\NormalTok{edges}\SpecialCharTok{$}\NormalTok{SEQ }\SpecialCharTok{\%in\%}\NormalTok{ exclude\_edges\_seq), ]}
        \FunctionTok{assign}\NormalTok{(}\StringTok{"df"}\NormalTok{, edges, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
        \DocumentationTok{\#\# signature of stop exclude}
        \FunctionTok{assign}\NormalTok{(}\StringTok{"continue"}\NormalTok{, }\DecValTok{0}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{      \}}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-generate_parent_nebula.r}{%
\section{File: generate\_parent\_nebula.R}\label{file-generate_parent_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title generate\_parent\_nebula}
\CommentTok{\#\textquotesingle{} @description According to formula dataset and structure dataset to generate parent{-}nebula graph}
\CommentTok{\#\textquotesingle{} @param write\_output Logic, Default: T}
\CommentTok{\#\textquotesingle{} @param output\_format Character, \textquotesingle{}igraph\textquotesingle{} supported format, Default: \textquotesingle{}graphml\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param output Character, Default: paste0(.MCn.output, "/", .MCn.results)}
\CommentTok{\#\textquotesingle{} @param edges\_file Character, path to edges file, Default: paste0(output, "/parent\_nebula/parent\_nebula\_edges.tsv")}
\CommentTok{\#\textquotesingle{} @param edges\_method Character, Default: \textquotesingle{}method\_formula\_based\_spec\_compare\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param nodes\_attributes A data.frame, formula dataset, Default: .MCn.formula\_set}
\CommentTok{\#\textquotesingle{} @param nodes\_other\_attributes A data.frame, structure dataset, Default: .MCn.structure\_set}
\CommentTok{\#\textquotesingle{} @param rm\_parent\_isolate\_nodes Logic, Default: F}
\CommentTok{\#\textquotesingle{} @param edge\_filter A number, Default: 0.5}
\CommentTok{\#\textquotesingle{} @param cpu\_cores A number, thread count, Default: 8}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\_all\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[igraph]\{as\_data\_frame\}\}, \textbackslash{}code\{\textbackslash{}link[igraph]\{write\_graph\}\}}
\CommentTok{\#\textquotesingle{} @rdname generate\_parent\_nebula}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr as\_tibble mutate mutate\_at rename filter}
\CommentTok{\#\textquotesingle{} @importFrom igraph graph\_from\_data\_frame write\_graph}
\NormalTok{generate\_parent\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output\_format =} \StringTok{"graphml"}\NormalTok{,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \CommentTok{\# exists edges file}
           \AttributeTok{edges\_file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/parent\_nebula/parent\_nebula\_edges.tsv"}\NormalTok{), }
           \CommentTok{\# or NULL}
           \AttributeTok{edges\_method =} \StringTok{"method\_formula\_based\_spec\_compare"}\NormalTok{, }
           \AttributeTok{nodes\_attributes =}\NormalTok{ .MCn.formula\_set,}
           \AttributeTok{nodes\_other\_attributes =}\NormalTok{ .MCn.structure\_set,}
           \AttributeTok{rm\_parent\_isolate\_nodes =}\NormalTok{ F,}
           \AttributeTok{edge\_filter =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{cpu\_cores =} \DecValTok{8}\NormalTok{, }
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: generate\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# main body}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate edges data}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(edges\_method))\{}
      \DocumentationTok{\#\# no edges\_method}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# generate\_parent\_nebula: no edges\_uethod used}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(}\FunctionTok{cbind}\NormalTok{(}\StringTok{".id\_1"} \OtherTok{=}\NormalTok{ nodes\_other\_attributes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                     \StringTok{".id\_2"} \OtherTok{=}\NormalTok{ nodes\_other\_attributes}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{dotproduct =} \DecValTok{1}\NormalTok{, }\AttributeTok{mass\_diff =} \DecValTok{0}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(edges\_method }\SpecialCharTok{==} \StringTok{"method\_formula\_based\_spec\_compare"}\NormalTok{)\{}
      \DocumentationTok{\#\# with edges\_method}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.null}\NormalTok{(edges\_file) }\SpecialCharTok{\&} \FunctionTok{file.exists}\NormalTok{(edges\_file))\{}
        \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# generate\_parent\_nebula: file.exists(edges\_file) == T.}\SpecialCharTok{\textbackslash{}n}\StringTok{Escape from time{-}consuming computation}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        edges }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(edges\_file) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id\_1"}\NormalTok{, }\StringTok{".id\_2"}\NormalTok{), as.character) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{          dplyr}\SpecialCharTok{::}\FunctionTok{mutate\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(.)[}\DecValTok{3}\SpecialCharTok{:}\DecValTok{4}\NormalTok{]), as.numeric)}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
        \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# generate\_parent\_nebula: method\_formula\_based\_spec\_compare}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{        edges }\OtherTok{=} \FunctionTok{method\_formula\_based\_spec\_compare}\NormalTok{(}\AttributeTok{edge\_filter =}\NormalTok{ edge\_filter, }\AttributeTok{cpu\_cores =}\NormalTok{ cpu\_cores, ...)}
\NormalTok{      \}}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# generate nodes data}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ nodes\_attributes}
    \DocumentationTok{\#\# additional nodes attributes}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(nodes\_other\_attributes))\{}
\NormalTok{      nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(nodes, nodes\_other\_attributes, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# rename the column name, otherwise the column will be choosed as key column in igraph}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{compound\_name =}\NormalTok{ name)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(rm\_parent\_isolate\_nodes)\{}
\NormalTok{      non\_iso\_nodes }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(edges}\SpecialCharTok{$}\NormalTok{.id\_1, edges}\SpecialCharTok{$}\NormalTok{.id\_2))}
\NormalTok{      nodes.parent }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(nodes, .id }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(non\_iso\_nodes))}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      nodes.parent }\OtherTok{\textless{}{-}}\NormalTok{ nodes}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# graph}
\NormalTok{    parent\_nebula }\OtherTok{\textless{}{-}}\NormalTok{ igraph}\SpecialCharTok{::}\FunctionTok{graph\_from\_data\_frame}\NormalTok{(edges, }\AttributeTok{directed =}\NormalTok{ T, }\AttributeTok{vertices =}\NormalTok{ nodes.parent)}
    \ControlFlowTok{if}\NormalTok{(write\_output)\{}
\NormalTok{      dir }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula"}\NormalTok{)}
      \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(dir))\{}
        \FunctionTok{dir.create}\NormalTok{(dir)}
\NormalTok{      \}}
\NormalTok{      igraph}\SpecialCharTok{::}\FunctionTok{write\_graph}\NormalTok{(parent\_nebula,}
                  \AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula."}\NormalTok{, output\_format),}
                  \AttributeTok{format =}\NormalTok{ output\_format)}
      \FunctionTok{write\_tsv}\NormalTok{(edges, }\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula\_edges.tsv"}\NormalTok{))}
      \FunctionTok{write\_tsv}\NormalTok{(nodes, }\FunctionTok{paste0}\NormalTok{(dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula\_nodes.tsv"}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# set as global var for next stage}
\NormalTok{    .MCn.parent\_graph }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ parent\_nebula}
\NormalTok{    .MCn.parent\_nodes }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(nodes)}
\NormalTok{    .MCn.parent\_edges }\OtherTok{\textless{}\textless{}{-}} \FunctionTok{as\_tibble}\NormalTok{(edges)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: generate\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_formula.r}{%
\section{File: get\_formula.R}\label{file-get_formula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title get\_formula}
\CommentTok{\#\textquotesingle{} @description A function to read table of formula data of feature in SIRIUS project.}
\CommentTok{\#\textquotesingle{} @param key\_id Character.}
\CommentTok{\#\textquotesingle{} @param exclude\_element Vector, Default: NULL}
\CommentTok{\#\textquotesingle{} @param formula\_method Character, Default: \textquotesingle{}top\_zodiac\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param rank Vector of number, Default: 1:5}
\CommentTok{\#\textquotesingle{} @param ppm\_error A bumber, Default: 20}
\CommentTok{\#\textquotesingle{} @param return\_col Vector of character, Default: c("rank", "precursorFormula",}
\CommentTok{\# \textquotesingle{}   "molecularFormula", "adduct", "ZodiacScore", }
\CommentTok{\#\textquotesingle{}    "massErrorPrecursor(ppm)")}
\CommentTok{\#\textquotesingle{} @param ... ...}
\CommentTok{\#\textquotesingle{} @return A data.frame}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @rdname get\_formula}
\CommentTok{\#\textquotesingle{} @export }
\NormalTok{get\_formula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
           \AttributeTok{exclude\_element =} \ConstantTok{NULL}\NormalTok{, }\DocumentationTok{\#\# e.g., c("S", "B", "P", "Si")}
           \AttributeTok{formula\_method =} \StringTok{"top\_zodiac"}\NormalTok{,}
           \AttributeTok{rank =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{, }\CommentTok{\# or "all"}
           \AttributeTok{ppm\_error =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{return\_col =} \FunctionTok{c}\NormalTok{(}\StringTok{"rank"}\NormalTok{, }\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{,}
                        \StringTok{"adduct"}\NormalTok{, }\StringTok{"ZodiacScore"}\NormalTok{, }\StringTok{"massErrorPrecursor(ppm)"}\NormalTok{),}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{pattern=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"*\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{), }\AttributeTok{full.names=}\NormalTok{T)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, }\StringTok{"formula\_candidates.tsv"}\NormalTok{))}
\NormalTok{    file}\SpecialCharTok{$}\NormalTok{rank }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{rank)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"ZodiacScore"} \SpecialCharTok{\%in\%} \FunctionTok{colnames}\NormalTok{(file) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      file}\SpecialCharTok{$}\NormalTok{ZodiacScore }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(exclude\_element) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      file }\OtherTok{\textless{}{-}}\NormalTok{ file[}\SpecialCharTok{!}\FunctionTok{unname}\NormalTok{(}\FunctionTok{sapply}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{precursorFormula, grep\_element,}
                                  \AttributeTok{exclude\_element =}\NormalTok{ exclude\_element)), ]}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(formula\_method }\SpecialCharTok{==} \StringTok{"top\_zodiac"}\NormalTok{)\{}
      \ControlFlowTok{if}\NormalTok{(rank[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{        rank }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(file}\SpecialCharTok{$}\NormalTok{rank)}
\NormalTok{      \}}
      \DocumentationTok{\#\# to escape the key in data.table}
\NormalTok{      filter }\OtherTok{=}\NormalTok{ rank}
\NormalTok{      file }\OtherTok{\textless{}{-}}\NormalTok{ file[}\FunctionTok{abs}\NormalTok{(file}\SpecialCharTok{$}\StringTok{"massErrorPrecursor(ppm)"}\NormalTok{) }\SpecialCharTok{\textless{}=}\NormalTok{ ppm\_error }\SpecialCharTok{\&}
\NormalTok{                   file}\SpecialCharTok{$}\StringTok{"rank"} \SpecialCharTok{\%in\%}\NormalTok{ filter,}
\NormalTok{                   return\_col, with }\OtherTok{=}\NormalTok{ F]}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{grep\_element }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           formula,}
           \AttributeTok{exclude\_element =} \FunctionTok{c}\NormalTok{(}\StringTok{"S"}\NormalTok{, }\StringTok{"P"}\NormalTok{, }\StringTok{"B"}\NormalTok{)}
\NormalTok{           )\{}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{grepl}\NormalTok{(}\FunctionTok{paste}\NormalTok{(exclude\_element, }\AttributeTok{collapse =} \StringTok{"|"}\NormalTok{), formula)}
    \FunctionTok{return}\NormalTok{(check)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_ppcp.r}{%
\section{File: get\_ppcp.R}\label{file-get_ppcp.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param key\_id PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param dir PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param precursor\_formula PARAM\_DESCRIPTION, Default: \textquotesingle{}method\_pick\_formula\_excellent\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param adduct PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param reformat PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param filter PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param filter\_threshold PARAM\_DESCRIPTION, Default: 0.1}
\CommentTok{\#\textquotesingle{} @param class\_index PARAM\_DESCRIPTION, Default: \textquotesingle{}canopus.tsv\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @rdname get\_ppcp}
\CommentTok{\#\textquotesingle{} @export }
\NormalTok{get\_ppcp }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{dir =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{precursor\_formula =} \StringTok{"method\_pick\_formula\_excellent"}\NormalTok{,}
           \AttributeTok{adduct =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{reformat =}\NormalTok{ T,}
           \AttributeTok{filter =}\NormalTok{ T,}
           \AttributeTok{filter\_threshold =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{class\_index =} \StringTok{"canopus.tsv"}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# get dir path}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(dir) }\SpecialCharTok{\&} \FunctionTok{is.null}\NormalTok{(key\_id))\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(dir))\{}
\NormalTok{      dir }\OtherTok{\textless{}{-}} \FunctionTok{get\_dir}\NormalTok{(key\_id)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# aquire formula via the method}
    \ControlFlowTok{if}\NormalTok{( precursor\_formula }\SpecialCharTok{==} \StringTok{"method\_pick\_formula\_excellent"}\NormalTok{ )\{}
\NormalTok{      meta }\OtherTok{\textless{}{-}} \FunctionTok{method\_pick\_formula\_excellent}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ dir)}
\NormalTok{      precursor\_formula }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{precursorFormula}
\NormalTok{      adduct }\OtherTok{\textless{}{-}}\NormalTok{ meta}\SpecialCharTok{$}\NormalTok{adduct}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# read ppcp data}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"canopus"}\NormalTok{),}
                       \AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}"}\NormalTok{, precursor\_formula, }\StringTok{"(.*)"}\NormalTok{, }\FunctionTok{escape\_ch}\NormalTok{(adduct), }\StringTok{"(.*)"}\NormalTok{, }\StringTok{".fpt$"}\NormalTok{),}
                       \AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}} \FunctionTok{read\_fpt}\NormalTok{(file)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# reformat section}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{reformat)\{}
      \FunctionTok{return}\NormalTok{(ppcp)}
\NormalTok{    \}}
    \DocumentationTok{\#\# check meta list}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{exists}\NormalTok{(}\StringTok{".MCn.class\_tree\_list"}\NormalTok{))\{}
      \FunctionTok{build\_classes\_tree\_list}\NormalTok{(}\AttributeTok{class\_index =}\NormalTok{ class\_index)}
\NormalTok{    \}}
    \DocumentationTok{\#\# merge with meta table, and filter}
\NormalTok{    ppcp }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(.MCn.class\_tree\_list, merge\_class\_ppcp,}
                   \DocumentationTok{\#\# parameter}
                   \AttributeTok{key\_id =}\NormalTok{ key\_id,}
                   \AttributeTok{values =}\NormalTok{ ppcp,}
                   \AttributeTok{filter =}\NormalTok{ filter,}
                   \AttributeTok{filter\_threshold =}\NormalTok{ filter\_threshold)}
    \FunctionTok{return}\NormalTok{(ppcp)}
\NormalTok{  \}}
\DocumentationTok{\#\# a small function to get data of ppcp}
\NormalTok{read\_fpt }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(file)\{}
\NormalTok{  fpt }\OtherTok{=}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input =}\NormalTok{ file, }\AttributeTok{header =}\NormalTok{ F, }\AttributeTok{quote =} \StringTok{""}\NormalTok{)}
\NormalTok{  fpt}\SpecialCharTok{$}\NormalTok{relativeIndex }\OtherTok{=} \FunctionTok{seq}\NormalTok{(}\DecValTok{0}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(fpt) }\SpecialCharTok{{-}} \DecValTok{1}\NormalTok{)}
  \FunctionTok{return}\NormalTok{(fpt)}
\NormalTok{\}}
\DocumentationTok{\#\# specific character in adduct description need to be revise, for pattern matching}
\NormalTok{escape\_ch }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{["}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{["}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{]"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{+"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}"}\NormalTok{, }\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}\textbackslash{}}\StringTok{{-}"}\NormalTok{, x)}
\NormalTok{  x }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, x)}
  \FunctionTok{return}\NormalTok{(x)}
\NormalTok{\}}
\DocumentationTok{\#\# the function to merge raw ppcp with meta list}
\NormalTok{merge\_class\_ppcp }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           class,}
\NormalTok{           values,}
           \AttributeTok{filter =}\NormalTok{ T,}
           \AttributeTok{filter\_threshold =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{filter\_col =} \StringTok{"V1"}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(class, values, }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{which}\NormalTok{(df[[filter\_col]] }\SpecialCharTok{\textgreater{}} \FunctionTok{ifelse}\NormalTok{(filter }\SpecialCharTok{==}\NormalTok{ T, filter\_threshold, }\DecValTok{0}\NormalTok{)),] }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-get_structure.r}{%
\section{File: get\_structure.R}\label{file-get_structure.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param key\_id PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param precursor\_formula PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param adduct PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param structure\_method PARAM\_DESCRIPTION, Default: \textquotesingle{}top\_score\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param order PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param return\_row PARAM\_DESCRIPTION, Default: 1:10}
\CommentTok{\#\textquotesingle{} @param as\_tibble PARAM\_DESCRIPTION, Default: F}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{} @rdname get\_structure}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr as\_tibble}
\NormalTok{get\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
           \AttributeTok{precursor\_formula =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{adduct =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{structure\_method =} \StringTok{"top\_score"}\NormalTok{, }\CommentTok{\# or top\_similarity}
           \AttributeTok{order =}\NormalTok{ T,}
           \AttributeTok{return\_row =} \DecValTok{1}\SpecialCharTok{:}\DecValTok{10}\NormalTok{, }\CommentTok{\# or "all"}
           \AttributeTok{as\_tibble =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    path }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ .MCn.sirius, }\AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(}\StringTok{"*\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{), }\AttributeTok{full.names =}\NormalTok{ T)}
\NormalTok{    files }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/fingerid"}\NormalTok{),}
                        \AttributeTok{pattern =} \FunctionTok{paste0}\NormalTok{(precursor\_formula, }\StringTok{"(.*)"}\NormalTok{, }\FunctionTok{escape\_ch}\NormalTok{(adduct), }\StringTok{"(.*).tsv$"}\NormalTok{),}
                        \AttributeTok{full.names =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# read file}
\NormalTok{    list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/fingerid/"}\NormalTok{, files), read\_tsv)}
    \FunctionTok{names}\NormalTok{(list) }\OtherTok{\textless{}{-}} \FunctionTok{gsub}\NormalTok{(}\StringTok{".tsv"}\NormalTok{, }\StringTok{""}\NormalTok{, files)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# reformat the data}
    \ControlFlowTok{if}\NormalTok{(order }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# bind row as data frame}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(list, }\AttributeTok{idcol =}\NormalTok{ T)}
      \FunctionTok{colnames}\NormalTok{(df)[}\FunctionTok{which}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(df) }\SpecialCharTok{==} \StringTok{".id"}\NormalTok{)] }\OtherTok{\textless{}{-}} \StringTok{"file\_name"}
      \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{(df)}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# order upon CSI:fingerID score}
      \ControlFlowTok{if}\NormalTok{(structure\_method }\SpecialCharTok{==} \StringTok{"top\_score"}\NormalTok{)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{score),]}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{structure\_rank }\OtherTok{=} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df)}
      \DocumentationTok{\#\# order upon tanimoto similarity}
\NormalTok{      \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(structure\_method }\SpecialCharTok{==} \StringTok{"top\_similarity"}\NormalTok{)\{}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{tanimotoSimilarity }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{tanimotoSimilarity)}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{tanimotoSimilarity),]}
\NormalTok{        df}\SpecialCharTok{$}\NormalTok{structure\_rank }\OtherTok{=} \DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df)}
\NormalTok{      \}}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \ControlFlowTok{if}\NormalTok{(as\_tibble }\SpecialCharTok{==}\NormalTok{ T)\{}
\NormalTok{        df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(df)}
\NormalTok{      \}}
      \CommentTok{\# return with top n}
      \ControlFlowTok{if}\NormalTok{(return\_row[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{!=} \StringTok{"all"}\NormalTok{)\{}
        \FunctionTok{return}\NormalTok{(df[}\FunctionTok{which}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{\%in\%}\NormalTok{ return\_row),])}
\NormalTok{      \}}\ControlFlowTok{else}\NormalTok{\{}
        \FunctionTok{return}\NormalTok{(df)}
\NormalTok{      \}}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(list)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-grid_child_nebula.r}{%
\section{File: grid\_child\_nebula.R}\label{file-grid_child_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grid\_child\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           graph,}
           \AttributeTok{anno =} \FunctionTok{c}\NormalTok{(}\AttributeTok{nebula\_index =} \StringTok{"classification"}\NormalTok{),}
\NormalTok{           class,}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{title\_palette =}\NormalTok{ .MCn.palette\_label,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
           \AttributeTok{print\_into =}\NormalTok{ T,}
           \AttributeTok{save\_layout\_df =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{remove\_nodes =}\NormalTok{ F,}
           \AttributeTok{legend\_fill =}\NormalTok{ F,}
           \AttributeTok{legend\_size =}\NormalTok{ F,}
           \AttributeTok{remove\_legend\_lab =}\NormalTok{ F,}
           \AttributeTok{theme\_args =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# reformat graph, add with class}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
    \DocumentationTok{\#\# nodes {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    nodes }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(graph, class, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{ , }\AttributeTok{by.y =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(nodes)}
    \DocumentationTok{\#\# edges {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(graph, edges))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(edges) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{)\{}
      \DocumentationTok{\#\# "dotproduct" or other attributes of compare spectra method.}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(edges, }\AttributeTok{similarity =} \DecValTok{3}\NormalTok{)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      edges }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(edges, }\AttributeTok{similarity =} \ConstantTok{NA}\NormalTok{) }
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# gather nodes and edges}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ nodes, }\AttributeTok{edges =}\NormalTok{ edges)}
    \DocumentationTok{\#\# create network layout}
    \ControlFlowTok{if}\NormalTok{(layout }\SpecialCharTok{==} \StringTok{"fr"} \SpecialCharTok{\&} \FunctionTok{nrow}\NormalTok{(nodes) }\SpecialCharTok{\textgreater{}=} \DecValTok{500}\NormalTok{)}
\NormalTok{      layout }\OtherTok{=} \StringTok{"kk"}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(graph, }\AttributeTok{layout =}\NormalTok{ layout)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.environment}\NormalTok{(save\_layout\_df))\{}
      \FunctionTok{assign}\NormalTok{(}\StringTok{"layout\_n"}\NormalTok{, layout\_n, }\AttributeTok{envir =}\NormalTok{ save\_layout\_df)}
\NormalTok{    \}}
    \DocumentationTok{\#\# plot}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{base\_vis\_c\_nebula}\NormalTok{(layout\_n, palette,}
                           \AttributeTok{title =}\NormalTok{ anno[[}\StringTok{"nebula\_index"}\NormalTok{]],}
                           \AttributeTok{title\_fill =}\NormalTok{ title\_palette[}\FunctionTok{as.numeric}\NormalTok{(anno[[}\StringTok{"hierarchy"}\NormalTok{]])],}
                           \AttributeTok{remove\_nodes =}\NormalTok{ remove\_nodes,}
                           \AttributeTok{theme\_args =}\NormalTok{ theme\_args,}
\NormalTok{                           ...)}
    \DocumentationTok{\#\# if print into grid panel}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\NormalTok{print\_into)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
    \DocumentationTok{\#\# remove legend or not}
\NormalTok{    p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{guides}\NormalTok{(}\AttributeTok{size =} \FunctionTok{ifelse}\NormalTok{(legend\_size, }\StringTok{"legend"}\NormalTok{, }\StringTok{"none"}\NormalTok{),}
                             \AttributeTok{fill =} \FunctionTok{ifelse}\NormalTok{(legend\_fill, }\StringTok{"legend"}\NormalTok{, }\StringTok{"none"}\NormalTok{))}
    \DocumentationTok{\#\# color bar}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(class}\SpecialCharTok{$}\NormalTok{vis\_class) }\SpecialCharTok{==} \StringTok{"numeric"} \SpecialCharTok{\&}\NormalTok{ legend\_fill)\{}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_colorbar}\NormalTok{(}\AttributeTok{direction =} \StringTok{"horizontal"}\NormalTok{, }\AttributeTok{barheight =} \FloatTok{0.3}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# rm legend labal}
    \ControlFlowTok{if}\NormalTok{(remove\_legend\_lab)\{}
\NormalTok{      p }\OtherTok{\textless{}{-}}\NormalTok{ p }\SpecialCharTok{+} \FunctionTok{labs}\NormalTok{(}\AttributeTok{size =} \StringTok{""}\NormalTok{, }\AttributeTok{fill =} \StringTok{""}\NormalTok{)}
\NormalTok{    \}}
    \FunctionTok{print}\NormalTok{(p, }\AttributeTok{vp =}\NormalTok{ grid}\SpecialCharTok{::}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout.pos.row =}\NormalTok{ anno[[}\StringTok{"row"}\NormalTok{]],}
                                 \AttributeTok{layout.pos.col =}\NormalTok{ anno[[}\StringTok{"col"}\NormalTok{]]))}
\NormalTok{  \}}
\NormalTok{base\_vis\_c\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula,}
           \AttributeTok{title =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
           \AttributeTok{title\_fill =} \StringTok{"grey"}\NormalTok{,}
           \AttributeTok{nodes\_size\_range =} \FunctionTok{c}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{),}
           \AttributeTok{nodes\_stroke =} \FloatTok{0.2}\NormalTok{,}
           \AttributeTok{edges\_width\_range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{),}
           \AttributeTok{edges\_color =} \StringTok{"black"}\NormalTok{,}
           \AttributeTok{title\_size =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{remove\_nodes =}\NormalTok{ F,}
           \AttributeTok{legend\_position =} \StringTok{"right"}\NormalTok{,}
           \AttributeTok{scale\_fill\_expression =} \StringTok{"scale\_fill\_manual(values = palette)"}\NormalTok{,}
           \AttributeTok{theme\_args =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.vector}\NormalTok{(}\FunctionTok{attr}\NormalTok{(palette, }\StringTok{"name"}\NormalTok{)))}
\NormalTok{      palette }\OtherTok{\textless{}{-}}\NormalTok{ palette[}\FunctionTok{which}\NormalTok{(}\FunctionTok{names}\NormalTok{(palette) }\SpecialCharTok{\%in\%}\NormalTok{ nebula}\SpecialCharTok{$}\NormalTok{vis\_class)]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(remove\_nodes)\{}
\NormalTok{      nodes\_size\_range }\OtherTok{=} \DecValTok{0}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    theme\_args.default }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}
        \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
        \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
        \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{),}
        \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
        \DocumentationTok{\#\# cunstom defined legend position}
        \AttributeTok{legend.position =}\NormalTok{ legend\_position,}
        \AttributeTok{plot.title =}\NormalTok{ ggtext}\SpecialCharTok{::}\FunctionTok{element\_textbox}\NormalTok{(}
          \DocumentationTok{\#\# nebula name textbox}
          \AttributeTok{size =}\NormalTok{ title\_size,}
          \AttributeTok{color =} \StringTok{"white"}\NormalTok{, }\AttributeTok{fill =}\NormalTok{ title\_fill, }\AttributeTok{box.color =} \StringTok{"white"}\NormalTok{,}
          \AttributeTok{halign =} \FloatTok{0.5}\NormalTok{, }\AttributeTok{linetype =} \DecValTok{1}\NormalTok{, }\AttributeTok{r =} \FunctionTok{unit}\NormalTok{(}\DecValTok{5}\NormalTok{, }\StringTok{"pt"}\NormalTok{), }\AttributeTok{width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"npc"}\NormalTok{),}
          \AttributeTok{padding =} \FunctionTok{margin}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{), }\AttributeTok{margin =} \FunctionTok{margin}\NormalTok{(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{        ))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.list}\NormalTok{(theme\_args))\{}
\NormalTok{      theme\_args.default }\OtherTok{\textless{}{-}}\NormalTok{ theme\_args.default[}\SpecialCharTok{!}\FunctionTok{names}\NormalTok{(theme\_args.default) }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(theme\_args)]}
\NormalTok{      theme\_args }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(theme\_args.default, theme\_args)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      theme\_args }\OtherTok{\textless{}{-}}\NormalTok{ theme\_args.default}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(nebula) }\SpecialCharTok{+} 
      \DocumentationTok{\#\# compound MS2 similarity mapping as edge width}
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width =}\NormalTok{ similarity), }\AttributeTok{color =}\NormalTok{ edges\_color, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+} 
      \DocumentationTok{\#\# nodes size mapping as compound idenfication similarity}
      \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{ifelse}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity),}
                                                \DocumentationTok{\#\# if the tanimotoSimilarity is NA, set to 0.2}
\NormalTok{                                                tanimotoSimilarity, }\FloatTok{0.2}\NormalTok{),}
                                  \DocumentationTok{\#\# nodes fill. mapping as classification or custom mark}
                                  \AttributeTok{fill =}\NormalTok{ vis\_class),}
                              \AttributeTok{shape =} \DecValTok{21}\NormalTok{,}
                              \AttributeTok{stroke =}\NormalTok{ nodes\_stroke) }\SpecialCharTok{+} 
      \DocumentationTok{\#\# for custum commound expression}
      \FunctionTok{eval}\NormalTok{(}\FunctionTok{parse}\NormalTok{(}\AttributeTok{text =}\NormalTok{ scale\_fill\_expression)) }\SpecialCharTok{+}
      \DocumentationTok{\#\# set range for edge width}
      \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range =}\NormalTok{ edges\_width\_range) }\SpecialCharTok{+} 
      \DocumentationTok{\#\# for this setting, if range set to 0, remove the nodes}
      \FunctionTok{scale\_size}\NormalTok{(}\AttributeTok{range =}\NormalTok{ nodes\_size\_range) }\SpecialCharTok{+}
      \DocumentationTok{\#\# if the nodes is removed, the override.aes setting will retain nodes shape and color in legend}
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
      \DocumentationTok{\#\# the title is the annotation of classification}
      \FunctionTok{ggtitle}\NormalTok{(stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(title, }\AttributeTok{width =} \DecValTok{30}\NormalTok{)) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{size =} \StringTok{"Tanimoto}\SpecialCharTok{\textbackslash{}n}\StringTok{similarity"}\NormalTok{, }\AttributeTok{fill =} \StringTok{"Compound mark"}\NormalTok{) }\SpecialCharTok{+}
      \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{do.call}\NormalTok{(theme, theme\_args)}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-initialize_mcnebula.r}{%
\section{File: initialize\_mcnebula.R}\label{file-initialize_mcnebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param sirius\_path PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param output\_path PARAM\_DESCRIPTION, Default: sirius\_path}
\CommentTok{\#\textquotesingle{} @param output\_file PARAM\_DESCRIPTION, Default: \textquotesingle{}mcnebula\_results\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param palette PARAM\_DESCRIPTION, Default: unique(c((ggsci::pal\_simpsons())(16), (ggsci::pal\_igv("default"))(51)))}
\CommentTok{\#\textquotesingle{} @param palette\_stat PARAM\_DESCRIPTION, Default: palette}
\CommentTok{\#\textquotesingle{} @param palette\_label PARAM\_DESCRIPTION, Default: colorRampPalette(c("\#C6DBEFFF", "\#3182BDFF", "red"))(10)}
\CommentTok{\#\textquotesingle{} @param rm\_var PARAM\_DESCRIPTION, Default: F}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[ggsci]\{pal\_simpsons\}\}, \textbackslash{}code\{\textbackslash{}link[ggsci]\{pal\_igv\}\}}
\CommentTok{\#\textquotesingle{} @rdname initialize\_mcnebula}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom ggsci pal\_simpsons pal\_igv}

\NormalTok{initialize\_mcnebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           sirius\_path,}
           \AttributeTok{output\_path =}\NormalTok{ sirius\_path,}
           \AttributeTok{output\_file =} \StringTok{"mcnebula\_results"}\NormalTok{,}
           \AttributeTok{palette =} \FunctionTok{unique}\NormalTok{(}\FunctionTok{c}\NormalTok{(ggsci}\SpecialCharTok{::}\FunctionTok{pal\_simpsons}\NormalTok{()(}\DecValTok{16}\NormalTok{),}
\NormalTok{                              ggsci}\SpecialCharTok{::}\FunctionTok{pal\_igv}\NormalTok{(}\StringTok{"default"}\NormalTok{)(}\DecValTok{51}\NormalTok{),}
\NormalTok{                              ggsci}\SpecialCharTok{::}\FunctionTok{pal\_ucscgb}\NormalTok{()(}\DecValTok{26}\NormalTok{),}
\NormalTok{                              ggsci}\SpecialCharTok{::}\FunctionTok{pal\_d3}\NormalTok{(}\StringTok{"category20"}\NormalTok{)(}\DecValTok{20}\NormalTok{)}
\NormalTok{                              )),}
           \AttributeTok{palette\_stat =}\NormalTok{ palette,}
           \AttributeTok{palette\_ppcp =}\NormalTok{ palette,}
           \AttributeTok{palette\_label =} \FunctionTok{colorRampPalette}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{"\#C6DBEFFF"}\NormalTok{, }\StringTok{"\#3182BDFF"}\NormalTok{, }\StringTok{"red"}\NormalTok{))(}\DecValTok{10}\NormalTok{),}
           \AttributeTok{rm\_mc.set =}\NormalTok{ F}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(rm\_mc.set)\{}
      \FunctionTok{rm\_mc.set}\NormalTok{(}\AttributeTok{envir =}\NormalTok{ .GlobalEnv)}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(sirius\_path) }\SpecialCharTok{|} \SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(output\_path))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"File path not find.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{file.exists}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(sirius\_path, }\StringTok{"/"}\NormalTok{, }\StringTok{".format"}\NormalTok{)))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"SIRIUS project not find.}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    .MCn.sirius }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ sirius\_path}
\NormalTok{    .MCn.output }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ output\_path}
\NormalTok{    .MCn.results }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ output\_file}
\NormalTok{    .MCn.palette }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette}
\NormalTok{    .MCn.palette\_stat }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette\_stat}
\NormalTok{    .MCn.palette\_ppcp }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette\_ppcp}
\NormalTok{    .MCn.palette\_label }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ palette\_label}
    \FunctionTok{dir.create}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"MCnebula project has initialized at {-}\textgreater{}"}\NormalTok{, .MCn.output, }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{rm\_mc.set }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           envir,}
           \AttributeTok{pattern =} \StringTok{"\^{}}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.MCn}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{..*"}
\NormalTok{           )\{}
\NormalTok{    mc.set }\OtherTok{\textless{}{-}} \FunctionTok{ls}\NormalTok{(}\AttributeTok{pattern =}\NormalTok{ pattern, }\AttributeTok{envir =}\NormalTok{ envir, }\AttributeTok{all.names =}\NormalTok{ T)}
    \FunctionTok{rm}\NormalTok{(}\AttributeTok{list =}\NormalTok{ mc.set, }\AttributeTok{envir =}\NormalTok{ envir)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_formula_based_spec_compare.r}{%
\section{File: method\_formula\_based\_spec\_compare.R}\label{file-method_formula_based_spec_compare.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param path PARAM\_DESCRIPTION, Default: .MCn.sirius}
\CommentTok{\#\textquotesingle{} @param dirs PARAM\_DESCRIPTION, Default: \textquotesingle{}all\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param cpu\_cores PARAM\_DESCRIPTION, Default: 8}
\CommentTok{\#\textquotesingle{} @param compare\_fun PARAM\_DESCRIPTION, Default: \textquotesingle{}dotproduct\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param precursor\_mass\_diff PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param edge\_filter PARAM\_DESCRIPTION, Default: 0.3}
\CommentTok{\#\textquotesingle{} @param only\_identical\_class PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param min\_hierarchy PARAM\_DESCRIPTION, Default: 5}
\CommentTok{\#\textquotesingle{} @param filter\_only\_max PARAM\_DESCRIPTION, Default: 2000}
\CommentTok{\#\textquotesingle{} @param min\_zodiac PARAM\_DESCRIPTION, Default: 0.9}
\CommentTok{\#\textquotesingle{} @param min\_tanimoto PARAM\_DESCRIPTION, Default: 0.4}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{group\_by\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{summarise\_all\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{distinct\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_formula\_based\_spec\_compare}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom pbapply pbsapply pbmapply pbapply pblapply}
\CommentTok{\#\textquotesingle{} @importFrom dplyr rename mutate filter group\_by summarise\_at ungroup select distinct as\_tibble}

\NormalTok{method\_formula\_based\_spec\_compare }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{path =}\NormalTok{ .MCn.sirius,}
           \AttributeTok{dirs =} \StringTok{"all"}\NormalTok{,}
           \AttributeTok{cpu\_cores =} \DecValTok{8}\NormalTok{, }
           \AttributeTok{compare\_fun =} \StringTok{"dotproduct"}\NormalTok{,}
           \AttributeTok{precursor\_mass\_diff =}\NormalTok{ T,}
           \AttributeTok{edge\_filter =} \FloatTok{0.3}\NormalTok{,}
           \DocumentationTok{\#\# only identical classes will be compared (according to results of function:collate\_ppcp}
           \AttributeTok{only\_identical\_class =}\NormalTok{ T, }
           \CommentTok{\# only hierarchy \textgreater{}= 5 (class, subclass...) will be considered)}
           \AttributeTok{min\_hierarchy =} \DecValTok{5}\NormalTok{, }
           \CommentTok{\# only nodes number \textgreater{}= 2000, do zoidacScore and tanimotoSimilarity filter}
           \AttributeTok{filter\_only\_max =} \DecValTok{2000}\NormalTok{, }
           \CommentTok{\# only ZodiacScore \textgreater{}= 0.5 ...}
           \AttributeTok{min\_zodiac =} \FloatTok{0.9}\NormalTok{, }
           \CommentTok{\# only the top structure tanimotoSimilarity \textgreater{}= 0.4 ...}
           \AttributeTok{min\_tanimoto =} \FloatTok{0.4}\NormalTok{, }
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{formula\_set =}\NormalTok{ .MCn.formula\_set,}
           \AttributeTok{structure\_set =}\NormalTok{ .MCn.structure\_set,}
           \AttributeTok{target\_ids =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{get\_meta\_dir =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# check dirs {-}{-}{-}{-} spectra}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(dirs) }\SpecialCharTok{==} \DecValTok{1} \SpecialCharTok{\&}\NormalTok{ dirs[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"all"}\NormalTok{)\{}
\NormalTok{      dirs }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path, }\AttributeTok{pattern=}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_(.*)$"}\NormalTok{, }\AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{    \}}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: check\_dir}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    check }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbsapply}\NormalTok{(dirs, check\_dir, }\AttributeTok{file =} \StringTok{"spectra"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ unname}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# lock on file location}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dirs[}\FunctionTok{which}\NormalTok{(check)] }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{data.frame}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{dir =} \StringTok{"."}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{.id =} \FunctionTok{grep\_id}\NormalTok{(dir)) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(formula\_set, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{)], }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.vector}\NormalTok{(target\_ids))\{}
\NormalTok{      meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, .id }\SpecialCharTok{\%in\%}\NormalTok{ target\_ids)}
\NormalTok{    \}}
    \DocumentationTok{\#\# some .id were Avoid time{-}consuming calculation}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir) }\SpecialCharTok{\textgreater{}=}\NormalTok{ filter\_only\_max)\{}
\NormalTok{      meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, ZodiacScore }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_zodiac, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_tanimoto)}
\NormalTok{    \}}
\NormalTok{    meta\_dir }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta\_dir, }\AttributeTok{adduct\_trans =} \FunctionTok{gsub}\NormalTok{(}\StringTok{" "}\NormalTok{, }\StringTok{""}\NormalTok{, adduct),}
                              \AttributeTok{target =} \FunctionTok{paste0}\NormalTok{(precursorFormula, }\StringTok{"\_"}\NormalTok{, adduct\_trans, }\StringTok{".tsv"}\NormalTok{), }
                              \AttributeTok{full.name =} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"spectra"}\NormalTok{, }\StringTok{"/"}\NormalTok{, target), }
                              \DocumentationTok{\#\# these files need to be check and filter (whether exist)}
                              \AttributeTok{spectra =} \FunctionTok{file.exists}\NormalTok{(full.name))}
\NormalTok{    meta\_dir\_filter }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta\_dir, spectra)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of spectra dataset:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(meta\_dir\_filter), }\StringTok{"(formula with match spectra)"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(meta\_dir), }\StringTok{"(all formula)"}\NormalTok{), }
        \StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(get\_meta\_dir)}
      \FunctionTok{return}\NormalTok{(meta\_dir\_filter)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# load all spectra dataset}
\NormalTok{    spectra\_cache }\OtherTok{\textless{}{-}} \FunctionTok{new.env}\NormalTok{()}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(read\_as\_spectrum2, }\CommentTok{\# function}
\NormalTok{                      meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{full.name,}
\NormalTok{                      meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{,}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{(}
                                      \AttributeTok{cache =}\NormalTok{ spectra\_cache}
\NormalTok{                                      ))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# enumeration combination}
    \ControlFlowTok{if}\NormalTok{(only\_identical\_class)\{}
      \DocumentationTok{\#\# enumeration combination in each hierarchy}
\NormalTok{      combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index,}
\NormalTok{                             hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_hierarchy,}
\NormalTok{                             .id }\SpecialCharTok{\%in\%}\NormalTok{ meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(hierarchy) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# dispose in each group}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), unique) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), sort) }\SpecialCharTok{\%\textgreater{}\%}
        \DocumentationTok{\#\# enumerate possible}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{), combn\_edge) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{ungroup}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{()}
      \DocumentationTok{\#\# this column has two sub{-}colunm}
\NormalTok{      combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(combn}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# this cost too much time !!!}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{combn\_edge}\NormalTok{(meta\_dir\_filter}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# compareSpectra (ms2) (via MSnbase)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: compare\_spectra: sum:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(combn), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    combn[[compare\_fun]] }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(combn, }\DecValTok{1}\NormalTok{, couple\_ms2\_compare,}
                                             \AttributeTok{fun =}\NormalTok{ compare\_fun,}
                                             \AttributeTok{cl =}\NormalTok{ cpu\_cores,}
                                             \AttributeTok{cache =}\NormalTok{ spectra\_cache,}
\NormalTok{                                             ...)}
    \DocumentationTok{\#\# filter via spectra similarity (edge\_filter)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    combn }\OtherTok{\textless{}{-}}\NormalTok{ combn[}\FunctionTok{which}\NormalTok{(combn[[compare\_fun]] }\SpecialCharTok{\textgreater{}=}\NormalTok{ edge\_filter), ]}
    \ControlFlowTok{if}\NormalTok{(precursor\_mass\_diff }\SpecialCharTok{==}\NormalTok{ T)\{}
      \DocumentationTok{\#\# dir}
\NormalTok{      info\_path }\OtherTok{=} \FunctionTok{paste0}\NormalTok{(path, }\StringTok{"/"}\NormalTok{, meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"compound.info"}\NormalTok{)}
      \DocumentationTok{\#\# load file}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: load compound info file}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      meta\_dir\_filter}\SpecialCharTok{$}\NormalTok{compound\_mass }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(info\_path, get\_precursor\_mass) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{()}
      \DocumentationTok{\#\# compute mass difference}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: diff\_precursor\_mass: sum:"}\NormalTok{, }\FunctionTok{nrow}\NormalTok{(combn), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      combn[[}\StringTok{"mass\_diff"}\NormalTok{]] }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(combn[,}\DecValTok{1}\SpecialCharTok{:}\DecValTok{2}\NormalTok{], }\DecValTok{1}\NormalTok{, precursor\_mass\_diff,}
                                               \AttributeTok{df =}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(meta\_dir\_filter))}
\NormalTok{    \}}
\NormalTok{    combn }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(combn)}
    \FunctionTok{return}\NormalTok{(combn)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{  \}}
\NormalTok{read\_as\_spectrum2 }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(filename,}
\NormalTok{           key\_id,}
           \AttributeTok{cache =}\NormalTok{ spectra\_cache)\{}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(filename)}
\NormalTok{    file }\OtherTok{\textless{}{-}} \FunctionTok{new}\NormalTok{(}\StringTok{"Spectrum2"}\NormalTok{, }\AttributeTok{mz =}\NormalTok{ file}\SpecialCharTok{$}\NormalTok{mz, }\AttributeTok{intensity =}\NormalTok{ file}\SpecialCharTok{$}\NormalTok{rel.intensity)}
    \FunctionTok{assign}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(key\_id), file, }\AttributeTok{envir =}\NormalTok{ cache)}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{combn\_edge }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{    combn }\OtherTok{\textless{}{-}} \FunctionTok{combn}\NormalTok{(x, }\DecValTok{2}\NormalTok{)}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(combn)}
\NormalTok{      combn }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(combn)}
      \FunctionTok{colnames}\NormalTok{(combn) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{".id\_1"}\NormalTok{, }\StringTok{".id\_2"}\NormalTok{)}
      \FunctionTok{return}\NormalTok{(combn)}
\NormalTok{  \}}
\NormalTok{couple\_ms2\_compare }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x,}
           \AttributeTok{fun =} \StringTok{"dotproduct"}\NormalTok{,}
           \AttributeTok{cache =}\NormalTok{ spectra\_cache,}
\NormalTok{           ...)\{}
\NormalTok{    simi }\OtherTok{\textless{}{-}}\NormalTok{ MSnbase}\SpecialCharTok{::}\FunctionTok{compareSpectra}\NormalTok{(}\FunctionTok{get}\NormalTok{(x[}\DecValTok{1}\NormalTok{], }\AttributeTok{envir =}\NormalTok{ cache),}
                                    \FunctionTok{get}\NormalTok{(x[}\DecValTok{2}\NormalTok{], }\AttributeTok{envir =}\NormalTok{ cache),}
                                    \AttributeTok{fun =}\NormalTok{ fun,}
\NormalTok{                                    ...)}
    \FunctionTok{return}\NormalTok{(simi)}
\NormalTok{  \}}
\NormalTok{get\_precursor\_mass }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           path}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{read\_tsv}\NormalTok{(path)}
\NormalTok{    mass }\OtherTok{\textless{}{-}}\NormalTok{ df[index }\SpecialCharTok{==} \StringTok{"ionMass"}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\NormalTok{    mass }\OtherTok{\textless{}{-}} \FunctionTok{as.numeric}\NormalTok{(mass)}
    \FunctionTok{return}\NormalTok{(mass)}
\NormalTok{  \}}
\NormalTok{precursor\_mass\_diff }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
\NormalTok{           df}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    x1 }\OtherTok{=}\NormalTok{ df[.id }\SpecialCharTok{==}\NormalTok{ x[}\DecValTok{1}\NormalTok{], ]}\SpecialCharTok{$}\StringTok{"compound\_mass"}
\NormalTok{    x2 }\OtherTok{=}\NormalTok{ df[.id }\SpecialCharTok{==}\NormalTok{ x[}\DecValTok{2}\NormalTok{], ]}\SpecialCharTok{$}\StringTok{"compound\_mass"}
\NormalTok{    x }\OtherTok{=}\NormalTok{ x2 }\SpecialCharTok{{-}}\NormalTok{ x1}
    \FunctionTok{return}\NormalTok{(x)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_pick_formula_excellent.r}{%
\section{File: method\_pick\_formula\_excellent.R}\label{file-method_pick_formula_excellent.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param dir PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param key\_id PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param exclude\_element PARAM\_DESCRIPTION, Default: NULL}
\CommentTok{\#\textquotesingle{} @param ppm\_error PARAM\_DESCRIPTION, Default: 20}
\CommentTok{\#\textquotesingle{} @param fc PARAM\_DESCRIPTION, Default: 1.5}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_pick\_formula\_excellent}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr mutate}
\NormalTok{method\_pick\_formula\_excellent }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{key\_id =} \ConstantTok{NULL}\NormalTok{, }
           \AttributeTok{dir =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{exclude\_element =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{ppm\_error =} \DecValTok{20}\NormalTok{,}
           \AttributeTok{fc =} \ConstantTok{NA}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(dir) }\SpecialCharTok{\textgreater{}=} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      meta }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{dir =}\NormalTok{ dir)}
\NormalTok{      meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta, }\AttributeTok{key\_id =} \FunctionTok{grep\_id}\NormalTok{(dir))}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      meta }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{(}\AttributeTok{key\_id =}\NormalTok{ key\_id, }\AttributeTok{dir =} \FunctionTok{get\_dir}\NormalTok{(key\_id))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    meta }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(meta,}
                          \AttributeTok{formula\_dir =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{,}
                                               \StringTok{"formula\_candidates.tsv"}\NormalTok{),}
                          \AttributeTok{structure\_dir =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{,}
                                                 \StringTok{"structure\_candidates.tsv"}\NormalTok{),}
                          \AttributeTok{fingerid =} \FunctionTok{paste0}\NormalTok{(.MCn.sirius, }\StringTok{"/"}\NormalTok{, dir, }\StringTok{"/"}\NormalTok{, }\StringTok{"fingerid"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: batch\_get\_formula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    formula\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(meta}\SpecialCharTok{$}\NormalTok{key\_id, mutate\_get\_formula,}
                                      \AttributeTok{ppm\_error =}\NormalTok{ ppm\_error, }\AttributeTok{exclude\_element =}\NormalTok{ exclude\_element)}
\NormalTok{    formula\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(formula\_list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# get top ZodiacScore within a key\_id formula set}
\NormalTok{    df\_fz }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(formula\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{)}
\NormalTok{    df\_fz }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(df\_fz)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: batch\_get\_structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    structure\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(mutate\_get\_structure, meta}\SpecialCharTok{$}\NormalTok{structure\_dir, meta}\SpecialCharTok{$}\NormalTok{key\_id,}
                                        \AttributeTok{SIMPLIFY =}\NormalTok{ F)}
\NormalTok{    structure\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(structure\_list)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# merge structure\_df with formula\_df, to get ZodiacScore of top structure}
\NormalTok{    structure\_df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(structure\_df, formula\_df, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(fc) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      df\_sz }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(structure\_df, }\AttributeTok{sz\_score =}\NormalTok{ ZodiacScore)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \DocumentationTok{\#\# compare fz\_score with sz\_score}
\NormalTok{      compare }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df\_fz[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"ZodiacScore"}\NormalTok{), }\AttributeTok{with =}\NormalTok{ F],}
\NormalTok{                       df\_sz[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"sz\_score"}\NormalTok{), }\AttributeTok{with =}\NormalTok{ F],}
                       \AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{)}
\NormalTok{      compare }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(compare,}
                               \AttributeTok{use\_zodiac =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(sz\_score), T,}
                                                   \FunctionTok{ifelse}\NormalTok{(ZodiacScore }\SpecialCharTok{\textgreater{}=}\NormalTok{ sz\_score }\SpecialCharTok{*}\NormalTok{ fc, T, F)}
\NormalTok{                                                   ))}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
      \DocumentationTok{\#\# the .id which formula of use\_zodiac or not}
\NormalTok{      fz }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(compare, use\_zodiac }\SpecialCharTok{==}\NormalTok{ T)}\SpecialCharTok{$}\StringTok{".id"}
\NormalTok{      sz }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(compare, use\_zodiac }\SpecialCharTok{==}\NormalTok{ F)}\SpecialCharTok{$}\StringTok{".id"}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      sz }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df}\SpecialCharTok{$}\StringTok{".id"}
\NormalTok{      fz }\OtherTok{\textless{}{-}}\NormalTok{ df\_fz}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{[}\FunctionTok{which}\NormalTok{(}\SpecialCharTok{!}\NormalTok{df\_fz}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{\%in\%}\NormalTok{ sz)]}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    df\_fz }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(df\_fz[.id }\SpecialCharTok{\%in\%}\NormalTok{ fz, ], }\AttributeTok{use\_zodiac =}\NormalTok{ T)}
\NormalTok{    df\_sz }\OtherTok{\textless{}{-}} \FunctionTok{mutate}\NormalTok{(structure\_df[.id }\SpecialCharTok{\%in\%}\NormalTok{ sz, ], }\AttributeTok{use\_zodiac =}\NormalTok{ F)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{bind\_rows}\NormalTok{(df\_fz, df\_sz)}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(formula\_adduct) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, }\FunctionTok{colnames}\NormalTok{(.))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \FunctionTok{return}\NormalTok{(formula\_adduct)}
\NormalTok{  \}}
\NormalTok{mutate\_get\_formula }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           key\_id,}
\NormalTok{           ppm\_error,}
\NormalTok{           exclude\_element}
\NormalTok{           )\{}
\NormalTok{    formula\_df }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\AttributeTok{silent =}\NormalTok{ T, }\FunctionTok{get\_formula}\NormalTok{(key\_id, }\AttributeTok{rank =} \StringTok{"all"}\NormalTok{, }\AttributeTok{ppm\_error =}\NormalTok{ ppm\_error,}
                                              \AttributeTok{exclude\_element =}\NormalTok{ exclude\_element))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(formula\_df)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      formula\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(formula\_df,}
                                  \AttributeTok{ZodiacScore =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{grepl}\NormalTok{(}\StringTok{"[0{-}9]"}\NormalTok{, ZodiacScore),}
\NormalTok{                                                       ZodiacScore, }\DecValTok{0}\NormalTok{),}
                                  \AttributeTok{ZodiacScore =} \FunctionTok{as.numeric}\NormalTok{(ZodiacScore))}
\NormalTok{      formula\_df}\SpecialCharTok{$}\StringTok{".id"} \OtherTok{\textless{}{-}}\NormalTok{ key\_id}
      \FunctionTok{return}\NormalTok{(formula\_df)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{mutate\_get\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_dir,}
\NormalTok{           key\_id}
\NormalTok{           )\{}
\NormalTok{    structure\_df }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(}\AttributeTok{silent =}\NormalTok{ T, }\FunctionTok{read\_tsv}\NormalTok{(structure\_dir))}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{class}\NormalTok{(structure\_df)[}\DecValTok{1}\NormalTok{] }\SpecialCharTok{==} \StringTok{"try{-}error"}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(structure\_df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    max }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(structure\_df}\SpecialCharTok{$}\StringTok{"CSI:FingerIDScore"}\NormalTok{)}
\NormalTok{    structure\_df }\OtherTok{\textless{}{-}}\NormalTok{ structure\_df[}\StringTok{\textasciigrave{}}\AttributeTok{CSI:FingerIDScore}\StringTok{\textasciigrave{}} \SpecialCharTok{==}\NormalTok{ max, }\FunctionTok{c}\NormalTok{(}\StringTok{"molecularFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{), with }\OtherTok{=}\NormalTok{ F]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(structure\_df) }\SpecialCharTok{\textgreater{}} \DecValTok{1}\NormalTok{)\{}
\NormalTok{      structure\_df }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(structure\_df, }\AttributeTok{n =} \DecValTok{1}\NormalTok{)}
\NormalTok{    \}}
\NormalTok{    structure\_df}\SpecialCharTok{$}\StringTok{".id"} \OtherTok{\textless{}{-}}\NormalTok{ key\_id}
    \FunctionTok{return}\NormalTok{(structure\_df)}
\NormalTok{  \}}
\NormalTok{get\_dir }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(}
\NormalTok{                    key\_id,}
                    \AttributeTok{path =}\NormalTok{ .MCn.sirius}
\NormalTok{                    )\{}
\NormalTok{  dir }\OtherTok{\textless{}{-}} \FunctionTok{list.files}\NormalTok{(}\AttributeTok{path =}\NormalTok{ path,}
                    \AttributeTok{pattern=}\FunctionTok{paste0}\NormalTok{(}\StringTok{"\^{}[0{-}9](.*)\_(.*)\_"}\NormalTok{, key\_id, }\StringTok{"$"}\NormalTok{),}
                    \AttributeTok{full.names =}\NormalTok{ F)}
\NormalTok{  check }\OtherTok{\textless{}{-}} \FunctionTok{check\_dir}\NormalTok{(dir)}
  \ControlFlowTok{if}\NormalTok{(check }\SpecialCharTok{==}\NormalTok{ T)\{}
    \FunctionTok{return}\NormalTok{(dir)}
\NormalTok{  \}}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_summarize_nebula_class.r}{%
\section{File: method\_summarize\_nebula\_class.R}\label{file-method_summarize_nebula_class.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param data PPCP dataset}
\CommentTok{\#\textquotesingle{} @param ppcp\_threshold PARAM\_DESCRIPTION, Default: 0.5}
\CommentTok{\#\textquotesingle{} @param max\_classes PARAM\_DESCRIPTION, Default: 5}
\CommentTok{\#\textquotesingle{} @param hierarchy\_priority PARAM\_DESCRIPTION, Default: c(6, 5, 4, 3)}
\CommentTok{\#\textquotesingle{} @param class\_data\_type PARAM\_DESCRIPTION, Default: \textquotesingle{}classes\_tree\_list\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_summarize\_nebula\_class}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr rename filter}
\NormalTok{method\_summarize\_nebula\_class }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           data,}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}\NormalTok{,}
           \AttributeTok{max\_classes =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{hierarchy\_priority =} \FunctionTok{c}\NormalTok{(}\DecValTok{6}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{), }\DocumentationTok{\#\# level 5, subclass, class, superclass}
           \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_list"}\NormalTok{, }\DocumentationTok{\#\# or "classes\_tree\_data"}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# input data }
    \ControlFlowTok{if}\NormalTok{(class\_data\_type }\SpecialCharTok{==} \StringTok{"classes\_tree\_list"}\NormalTok{)\{}
\NormalTok{      class\_data }\OtherTok{=}\NormalTok{ .MCn.class\_tree\_list}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(class\_data, }\AttributeTok{idcol =}\NormalTok{ T)}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(metadata, }\AttributeTok{hierarchy =}\NormalTok{ .id)}
\NormalTok{    \}}\ControlFlowTok{else} \ControlFlowTok{if}\NormalTok{(class\_data\_type }\SpecialCharTok{==} \StringTok{"classes\_tree\_data"}\NormalTok{)\{}
\NormalTok{      metadata }\OtherTok{\textless{}{-}}\NormalTok{ class\_data }\OtherTok{\textless{}{-}} \FunctionTok{get}\NormalTok{(}\StringTok{"metadata"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{get}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{))}
\NormalTok{    \}}
    \DocumentationTok{\#\# main body}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, V1 }\SpecialCharTok{\textgreater{}=}\NormalTok{ ppcp\_threshold)}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(df, metadata[, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{5}\NormalTok{], }\AttributeTok{all.x =}\NormalTok{ T, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, hierarchy }\SpecialCharTok{\%in\%}\NormalTok{ hierarchy\_priority)}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ df[}\FunctionTok{order}\NormalTok{(}\FunctionTok{factor}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{hierarchy, }\AttributeTok{levels =}\NormalTok{ hierarchy\_priority), }\SpecialCharTok{{-}}\NormalTok{df}\SpecialCharTok{$}\NormalTok{V1), ]}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(max\_classes) }\SpecialCharTok{==}\NormalTok{ F)}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{head}\NormalTok{(df, }\AttributeTok{n =}\NormalTok{ max\_classes)}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-method_summarize_nebula_index.r}{%
\section{File: method\_summarize\_nebula\_index.R}\label{file-method_summarize_nebula_index.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param ppcp\_dataset PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param nebula\_class PARAM\_DESCRIPTION, Default: .MCn.nebula\_class}
\CommentTok{\#\textquotesingle{} @param ppcp\_threshold PARAM\_DESCRIPTION, Default: 0.5}
\CommentTok{\#\textquotesingle{} @param min\_possess PARAM\_DESCRIPTION, Default: 10}
\CommentTok{\#\textquotesingle{} @param max\_possess\_pct PARAM\_DESCRIPTION, Default: 0.2}
\CommentTok{\#\textquotesingle{} @param identical\_factor PARAM\_DESCRIPTION, Default: 0.8}
\CommentTok{\#\textquotesingle{} @param filter\_identical PARAM\_DESCRIPTION, Default: c(top\_hierarchy = 4)}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{distinct\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{group\_by\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{} @rdname method\_summarize\_nebula\_index}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr distinct filter rename select group\_by}
\CommentTok{\#\textquotesingle{} @importFrom pbapply pblapply}
\NormalTok{method\_summarize\_nebula\_index }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{ppcp\_dataset =}\NormalTok{ .MCn.ppcp\_dataset,}
           \AttributeTok{nebula\_class =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}\NormalTok{,}
           \CommentTok{\# min number of compounds allowed exist in a child{-}nebula. if less than, filter the nebula}
           \AttributeTok{min\_possess =} \DecValTok{10}\NormalTok{, }
           \DocumentationTok{\#\# max percentage of compounds allowed exist in a child{-}nebula}
           \AttributeTok{max\_possess\_pct =} \FloatTok{0.2}\NormalTok{, }
           \DocumentationTok{\#\# identical filter}
           \AttributeTok{filter\_identical =} \FunctionTok{c}\NormalTok{(}\StringTok{"top\_hierarchy"} \OtherTok{=} \DecValTok{4}\NormalTok{), }
           \AttributeTok{identical\_factor =} \FloatTok{0.7}\NormalTok{,}
           \AttributeTok{rm\_position\_describe\_class =}\NormalTok{ T,}
           \DocumentationTok{\#\# in the nebula, if too many structure score is too low, filter the nebula.}
           \DocumentationTok{\#\# or NA}
           \AttributeTok{filter\_via\_struc\_score =} \StringTok{"tanimotoSimilarity"}\NormalTok{, }
           \AttributeTok{struc\_score\_cutoff =} \FloatTok{0.3}\NormalTok{,}
           \AttributeTok{min\_reached\_pct =} \FloatTok{0.6}\NormalTok{,}
           \AttributeTok{target\_classes =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.list}\NormalTok{(nebula\_class))\{}
\NormalTok{      classes }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(nebula\_class)}
      \ControlFlowTok{if}\NormalTok{(rm\_position\_describe\_class)\{}
\NormalTok{        classes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(classes, }\SpecialCharTok{!}\FunctionTok{grepl}\NormalTok{(}\StringTok{"[0{-}9]"}\NormalTok{, name))}
\NormalTok{      \}}
      \DocumentationTok{\#\# classes is merely a classes index number set}
\NormalTok{      classes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(classes, relativeIndex)}\SpecialCharTok{$}\NormalTok{relativeIndex}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      classes }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    \}}
    \DocumentationTok{\#\# user defined classes}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.vector}\NormalTok{(target\_classes))\{}
\NormalTok{      target\_classes }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.class\_tree\_data, name }\SpecialCharTok{\%in\%}\NormalTok{ target\_classes)}
      \DocumentationTok{\#\# merge}
\NormalTok{      classes }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(classes, target\_classes}\SpecialCharTok{$}\NormalTok{relativeIndex)}
\NormalTok{    \}}
    \DocumentationTok{\#\# get classes}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: class\_retrieve}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    index\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(ppcp\_dataset, class\_retrieve,}
                                    \AttributeTok{the\_relativeIndex =}\NormalTok{ classes,}
\NormalTok{                                    ...)}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(index\_list, }\AttributeTok{idcol =}\NormalTok{ T)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# filter via max\_possess and min\_possess}
\NormalTok{    stat }\OtherTok{\textless{}{-}} \FunctionTok{table}\NormalTok{(index\_df}\SpecialCharTok{$}\NormalTok{relativeIndex)}
\NormalTok{    stat }\OtherTok{\textless{}{-}}\NormalTok{ stat[}\FunctionTok{which}\NormalTok{(stat }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_possess }\SpecialCharTok{\&}\NormalTok{ stat }\SpecialCharTok{\textless{}=}\NormalTok{ max\_possess\_pct }\SpecialCharTok{*} \FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(index\_df}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)))]}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ index\_df }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(relativeIndex }\SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(stat))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# gather with classes annotation}
\NormalTok{    index\_df }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(.MCn.class\_tree\_list, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{hierarchy =}\NormalTok{ .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(relativeIndex, name, hierarchy) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(index\_df, }\AttributeTok{by =} \StringTok{"relativeIndex"}\NormalTok{, }\AttributeTok{all.y =}\NormalTok{ T, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{data.table}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(identical\_factor))\{}
      \DocumentationTok{\#\# filter identical or similar classes}
      \DocumentationTok{\#\# enumerate combination}
\NormalTok{      class\_for\_merge }\OtherTok{\textless{}{-}}\NormalTok{ index\_df }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ filter\_identical[[}\StringTok{"top\_hierarchy"}\NormalTok{]]) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(relativeIndex) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{combn}\NormalTok{(}\AttributeTok{m =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{t}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{data.frame}\NormalTok{()}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: identical\_filter}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      discard }\OtherTok{=}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pbapply}\NormalTok{(class\_for\_merge, }\DecValTok{1}\NormalTok{, identical\_filter,}
                                 \AttributeTok{index\_df =}\NormalTok{ index\_df,}
                                 \AttributeTok{identical\_factor =}\NormalTok{ identical\_factor,}
\NormalTok{                                 ...) }\SpecialCharTok{\%\textgreater{}\%}
        \FunctionTok{unlist}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{unique}\NormalTok{()}
\NormalTok{      index\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(index\_df, }\SpecialCharTok{!}\NormalTok{relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ discard)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(filter\_via\_struc\_score))\{}
\NormalTok{      df }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(index\_df, .MCn.structure\_set[, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, filter\_via\_struc\_score)],}
                  \AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T)}
\NormalTok{      list }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(df, }\StringTok{"relativeIndex"}\NormalTok{)}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# Method part: fun\_filter\_via\_struc\_score}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      select\_index }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(list, fun\_filter\_via\_struc\_score,}
\NormalTok{                                        filter\_via\_struc\_score,}
\NormalTok{                                        struc\_score\_cutoff,}
\NormalTok{                                        min\_reached\_pct)}
\NormalTok{      select\_index }\OtherTok{\textless{}{-}} \FunctionTok{unlist}\NormalTok{(select\_index)}
\NormalTok{      index\_df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(index\_df, relativeIndex }\SpecialCharTok{\%in\%} \FunctionTok{all\_of}\NormalTok{(select\_index))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# cluster id in each classes}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(index\_df, relativeIndex)}
    \FunctionTok{return}\NormalTok{(nebula\_index)}
\NormalTok{  \}}
\NormalTok{class\_retrieve }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           data,}
\NormalTok{           the\_relativeIndex,}
           \AttributeTok{ppcp\_threshold =} \FloatTok{0.5}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    classes }\OtherTok{\textless{}{-}}\NormalTok{ the\_relativeIndex}
\NormalTok{    data }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(data, relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ classes, V1 }\SpecialCharTok{\textgreater{}=}\NormalTok{ ppcp\_threshold)}
    \FunctionTok{return}\NormalTok{(data)}
\NormalTok{  \}}
\NormalTok{identical\_filter }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           couple,}
\NormalTok{           index\_df,}
           \AttributeTok{identical\_factor =} \FloatTok{0.7}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \DocumentationTok{\#\# index\_df is a data.table project}
\NormalTok{    x }\OtherTok{=} \FunctionTok{unique}\NormalTok{(index\_df[relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ couple[}\DecValTok{1}\NormalTok{], ]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    y }\OtherTok{=} \FunctionTok{unique}\NormalTok{(index\_df[relativeIndex }\SpecialCharTok{\%in\%}\NormalTok{ couple[}\DecValTok{2}\NormalTok{], ]}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
\NormalTok{    p\_x }\OtherTok{=} \FunctionTok{table}\NormalTok{(x }\SpecialCharTok{\%in\%}\NormalTok{ y)}
\NormalTok{    p\_y }\OtherTok{=} \FunctionTok{table}\NormalTok{(y }\SpecialCharTok{\%in\%}\NormalTok{ x)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"TRUE"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(p\_x) }\SpecialCharTok{==}\NormalTok{ F }\SpecialCharTok{|} \StringTok{"TRUE"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(p\_y) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{    p\_x }\OtherTok{=} \FunctionTok{prop.table}\NormalTok{(p\_x)[[}\StringTok{"TRUE"}\NormalTok{]]}
\NormalTok{    p\_y }\OtherTok{=} \FunctionTok{prop.table}\NormalTok{(p\_y)[[}\StringTok{"TRUE"}\NormalTok{]]}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(p\_x }\SpecialCharTok{\textgreater{}=}\NormalTok{ identical\_factor }\SpecialCharTok{\&}\NormalTok{ p\_y }\SpecialCharTok{\textgreater{}=}\NormalTok{ identical\_factor)\{}
\NormalTok{      idn }\OtherTok{=} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{length}\NormalTok{(x) }\SpecialCharTok{\textgreater{}=} \FunctionTok{length}\NormalTok{(y), couple[}\DecValTok{2}\NormalTok{], couple[}\DecValTok{1}\NormalTok{])}
      \FunctionTok{return}\NormalTok{(idn)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{fun\_filter\_via\_struc\_score }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           df,}
           \AttributeTok{score =} \StringTok{"tanimotoSimilarity"}\NormalTok{,}
           \AttributeTok{cutoff =} \FloatTok{0.4}\NormalTok{,}
           \AttributeTok{min\_reached\_pct =} \FloatTok{0.5}
\NormalTok{           )\{}
\NormalTok{    x }\OtherTok{\textless{}{-}}\NormalTok{ df[[score]]}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{reach =} \FunctionTok{ifelse}\NormalTok{(x }\SpecialCharTok{\textgreater{}=}\NormalTok{ cutoff }\SpecialCharTok{\&}
                                           \FunctionTok{is.na}\NormalTok{(x) }\SpecialCharTok{==}\NormalTok{ F,}
\NormalTok{                                         T, F))}
\NormalTok{    check }\OtherTok{\textless{}{-}} \FunctionTok{prop.table}\NormalTok{(}\FunctionTok{table}\NormalTok{(df[[}\StringTok{"reach"}\NormalTok{]]))}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"TRUE"} \SpecialCharTok{\%in\%} \FunctionTok{names}\NormalTok{(check) }\SpecialCharTok{==}\NormalTok{ F)}
      \FunctionTok{return}\NormalTok{()}
    \ControlFlowTok{if}\NormalTok{(check[[}\StringTok{"TRUE"}\NormalTok{]] }\SpecialCharTok{\textgreater{}=}\NormalTok{ min\_reached\_pct)\{}
      \FunctionTok{return}\NormalTok{(df[}\DecValTok{1}\NormalTok{, ]}\SpecialCharTok{$}\NormalTok{relativeIndex)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
      \FunctionTok{return}\NormalTok{()}
\NormalTok{    \}}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{method\_summarize\_target\_index }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           target\_classes}
\NormalTok{           )\{}
\NormalTok{    target\_index }\OtherTok{\textless{}{-}} \FunctionTok{method\_summarize\_nebula\_index}\NormalTok{(}\AttributeTok{nebula\_class =} \ConstantTok{NA}\NormalTok{,}
                                                  \AttributeTok{target\_classes =}\NormalTok{ target\_classes,}
                                                  \AttributeTok{identical\_factor =} \ConstantTok{NA}\NormalTok{,}
                                                  \AttributeTok{filter\_via\_struc\_score =} \ConstantTok{NA}\NormalTok{,}
                                                  \AttributeTok{max\_possess\_pct =} \DecValTok{1}\NormalTok{,}
                                                  \AttributeTok{min\_possess =} \DecValTok{1}
\NormalTok{    )}
    \FunctionTok{return}\NormalTok{(target\_index)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-mutate_get_parent_class.r}{%
\section{File: mutate\_get\_parent\_class.R}\label{file-mutate_get_parent_class.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mutate\_get\_parent\_class }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           classes,}
           \AttributeTok{class\_cutoff =} \DecValTok{4}\NormalTok{,}
           \AttributeTok{meta =}\NormalTok{ .MCn.class\_tree\_data,}
           \AttributeTok{this\_class =}\NormalTok{ F}
\NormalTok{           )\{}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# get\_parent\_class}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    db }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(meta, hierarchy }\SpecialCharTok{\textgreater{}=}\NormalTok{ class\_cutoff)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
    \DocumentationTok{\#\# for name to get id}
\NormalTok{    db\_id }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{id, c)}
    \FunctionTok{names}\NormalTok{(db\_id) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{name}
    \DocumentationTok{\#\# for id to get parentId}
\NormalTok{    db\_parent }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{parentId, c)}
    \FunctionTok{names}\NormalTok{(db\_parent) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{id}
    \DocumentationTok{\#\# for id to get name}
\NormalTok{    db\_name }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(db}\SpecialCharTok{$}\NormalTok{name, c)}
    \FunctionTok{names}\NormalTok{(db\_name) }\OtherTok{\textless{}{-}}\NormalTok{ db}\SpecialCharTok{$}\NormalTok{id}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    set\_list }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(classes, get\_parent\_class,}
                                  \AttributeTok{db\_id =}\NormalTok{ db\_id,}
                                  \AttributeTok{db\_parent =}\NormalTok{ db\_parent,}
                                  \AttributeTok{db\_name =}\NormalTok{ db\_name,}
                                  \AttributeTok{this\_class =}\NormalTok{ this\_class)}
    \FunctionTok{names}\NormalTok{(set\_list) }\OtherTok{\textless{}{-}}\NormalTok{ classes}
    \FunctionTok{return}\NormalTok{(set\_list)}
\NormalTok{  \}}
\NormalTok{get\_parent\_class }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           class,}
\NormalTok{           db\_id,}
\NormalTok{           db\_parent,}
\NormalTok{           db\_name,}
           \AttributeTok{this\_class =}\NormalTok{ F}
\NormalTok{           )\{}
\NormalTok{    set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{()}
\NormalTok{    parent }\OtherTok{\textless{}{-}} \DecValTok{0}
\NormalTok{    id }\OtherTok{\textless{}{-}}\NormalTok{ db\_id[[class]]}
\NormalTok{    test }\OtherTok{\textless{}{-}} \FunctionTok{try}\NormalTok{(db\_parent[[id]], }\AttributeTok{silent =}\NormalTok{ T)}
    \ControlFlowTok{if}\NormalTok{ (}\FunctionTok{inherits}\NormalTok{(test, }\StringTok{"try{-}error"}\NormalTok{))}
      \FunctionTok{return}\NormalTok{()}
    \ControlFlowTok{while}\NormalTok{(}\FunctionTok{is.null}\NormalTok{(parent) }\SpecialCharTok{==}\NormalTok{ F)\{}
      \ControlFlowTok{if}\NormalTok{(parent }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{)\{}
\NormalTok{        set }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(set, db\_name[[parent]])}
\NormalTok{        id }\OtherTok{\textless{}{-}}\NormalTok{ parent}
\NormalTok{      \}}
\NormalTok{      parent }\OtherTok{\textless{}{-}}\NormalTok{ db\_parent[[id]]}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{length}\NormalTok{(set) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \ControlFlowTok{if}\NormalTok{(this\_class }\SpecialCharTok{==}\NormalTok{ T)}
        \FunctionTok{return}\NormalTok{(class)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(set)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-nebula_re_rank.r}{%
\section{File: nebula\_re\_rank.R}\label{file-nebula_re_rank.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param nebula\_name PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param top\_n PARAM\_DESCRIPTION, Default: 10}
\CommentTok{\#\textquotesingle{} @param match\_pattern PARAM\_DESCRIPTION, Default: c("precursorFormula")}
\CommentTok{\#\textquotesingle{} @param collate\_factor PARAM\_DESCRIPTION, Default: 0.85}
\CommentTok{\#\textquotesingle{} @param revise\_MCn\_formula\_set PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param revise\_MCn\_structure\_set PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{filter\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{arrange\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{distinct\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[tidyr]\{separate\}\}}
\CommentTok{\#\textquotesingle{} @rdname nebula\_re\_rank}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom dplyr filter as\_tibble arrange mutate select distinct}
\CommentTok{\#\textquotesingle{} @importFrom pbapply pblapply}
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom tidyr separate}
\NormalTok{nebula\_re\_rank }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{top\_n =} \DecValTok{50}\NormalTok{,}
           \AttributeTok{match\_pattern =} \ConstantTok{NULL}\NormalTok{, }\CommentTok{\# c("precursorFormula"), or c("precursorFormula", "adduct")}
           \AttributeTok{collate\_factor =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{only\_gather\_structure =}\NormalTok{ F,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{reference\_compound =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{reference\_ratio =} \FloatTok{0.5}\NormalTok{,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{cluster\_method =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{csi\_score\_weight =} \FloatTok{0.6}\NormalTok{,}
           \AttributeTok{class\_similarity\_weight =} \FloatTok{0.3}\NormalTok{,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{filter\_via\_classification =}\NormalTok{ F,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{rt\_set =} \ConstantTok{NA}\NormalTok{,}
           \AttributeTok{rt\_weight =} \FloatTok{0.1}\NormalTok{,}
           \AttributeTok{rt\_window =} \FloatTok{1.5}\NormalTok{,}
           \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
           \AttributeTok{revise\_MCn\_formula\_set =}\NormalTok{ F,}
           \AttributeTok{revise\_MCn\_structure\_set =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: nebula\_re\_rank}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}} \FunctionTok{get\_nebula\_structure\_candidates}\NormalTok{(nebula\_name, top\_n, match\_pattern, collate\_factor,}
\NormalTok{                                                     ...)}
    \ControlFlowTok{if}\NormalTok{(only\_gather\_structure }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(structure\_set))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(reference\_compound) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      reference\_compound }\OtherTok{\textless{}{-}} \FunctionTok{set\_reference\_compound}\NormalTok{(structure\_set, reference\_ratio)}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      reference\_compound }\OtherTok{\textless{}{-}}\NormalTok{ reference\_compound}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# cluster method}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(cluster\_method) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      method\_fun }\OtherTok{\textless{}{-}} \FunctionTok{match.fun}\NormalTok{(cluster\_method)}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# netbula\_re\_rank:"}\NormalTok{, }\FunctionTok{paste0}\NormalTok{(cluster\_method), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      structure\_set }\OtherTok{\textless{}{-}} \FunctionTok{method\_fun}\NormalTok{(structure\_set, reference\_compound, }\AttributeTok{csi\_score\_weight =}\NormalTok{ csi\_score\_weight,}
                                  \AttributeTok{class\_similarity\_weight =}\NormalTok{ class\_similarity\_weight,}
\NormalTok{                                  ...)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# retrive class of candidates via classyfire}
    \ControlFlowTok{if}\NormalTok{(filter\_via\_classification }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# netbula\_re\_rank: method\_filter\_candidates\_upon\_classyfire}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      structure\_set }\OtherTok{\textless{}{-}} \FunctionTok{method\_filter\_candidates\_upon\_classyfire}\NormalTok{(structure\_set, nebula\_name, ...)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# rt prediction}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(rt\_set))\{}
      \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# netbula\_re\_rank: method\_predict\_candidates\_rt}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{      structure\_set }\OtherTok{\textless{}{-}} \FunctionTok{method\_predict\_candidates\_rt}\NormalTok{(structure\_set, reference\_compound, rt\_set,}
                                                    \AttributeTok{rt\_weight =}\NormalTok{ rt\_weight, }\AttributeTok{rt\_window =}\NormalTok{ rt\_window, ...)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# revise .GlobalVar .MCn.formula\_set}
    \ControlFlowTok{if}\NormalTok{(revise\_MCn\_formula\_set }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{revise\_MCn\_formula\_set}\NormalTok{(structure\_set)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# revise .GlobalVar .MCn.structure\_set {-}{-}{-}{-}{-}{-}{-}}
    \ControlFlowTok{if}\NormalTok{(revise\_MCn\_structure\_set }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{revise\_MCn\_structure\_set}\NormalTok{(structure\_set)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: nebula\_re\_rank}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{(structure\_set))}
\NormalTok{  \}}
\DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{smiles\_to\_sdfset }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_set}
\NormalTok{           )\{}
    \DocumentationTok{\#\#}
\NormalTok{    smiles\_set }\OtherTok{\textless{}{-}}\NormalTok{ structure\_set}\SpecialCharTok{$}\NormalTok{smiles}
    \FunctionTok{names}\NormalTok{(smiles\_set) }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(structure\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{"\_"}\NormalTok{, structure\_set}\SpecialCharTok{$}\NormalTok{structure\_rank)}
    \DocumentationTok{\#\# this function automaticly set the vector name as name of each subset}
\NormalTok{    sdf\_set }\OtherTok{\textless{}{-}}\NormalTok{ ChemmineR}\SpecialCharTok{::}\FunctionTok{smiles2sdf}\NormalTok{(smiles\_set)}
    \FunctionTok{return}\NormalTok{(sdf\_set)}
\NormalTok{  \}}
\NormalTok{df\_get\_structure }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           x,}
           \AttributeTok{top\_n =} \DecValTok{10}\NormalTok{,}
           \AttributeTok{collate\_factor =} \FloatTok{0.85}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    df }\OtherTok{\textless{}{-}} \FunctionTok{get\_structure}\NormalTok{(}
\NormalTok{                        x[[}\StringTok{".id"}\NormalTok{]],}
\NormalTok{                        x[[}\StringTok{"precursorFormula"}\NormalTok{]],}
\NormalTok{                        x[[}\StringTok{"adduct"}\NormalTok{]],}
                        \AttributeTok{return\_row =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{top\_n,}
\NormalTok{                        ...)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(df) }\SpecialCharTok{==} \DecValTok{0}\NormalTok{)\{}
      \FunctionTok{return}\NormalTok{(df)}
\NormalTok{    \}}
\NormalTok{    df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(df, }\AttributeTok{.id =}\NormalTok{ x[[}\StringTok{".id"}\NormalTok{]]) }\DocumentationTok{\#\# add key\_id}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(collate\_factor) }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      top\_simi }\OtherTok{\textless{}{-}}\NormalTok{ df[}\DecValTok{1}\NormalTok{, }\StringTok{"tanimotoSimilarity"}\NormalTok{]}
\NormalTok{      df }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(df, tanimotoSimilarity }\SpecialCharTok{\textgreater{}=}\NormalTok{ top\_simi }\SpecialCharTok{*}\NormalTok{ collate\_factor)}
\NormalTok{    \}}
    \FunctionTok{return}\NormalTok{(df)}
\NormalTok{  \}}
\NormalTok{rename\_file }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           file,}
           \AttributeTok{suffix =} \StringTok{"prefix"}
\NormalTok{           )\{}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(file) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{file.rename}\NormalTok{(file, }\FunctionTok{paste0}\NormalTok{(file, }\StringTok{"."}\NormalTok{, suffix))}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{revise\_MCn\_formula\_set }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_set}
\NormalTok{           )\{}
    \DocumentationTok{\#\# prepare replace data}
\NormalTok{    rp }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(structure\_set, .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidyr}\SpecialCharTok{::}\FunctionTok{separate}\NormalTok{(}\AttributeTok{col =} \StringTok{"file\_name"}\NormalTok{, }\AttributeTok{sep =} \StringTok{"\_"}\NormalTok{, }\AttributeTok{into =} \FunctionTok{c}\NormalTok{(}\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{adduct =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+(?!$)"}\NormalTok{, }\StringTok{" }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{+ "}\NormalTok{, adduct, }\AttributeTok{perl =}\NormalTok{ T),}
                    \AttributeTok{adduct =} \FunctionTok{gsub}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-}(?!$)"}\NormalTok{, }\StringTok{" }\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{{-} "}\NormalTok{, adduct, }\AttributeTok{perl =}\NormalTok{ T)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, precursorFormula, adduct, molecularFormula)}
    \DocumentationTok{\#\# replace}
\NormalTok{    fset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(.MCn.formula\_set, .id)}
\NormalTok{    fset[fset}\SpecialCharTok{$}\StringTok{".id"} \SpecialCharTok{\%in\%}\NormalTok{ rp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"precursorFormula"}\NormalTok{, }\StringTok{"adduct"}\NormalTok{, }\StringTok{"molecularFormula"}\NormalTok{)] }\OtherTok{\textless{}{-}}\NormalTok{ rp}
\NormalTok{    .MCn.formula\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ fset}
    \FunctionTok{return}\NormalTok{()}
\NormalTok{  \}}
\NormalTok{revise\_MCn\_structure\_set }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_set}
\NormalTok{           )\{}
\NormalTok{    sset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(.MCn.structure\_set, .id)}
    \DocumentationTok{\#\# prepare replace data}
\NormalTok{    rp }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(structure\_set, .id) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\FunctionTok{colnames}\NormalTok{(sset))}
    \DocumentationTok{\#\# replace}
\NormalTok{    sset }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{distinct}\NormalTok{(}\FunctionTok{rbind}\NormalTok{(rp, sset), .id, }\AttributeTok{.keep\_all =}\NormalTok{ T)}
\NormalTok{    .MCn.structure\_set }\OtherTok{\textless{}\textless{}{-}}\NormalTok{ sset}
    \DocumentationTok{\#\# rename exist structure picture {-}{-}{-}{-}{-}{-}{-}}
\NormalTok{    tmp\_stru }\OtherTok{\textless{}{-}} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results, }\StringTok{"/tmp/structure"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{file.exists}\NormalTok{(tmp\_stru) }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{lapply}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(tmp\_stru, }\StringTok{"/"}\NormalTok{, rp}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{, }\StringTok{".svg"}\NormalTok{), rename\_file)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{get\_nebula\_structure\_candidates }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
           \AttributeTok{top\_n =} \DecValTok{50}\NormalTok{,}
           \AttributeTok{match\_pattern =} \ConstantTok{NULL}\NormalTok{,}
           \AttributeTok{collate\_factor =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ... }
\NormalTok{           )\{}
    \DocumentationTok{\#\# get formula}
\NormalTok{    id\_set }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.nebula\_index, name }\SpecialCharTok{==}\NormalTok{ nebula\_name)}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(.MCn.formula\_set, .id }\SpecialCharTok{\%in\%}\NormalTok{ id\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# match patern}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"precursorFormula"} \SpecialCharTok{\%in\%}\NormalTok{ match\_pattern }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      formula\_adduct}\SpecialCharTok{$}\NormalTok{precursorFormula }\OtherTok{=} \ConstantTok{NULL}
\NormalTok{    \}}
    \ControlFlowTok{if}\NormalTok{(}\StringTok{"adduct"} \SpecialCharTok{\%in\%}\NormalTok{ match\_pattern }\SpecialCharTok{==}\NormalTok{ F)\{}
\NormalTok{      formula\_adduct}\SpecialCharTok{$}\NormalTok{adduct }\OtherTok{=} \ConstantTok{NULL}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# catch file}
\NormalTok{    formula\_adduct }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(formula\_adduct, }\StringTok{".id"}\NormalTok{)}
    \DocumentationTok{\#\# then, use lapply match file}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# netbula\_re\_rank: get\_structure}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(formula\_adduct, df\_get\_structure,}
                                       \AttributeTok{top\_n =}\NormalTok{ top\_n,}
                                       \AttributeTok{collate\_factor =}\NormalTok{ collate\_factor,}
\NormalTok{                                       ...)}
\NormalTok{    structure\_set }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(structure\_set, }\AttributeTok{fill =}\NormalTok{ T)}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# STAT of structure\_set:"}\NormalTok{,}
        \FunctionTok{paste0}\NormalTok{(}\FunctionTok{nrow}\NormalTok{(structure\_set), }\StringTok{" (structure sum)/"}\NormalTok{, }\FunctionTok{length}\NormalTok{(}\FunctionTok{unique}\NormalTok{(structure\_set}\SpecialCharTok{$}\StringTok{".id"}\NormalTok{)), }\StringTok{"(.id sum)"}\NormalTok{), }\StringTok{"}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \FunctionTok{return}\NormalTok{(structure\_set)}
\NormalTok{  \}}
\NormalTok{set\_reference\_compound }\OtherTok{\textless{}{-}} 
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           structure\_set,}
           \AttributeTok{reference\_ratio =} \FloatTok{0.5}
\NormalTok{           )\{}
\NormalTok{    reference\_compound }\OtherTok{\textless{}{-}}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{filter}\NormalTok{(structure\_set, structure\_rank }\SpecialCharTok{==} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, structure\_rank, tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{slice}\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\NormalTok{(}\FunctionTok{round}\NormalTok{(reference\_ratio }\SpecialCharTok{*} \FunctionTok{nrow}\NormalTok{(.))))}
    \FunctionTok{return}\NormalTok{(reference\_compound)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-read_tsv.r}{%
\section{File: read\_tsv.R}\label{file-read_tsv.r}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{read\_tsv }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(path)\{}
\NormalTok{  file }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{fread}\NormalTok{(}\AttributeTok{input=}\NormalTok{path, }\AttributeTok{sep=}\StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header=}\NormalTok{T, }\AttributeTok{quote=}\StringTok{""}\NormalTok{, }\AttributeTok{check.names=}\NormalTok{F)}
  \FunctionTok{return}\NormalTok{(file)}
\NormalTok{\}}
\NormalTok{write\_tsv }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(x, filename, }\AttributeTok{col.names =}\NormalTok{ T, }\AttributeTok{row.names =}\NormalTok{ F)\{}
    \FunctionTok{write.table}\NormalTok{(x, }\AttributeTok{file =}\NormalTok{ filename, }\AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{col.names =}\NormalTok{ col.names, }\AttributeTok{row.names =}\NormalTok{ row.names, }\AttributeTok{quote =}\NormalTok{ F)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_child_nebulae.r}{%
\section{File: visualize\_child\_nebulae.R}\label{file-visualize_child_nebulae.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param graph\_list PARAM\_DESCRIPTION, Default: .MCn.child\_graph\_list}
\CommentTok{\#\textquotesingle{} @param compound\_class\_list PARAM\_DESCRIPTION, Default: .MCn.nebula\_class}
\CommentTok{\#\textquotesingle{} @param output PARAM\_DESCRIPTION, Default: paste0(.MCn.output, "/", .MCn.results)}
\CommentTok{\#\textquotesingle{} @param layout PARAM\_DESCRIPTION, Default: \textquotesingle{}fr\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param width PARAM\_DESCRIPTION, Default: 23}
\CommentTok{\#\textquotesingle{} @param height PARAM\_DESCRIPTION, Default: 30}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{arrange\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[svglite]\{svglite\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[grid]\{grid.newpage\}\}, \textbackslash{}code\{\textbackslash{}link[grid]\{Working with Viewports\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{} @rdname visualize\_child\_nebulae}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr select rename as\_tibble arrange mutate}
\CommentTok{\#\textquotesingle{} @importFrom svglite svglite}
\CommentTok{\#\textquotesingle{} @importFrom grid grid.newpage pushViewport}
\CommentTok{\#\textquotesingle{} @importFrom pbapply pbmapply}
\NormalTok{visualize\_child\_nebulae }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{graph\_list =}\NormalTok{ .MCn.child\_graph\_list,}
           \AttributeTok{compound\_class\_list =}\NormalTok{ .MCn.nebula\_class,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"fr"}\NormalTok{,}
           \AttributeTok{width =} \DecValTok{23}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{30}\NormalTok{,}
           \AttributeTok{nodes\_mark =} \ConstantTok{NA}\NormalTok{,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: visualize\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# get top compound class (nodes\_color data)}
\NormalTok{    metadata }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(compound\_class\_list, head, }\AttributeTok{n =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(}\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{is.data.frame}\NormalTok{(nodes\_mark))\{}
      \DocumentationTok{\#\# the secound col as mark col}
      \FunctionTok{colnames}\NormalTok{(nodes\_mark) }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{".id"}\NormalTok{, }\StringTok{"mark"}\NormalTok{)}
      \DocumentationTok{\#\# merge with metadata}
\NormalTok{      metadata }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(metadata, nodes\_mark, }\AttributeTok{by =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%} 
\NormalTok{        dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{vis\_class =} \FunctionTok{ifelse}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(mark), mark,}
                                         \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.numeric}\NormalTok{(mark), }\ConstantTok{NA}\NormalTok{, }\StringTok{"Others"}\NormalTok{)))}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# draw network via ggplot, and print into grid palette}
    \DocumentationTok{\#\# number of child\_nebulae}
\NormalTok{    n }\OtherTok{=} \FunctionTok{length}\NormalTok{(graph\_list)}
    \DocumentationTok{\#\# specification of grid (cols * rows)}
\NormalTok{    cols }\OtherTok{=}\NormalTok{ n}\SpecialCharTok{\^{}}\NormalTok{(}\DecValTok{1}\SpecialCharTok{/}\DecValTok{2}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(}\FunctionTok{round}\NormalTok{(cols) }\SpecialCharTok{!=}\NormalTok{ cols)\{}
\NormalTok{      cols }\OtherTok{=} \FunctionTok{round}\NormalTok{(cols)}
\NormalTok{      rows }\OtherTok{=}\NormalTok{ cols }\SpecialCharTok{+} \DecValTok{1}
\NormalTok{    \}}\ControlFlowTok{else}\NormalTok{\{}
\NormalTok{      rows }\OtherTok{=}\NormalTok{ cols}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# grid position of all child\_nebulae}
\NormalTok{    graph\_anno }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(graph\_list) }\SpecialCharTok{\%\textgreater{}\%} \CommentTok{\# names}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{() }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{nebula\_index =}\NormalTok{ value) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(.MCn.class\_tree\_data[,}\FunctionTok{c}\NormalTok{(}\StringTok{"name"}\NormalTok{, }\StringTok{"hierarchy"}\NormalTok{)], }\AttributeTok{by.x =} \StringTok{"nebula\_index"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{, }\AttributeTok{all.x =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(hierarchy)) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# calculate position}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{seq =} \DecValTok{1}\SpecialCharTok{:}\NormalTok{n, }
                    \AttributeTok{col =} \FunctionTok{ifelse}\NormalTok{(seq }\SpecialCharTok{\%\%}\NormalTok{ cols }\SpecialCharTok{!=} \DecValTok{0}\NormalTok{, seq }\SpecialCharTok{\%\%}\NormalTok{ cols, cols),}
                    \AttributeTok{row =}\NormalTok{ (seq }\SpecialCharTok{{-}}\NormalTok{ col)}\SpecialCharTok{/}\NormalTok{cols }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# re{-}set rows}
\NormalTok{    rows }\OtherTok{\textless{}{-}} \FunctionTok{max}\NormalTok{(graph\_anno}\SpecialCharTok{$}\NormalTok{row)}
    \DocumentationTok{\#\# as list}
\NormalTok{    nebula\_index }\OtherTok{\textless{}{-}}\NormalTok{ graph\_anno}\SpecialCharTok{$}\NormalTok{nebula\_index}
\NormalTok{    graph\_anno }\OtherTok{\textless{}{-}} \FunctionTok{by\_group\_as\_list}\NormalTok{(graph\_anno, }\StringTok{"nebula\_index"}\NormalTok{)}
    \DocumentationTok{\#\# re{-}order the graph list according to annotation}
\NormalTok{    graph\_list }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(nebula\_index, }\ControlFlowTok{function}\NormalTok{(x)\{}
\NormalTok{                           graph\_list[[x]]}
\NormalTok{                         \})}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \DocumentationTok{\#\# prepare grid panel}
\NormalTok{    svglite}\SpecialCharTok{::}\FunctionTok{svglite}\NormalTok{(}\FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"child\_nebulae.svg"}\NormalTok{), }\AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{grid.newpage}\NormalTok{()}
\NormalTok{    grid}\SpecialCharTok{::}\FunctionTok{pushViewport}\NormalTok{(}\FunctionTok{viewport}\NormalTok{(}\AttributeTok{layout =} \FunctionTok{grid.layout}\NormalTok{(rows, cols)))}
    \DocumentationTok{\#\# draw child\_nebulae in grid}
\NormalTok{    pbapply}\SpecialCharTok{::}\FunctionTok{pbmapply}\NormalTok{(grid\_child\_nebula, }\DocumentationTok{\#\# function}
\NormalTok{                      graph\_list, }\DocumentationTok{\#\# graph list}
\NormalTok{                      graph\_anno, }\DocumentationTok{\#\# graph annotation}
                      \AttributeTok{MoreArgs =} \FunctionTok{list}\NormalTok{( }\DocumentationTok{\#\# args}
                                      \AttributeTok{class =}\NormalTok{ metadata,}
                                      \AttributeTok{layout =}\NormalTok{ layout,}
\NormalTok{                                      ...}
\NormalTok{                                      ))}
    \FunctionTok{dev.off}\NormalTok{()}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: visualize\_child\_nebulae}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_nebula.r}{%
\section{File: visualize\_nebula.R}\label{file-visualize_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param nebula\_name PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @rdname visualize\_nebula}
\CommentTok{\#\textquotesingle{} @export }
\NormalTok{visualize\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           nebula\_name,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{annotate\_child\_nebulae}\NormalTok{(}
                                \AttributeTok{nebula\_name =}\NormalTok{ nebula\_name,}
                                \AttributeTok{write\_output =}\NormalTok{ F,}
                                \AttributeTok{plot\_structure =}\NormalTok{ F,}
                                \AttributeTok{plot\_ppcp =}\NormalTok{ F,}
                                \AttributeTok{merge\_image =}\NormalTok{ F,}
                                \AttributeTok{return\_plot =}\NormalTok{ T,}
\NormalTok{                                ...)}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}

\hypertarget{file-visualize_parent_nebula.r}{%
\section{File: visualize\_parent\_nebula.R}\label{file-visualize_parent_nebula.r}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\#\textquotesingle{} @title FUNCTION\_TITLE}
\CommentTok{\#\textquotesingle{} @description FUNCTION\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @param graph PARAM\_DESCRIPTION, Default: .MCn.parent\_graph}
\CommentTok{\#\textquotesingle{} @param write\_output PARAM\_DESCRIPTION, Default: T}
\CommentTok{\#\textquotesingle{} @param output PARAM\_DESCRIPTION, Default: paste0(.MCn.output, "/", .MCn.results)}
\CommentTok{\#\textquotesingle{} @param layout PARAM\_DESCRIPTION, Default: \textquotesingle{}mds\textquotesingle{}}
\CommentTok{\#\textquotesingle{} @param nodes\_color PARAM\_DESCRIPTION, Default: c(hierarchy = 4)}
\CommentTok{\#\textquotesingle{} @param width PARAM\_DESCRIPTION, Default: 15}
\CommentTok{\#\textquotesingle{} @param height PARAM\_DESCRIPTION, Default: 12}
\CommentTok{\#\textquotesingle{} @param return\_plot PARAM\_DESCRIPTION, Default: F}
\CommentTok{\#\textquotesingle{} @param ... PARAM\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @return OUTPUT\_DESCRIPTION}
\CommentTok{\#\textquotesingle{} @details DETAILS}
\CommentTok{\#\textquotesingle{} @examples }
\CommentTok{\#\textquotesingle{} \textbackslash{}dontrun\{}
\CommentTok{\#\textquotesingle{} if(interactive())\{}
\CommentTok{\#\textquotesingle{}  \#EXAMPLE1}
\CommentTok{\#\textquotesingle{}  \}}
\CommentTok{\#\textquotesingle{} \}}
\CommentTok{\#\textquotesingle{} @seealso }
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[pbapply]\{pbapply\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[data.table]\{rbindlist\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[dplyr]\{select\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{rename\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{mutate\}\}, \textbackslash{}code\{\textbackslash{}link[dplyr]\{reexports\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[tidygraph]\{as\_tbl\_graph.data.frame\}\}, \textbackslash{}code\{\textbackslash{}link[tidygraph]\{activate\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[ggraph]\{ggraph\}\}}
\CommentTok{\#\textquotesingle{}  \textbackslash{}code\{\textbackslash{}link[ggplot2]\{ggsave\}\}}
\CommentTok{\#\textquotesingle{} @rdname visualize\_parent\_nebula}
\CommentTok{\#\textquotesingle{} @export }
\CommentTok{\#\textquotesingle{} @importFrom pbapply pblapply}
\CommentTok{\#\textquotesingle{} @importFrom data.table rbindlist}
\CommentTok{\#\textquotesingle{} @importFrom dplyr select rename mutate as\_tibble}
\CommentTok{\#\textquotesingle{} @importFrom tidygraph as\_tbl\_graph activate tbl\_graph}
\CommentTok{\#\textquotesingle{} @importFrom ggraph create\_layout}
\CommentTok{\#\textquotesingle{} @importFrom ggplot2 ggsave}
\NormalTok{visualize\_parent\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
           \AttributeTok{graph =}\NormalTok{ .MCn.parent\_graph,}
           \AttributeTok{write\_output =}\NormalTok{ T,}
           \AttributeTok{output =} \FunctionTok{paste0}\NormalTok{(.MCn.output, }\StringTok{"/"}\NormalTok{, .MCn.results),}
           \AttributeTok{layout =} \StringTok{"mds"}\NormalTok{,}
           \AttributeTok{nodes\_color =} \FunctionTok{c}\NormalTok{(}\StringTok{"hierarchy"} \OtherTok{=} \DecValTok{3}\NormalTok{), }\DocumentationTok{\#\# default, use superclass as color.}
           \AttributeTok{width =} \DecValTok{15}\NormalTok{,}
           \AttributeTok{height =} \DecValTok{12}\NormalTok{,}
           \AttributeTok{return\_plot =}\NormalTok{ F,}
\NormalTok{           ...}
\NormalTok{           )\{}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula run: visualize\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \DocumentationTok{\#\# get nodes\_color data}
\NormalTok{    metadata }\OtherTok{=}\NormalTok{ .MCn.class\_tree\_data}
    \FunctionTok{assign}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\FunctionTok{environment}\NormalTok{(), }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \FunctionTok{cat}\NormalTok{(}\StringTok{"\#\# visualize\_parent\_nebula: method\_summarize\_nebula\_index}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
\NormalTok{    class }\OtherTok{\textless{}{-}}\NormalTok{ pbapply}\SpecialCharTok{::}\FunctionTok{pblapply}\NormalTok{(.MCn.ppcp\_dataset, method\_summarize\_nebula\_class, }
                               \AttributeTok{class\_data\_type =} \StringTok{"classes\_tree\_data"}\NormalTok{,}
                               \AttributeTok{max\_number =} \DecValTok{1}\NormalTok{,}
                               \AttributeTok{hierarchy\_priority =}\NormalTok{ nodes\_color[[}\StringTok{"hierarchy"}\NormalTok{]] )}
\NormalTok{    class }\OtherTok{\textless{}{-}}\NormalTok{ data.table}\SpecialCharTok{::}\FunctionTok{rbindlist}\NormalTok{(class, }\AttributeTok{idcol =}\NormalTok{ T) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(.id, name) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{vis\_class =}\NormalTok{ name)}
    \DocumentationTok{\#\# reformat graph, add with class}
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{as\_tbl\_graph}\NormalTok{(graph)}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    nodes }\OtherTok{\textless{}{-}}\NormalTok{ graph }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(nodes) }\SpecialCharTok{\%\textgreater{}\%}
      \FunctionTok{merge}\NormalTok{(class, }\AttributeTok{by.x =} \StringTok{"name"}\NormalTok{ , }\AttributeTok{by.y =} \StringTok{".id"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{sort =}\NormalTok{ F) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{mutate}\NormalTok{(}\AttributeTok{vis\_class =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(vis\_class) }\SpecialCharTok{==}\NormalTok{ T, }\StringTok{"Unknown"}\NormalTok{, vis\_class)) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
\NormalTok{    edges }\OtherTok{\textless{}{-}}\NormalTok{ graph }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      tidygraph}\SpecialCharTok{::}\FunctionTok{activate}\NormalTok{(edges) }\SpecialCharTok{\%\textgreater{}\%}
      \DocumentationTok{\#\# rename the col of value of compare spectra}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{rename}\NormalTok{(}\AttributeTok{similarity =} \DecValTok{3}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{      dplyr}\SpecialCharTok{::}\FunctionTok{as\_tibble}\NormalTok{()}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
\NormalTok{    graph }\OtherTok{\textless{}{-}}\NormalTok{ tidygraph}\SpecialCharTok{::}\FunctionTok{tbl\_graph}\NormalTok{(}\AttributeTok{nodes =}\NormalTok{ nodes, }\AttributeTok{edges =}\NormalTok{ edges)}
    \DocumentationTok{\#\# create network layout}
\NormalTok{    layout\_n }\OtherTok{\textless{}{-}} \FunctionTok{create\_layout}\NormalTok{(graph, }\AttributeTok{layout =}\NormalTok{ layout, ...)}
    \DocumentationTok{\#\# palette}
\NormalTok{    palette }\OtherTok{\textless{}{-}}\NormalTok{ .MCn.palette}
    \DocumentationTok{\#\# draw network via ggraph}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{base\_vis\_p\_nebula}\NormalTok{(layout\_n, palette)}
    \DocumentationTok{\#\# write\_output}
    \ControlFlowTok{if}\NormalTok{(write\_output }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{ggsave}\NormalTok{(p, }\AttributeTok{file =} \FunctionTok{paste0}\NormalTok{(output, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula"}\NormalTok{, }\StringTok{"/"}\NormalTok{, }\StringTok{"parent\_nebula.svg"}\NormalTok{),}
             \AttributeTok{width =}\NormalTok{ width, }\AttributeTok{height =}\NormalTok{ height)}
\NormalTok{    \}}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{rm}\NormalTok{(}\StringTok{"envir\_meta"}\NormalTok{, }\AttributeTok{envir =} \FunctionTok{parent.env}\NormalTok{(}\FunctionTok{environment}\NormalTok{()))}
    \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
    \FunctionTok{cat}\NormalTok{(}\StringTok{"[INFO] MCnebula Job Done: visualize\_parent\_nebula}\SpecialCharTok{\textbackslash{}n}\StringTok{"}\NormalTok{)}
    \ControlFlowTok{if}\NormalTok{(return\_plot }\SpecialCharTok{==}\NormalTok{ T)\{}
      \FunctionTok{return}\NormalTok{(p)}
\NormalTok{    \}}
\NormalTok{  \}}
\NormalTok{base\_vis\_p\_nebula }\OtherTok{\textless{}{-}}
  \ControlFlowTok{function}\NormalTok{(}
\NormalTok{           layout\_n,}
           \AttributeTok{palette =}\NormalTok{ .MCn.palette,}
\NormalTok{           ...}
\NormalTok{           )\{}
\NormalTok{    p }\OtherTok{\textless{}{-}} \FunctionTok{ggraph}\NormalTok{(layout\_n) }\SpecialCharTok{+} 
      \FunctionTok{geom\_edge\_fan}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{edge\_width =}\NormalTok{ similarity),}
                    \AttributeTok{color =} \StringTok{"lightblue"}\NormalTok{, }\AttributeTok{show.legend =}\NormalTok{ F) }\SpecialCharTok{+} 
      \FunctionTok{geom\_node\_point}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{size =} \FunctionTok{ifelse}\NormalTok{(}\FunctionTok{is.na}\NormalTok{(tanimotoSimilarity) }\SpecialCharTok{==}\NormalTok{ F,}
\NormalTok{                                        tanimotoSimilarity, }\FloatTok{0.2}\NormalTok{),}
                          \AttributeTok{fill =}\NormalTok{ stringr}\SpecialCharTok{::}\FunctionTok{str\_wrap}\NormalTok{(vis\_class, }\AttributeTok{width =} \DecValTok{25}\NormalTok{)}
\NormalTok{                          ),}
                      \AttributeTok{shape =} \DecValTok{21}
\NormalTok{                      ) }\SpecialCharTok{+} 
      \FunctionTok{scale\_fill\_manual}\NormalTok{(}\AttributeTok{values =}\NormalTok{ palette) }\SpecialCharTok{+}
      \FunctionTok{scale\_edge\_width}\NormalTok{(}\AttributeTok{range =} \FunctionTok{c}\NormalTok{(}\FloatTok{0.1}\NormalTok{, }\FloatTok{0.7}\NormalTok{)) }\SpecialCharTok{+} 
      \FunctionTok{guides}\NormalTok{(}\AttributeTok{fill =} \FunctionTok{guide\_legend}\NormalTok{(}\AttributeTok{override.aes =} \FunctionTok{list}\NormalTok{(}\AttributeTok{size =} \DecValTok{5}\NormalTok{))) }\SpecialCharTok{+}
      \FunctionTok{labs}\NormalTok{(}\AttributeTok{fill =} \StringTok{"Class"}\NormalTok{, }\AttributeTok{size =} \StringTok{"Tanimoto similarity"}\NormalTok{) }\SpecialCharTok{+}
      \DocumentationTok{\#\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-} }
      \FunctionTok{theme\_grey}\NormalTok{() }\SpecialCharTok{+}
      \FunctionTok{theme}\NormalTok{(}
            \AttributeTok{text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{family =} \StringTok{"Times"}\NormalTok{),}
            \AttributeTok{axis.ticks =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.text =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{axis.title =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{panel.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"white"}\NormalTok{),}
            \AttributeTok{legend.key.width =} \FunctionTok{unit}\NormalTok{(}\DecValTok{1}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.key.height =} \FunctionTok{unit}\NormalTok{(}\FloatTok{1.8}\NormalTok{, }\StringTok{"cm"}\NormalTok{),}
            \AttributeTok{legend.title =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{),}
            \AttributeTok{legend.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{),}
            \AttributeTok{legend.background =} \FunctionTok{element\_rect}\NormalTok{(}\AttributeTok{fill =} \StringTok{"transparent"}\NormalTok{),}
            \AttributeTok{panel.grid =} \FunctionTok{element\_blank}\NormalTok{(),}
            \AttributeTok{strip.text =} \FunctionTok{element\_text}\NormalTok{(}\AttributeTok{size =} \DecValTok{20}\NormalTok{, }\AttributeTok{face =} \StringTok{"bold"}\NormalTok{)}
\NormalTok{      )}
    \FunctionTok{return}\NormalTok{(p)}
\NormalTok{  \}}
\end{Highlighting}
\end{Shaded}


\end{document}
